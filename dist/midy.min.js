var ke=Object.create;var oe=Object.defineProperty;var Fe=Object.getOwnPropertyDescriptor;var Ve=Object.getOwnPropertyNames;var Ee=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var z=(a,e)=>()=>(e||a((e={exports:{}}).exports,e),e.exports);var Me=(a,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ve(e))!Oe.call(a,n)&&n!==t&&oe(a,n,{get:()=>e[n],enumerable:!(s=Fe(e,n))||s.enumerable});return a};var Ie=(a,e,t)=>(t=a!=null?ke(Ee(a)):{},Me(e||!a||!a.__esModule?oe(t,"default",{value:a,enumerable:!0}):t,a));var ie=z((ot,ae)=>{function Ce(a){var e=new S(a),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var s=De(t.data),n=[],o=0;!e.eof()&&o<s.numTracks;o++){var r=e.readChunk();if(r.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+r.id+"'";var i=Re(r.data);n.push(i)}return{header:s,tracks:n}}function De(a){var e=new S(a),t=e.readUInt16(),s=e.readUInt16(),n={format:t,numTracks:s},o=e.readUInt16();return o&32768?(n.framesPerSecond=256-(o>>8),n.ticksPerFrame=o&255):n.ticksPerBeat=o,n}function Re(a){for(var e=new S(a),t=[];!e.eof();){var s=o();t.push(s)}return t;var n;function o(){var r={};r.deltaTime=e.readVarInt();var i=e.readUInt8();if((i&240)===240)if(i===255){r.meta=!0;var c=e.readUInt8(),l=e.readVarInt();switch(c){case 0:if(r.type="sequenceNumber",l!==2)throw"Expected length for sequenceNumber event is 2, got "+l;return r.number=e.readUInt16(),r;case 1:return r.type="text",r.text=e.readString(l),r;case 2:return r.type="copyrightNotice",r.text=e.readString(l),r;case 3:return r.type="trackName",r.text=e.readString(l),r;case 4:return r.type="instrumentName",r.text=e.readString(l),r;case 5:return r.type="lyrics",r.text=e.readString(l),r;case 6:return r.type="marker",r.text=e.readString(l),r;case 7:return r.type="cuePoint",r.text=e.readString(l),r;case 32:if(r.type="channelPrefix",l!=1)throw"Expected length for channelPrefix event is 1, got "+l;return r.channel=e.readUInt8(),r;case 33:if(r.type="portPrefix",l!=1)throw"Expected length for portPrefix event is 1, got "+l;return r.port=e.readUInt8(),r;case 47:if(r.type="endOfTrack",l!=0)throw"Expected length for endOfTrack event is 0, got "+l;return r;case 81:if(r.type="setTempo",l!=3)throw"Expected length for setTempo event is 3, got "+l;return r.microsecondsPerBeat=e.readUInt24(),r;case 84:if(r.type="smpteOffset",l!=5)throw"Expected length for smpteOffset event is 5, got "+l;var h=e.readUInt8(),d={0:24,32:25,64:29,96:30};return r.frameRate=d[h&96],r.hour=h&31,r.min=e.readUInt8(),r.sec=e.readUInt8(),r.frame=e.readUInt8(),r.subFrame=e.readUInt8(),r;case 88:if(r.type="timeSignature",l!=2&&l!=4)throw"Expected length for timeSignature event is 4 or 2, got "+l;return r.numerator=e.readUInt8(),r.denominator=1<<e.readUInt8(),l===4?(r.metronome=e.readUInt8(),r.thirtyseconds=e.readUInt8()):(r.metronome=36,r.thirtyseconds=8),r;case 89:if(r.type="keySignature",l!=2)throw"Expected length for keySignature event is 2, got "+l;return r.key=e.readInt8(),r.scale=e.readUInt8(),r;case 127:return r.type="sequencerSpecific",r.data=e.readBytes(l),r;default:return r.type="unknownMeta",r.data=e.readBytes(l),r.metatypeByte=c,r}}else if(i==240){r.type="sysEx";var l=e.readVarInt();return r.data=e.readBytes(l),r}else if(i==247){r.type="endSysEx";var l=e.readVarInt();return r.data=e.readBytes(l),r}else throw"Unrecognised MIDI event type byte: "+i;else{var u;if((i&128)===0){if(n===null)throw"Running status byte encountered before status byte";u=i,i=n,r.running=!0}else u=e.readUInt8(),n=i;var f=i>>4;switch(r.channel=i&15,f){case 8:return r.type="noteOff",r.noteNumber=u,r.velocity=e.readUInt8(),r;case 9:var m=e.readUInt8();return r.type=m===0?"noteOff":"noteOn",r.noteNumber=u,r.velocity=m,m===0&&(r.byte9=!0),r;case 10:return r.type="noteAftertouch",r.noteNumber=u,r.amount=e.readUInt8(),r;case 11:return r.type="controller",r.controllerType=u,r.value=e.readUInt8(),r;case 12:return r.type="programChange",r.programNumber=u,r;case 13:return r.type="channelAftertouch",r.amount=u,r;case 14:return r.type="pitchBend",r.value=u+(e.readUInt8()<<7)-8192,r;default:throw"Unrecognised MIDI event type: "+f}}}}function S(a){this.buffer=a,this.bufferLen=this.buffer.length,this.pos=0}S.prototype.eof=function(){return this.pos>=this.bufferLen};S.prototype.readUInt8=function(){var a=this.buffer[this.pos];return this.pos+=1,a};S.prototype.readInt8=function(){var a=this.readUInt8();return a&128?a-256:a};S.prototype.readUInt16=function(){var a=this.readUInt8(),e=this.readUInt8();return(a<<8)+e};S.prototype.readInt16=function(){var a=this.readUInt16();return a&32768?a-65536:a};S.prototype.readUInt24=function(){var a=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(a<<16)+(e<<8)+t};S.prototype.readInt24=function(){var a=this.readUInt24();return a&8388608?a-16777216:a};S.prototype.readUInt32=function(){var a=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),s=this.readUInt8();return(a<<24)+(e<<16)+(t<<8)+s};S.prototype.readBytes=function(a){var e=this.buffer.slice(this.pos,this.pos+a);return this.pos+=a,e};S.prototype.readString=function(a){var e=this.readBytes(a);return String.fromCharCode.apply(null,e)};S.prototype.readVarInt=function(){for(var a=0;!this.eof();){var e=this.readUInt8();if(e&128)a+=e&127,a<<=7;else return a+e}return a};S.prototype.readChunk=function(){var a=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:a,length:e,data:t}};ae.exports=Ce});var le=z((at,ce)=>{function Be(a,e){if(typeof a!="object")throw"Invalid MIDI data";e=e||{};var t=a.header||{},s=a.tracks||[],n,o=s.length,r=new y;for(Ne(r,t,o),n=0;n<o;n++)Le(r,s[n],e);return r.buffer}function Ne(a,e,t){var s=e.format==null?1:e.format,n=128;e.timeDivision?n=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?n=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(n=e.ticksPerBeat&32767);var o=new y;o.writeUInt16(s),o.writeUInt16(t),o.writeUInt16(n),a.writeChunk("MThd",o.buffer)}function Le(a,e,t){var s=new y,n,o=e.length,r=null;for(n=0;n<o;n++)(t.running===!1||!t.running&&!e[n].running)&&(r=null),r=Ae(s,e[n],r,t.useByte9ForNoteOff);a.writeChunk("MTrk",s.buffer)}function Ae(a,e,t,s){var n=e.type,o=e.deltaTime,r=e.text||"",i=e.data||[],c=null;switch(a.writeVarInt(o),n){case"sequenceNumber":a.writeUInt8(255),a.writeUInt8(0),a.writeVarInt(2),a.writeUInt16(e.number);break;case"text":a.writeUInt8(255),a.writeUInt8(1),a.writeVarInt(r.length),a.writeString(r);break;case"copyrightNotice":a.writeUInt8(255),a.writeUInt8(2),a.writeVarInt(r.length),a.writeString(r);break;case"trackName":a.writeUInt8(255),a.writeUInt8(3),a.writeVarInt(r.length),a.writeString(r);break;case"instrumentName":a.writeUInt8(255),a.writeUInt8(4),a.writeVarInt(r.length),a.writeString(r);break;case"lyrics":a.writeUInt8(255),a.writeUInt8(5),a.writeVarInt(r.length),a.writeString(r);break;case"marker":a.writeUInt8(255),a.writeUInt8(6),a.writeVarInt(r.length),a.writeString(r);break;case"cuePoint":a.writeUInt8(255),a.writeUInt8(7),a.writeVarInt(r.length),a.writeString(r);break;case"channelPrefix":a.writeUInt8(255),a.writeUInt8(32),a.writeVarInt(1),a.writeUInt8(e.channel);break;case"portPrefix":a.writeUInt8(255),a.writeUInt8(33),a.writeVarInt(1),a.writeUInt8(e.port);break;case"endOfTrack":a.writeUInt8(255),a.writeUInt8(47),a.writeVarInt(0);break;case"setTempo":a.writeUInt8(255),a.writeUInt8(81),a.writeVarInt(3),a.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":a.writeUInt8(255),a.writeUInt8(84),a.writeVarInt(5);var l={24:0,25:32,29:64,30:96},h=e.hour&31|l[e.frameRate];a.writeUInt8(h),a.writeUInt8(e.min),a.writeUInt8(e.sec),a.writeUInt8(e.frame),a.writeUInt8(e.subFrame);break;case"timeSignature":a.writeUInt8(255),a.writeUInt8(88),a.writeVarInt(4),a.writeUInt8(e.numerator);var d=Math.floor(Math.log(e.denominator)/Math.LN2)&255;a.writeUInt8(d),a.writeUInt8(e.metronome),a.writeUInt8(e.thirtyseconds||8);break;case"keySignature":a.writeUInt8(255),a.writeUInt8(89),a.writeVarInt(2),a.writeInt8(e.key),a.writeUInt8(e.scale);break;case"sequencerSpecific":a.writeUInt8(255),a.writeUInt8(127),a.writeVarInt(i.length),a.writeBytes(i);break;case"unknownMeta":e.metatypeByte!=null&&(a.writeUInt8(255),a.writeUInt8(e.metatypeByte),a.writeVarInt(i.length),a.writeBytes(i));break;case"sysEx":a.writeUInt8(240),a.writeVarInt(i.length),a.writeBytes(i);break;case"endSysEx":a.writeUInt8(247),a.writeVarInt(i.length),a.writeBytes(i);break;case"noteOff":var u=s!==!1&&e.byte9||s&&e.velocity==0?144:128;c=u|e.channel,c!==t&&a.writeUInt8(c),a.writeUInt8(e.noteNumber),a.writeUInt8(e.velocity);break;case"noteOn":c=144|e.channel,c!==t&&a.writeUInt8(c),a.writeUInt8(e.noteNumber),a.writeUInt8(e.velocity);break;case"noteAftertouch":c=160|e.channel,c!==t&&a.writeUInt8(c),a.writeUInt8(e.noteNumber),a.writeUInt8(e.amount);break;case"controller":c=176|e.channel,c!==t&&a.writeUInt8(c),a.writeUInt8(e.controllerType),a.writeUInt8(e.value);break;case"programChange":c=192|e.channel,c!==t&&a.writeUInt8(c),a.writeUInt8(e.programNumber);break;case"channelAftertouch":c=208|e.channel,c!==t&&a.writeUInt8(c),a.writeUInt8(e.amount);break;case"pitchBend":c=224|e.channel,c!==t&&a.writeUInt8(c);var f=8192+e.value,m=f&127,g=f>>7&127;a.writeUInt8(m),a.writeUInt8(g);break;default:throw"Unrecognized event type: "+n}return c}function y(){this.buffer=[]}y.prototype.writeUInt8=function(a){this.buffer.push(a&255)};y.prototype.writeInt8=y.prototype.writeUInt8;y.prototype.writeUInt16=function(a){var e=a>>8&255,t=a&255;this.writeUInt8(e),this.writeUInt8(t)};y.prototype.writeInt16=y.prototype.writeUInt16;y.prototype.writeUInt24=function(a){var e=a>>16&255,t=a>>8&255,s=a&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(s)};y.prototype.writeInt24=y.prototype.writeUInt24;y.prototype.writeUInt32=function(a){var e=a>>24&255,t=a>>16&255,s=a>>8&255,n=a&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(s),this.writeUInt8(n)};y.prototype.writeInt32=y.prototype.writeUInt32;y.prototype.writeBytes=function(a){this.buffer=this.buffer.concat(Array.prototype.slice.call(a,0))};y.prototype.writeString=function(a){var e,t=a.length,s=[];for(e=0;e<t;e++)s.push(a.codePointAt(e));this.writeBytes(s)};y.prototype.writeVarInt=function(a){if(a<0)throw"Cannot write negative variable-length integer";if(a<=127)this.writeUInt8(a);else{var e=a,t=[];for(t.push(e&127),e>>=7;e;){var s=e&127|128;t.push(s),e>>=7}this.writeBytes(t.reverse())}};y.prototype.writeChunk=function(a,e){this.writeString(a),this.writeUInt32(e.length),this.writeBytes(e)};ce.exports=Be});var ue=z(Q=>{Q.parseMidi=ie();Q.writeMidi=le()});var xe=Ie(ue());var k=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,s=t+e,n=this.data;this.offset=s;let o=s;for(let c=t+1;c<s;c++)if(n[c]===0){o=c;break}let r=o-t,i=new Array(r);for(let c=0;c<r;c++)i[c]=n[t+c];return String.fromCharCode(...i)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function _(a,e,t){let s=new k(a,e),n=s.readString(4),o=s.readDWORD(t);return new Z(n,o,s.offset)}function J(a,e=0,t,{padding:s=!0,bigEndian:n=!1}={}){let o=[],r=t+e,i=e;for(;i<r;){let c=_(a,i,n);i=c.offset+c.size,s&&(i-e&1)===1&&i++,o.push(c)}return o}var Z=class{constructor(e,t,s){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:s})}};var w=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var b=class a{constructor(e,t,s,n,o){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:o})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,s=e&127,n=e>>7&1,o=e>>8&1,r=e>>9&1;return new a(t,r,o,n,s)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var X=class a{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),s=e.readInt8();return new a(t,s)}},N=class a{constructor(e,t,s,n,o,r,i,c,l,h,d){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:h}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:d})}static parse(e,t){function s(x){for(let P=0;P<t.length;P++)if(t[P].type===x)return t[P]}function n(x){return new k(e,x.offset)}function o(x){let P=s(x);return P?n(P).readString(P.size):null}function r(x){let P=s(x);return P?X.parse(n(P)):null}let i=o("ICMT"),c=o("ICOP"),l=o("ICRD"),h=o("IENG"),d=o("INAM"),u=o("IPRD"),f=o("ISFT"),m=r("ifil"),g=o("isng"),F=o("irom"),I=r("iver");return new a(i,c,l,h,d,u,f,m,g,F,I)}},D=class a{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),s=e.readWORD();return new a(t,s)}},L=class a{constructor(e,t,s,n,o,r,i){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:i})}get isEnd(){return this.presetName==="EOP"}static parse(e){let t=e.readString(20),s=e.readWORD(),n=e.readWORD(),o=e.readWORD(),r=e.readDWORD(),i=e.readDWORD(),c=e.readDWORD();return new a(t,s,n,o,r,i,c)}},O=class a{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),s=e.readByte();return new a(t,s)}},v=class a{constructor(e,t,s,n,o){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:o})}transform(e){let t=this.value*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),s=e.readWORD(),n=e.readInt16(),o=e.readWORD(),r=e.readWORD(),i=b.parse(t),c=b.parse(o);return new a(i,s,n,c,r)}},R=class a{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return w[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),s=w[t],n;switch(s){case"keyRange":case"velRange":n=O.parse(e);break;default:n=e.readInt16();break}return new a(t,n)}},A=class a{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new a;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},U=class a{constructor(e,t,s,n,o,r,i,c,l,h){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:h})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let s=e.readString(20),n=e.readDWORD(),o=e.readDWORD(),r=e.readDWORD(),i=e.readDWORD(),c=e.readDWORD(),l=e.readByte(),h=e.readInt8(),d=e.readWORD(),u=e.readWORD();return t||(r-=n,i-=n),new a(s,n,o,r,i,c,l,h,d,u)}};var p=class{constructor(e,t,s){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=s}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};function he(a,e={}){let t=J(a,0,a.length,e);if(t.length!==1)throw new Error("wrong chunk length");let s=t[0];if(s===null)throw new Error("chunk not found");function n(c,l,h={}){let d=j(c,l,"RIFF","sfbk",h);if(d.length!==3)throw new Error("invalid sfbk structure");let u=Ue(d[0],l),f=u.version.major===3;return f&&d[2].type!=="LIST"&&(d[2]=_(l,d[2].offset-9,!1)),{info:u,samplingData:je(d[1],l),...o(d[2],l,f)}}function o(c,l,h){let d=j(c,l,"LIST","pdta");if(d.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:Ge(d[0],l),presetZone:He(d[1],l),presetModulators:We(d[2],l),presetGenerators:ze(d[3],l),instruments:Ke(d[4],l),instrumentZone:qe(d[5],l),instrumentModulators:$e(d[6],l),instrumentGenerators:Qe(d[7],l),sampleHeaders:Ze(d[8],l,h)}}let r=n(s,a,e),i=r.info.version.major===3;return{...r,samples:_e(r.sampleHeaders,r.samplingData.offsetMSB,r.samplingData.offsetLSB,a,i)}}function j(a,e,t,s,n={}){if(a.type!==t)throw new Error("invalid chunk type:"+a.type);let o=new k(e,a.offset),r=o.readString(4);if(r!==s)throw new Error("invalid signature:"+r);return J(e,o.offset,a.size-4,n)}function Ue(a,e){let t=j(a,e,"LIST","INFO");return N.parse(e,t)}function je(a,e){let t=j(a,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function V(a,e,t,s,n,o){let r=[];if(a.type!==t)throw new Error("invalid chunk type:"+a.type);let i=new k(e,a.offset),c=a.offset+a.size;for(;i.offset<c;){let l=s.parse(i,o);if(n&&n(l))break;r.push(l)}return r}var Ge=(a,e)=>V(a,e,"phdr",L,t=>t.isEnd),He=(a,e)=>V(a,e,"pbag",D),Ke=(a,e)=>V(a,e,"inst",A,t=>t.isEnd),qe=(a,e)=>V(a,e,"ibag",D),We=(a,e)=>V(a,e,"pmod",v),$e=(a,e)=>V(a,e,"imod",v),ze=(a,e)=>V(a,e,"pgen",R,t=>t.isEnd),Qe=(a,e)=>V(a,e,"igen",R),Ze=(a,e,t)=>V(a,e,"shdr",U,s=>s.isEnd,t);function _e(a,e,t,s,n){let o=new Array(a.length),r=n?1:2;for(let i=0;i<a.length;i++){let{start:c,end:l}=a[i],h=e+c*r,d=e+l*r;o[i]=s.subarray(h,d)}return o}var pe=new Map;for(let a=0;a<w.length;a++)pe.set(w[a],a);var Je=["instrument","sampleID"],me=["keyRange","velRange"],be=["keynum","velocity"],ye=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],de=[...ye,...be],ge=new Set;for(let a=0;a<de.length;a++){let e=de[a],t=pe.get(e);t!==void 0&&ge.add(t)}function ve(a){let e={},t=Object.keys(a);for(let s of t){let n=a[s];if(B(s))e[s]=n;else{let o=n;e[s]=o.clamp(o.defaultValue)}}return e}var fe=[["keynum","keyRange"],["velocity","velRange"]],Xe=new Set(me);function B(a){return Xe.has(a)}var Ye=new Set([...Je,...me,...be,...ye]);function et(){let a=[],e=w.length;for(let t=0;t<e;t++){let s=w[t];s!==void 0&&!Ye.has(s)&&a.push(s)}return a}var G=et(),tt=new Set(G);function Y(a){return tt.has(a)}function Se(a){let e={};for(let t=0;t<a.length;t++){let s=a[t],n=s.type;if(n!==void 0&&!ge.has(s.code))if(B(n))e[n]=s.value;else{let o=n;e[o]=s.value}}return e}function Pe(a){let e={};for(let t=0;t<a.length;t++){let s=a[t],n=s.type;if(n!==void 0)if(B(n))e[n]=s.value;else{let o=n;e[o]=s.value}}for(let t=0;t<fe.length;t++){let[s,n]=fe[t],o=e[s];o!==void 0&&(e[n]=new O(o,o))}return e}var C=-32768,E=32767,H={startAddrsOffset:new p(0,0,E),endAddrsOffset:new p(C,0,0),startloopAddrsOffset:new p(C,0,E),endloopAddrsOffset:new p(C,0,E),startAddrsCoarseOffset:new p(0,0,E),modLfoToPitch:new p(-12e3,0,12e3),vibLfoToPitch:new p(-12e3,0,12e3),modEnvToPitch:new p(-12e3,0,12e3),initialFilterFc:new p(1500,13500,13500),initialFilterQ:new p(0,0,960),modLfoToFilterFc:new p(-12e3,0,12e3),modEnvToFilterFc:new p(-12e3,0,12e3),endAddrsCoarseOffset:new p(C,0,0),modLfoToVolume:new p(-960,0,960),chorusEffectsSend:new p(0,0,1e3),reverbEffectsSend:new p(0,0,1e3),pan:new p(-500,0,500),delayModLFO:new p(-12e3,-12e3,5e3),freqModLFO:new p(-16e3,0,4500),delayVibLFO:new p(-12e3,-12e3,5e3),freqVibLFO:new p(-16e3,0,4500),delayModEnv:new p(-12e3,-12e3,5e3),attackModEnv:new p(-12e3,-12e3,8e3),holdModEnv:new p(-12e3,-12e3,5e3),decayModEnv:new p(-12e3,-12e3,8e3),sustainModEnv:new p(0,0,1e3),releaseModEnv:new p(-12e3,-12e3,8e3),keynumToModEnvHold:new p(-1200,0,1200),keynumToModEnvDecay:new p(-1200,0,1200),delayVolEnv:new p(-12e3,-12e3,5e3),attackVolEnv:new p(-12e3,-12e3,8e3),holdVolEnv:new p(-12e3,-12e3,5e3),decayVolEnv:new p(-12e3,-12e3,8e3),sustainVolEnv:new p(0,0,1440),releaseVolEnv:new p(-12e3,-12e3,8e3),keynumToVolEnvHold:new p(-1200,0,1200),keynumToVolEnvDecay:new p(-1200,0,1200),instrument:new p(-1,-1,E),keyRange:new O(0,127),velRange:new O(0,127),startloopAddrsCoarseOffset:new p(C,0,E),keynum:new p(-1,-1,127),velocity:new p(-1,-1,127),initialAttenuation:new p(0,0,1440),endloopAddrsCoarseOffset:new p(C,0,E),coarseTune:new p(-120,0,120),fineTune:new p(-99,0,99),sampleID:new p(-1,-1,E),sampleModes:new p(0,0,3),scaleTuning:new p(0,100,100),exclusiveClass:new p(0,0,127),overridingRootKey:new p(-1,-1,127)};function T(a){return Math.pow(2,a/1200)}var K=class{constructor(e,t,s,n,o){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(r,i)=>{r.modLfoToPitch=this.clamp("modLfoToPitch",i)},vibLfoToPitch:(r,i)=>{r.vibLfoToPitch=this.clamp("vibLfoToPitch",i)},modEnvToPitch:(r,i)=>{r.modEnvToPitch=this.clamp("modEnvToPitch",i)},initialFilterFc:(r,i)=>{r.initialFilterFc=this.clamp("initialFilterFc",i)},initialFilterQ:(r,i)=>{r.initialFilterQ=this.clamp("initialFilterQ",i)},modLfoToFilterFc:(r,i)=>{r.modLfoToFilterFc=this.clamp("modLfoToFilterFc",i)},modEnvToFilterFc:(r,i)=>{r.modEnvToFilterFc=this.clamp("modEnvToFilterFc",i)},modLfoToVolume:(r,i)=>{r.modLfoToVolume=this.clamp("modLfoToVolume",i)},chorusEffectsSend:(r,i)=>{r.chorusEffectsSend=this.clamp("chorusEffectsSend",i)/1e3},reverbEffectsSend:(r,i)=>{r.reverbEffectsSend=this.clamp("reverbEffectsSend",i)/1e3},pan:(r,i)=>{r.pan=this.clamp("pan",i)/1e3},delayModLFO:(r,i)=>{r.delayModLFO=T(this.clamp("delayModLFO",i))},freqModLFO:(r,i)=>{r.freqModLFO=this.clamp("freqModLFO",i)},delayVibLFO:(r,i)=>{r.delayVibLFO=T(this.clamp("delayVibLFO",i))},freqVibLFO:(r,i)=>{r.freqVibLFO=this.clamp("freqVibLFO",i)},delayModEnv:(r,i)=>{r.modDelay=T(this.clamp("delayModEnv",i))},attackModEnv:(r,i)=>{r.modAttack=T(this.clamp("attackModEnv",i))},holdModEnv:(r,i)=>{let c=this.clamp("holdModEnv",i),l=this.clamp("keynumToModEnvHold",i);r.modHold=this.getModHold(c,l)},decayModEnv:(r,i)=>{let c=this.clamp("decayModEnv",i),l=this.clamp("keynumToModEnvDecay",i);r.modDecay=this.getModDecay(c,l)},sustainModEnv:(r,i)=>{r.modSustain=this.clamp("sustainModEnv",i)/1e3},releaseModEnv:(r,i)=>{r.modRelease=T(this.clamp("releaseModEnv",i))},keynumToModEnvHold:(r,i)=>{let c=this.clamp("holdModEnv",i),l=this.clamp("keynumToModEnvHold",i);r.modHold=this.getModHold(c,l)},keynumToModEnvDecay:(r,i)=>{let c=this.clamp("decayModEnv",i),l=this.clamp("keynumToModEnvDecay",i);r.modDecay=this.getModDecay(c,l)},delayVolEnv:(r,i)=>{r.volDelay=T(this.clamp("delayVolEnv",i))},attackVolEnv:(r,i)=>{r.volAttack=T(this.clamp("attackVolEnv",i))},holdVolEnv:(r,i)=>{let c=this.clamp("holdVolEnv",i),l=this.clamp("keynumToVolEnvHold",i);r.volHold=this.getVolHold(c,l)},decayVolEnv:(r,i)=>{let c=this.clamp("decayVolEnv",i),l=this.clamp("keynumToVolEnvDecay",i);r.volDecay=this.getVolDecay(c,l)},sustainVolEnv:(r,i)=>{r.volSustain=this.clamp("sustainVolEnv",i)/1e3},releaseVolEnv:(r,i)=>{r.volRelease=T(this.clamp("releaseVolEnv",i))},keynumToVolEnvHold:(r,i)=>{let c=this.clamp("holdVolEnv",i),l=this.clamp("keynumToVolEnvHold",i);r.modHold=this.getVolHold(c,l)},keynumToVolEnvDecay:(r,i)=>{let c=this.clamp("decayVolEnv",i),l=this.clamp("keynumToVolEnvDecay",i);r.modDecay=this.getVolDecay(c,l)},initialAttenuation:(r,i)=>{r.initialAttenuation=this.clamp("initialAttenuation",i)},coarseTune:(r,i)=>{r.playbackRate=this.getPlaybackRate(i)},fineTune:(r,i)=>{r.playbackRate=this.getPlaybackRate(i)},scaleTuning:(r,i)=>{r.playbackRate=this.getPlaybackRate(i)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],s=t.sourceOper.controllerType,n=t.destinationOper,o=this.controllerToDestinations.get(s);o?o.add(t.destinationOper):this.controllerToDestinations.set(s,new Set([n]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],s=t.destinationOper,n=this.destinationToModulators.get(s);n?n.push(t):this.destinationToModulators.set(s,[t])}}getModHold(e,t){return T(e+(this.key-60)*t)}getModDecay(e,t){return T(e+(this.key-60)*t)}getVolHold(e,t){return T(e+(this.key-60)*t)}getVolDecay(e,t){return T(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("coarseTune",e),s=this.clamp("fineTune",e)/100,n=this.clamp("overridingRootKey",e),o=this.clamp("scaleTuning",e)/100,r=t+s,i=n===-1?this.sampleHeader.originalPitch:n,c=r+this.sampleHeader.pitchCorrection/100-i;return Math.pow(Math.pow(2,1/12),(this.key+c)*o)}transformParams(e,t){let s={},n=this.controllerToDestinations.get(e);if(!n)return s;for(let o of n){let r=w[o];if(!r||!Y(r))continue;let i=this.destinationToModulators.get(o);if(i){s[r]=this.generators[r];for(let c of i){let l=c.sourceOper,h=l.map(t[l.controllerType]),d=1,u=c.amountSourceOper;if(!(u.cc===0&&u.index===0)){let m=t[u.controllerType];d=u.map(m)}let f=c.transform(h*d);Number.isNaN(f)||(s[r]+=f)}}}return s}transformAllParams(e){let t=structuredClone(this.generators);for(let s of this.modulators){let n=s.sourceOper.controllerType,o=e[n];if(!o)continue;let r=w[s.destinationOper];if(!r||!Y(r))continue;let c=s.sourceOper.map(o),l=1,h=s.amountSourceOper;if(!(h.cc===0&&h.index===0)){let u=e[h.controllerType];l=h.map(u)}let d=s.transform(c*l);Number.isNaN(d)||(t[r]+=d)}return t}clamp(e,t){return H[e].clamp(t[e])}getParams(e,t){let s={},n=structuredClone(this.generators),o=this.transformParams(e,t),r=Object.keys(o);for(let i of r)n[i]=o[i];for(let i of r)this.voiceHandlers[i](s,n);return s}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},s=this.transformAllParams(e);for(let n=0;n<G.length;n++){let o=G[n];this.voiceHandlers[o](t,s)}return t}};var Te=[new v(b.parse(1282),48,960,b.parse(0),0),new v(b.parse(258),8,-2400,b.parse(0),0),new v(b.parse(13),6,50,b.parse(0),0),new v(b.parse(129),6,50,b.parse(0),0),new v(b.parse(1415),48,960,b.parse(0),0),new v(b.parse(650),48,1,b.parse(0),0),new v(b.parse(1419),48,960,b.parse(0),0),new v(b.parse(219),16,.2,b.parse(0),0),new v(b.parse(221),15,.2,b.parse(0),0),new v(b.parse(526),51,127,b.parse(16),0)];var q=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},W=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},$=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,s,n){let o=new Array(n-s);for(let r=s;r<n;r++){let i=t[r].generatorIndex,c=t[r+1].generatorIndex;o[r-s]=e.slice(i,c)}return o}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],s=this.parsed.presetHeaders[e+1],n=s?s.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,n)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],s=this.parsed.instruments[e+1],n=s?s.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,n)}getModulators(e,t,s,n){let o=new Array(n-s);for(let r=s;r<n;r++){let i=t[r].modulatorIndex,c=t[r+1].modulatorIndex;o[r-s]=e.slice(i,c)}return o}getPresetModulators(e){let t=this.parsed.presetHeaders[e],s=this.parsed.presetHeaders[e+1],n=s?s.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,n)}getInstrumentModulators(e){let t=this.parsed.instruments[e],s=this.parsed.instruments[e+1],n=s?s.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,n)}findInstrumentZone(e,t,s){let n=this.getInstrumentGenerators(e),o=this.getInstrumentModulators(e),r,i=[];for(let c=0;c<n.length;c++){let l=Pe(n[c]);if(l.sampleID===void 0){r=l,i=o[c];continue}if(!(l.keyRange&&!l.keyRange.in(t))&&!(l.velRange&&!l.velRange.in(s)))if(r){let h={...r,...l},d=[...i,...o[c]];return new q(h,d)}else return new q(l,o[c])}}findInstrument(e,t,s){let n=this.getPresetGenerators(e),o=this.getPresetModulators(e),r,i=[];for(let c=0;c<n.length;c++){let l=Se(n[c]);if(l.instrument===void 0){r=l,i=o[c];continue}if(l.keyRange&&!l.keyRange.in(t)||l.velRange&&!l.velRange.in(s))continue;let h=this.findInstrumentZone(l.instrument,t,s);if(h)if(r){let d={...r,...l},u=[...i,...o[c]],f=new W(d,u);return this.createVoice(t,f,h)}else{let d=new W(l,o[c]);return this.createVoice(t,d,h)}}return null}createVoice(e,t,s){let n=ve(H);Object.assign(n,s.generators);let o=Object.keys(t.generators);for(let h=0;h<o.length;h++){let d=o[h];B(d)||(n[d]+=t.generators[d])}let r=[...Te,...t.modulators,...s.modulators],i=n.sampleID,c=this.parsed.samples[i],l=this.parsed.sampleHeaders[i];return new K(e,n,r,c,l)}getVoice(e,t,s,n){let o=this.parsed.presetHeaders.findIndex(i=>i.preset===t&&i.bank===e);if(o<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let r=this.findInstrument(o,s,n);return r||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let s=0;s<t.length;s++){let n=t[s];e[n.bank]||(e[n.bank]={}),e[n.bank][n.preset]=n.presetName}return e}};var M=class{constructor(e){this.data=new Array(e),this.activeIndices=[]}set(e,t){this.data[e]===void 0&&this.activeIndices.push(e),this.data[e]=t}get(e){return this.data[e]}delete(e){if(this.data[e]!==void 0){this.data[e]=void 0;let t=this.activeIndices.indexOf(e);return t!==-1&&this.activeIndices.splice(t,1),!0}return!1}has(e){return this.data[e]!==void 0}get size(){return this.activeIndices.length}clear(){for(let e=0;e<this.activeIndices.length;e++){let t=this.activeIndices[e];this.data[t]=void 0}this.activeIndices=[]}*[Symbol.iterator](){for(let e=0;e<this.activeIndices.length;e++){let t=this.activeIndices[e];yield[t,this.data[t]]}}forEach(e){for(let t=0;t<this.activeIndices.length;t++){let s=this.activeIndices[t];e(this.data[s],s,this)}}},ee=class{bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;volumeNode;gainL;gainR;modulationLFO;modulationDepth;vibratoLFO;vibratoDepth;reverbEffectsSend;chorusEffectsSend;portamento;pressure=0;constructor(e,t,s,n,o){this.noteNumber=e,this.velocity=t,this.startTime=s,this.voice=n,this.voiceParams=o}},te={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},polyphonicKeyPressure:{type:10,defaultValue:0},channelPressure:{type:13,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepth:{type:129,defaultValue:0},portamentoTime:{type:133,defaultValue:0},volume:{type:135,defaultValue:100/127},pan:{type:138,defaultValue:.5},expression:{type:139,defaultValue:1},sustainPedal:{type:192,defaultValue:0},portamento:{type:193,defaultValue:0},sostenutoPedal:{type:194,defaultValue:0},softPedal:{type:195,defaultValue:0},filterResonance:{type:199,defaultValue:.5},releaseTime:{type:200,defaultValue:.5},attackTime:{type:201,defaultValue:.5},brightness:{type:202,defaultValue:.5},decayTime:{type:203,defaultValue:.5},vibratoRate:{type:204,defaultValue:.5},vibratoDepth:{type:205,defaultValue:.5},vibratoDelay:{type:206,defaultValue:.5},reverbSendLevel:{type:219,defaultValue:0},chorusSendLevel:{type:221,defaultValue:0}},ne=class{array=new Float32Array(256);constructor(){let e=Object.entries(te);for(let[t,{type:s,defaultValue:n}]of e)this.array[s]=n,Object.defineProperty(this,t,{get:()=>this.array[s],set:o=>this.array[s]=o,enumerable:!0,configurable:!0})}},se=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain","modRelease","playbackRate"],nt=new Set(se),re=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],st=new Set(re),we=class{ticksPerBeat=120;totalTime=0;masterFineTuning=0;masterCoarseTuning=0;reverb={time:this.getReverbTime(64),feedback:.8};chorus={modRate:this.getChorusModRate(3),modDepth:this.getChorusModDepth(19),feedback:this.getChorusFeedback(8),sendToReverb:this.getChorusSendToReverb(0),delayTimes:this.generateDistributedArray(.02,2,.5)};noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=this.initSoundFontTable();audioBufferCounter=new Map;audioBufferCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;timeline=[];instruments=[];notePromises=[];exclusiveClassMap=new M(128);static channelSettings={currentBufferSource:null,detune:0,program:0,bank:15488,bankMSB:121,bankLSB:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,mono:!1,fineTuning:0,coarseTuning:0,modulationDepthRange:50};defaultOptions={reverbAlgorithm:e=>{let{time:t,feedback:s}=this.reverb,n=this.generateDistributedArray(s,4),o=n.map(c=>this.calcDelay(t,c)),r=this.generateDistributedArray(s,4),i=r.map(c=>this.calcDelay(t,c));return this.createSchroederReverb(e,n,o,r,i)}};constructor(e,t=this.defaultOptions){this.audioContext=e,this.options={...this.defaultOptions,...t},this.masterVolume=new GainNode(e),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.reverbEffect=this.options.reverbAlgorithm(e),this.chorusEffect=this.createChorusEffect(e),this.chorusEffect.output.connect(this.masterVolume),this.reverbEffect.output.connect(this.masterVolume),this.masterVolume.connect(e.destination),this.GM2SystemOn()}initSoundFontTable(){let e=new Array(128);for(let t=0;t<128;t++)e[t]=new M(128);return e}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let s=e.parsed.presetHeaders;for(let n=0;n<s.length;n++){let o=s[n];o.presetName.startsWith("\0")||this.soundFontTable[o.preset].set(o.bank,t)}}async loadSoundFont(e){let s=await(await fetch(e)).arrayBuffer(),n=he(new Uint8Array(s)),o=new $(n);this.addSoundFont(o)}async loadMIDI(e){let s=await(await fetch(e)).arrayBuffer(),n=(0,xe.parseMidi)(new Uint8Array(s));this.ticksPerBeat=n.header.ticksPerBeat;let o=this.extractMidiData(n);this.instruments=o.instruments,this.timeline=o.timeline,this.totalTime=this.calcTotalTime()}setChannelAudioNodes(e){let{gainLeft:t,gainRight:s}=this.panToGain(te.pan.defaultValue),n=new GainNode(e,{gain:t}),o=new GainNode(e,{gain:s}),r=new ChannelMergerNode(e,{numberOfInputs:2});return n.connect(r,0,0),o.connect(r,0,1),r.connect(this.masterVolume),{gainL:n,gainR:o,merger:r}}createChannels(e){return Array.from({length:16},()=>({...this.constructor.channelSettings,state:new ne,controlTable:this.initControlTable(),...this.setChannelAudioNodes(e),scheduledNotes:new M(128),sustainNotes:[],sostenutoNotes:new M(128),scaleOctaveTuningTable:new Float32Array(12),channelPressureTable:new Uint8Array([64,64,64,0,0,0]),polyphonicKeyPressureTable:new Uint8Array([64,64,64,0,0,0]),keyBasedInstrumentControlTable:new Int8Array(16384)}))}async createNoteBuffer(e,t){let s=e.start,n=e.sample.length+e.end;if(t){let o=e.sample,r=o.byteOffset+s,i=o.byteOffset+n,c=o.buffer.slice(r,i);return await this.audioContext.decodeAudioData(c)}else{let o=e.sample,r=o.byteOffset+s,i=o.byteOffset+n,c=o.buffer.slice(r,i),l=new AudioBuffer({numberOfChannels:1,length:o.length,sampleRate:e.sampleRate}),h=l.getChannelData(0),d=new Int16Array(c);for(let u=0;u<d.length;u++)h[u]=d[u]/32768;return l}}createNoteBufferNode(e,t){let s=new AudioBufferSourceNode(this.audioContext);return s.buffer=e,s.loop=t.sampleModes%2!==0,s.loop&&(s.loopStart=t.loopStart/t.sampleRate,s.loopEnd=t.loopEnd/t.sampleRate),s}findPortamentoTarget(e){let t=this.timeline[e];if(!this.channels[t.channel].portamento)return;let s=t.startTime,n;for(;++e<this.timeline.length;){let o=this.timeline[e];if(s!==o.startTime)break;o.type==="noteOn"&&(!n||o.noteNumber<n.noteNumber)&&(n=o)}return n}async scheduleTimelineEvents(e,t,s){for(;s<this.timeline.length;){let n=this.timeline[s];if(n.startTime>e+this.lookAhead)break;let o=n.startTime+this.startDelay-t;switch(n.type){case"noteOn":if(n.velocity!==0){await this.scheduleNoteOn(n.channel,n.noteNumber,n.velocity,o,n.portamento);break}case"noteOff":{let r=this.findPortamentoTarget(s);r&&(r.portamento=!0);let i=this.scheduleNoteOff(n.channel,n.noteNumber,n.velocity,o,!1,r?.noteNumber);i&&this.notePromises.push(i);break}case"noteAftertouch":this.handlePolyphonicKeyPressure(n.channel,n.noteNumber,n.amount,o);break;case"controller":this.handleControlChange(n.channel,n.controllerType,n.value,o);break;case"programChange":this.handleProgramChange(n.channel,n.programNumber,o);break;case"channelAftertouch":this.handleChannelPressure(n.channel,n.amount,o);break;case"pitchBend":this.setPitchBend(n.channel,n.value+8192,o);break;case"sysEx":this.handleSysEx(n.data,o)}s++}return s}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}playNotes(){return new Promise(e=>{this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let t=this.getQueueIndex(this.resumeTime),s=this.resumeTime-this.startTime;this.notePromises=[];let n=async()=>{if(t>=this.timeline.length){await Promise.all(this.notePromises),this.notePromises=[],this.exclusiveClassMap.clear(),this.audioBufferCache.clear(),e();return}let o=this.audioContext.currentTime,r=o+s;if(t=await this.scheduleTimelineEvents(r,s,t),this.isPausing){await this.stopNotes(0,!0,o),this.notePromises=[],e(),this.isPausing=!1,this.isPaused=!0;return}else if(this.isStopping){await this.stopNotes(0,!0,o),this.notePromises=[],this.exclusiveClassMap.clear(),this.audioBufferCache.clear(),e(),this.isStopping=!1,this.isPaused=!1;return}else if(this.isSeeking)this.stopNotes(0,!0,o),this.exclusiveClassMap.clear(),this.startTime=this.audioContext.currentTime,t=this.getQueueIndex(this.resumeTime),s=this.resumeTime-this.startTime,this.isSeeking=!1,await n();else{let i=o+this.noteCheckInterval;await this.scheduleTask(()=>{},i),await n()}};n()})}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}getAudioBufferId(e,t,s){return`${e}:${t}:${s}`}extractMidiData(e){let t=new Set,s=[],n=new Array(16);for(let l=0;l<n.length;l++)n[l]={programNumber:-1,bankMSB:this.channels[l].bankMSB,bankLSB:this.channels[l].bankLSB};for(let l=0;l<e.tracks.length;l++){let h=e.tracks[l],d=0;for(let u=0;u<h.length;u++){let f=h[u];switch(d+=f.deltaTime,f.ticks=d,f.type){case"noteOn":{let m=n[f.channel],g=this.getAudioBufferId(m.programNumber,f.noteNumber,f.velocity);if(this.audioBufferCounter.set(g,(this.audioBufferCounter.get(g)??0)+1),m.programNumber<0){switch(m.programNumber=f.programNumber,m.bankMSB){case 120:t.add("128:0");break;case 121:t.add(`${m.bankLSB}:0`);break;default:{let F=m.bankMSB*128+m.bankLSB;t.add(`${F}:0`)}}m.programNumber=0}break}case"controller":switch(f.controllerType){case 0:n[f.channel].bankMSB=f.value;break;case 32:n[f.channel].bankLSB=f.value;break}break;case"programChange":{let m=n[f.channel];switch(m.programNumber=f.programNumber,m.bankMSB){case 120:t.add(`128:${m.programNumber}`);break;case 121:t.add(`${m.bankLSB}:${m.programNumber}`);break;default:{let g=m.bankMSB*128+m.bankLSB;t.add(`${g}:${m.programNumber}`)}}}}delete f.deltaTime,s.push(f)}}for(let[l,h]of this.audioBufferCounter)h===1&&this.audioBufferCounter.delete(l);let o={controller:0,sysEx:1,noteOff:2,noteOn:3};s.sort((l,h)=>l.ticks!==h.ticks?l.ticks-h.ticks:(o[l.type]||4)-(o[h.type]||4));let r=0,i=0,c=.5;for(let l=0;l<s.length;l++){let h=s[l],d=this.ticksToSecond(h.ticks-i,c);h.startTime=r+d,h.type==="setTempo"&&(r+=this.ticksToSecond(h.ticks-i,c),c=h.microsecondsPerBeat/1e6,i=h.ticks)}return{instruments:t,timeline:s}}stopChannelNotes(e,t,s,n){let o=this.channels[e],r=[];return this.processScheduledNotes(o,i=>{let c=this.scheduleNoteOff(e,i.noteNumber,t,n,s,void 0);this.notePromises.push(c),r.push(c)}),o.scheduledNotes.clear(),Promise.all(r)}stopNotes(e,t,s){let n=[];for(let o=0;o<this.channels.length;o++)n.push(this.stopChannelNotes(o,e,t,s));return Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,await this.playNotes(),this.isPlaying=!1)}stop(){this.isPlaying&&(this.isStopping=!0)}pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}async resume(){this.isPaused&&(await this.playNotes(),this.isPlaying=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let s=this.timeline[t];e<s.startTime&&(e=s.startTime)}return e}currentTime(){let e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}processScheduledNotes(e,t){e.scheduledNotes.forEach(s=>{for(let n=0;n<s.length;n++){let o=s[n];o&&t(o)}})}getActiveNotes(e,t){let s=new M(128);return e.scheduledNotes.forEach(n=>{let o=this.getActiveNote(n,t);o&&s.set(o.noteNumber,o)}),s}getActiveNote(e,t){for(let s=e.length-1;s>=0;s--){let n=e[s];if(!n)return;if(!(t<n.startTime))return n.ending?null:n}return e[0]}createConvolutionReverbImpulse(e,t,s){let n=e.sampleRate,o=n*t,r=new AudioBuffer({numberOfChannels:2,length:o,sampleRate:n}),i=Math.min(n*s,o);for(let c=0;c<r.numberOfChannels;c++){let l=r.getChannelData(c);for(let d=0;d<i;d++)l[d]=Math.random()*2-1;let h=1/(n*t);for(let d=i;d<o;d++){let u=Math.exp(-(d-i)*h);l[d]=(Math.random()*2-1)*u}}return r}createConvolutionReverb(e,t){let s=new GainNode(e),n=new ConvolverNode(e,{buffer:t});return s.connect(n),{input:s,output:n,convolverNode:n}}createCombFilter(e,t,s,n){let o=new DelayNode(e,{maxDelayTime:s,delayTime:s}),r=new GainNode(e,{gain:n});return t.connect(o),o.connect(r),r.connect(o),o}createAllpassFilter(e,t,s,n){let o=new DelayNode(e,{maxDelayTime:s,delayTime:s}),r=new GainNode(e,{gain:n}),i=new GainNode(e,{gain:1-n});return t.connect(o),o.connect(r),r.connect(o),o.connect(i),i}generateDistributedArray(e,t,s=.1,n=.05){let o=e*s,r=new Array(t);for(let i=0;i<t;i++){let c=i/(t-1||1),l=e-o+c*2*o;r[i]=l*(1-(Math.random()*2-1)*n)}return r}createSchroederReverb(e,t,s,n,o){let r=new GainNode(e),i=new GainNode(e);for(let h=0;h<s.length;h++)this.createCombFilter(e,r,s[h],t[h]).connect(i);let c=[];for(let h=0;h<o.length;h++){let d=this.createAllpassFilter(e,h===0?i:c.at(-1),o[h],n[h]);c.push(d)}let l=c.at(-1);return{input:r,output:l}}createChorusEffect(e){let t=new GainNode(e),s=new GainNode(e),n=new GainNode(e),o=new OscillatorNode(e,{frequency:this.chorus.modRate}),r=new GainNode(e,{gain:this.chorus.modDepth/2}),i=this.chorus.delayTimes,c=[],l=[];for(let h=0;h<i.length;h++){let d=i[h],u=new DelayNode(e,{maxDelayTime:.1,delayTime:d}),f=new GainNode(e,{gain:this.chorus.feedback});c.push(u),l.push(f),t.connect(u),r.connect(u.delayTime),u.connect(f),f.connect(u),u.connect(s)}return s.connect(n),o.connect(r),o.start(),{input:t,output:s,sendGain:n,lfo:o,lfoGain:r,delayNodes:c,feedbackGains:l}}cbToRatio(e){return Math.pow(10,e/200)}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=this.masterCoarseTuning+this.masterFineTuning,s=e.coarseTuning+e.fineTuning,n=t+s,o=e.state.pitchWheel*2-1,r=e.state.pitchWheelSensitivity*12800,i=o*r,l=(e.channelPressureTable[0]-64)/37.5*e.state.channelPressure;return n+i+l}calcNoteDetune(e,t){return e.scaleOctaveTuningTable[t.noteNumber%12]}updateChannelDetune(e,t){this.processScheduledNotes(e,s=>{this.updateDetune(e,s,t)})}updateDetune(e,t,s){let n=this.calcNoteDetune(e,t),o=this.getPitchControl(e,t),r=e.detune+n+o;t.bufferSource.detune.cancelScheduledValues(s).setValueAtTime(r,s)}getPortamentoTime(e){let t=5*Math.log(10)/127,s=e.state.portamentoTime;return Math.log(s)/t}setPortamentoStartVolumeEnvelope(e,t,s){let{voiceParams:n,startTime:o}=t,i=this.cbToRatio(-n.initialAttenuation)*(1-n.volSustain),c=o+n.volDelay,l=c+this.getPortamentoTime(e);t.volumeEnvelopeNode.gain.cancelScheduledValues(s).setValueAtTime(0,c).linearRampToValueAtTime(i,l)}setVolumeEnvelope(e,t,s){let n=e.state,{voiceParams:o,startTime:r}=t,i=this.cbToRatio(-o.initialAttenuation)*(1+this.getAmplitudeControl(e,t)),c=i*(1-o.volSustain),l=r+o.volDelay,h=l+o.volAttack*n.attackTime*2,d=h+o.volHold,u=d+o.volDecay*n.decayTime*2;t.volumeEnvelopeNode.gain.cancelScheduledValues(s).setValueAtTime(0,r).setValueAtTime(1e-6,l).exponentialRampToValueAtTime(i,h).setValueAtTime(i,d).linearRampToValueAtTime(c,u)}setPitchEnvelope(e,t){let{voiceParams:s}=e,n=s.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(n,t);let o=s.modEnvToPitch;if(o===0)return;let i=this.rateToCent(n)+o,c=this.centToRate(i),l=e.startTime+s.modDelay,h=l+s.modAttack,d=h+s.modHold,u=d+s.modDecay;e.bufferSource.playbackRate.setValueAtTime(n,l).exponentialRampToValueAtTime(c,h).setValueAtTime(c,d).linearRampToValueAtTime(n,u)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setPortamentoStartFilterEnvelope(e,t,s){let n=e.state,{voiceParams:o,noteNumber:r,startTime:i}=t,c=1-(.1+r/127*.2)*n.softPedal,l=this.centToHz(o.initialFilterFc)*c*n.brightness*2,h=this.centToHz(o.initialFilterFc+o.modEnvToFilterFc)*c*n.brightness*2,d=l+(h-l)*(1-o.modSustain),u=this.clampCutoffFrequency(l),f=this.clampCutoffFrequency(d),m=i+this.getPortamentoTime(e),g=i+o.modDelay;t.filterNode.frequency.cancelScheduledValues(s).setValueAtTime(u,i).setValueAtTime(u,g).linearRampToValueAtTime(f,m)}setFilterEnvelope(e,t,s){let n=e.state,{voiceParams:o,noteNumber:r,startTime:i}=t,c=1-(.1+r/127*.2)*n.softPedal,l=o.initialFilterFc+this.getFilterCutoffControl(e,t),h=this.centToHz(l)*c*n.brightness*2,d=this.centToHz(l+o.modEnvToFilterFc)*c*n.brightness*2,u=h+(d-h)*(1-o.modSustain),f=this.clampCutoffFrequency(h),m=this.clampCutoffFrequency(d),g=this.clampCutoffFrequency(u),F=i+o.modDelay,I=F+o.modAttack,x=I+o.modHold,P=x+o.modDecay;t.filterNode.frequency.cancelScheduledValues(s).setValueAtTime(f,i).setValueAtTime(f,F).exponentialRampToValueAtTime(m,I).setValueAtTime(m,x).linearRampToValueAtTime(g,P)}startModulation(e,t,s){let{voiceParams:n}=t;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(n.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:n.modLfoToFilterFc}),t.modulationDepth=new GainNode(this.audioContext),this.setModLfoToPitch(e,t,s),t.volumeDepth=new GainNode(this.audioContext),this.setModLfoToVolume(e,t,s),t.modulationLFO.start(t.startTime+n.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}startVibrato(e,t,s){let{voiceParams:n}=t,o=e.state;t.vibratoLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(n.freqVibLFO)*o.vibratoRate*2}),t.vibratoLFO.start(t.startTime+n.delayVibLFO*o.vibratoDelay*2),t.vibratoDepth=new GainNode(this.audioContext),this.setVibLfoToPitch(e,t,s),t.vibratoLFO.connect(t.vibratoDepth),t.vibratoDepth.connect(t.bufferSource.detune)}async getAudioBuffer(e,t,s,n,o){let r=this.getAudioBufferId(e,t,s),i=this.audioBufferCache.get(r);if(i)return i.counter+=1,i.maxCount<=i.counter&&this.audioBufferCache.delete(r),i.audioBuffer;{let c=this.audioBufferCounter.get(r)??0,l=await this.createNoteBuffer(n,o),h={audioBuffer:l,maxCount:c,counter:1};return this.audioBufferCache.set(r,h),l}}async createNote(e,t,s,n,o,r,i){let c=this.audioContext.currentTime,l=e.state,h=this.getControllerState(e,s,n),d=t.getAllParams(h),u=new ee(s,n,o,t,d),f=await this.getAudioBuffer(e.program,s,n,d,i);return u.bufferSource=this.createNoteBufferNode(f,d),u.volumeNode=new GainNode(this.audioContext),u.gainL=new GainNode(this.audioContext),u.gainR=new GainNode(this.audioContext),u.volumeEnvelopeNode=new GainNode(this.audioContext),u.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:d.initialFilterQ/5*l.filterResonance}),r?(u.portamento=!0,this.setPortamentoStartVolumeEnvelope(e,u,c),this.setPortamentoStartFilterEnvelope(e,u,c)):(u.portamento=!1,this.setVolumeEnvelope(e,u,c),this.setFilterEnvelope(e,u,c)),0<l.vibratoDepth&&this.startVibrato(e,u,c),this.setPitchEnvelope(u,c),0<l.modulationDepth&&this.startModulation(e,u,c),e.mono&&e.currentBufferSource&&(e.currentBufferSource.stop(o),e.currentBufferSource=u.bufferSource),u.bufferSource.connect(u.filterNode),u.filterNode.connect(u.volumeEnvelopeNode),u.volumeEnvelopeNode.connect(u.volumeNode),u.volumeNode.connect(u.gainL),u.volumeNode.connect(u.gainR),0<e.chorusSendLevel&&this.setChorusEffectsSend(e,u,0,c),0<e.reverbSendLevel&&this.setReverbEffectsSend(e,u,0,c),u.bufferSource.start(o),u}calcBank(e,t){return e.bankMSB===121?0:t%9<=1&&e.bankMSB===120?128:e.bank}async scheduleNoteOn(e,t,s,n,o){let r=this.channels[e],i=this.calcBank(r,e),c=this.soundFontTable[r.program].get(i);if(c===void 0)return;let l=this.soundFonts[c],h=l.getVoice(i,r.program,t,s);if(!h)return;let d=l.parsed.info.version.major===3,u=await this.createNote(r,h,t,s,n,o,d);u.gainL.connect(r.gainL),u.gainR.connect(r.gainR),.5<=r.state.sustainPedal&&r.sustainNotes.push(u);let f=u.voiceParams.exclusiveClass;if(f!==0){if(this.exclusiveClassMap.has(f)){let g=this.exclusiveClassMap.get(f),[F,I]=g;F.ending||this.scheduleNoteOff(I,F.noteNumber,0,n,!0,void 0)}this.exclusiveClassMap.set(f,[u,e])}let m=r.scheduledNotes;m.has(t)?m.get(t).push(u):m.set(t,[u])}noteOn(e,t,s,n){return n??=this.audioContext.currentTime,this.scheduleNoteOn(e,t,s,n,!1)}stopNote(e,t,s,n){let o=s[n];return o.volumeEnvelopeNode.gain.cancelScheduledValues(e).linearRampToValueAtTime(0,t),o.ending=!0,this.scheduleTask(()=>{o.bufferSource.loop=!1},t),new Promise(r=>{o.bufferSource.onended=()=>{s[n]=null,o.bufferSource.disconnect(),o.filterNode.disconnect(),o.volumeEnvelopeNode.disconnect(),o.volumeNode.disconnect(),o.gainL.disconnect(),o.gainR.disconnect(),o.modulationDepth&&(o.volumeDepth.disconnect(),o.modulationDepth.disconnect(),o.modulationLFO.stop()),o.vibratoDepth&&(o.vibratoDepth.disconnect(),o.vibratoLFO.stop()),o.reverbEffectsSend&&o.reverbEffectsSend.disconnect(),o.chorusEffectsSend&&o.chorusEffectsSend.disconnect(),r()},o.bufferSource.stop(t)})}scheduleNoteOff(e,t,s,n,o,r){let i=this.channels[e],c=i.state;if(!o&&(.5<=c.sustainPedal||i.sostenutoNotes.has(t))||!i.scheduledNotes.has(t))return;let l=i.scheduledNotes.get(t);for(let h=0;h<l.length;h++){let d=l[h];if(d&&!d.ending)if(r===void 0){let u=n+d.voiceParams.volRelease*c.releaseTime*2,f=n+d.voiceParams.modRelease;d.filterNode.frequency.cancelScheduledValues(n).linearRampToValueAtTime(0,f);let m=Math.min(u,f);return this.stopNote(n,m,l,h)}else{let u=n+this.getPortamentoTime(i),f=r-t,g=d.voiceParams.playbackRate*Math.pow(2,f/12);return d.bufferSource.playbackRate.cancelScheduledValues(n).linearRampToValueAtTime(g,u),this.stopNote(n,u,l,h)}}}noteOff(e,t,s,n){return n??=this.audioContext.currentTime,this.scheduleNoteOff(e,t,s,n,!1,void 0)}releaseSustainPedal(e,t,s){let n=t*2,o=this.channels[e],r=[];for(let i=0;i<o.sustainNotes.length;i++){let c=this.noteOff(e,o.sustainNotes[i].noteNumber,n,s);r.push(c)}return o.sustainNotes=[],r}releaseSostenutoPedal(e,t,s){let n=t*2,o=this.channels[e],r=[];return o.state.sostenutoPedal=0,o.sostenutoNotes.forEach(i=>{let c=this.noteOff(e,i.noteNumber,n,s);r.push(c)}),o.sostenutoNotes.clear(),r}handleMIDIMessage(e,t,s,n){let o=e&15,r=e&240;switch(r){case 128:return this.noteOff(o,t,s,n);case 144:return this.noteOn(o,t,s,n);case 160:return this.handlePolyphonicKeyPressure(o,t,s,n);case 176:return this.handleControlChange(o,t,s,n);case 192:return this.handleProgramChange(o,t,n);case 208:return this.handleChannelPressure(o,t,n);case 224:return this.handlePitchBendMessage(o,t,s,n);default:console.warn(`Unsupported MIDI message: ${r.toString(16)}`)}}handlePolyphonicKeyPressure(e,t,s,n){let o=this.channels[e];o.state.polyphonicKeyPressure=s/127;let r=o.polyphonicKeyPressureTable,i=this.getActiveNotes(o,n);if(i.has(t)){let c=i.get(t);this.setControllerParameters(o,c,r)}}handleProgramChange(e,t,s){let n=this.channels[e];n.bank=n.bankMSB*128+n.bankLSB,n.program=t}handleChannelPressure(e,t,s){let n=this.channels[e],o=n.state.channelPressure,r=t/127;if(n.state.channelPressure=r,n.channelPressureTable[0]!==64){let c=(n.channelPressureTable[0]-64)/37.5;n.detune+=c*(r-o)}let i=n.channelPressureTable;this.getActiveNotes(n,s).forEach(c=>{this.setControllerParameters(n,c,i)})}handlePitchBendMessage(e,t,s,n){let o=s*128+t;this.setPitchBend(e,o,n)}setPitchBend(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e],o=n.state,r=o.pitchWheel*2-1,i=(t-8192)/8192;o.pitchWheel=t/16383,n.detune+=(i-r)*o.pitchWheelSensitivity*12800,this.updateChannelDetune(n,s),this.applyVoiceParams(n,14,s)}setModLfoToPitch(e,t,s){let n=t.voiceParams.modLfoToPitch+this.getLFOPitchDepth(e,t),r=(Math.abs(n)+e.state.modulationDepth)*Math.sign(n);t.modulationDepth.gain.cancelScheduledValues(s).setValueAtTime(r,s)}setVibLfoToPitch(e,t,s){let n=t.voiceParams.vibLfoToPitch,o=Math.abs(n)*e.state.vibratoDepth*2,r=0<n;t.vibratoDepth.gain.cancelScheduledValues(s).setValueAtTime(o*r,s)}setModLfoToFilterFc(e,t,s){let n=t.voiceParams.modLfoToFilterFc+this.getLFOFilterDepth(e,t);t.filterDepth.gain.cancelScheduledValues(s).setValueAtTime(n,s)}setModLfoToVolume(e,t,s){let n=t.voiceParams.modLfoToVolume,r=(this.cbToRatio(Math.abs(n))-1)*Math.sign(n)*(1+this.getLFOAmplitudeDepth(e,t));t.volumeDepth.gain.cancelScheduledValues(s).setValueAtTime(r,s)}setReverbEffectsSend(e,t,s,n){if(0<s)if(0<t.voiceParams.reverbEffectsSend){let o=this.getKeyBasedInstrumentControlValue(e,t.noteNumber,91),r=t.voiceParams.reverbEffectsSend+o;t.reverbEffectsSend.gain.cancelScheduledValues(n).setValueAtTime(r,n)}else t.reverbEffectsSend.disconnect();else 0<t.voiceParams.reverbEffectsSend&&(t.reverbEffectsSend||(t.reverbEffectsSend=new GainNode(this.audioContext,{gain:t.voiceParams.reverbEffectsSend}),t.volumeNode.connect(t.reverbEffectsSend)),t.reverbEffectsSend.connect(this.reverbEffect.input))}setChorusEffectsSend(e,t,s,n){if(0<s)if(0<t.voiceParams.chorusEffectsSend){let o=this.getKeyBasedInstrumentControlValue(e,t.noteNumber,93),r=t.voiceParams.chorusEffectsSend+o;t.chorusEffectsSend.gain.cancelScheduledValues(n).setValueAtTime(r,n)}else t.chorusEffectsSend.disconnect();else 0<t.voiceParams.chorusEffectsSend&&(t.chorusEffectsSend||(t.chorusEffectsSend=new GainNode(this.audioContext,{gain:t.voiceParams.chorusEffectsSend}),t.volumeNode.connect(t.chorusEffectsSend)),t.chorusEffectsSend.connect(this.chorusEffect.input))}setDelayModLFO(e,t){let s=e.startTime;s<t||(e.modulationLFO.stop(t),e.modulationLFO.start(s+e.voiceParams.delayModLFO),e.modulationLFO.connect(e.filterDepth))}setFreqModLFO(e,t){let s=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(s,t)}setFreqVibLFO(e,t,s){let n=t.voiceParams.freqVibLFO;t.vibratoLFO.frequency.cancelScheduledValues(s).setValueAtTime(n*e.state.vibratoRate*2,s)}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,s,n)=>{0<e.state.modulationDepth&&this.setModLfoToPitch(e,t,n)},vibLfoToPitch:(e,t,s,n)=>{0<e.state.vibratoDepth&&this.setVibLfoToPitch(e,t,n)},modLfoToFilterFc:(e,t,s,n)=>{0<e.state.modulationDepth&&this.setModLfoToFilterFc(e,t,n)},modLfoToVolume:(e,t,s,n)=>{0<e.state.modulationDepth&&this.setModLfoToVolume(e,t,n)},chorusEffectsSend:(e,t,s,n)=>{this.setChorusEffectsSend(e,t,s,n)},reverbEffectsSend:(e,t,s,n)=>{this.setReverbEffectsSend(e,t,s,n)},delayModLFO:(e,t,s,n)=>this.setDelayModLFO(t,n),freqModLFO:(e,t,s,n)=>this.setFreqModLFO(t,n),delayVibLFO:(e,t,s,n)=>{if(0<e.state.vibratoDepth){let o=e.state.vibratoDelay*2,r=t.startTime+s*o;if(n<r)return;let i=t.voiceParams.delayVibLFO,c=t.startTime+i*o;t.vibratoLFO.stop(n),t.vibratoLFO.start(c)}},freqVibLFO:(e,t,s,n)=>{0<e.state.vibratoDepth&&this.setFreqVibLFO(e,t,n)}}}getControllerState(e,t,s){let n=new Float32Array(e.state.array.length);return n.set(e.state.array),n[2]=s/127,n[3]=t/127,n}applyVoiceParams(e,t,s){this.processScheduledNotes(e,n=>{let o=this.getControllerState(e,n.noteNumber,n.velocity),r=n.voice.getParams(t,o),i=!1,c=!1;for(let[l,h]of Object.entries(r)){let d=n.voiceParams[l];if(h!==d){if(n.voiceParams[l]=h,l in this.voiceParamsHandlers)this.voiceParamsHandlers[l](e,n,d,s);else if(nt.has(l)){if(i)continue;i=!0;let u=n.voiceParams;for(let f=0;f<se.length;f++){let m=se[f];m in r&&(u[m]=r[m])}n.portamento?this.setPortamentoStartFilterEnvelope(e,n,s):this.setFilterEnvelope(e,n,s),this.setPitchEnvelope(n,s)}else if(st.has(l)){if(c)continue;c=!0;let u=n.voiceParams;for(let f=0;f<re.length;f++){let m=re[f];m in r&&(u[m]=r[m])}this.setVolumeEnvelope(e,n,s)}}}})}createControlChangeHandlers(){return{0:this.setBankMSB,1:this.setModulationDepth,5:this.setPortamentoTime,6:this.dataEntryMSB,7:this.setVolume,10:this.setPan,11:this.setExpression,32:this.setBankLSB,38:this.dataEntryLSB,64:this.setSustainPedal,65:this.setPortamento,66:this.setSostenutoPedal,67:this.setSoftPedal,71:this.setFilterResonance,72:this.setReleaseTime,73:this.setAttackTime,74:this.setBrightness,75:this.setDecayTime,76:this.setVibratoRate,77:this.setVibratoDepth,78:this.setVibratoDelay,91:this.setReverbSendLevel,93:this.setChorusSendLevel,96:this.dataIncrement,97:this.dataDecrement,100:this.setRPNLSB,101:this.setRPNMSB,120:this.allSoundOff,121:this.resetAllControllers,123:this.allNotesOff,124:this.omniOff,125:this.omniOn,126:this.monoOn,127:this.polyOn}}handleControlChange(e,t,s,n){let o=this.controlChangeHandlers[t];if(o){o.call(this,e,s,n);let r=this.channels[e];this.applyVoiceParams(r,t+128,n),this.applyControlTable(r,t)}else console.warn(`Unsupported Control change: controllerType=${t} value=${s}`)}setBankMSB(e,t){this.channels[e].bankMSB=t}updateModulation(e,t){let s=e.state.modulationDepth*e.modulationDepthRange;this.processScheduledNotes(e,n=>{n.modulationDepth?n.modulationDepth.gain.setValueAtTime(s,t):(this.setPitchEnvelope(n,t),this.startModulation(e,n,t))})}setModulationDepth(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.modulationDepth=t/127,this.updateModulation(n,s)}setPortamentoTime(e,t){let s=this.channels[e],n=5*Math.log(10)/127;s.state.portamentoTime=Math.exp(n*t)}setKeyBasedVolume(e,t){this.processScheduledNotes(e,s=>{let n=this.getKeyBasedInstrumentControlValue(e,s.noteNumber,7);n!==0&&s.volumeNode.gain.cancelScheduledValues(t).setValueAtTime(1+n,t)})}setVolume(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.volume=t/127,this.updateChannelVolume(n,s),this.setKeyBasedVolume(n,s)}panToGain(e){let t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setKeyBasedPan(e,t){this.processScheduledNotes(e,s=>{let n=this.getKeyBasedInstrumentControlValue(e,s.noteNumber,10);if(n!==0){let{gainLeft:o,gainRight:r}=this.panToGain((n+1)/2);s.gainL.gain.cancelScheduledValues(t).setValueAtTime(o,t),s.gainR.gain.cancelScheduledValues(t).setValueAtTime(r,t)}})}setPan(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.pan=t/127,this.updateChannelVolume(n,s),this.setKeyBasedPan(n,s)}setExpression(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.expression=t/127,this.updateChannelVolume(n,s)}setBankLSB(e,t){this.channels[e].bankLSB=t}dataEntryLSB(e,t,s){this.channels[e].dataLSB=t,this.handleRPN(e,s)}updateChannelVolume(e,t){let s=e.state,n=s.volume*s.expression,{gainLeft:o,gainRight:r}=this.panToGain(s.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(n*o,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(n*r,t)}setSustainPedal(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(n,o=>{n.sustainNotes.push(o)}):this.releaseSustainPedal(e,t,s)}setPortamento(e,t){this.channels[e].state.portamento=t/127}setSostenutoPedal(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.sostenutoPedal=t/127,64<=t?n.sostenutoNotes=this.getActiveNotes(n,s):this.releaseSostenutoPedal(e,t,s)}setSoftPedal(e,t,s){let n=this.channels[e];n.state.softPedal=t/127}setFilterResonance(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e],o=n.state;o.filterResonance=t/64,this.processScheduledNotes(n,r=>{let i=r.voiceParams.initialFilterQ/5*o.filterResonance;r.filterNode.Q.setValueAtTime(i,s)})}setReleaseTime(e,t,s){scheduleTime??=this.audioContext.currentTime;let n=this.channels[e];n.state.releaseTime=t/64}setAttackTime(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.attackTime=t/64,this.processScheduledNotes(n,o=>{if(o.startTime<s)return!1;this.setVolumeEnvelope(n,o)})}setBrightness(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.brightness=t/64,this.processScheduledNotes(n,o=>{o.portamento?this.setPortamentoStartFilterEnvelope(n,o,s):this.setFilterEnvelope(n,o)})}setDecayTime(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.decayTime=t/64,this.processScheduledNotes(n,o=>{this.setVolumeEnvelope(n,o,s)})}setVibratoRate(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.state.vibratoRate=t/64,!(n.vibratoDepth<=0)&&this.processScheduledNotes(n,o=>{this.setVibLfoToPitch(n,o,s)})}setVibratoDepth(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e],o=n.state.vibratoDepth;n.state.vibratoDepth=t/64,0<o?this.processScheduledNotes(n,r=>{this.setFreqVibLFO(n,r,s)}):this.processScheduledNotes(n,r=>{this.startVibrato(n,r,s)})}setVibratoDelay(e,t){scheduleTime??=this.audioContext.currentTime;let s=this.channels[e];s.state.vibratoDelay=t/64,0<s.state.vibratoDepth&&this.processScheduledNotes(s,n=>{this.startVibrato(s,n,scheduleTime)})}setReverbSendLevel(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e],o=n.state,r=this.reverbEffect;0<o.reverbSendLevel?0<t?(o.reverbSendLevel=t/127,r.input.gain.cancelScheduledValues(s).setValueAtTime(o.reverbSendLevel,s)):this.processScheduledNotes(n,i=>{if(i.voiceParams.reverbEffectsSend<=0)return!1;i.reverbEffectsSend.disconnect()}):0<t&&(this.processScheduledNotes(n,i=>{this.setReverbEffectsSend(n,i,0,s)}),o.reverbSendLevel=t/127,r.input.gain.cancelScheduledValues(s).setValueAtTime(o.reverbSendLevel,s))}setChorusSendLevel(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e],o=n.state,r=this.chorusEffect;0<o.chorusSendLevel?0<t?(o.chorusSendLevel=t/127,r.input.gain.cancelScheduledValues(s).setValueAtTime(o.chorusSendLevel,s)):this.processScheduledNotes(n,i=>{if(i.voiceParams.chorusEffectsSend<=0)return!1;i.chorusEffectsSend.disconnect()}):0<t&&(this.processScheduledNotes(n,i=>{this.setChorusEffectsSend(n,i,0,s)}),o.chorusSendLevel=t/127,r.input.gain.cancelScheduledValues(s).setValueAtTime(o.chorusSendLevel,s))}limitData(e,t,s,n,o){o<e.dataLSB?(e.dataMSB++,e.dataLSB=n):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=o),s<e.dataMSB?(e.dataMSB=s,e.dataLSB=o):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=n)}limitDataMSB(e,t,s){s<e.dataMSB?e.dataMSB=s:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e,t,s){let n=this.channels[e];switch(n.rpnMSB*128+n.rpnLSB){case 0:n.dataLSB+=t,this.handlePitchBendRangeRPN(e,s);break;case 1:n.dataLSB+=t,this.handleFineTuningRPN(e,s);break;case 2:n.dataMSB+=t,this.handleCoarseTuningRPN(e,s);break;case 5:n.dataLSB+=t,this.handleModulationDepthRangeRPN(e,s);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${n.rpnMSB} LSB=${n.rpnLSB}`)}}dataIncrement(e){this.handleRPN(e,1)}dataDecrement(e){this.handleRPN(e,-1)}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,s){this.channels[e].dataMSB=t,this.handleRPN(e,s)}handlePitchBendRangeRPN(e,t){let s=this.channels[e];this.limitData(s,0,127,0,99);let n=s.dataMSB+s.dataLSB/100;this.setPitchBendRange(e,n,t)}setPitchBendRange(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e],o=n.state,r=o.pitchWheelSensitivity,i=t/128;o.pitchWheelSensitivity=i,n.detune+=(o.pitchWheel*2-1)*(i-r)*12800,this.updateChannelDetune(n,s),this.applyVoiceParams(n,16,s)}handleFineTuningRPN(e,t){let s=this.channels[e];this.limitData(s,0,127,0,127);let n=s.dataMSB*128+s.dataLSB;this.setFineTuning(e,n,t)}setFineTuning(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e],o=n.fineTuning,r=(t-8192)/8.192;n.fineTuning=r,n.detune+=r-o,this.updateChannelDetune(n,s)}handleCoarseTuningRPN(e,t){let s=this.channels[e];this.limitDataMSB(s,0,127);let n=s.dataMSB;this.setCoarseTuning(e,n,t)}setCoarseTuning(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e],o=n.coarseTuning,r=(t-64)*100;n.coarseTuning=r,n.detune+=r-o,this.updateChannelDetune(n,s)}handleModulationDepthRangeRPN(e,t){let s=this.channels[e];this.limitData(s,0,127,0,127);let n=(dataMSB+dataLSB/128)*100;this.setModulationDepthRange(e,n,t)}setModulationDepthRange(e,t,s){s??=this.audioContext.currentTime;let n=this.channels[e];n.modulationDepthRange=t,this.updateModulation(n,s)}allSoundOff(e,t,s){return s??=this.audioContext.currentTime,this.stopChannelNotes(e,0,!0,s)}resetAllControllers(e){let t=["expression","modulationDepth","sustainPedal","portamento","sostenutoPedal","softPedal","channelPressure","pitchWheelSensitivity"],s=this.channels[e],n=s.state;for(let r=0;r<t.length;r++){let i=t[r];n[i]=te[i].defaultValue}let o=["rpnMSB","rpnLSB"];for(let r=0;r<o.length;r++){let i=o[r];s[i]=this.constructor.channelSettings[i]}}allNotesOff(e,t,s){return s??=this.audioContext.currentTime,this.stopChannelNotes(e,0,!1,s)}omniOff(e,t,s){this.allNotesOff(e,t,s)}omniOn(e,t,s){this.allNotesOff(e,t,s)}monoOn(e,t,s){let n=this.channels[e];this.allNotesOff(e,t,s),n.mono=!0}polyOn(e,t,s){let n=this.channels[e];this.allNotesOff(e,t,s),n.mono=!1}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 8:switch(e[3]){case 8:return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!1,t);case 9:return this.handleScaleOctaveTuning2ByteFormatSysEx(e,!1,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:this.GM1SystemOn();break;case 2:break;case 3:this.GM2SystemOn();break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(){for(let e=0;e<this.channels.length;e++){let t=this.channels[e];t.bankMSB=0,t.bankLSB=0,t.bank=0}this.channels[9].bankMSB=1,this.channels[9].bank=128}GM2SystemOn(){for(let e=0;e<this.channels.length;e++){let t=this.channels[e];t.bankMSB=121,t.bankLSB=0,t.bank=15488}this.channels[9].bankMSB=120,this.channels[9].bank=15360}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e,t);case 3:return this.handleMasterFineTuningSysEx(e,t);case 4:return this.handleMasterCoarseTuningSysEx(e,t);case 5:return this.handleGlobalParameterControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 8:switch(e[3]){case 8:return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!0,t);case 9:return this.handleScaleOctaveTuning2ByteFormatSysEx(e,!0,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:return this.handlePressureSysEx(e,"channelPressureTable");case 2:return this.handlePressureSysEx(e,"polyphonicKeyPressureTable");case 3:return this.handleControlChangeSysEx(e);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 10:switch(e[3]){case 1:return this.handleKeyBasedInstrumentControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){let s=(e[5]*128+e[4])/16383;this.setMasterVolume(s,t)}setMasterVolume(e,t){t??=this.audioContext.currentTime,e<0&&1<e?console.error("Master Volume is out of range"):this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleMasterFineTuningSysEx(e,t){let s=e[5]*128+e[4];this.setMasterFineTuning(s,t)}setMasterFineTuning(e,t){let s=this.masterFineTuning,n=(e-8192)/8.192;this.masterFineTuning=n,channel.detune+=n-s,this.updateChannelDetune(channel,t)}handleMasterCoarseTuningSysEx(e,t){let s=e[4];this.setMasterCoarseTuning(s,t)}setMasterCoarseTuning(e,t){let s=this.masterCoarseTuning,n=(e-64)*100;this.masterCoarseTuning=n,channel.detune+=n-s,this.updateChannelDetune(channel,t)}handleGlobalParameterControlSysEx(e,t){if(e[7]===1)switch(e[8]){case 1:return this.handleReverbParameterSysEx(e);case 2:return this.handleChorusParameterSysEx(e,t);default:console.warn(`Unsupported Global Parameter Control Message: ${e}`)}else console.warn(`Unsupported Global Parameter Control Message: ${e}`)}handleReverbParameterSysEx(e){switch(e[9]){case 0:return this.setReverbType(e[10]);case 1:return this.setReverbTime(e[10])}}setReverbType(e){this.reverb.time=this.getReverbTimeFromType(e),this.reverb.feedback=e===8?.9:.8;let{audioContext:t,options:s}=this;this.reverbEffect=s.reverbAlgorithm(t)}getReverbTimeFromType(e){switch(e){case 0:return this.getReverbTime(44);case 1:return this.getReverbTime(50);case 2:return this.getReverbTime(56);case 3:return this.getReverbTime(64);case 4:return this.getReverbTime(64);case 8:return this.getReverbTime(50);default:console.warn(`Unsupported Reverb Time: ${e}`)}}setReverbTime(e){this.reverb.time=this.getReverbTime(e);let{audioContext:t,options:s}=this;this.reverbEffect=s.reverbAlgorithm(t)}getReverbTime(e){return Math.pow(Math.E,(e-40)*.025)}calcDelay(e,t){return-e*Math.log10(t)/3}handleChorusParameterSysEx(e,t){switch(e[9]){case 0:return this.setChorusType(e[10],t);case 1:return this.setChorusModRate(e[10],t);case 2:return this.setChorusModDepth(e[10],t);case 3:return this.setChorusFeedback(e[10],t);case 4:return this.setChorusSendToReverb(e[10],t)}}setChorusType(e,t){switch(e){case 0:return this.setChorusParameter(3,5,0,0,t);case 1:return this.setChorusParameter(9,19,5,0,t);case 2:return this.setChorusParameter(3,19,8,0,t);case 3:return this.setChorusParameter(9,16,16,0,t);case 4:return this.setChorusParameter(2,24,64,0,t);case 5:return this.setChorusParameter(1,5,112,0,t);default:console.warn(`Unsupported Chorus Type: ${e}`)}}setChorusParameter(e,t,s,n,o){this.setChorusModRate(e,o),this.setChorusModDepth(t,o),this.setChorusFeedback(s,o),this.setChorusSendToReverb(n,o)}setChorusModRate(e,t){let s=this.getChorusModRate(e);this.chorus.modRate=s,this.chorusEffect.lfo.frequency.setValueAtTime(s,t)}getChorusModRate(e){return e*.122}setChorusModDepth(e,t){let s=this.getChorusModDepth(e);this.chorus.modDepth=s,this.chorusEffect.lfoGain.gain.cancelScheduledValues(t).setValueAtTime(s/2,t)}getChorusModDepth(e){return(e+1)/3200}setChorusFeedback(e,t){let s=this.getChorusFeedback(e);this.chorus.feedback=s;let n=this.chorusEffect;for(let o=0;o<n.feedbackGains.length;o++)n.feedbackGains[o].gain.cancelScheduledValues(t).setValueAtTime(s,t)}getChorusFeedback(e){return e*.00763}setChorusSendToReverb(e,t){let s=this.getChorusSendToReverb(e),n=this.chorusEffect.sendGain;0<this.chorus.sendToReverb?(this.chorus.sendToReverb=s,0<s?n.gain.cancelScheduledValues(t).setValueAtTime(s,t):n.disconnect()):(this.chorus.sendToReverb=s,0<s&&(n.connect(this.reverbEffect.input),n.gain.cancelScheduledValues(t).setValueAtTime(s,t)))}getChorusSendToReverb(e){return e*.00787}getChannelBitmap(e){let t=new Array(16).fill(!1),s=e[4]&3,n=e[5]&127,o=e[6]&127;for(let r=0;r<7;r++)o&1<<r&&(t[r]=!0);for(let r=0;r<7;r++)n&1<<r&&(t[r+7]=!0);for(let r=0;r<2;r++)s&1<<r&&(t[r+14]=!0);return t}handleScaleOctaveTuning1ByteFormatSysEx(e,t,s){if(e.length<19){console.error("Data length is too short");return}let n=this.getChannelBitmap(e);for(let o=0;o<n.length;o++){if(!n[o])continue;let r=this.channels[o];for(let i=0;i<12;i++){let c=e[i+7]-64;r.scaleOctaveTuningTable[i]=c}t&&this.updateChannelDetune(r,s)}}handleScaleOctaveTuning2ByteFormatSysEx(e,t,s){if(e.length<31){console.error("Data length is too short");return}let n=this.getChannelBitmap(e);for(let o=0;o<n.length;o++){if(!n[o])continue;let r=this.channels[o];for(let i=0;i<12;i++){let c=7+i*2,l=e[c]&127,h=e[c+1]&127,u=(l*128+h-8192)/8.192;r.scaleOctaveTuningTable[i]=u}t&&this.updateChannelDetune(r,s)}}getPitchControl(e,t){return(e.polyphonicKeyPressureTable[0]-64)*t.pressure*t.pressure/37.5}getFilterCutoffControl(e,t){let s=(e.channelPressureTable[1]-64)*e.state.channelPressure,n=(e.polyphonicKeyPressureTable[1]-64)*t.pressure;return(s+n)*15}getAmplitudeControl(e,t){let s=e.channelPressureTable[2]*e.state.channelPressure,n=e.polyphonicKeyPressureTable[2]*t.pressure;return(s+n)/128}getLFOPitchDepth(e,t){let s=e.channelPressureTable[3]*e.state.channelPressure,n=e.polyphonicKeyPressureTable[3]*t.pressure;return(s+n)/254*600}getLFOFilterDepth(e,t){let s=e.channelPressureTable[4]*e.state.channelPressure,n=e.polyphonicKeyPressureTable[4]*t.pressure;return(s+n)/254*2400}getLFOAmplitudeDepth(e,t){let s=e.channelPressureTable[5]*e.state.channelPressure,n=e.polyphonicKeyPressureTable[5]*t.pressure;return(s+n)/254}setControllerParameters(e,t,s){s[0]!==64&&this.updateDetune(e,t),t.portamento||(s[1]!==64&&this.setFilterEnvelope(e,t),s[2]!==64&&this.setVolumeEnvelope(e,t)),s[3]!==0&&this.setModLfoToPitch(e,t),s[4]!==0&&this.setModLfoToFilterFc(e,t),s[5]!==0&&this.setModLfoToVolume(e,t)}handlePressureSysEx(e,t){let s=e[4],n=this.channels[s][t];for(let o=5;o<e.length-1;o+=2){let r=e[o],i=e[o+1];n[r]=i}}initControlTable(){let s=[64,64,64,0,0,0],n=new Uint8Array(768);for(let o=0;o<128;o++){let r=o*6;n.set(s,r)}return n}applyControlTable(e,t){let n=t*6,o=e.controlTable.subarray(n,n+6);this.processScheduledNotes(e,r=>{this.setControllerParameters(e,r,o)})}handleControlChangeSysEx(e){let t=e[4],s=e[5],n=this.channels[t].controlTable[s];for(let o=6;o<e.length-1;o+=2){let r=e[o],i=e[o+1];n[r]=i}}getKeyBasedInstrumentControlValue(e,t,s){let n=t*128+s;return(e.keyBasedInstrumentControlTable[n]+64)/64}handleKeyBasedInstrumentControlSysEx(e,t){let s=e[4],n=e[5],o=this.channels[s].keyBasedInstrumentControlTable;for(let r=6;r<e.length-1;r+=2){let i=e[r],c=e[r+1],l=n*128+i;o[l]=c-64}this.handleChannelPressure(s,channel.state.channelPressure*127,t)}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(s=>{let n=new AudioBufferSourceNode(this.audioContext);n.onended=()=>{e(),s()},n.start(t),n.stop(t)})}};export{we as Midy};
