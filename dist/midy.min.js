var Me=Object.create;var fe=Object.defineProperty;var Ne=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var Be=Object.getPrototypeOf,Ae=Object.prototype.hasOwnProperty;var te=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var Le=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Re(e))!Ae.call(i,s)&&s!==t&&fe(i,s,{get:()=>e[s],enumerable:!(r=Ne(e,s))||r.enumerable});return i};var Ue=(i,e,t)=>(t=i!=null?Me(Be(i)):{},Le(e||!i||!i.__esModule?fe(t,"default",{value:i,enumerable:!0}):t,i));var me=te((Pt,pe)=>{function Ge(i){var e=new S(i),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var r=je(t.data),s=[],o=0;!e.eof()&&o<r.numTracks;o++){var n=e.readChunk();if(n.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+n.id+"'";var a=He(n.data);s.push(a)}return{header:r,tracks:s}}function je(i){var e=new S(i),t=e.readUInt16(),r=e.readUInt16(),s={format:t,numTracks:r},o=e.readUInt16();return o&32768?(s.framesPerSecond=256-(o>>8),s.ticksPerFrame=o&255):s.ticksPerBeat=o,s}function He(i){for(var e=new S(i),t=[];!e.eof();){var r=o();t.push(r)}return t;var s;function o(){var n={};n.deltaTime=e.readVarInt();var a=e.readUInt8();if((a&240)===240)if(a===255){n.meta=!0;var c=e.readUInt8(),l=e.readVarInt();switch(c){case 0:if(n.type="sequenceNumber",l!==2)throw"Expected length for sequenceNumber event is 2, got "+l;return n.number=e.readUInt16(),n;case 1:return n.type="text",n.text=e.readString(l),n;case 2:return n.type="copyrightNotice",n.text=e.readString(l),n;case 3:return n.type="trackName",n.text=e.readString(l),n;case 4:return n.type="instrumentName",n.text=e.readString(l),n;case 5:return n.type="lyrics",n.text=e.readString(l),n;case 6:return n.type="marker",n.text=e.readString(l),n;case 7:return n.type="cuePoint",n.text=e.readString(l),n;case 32:if(n.type="channelPrefix",l!=1)throw"Expected length for channelPrefix event is 1, got "+l;return n.channel=e.readUInt8(),n;case 33:if(n.type="portPrefix",l!=1)throw"Expected length for portPrefix event is 1, got "+l;return n.port=e.readUInt8(),n;case 47:if(n.type="endOfTrack",l!=0)throw"Expected length for endOfTrack event is 0, got "+l;return n;case 81:if(n.type="setTempo",l!=3)throw"Expected length for setTempo event is 3, got "+l;return n.microsecondsPerBeat=e.readUInt24(),n;case 84:if(n.type="smpteOffset",l!=5)throw"Expected length for smpteOffset event is 5, got "+l;var u=e.readUInt8(),h={0:24,32:25,64:29,96:30};return n.frameRate=h[u&96],n.hour=u&31,n.min=e.readUInt8(),n.sec=e.readUInt8(),n.frame=e.readUInt8(),n.subFrame=e.readUInt8(),n;case 88:if(n.type="timeSignature",l!=2&&l!=4)throw"Expected length for timeSignature event is 4 or 2, got "+l;return n.numerator=e.readUInt8(),n.denominator=1<<e.readUInt8(),l===4?(n.metronome=e.readUInt8(),n.thirtyseconds=e.readUInt8()):(n.metronome=36,n.thirtyseconds=8),n;case 89:if(n.type="keySignature",l!=2)throw"Expected length for keySignature event is 2, got "+l;return n.key=e.readInt8(),n.scale=e.readUInt8(),n;case 127:return n.type="sequencerSpecific",n.data=e.readBytes(l),n;default:return n.type="unknownMeta",n.data=e.readBytes(l),n.metatypeByte=c,n}}else if(a==240){n.type="sysEx";var l=e.readVarInt();return n.data=e.readBytes(l),n}else if(a==247){n.type="endSysEx";var l=e.readVarInt();return n.data=e.readBytes(l),n}else throw"Unrecognised MIDI event type byte: "+a;else{var d;if((a&128)===0){if(s===null)throw"Running status byte encountered before status byte";d=a,a=s,n.running=!0}else d=e.readUInt8(),s=a;var p=a>>4;switch(n.channel=a&15,p){case 8:return n.type="noteOff",n.noteNumber=d,n.velocity=e.readUInt8(),n;case 9:var m=e.readUInt8();return n.type=m===0?"noteOff":"noteOn",n.noteNumber=d,n.velocity=m,m===0&&(n.byte9=!0),n;case 10:return n.type="noteAftertouch",n.noteNumber=d,n.amount=e.readUInt8(),n;case 11:return n.type="controller",n.controllerType=d,n.value=e.readUInt8(),n;case 12:return n.type="programChange",n.programNumber=d,n;case 13:return n.type="channelAftertouch",n.amount=d,n;case 14:return n.type="pitchBend",n.value=d+(e.readUInt8()<<7)-8192,n;default:throw"Unrecognised MIDI event type: "+p}}}}function S(i){this.buffer=i,this.bufferLen=this.buffer.length,this.pos=0}S.prototype.eof=function(){return this.pos>=this.bufferLen};S.prototype.readUInt8=function(){var i=this.buffer[this.pos];return this.pos+=1,i};S.prototype.readInt8=function(){var i=this.readUInt8();return i&128?i-256:i};S.prototype.readUInt16=function(){var i=this.readUInt8(),e=this.readUInt8();return(i<<8)+e};S.prototype.readInt16=function(){var i=this.readUInt16();return i&32768?i-65536:i};S.prototype.readUInt24=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(i<<16)+(e<<8)+t};S.prototype.readInt24=function(){var i=this.readUInt24();return i&8388608?i-16777216:i};S.prototype.readUInt32=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),r=this.readUInt8();return(i<<24)+(e<<16)+(t<<8)+r};S.prototype.readBytes=function(i){var e=this.buffer.slice(this.pos,this.pos+i);return this.pos+=i,e};S.prototype.readString=function(i){var e=this.readBytes(i);return String.fromCharCode.apply(null,e)};S.prototype.readVarInt=function(){for(var i=0;!this.eof();){var e=this.readUInt8();if(e&128)i+=e&127,i<<=7;else return i+e}return i};S.prototype.readChunk=function(){var i=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:i,length:e,data:t}};pe.exports=Ge});var ye=te((St,be)=>{function Ke(i,e){if(typeof i!="object")throw"Invalid MIDI data";e=e||{};var t=i.header||{},r=i.tracks||[],s,o=r.length,n=new y;for(qe(n,t,o),s=0;s<o;s++)We(n,r[s],e);return n.buffer}function qe(i,e,t){var r=e.format==null?1:e.format,s=128;e.timeDivision?s=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?s=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(s=e.ticksPerBeat&32767);var o=new y;o.writeUInt16(r),o.writeUInt16(t),o.writeUInt16(s),i.writeChunk("MThd",o.buffer)}function We(i,e,t){var r=new y,s,o=e.length,n=null;for(s=0;s<o;s++)(t.running===!1||!t.running&&!e[s].running)&&(n=null),n=$e(r,e[s],n,t.useByte9ForNoteOff);i.writeChunk("MTrk",r.buffer)}function $e(i,e,t,r){var s=e.type,o=e.deltaTime,n=e.text||"",a=e.data||[],c=null;switch(i.writeVarInt(o),s){case"sequenceNumber":i.writeUInt8(255),i.writeUInt8(0),i.writeVarInt(2),i.writeUInt16(e.number);break;case"text":i.writeUInt8(255),i.writeUInt8(1),i.writeVarInt(n.length),i.writeString(n);break;case"copyrightNotice":i.writeUInt8(255),i.writeUInt8(2),i.writeVarInt(n.length),i.writeString(n);break;case"trackName":i.writeUInt8(255),i.writeUInt8(3),i.writeVarInt(n.length),i.writeString(n);break;case"instrumentName":i.writeUInt8(255),i.writeUInt8(4),i.writeVarInt(n.length),i.writeString(n);break;case"lyrics":i.writeUInt8(255),i.writeUInt8(5),i.writeVarInt(n.length),i.writeString(n);break;case"marker":i.writeUInt8(255),i.writeUInt8(6),i.writeVarInt(n.length),i.writeString(n);break;case"cuePoint":i.writeUInt8(255),i.writeUInt8(7),i.writeVarInt(n.length),i.writeString(n);break;case"channelPrefix":i.writeUInt8(255),i.writeUInt8(32),i.writeVarInt(1),i.writeUInt8(e.channel);break;case"portPrefix":i.writeUInt8(255),i.writeUInt8(33),i.writeVarInt(1),i.writeUInt8(e.port);break;case"endOfTrack":i.writeUInt8(255),i.writeUInt8(47),i.writeVarInt(0);break;case"setTempo":i.writeUInt8(255),i.writeUInt8(81),i.writeVarInt(3),i.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":i.writeUInt8(255),i.writeUInt8(84),i.writeVarInt(5);var l={24:0,25:32,29:64,30:96},u=e.hour&31|l[e.frameRate];i.writeUInt8(u),i.writeUInt8(e.min),i.writeUInt8(e.sec),i.writeUInt8(e.frame),i.writeUInt8(e.subFrame);break;case"timeSignature":i.writeUInt8(255),i.writeUInt8(88),i.writeVarInt(4),i.writeUInt8(e.numerator);var h=Math.floor(Math.log(e.denominator)/Math.LN2)&255;i.writeUInt8(h),i.writeUInt8(e.metronome),i.writeUInt8(e.thirtyseconds||8);break;case"keySignature":i.writeUInt8(255),i.writeUInt8(89),i.writeVarInt(2),i.writeInt8(e.key),i.writeUInt8(e.scale);break;case"sequencerSpecific":i.writeUInt8(255),i.writeUInt8(127),i.writeVarInt(a.length),i.writeBytes(a);break;case"unknownMeta":e.metatypeByte!=null&&(i.writeUInt8(255),i.writeUInt8(e.metatypeByte),i.writeVarInt(a.length),i.writeBytes(a));break;case"sysEx":i.writeUInt8(240),i.writeVarInt(a.length),i.writeBytes(a);break;case"endSysEx":i.writeUInt8(247),i.writeVarInt(a.length),i.writeBytes(a);break;case"noteOff":var d=r!==!1&&e.byte9||r&&e.velocity==0?144:128;c=d|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.velocity);break;case"noteOn":c=144|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.velocity);break;case"noteAftertouch":c=160|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.amount);break;case"controller":c=176|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.controllerType),i.writeUInt8(e.value);break;case"programChange":c=192|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.programNumber);break;case"channelAftertouch":c=208|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.amount);break;case"pitchBend":c=224|e.channel,c!==t&&i.writeUInt8(c);var p=8192+e.value,m=p&127,g=p>>7&127;i.writeUInt8(m),i.writeUInt8(g);break;default:throw"Unrecognized event type: "+s}return c}function y(){this.buffer=[]}y.prototype.writeUInt8=function(i){this.buffer.push(i&255)};y.prototype.writeInt8=y.prototype.writeUInt8;y.prototype.writeUInt16=function(i){var e=i>>8&255,t=i&255;this.writeUInt8(e),this.writeUInt8(t)};y.prototype.writeInt16=y.prototype.writeUInt16;y.prototype.writeUInt24=function(i){var e=i>>16&255,t=i>>8&255,r=i&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(r)};y.prototype.writeInt24=y.prototype.writeUInt24;y.prototype.writeUInt32=function(i){var e=i>>24&255,t=i>>16&255,r=i>>8&255,s=i&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(r),this.writeUInt8(s)};y.prototype.writeInt32=y.prototype.writeUInt32;y.prototype.writeBytes=function(i){this.buffer=this.buffer.concat(Array.prototype.slice.call(i,0))};y.prototype.writeString=function(i){var e,t=i.length,r=[];for(e=0;e<t;e++)r.push(i.codePointAt(e));this.writeBytes(r)};y.prototype.writeVarInt=function(i){if(i<0)throw"Cannot write negative variable-length integer";if(i<=127)this.writeUInt8(i);else{var e=i,t=[];for(t.push(e&127),e>>=7;e;){var r=e&127|128;t.push(r),e>>=7}this.writeBytes(t.reverse())}};y.prototype.writeChunk=function(i,e){this.writeString(i),this.writeUInt32(e.length),this.writeBytes(e)};be.exports=Ke});var ge=te(se=>{se.parseMidi=me();se.writeMidi=ye()});var Ie=Ue(ge());var D=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,r=t+e,s=this.data,o=s.subarray(t,r).indexOf(0);o<0&&(o=e);let n=new Array(o);for(let a=0;a<o;a++)n[a]=s[t+a];return this.offset=r,String.fromCharCode(...n)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function ne(i,e,t){let r=new D(i,e),s=r.readString(4),o=r.readDWORD(t);return new re(s,o,r.offset)}function oe(i,e=0,t,{padding:r=!0,bigEndian:s=!1}={}){let o=[],n=t+e,a=e;for(;a<n;){let c=ne(i,a,s);a=c.offset+c.size,r&&(a-e&1)===1&&a++,o.push(c)}return o}var re=class{constructor(e,t,r){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:r})}};var F=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var b=class i{constructor(e,t,r,s,o){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:o})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,r=e&127,s=e>>7&1,o=e>>8&1,n=e>>9&1;return new i(t,n,o,s,r)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var ae=class i{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),r=e.readInt8();return new i(t,r)}},G=class i{constructor(e,t,r,s,o,n,a,c,l,u,h){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:h})}static parse(e,t){function r(k){for(let w=0;w<t.length;w++)if(t[w].type===k)return t[w]}function s(k){return new D(e,k.offset)}function o(k){let w=r(k);return w?s(w).readString(w.size):null}function n(k){let w=r(k);return w?ae.parse(s(w)):null}let a=o("ICMT"),c=o("ICOP"),l=o("ICRD"),u=o("IENG"),h=o("INAM"),d=o("IPRD"),p=o("ISFT"),m=n("ifil"),g=o("isng"),V=o("irom"),C=n("iver");return new i(a,c,l,u,h,d,p,m,g,V,C)}},R=class i{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),r=e.readWORD();return new i(t,r)}},j=class i{constructor(e,t,r,s,o,n,a){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:a})}get isEnd(){let{presetName:e,preset:t,bank:r,library:s,genre:o,morphology:n}=this;return(e===""||e==="EOP")&&t+r+s+o+n===0}static parse(e){let t=e.readString(20),r=e.readWORD(),s=e.readWORD(),o=e.readWORD(),n=e.readDWORD(),a=e.readDWORD(),c=e.readDWORD();return new i(t,r,s,o,n,a,c)}},O=class i{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),r=e.readByte();return new i(t,r)}},v=class i{constructor(e,t,r,s,o){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"amount",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:o})}transform(e){let t=this.amount*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),r=e.readWORD(),s=e.readInt16(),o=e.readWORD(),n=e.readWORD(),a=b.parse(t),c=b.parse(o);return new i(a,r,s,c,n)}},B=class i{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return F[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),r=F[t],s;switch(r){case"keyRange":case"velRange":s=O.parse(e);break;case"instrument":case"sampleID":s=e.readUInt16();break;default:s=e.readInt16();break}return new i(t,s)}},H=class i{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new i;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},K=class i{constructor(e,t,r,s,o,n,a,c,l,u){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:u})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let r=e.readString(20),s=e.readDWORD(),o=e.readDWORD(),n=e.readDWORD(),a=e.readDWORD(),c=e.readDWORD(),l=e.readByte(),u=e.readInt8(),h=e.readWORD(),d=e.readWORD();return t||(n-=s,a-=s),new i(r,s,o,n,a,c,l,u,h,d)}};var f=class{constructor(e,t,r){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=r}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};var ze=["pcm16","pcm24","compressed"],Qe=new Set(ze),q=class{constructor(e,t,r){if(Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Qe.has(e))throw new Error(`Invalid AudioDataType: ${e}`);this.type=e,this.sampleHeader=t,this.data=r}decodePCM(e){let{type:t}=this;if(t==="pcm16"){let s=e.byteLength/2,o=new Float32Array(s),n=new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);for(let a=0;a<s;a++)o[a]=n[a]/32768;return o}else{let s=e.byteLength/3,o=new Float32Array(s);for(let n=0;n<s;n++){let a=n*3,c=e[a]|e[a+1]<<8|e[a+2]<<16;c&8388608&&(c|=4278190080),o[n]=c/8388608}return o}}async toAudioBuffer(e,t,r){if(this.type==="compressed"){let s=this.data.slice(t,r);return await e.decodeAudioData(s.buffer)}else{let s=this.data.subarray(t,r),o=this.decodePCM(s),n=new AudioBuffer({numberOfChannels:1,length:o.length,sampleRate:this.sampleHeader.sampleRate});return n.getChannelData(0).set(o),n}}};function ie(i,e={}){let t=oe(i,0,i.length,e);if(t.length!==1)throw new Error("wrong chunk length");let r=t[0];if(r===null)throw new Error("chunk not found");function s(c,l,u={}){let h=W(c,l,"RIFF","sfbk",u);if(h.length!==3)throw new Error("invalid sfbk structure");let d=Ze(h[0],l),p=d.version.major===3;return p&&h[2].type!=="LIST"&&(h[2]=ne(l,h[2].offset-9,!1)),{info:d,samplingData:_e(h[1],l),...o(h[2],l,p)}}function o(c,l,u){let h=W(c,l,"LIST","pdta");if(h.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:Je(h[0],l),presetZone:Xe(h[1],l),presetModulators:tt(h[2],l),presetGenerators:rt(h[3],l),instruments:Ye(h[4],l),instrumentZone:et(h[5],l),instrumentModulators:st(h[6],l),instrumentGenerators:nt(h[7],l),sampleHeaders:ot(h[8],l,u)}}let n=s(r,i,e),a=n.info.version.major===3;return{...n,samples:at(n.sampleHeaders,n.samplingData.offsetMSB,n.samplingData.offsetLSB,i,a)}}function W(i,e,t,r,s={}){if(i.type!==t)throw new Error("invalid chunk type:"+i.type);let o=new D(e,i.offset),n=o.readString(4);if(n!==r)throw new Error("invalid signature:"+n);return oe(e,o.offset,i.size-4,s)}function Ze(i,e){let t=W(i,e,"LIST","INFO");return G.parse(e,t)}function _e(i,e){let t=W(i,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function E(i,e,t,r,s,o){let n=[];if(i.type!==t)throw new Error("invalid chunk type:"+i.type);let a=new D(e,i.offset),c=i.offset+i.size;for(;a.offset<c;){let l=r.parse(a,o);if(s&&s(l))break;n.push(l)}return n}var Je=(i,e)=>E(i,e,"phdr",j,t=>t.isEnd),Xe=(i,e)=>E(i,e,"pbag",R),Ye=(i,e)=>E(i,e,"inst",H,t=>t.isEnd),et=(i,e)=>E(i,e,"ibag",R),tt=(i,e)=>E(i,e,"pmod",v),st=(i,e)=>E(i,e,"imod",v),rt=(i,e)=>E(i,e,"pgen",B,t=>t.isEnd),nt=(i,e)=>E(i,e,"igen",B),ot=(i,e,t)=>E(i,e,"shdr",K,r=>r.isEnd,t);function at(i,e,t,r,s){let o=new Array(i.length),n=s?1:2,a=s?"compressed":t?"pcm24":"pcm16";for(let c=0;c<i.length;c++){let{start:l,end:u}=i[c],h=e+l*n,d=e+u*n,p=r.subarray(h,d);o[c]=new q(a,i[c],p)}return o}var we=new Map;for(let i=0;i<F.length;i++)we.set(F[i],i);var it=["instrument","sampleID"],xe=["keyRange","velRange"],Te=["keynum","velocity"],ke=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],ve=[...ke,...Te],Fe=new Set;for(let i=0;i<ve.length;i++){let e=ve[i],t=we.get(e);t!==void 0&&Fe.add(t)}function De(i){let e={},t=Object.keys(i);for(let r of t){let s=i[r];if(A(r))e[r]=s;else{let o=s;e[r]=o.clamp(o.defaultValue)}}return e}var Pe=[["keynum","keyRange"],["velocity","velRange"]],ct=new Set(xe);function A(i){return ct.has(i)}var lt=new Set([...it,...xe,...Te,...ke]);function ut(){let i=[],e=F.length;for(let t=0;t<e;t++){let r=F[t];r!==void 0&&!lt.has(r)&&i.push(r)}return i}var z=ut(),ht=new Set(z);function ce(i){return ht.has(i)}function Ve(i){let e={};for(let t=0;t<i.length;t++){let r=i[t],s=r.type;if(s!==void 0&&!Fe.has(r.code))if(A(s))e[s]=r.value;else{let o=s;e[o]=r.value}}return e}function Ee(i){let e={};for(let t=0;t<i.length;t++){let r=i[t],s=r.type;if(s!==void 0)if(A(s))e[s]=r.value;else{let o=s;e[o]=r.value}}for(let t=0;t<Pe.length;t++){let[r,s]=Pe[t],o=e[r];o!==void 0&&(e[s]=new O(o,o))}return e}var M=-32768,N=32767,Se=0,$=65535,Q={startAddrsOffset:new f(0,0,N),endAddrsOffset:new f(M,0,0),startloopAddrsOffset:new f(M,0,N),endloopAddrsOffset:new f(M,0,N),startAddrsCoarseOffset:new f(0,0,N),modLfoToPitch:new f(-12e3,0,12e3),vibLfoToPitch:new f(-12e3,0,12e3),modEnvToPitch:new f(-12e3,0,12e3),initialFilterFc:new f(1500,13500,13500),initialFilterQ:new f(0,0,960),modLfoToFilterFc:new f(-12e3,0,12e3),modEnvToFilterFc:new f(-12e3,0,12e3),endAddrsCoarseOffset:new f(M,0,0),modLfoToVolume:new f(-960,0,960),chorusEffectsSend:new f(0,0,1e3),reverbEffectsSend:new f(0,0,1e3),pan:new f(-500,0,500),delayModLFO:new f(-12e3,-12e3,5e3),freqModLFO:new f(-16e3,0,4500),delayVibLFO:new f(-12e3,-12e3,5e3),freqVibLFO:new f(-16e3,0,4500),delayModEnv:new f(-12e3,-12e3,5e3),attackModEnv:new f(-12e3,-12e3,8e3),holdModEnv:new f(-12e3,-12e3,5e3),decayModEnv:new f(-12e3,-12e3,8e3),sustainModEnv:new f(0,0,1e3),releaseModEnv:new f(-12e3,-12e3,8e3),keynumToModEnvHold:new f(-1200,0,1200),keynumToModEnvDecay:new f(-1200,0,1200),delayVolEnv:new f(-12e3,-12e3,5e3),attackVolEnv:new f(-12e3,-12e3,8e3),holdVolEnv:new f(-12e3,-12e3,5e3),decayVolEnv:new f(-12e3,-12e3,8e3),sustainVolEnv:new f(0,0,1440),releaseVolEnv:new f(-12e3,-12e3,8e3),keynumToVolEnvHold:new f(-1200,0,1200),keynumToVolEnvDecay:new f(-1200,0,1200),instrument:new f(Se,$,$),keyRange:new O(0,127),velRange:new O(0,127),startloopAddrsCoarseOffset:new f(M,0,N),keynum:new f(-1,-1,127),velocity:new f(-1,-1,127),initialAttenuation:new f(0,0,1440),endloopAddrsCoarseOffset:new f(M,0,N),coarseTune:new f(-120,0,120),fineTune:new f(-99,0,99),sampleID:new f(Se,$,$),sampleModes:new f(0,0,3),scaleTuning:new f(0,100,100),exclusiveClass:new f(0,0,127),overridingRootKey:new f(-1,-1,127)};function T(i){return Math.pow(2,i/1200)}var Z=class{constructor(e,t,r,s,o){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(n,a)=>{n.modLfoToPitch=this.clamp("modLfoToPitch",a)},vibLfoToPitch:(n,a)=>{n.vibLfoToPitch=this.clamp("vibLfoToPitch",a)},modEnvToPitch:(n,a)=>{n.modEnvToPitch=this.clamp("modEnvToPitch",a)},initialFilterFc:(n,a)=>{n.initialFilterFc=this.clamp("initialFilterFc",a)},initialFilterQ:(n,a)=>{n.initialFilterQ=this.clamp("initialFilterQ",a)},modLfoToFilterFc:(n,a)=>{n.modLfoToFilterFc=this.clamp("modLfoToFilterFc",a)},modEnvToFilterFc:(n,a)=>{n.modEnvToFilterFc=this.clamp("modEnvToFilterFc",a)},modLfoToVolume:(n,a)=>{n.modLfoToVolume=this.clamp("modLfoToVolume",a)},chorusEffectsSend:(n,a)=>{n.chorusEffectsSend=this.clamp("chorusEffectsSend",a)/1e3},reverbEffectsSend:(n,a)=>{n.reverbEffectsSend=this.clamp("reverbEffectsSend",a)/1e3},pan:(n,a)=>{n.pan=this.clamp("pan",a)/1e3},delayModLFO:(n,a)=>{n.delayModLFO=T(this.clamp("delayModLFO",a))},freqModLFO:(n,a)=>{n.freqModLFO=this.clamp("freqModLFO",a)},delayVibLFO:(n,a)=>{n.delayVibLFO=T(this.clamp("delayVibLFO",a))},freqVibLFO:(n,a)=>{n.freqVibLFO=this.clamp("freqVibLFO",a)},delayModEnv:(n,a)=>{n.modDelay=T(this.clamp("delayModEnv",a))},attackModEnv:(n,a)=>{n.modAttack=T(this.clamp("attackModEnv",a))},holdModEnv:(n,a)=>{let c=this.clamp("holdModEnv",a),l=this.clamp("keynumToModEnvHold",a);n.modHold=this.getModHold(c,l)},decayModEnv:(n,a)=>{let c=this.clamp("decayModEnv",a),l=this.clamp("keynumToModEnvDecay",a);n.modDecay=this.getModDecay(c,l)},sustainModEnv:(n,a)=>{n.modSustain=this.clamp("sustainModEnv",a)/1e3},releaseModEnv:(n,a)=>{n.modRelease=T(this.clamp("releaseModEnv",a))},keynumToModEnvHold:(n,a)=>{let c=this.clamp("holdModEnv",a),l=this.clamp("keynumToModEnvHold",a);n.modHold=this.getModHold(c,l)},keynumToModEnvDecay:(n,a)=>{let c=this.clamp("decayModEnv",a),l=this.clamp("keynumToModEnvDecay",a);n.modDecay=this.getModDecay(c,l)},delayVolEnv:(n,a)=>{n.volDelay=T(this.clamp("delayVolEnv",a))},attackVolEnv:(n,a)=>{n.volAttack=T(this.clamp("attackVolEnv",a))},holdVolEnv:(n,a)=>{let c=this.clamp("holdVolEnv",a),l=this.clamp("keynumToVolEnvHold",a);n.volHold=this.getVolHold(c,l)},decayVolEnv:(n,a)=>{let c=this.clamp("decayVolEnv",a),l=this.clamp("keynumToVolEnvDecay",a);n.volDecay=this.getVolDecay(c,l)},sustainVolEnv:(n,a)=>{n.volSustain=this.clamp("sustainVolEnv",a)/1e3},releaseVolEnv:(n,a)=>{n.volRelease=T(this.clamp("releaseVolEnv",a))},keynumToVolEnvHold:(n,a)=>{let c=this.clamp("holdVolEnv",a),l=this.clamp("keynumToVolEnvHold",a);n.modHold=this.getVolHold(c,l)},keynumToVolEnvDecay:(n,a)=>{let c=this.clamp("decayVolEnv",a),l=this.clamp("keynumToVolEnvDecay",a);n.modDecay=this.getVolDecay(c,l)},initialAttenuation:(n,a)=>{n.initialAttenuation=this.clamp("initialAttenuation",a)},coarseTune:(n,a)=>{n.playbackRate=this.getPlaybackRate(a)},fineTune:(n,a)=>{n.playbackRate=this.getPlaybackRate(a)},scaleTuning:(n,a)=>{n.playbackRate=this.getPlaybackRate(a)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],r=t.sourceOper.controllerType,s=t.destinationOper,o=this.controllerToDestinations.get(r);o?o.add(t.destinationOper):this.controllerToDestinations.set(r,new Set([s]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],r=t.destinationOper,s=this.destinationToModulators.get(r);s?s.push(t):this.destinationToModulators.set(r,[t])}}getModHold(e,t){return T(e+(this.key-60)*t)}getModDecay(e,t){return T(e+(this.key-60)*t)}getVolHold(e,t){return T(e+(this.key-60)*t)}getVolDecay(e,t){return T(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("coarseTune",e),r=this.clamp("fineTune",e)/100,s=this.clamp("overridingRootKey",e),o=this.clamp("scaleTuning",e)/100,n=t+r,a=s===-1?this.sampleHeader.originalPitch:s,c=n+this.sampleHeader.pitchCorrection/100-a;return Math.pow(Math.pow(2,1/12),(this.key+c)*o)}transformParams(e,t){let r={},s=this.controllerToDestinations.get(e);if(!s)return r;for(let o of s){let n=F[o];if(!n||!ce(n))continue;let a=this.destinationToModulators.get(o);if(a){r[n]=this.generators[n];for(let c of a){let l=c.sourceOper,u=l.map(t[l.controllerType]),h=1,d=c.amountSourceOper;if(!(d.cc===0&&d.index===0)){let m=t[d.controllerType];h=d.map(m)}let p=c.transform(u*h);Number.isNaN(p)||(r[n]+=p)}}}return r}transformAllParams(e){let t=structuredClone(this.generators);for(let r of this.modulators){let s=r.sourceOper.controllerType,o=e[s];if(!o)continue;let n=F[r.destinationOper];if(!n||!ce(n))continue;let c=r.sourceOper.map(o),l=1,u=r.amountSourceOper;if(!(u.cc===0&&u.index===0)){let d=e[u.controllerType];l=u.map(d)}let h=r.transform(c*l);Number.isNaN(h)||(t[n]+=h)}return t}clamp(e,t){return Q[e].clamp(t[e])}getParams(e,t){let r={},s=structuredClone(this.generators),o=this.transformParams(e,t),n=Object.keys(o);for(let a of n)s[a]=o[a];for(let a of n)this.voiceHandlers[a](r,s);return r}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,instrument:this.generators.instrument,sampleID:this.generators.sampleID,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},r=this.transformAllParams(e);for(let s=0;s<z.length;s++){let o=z[s];this.voiceHandlers[o](t,r)}return t}};var Oe=[new v(b.parse(1282),48,960,b.parse(0),0),new v(b.parse(258),8,-2400,b.parse(0),0),new v(b.parse(13),6,50,b.parse(0),0),new v(b.parse(129),6,50,b.parse(0),0),new v(b.parse(1415),48,960,b.parse(0),0),new v(b.parse(650),48,1,b.parse(0),0),new v(b.parse(1419),48,960,b.parse(0),0),new v(b.parse(219),16,.2,b.parse(0),0),new v(b.parse(221),15,.2,b.parse(0),0),new v(b.parse(526),51,127,b.parse(16),0)];var _=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},J=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},L=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,r,s){let o=new Array(s-r);for(let n=r;n<s;n++){let a=t[n].generatorIndex,c=t[n+1].generatorIndex;o[n-r]=e.slice(a,c)}return o}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],r=this.parsed.presetHeaders[e+1],s=r?r.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,s)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],r=this.parsed.instruments[e+1],s=r?r.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,s)}getModulators(e,t,r,s){let o=new Array(s-r);for(let n=r;n<s;n++){let a=t[n].modulatorIndex,c=t[n+1].modulatorIndex;o[n-r]=e.slice(a,c)}return o}getPresetModulators(e){let t=this.parsed.presetHeaders[e],r=this.parsed.presetHeaders[e+1],s=r?r.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,s)}getInstrumentModulators(e){let t=this.parsed.instruments[e],r=this.parsed.instruments[e+1],s=r?r.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,s)}findInstrumentZone(e,t,r){let s=this.getInstrumentGenerators(e),o=this.getInstrumentModulators(e),n,a=[];for(let c=0;c<s.length;c++){let l=Ee(s[c]);if(l.sampleID===void 0){n=l,a=o[c];continue}if(!(l.keyRange&&!l.keyRange.in(t))&&!(l.velRange&&!l.velRange.in(r)))if(n){let u={...n,...l},h=[...a,...o[c]];return new _(u,h)}else return new _(l,o[c])}}findInstrument(e,t,r){let s=this.getPresetGenerators(e),o=this.getPresetModulators(e),n,a=[];for(let c=0;c<s.length;c++){let l=Ve(s[c]);if(l.instrument===void 0){n=l,a=o[c];continue}if(l.keyRange&&!l.keyRange.in(t)||l.velRange&&!l.velRange.in(r))continue;let u=this.findInstrumentZone(l.instrument,t,r);if(u)if(n){let h={...n,...l},d=[...a,...o[c]],p=new J(h,d);return this.createVoice(t,p,u)}else{let h=new J(l,o[c]);return this.createVoice(t,h,u)}}return null}createVoice(e,t,r){let s=De(Q);Object.assign(s,r.generators);let o=Object.keys(t.generators);for(let u=0;u<o.length;u++){let h=o[u];A(h)||(s[h]+=t.generators[h])}let n=[...Oe,...t.modulators,...r.modulators],a=s.sampleID,c=this.parsed.samples[a],l=this.parsed.sampleHeaders[a];return new Z(e,s,n,c,l)}getVoice(e,t,r,s){let o=this.parsed.presetHeaders.findIndex(a=>a.preset===t&&a.bank===e);if(o<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let n=this.findInstrument(o,r,s);return n||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let r=0;r<t.length;r++){let s=t[r];e[s.bank]||(e[s.bank]={}),e[s.bank][s.preset]=s.presetName}return e}};var le=class{index=-1;ending=!1;bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;modulationLFO;modulationDepth;vibratoLFO;vibratoDepth;reverbSend;chorusSend;portamentoNoteNumber=-1;pressure=0;constructor(e,t,r,s,o){this.noteNumber=e,this.velocity=t,this.startTime=r,this.voice=s,this.voiceParams=o}},U=new Array(57),dt=10,P=new Uint8Array(128);P[42]=1;P[44]=1;P[46]=1;P[71]=2;P[72]=2;P[73]=3;P[74]=3;P[78]=4;P[79]=4;P[80]=5;P[81]=5;P[29]=6;P[30]=6;P[86]=7;P[87]=7;U[0]=P;var Y=new Uint8Array(128);Y[42]=8;Y[44]=8;Y[46]=8;U[25]=Y;var ee=new Uint8Array(128);ee[27]=9;ee[28]=9;ee[29]=9;U[48]=ee;var he=new Uint8Array(128);he[41]=10;he[42]=10;U[56]=he;var X={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},polyphonicKeyPressure:{type:10,defaultValue:0},channelPressure:{type:13,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepth:{type:129,defaultValue:0},portamentoTime:{type:133,defaultValue:0},volume:{type:135,defaultValue:100/127},pan:{type:138,defaultValue:64/127},expression:{type:139,defaultValue:1},sustainPedal:{type:192,defaultValue:0},portamento:{type:193,defaultValue:0},sostenutoPedal:{type:194,defaultValue:0},softPedal:{type:195,defaultValue:0},filterResonance:{type:199,defaultValue:64/127},releaseTime:{type:200,defaultValue:64/127},attackTime:{type:201,defaultValue:64/127},brightness:{type:202,defaultValue:64/127},decayTime:{type:203,defaultValue:64/127},vibratoRate:{type:204,defaultValue:64/127},vibratoDepth:{type:205,defaultValue:64/127},vibratoDelay:{type:206,defaultValue:64/127},reverbSendLevel:{type:219,defaultValue:0},chorusSendLevel:{type:221,defaultValue:0}},ue=class{array=new Float32Array(256);constructor(){let e=Object.entries(X);for(let[t,{type:r,defaultValue:s}]of e)this.array[r]=s,Object.defineProperty(this,t,{get:()=>this.array[r],set:o=>this.array[r]=o,enumerable:!0,configurable:!0})}},ft=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],pt=new Set(ft),mt=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain"],bt=new Set(mt),yt=["modEnvToPitch","modDelay","modAttack","modHold","modDecay","modSustain","playbackRate"],gt=new Set(yt),Ce=class{mode="GM2";masterFineTuning=0;masterCoarseTuning=0;reverb={algorithm:"SchroederReverb",time:this.getReverbTime(64),feedback:.8};chorus={modRate:this.getChorusModRate(3),modDepth:this.getChorusModDepth(19),feedback:this.getChorusFeedback(8),sendToReverb:this.getChorusSendToReverb(0),delayTimes:this.generateDistributedArray(.02,2,.5)};numChannels=16;ticksPerBeat=120;totalTime=0;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=this.initSoundFontTable();voiceCounter=new Map;voiceCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;timeline=[];notePromises=[];instruments=new Set;exclusiveClassNotes=new Array(128);drumExclusiveClassNotes=new Array(this.numChannels*dt);static channelSettings={scheduleIndex:0,detune:0,programNumber:0,bank:15488,bankMSB:121,bankLSB:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,mono:!1,modulationDepthRange:50,fineTuning:0,coarseTuning:0};constructor(e){this.audioContext=e,this.masterVolume=new GainNode(e),this.scheduler=new GainNode(e,{gain:0}),this.schedulerBuffer=new AudioBuffer({length:1,sampleRate:e.sampleRate}),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.reverbEffect=this.createReverbEffect(e),this.chorusEffect=this.createChorusEffect(e),this.chorusEffect.output.connect(this.masterVolume),this.reverbEffect.output.connect(this.masterVolume),this.masterVolume.connect(e.destination),this.scheduler.connect(e.destination),this.GM2SystemOn()}initSoundFontTable(){let e=new Array(128);for(let t=0;t<128;t++)e[t]=new Map;return e}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let r=e.parsed.presetHeaders;for(let s=0;s<r.length;s++){let o=r[s];this.soundFontTable[o.preset].set(o.bank,t)}}async toUint8Array(e){let t;if(typeof e=="string"){let s=await(await fetch(e)).arrayBuffer();t=new Uint8Array(s)}else if(e instanceof Uint8Array)t=e;else throw new TypeError("input must be a URL string or Uint8Array");return t}async loadSoundFont(e){if(this.voiceCounter.clear(),Array.isArray(e)){let t=new Array(e.length);for(let s=0;s<e.length;s++)t[s]=this.toUint8Array(e[s]);let r=await Promise.all(t);for(let s=0;s<r.length;s++){let o=ie(r[s]),n=new L(o);this.addSoundFont(n)}}else{let t=await this.toUint8Array(e),r=ie(t),s=new L(r);this.addSoundFont(s)}}async loadMIDI(e){this.voiceCounter.clear();let t=await this.toUint8Array(e),r=(0,Ie.parseMidi)(t);this.ticksPerBeat=r.header.ticksPerBeat;let s=this.extractMidiData(r);this.instruments=s.instruments,this.timeline=s.timeline,this.totalTime=this.calcTotalTime()}cacheVoiceIds(){let e=this.timeline;for(let t=0;t<e.length;t++){let r=e[t];switch(r.type){case"noteOn":{let s=this.getVoiceId(this.channels[r.channel],r.noteNumber,r.velocity);this.voiceCounter.set(s,(this.voiceCounter.get(s)??0)+1);break}case"controller":r.controllerType===0?this.setBankMSB(r.channel,r.value):r.controllerType===32&&this.setBankLSB(r.channel,r.value);break;case"programChange":this.setProgramChange(r.channel,r.programNumber,r.startTime)}}for(let[t,r]of this.voiceCounter)r===1&&this.voiceCounter.delete(t);this.GM2SystemOn()}getVoiceId(e,t,r){let s=this.calcBank(e),o=this.soundFontTable[e.programNumber].get(s);if(o===void 0)return;let a=this.soundFonts[o].getVoice(s,e.programNumber,t,r),{instrument:c,sampleID:l}=a.generators;return o*2**32+(c<<16)+l}createChannelAudioNodes(e){let{gainLeft:t,gainRight:r}=this.panToGain(X.pan.defaultValue),s=new GainNode(e,{gain:t}),o=new GainNode(e,{gain:r}),n=new ChannelMergerNode(e,{numberOfInputs:2});return s.connect(n,0,0),o.connect(n,0,1),n.connect(this.masterVolume),{gainL:s,gainR:o,merger:n}}resetChannelTable(e){e.controlTable.fill(-1),e.scaleOctaveTuningTable.fill(0),e.channelPressureTable.fill(-1),e.polyphonicKeyPressureTable.fill(-1),e.keyBasedInstrumentControlTable.fill(-1)}createChannels(e){return Array.from({length:this.numChannels},()=>({currentBufferSource:null,isDrum:!1,state:new ue,...this.constructor.channelSettings,...this.createChannelAudioNodes(e),scheduledNotes:[],sustainNotes:[],sostenutoNotes:[],controlTable:this.initControlTable(),scaleOctaveTuningTable:new Float32Array(12),channelPressureTable:new Int8Array(6).fill(-1),polyphonicKeyPressureTable:new Int8Array(6).fill(-1),keyBasedInstrumentControlTable:new Int8Array(16384).fill(-1),keyBasedGainLs:new Array(128),keyBasedGainRs:new Array(128)}))}async createAudioBuffer(e){let t=e.sample,r=e.start,s=t.data.length+e.end;return await t.toAudioBuffer(this.audioContext,r,s)}isLoopDrum(e,t){let r=e.programNumber;return r===48&&t===88||r===56&&47<=t&&t<=84}createBufferSource(e,t,r,s){let o=new AudioBufferSourceNode(this.audioContext);return o.buffer=s,o.loop=e.isDrum?this.isLoopDrum(e,t):r.sampleModes%2!==0,o.loop&&(o.loopStart=r.loopStart/r.sampleRate,o.loopEnd=r.loopEnd/r.sampleRate),o}async scheduleTimelineEvents(e,t,r){for(;r<this.timeline.length;){let s=this.timeline[r];if(s.startTime>e+this.lookAhead)break;let o=this.startDelay-t,n=s.startTime+o;switch(s.type){case"noteOn":await this.scheduleNoteOn(s.channel,s.noteNumber,s.velocity,n);break;case"noteOff":{let a=this.scheduleNoteOff(s.channel,s.noteNumber,s.velocity,n,!1);a&&this.notePromises.push(a);break}case"noteAftertouch":this.setPolyphonicKeyPressure(s.channel,s.noteNumber,s.amount,n);break;case"controller":this.setControlChange(s.channel,s.controllerType,s.value,n);break;case"programChange":this.setProgramChange(s.channel,s.programNumber,n);break;case"channelAftertouch":this.setChannelPressure(s.channel,s.amount,n);break;case"pitchBend":this.setPitchBend(s.channel,s.value+8192,n);break;case"sysEx":this.handleSysEx(s.data,n)}r++}return r}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}playNotes(){return new Promise(e=>{this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let t=this.getQueueIndex(this.resumeTime),r=this.resumeTime-this.startTime;this.notePromises=[];let s=async()=>{if(t>=this.timeline.length){await Promise.all(this.notePromises),this.notePromises=[],this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.voiceCache.clear();for(let a=0;a<this.channels.length;a++)this.channels[a].scheduledNotes=[],this.resetAllStates(a);e();return}let o=this.audioContext.currentTime,n=o+r;if(t=await this.scheduleTimelineEvents(n,r,t),this.isPausing){await this.stopNotes(0,!0,o),this.notePromises=[],this.isPausing=!1,this.isPaused=!0,e();return}else if(this.isStopping){await this.stopNotes(0,!0,o),this.notePromises=[],this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.voiceCache.clear();for(let a=0;a<this.channels.length;a++)this.channels[a].scheduledNotes=[],this.resetAllStates(a);this.isStopping=!1,this.isPaused=!1,e();return}else if(this.isSeeking)this.stopNotes(0,!0,o),this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.startTime=this.audioContext.currentTime,t=this.getQueueIndex(this.resumeTime),r=this.resumeTime-this.startTime,this.isSeeking=!1,await s();else{let a=o+this.noteCheckInterval;await this.scheduleTask(()=>{},a),await s()}};s()})}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}extractMidiData(e){let t=new Set,r=[],s=new Array(this.channels.length);for(let l=0;l<s.length;l++)s[l]={programNumber:-1,bankMSB:this.channels[l].bankMSB,bankLSB:this.channels[l].bankLSB};for(let l=0;l<e.tracks.length;l++){let u=e.tracks[l],h=0;for(let d=0;d<u.length;d++){let p=u[d];switch(h+=p.deltaTime,p.ticks=h,p.type){case"noteOn":{let m=s[p.channel];if(m.programNumber<0){switch(m.programNumber=p.programNumber,m.bankMSB){case 120:t.add("128:0");break;case 121:t.add(`${m.bankLSB}:0`);break;default:{let g=m.bankMSB*128+m.bankLSB;t.add(`${g}:0`)}}m.programNumber=0}break}case"controller":switch(p.controllerType){case 0:s[p.channel].bankMSB=p.value;break;case 32:s[p.channel].bankLSB=p.value;break}break;case"programChange":{let m=s[p.channel];switch(m.programNumber=p.programNumber,m.bankMSB){case 120:t.add(`128:${m.programNumber}`);break;case 121:t.add(`${m.bankLSB}:${m.programNumber}`);break;default:{let g=m.bankMSB*128+m.bankLSB;t.add(`${g}:${m.programNumber}`)}}}}delete p.deltaTime,r.push(p)}}let o={controller:0,sysEx:1,noteOff:2,noteOn:3};r.sort((l,u)=>l.ticks!==u.ticks?l.ticks-u.ticks:(o[l.type]||4)-(o[u.type]||4));let n=0,a=0,c=.5;for(let l=0;l<r.length;l++){let u=r[l],h=this.ticksToSecond(u.ticks-a,c);u.startTime=n+h,u.type==="setTempo"&&(n+=this.ticksToSecond(u.ticks-a,c),c=u.microsecondsPerBeat/1e6,a=u.ticks)}return{instruments:t,timeline:r}}stopActiveNotes(e,t,r,s){let o=this.channels[e],n=[];return this.processActiveNotes(o,s,a=>{let c=this.scheduleNoteOff(e,a.noteNumber,t,s,r);this.notePromises.push(c),n.push(c)}),Promise.all(n)}stopChannelNotes(e,t,r,s){let o=this.channels[e],n=[];return this.processScheduledNotes(o,a=>{let c=this.scheduleNoteOff(e,a.noteNumber,t,s,r);this.notePromises.push(c),n.push(c)}),Promise.all(n)}stopNotes(e,t,r){let s=[];for(let o=0;o<this.channels.length;o++)s.push(this.stopChannelNotes(o,e,t,r));return Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,this.voiceCounter.size===0&&this.cacheVoiceIds(),await this.playNotes(),this.isPlaying=!1)}stop(){this.isPlaying&&(this.isStopping=!0)}pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}async resume(){this.isPaused&&(await this.playNotes(),this.isPlaying=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let r=this.timeline[t];e<r.startTime&&(e=r.startTime)}return e}currentTime(){let e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}processScheduledNotes(e,t){let r=e.scheduledNotes;for(let s=e.scheduleIndex;s<r.length;s++){let o=r[s];o&&(o.ending||t(o))}}processActiveNotes(e,t,r){let s=e.scheduledNotes;for(let o=e.scheduleIndex;o<s.length;o++){let n=s[o];if(n&&!n.ending){if(t<n.startTime)break;r(n)}}}createConvolutionReverbImpulse(e,t,r){let s=e.sampleRate,o=s*t,n=new AudioBuffer({numberOfChannels:2,length:o,sampleRate:s}),a=Math.min(s*r,o);for(let c=0;c<n.numberOfChannels;c++){let l=n.getChannelData(c);for(let h=0;h<a;h++)l[h]=Math.random()*2-1;let u=1/(s*t);for(let h=a;h<o;h++){let d=Math.exp(-(h-a)*u);l[h]=(Math.random()*2-1)*d}}return n}createConvolutionReverb(e,t){let r=new ConvolverNode(e,{buffer:t});return{input:r,output:r,convolverNode:r}}createCombFilter(e,t,r,s){let o=new DelayNode(e,{maxDelayTime:r,delayTime:r}),n=new GainNode(e,{gain:s});return t.connect(o),o.connect(n),n.connect(o),o}createAllpassFilter(e,t,r,s){let o=new DelayNode(e,{maxDelayTime:r,delayTime:r}),n=new GainNode(e,{gain:s}),a=new GainNode(e,{gain:1-s});return t.connect(o),o.connect(n),n.connect(o),o.connect(a),a}generateDistributedArray(e,t,r=.1,s=.05){let o=e*r,n=new Array(t);for(let a=0;a<t;a++){let c=a/(t-1||1),l=e-o+c*2*o;n[a]=l*(1-(Math.random()*2-1)*s)}return n}createSchroederReverb(e,t,r,s,o){let n=new GainNode(e),a=new GainNode(e);for(let u=0;u<r.length;u++)this.createCombFilter(e,n,r[u],t[u]).connect(a);let c=[];for(let u=0;u<o.length;u++){let h=this.createAllpassFilter(e,u===0?a:c.at(-1),o[u],s[u]);c.push(h)}let l=c.at(-1);return{input:n,output:l}}createReverbEffect(e){let{algorithm:t,time:r,feedback:s}=this.reverb;switch(t){case"ConvolutionReverb":{let o=this.createConvolutionReverbImpulse(e,r,this.calcDelay(r,s));return this.createConvolutionReverb(e,o)}case"SchroederReverb":{let o=this.generateDistributedArray(s,4),n=o.map(l=>this.calcDelay(r,l)),a=this.generateDistributedArray(s,4),c=a.map(l=>this.calcDelay(r,l));return this.createSchroederReverb(e,o,n,a,c)}}}createChorusEffect(e){let t=new GainNode(e),r=new GainNode(e),s=new GainNode(e),o=new OscillatorNode(e,{frequency:this.chorus.modRate}),n=new GainNode(e,{gain:this.chorus.modDepth/2}),a=this.chorus.delayTimes,c=[],l=[];for(let u=0;u<a.length;u++){let h=a[u],d=new DelayNode(e,{maxDelayTime:.1,delayTime:h}),p=new GainNode(e,{gain:this.chorus.feedback});c.push(d),l.push(p),t.connect(d),n.connect(d.delayTime),d.connect(p),p.connect(d),d.connect(r)}return r.connect(s),o.connect(n),o.start(),{input:t,output:r,sendGain:s,lfo:o,lfoGain:n,delayNodes:c,feedbackGains:l}}cbToRatio(e){return Math.pow(10,e/200)}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=e.isDrum?0:this.masterCoarseTuning+this.masterFineTuning,r=e.coarseTuning+e.fineTuning,s=t+r,o=e.state.pitchWheel*2-1,n=e.state.pitchWheelSensitivity*12800,a=o*n,c=e.channelPressureTable[0];if(0<=c){let u=(c-64)/37.5*e.state.channelPressure;return s+a+u}else return s+a}calcNoteDetune(e,t){return e.scaleOctaveTuningTable[t.noteNumber%12]}updateChannelDetune(e,t){this.processScheduledNotes(e,r=>{this.updateDetune(e,r,t)})}updateDetune(e,t,r){let s=this.calcNoteDetune(e,t),o=this.getPitchControl(e,t),n=e.detune+s+o;if(.5<=e.state.portamento&&0<=t.portamentoNoteNumber){let a=t.startTime,c=(t.noteNumber-t.portamentoNoteNumber)*100,l=a+this.getPortamentoTime(e,t);t.bufferSource.detune.cancelScheduledValues(r).setValueAtTime(n-c,r).linearRampToValueAtTime(n,l)}else t.bufferSource.detune.cancelScheduledValues(r).setValueAtTime(n,r)}getPortamentoTime(e,t){let r=Math.abs(t.noteNumber-t.portamentoNoteNumber),s=Math.ceil(e.state.portamentoTime*127);return r/this.getPitchIncrementSpeed(s)/10}getPitchIncrementSpeed(e){let t=[[0,1e3],[6,100],[16,20],[32,10],[48,5],[64,2.5],[80,1],[96,.4],[112,.15],[127,.01]],r=new Array(t.length);for(let x=0;x<t.length;x++){let[I,de]=t[x];if(e===I)return de;r[x]=[I,Math.log(de)]}let s=0;for(let x=1;x<r.length;x++)if(e<=r[x][0]){s=x-1;break}let[o,n]=r[s],[a,c]=r[s+1],l=a-o,u=(e-o)/l,h,d;if(s===0)h=(c-n)/l;else{let[x,I]=r[s-1];h=(c-I)/(a-x)}if(s===r.length-2)d=(c-n)/l;else{let[x,I]=r[s+2];d=(I-n)/(x-o)}let p=u*u,m=p*u,g=2*m-3*p+1,V=m-2*p+u,C=-2*m+3*p,k=m-p,w=g*n+C*c+l*(V*h+k*d);return Math.exp(w)}setPortamentoVolumeEnvelope(e,t,r){let s=e.state,{voiceParams:o,startTime:n}=t,c=this.cbToRatio(-o.initialAttenuation)*(1+this.getAmplitudeControl(e,t))*(1-o.volSustain),h=n+o.volDelay+o.volAttack*s.attackTime*2+o.volHold;t.volumeEnvelopeNode.gain.cancelScheduledValues(r).setValueAtTime(c,h)}setVolumeEnvelope(e,t,r){let s=e.state,{voiceParams:o,startTime:n}=t,a=this.cbToRatio(-o.initialAttenuation)*(1+this.getAmplitudeControl(e,t)),c=a*(1-o.volSustain),l=n+o.volDelay,u=l+o.volAttack*s.attackTime*2,h=u+o.volHold,d=h+o.volDecay*s.decayTime*2;t.volumeEnvelopeNode.gain.cancelScheduledValues(r).setValueAtTime(0,n).setValueAtTime(1e-6,l).exponentialRampToValueAtTime(a,u).setValueAtTime(a,h).linearRampToValueAtTime(c,d)}setPortamentoPitchEnvelope(e,t){let r=e.voiceParams.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(r,t)}setPitchEnvelope(e,t){let{voiceParams:r}=e,s=r.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(s,t);let o=r.modEnvToPitch;if(o===0)return;let a=this.rateToCent(s)+o,c=this.centToRate(a),l=e.startTime+r.modDelay,u=l+r.modAttack,h=u+r.modHold,d=h+r.modDecay;e.bufferSource.playbackRate.setValueAtTime(s,l).exponentialRampToValueAtTime(c,u).setValueAtTime(c,h).linearRampToValueAtTime(s,d)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setPortamentoFilterEnvelope(e,t,r){let s=e.state,{voiceParams:o,startTime:n}=t,a=this.getSoftPedalFactor(e,t),c=o.initialFilterFc+this.getFilterCutoffControl(e,t),l=this.centToHz(c)*a*s.brightness*2,u=this.centToHz(o.initialFilterFc+o.modEnvToFilterFc)*a*s.brightness*2,h=l+(u-l)*(1-o.modSustain),d=this.clampCutoffFrequency(l),p=this.clampCutoffFrequency(h),m=n+this.getPortamentoTime(e,t),g=n+o.modDelay;t.filterNode.frequency.cancelScheduledValues(r).setValueAtTime(d,n).setValueAtTime(d,g).linearRampToValueAtTime(p,m)}setFilterEnvelope(e,t,r){let s=e.state,{voiceParams:o,startTime:n}=t,a=this.getSoftPedalFactor(e,t),c=o.initialFilterFc+this.getFilterCutoffControl(e,t),l=this.centToHz(c)*a*s.brightness*2,u=this.centToHz(c+o.modEnvToFilterFc)*a*s.brightness*2,h=l+(u-l)*(1-o.modSustain),d=this.clampCutoffFrequency(l),p=this.clampCutoffFrequency(u),m=this.clampCutoffFrequency(h),g=n+o.modDelay,V=g+o.modAttack,C=V+o.modHold,k=C+o.modDecay;t.filterNode.frequency.cancelScheduledValues(r).setValueAtTime(d,n).setValueAtTime(d,g).exponentialRampToValueAtTime(p,V).setValueAtTime(p,C).linearRampToValueAtTime(m,k)}startModulation(e,t,r){let{voiceParams:s}=t;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(s.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:s.modLfoToFilterFc}),t.modulationDepth=new GainNode(this.audioContext),this.setModLfoToPitch(e,t,r),t.volumeDepth=new GainNode(this.audioContext),this.setModLfoToVolume(e,t,r),t.modulationLFO.start(t.startTime+s.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}startVibrato(e,t,r){let{voiceParams:s}=t,o=e.state;t.vibratoLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(s.freqVibLFO)*o.vibratoRate*2}),t.vibratoLFO.start(t.startTime+s.delayVibLFO*o.vibratoDelay*2),t.vibratoDepth=new GainNode(this.audioContext),this.setVibLfoToPitch(e,t,r),t.vibratoLFO.connect(t.vibratoDepth),t.vibratoDepth.connect(t.bufferSource.detune)}async getAudioBuffer(e,t,r,s){let o=this.getVoiceId(e,t,r),n=this.voiceCache.get(o);if(n)return n.counter+=1,n.maxCount<=n.counter&&this.voiceCache.delete(o),n.audioBuffer;{let a=this.voiceCounter.get(o)??0,c=await this.createAudioBuffer(s),l={audioBuffer:c,maxCount:a,counter:1};return this.voiceCache.set(o,l),c}}async createNote(e,t,r,s,o){let n=this.audioContext.currentTime,a=e.state,c=this.getControllerState(e,r,s,0),l=t.getAllParams(c),u=new le(r,s,o,t,l),h=await this.getAudioBuffer(e,r,s,l);u.bufferSource=this.createBufferSource(e,r,l,h),u.volumeEnvelopeNode=new GainNode(this.audioContext),u.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:l.initialFilterQ/5*a.filterResonance});let d=e.scheduledNotes.at(-1);return d&&d.noteNumber!==r&&(u.portamentoNoteNumber=d.noteNumber),.5<=e.state.portamento&&0<=u.portamentoNoteNumber?(this.setPortamentoVolumeEnvelope(e,u,n),this.setPortamentoFilterEnvelope(e,u,n),this.setPortamentoPitchEnvelope(u,n)):(this.setVolumeEnvelope(e,u,n),this.setFilterEnvelope(e,u,n),this.setPitchEnvelope(u,n)),this.updateDetune(e,u,n),0<a.vibratoDepth&&this.startVibrato(e,u,n),0<a.modulationDepth&&this.startModulation(e,u,n),e.mono&&e.currentBufferSource&&(e.currentBufferSource.stop(o),e.currentBufferSource=u.bufferSource),u.bufferSource.connect(u.filterNode),u.filterNode.connect(u.volumeEnvelopeNode),this.setChorusSend(e,u,n),this.setReverbSend(e,u,n),u.bufferSource.start(o),u}calcBank(e){switch(this.mode){case"GM1":return e.isDrum?128:0;case"GM2":return e.bankMSB===121?0:e.isDrum?128:e.bank;default:return e.bank}}handleExclusiveClass(e,t,r){let s=e.voiceParams.exclusiveClass;if(s===0)return;let o=this.exclusiveClassNotes[s];if(o){let[n,a]=o;n&&!n.ending&&this.scheduleNoteOff(a,n.noteNumber,0,r,!0)}this.exclusiveClassNotes[s]=[e,t]}handleDrumExclusiveClass(e,t,r){let s=this.channels[t];if(!s.isDrum)return;let o=U[s.programNumber];if(!o)return;let n=o[e.noteNumber];if(n===0)return;let a=(n-1)*this.channels.length+t,c=this.drumExclusiveClassNotes[a];c&&!c.ending&&this.scheduleNoteOff(t,c.noteNumber,0,r,!0),this.drumExclusiveClassNotes[a]=e}async scheduleNoteOn(e,t,r,s){let o=this.channels[e],n=this.calcBank(o,e),a=this.soundFontTable[o.programNumber].get(n);if(a===void 0)return;let l=this.soundFonts[a].getVoice(n,o.programNumber,t,r);if(!l)return;let u=await this.createNote(o,l,t,r,s);if(o.isDrum){let{keyBasedGainLs:d,keyBasedGainRs:p}=o,m=d[t],g=p[t];if(!m){let V=this.createChannelAudioNodes(this.audioContext);m=d[t]=V.gainL,g=p[t]=V.gainR}u.volumeEnvelopeNode.connect(m),u.volumeEnvelopeNode.connect(g)}else u.volumeEnvelopeNode.connect(o.gainL),u.volumeEnvelopeNode.connect(o.gainR);.5<=o.state.sustainPedal&&o.sustainNotes.push(u),this.handleExclusiveClass(u,e,s),this.handleDrumExclusiveClass(u,e,s);let h=o.scheduledNotes;u.index=h.length,h.push(u)}noteOn(e,t,r,s){return s??=this.audioContext.currentTime,this.scheduleNoteOn(e,t,r,s,void 0)}disconnectNote(e){e.bufferSource.disconnect(),e.filterNode.disconnect(),e.volumeEnvelopeNode.disconnect(),e.modulationDepth&&(e.volumeDepth.disconnect(),e.modulationDepth.disconnect(),e.modulationLFO.stop()),e.vibratoDepth&&(e.vibratoDepth.disconnect(),e.vibratoLFO.stop()),e.reverbSend&&e.reverbSend.disconnect(),e.chorusSend&&e.chorusSend.disconnect()}releaseNote(e,t,r){let s=r+t.voiceParams.volRelease*e.state.releaseTime*2,o=r+t.voiceParams.modRelease,n=Math.min(s,o);return t.filterNode.frequency.cancelScheduledValues(r).linearRampToValueAtTime(0,o),t.volumeEnvelopeNode.gain.cancelScheduledValues(r).linearRampToValueAtTime(0,s),new Promise(a=>{this.scheduleTask(()=>{let c=t.bufferSource;c.loop=!1,c.stop(n),this.disconnectNote(t),e.scheduledNotes[t.index]=void 0,a()},n)})}scheduleNoteOff(e,t,r,s,o){let n=this.channels[e],a=n.state;if(!o){if(n.isDrum){if(!this.isLoopDrum(n,t))return}else if(.5<=a.sustainPedal||.5<=a.sostenutoPedal)return}let c=this.findNoteOffIndex(n,t);if(c<0)return;let l=n.scheduledNotes[c];l.ending=!0,this.setNoteIndex(n,c),this.releaseNote(n,l,s)}setNoteIndex(e,t){let r=!0;for(let s=e.scheduleIndex;s<t;s++){let o=e.scheduledNotes[s];if(o&&!o.ending){r=!1;break}}r&&(e.scheduleIndex=t+1)}findNoteOffIndex(e,t){let r=e.scheduledNotes;for(let s=e.scheduleIndex;s<r.length;s++){let o=r[s];if(o&&!o.ending&&o.noteNumber===t)return s}return-1}noteOff(e,t,r,s){return s??=this.audioContext.currentTime,this.scheduleNoteOff(e,t,r,s,!1)}releaseSustainPedal(e,t,r){let s=t*2,o=this.channels[e],n=[];for(let a=0;a<o.sustainNotes.length;a++){let c=this.scheduleNoteOff(e,o.sustainNotes[a].noteNumber,s,r);n.push(c)}return o.sustainNotes=[],n}releaseSostenutoPedal(e,t,r){let s=t*2,o=this.channels[e],n=[],a=o.sostenutoNotes;o.state.sostenutoPedal=0;for(let c=0;c<a.length;c++){let l=a[c],u=this.scheduleNoteOff(e,l.noteNumber,s,r);n.push(u)}return o.sostenutoNotes=[],n}handleMIDIMessage(e,t,r,s){let o=e&15,n=e&240;switch(n){case 128:return this.noteOff(o,t,r,s);case 144:return this.noteOn(o,t,r,s);case 160:return this.setPolyphonicKeyPressure(o,t,r,s);case 176:return this.setControlChange(o,t,r,s);case 192:return this.setProgramChange(o,t,s);case 208:return this.setChannelPressure(o,t,s);case 224:return this.handlePitchBendMessage(o,t,r,s);default:console.warn(`Unsupported MIDI message: ${n.toString(16)}`)}}setPolyphonicKeyPressure(e,t,r,s){let o=this.channels[e],n=o.polyphonicKeyPressureTable;this.processActiveNotes(o,s,a=>{a.noteNumber===t&&(a.pressure=r,this.setEffects(o,a,n,s))}),this.applyVoiceParams(o,10)}setProgramChange(e,t,r){let s=this.channels[e];if(s.bank=s.bankMSB*128+s.bankLSB,s.programNumber=t,this.mode==="GM2")switch(s.bankMSB){case 120:s.isDrum=!0;break;case 121:s.isDrum=!1;break}}setChannelPressure(e,t,r){let s=this.channels[e];if(s.isDrum)return;let o=s.state.channelPressure,n=t/127;s.state.channelPressure=n;let a=s.channelPressureTable[0];if(0<=a){let l=(a-64)/37.5;s.detune+=l*(n-o)}let c=s.channelPressureTable;this.processActiveNotes(s,r,l=>{this.setEffects(s,l,c,r)}),this.applyVoiceParams(s,13)}handlePitchBendMessage(e,t,r,s){let o=r*128+t;this.setPitchBend(e,o,s)}setPitchBend(e,t,r){let s=this.channels[e];if(s.isDrum)return;r??=this.audioContext.currentTime;let o=s.state,n=o.pitchWheel*2-1,a=(t-8192)/8192;o.pitchWheel=t/16383,s.detune+=(a-n)*o.pitchWheelSensitivity*12800,this.updateChannelDetune(s,r),this.applyVoiceParams(s,14,r)}setModLfoToPitch(e,t,r){if(t.modulationDepth){let s=t.voiceParams.modLfoToPitch+this.getLFOPitchDepth(e,t),n=(Math.abs(s)+e.state.modulationDepth)*Math.sign(s);t.modulationDepth.gain.cancelScheduledValues(r).setValueAtTime(n,r)}else this.startModulation(e,t,r)}setVibLfoToPitch(e,t,r){let s=t.voiceParams.vibLfoToPitch,o=Math.abs(s)*e.state.vibratoDepth*2,n=0<s;t.vibratoDepth.gain.cancelScheduledValues(r).setValueAtTime(o*n,r)}setModLfoToFilterFc(e,t,r){let s=t.voiceParams.modLfoToFilterFc+this.getLFOFilterDepth(e,t);t.filterDepth.gain.cancelScheduledValues(r).setValueAtTime(s,r)}setModLfoToVolume(e,t,r){let s=t.voiceParams.modLfoToVolume,n=(this.cbToRatio(Math.abs(s))-1)*Math.sign(s)*(1+this.getLFOAmplitudeDepth(e,t));t.volumeDepth.gain.cancelScheduledValues(r).setValueAtTime(n,r)}setReverbSend(e,t,r){let s=t.voiceParams.reverbEffectsSend*e.state.reverbSendLevel;if(e.isDrum){let o=this.getKeyBasedValue(e,t.noteNumber,91);0<=o&&(s=o/127)}if(!t.reverbSend)0<s&&(t.reverbSend=new GainNode(this.audioContext,{gain:s}),t.volumeEnvelopeNode.connect(t.reverbSend),t.reverbSend.connect(this.reverbEffect.input));else if(t.reverbSend.gain.cancelScheduledValues(r).setValueAtTime(s,r),0<s)t.volumeEnvelopeNode.connect(t.reverbSend);else try{t.volumeEnvelopeNode.disconnect(t.reverbSend)}catch{}}setChorusSend(e,t,r){let s=t.voiceParams.chorusEffectsSend*e.state.chorusSendLevel;if(e.isDrum){let o=this.getKeyBasedValue(e,t.noteNumber,93);0<=o&&(s=o/127)}if(!t.chorusSend)0<s&&(t.chorusSend=new GainNode(this.audioContext,{gain:s}),t.volumeEnvelopeNode.connect(t.chorusSend),t.chorusSend.connect(this.chorusEffect.input));else if(t.chorusSend.gain.cancelScheduledValues(r).setValueAtTime(s,r),0<s)t.volumeEnvelopeNode.connect(t.chorusSend);else try{t.volumeEnvelopeNode.disconnect(t.chorusSend)}catch{}}setDelayModLFO(e,t){let r=e.startTime;r<t||(e.modulationLFO.stop(t),e.modulationLFO.start(r+e.voiceParams.delayModLFO),e.modulationLFO.connect(e.filterDepth))}setFreqModLFO(e,t){let r=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(r,t)}setFreqVibLFO(e,t,r){let s=t.voiceParams.freqVibLFO;t.vibratoLFO.frequency.cancelScheduledValues(r).setValueAtTime(s*e.state.vibratoRate*2,r)}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,r,s)=>{0<e.state.modulationDepth&&this.setModLfoToPitch(e,t,s)},vibLfoToPitch:(e,t,r,s)=>{0<e.state.vibratoDepth&&this.setVibLfoToPitch(e,t,s)},modLfoToFilterFc:(e,t,r,s)=>{0<e.state.modulationDepth&&this.setModLfoToFilterFc(e,t,s)},modLfoToVolume:(e,t,r,s)=>{0<e.state.modulationDepth&&this.setModLfoToVolume(e,t,s)},chorusEffectsSend:(e,t,r,s)=>{this.setChorusSend(e,t,s)},reverbEffectsSend:(e,t,r,s)=>{this.setReverbSend(e,t,s)},delayModLFO:(e,t,r,s)=>this.setDelayModLFO(t,s),freqModLFO:(e,t,r,s)=>this.setFreqModLFO(t,s),delayVibLFO:(e,t,r,s)=>{if(0<e.state.vibratoDepth){let o=e.state.vibratoDelay*2,n=t.startTime+r*o;if(s<n)return;let a=t.voiceParams.delayVibLFO,c=t.startTime+a*o;t.vibratoLFO.stop(s),t.vibratoLFO.start(c)}},freqVibLFO:(e,t,r,s)=>{0<e.state.vibratoDepth&&this.setFreqVibLFO(e,t,s)}}}getControllerState(e,t,r,s){let o=new Float32Array(e.state.array.length);return o.set(e.state.array),o[2]=r/127,o[3]=t/127,o[10]=s/127,o[13]=o.channelPressure/127,o}applyVoiceParams(e,t,r){this.processScheduledNotes(e,s=>{let o=this.getControllerState(e,s.noteNumber,s.velocity,s.pressure),n=s.voice.getParams(t,o),a=!1,c=!1,l=!1;for(let[u,h]of Object.entries(n)){let d=s.voiceParams[u];h!==d&&(s.voiceParams[u]=h,u in this.voiceParamsHandlers?this.voiceParamsHandlers[u](e,s,d,r):(pt.has(u)&&(a=!0),bt.has(u)&&(c=!0),gt.has(u)&&(l=!0)))}a&&this.setVolumeEnvelope(e,s,r),c&&this.setFilterEnvelope(e,s,r),l&&this.setPitchEnvelope(s,r)})}createControlChangeHandlers(){let e=new Array(128);return e[0]=this.setBankMSB,e[1]=this.setModulationDepth,e[5]=this.setPortamentoTime,e[6]=this.dataEntryMSB,e[7]=this.setVolume,e[10]=this.setPan,e[11]=this.setExpression,e[32]=this.setBankLSB,e[38]=this.dataEntryLSB,e[64]=this.setSustainPedal,e[65]=this.setPortamento,e[66]=this.setSostenutoPedal,e[67]=this.setSoftPedal,e[71]=this.setFilterResonance,e[72]=this.setReleaseTime,e[73]=this.setAttackTime,e[74]=this.setBrightness,e[75]=this.setDecayTime,e[76]=this.setVibratoRate,e[77]=this.setVibratoDepth,e[78]=this.setVibratoDelay,e[91]=this.setReverbSendLevel,e[93]=this.setChorusSendLevel,e[96]=this.dataIncrement,e[97]=this.dataDecrement,e[100]=this.setRPNLSB,e[101]=this.setRPNMSB,e[120]=this.allSoundOff,e[121]=this.resetAllControllers,e[123]=this.allNotesOff,e[124]=this.omniOff,e[125]=this.omniOn,e[126]=this.monoOn,e[127]=this.polyOn,e}setControlChange(e,t,r,s){let o=this.controlChangeHandlers[t];if(o){o.call(this,e,r,s);let n=this.channels[e];this.applyVoiceParams(n,t+128,s),this.setControlChangeEffects(n,t,s)}else console.warn(`Unsupported Control change: controllerType=${t} value=${r}`)}setBankMSB(e,t){this.channels[e].bankMSB=t}updateModulation(e,t){let r=e.state.modulationDepth*e.modulationDepthRange;this.processScheduledNotes(e,s=>{s.modulationDepth?s.modulationDepth.gain.setValueAtTime(r,t):this.startModulation(e,s,t)})}setModulationDepth(e,t,r){let s=this.channels[e];s.isDrum||(r??=this.audioContext.currentTime,s.state.modulationDepth=t/127,this.updateModulation(s,r))}updatePortamento(e,t){this.processScheduledNotes(e,r=>{.5<=e.state.portamento?0<=r.portamentoNoteNumber&&(this.setPortamentoVolumeEnvelope(e,r,t),this.setPortamentoFilterEnvelope(e,r,t),this.setPortamentoPitchEnvelope(r,t),this.updateDetune(e,r,t)):0<=r.portamentoNoteNumber&&(this.setVolumeEnvelope(e,r,t),this.setFilterEnvelope(e,r,t),this.setPitchEnvelope(r,t),this.updateDetune(e,r,t))})}setPortamentoTime(e,t,r){let s=this.channels[e];r??=this.audioContext.currentTime,s.state.portamentoTime=t/127,!s.isDrum&&this.updatePortamento(s,r)}setVolume(e,t,r){r??=this.audioContext.currentTime;let s=this.channels[e];if(s.state.volume=t/127,s.isDrum)for(let o=0;o<128;o++)this.updateKeyBasedVolume(s,o,r);else this.updateChannelVolume(s,r)}panToGain(e){let t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t,r){r??=this.audioContext.currentTime;let s=this.channels[e];if(s.state.pan=t/127,s.isDrum)for(let o=0;o<128;o++)this.updateKeyBasedVolume(s,o,r);else this.updateChannelVolume(s,r)}setExpression(e,t,r){r??=this.audioContext.currentTime;let s=this.channels[e];s.state.expression=t/127,this.updateChannelVolume(s,r)}setBankLSB(e,t){this.channels[e].bankLSB=t}dataEntryLSB(e,t,r){this.channels[e].dataLSB=t,this.handleRPN(e,0,r)}updateChannelVolume(e,t){let r=e.state,s=r.volume*r.expression,{gainLeft:o,gainRight:n}=this.panToGain(r.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(s*o,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(s*n,t)}updateKeyBasedVolume(e,t,r){let s=e.state,o=s.volume*s.expression,n=s.pan,a=e.keyBasedGainLs[t],c=e.keyBasedGainRs[t];if(!a)return;let l=this.getKeyBasedValue(e,t,7),u=0<=l?o*l/64:o,h=this.getKeyBasedValue(e,t,10),d=0<=h?h/127:n,{gainLeft:p,gainRight:m}=this.panToGain(d);a.gain.cancelScheduledValues(r).setValueAtTime(u*p,r),c.gain.cancelScheduledValues(r).setValueAtTime(u*m,r)}setSustainPedal(e,t,r){let s=this.channels[e];s.isDrum||(r??=this.audioContext.currentTime,s.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(s,o=>{s.sustainNotes.push(o)}):this.releaseSustainPedal(e,t,r))}setPortamento(e,t,r){let s=this.channels[e];s.isDrum||(r??=this.audioContext.currentTime,s.state.portamento=t/127,this.updatePortamento(s,r))}setSostenutoPedal(e,t,r){let s=this.channels[e];if(!s.isDrum)if(r??=this.audioContext.currentTime,s.state.sostenutoPedal=t/127,64<=t){let o=[];this.processActiveNotes(s,r,n=>{o.push(n)}),s.sostenutoNotes=o}else this.releaseSostenutoPedal(e,t,r)}getSoftPedalFactor(e,t){return 1-(.1+t.noteNumber/127*.2)*e.state.softPedal}setSoftPedal(e,t,r){let s=this.channels[e];if(s.isDrum)return;let o=s.state;r??=this.audioContext.currentTime,o.softPedal=t/127,this.processScheduledNotes(s,n=>{.5<=o.portamento&&0<=n.portamentoNoteNumber?(this.setPortamentoVolumeEnvelope(s,n,r),this.setPortamentoFilterEnvelope(s,n,r)):(this.setVolumeEnvelope(s,n,r),this.setFilterEnvelope(s,n,r))})}setFilterResonance(e,t,r){let s=this.channels[e];if(s.isDrum)return;r??=this.audioContext.currentTime;let o=s.state;o.filterResonance=t/127,this.processScheduledNotes(s,n=>{let a=n.voiceParams.initialFilterQ/5*o.filterResonance;n.filterNode.Q.setValueAtTime(a,r)})}setReleaseTime(e,t,r){let s=this.channels[e];s.isDrum||(r??=this.audioContext.currentTime,s.state.releaseTime=t/127)}setAttackTime(e,t,r){let s=this.channels[e];s.isDrum||(r??=this.audioContext.currentTime,s.state.attackTime=t/127,this.processScheduledNotes(s,o=>{if(o.startTime<r)return!1;this.setVolumeEnvelope(s,o,r)}))}setBrightness(e,t,r){let s=this.channels[e];if(s.isDrum)return;let o=s.state;r??=this.audioContext.currentTime,o.brightness=t/127,this.processScheduledNotes(s,n=>{.5<=o.portamento&&0<=n.portamentoNoteNumber?this.setPortamentoFilterEnvelope(s,n,r):this.setFilterEnvelope(s,n,r)})}setDecayTime(e,t,r){let s=this.channels[e];s.isDrum||(r??=this.audioContext.currentTime,s.state.decayTime=t/127,this.processScheduledNotes(s,o=>{this.setVolumeEnvelope(s,o,r)}))}setVibratoRate(e,t,r){let s=this.channels[e];s.isDrum||(r??=this.audioContext.currentTime,s.state.vibratoRate=t/127,!(s.vibratoDepth<=0)&&this.processScheduledNotes(s,o=>{this.setVibLfoToPitch(s,o,r)}))}setVibratoDepth(e,t,r){let s=this.channels[e];if(s.isDrum)return;r??=this.audioContext.currentTime;let o=s.state.vibratoDepth;s.state.vibratoDepth=t/127,0<o?this.processScheduledNotes(s,n=>{this.setFreqVibLFO(s,n,r)}):this.processScheduledNotes(s,n=>{this.startVibrato(s,n,r)})}setVibratoDelay(e,t,r){let s=this.channels[e];s.isDrum||(r??=this.audioContext.currentTime,s.state.vibratoDelay=t/127,0<s.state.vibratoDepth&&this.processScheduledNotes(s,o=>{this.startVibrato(s,o,r)}))}setReverbSendLevel(e,t,r){r??=this.audioContext.currentTime;let s=this.channels[e],o=s.state;o.reverbSendLevel=t/127,this.processScheduledNotes(s,n=>{this.setReverbSend(s,n,r)})}setChorusSendLevel(e,t,r){r??=this.audioContext.currentTime;let s=this.channels[e],o=s.state;o.chorusSendLevel=t/127,this.processScheduledNotes(s,n=>{this.setChorusSend(s,n,r)})}limitData(e,t,r,s,o){o<e.dataLSB?(e.dataMSB++,e.dataLSB=s):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=o),r<e.dataMSB?(e.dataMSB=r,e.dataLSB=o):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=s)}limitDataMSB(e,t,r){r<e.dataMSB?e.dataMSB=r:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e,t,r){let s=this.channels[e];switch(s.rpnMSB*128+s.rpnLSB){case 0:s.dataLSB+=t,this.handlePitchBendRangeRPN(e,r);break;case 1:s.dataLSB+=t,this.handleFineTuningRPN(e,r);break;case 2:s.dataMSB+=t,this.handleCoarseTuningRPN(e,r);break;case 5:s.dataLSB+=t,this.handleModulationDepthRangeRPN(e,r);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${s.rpnMSB} LSB=${s.rpnLSB}`)}}dataIncrement(e,t){t??=this.audioContext.currentTime,this.handleRPN(e,1,t)}dataDecrement(e,t){t??=this.audioContext.currentTime,this.handleRPN(e,-1,t)}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,r){this.channels[e].dataMSB=t,this.handleRPN(e,0,r)}handlePitchBendRangeRPN(e,t){let r=this.channels[e];this.limitData(r,0,127,0,99);let s=r.dataMSB+r.dataLSB/100;this.setPitchBendRange(e,s,t)}setPitchBendRange(e,t,r){let s=this.channels[e];if(s.isDrum)return;r??=this.audioContext.currentTime;let o=s.state,n=o.pitchWheelSensitivity,a=t/128;o.pitchWheelSensitivity=a,s.detune+=(o.pitchWheel*2-1)*(a-n)*12800,this.updateChannelDetune(s,r),this.applyVoiceParams(s,16,r)}handleFineTuningRPN(e,t){let r=this.channels[e];this.limitData(r,0,127,0,127);let s=r.dataMSB*128+r.dataLSB;this.setFineTuning(e,s,t)}setFineTuning(e,t,r){let s=this.channels[e];if(s.isDrum)return;r??=this.audioContext.currentTime;let o=s.fineTuning,n=(t-8192)/8.192;s.fineTuning=n,s.detune+=n-o,this.updateChannelDetune(s,r)}handleCoarseTuningRPN(e,t){let r=this.channels[e];this.limitDataMSB(r,0,127);let s=r.dataMSB;this.setCoarseTuning(e,s,t)}setCoarseTuning(e,t,r){let s=this.channels[e];if(s.isDrum)return;r??=this.audioContext.currentTime;let o=s.coarseTuning,n=(t-64)*100;s.coarseTuning=n,s.detune+=n-o,this.updateChannelDetune(s,r)}handleModulationDepthRangeRPN(e,t){let r=this.channels[e];this.limitData(r,0,127,0,127);let s=(dataMSB+dataLSB/128)*100;this.setModulationDepthRange(e,s,t)}setModulationDepthRange(e,t,r){let s=this.channels[e];s.isDrum||(r??=this.audioContext.currentTime,s.modulationDepthRange=t,this.updateModulation(s,r))}allSoundOff(e,t,r){return r??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!0,r)}resetAllStates(e){let t=this.audioContext.currentTime,r=this.channels[e],s=r.state,o=Object.entries(X);for(let[n,{type:a,defaultValue:c}]of o)128<=a?this.setControlChange(e,a-128,Math.ceil(c*127),t):s[n]=c;for(let n of Object.keys(this.constructor.channelSettings))r[n]=this.constructor.channelSettings[n];this.resetChannelTable(r),this.mode="GM2",this.masterFineTuning=0,this.masterCoarseTuning=0}resetAllControllers(e,t,r){let s=["polyphonicKeyPressure","channelPressure","pitchWheel","expression","modulationDepth","sustainPedal","portamento","sostenutoPedal","softPedal"],o=this.channels[e],n=o.state;for(let c=0;c<s.length;c++){let l=s[c],{type:u,defaultValue:h}=X[l];128<=u?this.setControlChange(e,u-128,Math.ceil(h*127),r):n[l]=h}this.setPitchBend(e,8192,r);let a=["rpnMSB","rpnLSB"];for(let c=0;c<a.length;c++){let l=a[c];o[l]=this.constructor.channelSettings[l]}}allNotesOff(e,t,r){return r??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!1,r)}omniOff(e,t,r){this.allNotesOff(e,t,r)}omniOn(e,t,r){this.allNotesOff(e,t,r)}monoOn(e,t,r){let s=this.channels[e];this.allNotesOff(e,t,r),s.mono=!0}polyOn(e,t,r){let s=this.channels[e];this.allNotesOff(e,t,r),s.mono=!1}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 8:switch(e[3]){case 8:return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!1,t);case 9:return this.handleScaleOctaveTuning2ByteFormatSysEx(e,!1,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:this.GM1SystemOn(t);break;case 2:break;case 3:this.GM2SystemOn(t);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(e){e??=this.audioContext.currentTime,this.mode="GM1";for(let t=0;t<this.channels.length;t++){this.allSoundOff(t,0,e);let r=this.channels[t];r.bankMSB=0,r.bankLSB=0,r.bank=0,r.isDrum=!1}this.channels[9].bankMSB=1,this.channels[9].bank=128,this.channels[9].isDrum=!0}GM2SystemOn(e){e??=this.audioContext.currentTime,this.mode="GM2";for(let t=0;t<this.channels.length;t++){this.allSoundOff(t,0,e);let r=this.channels[t];r.bankMSB=121,r.bankLSB=0,r.bank=15488,r.isDrum=!1}this.channels[9].bankMSB=120,this.channels[9].bank=15360,this.channels[9].isDrum=!0}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e,t);case 3:return this.handleMasterFineTuningSysEx(e,t);case 4:return this.handleMasterCoarseTuningSysEx(e,t);case 5:return this.handleGlobalParameterControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 8:switch(e[3]){case 8:return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!0,t);case 9:return this.handleScaleOctaveTuning2ByteFormatSysEx(e,!0,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:return this.handlePressureSysEx(e,"channelPressureTable",t);case 2:return this.handlePressureSysEx(e,"polyphonicKeyPressureTable",t);case 3:return this.handleControlChangeSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 10:switch(e[3]){case 1:return this.handleKeyBasedInstrumentControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){let r=(e[5]*128+e[4])/16383;this.setMasterVolume(r,t)}setMasterVolume(e,t){t??=this.audioContext.currentTime,e<0&&1<e?console.error("Master Volume is out of range"):this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleMasterFineTuningSysEx(e,t){let r=e[5]*128+e[4];this.setMasterFineTuning(r,t)}setMasterFineTuning(e,t){let r=this.masterFineTuning,s=(e-8192)/8.192;this.masterFineTuning=s;let o=s-r;for(let n=0;n<this.channels.length;n++){let a=this.channels[n];a.isDrum||(a.detune+=o,this.updateChannelDetune(a,t))}}handleMasterCoarseTuningSysEx(e,t){let r=e[4];this.setMasterCoarseTuning(r,t)}setMasterCoarseTuning(e,t){let r=this.masterCoarseTuning,s=(e-64)*100;this.masterCoarseTuning=s;let o=s-r;for(let n=0;n<this.channels.length;n++){let a=this.channels[n];a.isDrum||(a.detune+=o,this.updateChannelDetune(a,t))}}handleGlobalParameterControlSysEx(e,t){if(e[7]===1)switch(e[8]){case 1:return this.handleReverbParameterSysEx(e);case 2:return this.handleChorusParameterSysEx(e,t);default:console.warn(`Unsupported Global Parameter Control Message: ${e}`)}else console.warn(`Unsupported Global Parameter Control Message: ${e}`)}handleReverbParameterSysEx(e){switch(e[9]){case 0:return this.setReverbType(e[10]);case 1:return this.setReverbTime(e[10])}}setReverbType(e){this.reverb.time=this.getReverbTimeFromType(e),this.reverb.feedback=e===8?.9:.8,this.reverbEffect=this.createReverbEffect(this.audioContext)}getReverbTimeFromType(e){switch(e){case 0:return this.getReverbTime(44);case 1:return this.getReverbTime(50);case 2:return this.getReverbTime(56);case 3:return this.getReverbTime(64);case 4:return this.getReverbTime(64);case 8:return this.getReverbTime(50);default:console.warn(`Unsupported Reverb Time: ${e}`)}}setReverbTime(e){this.reverb.time=this.getReverbTime(e),this.reverbEffect=this.createReverbEffect(this.audioContext)}getReverbTime(e){return Math.exp((e-40)*.025)}calcDelay(e,t){return-e*Math.log10(t)/3}handleChorusParameterSysEx(e,t){switch(e[9]){case 0:return this.setChorusType(e[10],t);case 1:return this.setChorusModRate(e[10],t);case 2:return this.setChorusModDepth(e[10],t);case 3:return this.setChorusFeedback(e[10],t);case 4:return this.setChorusSendToReverb(e[10],t)}}setChorusType(e,t){switch(e){case 0:return this.setChorusParameter(3,5,0,0,t);case 1:return this.setChorusParameter(9,19,5,0,t);case 2:return this.setChorusParameter(3,19,8,0,t);case 3:return this.setChorusParameter(9,16,16,0,t);case 4:return this.setChorusParameter(2,24,64,0,t);case 5:return this.setChorusParameter(1,5,112,0,t);default:console.warn(`Unsupported Chorus Type: ${e}`)}}setChorusParameter(e,t,r,s,o){this.setChorusModRate(e,o),this.setChorusModDepth(t,o),this.setChorusFeedback(r,o),this.setChorusSendToReverb(s,o)}setChorusModRate(e,t){let r=this.getChorusModRate(e);this.chorus.modRate=r,this.chorusEffect.lfo.frequency.setValueAtTime(r,t)}getChorusModRate(e){return e*.122}setChorusModDepth(e,t){let r=this.getChorusModDepth(e);this.chorus.modDepth=r,this.chorusEffect.lfoGain.gain.cancelScheduledValues(t).setValueAtTime(r/2,t)}getChorusModDepth(e){return(e+1)/3200}setChorusFeedback(e,t){let r=this.getChorusFeedback(e);this.chorus.feedback=r;let s=this.chorusEffect;for(let o=0;o<s.feedbackGains.length;o++)s.feedbackGains[o].gain.cancelScheduledValues(t).setValueAtTime(r,t)}getChorusFeedback(e){return e*.00763}setChorusSendToReverb(e,t){let r=this.getChorusSendToReverb(e),s=this.chorusEffect.sendGain;0<this.chorus.sendToReverb?(this.chorus.sendToReverb=r,0<r?s.gain.cancelScheduledValues(t).setValueAtTime(r,t):s.disconnect()):(this.chorus.sendToReverb=r,0<r&&(s.connect(this.reverbEffect.input),s.gain.cancelScheduledValues(t).setValueAtTime(r,t)))}getChorusSendToReverb(e){return e*.00787}getChannelBitmap(e){let t=new Array(this.channels.length).fill(!1),r=e[4]&3,s=e[5]&127,o=e[6]&127;for(let n=0;n<7;n++)o&1<<n&&(t[n]=!0);for(let n=0;n<7;n++)s&1<<n&&(t[n+7]=!0);for(let n=0;n<2;n++)r&1<<n&&(t[n+14]=!0);return t}handleScaleOctaveTuning1ByteFormatSysEx(e,t,r){if(e.length<19){console.error("Data length is too short");return}let s=this.getChannelBitmap(e);for(let o=0;o<s.length;o++){if(!s[o])continue;let n=this.channels[o];if(!n.isDrum){for(let a=0;a<12;a++){let c=e[a+7]-64;n.scaleOctaveTuningTable[a]=c}t&&this.updateChannelDetune(n,r)}}}handleScaleOctaveTuning2ByteFormatSysEx(e,t,r){if(e.length<31){console.error("Data length is too short");return}let s=this.getChannelBitmap(e);for(let o=0;o<s.length;o++){if(!s[o])continue;let n=this.channels[o];if(!n.isDrum){for(let a=0;a<12;a++){let c=7+a*2,l=e[c]&127,u=e[c+1]&127,d=(l*128+u-8192)/8.192;n.scaleOctaveTuningTable[a]=d}t&&this.updateChannelDetune(n,r)}}}getPitchControl(e,t){let r=e.polyphonicKeyPressureTable[0];return r<0?0:(r-64)*t.pressure*t.pressure/37.5}getFilterCutoffControl(e,t){let r=e.channelPressureTable[1],s=0<=r?(r-64)*e.state.channelPressure:0,o=e.polyphonicKeyPressureTable[1],n=0<=o?(o-64)*t.pressure:0;return(s+n)*15}getAmplitudeControl(e,t){let r=e.channelPressureTable[2],s=0<=r?r*e.state.channelPressure:0,o=e.polyphonicKeyPressureTable[2],n=0<=o?o*t.pressure:0;return(s+n)/128}getLFOPitchDepth(e,t){let r=e.channelPressureTable[3],s=0<=r?r*e.state.channelPressure:0,o=e.polyphonicKeyPressureTable[3],n=0<=o?o*t.pressure:0;return(s+n)/254*600}getLFOFilterDepth(e,t){let r=e.channelPressureTable[4],s=0<=r?r*e.state.channelPressure:0,o=e.polyphonicKeyPressureTable[4],n=0<=o?o*t.pressure:0;return(s+n)/254*2400}getLFOAmplitudeDepth(e,t){let r=e.channelPressureTable[5],s=0<=r?r*e.state.channelPressure:0,o=e.polyphonicKeyPressureTable[5],n=0<=o?o*t.pressure:0;return(s+n)/254}setEffects(e,t,r,s){0<=r[0]&&this.updateDetune(e,t,s),.5<=e.state.portamemento&&0<=t.portamentoNoteNumber?(0<=r[1]&&this.setPortamentoFilterEnvelope(e,t,s),0<=r[2]&&this.setPortamentoVolumeEnvelope(e,t,s)):(0<=r[1]&&this.setFilterEnvelope(e,t,s),0<=r[2]&&this.setVolumeEnvelope(e,t,s)),0<=r[3]&&this.setModLfoToPitch(e,t,s),0<=r[4]&&this.setModLfoToFilterFc(e,t,s),0<=r[5]&&this.setModLfoToVolume(e,t,s)}handlePressureSysEx(e,t,r){let s=e[4],o=this.channels[s];if(o.isDrum)return;let n=o[t];for(let a=5;a<e.length-1;a+=2){let c=e[a],l=e[a+1];n[c]=l}this.processActiveNotes(o,r,a=>{this.setEffects(o,a,n,r)})}initControlTable(){return new Int8Array(768).fill(-1)}setControlChangeEffects(e,t,r){let o=t*6,n=e.controlTable.subarray(o,o+6);this.processScheduledNotes(e,a=>{this.setEffects(e,a,n,r)})}handleControlChangeSysEx(e,t){let r=e[4],s=this.channels[r];if(s.isDrum)return;let o=6,n=e[5],a=n*o,c=s.controlTable;for(let l=6;l<e.length;l+=2){let u=e[l],h=e[l+1];c[a+u]=h}this.setControlChangeEffects(s,n,t)}getKeyBasedValue(e,t,r){let s=t*128+r;return e.keyBasedInstrumentControlTable[s]}handleKeyBasedInstrumentControlSysEx(e,t){let r=e[4],s=this.channels[r];if(!s.isDrum)return;let o=e[5],n=s.keyBasedInstrumentControlTable;for(let a=6;a<e.length;a+=2){let c=e[a],l=e[a+1],u=o*128+c;switch(n[u]=l,c){case 7:case 10:this.updateKeyBasedVolume(s,o,t);break;default:this.setControlChange(r,c,l,t)}}}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(r=>{let s=new AudioBufferSourceNode(this.audioContext,{buffer:this.schedulerBuffer});s.connect(this.scheduler),s.onended=()=>{try{e()}finally{s.disconnect(),r()}},s.start(t)})}};export{Ce as Midy};
