var Ae=Object.create;var be=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var Ge=Object.getOwnPropertyNames;var je=Object.getPrototypeOf,Ke=Object.prototype.hasOwnProperty;var oe=(c,e)=>()=>(e||c((e={exports:{}}).exports,e),e.exports);var He=(c,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ge(e))!Ke.call(c,r)&&r!==t&&be(c,r,{get:()=>e[r],enumerable:!(s=Ue(e,r))||s.enumerable});return c};var qe=(c,e,t)=>(t=c!=null?Ae(je(c)):{},He(e||!c||!c.__esModule?be(t,"default",{value:c,enumerable:!0}):t,c));var ve=oe((Mt,ge)=>{function We(c){var e=new x(c),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var s=$e(t.data),r=[],o=0;!e.eof()&&o<s.numTracks;o++){var n=e.readChunk();if(n.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+n.id+"'";var a=ze(n.data);r.push(a)}return{header:s,tracks:r}}function $e(c){var e=new x(c),t=e.readUInt16(),s=e.readUInt16(),r={format:t,numTracks:s},o=e.readUInt16();return o&32768?(r.framesPerSecond=256-(o>>8),r.ticksPerFrame=o&255):r.ticksPerBeat=o,r}function ze(c){for(var e=new x(c),t=[];!e.eof();){var s=o();t.push(s)}return t;var r;function o(){var n={};n.deltaTime=e.readVarInt();var a=e.readUInt8();if((a&240)===240)if(a===255){n.meta=!0;var l=e.readUInt8(),u=e.readVarInt();switch(l){case 0:if(n.type="sequenceNumber",u!==2)throw"Expected length for sequenceNumber event is 2, got "+u;return n.number=e.readUInt16(),n;case 1:return n.type="text",n.text=e.readString(u),n;case 2:return n.type="copyrightNotice",n.text=e.readString(u),n;case 3:return n.type="trackName",n.text=e.readString(u),n;case 4:return n.type="instrumentName",n.text=e.readString(u),n;case 5:return n.type="lyrics",n.text=e.readString(u),n;case 6:return n.type="marker",n.text=e.readString(u),n;case 7:return n.type="cuePoint",n.text=e.readString(u),n;case 32:if(n.type="channelPrefix",u!=1)throw"Expected length for channelPrefix event is 1, got "+u;return n.channel=e.readUInt8(),n;case 33:if(n.type="portPrefix",u!=1)throw"Expected length for portPrefix event is 1, got "+u;return n.port=e.readUInt8(),n;case 47:if(n.type="endOfTrack",u!=0)throw"Expected length for endOfTrack event is 0, got "+u;return n;case 81:if(n.type="setTempo",u!=3)throw"Expected length for setTempo event is 3, got "+u;return n.microsecondsPerBeat=e.readUInt24(),n;case 84:if(n.type="smpteOffset",u!=5)throw"Expected length for smpteOffset event is 5, got "+u;var h=e.readUInt8(),d={0:24,32:25,64:29,96:30};return n.frameRate=d[h&96],n.hour=h&31,n.min=e.readUInt8(),n.sec=e.readUInt8(),n.frame=e.readUInt8(),n.subFrame=e.readUInt8(),n;case 88:if(n.type="timeSignature",u!=2&&u!=4)throw"Expected length for timeSignature event is 4 or 2, got "+u;return n.numerator=e.readUInt8(),n.denominator=1<<e.readUInt8(),u===4?(n.metronome=e.readUInt8(),n.thirtyseconds=e.readUInt8()):(n.metronome=36,n.thirtyseconds=8),n;case 89:if(n.type="keySignature",u!=2)throw"Expected length for keySignature event is 2, got "+u;return n.key=e.readInt8(),n.scale=e.readUInt8(),n;case 127:return n.type="sequencerSpecific",n.data=e.readBytes(u),n;default:return n.type="unknownMeta",n.data=e.readBytes(u),n.metatypeByte=l,n}}else if(a==240){n.type="sysEx";var u=e.readVarInt();return n.data=e.readBytes(u),n}else if(a==247){n.type="endSysEx";var u=e.readVarInt();return n.data=e.readBytes(u),n}else throw"Unrecognised MIDI event type byte: "+a;else{var f;if((a&128)===0){if(r===null)throw"Running status byte encountered before status byte";f=a,a=r,n.running=!0}else f=e.readUInt8(),r=a;var p=a>>4;switch(n.channel=a&15,p){case 8:return n.type="noteOff",n.noteNumber=f,n.velocity=e.readUInt8(),n;case 9:var y=e.readUInt8();return n.type=y===0?"noteOff":"noteOn",n.noteNumber=f,n.velocity=y,y===0&&(n.byte9=!0),n;case 10:return n.type="noteAftertouch",n.noteNumber=f,n.amount=e.readUInt8(),n;case 11:return n.type="controller",n.controllerType=f,n.value=e.readUInt8(),n;case 12:return n.type="programChange",n.programNumber=f,n;case 13:return n.type="channelAftertouch",n.amount=f,n;case 14:return n.type="pitchBend",n.value=f+(e.readUInt8()<<7)-8192,n;default:throw"Unrecognised MIDI event type: "+p}}}}function x(c){this.buffer=c,this.bufferLen=this.buffer.length,this.pos=0}x.prototype.eof=function(){return this.pos>=this.bufferLen};x.prototype.readUInt8=function(){var c=this.buffer[this.pos];return this.pos+=1,c};x.prototype.readInt8=function(){var c=this.readUInt8();return c&128?c-256:c};x.prototype.readUInt16=function(){var c=this.readUInt8(),e=this.readUInt8();return(c<<8)+e};x.prototype.readInt16=function(){var c=this.readUInt16();return c&32768?c-65536:c};x.prototype.readUInt24=function(){var c=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(c<<16)+(e<<8)+t};x.prototype.readInt24=function(){var c=this.readUInt24();return c&8388608?c-16777216:c};x.prototype.readUInt32=function(){var c=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),s=this.readUInt8();return(c<<24)+(e<<16)+(t<<8)+s};x.prototype.readBytes=function(c){var e=this.buffer.slice(this.pos,this.pos+c);return this.pos+=c,e};x.prototype.readString=function(c){var e=this.readBytes(c);return String.fromCharCode.apply(null,e)};x.prototype.readVarInt=function(){for(var c=0;!this.eof();){var e=this.readUInt8();if(e&128)c+=e&127,c<<=7;else return c+e}return c};x.prototype.readChunk=function(){var c=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:c,length:e,data:t}};ge.exports=We});var Pe=oe((Et,Se)=>{function Qe(c,e){if(typeof c!="object")throw"Invalid MIDI data";e=e||{};var t=c.header||{},s=c.tracks||[],r,o=s.length,n=new g;for(Ze(n,t,o),r=0;r<o;r++)_e(n,s[r],e);return n.buffer}function Ze(c,e,t){var s=e.format==null?1:e.format,r=128;e.timeDivision?r=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?r=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(r=e.ticksPerBeat&32767);var o=new g;o.writeUInt16(s),o.writeUInt16(t),o.writeUInt16(r),c.writeChunk("MThd",o.buffer)}function _e(c,e,t){var s=new g,r,o=e.length,n=null;for(r=0;r<o;r++)(t.running===!1||!t.running&&!e[r].running)&&(n=null),n=Je(s,e[r],n,t.useByte9ForNoteOff);c.writeChunk("MTrk",s.buffer)}function Je(c,e,t,s){var r=e.type,o=e.deltaTime,n=e.text||"",a=e.data||[],l=null;switch(c.writeVarInt(o),r){case"sequenceNumber":c.writeUInt8(255),c.writeUInt8(0),c.writeVarInt(2),c.writeUInt16(e.number);break;case"text":c.writeUInt8(255),c.writeUInt8(1),c.writeVarInt(n.length),c.writeString(n);break;case"copyrightNotice":c.writeUInt8(255),c.writeUInt8(2),c.writeVarInt(n.length),c.writeString(n);break;case"trackName":c.writeUInt8(255),c.writeUInt8(3),c.writeVarInt(n.length),c.writeString(n);break;case"instrumentName":c.writeUInt8(255),c.writeUInt8(4),c.writeVarInt(n.length),c.writeString(n);break;case"lyrics":c.writeUInt8(255),c.writeUInt8(5),c.writeVarInt(n.length),c.writeString(n);break;case"marker":c.writeUInt8(255),c.writeUInt8(6),c.writeVarInt(n.length),c.writeString(n);break;case"cuePoint":c.writeUInt8(255),c.writeUInt8(7),c.writeVarInt(n.length),c.writeString(n);break;case"channelPrefix":c.writeUInt8(255),c.writeUInt8(32),c.writeVarInt(1),c.writeUInt8(e.channel);break;case"portPrefix":c.writeUInt8(255),c.writeUInt8(33),c.writeVarInt(1),c.writeUInt8(e.port);break;case"endOfTrack":c.writeUInt8(255),c.writeUInt8(47),c.writeVarInt(0);break;case"setTempo":c.writeUInt8(255),c.writeUInt8(81),c.writeVarInt(3),c.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":c.writeUInt8(255),c.writeUInt8(84),c.writeVarInt(5);var u={24:0,25:32,29:64,30:96},h=e.hour&31|u[e.frameRate];c.writeUInt8(h),c.writeUInt8(e.min),c.writeUInt8(e.sec),c.writeUInt8(e.frame),c.writeUInt8(e.subFrame);break;case"timeSignature":c.writeUInt8(255),c.writeUInt8(88),c.writeVarInt(4),c.writeUInt8(e.numerator);var d=Math.floor(Math.log(e.denominator)/Math.LN2)&255;c.writeUInt8(d),c.writeUInt8(e.metronome),c.writeUInt8(e.thirtyseconds||8);break;case"keySignature":c.writeUInt8(255),c.writeUInt8(89),c.writeVarInt(2),c.writeInt8(e.key),c.writeUInt8(e.scale);break;case"sequencerSpecific":c.writeUInt8(255),c.writeUInt8(127),c.writeVarInt(a.length),c.writeBytes(a);break;case"unknownMeta":e.metatypeByte!=null&&(c.writeUInt8(255),c.writeUInt8(e.metatypeByte),c.writeVarInt(a.length),c.writeBytes(a));break;case"sysEx":c.writeUInt8(240),c.writeVarInt(a.length),c.writeBytes(a);break;case"endSysEx":c.writeUInt8(247),c.writeVarInt(a.length),c.writeBytes(a);break;case"noteOff":var f=s!==!1&&e.byte9||s&&e.velocity==0?144:128;l=f|e.channel,l!==t&&c.writeUInt8(l),c.writeUInt8(e.noteNumber),c.writeUInt8(e.velocity);break;case"noteOn":l=144|e.channel,l!==t&&c.writeUInt8(l),c.writeUInt8(e.noteNumber),c.writeUInt8(e.velocity);break;case"noteAftertouch":l=160|e.channel,l!==t&&c.writeUInt8(l),c.writeUInt8(e.noteNumber),c.writeUInt8(e.amount);break;case"controller":l=176|e.channel,l!==t&&c.writeUInt8(l),c.writeUInt8(e.controllerType),c.writeUInt8(e.value);break;case"programChange":l=192|e.channel,l!==t&&c.writeUInt8(l),c.writeUInt8(e.programNumber);break;case"channelAftertouch":l=208|e.channel,l!==t&&c.writeUInt8(l),c.writeUInt8(e.amount);break;case"pitchBend":l=224|e.channel,l!==t&&c.writeUInt8(l);var p=8192+e.value,y=p&127,M=p>>7&127;c.writeUInt8(y),c.writeUInt8(M);break;default:throw"Unrecognized event type: "+r}return l}function g(){this.buffer=[]}g.prototype.writeUInt8=function(c){this.buffer.push(c&255)};g.prototype.writeInt8=g.prototype.writeUInt8;g.prototype.writeUInt16=function(c){var e=c>>8&255,t=c&255;this.writeUInt8(e),this.writeUInt8(t)};g.prototype.writeInt16=g.prototype.writeUInt16;g.prototype.writeUInt24=function(c){var e=c>>16&255,t=c>>8&255,s=c&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(s)};g.prototype.writeInt24=g.prototype.writeUInt24;g.prototype.writeUInt32=function(c){var e=c>>24&255,t=c>>16&255,s=c>>8&255,r=c&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(s),this.writeUInt8(r)};g.prototype.writeInt32=g.prototype.writeUInt32;g.prototype.writeBytes=function(c){this.buffer=this.buffer.concat(Array.prototype.slice.call(c,0))};g.prototype.writeString=function(c){var e,t=c.length,s=[];for(e=0;e<t;e++)s.push(c.codePointAt(e));this.writeBytes(s)};g.prototype.writeVarInt=function(c){if(c<0)throw"Cannot write negative variable-length integer";if(c<=127)this.writeUInt8(c);else{var e=c,t=[];for(t.push(e&127),e>>=7;e;){var s=e&127|128;t.push(s),e>>=7}this.writeBytes(t.reverse())}};g.prototype.writeChunk=function(c,e){this.writeString(c),this.writeUInt32(e.length),this.writeBytes(e)};Se.exports=Qe});var we=oe(ae=>{ae.parseMidi=ve();ae.writeMidi=Pe()});var Le=qe(we());var V=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,s=t+e,r=this.data,o=r.subarray(t,s).indexOf(0);o<0&&(o=e);let n=new Array(o);for(let a=0;a<o;a++)n[a]=r[t+a];return this.offset=s,String.fromCharCode(...n)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function ce(c,e,t){let s=new V(c,e),r=s.readString(4),o=s.readDWORD(t);return new ie(r,o,s.offset)}function le(c,e=0,t,{padding:s=!0,bigEndian:r=!1}={}){let o=[],n=t+e,a=e;for(;a<n;){let l=ce(c,a,r);a=l.offset+l.size,s&&(a-e&1)===1&&a++,o.push(l)}return o}var ie=class{constructor(e,t,s){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:s})}};var k=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var b=class c{constructor(e,t,s,r,o){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:o})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,s=e&127,r=e>>7&1,o=e>>8&1,n=e>>9&1;return new c(t,n,o,r,s)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var ue=class c{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),s=e.readInt8();return new c(t,s)}},H=class c{constructor(e,t,s,r,o,n,a,l,u,h,d){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:h}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:d})}static parse(e,t){function s(T){for(let v=0;v<t.length;v++)if(t[v].type===T)return t[v]}function r(T){return new V(e,T.offset)}function o(T){let v=s(T);return v?r(v).readString(v.size):null}function n(T){let v=s(T);return v?ue.parse(r(v)):null}let a=o("ICMT"),l=o("ICOP"),u=o("ICRD"),h=o("IENG"),d=o("INAM"),f=o("IPRD"),p=o("ISFT"),y=n("ifil"),M=o("isng"),E=o("irom"),C=n("iver");return new c(a,l,u,h,d,f,p,y,M,E,C)}},R=class c{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),s=e.readWORD();return new c(t,s)}},q=class c{constructor(e,t,s,r,o,n,a){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:a})}get isEnd(){let{presetName:e,preset:t,bank:s,library:r,genre:o,morphology:n}=this;return e==="EOP"||e===""&&t+s+r+o+n===0}static parse(e){let t=e.readString(20),s=e.readWORD(),r=e.readWORD(),o=e.readWORD(),n=e.readDWORD(),a=e.readDWORD(),l=e.readDWORD();return new c(t,s,r,o,n,a,l)}},I=class c{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),s=e.readByte();return new c(t,s)}},P=class c{constructor(e,t,s,r,o){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"amount",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:o})}transform(e){let t=this.amount*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),s=e.readWORD(),r=e.readInt16(),o=e.readWORD(),n=e.readWORD(),a=b.parse(t),l=b.parse(o);return new c(a,s,r,l,n)}},L=class c{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return k[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),s=k[t],r;switch(s){case"keyRange":case"velRange":r=I.parse(e);break;case"instrument":case"sampleID":r=e.readUInt16();break;default:r=e.readInt16();break}return new c(t,r)}},W=class c{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new c;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},$=class c{constructor(e,t,s,r,o,n,a,l,u,h){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:h})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let s=e.readString(20),r=e.readDWORD(),o=e.readDWORD(),n=e.readDWORD(),a=e.readDWORD(),l=e.readDWORD(),u=e.readByte(),h=e.readInt8(),d=e.readWORD(),f=e.readWORD();return t||(n-=r,a-=r),new c(s,r,o,n,a,l,u,h,d,f)}};var m=class{constructor(e,t,s){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=s}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};var Xe=["pcm16","pcm24","compressed"],Ye=new Set(Xe),z=class{constructor(e,t,s){if(Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Ye.has(e))throw new Error(`Invalid AudioDataType: ${e}`);this.type=e,this.sampleHeader=t,this.data=s}decodePCM(e){let{type:t}=this;if(t==="pcm16"){let r=e.byteLength/2,o=new Float32Array(r),n=new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);for(let a=0;a<r;a++)o[a]=n[a]/32768;return o}else{let r=e.byteLength/3,o=new Float32Array(r);for(let n=0;n<r;n++){let a=n*3,l=e[a]|e[a+1]<<8|e[a+2]<<16;l&8388608&&(l|=4278190080),o[n]=l/8388608}return o}}async toAudioBuffer(e,t,s){if(this.type==="compressed"){let r=this.data.slice().buffer;return await e.decodeAudioData(r)}else{let r=this.data.subarray(t,s),o=this.decodePCM(r),n=new AudioBuffer({numberOfChannels:1,length:o.length,sampleRate:this.sampleHeader.sampleRate});return n.getChannelData(0).set(o),n}}};function he(c,e={}){let t=le(c,0,c.length,e);if(t.length!==1)throw new Error("wrong chunk length");let s=t[0];if(s===null)throw new Error("chunk not found");function r(l,u,h={}){let d=Q(l,u,"RIFF","sfbk",h);if(d.length!==3)throw new Error("invalid sfbk structure");let f=et(d[0],u),p=f.version.major===3;return p&&d[2].type!=="LIST"&&(d[2]=ce(u,d[2].offset-9,!1)),{info:f,samplingData:tt(d[1],u),...o(d[2],u,p)}}function o(l,u,h){let d=Q(l,u,"LIST","pdta");if(d.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:st(d[0],u),presetZone:rt(d[1],u),presetModulators:at(d[2],u),presetGenerators:ct(d[3],u),instruments:nt(d[4],u),instrumentZone:ot(d[5],u),instrumentModulators:it(d[6],u),instrumentGenerators:lt(d[7],u),sampleHeaders:ut(d[8],u,h)}}let n=r(s,c,e),a=n.info.version.major===3;return{...n,samples:ht(n.sampleHeaders,n.samplingData.offsetMSB,n.samplingData.offsetLSB,c,a)}}function Q(c,e,t,s,r={}){if(c.type!==t)throw new Error("invalid chunk type:"+c.type);let o=new V(e,c.offset),n=o.readString(4);if(n!==s)throw new Error("invalid signature:"+n);return le(e,o.offset,c.size-4,r)}function et(c,e){let t=Q(c,e,"LIST","INFO");return H.parse(e,t)}function tt(c,e){let t=Q(c,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function O(c,e,t,s,r,o){let n=[];if(c.type!==t)throw new Error("invalid chunk type:"+c.type);let a=new V(e,c.offset),l=c.offset+c.size;for(;a.offset<l;){let u=s.parse(a,o);if(r&&r(u))break;n.push(u)}return n}var st=(c,e)=>O(c,e,"phdr",q,t=>t.isEnd),rt=(c,e)=>O(c,e,"pbag",R),nt=(c,e)=>O(c,e,"inst",W,t=>t.isEnd),ot=(c,e)=>O(c,e,"ibag",R),at=(c,e)=>O(c,e,"pmod",P),it=(c,e)=>O(c,e,"imod",P),ct=(c,e)=>O(c,e,"pgen",L,t=>t.isEnd),lt=(c,e)=>O(c,e,"igen",L),ut=(c,e,t)=>O(c,e,"shdr",$,s=>s.isEnd,t);function ht(c,e,t,s,r){let o=new Array(c.length),n=r?1:2,a=r?"compressed":t?"pcm24":"pcm16";for(let l=0;l<c.length;l++){let{start:u,end:h}=c[l],d=e+u*n,f=e+h*n,p=s.subarray(d,f);o[l]=new z(a,c[l],p)}return o}var Ee=new Map;for(let c=0;c<k.length;c++)Ee.set(k[c],c);var dt=["instrument","sampleID"],De=["keyRange","velRange"],Fe=["keynum","velocity"],ke=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],xe=[...ke,...Fe],Ve=new Set;for(let c=0;c<xe.length;c++){let e=xe[c],t=Ee.get(e);t!==void 0&&Ve.add(t)}function Ce(c){let e={},t=Object.keys(c);for(let s of t){let r=c[s];if(A(s))e[s]=r;else{let o=r;e[s]=o.clamp(o.defaultValue)}}return e}var Te=[["keynum","keyRange"],["velocity","velRange"]],ft=new Set(De);function A(c){return ft.has(c)}var pt=new Set([...dt,...De,...Fe,...ke]);function mt(){let c=[],e=k.length;for(let t=0;t<e;t++){let s=k[t];s!==void 0&&!pt.has(s)&&c.push(s)}return c}var _=mt(),yt=new Set(_);function de(c){return yt.has(c)}function Oe(c){let e={};for(let t=0;t<c.length;t++){let s=c[t],r=s.type;if(r!==void 0&&!Ve.has(s.code))if(A(r))e[r]=s.value;else{let o=r;e[o]=s.value}}return e}function Ie(c){let e={};for(let t=0;t<c.length;t++){let s=c[t],r=s.type;if(r!==void 0)if(A(r))e[r]=s.value;else{let o=r;e[o]=s.value}}for(let t=0;t<Te.length;t++){let[s,r]=Te[t],o=e[s];o!==void 0&&(e[r]=new I(o,o))}return e}var B=-32768,N=32767,Me=0,Z=65535,J={startAddrsOffset:new m(0,0,N),endAddrsOffset:new m(B,0,0),startloopAddrsOffset:new m(B,0,N),endloopAddrsOffset:new m(B,0,N),startAddrsCoarseOffset:new m(0,0,N),modLfoToPitch:new m(-12e3,0,12e3),vibLfoToPitch:new m(-12e3,0,12e3),modEnvToPitch:new m(-12e3,0,12e3),initialFilterFc:new m(1500,13500,13500),initialFilterQ:new m(0,0,960),modLfoToFilterFc:new m(-12e3,0,12e3),modEnvToFilterFc:new m(-12e3,0,12e3),endAddrsCoarseOffset:new m(B,0,0),modLfoToVolume:new m(-960,0,960),chorusEffectsSend:new m(0,0,1e3),reverbEffectsSend:new m(0,0,1e3),pan:new m(-500,0,500),delayModLFO:new m(-12e3,-12e3,5e3),freqModLFO:new m(-16e3,0,4500),delayVibLFO:new m(-12e3,-12e3,5e3),freqVibLFO:new m(-16e3,0,4500),delayModEnv:new m(-12e3,-12e3,5e3),attackModEnv:new m(-12e3,-12e3,8e3),holdModEnv:new m(-12e3,-12e3,5e3),decayModEnv:new m(-12e3,-12e3,8e3),sustainModEnv:new m(0,0,1e3),releaseModEnv:new m(-12e3,-12e3,8e3),keynumToModEnvHold:new m(-1200,0,1200),keynumToModEnvDecay:new m(-1200,0,1200),delayVolEnv:new m(-12e3,-12e3,5e3),attackVolEnv:new m(-12e3,-12e3,8e3),holdVolEnv:new m(-12e3,-12e3,5e3),decayVolEnv:new m(-12e3,-12e3,8e3),sustainVolEnv:new m(0,0,1440),releaseVolEnv:new m(-12e3,-12e3,8e3),keynumToVolEnvHold:new m(-1200,0,1200),keynumToVolEnvDecay:new m(-1200,0,1200),instrument:new m(Me,Z,Z),keyRange:new I(0,127),velRange:new I(0,127),startloopAddrsCoarseOffset:new m(B,0,N),keynum:new m(-1,-1,127),velocity:new m(-1,-1,127),initialAttenuation:new m(0,0,1440),endloopAddrsCoarseOffset:new m(B,0,N),coarseTune:new m(-120,0,120),fineTune:new m(-99,0,99),sampleID:new m(Me,Z,Z),sampleModes:new m(0,0,3),scaleTuning:new m(0,100,100),exclusiveClass:new m(0,0,127),overridingRootKey:new m(-1,-1,127)};function F(c){return Math.pow(2,c/1200)}var X=class{constructor(e,t,s,r,o){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(n,a)=>{n.modLfoToPitch=this.clamp("modLfoToPitch",a)},vibLfoToPitch:(n,a)=>{n.vibLfoToPitch=this.clamp("vibLfoToPitch",a)},modEnvToPitch:(n,a)=>{n.modEnvToPitch=this.clamp("modEnvToPitch",a)},initialFilterFc:(n,a)=>{n.initialFilterFc=this.clamp("initialFilterFc",a)},initialFilterQ:(n,a)=>{n.initialFilterQ=this.clamp("initialFilterQ",a)},modLfoToFilterFc:(n,a)=>{n.modLfoToFilterFc=this.clamp("modLfoToFilterFc",a)},modEnvToFilterFc:(n,a)=>{n.modEnvToFilterFc=this.clamp("modEnvToFilterFc",a)},modLfoToVolume:(n,a)=>{n.modLfoToVolume=this.clamp("modLfoToVolume",a)},chorusEffectsSend:(n,a)=>{n.chorusEffectsSend=this.clamp("chorusEffectsSend",a)/1e3},reverbEffectsSend:(n,a)=>{n.reverbEffectsSend=this.clamp("reverbEffectsSend",a)/1e3},pan:(n,a)=>{n.pan=this.clamp("pan",a)/1e3},delayModLFO:(n,a)=>{n.delayModLFO=F(this.clamp("delayModLFO",a))},freqModLFO:(n,a)=>{n.freqModLFO=this.clamp("freqModLFO",a)},delayVibLFO:(n,a)=>{n.delayVibLFO=F(this.clamp("delayVibLFO",a))},freqVibLFO:(n,a)=>{n.freqVibLFO=this.clamp("freqVibLFO",a)},delayModEnv:(n,a)=>{n.modDelay=F(this.clamp("delayModEnv",a))},attackModEnv:(n,a)=>{n.modAttack=F(this.clamp("attackModEnv",a))},holdModEnv:(n,a)=>{let l=this.clamp("holdModEnv",a),u=this.clamp("keynumToModEnvHold",a);n.modHold=this.getModHold(l,u)},decayModEnv:(n,a)=>{let l=this.clamp("decayModEnv",a),u=this.clamp("keynumToModEnvDecay",a);n.modDecay=this.getModDecay(l,u)},sustainModEnv:(n,a)=>{n.modSustain=this.clamp("sustainModEnv",a)/1e3},releaseModEnv:(n,a)=>{n.modRelease=F(this.clamp("releaseModEnv",a))},keynumToModEnvHold:(n,a)=>{let l=this.clamp("holdModEnv",a),u=this.clamp("keynumToModEnvHold",a);n.modHold=this.getModHold(l,u)},keynumToModEnvDecay:(n,a)=>{let l=this.clamp("decayModEnv",a),u=this.clamp("keynumToModEnvDecay",a);n.modDecay=this.getModDecay(l,u)},delayVolEnv:(n,a)=>{n.volDelay=F(this.clamp("delayVolEnv",a))},attackVolEnv:(n,a)=>{n.volAttack=F(this.clamp("attackVolEnv",a))},holdVolEnv:(n,a)=>{let l=this.clamp("holdVolEnv",a),u=this.clamp("keynumToVolEnvHold",a);n.volHold=this.getVolHold(l,u)},decayVolEnv:(n,a)=>{let l=this.clamp("decayVolEnv",a),u=this.clamp("keynumToVolEnvDecay",a);n.volDecay=this.getVolDecay(l,u)},sustainVolEnv:(n,a)=>{n.volSustain=this.clamp("sustainVolEnv",a)/1e3},releaseVolEnv:(n,a)=>{n.volRelease=F(this.clamp("releaseVolEnv",a))},keynumToVolEnvHold:(n,a)=>{let l=this.clamp("holdVolEnv",a),u=this.clamp("keynumToVolEnvHold",a);n.modHold=this.getVolHold(l,u)},keynumToVolEnvDecay:(n,a)=>{let l=this.clamp("decayVolEnv",a),u=this.clamp("keynumToVolEnvDecay",a);n.modDecay=this.getVolDecay(l,u)},initialAttenuation:(n,a)=>{n.initialAttenuation=this.clamp("initialAttenuation",a)},coarseTune:(n,a)=>{n.detune=this.getDetune(a)},fineTune:(n,a)=>{n.detune=this.getDetune(a)},scaleTuning:(n,a)=>{n.playbackRate=this.getPlaybackRate(a)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],s=t.sourceOper.controllerType,r=t.destinationOper,o=this.controllerToDestinations.get(s);o?o.add(t.destinationOper):this.controllerToDestinations.set(s,new Set([r]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],s=t.destinationOper,r=this.destinationToModulators.get(s);r?r.push(t):this.destinationToModulators.set(s,[t])}}getModHold(e,t){return F(e+(this.key-60)*t)}getModDecay(e,t){return F(e+(this.key-60)*t)}getVolHold(e,t){return F(e+(this.key-60)*t)}getVolDecay(e,t){return F(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("overridingRootKey",e),s=this.clamp("scaleTuning",e),r=t===-1?this.sampleHeader.originalPitch:t;return Math.pow(2,(this.key-r)*s/1200)}getDetune(e){let t=this.clamp("coarseTune",e)*100,s=this.clamp("fineTune",e),r=this.sampleHeader.pitchCorrection;return t+s+r}transformParams(e,t){let s={},r=this.controllerToDestinations.get(e);if(!r)return s;for(let o of r){let n=k[o];if(!n||!de(n))continue;let a=this.destinationToModulators.get(o);if(a){s[n]=this.generators[n];for(let l of a){let u=l.sourceOper,h=u.map(t[u.controllerType]),d=1,f=l.amountSourceOper;if(!(f.cc===0&&f.index===0)){let y=t[f.controllerType];d=f.map(y)}let p=l.transform(h*d);Number.isNaN(p)||(s[n]+=p)}}}return s}transformAllParams(e){let t=structuredClone(this.generators);for(let s of this.modulators){let r=s.sourceOper.controllerType,o=e[r];if(!o)continue;let n=k[s.destinationOper];if(!n||!de(n))continue;let l=s.sourceOper.map(o),u=1,h=s.amountSourceOper;if(!(h.cc===0&&h.index===0)){let f=e[h.controllerType];u=h.map(f)}let d=s.transform(l*u);Number.isNaN(d)||(t[n]+=d)}return t}clamp(e,t){return J[e].clamp(t[e])}getParams(e,t){let s={},r=structuredClone(this.generators),o=this.transformParams(e,t),n=Object.keys(o);for(let a of n)r[a]=o[a];for(let a of n)this.voiceHandlers[a](s,r);return s}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,instrument:this.generators.instrument,sampleID:this.generators.sampleID,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},s=this.transformAllParams(e);for(let r=0;r<_.length;r++){let o=_[r];this.voiceHandlers[o](t,s)}return t}};var Be=[new P(b.parse(1282),48,960,b.parse(0),0),new P(b.parse(258),8,-2400,b.parse(0),0),new P(b.parse(13),6,50,b.parse(0),0),new P(b.parse(129),6,50,b.parse(0),0),new P(b.parse(1415),48,960,b.parse(0),0),new P(b.parse(650),48,1,b.parse(0),0),new P(b.parse(1419),48,960,b.parse(0),0),new P(b.parse(219),16,.2,b.parse(0),0),new P(b.parse(221),15,.2,b.parse(0),0),new P(b.parse(526),51,127,b.parse(16),0)];var Y=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},ee=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},U=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,s,r){let o=new Array(r-s);for(let n=s;n<r;n++){let a=t[n].generatorIndex,l=t[n+1].generatorIndex;o[n-s]=e.slice(a,l)}return o}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],s=this.parsed.presetHeaders[e+1],r=s?s.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,r)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],s=this.parsed.instruments[e+1],r=s?s.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,r)}getModulators(e,t,s,r){let o=new Array(r-s);for(let n=s;n<r;n++){let a=t[n].modulatorIndex,l=t[n+1].modulatorIndex;o[n-s]=e.slice(a,l)}return o}getPresetModulators(e){let t=this.parsed.presetHeaders[e],s=this.parsed.presetHeaders[e+1],r=s?s.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,r)}getInstrumentModulators(e){let t=this.parsed.instruments[e],s=this.parsed.instruments[e+1],r=s?s.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,r)}findInstrumentZone(e,t,s){let r=this.getInstrumentGenerators(e),o=this.getInstrumentModulators(e),n,a=[];for(let l=0;l<r.length;l++){let u=Ie(r[l]);if(u.sampleID===void 0){n=u,a=o[l];continue}if(!(u.keyRange&&!u.keyRange.in(t))&&!(u.velRange&&!u.velRange.in(s)))if(n){let h={...n,...u},d=[...a,...o[l]];return new Y(h,d)}else return new Y(u,o[l])}}findInstrument(e,t,s){let r=this.getPresetGenerators(e),o=this.getPresetModulators(e),n,a=[];for(let l=0;l<r.length;l++){let u=Oe(r[l]);if(u.instrument===void 0){n=u,a=o[l];continue}if(u.keyRange&&!u.keyRange.in(t)||u.velRange&&!u.velRange.in(s))continue;let h=this.findInstrumentZone(u.instrument,t,s);if(h)if(n){let d={...n,...u},f=[...a,...o[l]],p=new ee(d,f);return this.createVoice(t,p,h)}else{let d=new ee(u,o[l]);return this.createVoice(t,d,h)}}return null}createVoice(e,t,s){let r=Ce(J);Object.assign(r,s.generators);let o=Object.keys(t.generators);for(let h=0;h<o.length;h++){let d=o[h];A(d)||(r[d]+=t.generators[d])}let n=[...Be,...t.modulators,...s.modulators],a=r.sampleID,l=this.parsed.samples[a],u=this.parsed.sampleHeaders[a];return new X(e,r,n,l,u)}getVoice(e,t,s,r){let o=this.parsed.presetHeaders.findIndex(a=>a.preset===t&&a.bank===e);if(o<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let n=this.findInstrument(o,s,r);return n||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let s=0;s<t.length;s++){let r=t[s];e[r.bank]||(e[r.bank]={}),e[r.bank][r.preset]=r.presetName}return e}};var pe=class{voice;voiceParams;adjustedBaseFreq=2e4;index=-1;ending=!1;bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;modulationLFO;modulationDepth;vibratoLFO;vibratoDepth;reverbSend;chorusSend;portamentoNoteNumber=-1;pressure=0;constructor(e,t,s){this.noteNumber=e,this.velocity=t,this.startTime=s,this.ready=new Promise(r=>{this.resolveReady=r})}},j=new Array(57),bt=10,w=new Uint8Array(128);w[42]=1;w[44]=1;w[46]=1;w[71]=2;w[72]=2;w[73]=3;w[74]=3;w[78]=4;w[79]=4;w[80]=5;w[81]=5;w[29]=6;w[30]=6;w[86]=7;w[87]=7;j[0]=w;var re=new Uint8Array(128);re[42]=8;re[44]=8;re[46]=8;j[25]=re;var ne=new Uint8Array(128);ne[27]=9;ne[28]=9;ne[29]=9;j[48]=ne;var ye=new Uint8Array(128);ye[41]=10;ye[42]=10;j[56]=ye;var se={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},polyphonicKeyPressure:{type:10,defaultValue:0},channelPressure:{type:13,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepthMSB:{type:129,defaultValue:0},portamentoTimeMSB:{type:133,defaultValue:0},volumeMSB:{type:135,defaultValue:100/127},panMSB:{type:138,defaultValue:64/127},expressionMSB:{type:139,defaultValue:1},modulationDepthLSB:{type:161,defaultValue:0},portamentoTimeLSB:{type:165,defaultValue:0},volumeLSB:{type:167,defaultValue:0},panLSB:{type:170,defaultValue:0},expressionLSB:{type:171,defaultValue:0},sustainPedal:{type:192,defaultValue:0},portamento:{type:193,defaultValue:0},sostenutoPedal:{type:194,defaultValue:0},softPedal:{type:195,defaultValue:0},filterResonance:{type:199,defaultValue:64/127},releaseTime:{type:200,defaultValue:64/127},attackTime:{type:201,defaultValue:64/127},brightness:{type:202,defaultValue:64/127},decayTime:{type:203,defaultValue:64/127},vibratoRate:{type:204,defaultValue:64/127},vibratoDepth:{type:205,defaultValue:64/127},vibratoDelay:{type:206,defaultValue:64/127},portamentoNoteNumber:{type:212,defaultValue:0},reverbSendLevel:{type:219,defaultValue:0},chorusSendLevel:{type:221,defaultValue:0}},me=class{array=new Float32Array(256);constructor(){let e=Object.entries(se);for(let[t,{type:s,defaultValue:r}]of e)this.array[s]=r,Object.defineProperty(this,t,{get:()=>this.array[s],set:o=>this.array[s]=o,enumerable:!0,configurable:!0})}},gt=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],vt=new Set(gt),St=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain"],Pt=new Set(St),wt=["modEnvToPitch","modDelay","modAttack","modHold","modDecay","modSustain","playbackRate"],xt=new Set(wt),te=new Int8Array([64,64,64,0,0,0]);function G(c){return Math.pow(10,c/200)}var fe=1/-Math.log(G(-1e3)),Ne=1/-Math.log(G(-600)),Re=class extends EventTarget{perceptualSmoothingTime=.004;mode="GM2";masterFineTuning=0;masterCoarseTuning=0;reverb={algorithm:"SchroederReverb",time:this.getReverbTime(64),feedback:.8};chorus={modRate:this.getChorusModRate(3),modDepth:this.getChorusModDepth(19),feedback:this.getChorusFeedback(8),sendToReverb:this.getChorusSendToReverb(0),delayTimes:this.generateDistributedArray(.02,2,.5)};numChannels=16;ticksPerBeat=120;totalTime=0;lastActiveSensing=0;activeSensingThreshold=.3;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=Array.from({length:128},()=>[]);voiceCounter=new Map;voiceCache=new Map;realtimeVoiceCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;totalTimeEventTypes=new Set(["noteOff"]);tempo=1;loop=!1;loopStart=0;playPromise;timeline=[];notePromises=[];instruments=new Set;exclusiveClassNotes=new Array(128);drumExclusiveClassNotes=new Array(this.numChannels*bt);mpeEnabled=!1;lowerMPEMembers=0;upperMPEMembers=0;mpeState={channelToNotes:new Map,noteToChannel:new Map};static channelSettings={scheduleIndex:0,detune:0,programNumber:0,bankMSB:121,bankLSB:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,mono:!1,modulationDepthRange:50,fineTuning:0,coarseTuning:0,portamentoControl:!1,isMPEMember:!1,isMPEManager:!1};constructor(e){super(),this.audioContext=e,this.masterVolume=new GainNode(e),this.scheduler=new GainNode(e,{gain:0}),this.schedulerBuffer=new AudioBuffer({length:1,sampleRate:e.sampleRate}),this.messageHandlers=this.createMessageHandlers(),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.keyBasedControllerHandlers=this.createKeyBasedControllerHandlers(),this.channels=this.createChannels(e),this.reverbEffect=this.createReverbEffect(e),this.chorusEffect=this.createChorusEffect(e),this.chorusEffect.output.connect(this.masterVolume),this.reverbEffect.output.connect(this.masterVolume),this.masterVolume.connect(e.destination),this.scheduler.connect(e.destination),this.GM2SystemOn()}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let s=e.parsed.presetHeaders,r=this.soundFontTable;for(let o=0;o<s.length;o++){let{preset:n,bank:a}=s[o];r[n][a]=t}}async toUint8Array(e){let t;if(typeof e=="string"){let r=await(await fetch(e)).arrayBuffer();t=new Uint8Array(r)}else if(e instanceof Uint8Array)t=e;else throw new TypeError("input must be a URL string or Uint8Array");return t}async loadSoundFont(e){if(this.voiceCounter.clear(),Array.isArray(e)){let t=new Array(e.length);for(let r=0;r<e.length;r++)t[r]=this.toUint8Array(e[r]);let s=await Promise.all(t);for(let r=0;r<s.length;r++){let o=he(s[r]),n=new U(o);this.addSoundFont(n)}}else{let t=await this.toUint8Array(e),s=he(t),r=new U(s);this.addSoundFont(r)}}async loadMIDI(e){this.voiceCounter.clear();let t=await this.toUint8Array(e),s=(0,Le.parseMidi)(t);this.ticksPerBeat=s.header.ticksPerBeat;let r=this.extractMidiData(s);this.instruments=r.instruments,this.timeline=r.timeline,this.totalTime=this.calcTotalTime()}cacheVoiceIds(){let{channels:e,timeline:t,voiceCounter:s}=this;for(let r=0;r<t.length;r++){let o=t[r];switch(o.type){case"noteOn":{let n=this.getVoiceId(e[o.channel],o.noteNumber,o.velocity);s.set(n,(s.get(n)??0)+1);break}case"controller":o.controllerType===0?this.setBankMSB(o.channel,o.value):o.controllerType===32&&this.setBankLSB(o.channel,o.value);break;case"programChange":this.setProgramChange(o.channel,o.programNumber,o.startTime)}}for(let[r,o]of s)o===1&&s.delete(r);this.GM2SystemOn()}getVoiceId(e,t,s){let r=e.programNumber,o=this.soundFontTable[r];if(!o)return;let n=e.isDrum?128:e.bankLSB;if(o[n]===void 0){if(e.isDrum)return;n=0}let a=o[n];if(a===void 0)return;let u=this.soundFonts[a].getVoice(n,r,t,s),{instrument:h,sampleID:d}=u.generators;return a*2**32+(h<<16)+d}createChannelAudioNodes(e){let{gainLeft:t,gainRight:s}=this.panToGain(se.panMSB.defaultValue),r=new GainNode(e,{gain:t}),o=new GainNode(e,{gain:s}),n=new ChannelMergerNode(e,{numberOfInputs:2});return r.connect(n,0,0),o.connect(n,0,1),n.connect(this.masterVolume),{gainL:r,gainR:o,merger:n}}resetChannelTable(e){e.controlTable.fill(-1),e.scaleOctaveTuningTable.fill(0),e.channelPressureTable.set(te),e.polyphonicKeyPressureTable.set(te),e.keyBasedTable.fill(-1)}createChannels(e){return Array.from({length:this.numChannels},()=>({currentBufferSource:null,isDrum:!1,state:new me,...this.constructor.channelSettings,...this.createChannelAudioNodes(e),scheduledNotes:[],sustainNotes:[],sostenutoNotes:[],controlTable:this.initControlTable(),scaleOctaveTuningTable:new Float32Array(12),channelPressureTable:new Int8Array(te),polyphonicKeyPressureTable:new Int8Array(te),keyBasedTable:new Int8Array(16384).fill(-1),keyBasedGainLs:new Array(128),keyBasedGainRs:new Array(128)}))}async createAudioBuffer(e){let{sample:t,start:s,end:r}=e,o=t.data.length+r;return await t.toAudioBuffer(this.audioContext,s,o)}isLoopDrum(e,t){let s=e.programNumber;return s===48&&t===88||s===56&&47<=t&&t<=84}createBufferSource(e,t,s,r){let o=new AudioBufferSourceNode(this.audioContext);return o.buffer=r,o.loop=e.isDrum?this.isLoopDrum(e,t):s.sampleModes%2!==0,o.loop&&(o.loopStart=s.loopStart/s.sampleRate,o.loopEnd=s.loopEnd/s.sampleRate),o}scheduleTimelineEvents(e,t){let s=this.resumeTime-this.startTime,r=e+s+this.lookAhead,o=this.startDelay-s,n=this.timeline,a=1/this.tempo;for(;t<n.length;){let l=n[t],u=l.startTime*a;if(r<u)break;let h=u+o;switch(l.type){case"noteOn":this.noteOn(l.channel,l.noteNumber,l.velocity,h);break;case"noteOff":{this.noteOff(l.channel,l.noteNumber,l.velocity,h,!1);break}case"noteAftertouch":this.setPolyphonicKeyPressure(l.channel,l.noteNumber,l.amount,h);break;case"controller":this.setControlChange(l.channel,l.controllerType,l.value,h);break;case"programChange":this.setProgramChange(l.channel,l.programNumber,h);break;case"channelAftertouch":this.setChannelPressure(l.channel,l.amount,h);break;case"pitchBend":this.setPitchBend(l.channel,l.value+8192,h);break;case"sysEx":this.handleSysEx(l.data,h)}t++}return t}getQueueIndex(e){let t=this.timeline,s=1/this.tempo;for(let r=0;r<t.length;r++)if(e<=t[r].startTime*s)return r;return 0}resetAllStates(){this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.voiceCache.clear(),this.realtimeVoiceCache.clear();let e=this.channels;for(let t=0;t<e.length;t++)e[t].scheduledNotes=[],this.resetChannelStates(t)}updateStates(e,t){let{timeline:s,resumeTime:r}=this,o=1/this.tempo,n=this.audioContext.currentTime;t<e&&(e=0);for(let a=e;a<t;a++){let l=s[a];switch(l.type){case"controller":this.setControlChange(l.channel,l.controllerType,l.value,n-r+l.startTime*o);break;case"programChange":this.setProgramChange(l.channel,l.programNumber,n-r+l.startTime*o);break;case"pitchBend":this.setPitchBend(l.channel,l.value+8192,n-r+l.startTime*o);break;case"sysEx":this.handleSysEx(l.data,n-r+l.startTime*o)}}}async playNotes(){let e=this.audioContext;e.state==="suspended"&&await e.resume();let t=this.isPaused;this.isPlaying=!0,this.isPaused=!1,this.startTime=e.currentTime,t?this.dispatchEvent(new Event("resumed")):this.dispatchEvent(new Event("started"));let s=this.getQueueIndex(this.resumeTime),r;for(this.notePromises=[];;){let o=e.currentTime;if(0<this.lastActiveSensing&&this.activeSensingThreshold<performance.now()-this.lastActiveSensing){await this.stopNotes(0,!0,o),await e.suspend(),r="aborted";break}if(this.totalTime<this.currentTime()||this.timeline.length<=s)if(await this.stopNotes(0,!0,o),this.loop){if(this.resetAllStates(),this.startTime=e.currentTime,this.resumeTime=this.loopStart,0<this.loopStart){let a=this.getQueueIndex(this.resumeTime);this.updateStates(s,a),s=a}else s=0;this.dispatchEvent(new Event("looped"));continue}else{await e.suspend(),r="ended";break}if(this.isPausing){await this.stopNotes(0,!0,o),await e.suspend(),this.isPausing=!1,r="paused";break}else if(this.isStopping){await this.stopNotes(0,!0,o),await e.suspend(),this.isStopping=!1,r="stopped";break}else if(this.isSeeking){this.stopNotes(0,!0,o),this.startTime=e.currentTime;let a=this.getQueueIndex(this.resumeTime);this.updateStates(s,a),s=a,this.isSeeking=!1,this.dispatchEvent(new Event("seeked"));continue}s=this.scheduleTimelineEvents(o,s);let n=o+this.noteCheckInterval;await this.scheduleTask(()=>{},n)}r!=="paused"&&(this.resetAllStates(),this.lastActiveSensing=0),this.isPlaying=!1,r==="paused"?(this.isPaused=!0,this.dispatchEvent(new Event("paused"))):(this.isPaused=!1,this.dispatchEvent(new Event(r)))}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}getSoundFontId(e){let t=e.programNumber,r=(e.isDrum?128:e.bankLSB).toString().padStart(3,"0"),o=t.toString().padStart(3,"0");return`${r}:${o}`}extractMidiData(e){let t=new Set,s=[],r=this.channels;for(let u=0;u<e.tracks.length;u++){let h=e.tracks[u],d=0;for(let f=0;f<h.length;f++){let p=h[f];switch(d+=p.deltaTime,p.ticks=d,p.type){case"noteOn":{let y=r[p.channel];t.add(this.getSoundFontId(y));break}case"controller":switch(p.controllerType){case 0:this.setBankMSB(p.channel,p.value);break;case 32:this.setBankLSB(p.channel,p.value);break}break;case"programChange":{let y=r[p.channel];this.setProgramChange(p.channel,p.programNumber),t.add(this.getSoundFontId(y));break}case"sysEx":{let y=p.data;if(y[0]===126&&y[1]===9&&y[2]===3)switch(y[3]){case 1:this.GM1SystemOn(scheduleTime);break;case 2:break;case 3:this.GM2SystemOn(scheduleTime);break;default:console.warn(`Unsupported Exclusive Message: ${y}`)}}}delete p.deltaTime,s.push(p)}}let o={controller:0,sysEx:1,noteOff:2,noteOn:3};s.sort((u,h)=>u.ticks!==h.ticks?u.ticks-h.ticks:(o[u.type]||4)-(o[h.type]||4));let n=0,a=0,l=.5;for(let u=0;u<s.length;u++){let h=s[u],d=this.ticksToSecond(h.ticks-a,l);h.startTime=n+d,h.type==="setTempo"&&(n+=this.ticksToSecond(h.ticks-a,l),l=h.microsecondsPerBeat/1e6,a=h.ticks)}return{instruments:t,timeline:s}}stopActiveNotes(e,t,s,r){let o=this.channels[e],n=[];return this.processActiveNotes(o,r,a=>{let l=this.noteOff(e,a.noteNumber,t,r,s);this.notePromises.push(l),n.push(l)}),Promise.all(n)}stopChannelNotes(e,t,s,r){let o=this.channels[e],n=[];return this.processScheduledNotes(o,a=>{let l=this.noteOff(e,a.noteNumber,t,r,s);this.notePromises.push(l),n.push(l)}),Promise.all(n)}stopNotes(e,t,s){let r=this.channels;for(let n=0;n<r.length;n++)this.stopChannelNotes(n,e,t,s);let o=Promise.all(this.notePromises);return this.notePromises=[],o}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,this.voiceCounter.size===0&&this.cacheVoiceIds(),this.playPromise=this.playNotes(),await this.playPromise)}async stop(){this.isPlaying&&(this.isStopping=!0,await this.playPromise)}async pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime=e+this.resumeTime-this.startTime,this.isPausing=!0,await this.playPromise}async resume(){this.isPaused&&(this.playPromise=this.playNotes(),await this.playPromise)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}tempoChange(e){let t=this.tempo/e;this.resumeTime=this.resumeTime*t,this.tempo=e,this.totalTime=this.calcTotalTime(),this.seekTo(this.currentTime()*t)}calcTotalTime(){let e=this.totalTimeEventTypes,t=this.timeline,s=1/this.tempo,r=0;for(let o=0;o<t.length;o++){let n=t[o];if(!e.has(n.type))continue;let a=n.startTime*s;r<a&&(r=a)}return r+this.startDelay}currentTime(){return this.isPlaying?this.audioContext.currentTime+this.resumeTime-this.startTime:this.resumeTime}async processScheduledNotes(e,t){let s=e.scheduledNotes,r=[];for(let o=e.scheduleIndex;o<s.length;o++){let n=s[o];if(!n||n.ending)continue;let a=n.ready.then(()=>t(n));r.push(a)}await Promise.all(r)}async processActiveNotes(e,t,s){let r=e.scheduledNotes,o=[];for(let n=e.scheduleIndex;n<r.length;n++){let a=r[n];if(!a||a.ending)continue;if(t<a.startTime)break;let l=a.ready.then(()=>s(a));o.push(l)}await Promise.all(o)}applyToMPEChannels(e,t){if(t(e),!!this.channels[e].isMPEManager){if(e===0)for(let r=1;r<=this.lowerMPEMembers;r++)t(r);else if(e===15)for(let r=15-this.upperMPEMembers;r<=14;r++)t(r)}}createConvolutionReverbImpulse(e,t,s){let r=e.sampleRate,o=r*t,n=new AudioBuffer({numberOfChannels:2,length:o,sampleRate:r}),a=Math.min(r*s,o);for(let l=0;l<n.numberOfChannels;l++){let u=n.getChannelData(l);for(let d=0;d<a;d++)u[d]=Math.random()*2-1;let h=1/(r*t);for(let d=a;d<o;d++){let f=Math.exp(-(d-a)*h);u[d]=(Math.random()*2-1)*f}}return n}createConvolutionReverb(e,t){let s=new ConvolverNode(e,{buffer:t});return{input:s,output:s,convolverNode:s}}createCombFilter(e,t,s,r){let o=new DelayNode(e,{maxDelayTime:s,delayTime:s}),n=new GainNode(e,{gain:r});return t.connect(o),o.connect(n),n.connect(o),o}createAllpassFilter(e,t,s,r){let o=new DelayNode(e,{maxDelayTime:s,delayTime:s}),n=new GainNode(e,{gain:r}),a=new GainNode(e,{gain:1-r});return t.connect(o),o.connect(n),n.connect(o),o.connect(a),a}generateDistributedArray(e,t,s=.1,r=.05){let o=e*s,n=new Array(t);for(let a=0;a<t;a++){let l=a/(t-1||1),u=e-o+l*2*o;n[a]=u*(1-(Math.random()*2-1)*r)}return n}createSchroederReverb(e,t,s,r,o){let n=new GainNode(e),a=new GainNode(e);for(let h=0;h<s.length;h++)this.createCombFilter(e,n,s[h],t[h]).connect(a);let l=[];for(let h=0;h<o.length;h++){let d=this.createAllpassFilter(e,h===0?a:l.at(-1),o[h],r[h]);l.push(d)}let u=l.at(-1);return{input:n,output:u}}createReverbEffect(e){let{algorithm:t,time:s,feedback:r}=this.reverb;switch(t){case"ConvolutionReverb":{let o=this.createConvolutionReverbImpulse(e,s,this.calcDelay(s,r));return this.createConvolutionReverb(e,o)}case"SchroederReverb":{let o=this.generateDistributedArray(r,4),n=o.map(u=>this.calcDelay(s,u)),a=this.generateDistributedArray(r,4),l=a.map(u=>this.calcDelay(s,u));return this.createSchroederReverb(e,o,n,a,l)}}}createChorusEffect(e){let t=new GainNode(e),s=new GainNode(e),r=new GainNode(e),o=new OscillatorNode(e,{frequency:this.chorus.modRate}),n=new GainNode(e,{gain:this.chorus.modDepth/2}),a=this.chorus.delayTimes,l=[],u=[];for(let h=0;h<a.length;h++){let d=a[h],f=new DelayNode(e,{maxDelayTime:.1,delayTime:d}),p=new GainNode(e,{gain:this.chorus.feedback});l.push(f),u.push(p),t.connect(f),n.connect(f.delayTime),f.connect(p),p.connect(f),f.connect(s)}return s.connect(r),o.connect(n),o.start(),{input:t,output:s,sendGain:r,lfo:o,lfoGain:n,delayNodes:l,feedbackGains:u}}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=e.isDrum?0:this.masterCoarseTuning+this.masterFineTuning,s=e.coarseTuning+e.fineTuning,r=t+s,o=e.state.pitchWheel*2-1,n=e.state.pitchWheelSensitivity*12800,a=o*n,l=e.channelPressureTable[0];if(0<=l){let h=(l-64)/37.5*e.state.channelPressure;return r+a+h}else return r+a}updateChannelDetune(e,t){this.processScheduledNotes(e,s=>{this.isPortamento(e,s)?this.setPortamentoDetune(e,s,t):this.setDetune(e,s,t)})}calcScaleOctaveTuning(e,t){return e.scaleOctaveTuningTable[t.noteNumber%12]}calcNoteDetune(e,t){let s=t.voiceParams.detune+this.calcScaleOctaveTuning(e,t),r=this.getPitchControl(e,t);return e.detune+s+r}getPortamentoTime(e,t){let{portamentoTimeMSB:s,portamentoTimeLSB:r}=e.state,o=s+r/128,n=Math.abs(t.noteNumber-t.portamentoNoteNumber),a=Math.ceil(o*128);return n/this.getPitchIncrementSpeed(a)/10}getPitchIncrementSpeed(e){let t=[[0,1e3],[6,100],[16,20],[32,10],[48,5],[64,2.5],[80,1],[96,.4],[112,.15],[127,.01]],s=new Array(t.length);for(let S=0;S<t.length;S++){let[D,K]=t[S];if(e===D)return K;s[S]=[D,Math.log(K)]}let r=0;for(let S=1;S<s.length;S++)if(e<=s[S][0]){r=S-1;break}let[o,n]=s[r],[a,l]=s[r+1],u=a-o,h=(e-o)/u,d,f;if(r===0)d=(l-n)/u;else{let[S,D]=s[r-1];d=(l-D)/(a-S)}if(r===s.length-2)f=(l-n)/u;else{let[S,D]=s[r+2];f=(D-n)/(S-o)}let p=h*h,y=p*h,M=2*y-3*p+1,E=y-2*p+h,C=-2*y+3*p,T=y-p,v=M*n+C*l+u*(E*d+T*f);return Math.exp(v)}setPortamentoVolumeEnvelope(e,t,s){let{voiceParams:r,startTime:o}=t,a=G(-r.initialAttenuation)*(1+this.getAmplitudeControl(e,t))*(1-r.volSustain),l=o+this.getPortamentoTime(e,t);t.volumeEnvelopeNode.gain.cancelScheduledValues(s).exponentialRampToValueAtTime(a,l)}setVolumeEnvelope(e,t,s){let{voiceParams:r,startTime:o}=t,n=G(-r.initialAttenuation)*(1+this.getAmplitudeControl(e,t)),a=n*(1-r.volSustain),l=o+r.volDelay,u=this.getRelativeKeyBasedValue(e,t,73)*2,h=l+r.volAttack*u,d=h+r.volHold,f=this.getRelativeKeyBasedValue(e,t,75)*2,p=r.volDecay*f;t.volumeEnvelopeNode.gain.cancelScheduledValues(s).setValueAtTime(0,o).setValueAtTime(1e-6,l).exponentialRampToValueAtTime(n,h).setValueAtTime(n,d).setTargetAtTime(a,d,p*fe)}setPortamentoDetune(e,t,s){if(e.portamentoControl){let l=e.state,u=Math.ceil(l.portamentoNoteNumber*127);t.portamentoNoteNumber=u,e.portamentoControl=!1,l.portamentoNoteNumber=0}let r=this.calcNoteDetune(e,t),o=t.startTime,n=(t.noteNumber-t.portamentoNoteNumber)*100,a=o+this.getPortamentoTime(e,t);t.bufferSource.detune.cancelScheduledValues(s).setValueAtTime(r-n,s).linearRampToValueAtTime(r,a)}setDetune(e,t,s){let r=this.calcNoteDetune(e,t);t.bufferSource.detune.cancelScheduledValues(s).setValueAtTime(r,s);let o=this.perceptualSmoothingTime/5;t.bufferSource.detune.cancelAndHoldAtTime(s).setTargetAtTime(r,s,o)}setPortamentoPitchEnvelope(e,t,s){let r=t.voiceParams.playbackRate,o=t.startTime+this.getPortamentoTime(e,t);t.bufferSource.playbackRate.cancelScheduledValues(s).exponentialRampToValueAtTime(r,o)}setPitchEnvelope(e,t){let{bufferSource:s,voiceParams:r}=e,o=r.playbackRate;s.playbackRate.cancelScheduledValues(t).setValueAtTime(o,t);let n=r.modEnvToPitch;if(n===0)return;let a=o*this.centToRate(n),l=e.startTime+r.modDelay,u=l+r.modAttack,h=u+r.modHold,d=r.modDecay;s.playbackRate.setValueAtTime(o,l).exponentialRampToValueAtTime(a,u).setValueAtTime(a,h).setTargetAtTime(o,h,d*fe)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setPortamentoFilterEnvelope(e,t,s){let{voiceParams:r,startTime:o}=t,n=this.getSoftPedalFactor(e,t),a=this.getRelativeKeyBasedValue(e,t,74)*2,l=n*a,u=r.initialFilterFc+this.getFilterCutoffControl(e,t),h=u+r.modEnvToFilterFc*(1-r.modSustain),d=this.centToHz(u)*l,f=this.centToHz(h)*l,p=this.clampCutoffFrequency(d),y=this.clampCutoffFrequency(f),M=o+this.getPortamentoTime(e,t),E=o+r.modDelay;t.adjustedBaseFreq=y,t.filterNode.frequency.cancelScheduledValues(s).setValueAtTime(p,o).setValueAtTime(p,E).exponentialRampToValueAtTime(y,M)}setFilterEnvelope(e,t,s){let{voiceParams:r,startTime:o}=t,n=r.modEnvToFilterFc,a=r.initialFilterFc+this.getFilterCutoffControl(e,t),l=a+n,u=a+n*(1-r.modSustain),h=this.getSoftPedalFactor(e,t),d=this.getRelativeKeyBasedValue(e,t,74)*2,f=h*d,p=this.centToHz(a)*f,y=this.centToHz(l)*f,M=this.centToHz(u)*f,E=this.clampCutoffFrequency(p),C=this.clampCutoffFrequency(y),T=this.clampCutoffFrequency(M),v=o+r.modDelay,S=v+r.modAttack,D=S+r.modHold,K=D+r.modDecay;t.adjustedBaseFreq=E,t.filterNode.frequency.cancelScheduledValues(s).setValueAtTime(E,o).setValueAtTime(E,v).exponentialRampToValueAtTime(C,S).setValueAtTime(C,D).setTargetAtTime(T,D,K*fe)}startModulation(e,t,s){let r=this.audioContext,{voiceParams:o}=t;t.modulationLFO=new OscillatorNode(r,{frequency:this.centToHz(o.freqModLFO)}),t.filterDepth=new GainNode(r,{gain:o.modLfoToFilterFc}),t.modulationDepth=new GainNode(r),this.setModLfoToPitch(e,t,s),t.volumeDepth=new GainNode(r),this.setModLfoToVolume(e,t,s),t.modulationLFO.start(t.startTime+o.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}startVibrato(e,t,s){let{voiceParams:r}=t,o=this.getRelativeKeyBasedValue(e,t,76)*2,n=this.getRelativeKeyBasedValue(e,t,78)*2;t.vibratoLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(r.freqVibLFO)*o}),t.vibratoLFO.start(t.startTime+r.delayVibLFO*n),t.vibratoDepth=new GainNode(this.audioContext),this.setVibLfoToPitch(e,t,s),t.vibratoLFO.connect(t.vibratoDepth),t.vibratoDepth.connect(t.bufferSource.detune)}async getAudioBuffer(e,t,s,r,o){let n=this.getVoiceId(e,t,s);if(o){let a=this.realtimeVoiceCache.get(n);if(a)return a;let l=await this.createAudioBuffer(r);return this.realtimeVoiceCache.set(n,l),l}else{let a=this.voiceCache.get(n);if(a)return a.counter+=1,a.maxCount<=a.counter&&this.voiceCache.delete(n),a.audioBuffer;{let l=this.voiceCounter.get(n)??0,u=await this.createAudioBuffer(r),h={audioBuffer:u,maxCount:l,counter:1};return this.voiceCache.set(n,h),u}}}async setNoteAudioNode(e,t,s){let r=this.audioContext,o=r.currentTime,{noteNumber:n,velocity:a,startTime:l}=t,u=e.state,h=this.getControllerState(e,n,a,0),d=t.voice.getAllParams(h);t.voiceParams=d;let f=await this.getAudioBuffer(e,n,a,d,s);t.bufferSource=this.createBufferSource(e,n,d,f),t.volumeEnvelopeNode=new GainNode(r);let p=this.getRelativeKeyBasedValue(e,t,71);t.filterNode=new BiquadFilterNode(r,{type:"lowpass",Q:d.initialFilterQ/5*p});let y=e.scheduledNotes.at(-1);if(y&&y.noteNumber!==n&&(t.portamentoNoteNumber=y.noteNumber),!e.isDrum&&this.isPortamento(e,t)?(this.setPortamentoVolumeEnvelope(e,t,o),this.setPortamentoFilterEnvelope(e,t,o),this.setPortamentoPitchEnvelope(e,t,o),this.setPortamentoDetune(e,t,o)):(this.setVolumeEnvelope(e,t,o),this.setFilterEnvelope(e,t,o),this.setPitchEnvelope(t,o),this.setDetune(e,t,o)),0<u.vibratoDepth&&this.startVibrato(e,t,o),0<u.modulationDepthMSB+u.modulationDepthLSB&&this.startModulation(e,t,o),e.mono&&e.currentBufferSource&&(e.currentBufferSource.stop(l),e.currentBufferSource=t.bufferSource),t.bufferSource.connect(t.filterNode),t.filterNode.connect(t.volumeEnvelopeNode),this.setChorusSend(e,t,o),this.setReverbSend(e,t,o),d.sample.type==="compressed"){let M=d.start/f.sampleRate;t.bufferSource.start(l,M)}else t.bufferSource.start(l);return t}handleExclusiveClass(e,t,s){let r=e.voiceParams.exclusiveClass;if(r===0)return;let o=this.exclusiveClassNotes[r];if(o){let[n,a]=o;n&&!n.ending&&this.noteOff(a,n.noteNumber,0,s,!0)}this.exclusiveClassNotes[r]=[e,t]}handleDrumExclusiveClass(e,t,s){let r=this.channels[t];if(!r.isDrum)return;let o=j[r.programNumber];if(!o)return;let n=o[e.noteNumber];if(n===0)return;let a=(n-1)*this.channels.length+t,l=this.drumExclusiveClassNotes[a];l&&!l.ending&&this.noteOff(t,l.noteNumber,0,s,!0),this.drumExclusiveClassNotes[a]=e}setNoteRouting(e,t,s){let r=this.channels[e],{noteNumber:o,volumeEnvelopeNode:n}=t;if(r.isDrum){let{keyBasedGainLs:a,keyBasedGainRs:l}=r,u=a[o],h=l[o];if(!u){let d=this.createChannelAudioNodes(this.audioContext);u=a[o]=d.gainL,h=l[o]=d.gainR}n.connect(u),n.connect(h)}else n.connect(r.gainL),n.connect(r.gainR);.5<=r.state.sustainPedal&&r.sustainNotes.push(t),this.handleExclusiveClass(t,e,s),this.handleDrumExclusiveClass(t,e,s)}async noteOn(e,t,s,r){if(this.mpeEnabled){let o=await this.startNote(e,t,s,r);this.mpeState.channelToNotes.has(e)||this.mpeState.channelToNotes.set(e,new Set),this.mpeState.channelToNotes.get(e).add(o.index),this.mpeState.noteToChannel.set(o.index,e)}else await this.startNote(e,t,s,r)}async startNote(e,t,s,r){let o=this.channels[e],n=r===void 0;n&&(r=this.audioContext.currentTime);let a=new pe(t,s,r),l=o.scheduledNotes;a.index=l.length,l.push(a);let u=o.programNumber,h=this.soundFontTable[u],d=o.isDrum?128:o.bankLSB;if(h[d]===void 0){if(o.isDrum)return;d=0}let f=h[d];if(f===void 0)return;let p=this.soundFonts[f];if(a.voice=p.getVoice(d,u,t,s),!!a.voice)return await this.setNoteAudioNode(o,a,n),this.setNoteRouting(e,a,r),a.resolveReady(),a}disconnectNote(e){e.bufferSource.disconnect(),e.filterNode.disconnect(),e.volumeEnvelopeNode.disconnect(),e.modulationDepth&&(e.volumeDepth.disconnect(),e.modulationDepth.disconnect(),e.modulationLFO.stop()),e.vibratoDepth&&(e.vibratoDepth.disconnect(),e.vibratoLFO.stop()),e.reverbSend&&e.reverbSend.disconnect(),e.chorusSend&&e.chorusSend.disconnect()}releaseNote(e,t,s){s??=this.audioContext.currentTime;let r=this.getRelativeKeyBasedValue(e,t,72)*2,o=t.voiceParams.volRelease*r,n=s+o;return t.filterNode.frequency.cancelScheduledValues(s).setTargetAtTime(t.adjustedBaseFreq,s,t.voiceParams.modRelease*Ne),t.volumeEnvelopeNode.gain.cancelScheduledValues(s).setTargetAtTime(0,s,o*Ne),new Promise(a=>{this.scheduleTask(()=>{let l=t.bufferSource;l.loop=!1,l.stop(n),this.disconnectNote(t),e.scheduledNotes[t.index]=void 0,a()},n)})}noteOff(e,t,s,r,o){if(this.mpeEnabled){let n=this.mpeState.channelToNotes.get(e);if(!n||n.size===0)return;let a=this.channels[e],l;for(let d of n){let f=a.scheduledNotes[d];if(f&&f.noteNumber===t&&!f.ending){l=d;break}}if(l===void 0)return;let u=a.scheduledNotes[l];u.ending=!0;let h=u.ready.then(()=>this.releaseNote(a,u,r));return n.delete(l),n.size===0&&this.mpeState.channelToNotes.delete(e),this.mpeState.noteToChannel.delete(l),h}else return this.stopNote(e,t,s,r,o)}stopNote(e,t,s,r,o){let n=this.channels[e],a=n.state;if(!o){if(n.isDrum){if(!this.isLoopDrum(n,t))return}else if(.5<=a.sustainPedal||.5<=a.sostenutoPedal)return}let l=this.findNoteOffIndex(n,t);if(l<0)return;let u=n.scheduledNotes[l];u.ending=!0,this.setNoteIndex(n,l);let h=u.ready.then(()=>this.releaseNote(n,u,r));return this.notePromises.push(h),h}setNoteIndex(e,t){let s=!0;for(let r=e.scheduleIndex;r<t;r++){let o=e.scheduledNotes[r];if(o&&!o.ending){s=!1;break}}s&&(e.scheduleIndex=t+1)}findNoteOffIndex(e,t){let s=e.scheduledNotes;for(let r=e.scheduleIndex;r<s.length;r++){let o=s[r];if(o&&!o.ending&&o.noteNumber===t)return r}return-1}releaseSustainPedal(e,t,s){let r=t*2,o=this.channels[e],n=[];for(let a=0;a<o.sustainNotes.length;a++){let l=this.noteOff(e,o.sustainNotes[a].noteNumber,r,s);n.push(l)}return o.sustainNotes=[],n}releaseSostenutoPedal(e,t,s){let r=t*2,o=this.channels[e],n=[],a=o.sostenutoNotes;o.state.sostenutoPedal=0;for(let l=0;l<a.length;l++){let u=a[l],h=this.noteOff(e,u.noteNumber,r,s);n.push(h)}return o.sostenutoNotes=[],n}createMessageHandlers(){let e=new Array(256);return e[128]=(t,s)=>this.noteOff(t[0]&15,t[1],t[2],s),e[144]=(t,s)=>this.noteOn(t[0]&15,t[1],t[2],s),e[160]=(t,s)=>this.setPolyphonicKeyPressure(t[0]&15,t[1],t[2],s),e[176]=(t,s)=>this.setControlChange(t[0]&15,t[1],t[2],s),e[192]=(t,s)=>this.setProgramChange(t[0]&15,t[1],s),e[208]=(t,s)=>this.setChannelPressure(t[0]&15,t[1],s),e[224]=(t,s)=>this.handlePitchBendMessage(t[0]&15,t[1],t[2],s),e[254]=(t,s)=>this.activeSensing(),e}handleMessage(e,t){let s=e[0];if(s===240)return this.handleSysEx(e.subarray(1),t);let r=this.messageHandlers[s];r&&r(e,t)}activeSensing(){this.lastActiveSensing=performance.now()}setPolyphonicKeyPressure(e,t,s,r){let o=this.channels[e];if(o.isMPEMember)return;0<=r||(r=this.audioContext.currentTime);let n=o.polyphonicKeyPressureTable;this.processActiveNotes(o,r,a=>{a.noteNumber===t&&(a.pressure=s,this.setEffects(o,a,n,r))}),this.applyVoiceParams(o,10,r)}setProgramChange(e,t,s){this.applyToMPEChannels(e,r=>{this.applyProgramChange(r,t,s)})}applyProgramChange(e,t,s){let r=this.channels[e];if(r.programNumber=t,this.mode==="GM2")switch(r.bankMSB){case 120:r.isDrum=!0,r.keyBasedTable.fill(-1);break;case 121:r.isDrum=!1;break}}setChannelPressure(e,t,s){this.applyToMPEChannels(e,r=>{this.applyChannelPressure(r,t,s)})}applyChannelPressure(e,t,s){0<=s||(s=this.audioContext.currentTime);let r=this.channels[e];if(r.isDrum)return;let o=r.state.channelPressure,n=t/127;r.state.channelPressure=n;let a=r.channelPressureTable[0];if(0<=a){let u=(a-64)/37.5;r.detune+=u*(n-o)}let l=r.channelPressureTable;this.processActiveNotes(r,s,u=>{this.setEffects(r,u,l,s)}),this.applyVoiceParams(r,13,s)}handlePitchBendMessage(e,t,s,r){let o=s*128+t;this.setPitchBend(e,o,r)}setPitchBend(e,t,s){this.applyToMPEChannels(e,r=>{this.applyPitchBend(r,t,s)})}applyPitchBend(e,t,s){let r=this.channels[e];if(r.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=r.state,n=o.pitchWheel*2-1,a=(t-8192)/8192;o.pitchWheel=t/16383,r.detune+=(a-n)*o.pitchWheelSensitivity*12800,this.updateChannelDetune(r,s),this.applyVoiceParams(r,14,s)}setModLfoToPitch(e,t,s){if(t.modulationDepth){let{modulationDepthMSB:r,modulationDepthLSB:o}=e.state,n=r+o/128,a=t.voiceParams.modLfoToPitch+this.getLFOPitchDepth(e,t),u=(Math.abs(a)+n)*Math.sign(a);t.modulationDepth.gain.cancelScheduledValues(s).setValueAtTime(u,s)}else this.startModulation(e,t,s)}setVibLfoToPitch(e,t,s){if(t.vibratoDepth){let r=this.getKeyBasedValue(e,t.noteNumber,77)*2,o=t.voiceParams.vibLfoToPitch,a=Math.abs(o)*r*Math.sign(o);t.vibratoDepth.gain.cancelScheduledValues(s).setValueAtTime(a,s)}else this.startVibrato(e,t,s)}setModLfoToFilterFc(e,t,s){let r=t.voiceParams.modLfoToFilterFc+this.getLFOFilterDepth(e,t);t.filterDepth.gain.cancelScheduledValues(s).setValueAtTime(r,s)}setModLfoToVolume(e,t,s){let r=t.voiceParams.modLfoToVolume,n=(G(Math.abs(r))-1)*Math.sign(r)*(1+this.getLFOAmplitudeDepth(e,t));t.volumeDepth.gain.cancelScheduledValues(s).setValueAtTime(n,s)}setReverbSend(e,t,s){let r=t.voiceParams.reverbEffectsSend*e.state.reverbSendLevel;if(e.isDrum){let o=this.getKeyBasedValue(e,t.noteNumber,91);0<=o&&(r=o/127)}if(!t.reverbSend)0<r&&(t.reverbSend=new GainNode(this.audioContext,{gain:r}),t.volumeEnvelopeNode.connect(t.reverbSend),t.reverbSend.connect(this.reverbEffect.input));else if(t.reverbSend.gain.cancelScheduledValues(s).setValueAtTime(r,s),0<r)t.volumeEnvelopeNode.connect(t.reverbSend);else try{t.volumeEnvelopeNode.disconnect(t.reverbSend)}catch{}}setChorusSend(e,t,s){let r=t.voiceParams.chorusEffectsSend*e.state.chorusSendLevel;if(e.isDrum){let o=this.getKeyBasedValue(e,t.noteNumber,93);0<=o&&(r=o/127)}if(!t.chorusSend)0<r&&(t.chorusSend=new GainNode(this.audioContext,{gain:r}),t.volumeEnvelopeNode.connect(t.chorusSend),t.chorusSend.connect(this.chorusEffect.input));else if(t.chorusSend.gain.cancelScheduledValues(s).setValueAtTime(r,s),0<r)t.volumeEnvelopeNode.connect(t.chorusSend);else try{t.volumeEnvelopeNode.disconnect(t.chorusSend)}catch{}}setDelayModLFO(e){let t=e.startTime+e.voiceParams.delayModLFO;try{e.modulationLFO.start(t)}catch{}}setFreqModLFO(e,t){let s=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(s,t)}setDelayVibLFO(e,t){let s=this.getRelativeKeyBasedValue(e,t,78)*2,r=t.voiceParams.delayVibLFO,o=t.startTime+r*s;try{t.vibratoLFO.start(o)}catch{}}setFreqVibLFO(e,t,s){let r=this.getRelativeKeyBasedValue(e,t,76)*2,o=t.voiceParams.freqVibLFO;t.vibratoLFO.frequency.cancelScheduledValues(s).setValueAtTime(o*r,s)}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,s)=>{let{modulationDepthMSB:r,modulationDepthLSB:o}=e.state;0<r+o&&this.setModLfoToPitch(e,t,s)},vibLfoToPitch:(e,t,s)=>{0<e.state.vibratoDepth&&this.setVibLfoToPitch(e,t,s)},modLfoToFilterFc:(e,t,s)=>{let{modulationDepthMSB:r,modulationDepthLSB:o}=e.state;0<r+o&&this.setModLfoToFilterFc(e,t,s)},modLfoToVolume:(e,t,s)=>{let{modulationDepthMSB:r,modulationDepthLSB:o}=e.state;0<r+o&&this.setModLfoToVolume(e,t,s)},chorusEffectsSend:(e,t,s)=>{this.setChorusSend(e,t,s)},reverbEffectsSend:(e,t,s)=>{this.setReverbSend(e,t,s)},delayModLFO:(e,t,s)=>{let{modulationDepthMSB:r,modulationDepthLSB:o}=channel.state;0<r+o&&this.setDelayModLFO(t)},freqModLFO:(e,t,s)=>{let{modulationDepthMSB:r,modulationDepthLSB:o}=channel.state;0<r+o&&this.setFreqModLFO(t,s)},delayVibLFO:(e,t,s)=>{0<e.state.vibratoDepth&&setDelayVibLFO(e,t)},freqVibLFO:(e,t,s)=>{0<e.state.vibratoDepth&&this.setFreqVibLFO(e,t,s)},detune:(e,t,s)=>{this.isPortamento(e,t)?this.setPortamentoDetune(e,t,s):this.setDetune(e,t,s)}}}getControllerState(e,t,s,r){let o=new Float32Array(e.state.array.length);return o.set(e.state.array),o[2]=s/127,o[3]=t/127,o[10]=r/127,o[13]=o.channelPressure/127,o}applyVoiceParams(e,t,s){this.processScheduledNotes(e,r=>{let o=this.getControllerState(e,r.noteNumber,r.velocity,r.pressure),n=r.voice.getParams(t,o),a=!1,l=!1,u=!1;for(let[h,d]of Object.entries(n)){let f=r.voiceParams[h];d!==f&&(r.voiceParams[h]=d,h in this.voiceParamsHandlers?this.voiceParamsHandlers[h](e,r,s):(vt.has(h)&&(a=!0),Pt.has(h)&&(l=!0),xt.has(h)&&(u=!0)))}a&&this.setVolumeEnvelope(e,r,s),l&&this.setFilterEnvelope(e,r,s),u&&this.setPitchEnvelope(r,s)})}createControlChangeHandlers(){let e=new Array(128);return e[0]=this.setBankMSB,e[1]=this.setModulationDepth,e[5]=this.setPortamentoTime,e[6]=this.dataEntryMSB,e[7]=this.setVolume,e[10]=this.setPan,e[11]=this.setExpression,e[32]=this.setBankLSB,e[33]=this.setModulationDepth,e[37]=this.setPortamentoTime,e[38]=this.dataEntryLSB,e[39]=this.setVolume,e[42]=this.setPan,e[43]=this.setExpression,e[64]=this.setSustainPedal,e[65]=this.setPortamento,e[66]=this.setSostenutoPedal,e[67]=this.setSoftPedal,e[71]=this.setFilterResonance,e[72]=this.setReleaseTime,e[73]=this.setAttackTime,e[74]=this.setBrightness,e[75]=this.setDecayTime,e[76]=this.setVibratoRate,e[77]=this.setVibratoDepth,e[78]=this.setVibratoDelay,e[84]=this.setPortamentoNoteNumber,e[91]=this.setReverbSendLevel,e[93]=this.setChorusSendLevel,e[96]=this.dataIncrement,e[97]=this.dataDecrement,e[100]=this.setRPNLSB,e[101]=this.setRPNMSB,e[111]=this.setRPGMakerLoop,e[120]=this.allSoundOff,e[121]=this.resetAllControllers,e[123]=this.allNotesOff,e[124]=this.omniOff,e[125]=this.omniOn,e[126]=this.monoOn,e[127]=this.polyOn,e}setControlChange(e,t,s,r){this.applyToMPEChannels(e,o=>{this.applyControlChange(o,t,s,r)})}applyControlChange(e,t,s,r){let o=this.controlChangeHandlers[t];if(o){o.call(this,e,s,r);let n=this.channels[e];this.applyVoiceParams(n,t+128,r),this.setControlChangeEffects(n,t,r)}else console.warn(`Unsupported Control change: controllerType=${t} value=${s}`)}setBankMSB(e,t){this.channels[e].bankMSB=t}updateModulation(e,t){let{modulationDepthMSB:s,modulationDepthLSB:r}=e.state,n=(s+r/128)*e.modulationDepthRange;this.processScheduledNotes(e,a=>{a.modulationDepth?a.modulationDepth.gain.setValueAtTime(n,t):this.startModulation(e,a,t)})}setModulationDepth(e,t,s){let r=this.channels[e];if(r.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=r.state,n=Math.trunc(t);o.modulationDepthMSB=n/127,o.modulationDepthLSB=t-n,this.updateModulation(r,s)}updatePortamento(e,t){e.isDrum||this.processScheduledNotes(e,s=>{this.isPortamento(e,s)?(this.setPortamentoVolumeEnvelope(e,s,t),this.setPortamentoFilterEnvelope(e,s,t),this.setPortamentoPitchEnvelope(e,s,t),this.setPortamentoDetune(e,s,t)):(this.setVolumeEnvelope(e,s,t),this.setFilterEnvelope(e,s,t),this.setPitchEnvelope(s,t),this.setDetune(e,s,t))})}setPortamentoTime(e,t,s){0<=s||(s=this.audioContext.currentTime);let r=this.channels[e],o=r.state,n=Math.trunc(t);o.portamentoTimeMSB=n/127,o.portamentoTimeLSB=t-127,!r.isDrum&&this.updatePortamento(r,s)}setVolume(e,t,s){0<=s||(s=this.audioContext.currentTime);let r=this.channels[e],o=r.state,n=Math.trunc(t);if(o.volumeMSB=n/127,o.volumeLSB=t-n,r.isDrum)for(let a=0;a<128;a++)this.updateKeyBasedVolume(r,a,s);else this.updateChannelVolume(r,s)}panToGain(e){let t=Math.PI/2*Math.max(e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t,s){0<=s||(s=this.audioContext.currentTime);let r=this.channels[e],o=r.state,n=Math.trunc(t);if(o.panMSB=n/127,o.panLSB=t-n,r.isDrum)for(let a=0;a<128;a++)this.updateKeyBasedVolume(r,a,s);else this.updateChannelVolume(r,s)}setExpression(e,t,s){0<=s||(s=this.audioContext.currentTime);let r=this.channels[e],o=r.state,n=Math.trunc(t);o.expressionMSB=n/127,o.expressionLSB=t-n,this.updateChannelVolume(r,s)}setBankLSB(e,t){this.channels[e].bankLSB=t}dataEntryLSB(e,t,s){this.channels[e].dataLSB=t,this.handleRPN(e,0,s)}updateChannelVolume(e,t){let{expressionMSB:s,expressionLSB:r,volumeMSB:o,volumeLSB:n,panMSB:a,panLSB:l}=e.state,u=o+n/128,h=s+r/128,d=a+l/128,f=u*h,{gainLeft:p,gainRight:y}=this.panToGain(d);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(f*p,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(f*y,t)}updateKeyBasedVolume(e,t,s){let r=e.keyBasedGainLs[t];if(!r)return;let o=e.keyBasedGainRs[t],{expressionMSB:n,expressionLSB:a,volumeMSB:l,volumeLSB:u,panMSB:h,panLSB:d}=e.state,f=l+u/128,p=n+a/128,y=f*p,M=h+d/128,E=this.getKeyBasedValue(e,t,7),C=0<=E?y*E/64:y,T=this.getKeyBasedValue(e,t,10),v=0<=T?T/127:M,{gainLeft:S,gainRight:D}=this.panToGain(v);r.gain.cancelScheduledValues(s).setValueAtTime(C*S,s),o.gain.cancelScheduledValues(s).setValueAtTime(C*D,s)}setSustainPedal(e,t,s){let r=this.channels[e];r.isDrum||(0<=s||(s=this.audioContext.currentTime),r.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(r,o=>{r.sustainNotes.push(o)}):this.releaseSustainPedal(e,t,s))}isPortamento(e,t){return .5<=e.state.portamento&&0<=t.portamentoNoteNumber}setPortamento(e,t,s){let r=this.channels[e];r.isDrum||(0<=s||(s=this.audioContext.currentTime),r.state.portamento=t/127,this.updatePortamento(r,s))}setSostenutoPedal(e,t,s){let r=this.channels[e];if(!r.isDrum)if(0<=s||(s=this.audioContext.currentTime),r.state.sostenutoPedal=t/127,64<=t){let o=[];this.processActiveNotes(r,s,n=>{o.push(n)}),r.sostenutoNotes=o}else this.releaseSostenutoPedal(e,t,s)}getSoftPedalFactor(e,t){return 1-(.1+t.noteNumber/127*.2)*e.state.softPedal}setSoftPedal(e,t,s){let r=this.channels[e];if(r.isDrum)return;let o=r.state;0<=s||(s=this.audioContext.currentTime),o.softPedal=t/127,this.processScheduledNotes(r,n=>{this.isPortamento(r,n)?(this.setPortamentoVolumeEnvelope(r,n,s),this.setPortamentoFilterEnvelope(r,n,s)):(this.setVolumeEnvelope(r,n,s),this.setFilterEnvelope(r,n,s))})}setFilterResonance(e,t,s){let r=this.channels[e];if(r.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=r.state;o.filterResonance=t/127,this.processScheduledNotes(r,n=>{let a=this.getRelativeKeyBasedValue(r,n,71),l=n.voiceParams.initialFilterQ/5*a;n.filterNode.Q.setValueAtTime(l,s)})}getRelativeKeyBasedValue(e,t,s){let r=e.state.array[128+s],o=this.getKeyBasedValue(e,t.noteNumber,s);if(o<0)return r;let n=r+o/127-.5;return n<0?n:0}setReleaseTime(e,t,s){let r=this.channels[e];r.isDrum||(0<=s||(s=this.audioContext.currentTime),r.state.releaseTime=t/127)}setAttackTime(e,t,s){let r=this.channels[e];r.isDrum||(0<=s||(s=this.audioContext.currentTime),r.state.attackTime=t/127,this.processScheduledNotes(r,o=>{s<o.startTime&&this.setVolumeEnvelope(r,o,s)}))}setBrightness(e,t,s){let r=this.channels[e];if(r.isDrum)return;let o=r.state;0<=s||(s=this.audioContext.currentTime),o.brightness=t/127,this.processScheduledNotes(r,n=>{this.isPortamento(r,n)?this.setPortamentoFilterEnvelope(r,n,s):this.setFilterEnvelope(r,n,s)})}setDecayTime(e,t,s){let r=this.channels[e];r.isDrum||(0<=s||(s=this.audioContext.currentTime),r.state.decayTime=t/127,this.processScheduledNotes(r,o=>{this.setVolumeEnvelope(r,o,s)}))}setVibratoRate(e,t,s){let r=this.channels[e];r.isDrum||(0<=s||(s=this.audioContext.currentTime),r.state.vibratoRate=t/127,!(r.vibratoDepth<=0)&&this.processScheduledNotes(r,o=>{this.setVibLfoToPitch(r,o,s)}))}setVibratoDepth(e,t,s){let r=this.channels[e];if(r.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=r.state.vibratoDepth;r.state.vibratoDepth=t/127,0<o?this.processScheduledNotes(r,n=>{this.setFreqVibLFO(r,n,s)}):this.processScheduledNotes(r,n=>{this.startVibrato(r,n,s)})}setVibratoDelay(e,t,s){let r=this.channels[e];r.isDrum||(0<=s||(s=this.audioContext.currentTime),r.state.vibratoDelay=t/127,0<r.state.vibratoDepth&&this.processScheduledNotes(r,o=>{this.startVibrato(r,o,s)}))}setPortamentoNoteNumber(e,t,s){0<=s||(s=this.audioContext.currentTime);let r=this.channels[e];r.portamentoControl=!0,r.state.portamentoNoteNumber=t/127}setReverbSendLevel(e,t,s){0<=s||(s=this.audioContext.currentTime);let r=this.channels[e],o=r.state;o.reverbSendLevel=t/127,this.processScheduledNotes(r,n=>{this.setReverbSend(r,n,s)})}setChorusSendLevel(e,t,s){0<=s||(s=this.audioContext.currentTime);let r=this.channels[e],o=r.state;o.chorusSendLevel=t/127,this.processScheduledNotes(r,n=>{this.setChorusSend(r,n,s)})}limitData(e,t,s,r,o){o<e.dataLSB?(e.dataMSB++,e.dataLSB=r):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=o),s<e.dataMSB?(e.dataMSB=s,e.dataLSB=o):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=r)}limitDataMSB(e,t,s){s<e.dataMSB?e.dataMSB=s:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e,t,s){let r=this.channels[e];switch(r.rpnMSB*128+r.rpnLSB){case 0:r.dataLSB+=t,this.handlePitchBendRangeRPN(e,s);break;case 1:r.dataLSB+=t,this.handleFineTuningRPN(e,s);break;case 2:r.dataMSB+=t,this.handleCoarseTuningRPN(e,s);break;case 5:r.dataLSB+=t,this.handleModulationDepthRangeRPN(e,s);break;case 6:r.dataLSB+=t,this.handleMIDIPolyphonicExpressionRPN(e,s);break;case 16383:break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${r.rpnMSB} LSB=${r.rpnLSB}`)}}dataIncrement(e,t){0<=t||(t=this.audioContext.currentTime),this.handleRPN(e,1,t)}dataDecrement(e,t){0<=t||(t=this.audioContext.currentTime),this.handleRPN(e,-1,t)}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,s){this.channels[e].dataMSB=t,this.handleRPN(e,0,s)}handlePitchBendRangeRPN(e,t){let s=this.channels[e];this.limitData(s,0,127,0,127);let r=(s.dataMSB+s.dataLSB/128)*100;this.setPitchBendRange(e,r,t)}setPitchBendRange(e,t,s){let r=this.channels[e];if(r.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=r.state,n=o.pitchWheelSensitivity,a=t/12800;o.pitchWheelSensitivity=a,r.detune+=(o.pitchWheel*2-1)*(a-n)*12800,this.updateChannelDetune(r,s),this.applyVoiceParams(r,16,s)}handleFineTuningRPN(e,t){let s=this.channels[e];this.limitData(s,0,127,0,127);let o=(s.dataMSB*128+s.dataLSB-8192)/8192*100;this.setFineTuning(e,o,t)}setFineTuning(e,t,s){let r=this.channels[e];if(r.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=r.fineTuning,n=t;r.fineTuning=n,r.detune+=n-o,this.updateChannelDetune(r,s)}handleCoarseTuningRPN(e,t){let s=this.channels[e];this.limitDataMSB(s,0,127);let r=(s.dataMSB-64)*100;this.setCoarseTuning(e,r,t)}setCoarseTuning(e,t,s){let r=this.channels[e];if(r.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=r.coarseTuning,n=t;r.coarseTuning=n,r.detune+=n-o,this.updateChannelDetune(r,s)}handleModulationDepthRangeRPN(e,t){let s=this.channels[e];this.limitData(s,0,127,0,127);let r=(s.dataMSB+s.dataLSB/128)*100;this.setModulationDepthRange(e,r,t)}setModulationDepthRange(e,t,s){let r=this.channels[e];r.isDrum||(0<=s||(s=this.audioContext.currentTime),r.modulationDepthRange=t,this.updateModulation(r,s))}handleMIDIPolyphonicExpressionRPN(e,t){this.setMIDIPolyphonicExpression(e,channel.dataMSB)}setMIDIPolyphonicExpression(e,t){if(e!==0&&e!==15)return;let s=t&15;e===0?this.lowerMPEMembers=s:this.upperMPEMembers=s,this.mpeEnabled=this.lowerMPEMembers>0||this.upperMPEMembers>0;let r=1,o=this.lowerMPEMembers,n=16-this.upperMPEMembers,a=14,{channels:l,lowerMPEMembers:u,upperMPEMembers:h,mpeEnabled:d}=this;for(let f=0;f<16;f++){let p=u&&r<=f&&f<=o,y=h&&n<=f&&f<=a;l[i].isMPEMember=d&&(p||y),l[i].isMPEManager=d&&(f===0||f===15)}}setRPGMakerLoop(e,t,s){s??=this.audioContext.currentTime,this.loopStart=s+this.resumeTime-this.startTime}allSoundOff(e,t,s){this.channels[e].isMPEManager||this.applyAllSoundOff(e,t,s)}applyAllSoundOff(e,t,s){if(!this.channels[e].isMPEManager)return 0<=s||(s=this.audioContext.currentTime),this.stopActiveNotes(e,0,!0,s)}resetChannelStates(e){let t=this.audioContext.currentTime,s=this.channels[e],r=s.state,o=Object.entries(se);for(let[n,{type:a,defaultValue:l}]of o)128<=a?this.setControlChange(e,a-128,Math.ceil(l*127),t):r[n]=l;for(let n of Object.keys(this.constructor.channelSettings))s[n]=this.constructor.channelSettings[n];this.resetChannelTable(s),this.mode="GM2",this.masterFineTuning=0,this.masterCoarseTuning=0}resetAllControllers(e,t,s){let r=["polyphonicKeyPressure","channelPressure","pitchWheel","expressionMSB","expressionLSB","modulationDepthMSB","modulationDepthLSB","sustainPedal","portamento","sostenutoPedal","softPedal"],o=this.channels[e],n=o.state;for(let l=0;l<r.length;l++){let u=r[l],{type:h,defaultValue:d}=se[u];128<=h?this.setControlChange(e,h-128,Math.ceil(d*127),s):n[u]=d}this.setPitchBend(e,8192,s);let a=["rpnMSB","rpnLSB"];for(let l=0;l<a.length;l++){let u=a[l];o[u]=this.constructor.channelSettings[u]}}allNotesOff(e,t,s){return 0<=s||(s=this.audioContext.currentTime),this.stopActiveNotes(e,0,!1,s)}omniOff(e,t,s){this.mpeEnabled||this.allNotesOff(e,t,s)}omniOn(e,t,s){this.mpeEnabled||this.allNotesOff(e,t,s)}monoOn(e,t,s){let r=this.channels[e];r.isMPEManager||(this.allNotesOff(e,t,s),r.mono=!0)}polyOn(e,t,s){let r=this.channels[e];r.isMPEManager||(this.allNotesOff(e,t,s),r.mono=!1)}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 8:switch(e[3]){case 8:return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!1,t);case 9:return this.handleScaleOctaveTuning2ByteFormatSysEx(e,!1,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:this.GM1SystemOn(t);break;case 2:break;case 3:this.GM2SystemOn(t);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(e){let t=this.channels;0<=e||(e=this.audioContext.currentTime),this.mode="GM1";for(let s=0;s<t.length;s++){this.applyAllSoundOff(s,0,e);let r=t[s];r.bankMSB=0,r.bankLSB=0,r.isDrum=!1}t[9].bankMSB=1,t[9].isDrum=!0}GM2SystemOn(e){let t=this.channels;0<=e||(e=this.audioContext.currentTime),this.mode="GM2";for(let s=0;s<t.length;s++){this.applyAllSoundOff(s,0,e);let r=t[s];r.bankMSB=121,r.bankLSB=0,r.isDrum=!1}t[9].bankMSB=120,t[9].isDrum=!0}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e,t);case 3:return this.handleMasterFineTuningSysEx(e,t);case 4:return this.handleMasterCoarseTuningSysEx(e,t);case 5:return this.handleGlobalParameterControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 8:switch(e[3]){case 8:return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!0,t);case 9:return this.handleScaleOctaveTuning2ByteFormatSysEx(e,!0,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:return this.handlePressureSysEx(e,"channelPressureTable",t);case 2:return this.handlePressureSysEx(e,"polyphonicKeyPressureTable",t);case 3:return this.handleControlChangeSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 10:if(e[3]===1)return this.handleKeyBasedInstrumentControlSysEx(e,t);console.warn(`Unsupported Exclusive Message: ${e}`);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){let s=(e[5]*128+e[4])/16383;this.setMasterVolume(s,t)}setMasterVolume(e,t){0<=t||(t=this.audioContext.currentTime),this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleMasterFineTuningSysEx(e,t){let r=((e[5]*128+e[4])/16383-8192)/8192*100;this.setMasterFineTuning(r,t)}setMasterFineTuning(e,t){let s=this.masterFineTuning,r=e;this.masterFineTuning=r;let o=r-s,n=this.channels;for(let a=0;a<n.length;a++){let l=n[a];l.isDrum||(l.detune+=o,this.updateChannelDetune(l,t))}}handleMasterCoarseTuningSysEx(e,t){let s=(e[4]-64)*100;this.setMasterCoarseTuning(s,t)}setMasterCoarseTuning(e,t){let s=this.masterCoarseTuning,r=e;this.masterCoarseTuning=r;let o=r-s,n=this.channels;for(let a=0;a<n.length;a++){let l=n[a];l.isDrum||(l.detune+=o,this.updateChannelDetune(l,t))}}handleGlobalParameterControlSysEx(e,t){if(e[7]===1)switch(e[8]){case 1:return this.handleReverbParameterSysEx(e);case 2:return this.handleChorusParameterSysEx(e,t);default:console.warn(`Unsupported Global Parameter Control Message: ${e}`)}else console.warn(`Unsupported Global Parameter Control Message: ${e}`)}handleReverbParameterSysEx(e){switch(e[9]){case 0:return this.setReverbType(e[10]);case 1:return this.setReverbTime(e[10])}}setReverbType(e){this.reverb.time=this.getReverbTimeFromType(e),this.reverb.feedback=e===8?.9:.8,this.reverbEffect=this.createReverbEffect(this.audioContext)}getReverbTimeFromType(e){switch(e){case 0:return this.getReverbTime(44);case 1:return this.getReverbTime(50);case 2:return this.getReverbTime(56);case 3:return this.getReverbTime(64);case 4:return this.getReverbTime(64);case 8:return this.getReverbTime(50);default:console.warn(`Unsupported Reverb Time: ${e}`)}}setReverbTime(e){this.reverb.time=this.getReverbTime(e),this.reverbEffect=this.createReverbEffect(this.audioContext)}getReverbTime(e){return Math.exp((e-40)*.025)}calcDelay(e,t){return-e*Math.log10(t)/3}handleChorusParameterSysEx(e,t){switch(e[9]){case 0:return this.setChorusType(e[10],t);case 1:return this.setChorusModRate(e[10],t);case 2:return this.setChorusModDepth(e[10],t);case 3:return this.setChorusFeedback(e[10],t);case 4:return this.setChorusSendToReverb(e[10],t)}}setChorusType(e,t){switch(e){case 0:return this.setChorusParameter(3,5,0,0,t);case 1:return this.setChorusParameter(9,19,5,0,t);case 2:return this.setChorusParameter(3,19,8,0,t);case 3:return this.setChorusParameter(9,16,16,0,t);case 4:return this.setChorusParameter(2,24,64,0,t);case 5:return this.setChorusParameter(1,5,112,0,t);default:console.warn(`Unsupported Chorus Type: ${e}`)}}setChorusParameter(e,t,s,r,o){this.setChorusModRate(e,o),this.setChorusModDepth(t,o),this.setChorusFeedback(s,o),this.setChorusSendToReverb(r,o)}setChorusModRate(e,t){let s=this.getChorusModRate(e);this.chorus.modRate=s,this.chorusEffect.lfo.frequency.setValueAtTime(s,t)}getChorusModRate(e){return e*.122}setChorusModDepth(e,t){let s=this.getChorusModDepth(e);this.chorus.modDepth=s,this.chorusEffect.lfoGain.gain.cancelScheduledValues(t).setValueAtTime(s/2,t)}getChorusModDepth(e){return(e+1)/3200}setChorusFeedback(e,t){let s=this.getChorusFeedback(e);this.chorus.feedback=s;let r=this.chorusEffect;for(let o=0;o<r.feedbackGains.length;o++)r.feedbackGains[o].gain.cancelScheduledValues(t).setValueAtTime(s,t)}getChorusFeedback(e){return e*.00763}setChorusSendToReverb(e,t){let s=this.getChorusSendToReverb(e),r=this.chorusEffect.sendGain;0<this.chorus.sendToReverb?(this.chorus.sendToReverb=s,0<s?r.gain.cancelScheduledValues(t).setValueAtTime(s,t):r.disconnect()):(this.chorus.sendToReverb=s,0<s&&(r.connect(this.reverbEffect.input),r.gain.cancelScheduledValues(t).setValueAtTime(s,t)))}getChorusSendToReverb(e){return e*.00787}getChannelBitmap(e){let t=new Array(this.channels.length).fill(!1),s=e[4]&3,r=e[5]&127,o=e[6]&127;for(let n=0;n<7;n++)o&1<<n&&(t[n]=!0);for(let n=0;n<7;n++)r&1<<n&&(t[n+7]=!0);for(let n=0;n<2;n++)s&1<<n&&(t[n+14]=!0);return t}handleScaleOctaveTuning1ByteFormatSysEx(e,t,s){if(e.length<19){console.error("Data length is too short");return}let r=this.getChannelBitmap(e);for(let o=0;o<r.length;o++){if(!r[o])continue;let n=this.channels[o];if(!n.isDrum){for(let a=0;a<12;a++){let l=e[a+7]-64;n.scaleOctaveTuningTable[a]=l}t&&this.updateChannelDetune(n,s)}}}handleScaleOctaveTuning2ByteFormatSysEx(e,t,s){if(e.length<31){console.error("Data length is too short");return}let r=this.getChannelBitmap(e);for(let o=0;o<r.length;o++){if(!r[o])continue;let n=this.channels[o];if(!n.isDrum){for(let a=0;a<12;a++){let l=7+a*2,u=e[l]&127,h=e[l+1]&127,f=(u*128+h-8192)/8.192;n.scaleOctaveTuningTable[a]=f}t&&this.updateChannelDetune(n,s)}}}getPitchControl(e,t){let s=e.polyphonicKeyPressureTable[0];return s<=0?0:(s-64)*t.pressure*t.pressure/37.5}getFilterCutoffControl(e,t){let s=e.channelPressureTable[1],r=0<=s?(s-64)*e.state.channelPressure:0,o=e.polyphonicKeyPressureTable[1],n=0<=o?(o-64)*t.pressure:0;return(r+n)*15}getAmplitudeControl(e,t){let s=e.channelPressureTable[2],r=0<=s?e.state.channelPressure*127/s:0,o=e.polyphonicKeyPressureTable[2],n=0<=o?t.pressure/o:0;return r+n}getLFOPitchDepth(e,t){let s=e.channelPressureTable[3],r=0<=s?s*e.state.channelPressure:0,o=e.polyphonicKeyPressureTable[3],n=0<=o?o*t.pressure:0;return(r+n)/254*600}getLFOFilterDepth(e,t){let s=e.channelPressureTable[4],r=0<=s?s*e.state.channelPressure:0,o=e.polyphonicKeyPressureTable[4],n=0<=o?o*t.pressure:0;return(r+n)/254*2400}getLFOAmplitudeDepth(e,t){let s=e.channelPressureTable[5],r=0<=s?s*e.state.channelPressure:0,o=e.polyphonicKeyPressureTable[5],n=0<=o?o*t.pressure:0;return(r+n)/254}setEffects(e,t,s,r){0<s[0]&&(this.isPortamento(e,t)?this.setPortamentoDetune(e,t,r):this.setDetune(e,t,r)),.5<=e.state.portamemento&&0<=t.portamentoNoteNumber?(0<s[1]&&this.setPortamentoFilterEnvelope(e,t,r),0<s[2]&&this.setPortamentoVolumeEnvelope(e,t,r)):(0<s[1]&&this.setFilterEnvelope(e,t,r),0<s[2]&&this.setVolumeEnvelope(e,t,r)),0<s[3]&&this.setModLfoToPitch(e,t,r),0<s[4]&&this.setModLfoToFilterFc(e,t,r),0<s[5]&&this.setModLfoToVolume(e,t,r)}handlePressureSysEx(e,t,s){let r=e[4],o=this.channels[r];if(o.isDrum)return;let n=o[t];for(let a=5;a<e.length-1;a+=2){let l=e[a],u=e[a+1];n[l]=u}this.processActiveNotes(o,s,a=>{this.setEffects(o,a,n,s)})}initControlTable(){return new Int8Array(768).fill(-1)}setControlChangeEffects(e,t,s){let o=t*6,n=e.controlTable.subarray(o,o+6);this.processScheduledNotes(e,a=>{this.setEffects(e,a,n,s)})}handleControlChangeSysEx(e,t){let s=e[4],r=this.channels[s];if(r.isDrum)return;let o=6,n=e[5],a=n*o,l=r.controlTable;for(let u=6;u<e.length;u+=2){let h=e[u],d=e[u+1];l[a+h]=d}this.setControlChangeEffects(r,n,t)}getKeyBasedValue(e,t,s){let r=t*128+s;return e.keyBasedTable[r]}createKeyBasedControllerHandlers(){let e=new Array(128);return e[7]=(t,s,r)=>this.updateKeyBasedVolume(t,s,r),e[10]=(t,s,r)=>this.updateKeyBasedVolume(t,s,r),e[71]=(t,s,r)=>this.processScheduledNotes(t,o=>{if(o.noteNumber===s){let n=this.getRelativeKeyBasedValue(t,o,71),a=o.voiceParams.initialFilterQ/5*n;o.filterNode.Q.setValueAtTime(a,r)}}),e[73]=(t,s,r)=>this.processScheduledNotes(t,o=>{o.noteNumber===s&&this.setVolumeEnvelope(t,o,r)}),e[74]=(t,s,r)=>this.processScheduledNotes(t,o=>{o.noteNumber===s&&this.setFilterEnvelope(t,o,r)}),e[75]=(t,s,r)=>this.processScheduledNotes(t,o=>{o.noteNumber===s&&this.setVolumeEnvelope(t,o,r)}),e[76]=(t,s,r)=>{t.state.vibratoDepth<=0||this.processScheduledNotes(t,o=>{o.noteNumber===s&&this.setFreqVibLFO(t,o,r)})},e[77]=(t,s,r)=>{t.state.vibratoDepth<=0||this.processScheduledNotes(t,o=>{o.noteNumber===s&&this.setVibLfoToPitch(t,o,r)})},e[78]=(t,s)=>{t.state.vibratoDepth<=0||this.processScheduledNotes(t,r=>{r.noteNumber===s&&this.setDelayVibLFO(t,r)})},e[91]=(t,s,r)=>this.processScheduledNotes(t,o=>{o.noteNumber===s&&this.setReverbSend(t,o,r)}),e[93]=(t,s,r)=>this.processScheduledNotes(t,o=>{o.noteNumber===s&&this.setChorusSend(t,o,r)}),e}handleKeyBasedInstrumentControlSysEx(e,t){let s=e[4],r=this.channels[s];if(!r.isDrum)return;let o=e[5],n=r.keyBasedTable;for(let a=6;a<e.length;a+=2){let l=e[a],u=e[a+1],h=o*128+l;n[h]=u;let d=this.keyBasedControllerHandlers[l];d&&d(r,o,t)}}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(s=>{let r=new AudioBufferSourceNode(this.audioContext,{buffer:this.schedulerBuffer});r.connect(this.scheduler),r.onended=()=>{try{e()}finally{r.disconnect(),s()}},r.start(t)})}};export{Re as Midy};
