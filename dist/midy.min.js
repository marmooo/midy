var le=Object.create;var Z=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var de=Object.getOwnPropertyNames;var fe=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty;var q=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var pe=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of de(e))!me.call(i,r)&&r!==t&&Z(i,r,{get:()=>e[r],enumerable:!(n=he(e,r))||n.enumerable});return i};var be=(i,e,t)=>(t=i!=null?le(fe(i)):{},pe(e||!i||!i.__esModule?Z(t,"default",{value:i,enumerable:!0}):t,i));var X=q((je,J)=>{function ge(i){var e=new v(i),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var n=ve(t.data),r=[],o=0;!e.eof()&&o<n.numTracks;o++){var s=e.readChunk();if(s.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+s.id+"'";var a=ye(s.data);r.push(a)}return{header:n,tracks:r}}function ve(i){var e=new v(i),t=e.readUInt16(),n=e.readUInt16(),r={format:t,numTracks:n},o=e.readUInt16();return o&32768?(r.framesPerSecond=256-(o>>8),r.ticksPerFrame=o&255):r.ticksPerBeat=o,r}function ye(i){for(var e=new v(i),t=[];!e.eof();){var n=o();t.push(n)}return t;var r;function o(){var s={};s.deltaTime=e.readVarInt();var a=e.readUInt8();if((a&240)===240)if(a===255){s.meta=!0;var c=e.readUInt8(),u=e.readVarInt();switch(c){case 0:if(s.type="sequenceNumber",u!==2)throw"Expected length for sequenceNumber event is 2, got "+u;return s.number=e.readUInt16(),s;case 1:return s.type="text",s.text=e.readString(u),s;case 2:return s.type="copyrightNotice",s.text=e.readString(u),s;case 3:return s.type="trackName",s.text=e.readString(u),s;case 4:return s.type="instrumentName",s.text=e.readString(u),s;case 5:return s.type="lyrics",s.text=e.readString(u),s;case 6:return s.type="marker",s.text=e.readString(u),s;case 7:return s.type="cuePoint",s.text=e.readString(u),s;case 32:if(s.type="channelPrefix",u!=1)throw"Expected length for channelPrefix event is 1, got "+u;return s.channel=e.readUInt8(),s;case 33:if(s.type="portPrefix",u!=1)throw"Expected length for portPrefix event is 1, got "+u;return s.port=e.readUInt8(),s;case 47:if(s.type="endOfTrack",u!=0)throw"Expected length for endOfTrack event is 0, got "+u;return s;case 81:if(s.type="setTempo",u!=3)throw"Expected length for setTempo event is 3, got "+u;return s.microsecondsPerBeat=e.readUInt24(),s;case 84:if(s.type="smpteOffset",u!=5)throw"Expected length for smpteOffset event is 5, got "+u;var l=e.readUInt8(),h={0:24,32:25,64:29,96:30};return s.frameRate=h[l&96],s.hour=l&31,s.min=e.readUInt8(),s.sec=e.readUInt8(),s.frame=e.readUInt8(),s.subFrame=e.readUInt8(),s;case 88:if(s.type="timeSignature",u!=2&&u!=4)throw"Expected length for timeSignature event is 4 or 2, got "+u;return s.numerator=e.readUInt8(),s.denominator=1<<e.readUInt8(),u===4?(s.metronome=e.readUInt8(),s.thirtyseconds=e.readUInt8()):(s.metronome=36,s.thirtyseconds=8),s;case 89:if(s.type="keySignature",u!=2)throw"Expected length for keySignature event is 2, got "+u;return s.key=e.readInt8(),s.scale=e.readUInt8(),s;case 127:return s.type="sequencerSpecific",s.data=e.readBytes(u),s;default:return s.type="unknownMeta",s.data=e.readBytes(u),s.metatypeByte=c,s}}else if(a==240){s.type="sysEx";var u=e.readVarInt();return s.data=e.readBytes(u),s}else if(a==247){s.type="endSysEx";var u=e.readVarInt();return s.data=e.readBytes(u),s}else throw"Unrecognised MIDI event type byte: "+a;else{var f;if((a&128)===0){if(r===null)throw"Running status byte encountered before status byte";f=a,a=r,s.running=!0}else f=e.readUInt8(),r=a;var m=a>>4;switch(s.channel=a&15,m){case 8:return s.type="noteOff",s.noteNumber=f,s.velocity=e.readUInt8(),s;case 9:var p=e.readUInt8();return s.type=p===0?"noteOff":"noteOn",s.noteNumber=f,s.velocity=p,p===0&&(s.byte9=!0),s;case 10:return s.type="noteAftertouch",s.noteNumber=f,s.amount=e.readUInt8(),s;case 11:return s.type="controller",s.controllerType=f,s.value=e.readUInt8(),s;case 12:return s.type="programChange",s.programNumber=f,s;case 13:return s.type="channelAftertouch",s.amount=f,s;case 14:return s.type="pitchBend",s.value=f+(e.readUInt8()<<7)-8192,s;default:throw"Unrecognised MIDI event type: "+m}}}}function v(i){this.buffer=i,this.bufferLen=this.buffer.length,this.pos=0}v.prototype.eof=function(){return this.pos>=this.bufferLen};v.prototype.readUInt8=function(){var i=this.buffer[this.pos];return this.pos+=1,i};v.prototype.readInt8=function(){var i=this.readUInt8();return i&128?i-256:i};v.prototype.readUInt16=function(){var i=this.readUInt8(),e=this.readUInt8();return(i<<8)+e};v.prototype.readInt16=function(){var i=this.readUInt16();return i&32768?i-65536:i};v.prototype.readUInt24=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(i<<16)+(e<<8)+t};v.prototype.readInt24=function(){var i=this.readUInt24();return i&8388608?i-16777216:i};v.prototype.readUInt32=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8();return(i<<24)+(e<<16)+(t<<8)+n};v.prototype.readBytes=function(i){var e=this.buffer.slice(this.pos,this.pos+i);return this.pos+=i,e};v.prototype.readString=function(i){var e=this.readBytes(i);return String.fromCharCode.apply(null,e)};v.prototype.readVarInt=function(){for(var i=0;!this.eof();){var e=this.readUInt8();if(e&128)i+=e&127,i<<=7;else return i+e}return i};v.prototype.readChunk=function(){var i=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:i,length:e,data:t}};J.exports=ge});var _=q((qe,Y)=>{function we(i,e){if(typeof i!="object")throw"Invalid MIDI data";e=e||{};var t=i.header||{},n=i.tracks||[],r,o=n.length,s=new g;for(Se(s,t,o),r=0;r<o;r++)Te(s,n[r],e);return s.buffer}function Se(i,e,t){var n=e.format==null?1:e.format,r=128;e.timeDivision?r=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?r=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(r=e.ticksPerBeat&32767);var o=new g;o.writeUInt16(n),o.writeUInt16(t),o.writeUInt16(r),i.writeChunk("MThd",o.buffer)}function Te(i,e,t){var n=new g,r,o=e.length,s=null;for(r=0;r<o;r++)(t.running===!1||!t.running&&!e[r].running)&&(s=null),s=xe(n,e[r],s,t.useByte9ForNoteOff);i.writeChunk("MTrk",n.buffer)}function xe(i,e,t,n){var r=e.type,o=e.deltaTime,s=e.text||"",a=e.data||[],c=null;switch(i.writeVarInt(o),r){case"sequenceNumber":i.writeUInt8(255),i.writeUInt8(0),i.writeVarInt(2),i.writeUInt16(e.number);break;case"text":i.writeUInt8(255),i.writeUInt8(1),i.writeVarInt(s.length),i.writeString(s);break;case"copyrightNotice":i.writeUInt8(255),i.writeUInt8(2),i.writeVarInt(s.length),i.writeString(s);break;case"trackName":i.writeUInt8(255),i.writeUInt8(3),i.writeVarInt(s.length),i.writeString(s);break;case"instrumentName":i.writeUInt8(255),i.writeUInt8(4),i.writeVarInt(s.length),i.writeString(s);break;case"lyrics":i.writeUInt8(255),i.writeUInt8(5),i.writeVarInt(s.length),i.writeString(s);break;case"marker":i.writeUInt8(255),i.writeUInt8(6),i.writeVarInt(s.length),i.writeString(s);break;case"cuePoint":i.writeUInt8(255),i.writeUInt8(7),i.writeVarInt(s.length),i.writeString(s);break;case"channelPrefix":i.writeUInt8(255),i.writeUInt8(32),i.writeVarInt(1),i.writeUInt8(e.channel);break;case"portPrefix":i.writeUInt8(255),i.writeUInt8(33),i.writeVarInt(1),i.writeUInt8(e.port);break;case"endOfTrack":i.writeUInt8(255),i.writeUInt8(47),i.writeVarInt(0);break;case"setTempo":i.writeUInt8(255),i.writeUInt8(81),i.writeVarInt(3),i.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":i.writeUInt8(255),i.writeUInt8(84),i.writeVarInt(5);var u={24:0,25:32,29:64,30:96},l=e.hour&31|u[e.frameRate];i.writeUInt8(l),i.writeUInt8(e.min),i.writeUInt8(e.sec),i.writeUInt8(e.frame),i.writeUInt8(e.subFrame);break;case"timeSignature":i.writeUInt8(255),i.writeUInt8(88),i.writeVarInt(4),i.writeUInt8(e.numerator);var h=Math.floor(Math.log(e.denominator)/Math.LN2)&255;i.writeUInt8(h),i.writeUInt8(e.metronome),i.writeUInt8(e.thirtyseconds||8);break;case"keySignature":i.writeUInt8(255),i.writeUInt8(89),i.writeVarInt(2),i.writeInt8(e.key),i.writeUInt8(e.scale);break;case"sequencerSpecific":i.writeUInt8(255),i.writeUInt8(127),i.writeVarInt(a.length),i.writeBytes(a);break;case"unknownMeta":e.metatypeByte!=null&&(i.writeUInt8(255),i.writeUInt8(e.metatypeByte),i.writeVarInt(a.length),i.writeBytes(a));break;case"sysEx":i.writeUInt8(240),i.writeVarInt(a.length),i.writeBytes(a);break;case"endSysEx":i.writeUInt8(247),i.writeVarInt(a.length),i.writeBytes(a);break;case"noteOff":var f=n!==!1&&e.byte9||n&&e.velocity==0?144:128;c=f|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.velocity);break;case"noteOn":c=144|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.velocity);break;case"noteAftertouch":c=160|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.amount);break;case"controller":c=176|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.controllerType),i.writeUInt8(e.value);break;case"programChange":c=192|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.programNumber);break;case"channelAftertouch":c=208|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.amount);break;case"pitchBend":c=224|e.channel,c!==t&&i.writeUInt8(c);var m=8192+e.value,p=m&127,y=m>>7&127;i.writeUInt8(p),i.writeUInt8(y);break;default:throw"Unrecognized event type: "+r}return c}function g(){this.buffer=[]}g.prototype.writeUInt8=function(i){this.buffer.push(i&255)};g.prototype.writeInt8=g.prototype.writeUInt8;g.prototype.writeUInt16=function(i){var e=i>>8&255,t=i&255;this.writeUInt8(e),this.writeUInt8(t)};g.prototype.writeInt16=g.prototype.writeUInt16;g.prototype.writeUInt24=function(i){var e=i>>16&255,t=i>>8&255,n=i&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n)};g.prototype.writeInt24=g.prototype.writeUInt24;g.prototype.writeUInt32=function(i){var e=i>>24&255,t=i>>16&255,n=i>>8&255,r=i&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(r)};g.prototype.writeInt32=g.prototype.writeUInt32;g.prototype.writeBytes=function(i){this.buffer=this.buffer.concat(Array.prototype.slice.call(i,0))};g.prototype.writeString=function(i){var e,t=i.length,n=[];for(e=0;e<t;e++)n.push(i.codePointAt(e));this.writeBytes(n)};g.prototype.writeVarInt=function(i){if(i<0)throw"Cannot write negative variable-length integer";if(i<=127)this.writeUInt8(i);else{var e=i,t=[];for(t.push(e&127),e>>=7;e;){var n=e&127|128;t.push(n),e>>=7}this.writeBytes(t.reverse())}};g.prototype.writeChunk=function(i,e){this.writeString(i),this.writeUInt32(e.length),this.writeBytes(e)};Y.exports=we});var ee=q(H=>{H.parseMidi=X();H.writeMidi=_()});var ue=be(ee());var S=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,n=t+e,r=this.data;this.offset=n;let o=n;for(let c=t+1;c<n;c++)if(r[c]===0){o=c;break}let s=o-t,a=new Array(s);for(let c=0;c<s;c++)a[c]=r[t+c];return String.fromCharCode(...a)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function $(i,e,t){let n=new S(i,e),r=n.readString(4),o=n.readDWORD(t);return new W(r,o,n.offset)}function K(i,e=0,t,{padding:n=!0,bigEndian:r=!1}={}){let o=[],s=t+e,a=e;for(;a<s;){let c=$(i,a,r);a=c.offset+c.size,n&&(a-e&1)===1&&a++,o.push(c)}return o}var W=class{constructor(e,t,n){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:n})}};var F=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var z=class i{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),n=e.readInt8();return new i(t,n)}},B=class i{constructor(e,t,n,r,o,s,a,c,u,l,h){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:h})}static parse(e,t){function n(T){for(let b=0;b<t.length;b++)if(t[b].type===T)return t[b]}function r(T){return new S(e,T.offset)}function o(T){let b=n(T);return b?r(b).readString(b.size):null}function s(T){let b=n(T);return b?z.parse(r(b)):null}let a=o("ICMT"),c=o("ICOP"),u=o("ICRD"),l=o("IENG"),h=o("INAM"),f=o("IPRD"),m=o("ISFT"),p=s("ifil"),y=o("isng"),k=o("irom"),O=s("iver");return new i(a,c,u,l,h,f,m,p,y,k,O)}},R=class i{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),n=e.readWORD();return new i(t,n)}},V=class i{constructor(e,t,n,r,o,s,a){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:a})}get isEnd(){return this.presetName==="EOP"}static parse(e){let t=e.readString(20),n=e.readWORD(),r=e.readWORD(),o=e.readWORD(),s=e.readDWORD(),a=e.readDWORD(),c=e.readDWORD();return new i(t,n,r,o,s,a,c)}},P=class i{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),n=e.readByte();return new i(t,n)}},C=class i{constructor(e,t,n,r,o){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:o})}static parse(e){let t=e.readWORD(),n=e.readWORD(),r=e.readInt16(),o=e.readWORD(),s=e.readWORD();return new i(t,n,r,o,s)}},D=class i{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return F[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),n=F[t],r;switch(n){case"keyRange":case"velRange":r=P.parse(e);break;default:r=e.readInt16();break}return new i(t,r)}},U=class i{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new i;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},A=class i{constructor(e,t,n,r,o,s,a,c,u,l){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:l})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let n=e.readString(20),r=e.readDWORD(),o=e.readDWORD(),s=e.readDWORD(),a=e.readDWORD(),c=e.readDWORD(),u=e.readByte(),l=e.readInt8(),h=e.readWORD(),f=e.readWORD();return t||(s-=r,a-=r),new i(n,r,o,s,a,c,u,l,h,f)}};var d=class{constructor(e,t,n){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.value=t,this.max=n}clamp(){return Math.max(this.min,Math.min(this.value,this.max))}};function te(i,e={}){let t=K(i,0,i.length,e);if(t.length!==1)throw new Error("wrong chunk length");let n=t[0];if(n===null)throw new Error("chunk not found");function r(c,u,l={}){let h=L(c,u,"RIFF","sfbk",l);if(h.length!==3)throw new Error("invalid sfbk structure");let f=ke(h[0],u),m=f.version.major===3;return m&&h[2].type!=="LIST"&&(h[2]=$(u,h[2].offset-9,!1)),{info:f,samplingData:Ie(h[1],u),...o(h[2],u,m)}}function o(c,u,l){let h=L(c,u,"LIST","pdta");if(h.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:Pe(h[0],u),presetZone:Fe(h[1],u),presetModulators:Me(h[2],u),presetGenerators:Ce(h[3],u),instruments:Ee(h[4],u),instrumentZone:Oe(h[5],u),instrumentModulators:Re(h[6],u),instrumentGenerators:De(h[7],u),sampleHeaders:Ne(h[8],u,l)}}let s=r(n,i,e),a=s.info.version.major===3;return{...s,samples:Be(s.sampleHeaders,s.samplingData.offsetMSB,s.samplingData.offsetLSB,i,a)}}function L(i,e,t,n,r={}){if(i.type!==t)throw new Error("invalid chunk type:"+i.type);let o=new S(e,i.offset),s=o.readString(4);if(s!==n)throw new Error("invalid signature:"+s);return K(e,o.offset,i.size-4,r)}function ke(i,e){let t=L(i,e,"LIST","INFO");return B.parse(e,t)}function Ie(i,e){let t=L(i,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function x(i,e,t,n,r,o){let s=[];if(i.type!==t)throw new Error("invalid chunk type:"+i.type);let a=new S(e,i.offset),c=i.offset+i.size;for(;a.offset<c;){let u=n.parse(a,o);if(r&&r(u))break;s.push(u)}return s}var Pe=(i,e)=>x(i,e,"phdr",V,t=>t.isEnd),Fe=(i,e)=>x(i,e,"pbag",R),Ee=(i,e)=>x(i,e,"inst",U,t=>t.isEnd),Oe=(i,e)=>x(i,e,"ibag",R),Me=(i,e)=>x(i,e,"pmod",C),Re=(i,e)=>x(i,e,"imod",C),Ce=(i,e)=>x(i,e,"pgen",D,t=>t.isEnd),De=(i,e)=>x(i,e,"igen",D),Ne=(i,e,t)=>x(i,e,"shdr",A,n=>n.isEnd,t);function Be(i,e,t,n,r){let o=new Array(i.length),s=r?1:2;for(let a=0;a<i.length;a++){let{start:c,end:u}=i[a],l=e+c*s,h=e+u*s;o[a]=n.subarray(l,h)}return o}var se=new Map;for(let i=0;i<F.length;i++)se.set(F[i],i);var Ve=["keyRange","velRange"],Ue=["keynum","velocity"],Ae=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],ne=[...Ae,...Ue],oe=new Set;for(let i=0;i<ne.length;i++){let e=ne[i],t=se.get(e);t!==void 0&&oe.add(t)}var re=[["keynum","keyRange"],["velocity","velRange"]],Le=new Set(Ve);function N(i){return Le.has(i)}function ie(i){let e={};for(let t=0;t<i.length;t++){let n=i[t],r=n.type;if(r!==void 0&&!oe.has(n.code))if(N(r))e[r]=n.value;else{let o=r,s=G[o];e[o]=new d(s.min,n.value,s.max)}}return e}function ae(i){let e={};for(let t=0;t<i.length;t++){let n=i[t],r=n.type;if(r!==void 0)if(N(r))e[r]=n.value;else{let o=r,s=G[o];e[o]=new d(s.min,n.value,s.max)}}for(let t=0;t<re.length;t++){let[n,r]=re[t],o=e[n];o instanceof d&&0<=o.value&&(e[r]=new P(o.value,o.value))}return e}var E=-32768,I=32767,G={startAddrsOffset:new d(0,0,I),endAddrsOffset:new d(E,0,0),startloopAddrsOffset:new d(E,0,I),endloopAddrsOffset:new d(E,0,I),startAddrsCoarseOffset:new d(0,0,I),modLfoToPitch:new d(-12e3,0,12e3),vibLfoToPitch:new d(-12e3,0,12e3),modEnvToPitch:new d(-12e3,0,12e3),initialFilterFc:new d(1500,13500,13500),initialFilterQ:new d(0,0,960),modLfoToFilterFc:new d(-12e3,0,12e3),modEnvToFilterFc:new d(-12e3,0,12e3),endAddrsCoarseOffset:new d(E,0,0),modLfoToVolume:new d(-960,0,960),chorusEffectsSend:new d(0,0,1e3),reverbEffectsSend:new d(0,0,1e3),pan:new d(-500,0,500),delayModLFO:new d(-12e3,-12e3,5e3),freqModLFO:new d(-16e3,0,4500),delayVibLFO:new d(-12e3,-12e3,5e3),freqVibLFO:new d(-16e3,0,4500),delayModEnv:new d(-12e3,-12e3,5e3),attackModEnv:new d(-12e3,-12e3,8e3),holdModEnv:new d(-12e3,-12e3,5e3),decayModEnv:new d(-12e3,-12e3,8e3),sustainModEnv:new d(0,0,1e3),releaseModEnv:new d(-12e3,-12e3,8e3),keynumToModEnvHold:new d(-1200,0,1200),keynumToModEnvDecay:new d(-1200,0,1200),delayVolEnv:new d(-12e3,-12e3,5e3),attackVolEnv:new d(-12e3,-12e3,8e3),holdVolEnv:new d(-12e3,-12e3,5e3),decayVolEnv:new d(-12e3,-12e3,8e3),sustainVolEnv:new d(0,0,1440),releaseVolEnv:new d(-12e3,-12e3,8e3),keynumToVolEnvHold:new d(-1200,0,1200),keynumToVolEnvDecay:new d(-1200,0,1200),instrument:new d(-1,-1,I),keyRange:new P(0,127),velRange:new P(0,127),startloopAddrsCoarseOffset:new d(E,0,I),keynum:new d(-1,-1,127),velocity:new d(-1,-1,127),initialAttenuation:new d(0,0,1440),endloopAddrsCoarseOffset:new d(E,0,I),coarseTune:new d(-120,0,120),fineTune:new d(-99,0,99),sampleID:new d(-1,-1,I),sampleModes:new d(0,0,3),scaleTuning:new d(0,100,100),exclusiveClass:new d(0,0,127),overridingRootKey:new d(-1,-1,127)};var j=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.parsed=e}getGenerators(e,t,n,r){let o=new Array(r-n);for(let s=n;s<r;s++){let a=t[s].generatorIndex,c=t[s+1].generatorIndex;o[s-n]=e.slice(a,c)}return o}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],n=this.parsed.presetHeaders[e+1],r=n?n.presetBagIndex:this.parsed.presetZone.length-1;return this.getGenerators(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,r)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],n=this.parsed.instruments[e+1],r=n?n.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGenerators(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,r)}findInstrumentZone(e,t,n){let r=this.getInstrumentGenerators(e),o;for(let s=0;s<r.length;s++){let a=ae(r[s]);if(a.sampleID===void 0){o=a;continue}if(!(a.keyRange&&!a.keyRange.in(t))&&!(a.velRange&&!a.velRange.in(n)))return o?{...o,...a}:a}}findInstrument(e,t,n){let r=this.getPresetGenerators(e),o;for(let s=0;s<r.length;s++){let a=ie(r[s]);if(a.instrument===void 0){o=a;continue}if(a.keyRange&&!a.keyRange.in(t)||a.velRange&&!a.velRange.in(n))continue;let c=this.findInstrumentZone(a.instrument.value,t,n);if(c)return o?this.getInstrument({...o,...a},c):this.getInstrument(a,c)}return null}getInstrument(e,t){let n={...G,...t},r=Object.keys(e);for(let o=0;o<r.length;o++){let s=r[o];if(N(s))continue;let a=n[s],c=e[s];n[s]=new d(a.min,a.value+c.value,a.max)}return n}getInstrumentKey(e,t,n,r){let o=this.parsed.presetHeaders.findIndex(b=>b.preset===t&&b.bank===e);if(o<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let s=this.findInstrument(o,n,r);if(!s)return console.warn("instrument not found: bank=%s instrument=%s",e,t),null;let a={},c=Object.keys(s);for(let b=0;b<c.length;b++){let M=c[b];N(M)?a[M]=s[M]:a[M]=s[M].clamp()}let u=w(a.holdModEnv+(n-60)*a.keynumToModEnvHold),l=w(a.decayModEnv+(n-60)*a.keynumToModEnvDecay),h=w(a.holdVolEnv+(n-60)*a.keynumToVolEnvHold),f=w(a.decayVolEnv+(n-60)*a.keynumToVolEnvDecay),m=this.parsed.samples[a.sampleID],p=this.parsed.sampleHeaders[a.sampleID],y=a.coarseTune+a.fineTune/100,k=a.overridingRootKey===-1?p.originalPitch:a.overridingRootKey,O=y+p.pitchCorrection/100-k,T=a.scaleTuning/100;return{start:a.startAddrsCoarseOffset*32768+a.startAddrsOffset,end:a.endAddrsCoarseOffset*32768+a.endAddrsOffset,loopStart:p.loopStart+a.startloopAddrsCoarseOffset*32768+a.startloopAddrsOffset,loopEnd:p.loopEnd+a.endloopAddrsCoarseOffset*32768+a.endloopAddrsOffset,modLfoToPitch:a.modLfoToPitch,vibLfoToPitch:a.vibLfoToPitch,modEnvToPitch:a.modEnvToPitch,initialFilterFc:a.initialFilterFc,initialFilterQ:a.initialFilterQ,modLfoToFilterFc:a.modLfoToFilterFc,modEnvToFilterFc:a.modEnvToFilterFc,modLfoToVolume:a.modLfoToVolume,chorusEffectsSend:a.chorusEffectsSend/1e3,reverbEffectsSend:a.reverbEffectsSend/1e3,pan:a.pan,delayModLFO:w(a.delayModLFO),freqModLFO:a.freqModLFO,delayVibLFO:w(a.delayVibLFO),freqVibLFO:a.freqVibLFO,modDelay:w(a.delayModEnv),modAttack:w(a.attackModEnv),modHold:u,modDecay:l,modSustain:a.sustainModEnv/1e3,modRelease:w(a.releaseModEnv),volDelay:w(a.delayVolEnv),volAttack:w(a.attackVolEnv),volHold:h,volDecay:f,volSustain:a.sustainVolEnv/1e3,volRelease:w(a.releaseVolEnv),initialAttenuation:a.initialAttenuation,playbackRate:b=>Math.pow(Math.pow(2,1/12),(b+O)*T),sample:m,sampleRate:p.sampleRate,sampleName:p.sampleName,sampleModes:a.sampleModes,exclusiveClass:a.exclusiveClass}}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let n=0;n<t.length;n++){let r=t[n];e[r.bank]||(e[r.bank]={}),e[r.bank][r.preset]=r.presetName}return e}};function w(i){return Math.pow(2,i/1200)}var Q=class{bufferSource;filterNode;volumeNode;volumeDepth;modulationLFO;modulationDepth;vibratoLFO;vibratoDepth;reverbEffectsSend;chorusEffectsSend;constructor(e,t,n,r){this.noteNumber=e,this.velocity=t,this.startTime=n,this.instrumentKey=r}},ce=class{ticksPerBeat=120;totalTime=0;masterFineTuning=0;masterCoarseTuning=0;reverb={time:this.getReverbTime(64),feedback:.8};chorus={modRate:this.getChorusModRate(3),modDepth:this.getChorusModDepth(19),feedback:this.getChorusFeedback(8),sendToReverb:this.getChorusSendToReverb(0),delayTimes:this.generateDistributedArray(.02,2,.5)};mono=!1;omni=!1;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=this.initSoundFontTable();isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;timeline=[];instruments=[];notePromises=[];exclusiveClassMap=new Map;static channelSettings={currentBufferSource:null,volume:100/127,pan:64,portamentoTime:1,filterResonance:1,releaseTime:1,attackTime:1,brightness:1,decayTime:1,reverbSendLevel:0,chorusSendLevel:0,vibratoRate:1,vibratoDepth:1,vibratoDelay:1,bank:121*128,bankMSB:121,bankLSB:0,dataMSB:0,dataLSB:0,program:0,pitchBend:0,fineTuning:0,coarseTuning:0,modulationDepthRange:50};static effectSettings={expression:1,modulationDepth:0,sustainPedal:!1,portamento:!1,sostenutoPedal:!1,softPedal:0,rpnMSB:127,rpnLSB:127,channelPressure:0,pitchBendRange:2};static controllerDestinationSettings={pitchControl:0,filterCutoffControl:0,amplitudeControl:1,lfoPitchDepth:0,lfoFilterDepth:0,lfoAmplitudeDepth:0};defaultOptions={reverbAlgorithm:e=>{let{time:t,feedback:n}=this.reverb,r=this.generateDistributedArray(n,4),o=r.map(c=>this.calcDelay(t,c)),s=this.generateDistributedArray(n,4),a=s.map(c=>this.calcDelay(t,c));return this.createSchroederReverb(e,r,o,s,a)}};constructor(e,t=this.defaultOptions){this.audioContext=e,this.options={...this.defaultOptions,...t},this.masterGain=new GainNode(e),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.reverbEffect=this.options.reverbAlgorithm(e),this.chorusEffect=this.createChorusEffect(e),this.chorusEffect.output.connect(this.masterGain),this.reverbEffect.output.connect(this.masterGain),this.masterGain.connect(e.destination),this.GM2SystemOn()}initSoundFontTable(){let e=new Array(128);for(let t=0;t<128;t++)e[t]=new Map;return e}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let n=e.parsed.presetHeaders;for(let r=0;r<n.length;r++){let o=n[r];o.presetName.startsWith("\0")||this.soundFontTable[o.preset].set(o.bank,t)}}async loadSoundFont(e){let n=await(await fetch(e)).arrayBuffer(),r=te(new Uint8Array(n)),o=new j(r);this.addSoundFont(o)}async loadMIDI(e){let n=await(await fetch(e)).arrayBuffer(),r=(0,ue.parseMidi)(new Uint8Array(n));this.ticksPerBeat=r.header.ticksPerBeat;let o=this.extractMidiData(r);this.instruments=o.instruments,this.timeline=o.timeline,this.totalTime=this.calcTotalTime()}setChannelAudioNodes(e){let{gainLeft:t,gainRight:n}=this.panToGain(this.constructor.channelSettings.pan),r=new GainNode(e,{gain:t}),o=new GainNode(e,{gain:n}),s=new ChannelMergerNode(e,{numberOfInputs:2});return r.connect(s,0,0),o.connect(s,0,1),s.connect(this.masterGain),{gainL:r,gainR:o,merger:s}}createChannels(e){return Array.from({length:16},()=>({...this.constructor.channelSettings,...this.constructor.effectSettings,...this.setChannelAudioNodes(e),scheduledNotes:new Map,sostenutoNotes:new Map,polyphonicKeyPressure:{...this.constructor.controllerDestinationSettings},channelPressure:{...this.constructor.controllerDestinationSettings}}))}async createNoteBuffer(e,t){let n=e.start,r=e.sample.length+e.end;if(t){let o=e.sample,s=o.byteOffset+n,a=o.byteOffset+r,c=o.buffer.slice(s,a);return await this.audioContext.decodeAudioData(c)}else{let o=e.sample,s=o.byteOffset+n,a=o.byteOffset+r,c=o.buffer.slice(s,a),u=new AudioBuffer({numberOfChannels:1,length:o.length,sampleRate:e.sampleRate}),l=u.getChannelData(0),h=new Int16Array(c);for(let f=0;f<h.length;f++)l[f]=h[f]/32768;return u}}async createNoteBufferNode(e,t){let n=new AudioBufferSourceNode(this.audioContext),r=await this.createNoteBuffer(e,t);return n.buffer=r,n.loop=e.sampleModes%2!==0,n.loop&&(n.loopStart=e.loopStart/e.sampleRate,n.loopEnd=e.loopEnd/e.sampleRate),n}findPortamentoTarget(e){let t=this.timeline[e];if(!this.channels[t.channel].portamento)return;let n=t.startTime,r;for(;++e<this.timeline.length;){let o=this.timeline[e];if(n!==o.startTime)break;o.type==="noteOn"&&(!r||o.noteNumber<r.noteNumber)&&(r=o)}return r}async scheduleTimelineEvents(e,t,n){for(;n<this.timeline.length;){let r=this.timeline[n];if(r.startTime>e+this.lookAhead)break;switch(r.type){case"noteOn":if(r.velocity!==0){await this.scheduleNoteOn(r.channel,r.noteNumber,r.velocity,r.startTime+this.startDelay-t,r.portamento);break}case"noteOff":{let o=this.findPortamentoTarget(n);o&&(o.portamento=!0);let s=this.scheduleNoteRelease(this.omni?0:r.channel,r.noteNumber,r.velocity,r.startTime+this.startDelay-t,o?.noteNumber,!1);s&&this.notePromises.push(s);break}case"noteAftertouch":this.handlePolyphonicKeyPressure(r.channel,r.noteNumber,r.amount);break;case"controller":this.handleControlChange(this.omni?0:r.channel,r.controllerType,r.value);break;case"programChange":this.handleProgramChange(r.channel,r.programNumber);break;case"channelAftertouch":this.handleChannelPressure(r.channel,r.amount);break;case"pitchBend":this.setPitchBend(r.channel,r.value);break;case"sysEx":this.handleSysEx(r.data)}n++}return n}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}playNotes(){return new Promise(e=>{this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime;this.notePromises=[];let r=async()=>{if(t>=this.timeline.length){await Promise.all(this.notePromises),this.notePromises=[],this.exclusiveClassMap.clear(),e();return}let o=this.audioContext.currentTime+n;if(t=await this.scheduleTimelineEvents(o,n,t),this.isPausing){await this.stopNotes(0,!0),this.notePromises=[],e(),this.isPausing=!1,this.isPaused=!0;return}else if(this.isStopping){await this.stopNotes(0,!0),this.exclusiveClassMap.clear(),this.notePromises=[],e(),this.isStopping=!1,this.isPaused=!1;return}else if(this.isSeeking)this.stopNotes(0,!0),this.exclusiveClassMap.clear(),this.startTime=this.audioContext.currentTime,t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime,this.isSeeking=!1,await r();else{let a=this.audioContext.currentTime+this.noteCheckInterval;await this.scheduleTask(()=>{},a),await r()}};r()})}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}extractMidiData(e){let t=new Set,n=[],r=new Array(16);for(let u=0;u<r.length;u++)r[u]={programNumber:-1,bankMSB:this.channels[u].bankMSB,bankLSB:this.channels[u].bankLSB};for(let u=0;u<e.tracks.length;u++){let l=e.tracks[u],h=0;for(let f=0;f<l.length;f++){let m=l[f];switch(h+=m.deltaTime,m.ticks=h,m.type){case"noteOn":{let p=r[m.channel];if(p.programNumber<0){switch(p.programNumber=m.programNumber,p.bankMSB){case 120:t.add("128:0");break;case 121:t.add(`${p.bankLSB}:0`);break;default:{let y=p.bankMSB*128+p.bankLSB;t.add(`${y}:0`)}}p.programNumber=0}break}case"controller":switch(m.controllerType){case 0:r[m.channel].bankMSB=m.value;break;case 32:r[m.channel].bankLSB=m.value;break}break;case"programChange":{let p=r[m.channel];switch(p.programNumber=m.programNumber,p.bankMSB){case 120:t.add(`128:${p.programNumber}`);break;case 121:t.add(`${p.bankLSB}:${p.programNumber}`);break;default:{let y=p.bankMSB*128+p.bankLSB;t.add(`${y}:${p.programNumber}`)}}}}delete m.deltaTime,n.push(m)}}let o={controller:0,sysEx:1,noteOff:2,noteOn:3};n.sort((u,l)=>u.ticks!==l.ticks?u.ticks-l.ticks:(o[u.type]||4)-(o[l.type]||4));let s=0,a=0,c=.5;for(let u=0;u<n.length;u++){let l=n[u],h=this.ticksToSecond(l.ticks-a,c);l.startTime=s+h,l.type==="setTempo"&&(s+=this.ticksToSecond(l.ticks-a,c),c=l.microsecondsPerBeat/1e6,a=l.ticks)}return{instruments:t,timeline:n}}async stopChannelNotes(e,t,n){let r=this.audioContext.currentTime,o=this.channels[e];o.scheduledNotes.forEach(s=>{for(let a=0;a<s.length;a++){let c=s[a];if(!c)continue;let u=this.scheduleNoteRelease(e,c.noteNumber,t,r,void 0,n);this.notePromises.push(u)}}),o.scheduledNotes.clear(),await Promise.all(this.notePromises)}stopNotes(e,t){for(let n=0;n<this.channels.length;n++)this.stopChannelNotes(n,e,t);return Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,await this.playNotes(),this.isPlaying=!1)}stop(){this.isPlaying&&(this.isStopping=!0)}pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}async resume(){this.isPaused&&(await this.playNotes(),this.isPlaying=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let n=this.timeline[t];e<n.startTime&&(e=n.startTime)}return e}currentTime(){let e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}getActiveNotes(e,t){let n=new Map;return e.scheduledNotes.forEach(r=>{let o=this.getActiveNote(r,t);o&&n.set(o.noteNumber,o)}),n}getActiveNote(e,t){for(let n=e.length-1;n>=0;n--){let r=e[n];if(!r)return;if(!(t<r.startTime))return r.ending?null:r}return e[0]}createConvolutionReverbImpulse(e,t,n){let r=e.sampleRate,o=r*t,s=new AudioBuffer({numberOfChannels:2,length:o,sampleRate:r}),a=Math.min(r*n,o);for(let c=0;c<s.numberOfChannels;c++){let u=s.getChannelData(c);for(let h=0;h<a;h++)u[h]=Math.random()*2-1;let l=1/(r*t);for(let h=a;h<o;h++){let f=Math.exp(-(h-a)*l);u[h]=(Math.random()*2-1)*f}}return s}createConvolutionReverb(e,t){let n=new GainNode(e),r=new ConvolverNode(e,{buffer:t});return n.connect(r),{input:n,output:r,convolverNode:r}}createCombFilter(e,t,n,r){let o=new DelayNode(e,{maxDelayTime:n,delayTime:n}),s=new GainNode(e,{gain:r});return t.connect(o),o.connect(s),s.connect(o),o}createAllpassFilter(e,t,n,r){let o=new DelayNode(e,{maxDelayTime:n,delayTime:n}),s=new GainNode(e,{gain:r}),a=new GainNode(e,{gain:1-r});return t.connect(o),o.connect(s),s.connect(o),o.connect(a),a}generateDistributedArray(e,t,n=.1,r=.05){let o=e*n,s=new Array(t);for(let a=0;a<t;a++){let c=a/(t-1||1),u=e-o+c*2*o;s[a]=u*(1-(Math.random()*2-1)*r)}return s}createSchroederReverb(e,t,n,r,o){let s=new GainNode(e),a=new GainNode(e);for(let l=0;l<n.length;l++)this.createCombFilter(e,s,n[l],t[l]).connect(a);let c=[];for(let l=0;l<o.length;l++){let h=this.createAllpassFilter(e,l===0?a:c.at(-1),o[l],r[l]);c.push(h)}let u=c.at(-1);return{input:s,output:u}}createChorusEffect(e){let t=new GainNode(e),n=new GainNode(e),r=new GainNode(e),o=new OscillatorNode(e,{frequency:this.chorus.modRate}),s=new GainNode(e,{gain:this.chorus.modDepth/2}),a=this.chorus.delayTimes,c=[],u=[];for(let l=0;l<a.length;l++){let h=a[l],f=new DelayNode(e,{maxDelayTime:.1,delayTime:h}),m=new GainNode(e,{gain:this.chorus.feedback});c.push(f),u.push(m),t.connect(f),s.connect(f.delayTime),f.connect(m),m.connect(f),f.connect(n)}return n.connect(r),o.connect(s),o.start(),{input:t,output:n,sendGain:r,lfo:o,lfoGain:s,delayNodes:c,feedbackGains:u}}cbToRatio(e){return Math.pow(10,e/200)}centToHz(e){return 8.176*Math.pow(2,e/1200)}calcSemitoneOffset(e){let t=this.masterCoarseTuning+this.masterFineTuning,n=e.coarseTuning+e.fineTuning,r=t+n;return e.pitchBend*e.pitchBendRange+r}calcPlaybackRate(e,t,n){return e.playbackRate(t)*Math.pow(2,n/12)}setPortamentoStartVolumeEnvelope(e,t){let{instrumentKey:n,startTime:r}=t,s=this.cbToRatio(-n.initialAttenuation)*(1-n.volSustain),a=r+n.volDelay,c=a+e.portamentoTime;t.volumeNode.gain.cancelScheduledValues(r).setValueAtTime(0,a).linearRampToValueAtTime(s,c)}setVolumeEnvelope(e,t){let{instrumentKey:n,startTime:r}=t,o=this.cbToRatio(-n.initialAttenuation),s=o*(1-n.volSustain),a=r+n.volDelay,c=a+n.volAttack*e.attackTime,u=c+n.volHold,l=u+n.volDecay*e.decayTime;t.volumeNode.gain.cancelScheduledValues(r).setValueAtTime(0,r).setValueAtTime(1e-6,a).exponentialRampToValueAtTime(o,c).setValueAtTime(o,u).linearRampToValueAtTime(s,l)}setPitch(e,t){let{instrumentKey:n,noteNumber:r,startTime:o}=e,s=n.modEnvToPitch/100;if(e.bufferSource.playbackRate.value=this.calcPlaybackRate(n,r,t),s===0)return;let a=e.bufferSource.playbackRate.value,c=this.calcPlaybackRate(n,r,t+s),u=o+n.modDelay,l=u+n.modAttack,h=l+n.modHold,f=h+n.modDecay;e.bufferSource.playbackRate.value.setValueAtTime(a,u).exponentialRampToValueAtTime(c,l).setValueAtTime(c,h).linearRampToValueAtTime(a,f)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setPortamentoStartFilterEnvelope(e,t){let{instrumentKey:n,noteNumber:r,startTime:o}=t,s=1-(.1+r/127*.2)*e.softPedal,a=this.centToHz(n.initialFilterFc)*s*e.brightness,c=this.centToHz(n.initialFilterFc+n.modEnvToFilterFc)*s*e.brightness,u=a+(c-a)*(1-n.modSustain),l=this.clampCutoffFrequency(a),h=this.clampCutoffFrequency(u),f=o+e.portamentoTime,m=o+n.modDelay;t.filterNode.frequency.cancelScheduledValues(o).setValueAtTime(l,o).setValueAtTime(l,m).linearRampToValueAtTime(h,f)}setFilterEnvelope(e,t){let{instrumentKey:n,noteNumber:r,startTime:o}=t,s=1-(.1+r/127*.2)*e.softPedal,a=this.centToHz(n.initialFilterFc)*s*e.brightness,c=this.centToHz(n.initialFilterFc+n.modEnvToFilterFc)*s*e.brightness,u=a+(c-a)*(1-n.modSustain),l=this.clampCutoffFrequency(a),h=this.clampCutoffFrequency(c),f=this.clampCutoffFrequency(u),m=o+n.modDelay,p=m+n.modAttack,y=p+n.modHold,k=y+n.modDecay;t.filterNode.frequency.cancelScheduledValues(o).setValueAtTime(l,o).setValueAtTime(l,m).exponentialRampToValueAtTime(h,p).setValueAtTime(h,y).linearRampToValueAtTime(f,k)}startModulation(e,t,n){let{instrumentKey:r}=t,{modLfoToPitch:o,modLfoToVolume:s}=r;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(r.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:r.modLfoToFilterFc});let a=Math.abs(o)+e.modulationDepth,c=0<o?1:-1;t.modulationDepth=new GainNode(this.audioContext,{gain:a*c});let u=this.cbToRatio(Math.abs(s))-1,l=0<s?1:-1;t.volumeDepth=new GainNode(this.audioContext,{gain:u*l}),t.modulationLFO.start(n+r.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeNode.gain)}startVibrato(e,t,n){let{instrumentKey:r}=t,{vibLfoToPitch:o}=r;t.vibratoLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(r.freqVibLFO)*e.vibratoRate});let s=Math.abs(o)*e.vibratoDepth,a=0<o;t.vibratoDepth=new GainNode(this.audioContext,{gain:s*a}),t.vibratoLFO.start(n+r.delayVibLFO*e.vibratoDelay),t.vibratoLFO.connect(t.vibratoDepth),t.vibratoDepth.connect(t.bufferSource.detune)}async createNote(e,t,n,r,o,s,a){let c=this.calcSemitoneOffset(e),u=new Q(n,r,o,t);return u.bufferSource=await this.createNoteBufferNode(t,a),u.volumeNode=new GainNode(this.audioContext),u.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:t.initialFilterQ/10*e.filterResonance}),s?(this.setPortamentoStartVolumeEnvelope(e,u),this.setPortamentoStartFilterEnvelope(e,u)):(this.setVolumeEnvelope(e,u),this.setFilterEnvelope(e,u)),0<e.vibratoDepth&&this.startVibrato(e,u,o),0<e.modulationDepth?(this.setPitch(u,c),this.startModulation(e,u,o)):u.bufferSource.playbackRate.value=this.calcPlaybackRate(t,n,c),this.mono&&e.currentBufferSource&&(e.currentBufferSource.stop(o),e.currentBufferSource=u.bufferSource),u.bufferSource.connect(u.filterNode),u.filterNode.connect(u.volumeNode),0<e.reverbSendLevel&&0<t.reverbEffectsSend&&(u.reverbEffectsSend=new GainNode(this.audioContext,{gain:t.reverbEffectsSend}),u.volumeNode.connect(u.reverbEffectsSend),u.reverbEffectsSend.connect(this.reverbEffect.input)),0<e.chorusSendLevel&&0<t.chorusEffectsSend&&(u.chorusEffectsSend=new GainNode(this.audioContext,{gain:t.chorusEffectsSend}),u.volumeNode.connect(u.chorusEffectsSend),u.chorusEffectsSend.connect(this.chorusEffect.input)),u.bufferSource.start(o),u}calcBank(e,t){return e.bankMSB===121?0:t%9<=1&&e.bankMSB===120?128:e.bank}async scheduleNoteOn(e,t,n,r,o){let s=this.channels[e],a=this.calcBank(s,e),c=this.soundFontTable[s.program].get(a);if(c===void 0)return;let u=this.soundFonts[c],l=u.parsed.info.version.major===3,h=u.getInstrumentKey(a,s.program,t,n);if(!h)return;let f=await this.createNote(s,h,t,n,r,o,l);f.volumeNode.connect(s.gainL),f.volumeNode.connect(s.gainR),s.sostenutoPedal&&s.sostenutoNotes.set(t,f);let m=h.exclusiveClass;if(m!==0){if(this.exclusiveClassMap.has(m)){let y=this.exclusiveClassMap.get(m),[k,O]=y;k.ending||this.scheduleNoteRelease(O,k.noteNumber,0,r,void 0,!0)}this.exclusiveClassMap.set(m,[f,e])}let p=s.scheduledNotes;p.has(t)?p.get(t).push(f):p.set(t,[f])}noteOn(e,t,n,r){let o=this.audioContext.currentTime;return this.scheduleNoteOn(e,t,n,o,r)}stopNote(e,t,n,r){let o=n[r];return o.volumeNode.gain.cancelScheduledValues(e).linearRampToValueAtTime(0,t),o.ending=!0,this.scheduleTask(()=>{o.bufferSource.loop=!1},t),new Promise(s=>{o.bufferSource.onended=()=>{n[r]=null,o.bufferSource.disconnect(),o.volumeNode.disconnect(),o.filterNode.disconnect(),o.modulationDepth&&(o.volumeDepth.disconnect(),o.modulationDepth.disconnect(),o.modulationLFO.stop()),o.vibratoDepth&&(o.vibratoDepth.disconnect(),o.vibratoLFO.stop()),o.reverbEffectsSend&&o.reverbEffectsSend.disconnect(),o.chorusEffectsSend&&o.chorusEffectsSend.disconnect(),s()},o.bufferSource.stop(t)})}scheduleNoteRelease(e,t,n,r,o,s){let a=this.channels[e];if(!s&&(a.sustainPedal||a.sostenutoNotes.has(t))||!a.scheduledNotes.has(t))return;let c=a.scheduledNotes.get(t);for(let u=0;u<c.length;u++){let l=c[u];if(l&&!l.ending)if(o===void 0){let h=r+l.instrumentKey.volRelease*a.releaseTime,f=r+l.instrumentKey.modRelease;l.filterNode.frequency.cancelScheduledValues(r).linearRampToValueAtTime(0,f);let m=Math.min(h,f);return this.stopNote(r,m,c,u)}else{let h=r+a.portamentoTime,f=(o-t)*100,m=l.bufferSource.detune.value+f;return l.bufferSource.detune.cancelScheduledValues(r).linearRampToValueAtTime(m,h),this.stopNote(r,h,c,u)}}}releaseNote(e,t,n,r){let o=this.audioContext.currentTime;return this.scheduleNoteRelease(e,t,n,o,r,!1)}releaseSustainPedal(e,t){let n=t*2,r=this.channels[e],o=[];return r.sustainPedal=!1,r.scheduledNotes.forEach(s=>{for(let a=0;a<s.length;a++){let c=s[a];if(!c)continue;let{noteNumber:u}=c,l=this.releaseNote(e,u,n);o.push(l)}}),o}releaseSostenutoPedal(e,t){let n=t*2,r=this.channels[e],o=[];return r.sostenutoPedal=!1,r.sostenutoNotes.forEach(s=>{let{noteNumber:a}=s,c=this.releaseNote(e,a,n);o.push(c)}),r.sostenutoNotes.clear(),o}handleMIDIMessage(e,t,n){let r=omni?0:e&15,o=e&240;switch(o){case 128:return this.releaseNote(r,t,n);case 144:return this.noteOn(r,t,n);case 160:return this.handlePolyphonicKeyPressure(r,t,n);case 176:return this.handleControlChange(r,t,n);case 192:return this.handleProgramChange(r,t);case 208:return this.handleChannelPressure(r,t);case 224:return this.handlePitchBendMessage(r,t,n);default:console.warn(`Unsupported MIDI message: ${o.toString(16)}`)}}handlePolyphonicKeyPressure(e,t,n){let r=this.audioContext.currentTime,o=this.channels[e];n/=64;let s=this.getActiveNotes(o,r);if(o.polyphonicKeyPressure.amplitudeControl!==1&&s.has(t)){let a=s.get(t),c=a.volumeNode.gain.value;a.volumeNode.gain.cancelScheduledValues(r).setValueAtTime(c*n,r)}}handleProgramChange(e,t){let n=this.channels[e];n.bank=n.bankMSB*128+n.bankLSB,n.program=t}handleChannelPressure(e,t){let n=this.audioContext.currentTime,r=this.channels[e];t/=64,r.channelPressure=t;let o=this.getActiveNotes(r,n);r.channelPressure.amplitudeControl!==1&&o.forEach(s=>{let a=s.volumeNode.gain.value;s.volumeNode.gain.cancelScheduledValues(n).setValueAtTime(a*t,n)})}handlePitchBendMessage(e,t,n){let r=n*128+t-8192;this.setPitchBend(e,r)}setPitchBend(e,t){let n=this.channels[e],r=n.pitchBend;n.pitchBend=t/8192;let o=(n.pitchBend-r)*n.pitchBendRange*100;this.updateDetune(n,o)}createControlChangeHandlers(){return{0:this.setBankMSB,1:this.setModulationDepth,5:this.setPortamentoTime,6:this.dataEntryMSB,7:this.setVolume,10:this.setPan,11:this.setExpression,32:this.setBankLSB,38:this.dataEntryLSB,64:this.setSustainPedal,65:this.setPortamento,66:this.setSostenutoPedal,67:this.setSoftPedal,71:this.setFilterResonance,72:this.setReleaseTime,73:this.setAttackTime,74:this.setBrightness,75:this.setDecayTime,76:this.setVibratoRate,77:this.setVibratoDepth,78:this.setVibratoDelay,91:this.setReverbSendLevel,93:this.setChorusSendLevel,96:this.dataIncrement,97:this.dataDecrement,100:this.setRPNLSB,101:this.setRPNMSB,120:this.allSoundOff,121:this.resetAllControllers,123:this.allNotesOff,124:this.omniOff,125:this.omniOn,126:this.monoOn,127:this.polyOn}}handleControlChange(e,t,n){let r=this.controlChangeHandlers[t];r?r.call(this,e,n):console.warn(`Unsupported Control change: controller=${t} value=${n}`)}setBankMSB(e,t){this.channels[e].bankMSB=t}updateModulation(e){let t=this.audioContext.currentTime;e.scheduledNotes.forEach(n=>{for(let r=0;r<n.length;r++){let o=n[r];if(o)if(o.modulationDepth)o.modulationDepth.gain.setValueAtTime(e.modulationDepth,t);else{let s=this.calcSemitoneOffset(e);this.setPitch(o,s),this.startModulation(e,o,t)}}})}setModulationDepth(e,t){let n=this.channels[e];n.modulationDepth=t/127*n.modulationDepthRange,this.updateModulation(n)}setPortamentoTime(e,t){let n=this.channels[e],r=5*Math.log(10)/127;n.portamentoTime=Math.exp(r*t)}setVolume(e,t){let n=this.channels[e];n.volume=t/127,this.updateChannelVolume(n)}panToGain(e){let t=Math.PI/2*Math.max(0,e-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t){let n=this.channels[e];n.pan=t,this.updateChannelVolume(n)}setExpression(e,t){let n=this.channels[e];n.expression=t/127,this.updateChannelVolume(n)}setBankLSB(e,t){this.channels[e].bankLSB=t}dataEntryLSB(e,t){this.channels[e].dataLSB=t,this.handleRPN(e,0)}updateChannelVolume(e){let t=this.audioContext.currentTime,n=e.volume*e.expression,{gainLeft:r,gainRight:o}=this.panToGain(e.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(n*r,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(n*o,t)}setSustainPedal(e,t){let n=t>=64;this.channels[e].sustainPedal=n,n||this.releaseSustainPedal(e,t)}setPortamento(e,t){this.channels[e].portamento=t>=64}setReverbSendLevel(e,t){let n=this.channels[e],r=this.reverbEffect;if(0<n.reverbSendLevel)if(0<t){let o=this.audioContext.currentTime;n.reverbSendLevel=t/127,r.input.gain.cancelScheduledValues(o),r.input.gain.setValueAtTime(n.reverbSendLevel,o)}else n.scheduledNotes.forEach(o=>{for(let s=0;s<o.length;s++){let a=o[s];a&&(a.instrumentKey.reverbEffectsSend<=0||a.reverbEffectsSend.disconnect())}});else if(0<t){let o=this.audioContext.currentTime;n.scheduledNotes.forEach(s=>{for(let a=0;a<s.length;a++){let c=s[a];c&&(c.instrumentKey.reverbEffectsSend<=0||(c.reverbEffectsSend||(c.reverbEffectsSend=new GainNode(this.audioContext,{gain:c.instrumentKey.reverbEffectsSend}),c.volumeNode.connect(c.reverbEffectsSend)),c.reverbEffectsSend.connect(r.input)))}}),n.reverbSendLevel=t/127,r.input.gain.cancelScheduledValues(o),r.input.gain.setValueAtTime(n.reverbSendLevel,o)}}setChorusSendLevel(e,t){let n=this.channels[e],r=this.chorusEffect;if(0<n.chorusSendLevel)if(0<t){let o=this.audioContext.currentTime;n.chorusSendLevel=t/127,r.input.gain.cancelScheduledValues(o),r.input.gain.setValueAtTime(n.chorusSendLevel,o)}else n.scheduledNotes.forEach(o=>{for(let s=0;s<o.length;s++){let a=o[s];a&&(a.instrumentKey.chorusEffectsSend<=0||a.chorusEffectsSend.disconnect())}});else if(0<t){let o=this.audioContext.currentTime;n.scheduledNotes.forEach(s=>{for(let a=0;a<s.length;a++){let c=s[a];c&&(c.instrumentKey.chorusEffectsSend<=0||(c.chorusEffectsSend||(c.chorusEffectsSend=new GainNode(this.audioContext,{gain:c.instrumentKey.chorusEffectsSend}),c.volumeNode.connect(c.chorusEffectsSend)),c.chorusEffectsSend.connect(r.input)))}}),n.chorusSendLevel=t/127,r.input.gain.cancelScheduledValues(o),r.input.gain.setValueAtTime(n.chorusSendLevel,o)}}setSostenutoPedal(e,t){let n=t>=64,r=this.channels[e];if(r.sostenutoPedal=n,n){let o=this.audioContext.currentTime,s=this.getActiveNotes(r,o);r.sostenutoNotes=new Map(s)}else this.releaseSostenutoPedal(e,t)}setSoftPedal(e,t){let n=this.channels[e];n.softPedal=t/127}setFilterResonance(e,t){let n=this.audioContext.currentTime,r=this.channels[e];r.filterResonance=t/64,r.scheduledNotes.forEach(o=>{for(let s=0;s<o.length;s++){let a=o[s];if(!a)continue;let c=a.instrumentKey.initialFilterQ/10*r.filterResonance;a.filterNode.Q.setValueAtTime(c,n)}})}setReleaseTime(e,t){let n=this.channels[e];n.releaseTime=t/64}setAttackTime(e,t){let n=this.audioContext.currentTime,r=this.channels[e];r.attackTime=t/64,r.scheduledNotes.forEach(o=>{for(let s=0;s<o.length;s++){let a=o[s];a&&(a.startTime<n||this.setVolumeEnvelope(r,a))}})}setBrightness(e,t){let n=this.channels[e];n.brightness=t/64,n.scheduledNotes.forEach(r=>{for(let o=0;o<r.length;o++){let s=r[o];s&&this.setFilterEnvelope(n,s)}})}setDecayTime(e,t){let n=this.channels[e];n.decayTime=t/64,n.scheduledNotes.forEach(r=>{for(let o=0;o<r.length;o++){let s=r[o];s&&this.setVolumeEnvelope(n,s)}})}setVibratoRate(e,t){let n=this.channels[e];if(n.vibratoRate=t/64,n.vibratoDepth<=0)return;let r=this.audioContext.currentTime;this.getActiveNotes(n,r).forEach(s=>{s.vibratoLFO.frequency.cancelScheduledValues(r).setValueAtTime(n.vibratoRate,r)})}setVibratoDepth(e,t){let n=this.channels[e];n.vibratoDepth=t/64}setVibratoDelay(e,t){let n=this.channels[e];n.vibratoDelay=t/64}limitData(e,t,n,r,o){o<e.dataLSB?(e.dataMSB++,e.dataLSB=r):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=o),n<e.dataMSB?(e.dataMSB=n,e.dataLSB=o):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=r)}limitDataMSB(e,t,n){n<e.dataMSB?e.dataMSB=n:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e,t){let n=this.channels[e];switch(n.rpnMSB*128+n.rpnLSB){case 0:n.dataLSB+=t,this.handlePitchBendRangeRPN(e);break;case 1:n.dataLSB+=t,this.handleFineTuningRPN(e);break;case 2:n.dataMSB+=t,this.handleCoarseTuningRPN(e);break;case 5:n.dataLSB+=t,this.handleModulationDepthRangeRPN(e);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${n.rpnMSB} LSB=${n.rpnLSB}`)}}dataIncrement(e){this.handleRPN(e,1)}dataDecrement(e){this.handleRPN(e,-1)}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t){this.channels[e].dataMSB=t,this.handleRPN(e,0)}updateDetune(e,t){let n=this.audioContext.currentTime;e.scheduledNotes.forEach(r=>{for(let o=0;o<r.length;o++){let s=r[o];if(!s)continue;let{bufferSource:a}=s,c=a.detune.value+t;a.detune.cancelScheduledValues(n).setValueAtTime(c,n)}})}handlePitchBendRangeRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,99);let n=t.dataMSB+t.dataLSB/100;this.setPitchBendRange(e,n)}setPitchBendRange(e,t){let n=this.channels[e],r=n.pitchBendRange;n.pitchBendRange=t;let o=(n.pitchBendRange-r)*n.pitchBend*100;this.updateDetune(n,o)}handleFineTuningRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,127);let n=(t.dataMSB*128+t.dataLSB-8192)/8192;this.setFineTuning(e,n)}setFineTuning(e,t){let n=this.channels[e],r=n.fineTuning;n.fineTuning=t;let o=n.fineTuning-r;this.updateDetune(n,o)}handleCoarseTuningRPN(e){let t=this.channels[e];this.limitDataMSB(t,0,127);let n=t.dataMSB-64;this.setFineTuning(e,n)}setCoarseTuning(e,t){let n=this.channels[e],r=n.coarseTuning;n.coarseTuning=t;let o=n.coarseTuning-r;this.updateDetune(n,o)}handleModulationDepthRangeRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,127);let n=(dataMSB+dataLSB/128)*100;this.setModulationDepthRange(e,n)}setModulationDepthRange(e,t){let n=this.channels[e];n.modulationDepthRange=t,n.modulationDepth=modulation/127*t,this.updateModulation(n)}allSoundOff(e){return this.stopChannelNotes(e,0,!0)}resetAllControllers(e){Object.assign(this.channels[e],this.effectSettings)}allNotesOff(e){return this.stopChannelNotes(e,0,!1)}omniOff(){this.omni=!1}omniOn(){this.omni=!0}monoOn(){this.mono=!0}polyOn(){this.mono=!1}handleUniversalNonRealTimeExclusiveMessage(e){switch(e[2]){case 9:switch(e[3]){case 1:this.GM1SystemOn();break;case 2:break;case 3:this.GM2SystemOn();break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(){for(let e=0;e<this.channels.length;e++){let t=this.channels[e];t.bankMSB=0,t.bankLSB=0,t.bank=0}this.channels[9].bankMSB=1,this.channels[9].bank=128}GM2SystemOn(){for(let e=0;e<this.channels.length;e++){let t=this.channels[e];t.bankMSB=121,t.bankLSB=0,t.bank=121*128}this.channels[9].bankMSB=120,this.channels[9].bank=120*128}handleUniversalRealTimeExclusiveMessage(e){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e);case 3:return this.handleMasterFineTuningSysEx(e);case 4:return this.handleMasterCoarseTuningSysEx(e);case 5:return this.handleGlobalParameterControlSysEx(e);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 8:switch(e[3]){default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 10:switch(e[3]){default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e){let t=(e[5]*128+e[4])/16383;this.setMasterVolume(t)}setMasterVolume(e){if(e<0&&1<e)console.error("Master Volume is out of range");else{let t=this.audioContext.currentTime;this.masterGain.gain.cancelScheduledValues(t),this.masterGain.gain.setValueAtTime(e*e,t)}}handleMasterFineTuningSysEx(e){let t=(e[5]*128+e[4]-8192)/8192;this.setMasterFineTuning(t)}setMasterFineTuning(e){e<-1&&1<e?console.error("Master Fine Tuning value is out of range"):this.masterFineTuning=e}handleMasterCoarseTuningSysEx(e){let t=e[4];this.setMasterCoarseTuning(t)}setMasterCoarseTuning(e){e<0&&127<e?console.error("Master Coarse Tuning value is out of range"):this.masterCoarseTuning=e-64}handleGlobalParameterControlSysEx(e){if(e[7]===1)switch(e[8]){case 1:return this.handleReverbParameterSysEx(e);case 2:return this.handleChorusParameterSysEx(e);default:console.warn(`Unsupported Global Parameter Control Message: ${e}`)}else console.warn(`Unsupported Global Parameter Control Message: ${e}`)}handleReverbParameterSysEx(e){switch(e[9]){case 0:return this.setReverbType(e[10]);case 1:return this.setReverbTime(e[10])}}setReverbType(e){this.reverb.time=this.getReverbTimeFromType(e),this.reverb.feedback=e===8?.9:.8;let{audioContext:t,options:n}=this;this.reverbEffect=n.reverbAlgorithm(t)}getReverbTimeFromType(e){switch(e){case 0:return this.getReverbTime(44);case 1:return this.getReverbTime(50);case 2:return this.getReverbTime(56);case 3:return this.getReverbTime(64);case 4:return this.getReverbTime(64);case 8:return this.getReverbTime(50);default:console.warn(`Unsupported Reverb Time: ${e}`)}}setReverbTime(e){this.reverb.time=this.getReverbTime(e);let{audioContext:t,options:n}=this;this.reverbEffect=n.reverbAlgorithm(t)}getReverbTime(e){return Math.pow(Math.E,(e-40)*.025)}calcDelay(e,t){return-e*Math.log10(t)/3}handleChorusParameterSysEx(e){switch(e[9]){case 0:return this.setChorusType(e[10]);case 1:return this.setChorusModRate(e[10]);case 2:return this.setChorusModDepth(e[10]);case 3:return this.setChorusFeedback(e[10]);case 4:return this.setChorusSendToReverb(e[10])}}setChorusType(e){switch(e){case 0:return this.setChorusParameter(3,5,0,0);case 1:return this.setChorusParameter(9,19,5,0);case 2:return this.setChorusParameter(3,19,8,0);case 3:return this.setChorusParameter(9,16,16,0);case 4:return this.setChorusParameter(2,24,64,0);case 5:return this.setChorusParameter(1,5,112,0);default:console.warn(`Unsupported Chorus Type: ${e}`)}}setChorusParameter(e,t,n,r){this.setChorusModRate(e),this.setChorusModDepth(t),this.setChorusFeedback(n),this.setChorusSendToReverb(r)}setChorusModRate(e){let t=this.audioContext.currentTime,n=this.getChorusModRate(e);this.chorus.modRate=n,this.chorusEffect.lfo.frequency.setValueAtTime(n,t)}getChorusModRate(e){return e*.122}setChorusModDepth(e){let t=this.audioContext.currentTime,n=this.getChorusModDepth(e);this.chorus.modDepth=n,this.chorusEffect.lfoGain.gain.cancelScheduledValues(t).setValueAtTime(n/2,t)}getChorusModDepth(e){return(e+1)/3200}setChorusFeedback(e){let t=this.audioContext.currentTime,n=this.getChorusFeedback(e);this.chorus.feedback=n;let r=this.chorusEffect;for(let o=0;o<r.feedbackGains.length;o++)r.feedbackGains[o].gain.cancelScheduledValues(t).setValueAtTime(n,t)}getChorusFeedback(e){return e*.00763}setChorusSendToReverb(e){let t=this.getChorusSendToReverb(e),n=this.chorusEffect.sendGain;if(0<this.chorus.sendToReverb)if(this.chorus.sendToReverb=t,0<t){let r=this.audioContext.currentTime;n.gain.cancelScheduledValues(r).setValueAtTime(t,r)}else n.disconnect();else if(this.chorus.sendToReverb=t,0<t){let r=this.audioContext.currentTime;n.connect(this.reverbEffect.input),n.gain.cancelScheduledValues(r).setValueAtTime(t,r)}}getChorusSendToReverb(e){return e*.00787}handleExclusiveMessage(e){console.warn(`Unsupported Exclusive Message: ${e}`)}handleSysEx(e){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e);case 127:return this.handleUniversalRealTimeExclusiveMessage(e);default:return this.handleExclusiveMessage(e)}}scheduleTask(e,t){return new Promise(n=>{let r=new AudioBufferSourceNode(this.audioContext);r.onended=()=>{e(),n()},r.start(t),r.stop(t)})}};export{ce as Midy};
