function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}function t(e,t,n,a,r,i,s){try{var o=e[i](s),u=o.value}catch(e){n(e);return}o.done?t(u):Promise.resolve(u).then(a,r)}function n(e){return function(){var n=this,a=arguments;return new Promise(function(r,i){var s=e.apply(n,a);function o(e){t(s,r,i,o,u,"next",e)}function u(e){t(s,r,i,o,u,"throw",e)}o(void 0)})}}function a(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),a.forEach(function(t){r(e,t,n[t])})}return e}function s(e,t){var n,a,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(u){var c=[o,u];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(i=0)),i;)try{if(n=1,a&&(r=2&c[0]?a.return:c[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,c[1])).done)return r;switch(a=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,a=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(r=(r=i.trys).length>0&&r[r.length-1])&&(6===c[0]||2===c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],a=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}import{parseMidi as o}from"midi-file";import{parse as u,SoundFont as c}from"@marmooo/soundfont-parser";var l=function e(t,n,i,s){"use strict";a(this,e),r(this,"bufferSource",void 0),r(this,"filterNode",void 0),r(this,"volumeNode",void 0),r(this,"volumeDepth",void 0),r(this,"modulationLFO",void 0),r(this,"modulationDepth",void 0),r(this,"vibratoLFO",void 0),r(this,"vibratoDepth",void 0),r(this,"reverbEffectsSend",void 0),r(this,"chorusEffectsSend",void 0),this.noteNumber=t,this.velocity=n,this.startTime=i,this.instrumentKey=s};export var MidyGM2=function(){"use strict";var t;function h(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultOptions;a(this,h),r(this,"ticksPerBeat",120),r(this,"totalTime",0),r(this,"masterFineTuning",0),r(this,"masterCoarseTuning",0),r(this,"reverb",{time:this.getReverbTime(64),feedback:.8}),r(this,"chorus",{modRate:this.getChorusModRate(3),modDepth:this.getChorusModDepth(19),feedback:this.getChorusFeedback(8),sendToReverb:this.getChorusSendToReverb(0),delayTimes:this.generateDistributedArray(.02,2,.5)}),r(this,"mono",!1),r(this,"omni",!1),r(this,"noteCheckInterval",.1),r(this,"lookAhead",1),r(this,"startDelay",.1),r(this,"startTime",0),r(this,"resumeTime",0),r(this,"soundFonts",[]),r(this,"soundFontTable",this.initSoundFontTable()),r(this,"isPlaying",!1),r(this,"isPausing",!1),r(this,"isPaused",!1),r(this,"isStopping",!1),r(this,"isSeeking",!1),r(this,"timeline",[]),r(this,"instruments",[]),r(this,"notePromises",[]),r(this,"exclusiveClassMap",new Map),r(this,"defaultOptions",{reverbAlgorithm:function(e){var n=t.reverb,a=n.time,r=n.feedback,i=t.generateDistributedArray(r,4),s=i.map(function(e){return t.calcDelay(a,e)}),o=t.generateDistributedArray(r,4),u=o.map(function(e){return t.calcDelay(a,e)});return t.createSchroederReverb(e,i,s,o,u)}}),this.audioContext=e,this.options=i({},this.defaultOptions,n),this.masterGain=new GainNode(e),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.reverbEffect=this.options.reverbAlgorithm(e),this.chorusEffect=this.createChorusEffect(e),this.chorusEffect.output.connect(this.masterGain),this.reverbEffect.output.connect(this.masterGain),this.masterGain.connect(e.destination),this.GM2SystemOn()}return t=[{key:"initSoundFontTable",value:function(){for(var e=Array(128),t=0;t<128;t++)e[t]=new Map;return e}},{key:"addSoundFont",value:function(e){var t=this.soundFonts.length;this.soundFonts.push(e);for(var n=e.parsed.presetHeaders,a=0;a<n.length;a++){var r=n[a];r.presetName.startsWith("\0")||this.soundFontTable[r.preset].set(r.bank,t)}}},{key:"loadSoundFont",value:function(e){return n(function(){var t;return s(this,function(n){switch(n.label){case 0:return[4,fetch(e)];case 1:return[4,n.sent().arrayBuffer()];case 2:return t=new c(u(new Uint8Array(n.sent()))),this.addSoundFont(t),[2]}})}).call(this)}},{key:"loadMIDI",value:function(e){return n(function(){var t,n;return s(this,function(a){switch(a.label){case 0:return[4,fetch(e)];case 1:return[4,a.sent().arrayBuffer()];case 2:return t=o(new Uint8Array(a.sent())),this.ticksPerBeat=t.header.ticksPerBeat,n=this.extractMidiData(t),this.instruments=n.instruments,this.timeline=n.timeline,this.totalTime=this.calcTotalTime(),[2]}})}).call(this)}},{key:"setChannelAudioNodes",value:function(e){var t=this.panToGain(this.constructor.channelSettings.pan),n=t.gainLeft,a=t.gainRight,r=new GainNode(e,{gain:n}),i=new GainNode(e,{gain:a}),s=new ChannelMergerNode(e,{numberOfInputs:2});return r.connect(s,0,0),i.connect(s,0,1),s.connect(this.masterGain),{gainL:r,gainR:i,merger:s}}},{key:"createChannels",value:function(e){var t=this;return Array.from({length:16},function(){var n,a;return n=i({},t.constructor.channelSettings,t.constructor.effectSettings,t.setChannelAudioNodes(e)),a=a={scheduledNotes:new Map,sostenutoNotes:new Map,channelPressure:i({},t.constructor.controllerDestinationSettings)},Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n})(Object(a)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(a,e))}),n})}},{key:"createNoteBuffer",value:function(e,t){return n(function(){var n,a,r,i,o,u,c,l,h,d,f,v,m,p;return s(this,function(s){switch(s.label){case 0:if(n=e.start,a=e.sample.length+e.end,!t)return[3,2];return i=(r=e.sample).byteOffset+n,o=r.byteOffset+a,u=r.buffer.slice(i,o),[4,this.audioContext.decodeAudioData(u)];case 1:return[2,s.sent()];case 2:for(p=0,l=(c=e.sample).byteOffset+n,h=c.byteOffset+a,d=c.buffer.slice(l,h),v=(f=new AudioBuffer({numberOfChannels:1,length:c.length,sampleRate:e.sampleRate})).getChannelData(0),m=new Int16Array(d);p<m.length;p++)v[p]=m[p]/32768;return[2,f];case 3:return[2]}})}).call(this)}},{key:"createNoteBufferNode",value:function(e,t){return n(function(){var n,a;return s(this,function(r){switch(r.label){case 0:return n=new AudioBufferSourceNode(this.audioContext),[4,this.createNoteBuffer(e,t)];case 1:return a=r.sent(),n.buffer=a,n.loop=e.sampleModes%2!=0,n.loop&&(n.loopStart=e.loopStart/e.sampleRate,n.loopEnd=e.loopEnd/e.sampleRate),[2,n]}})}).call(this)}},{key:"findPortamentoTarget",value:function(e){var t,n=this.timeline[e];if(this.channels[n.channel].portamento){for(var a=n.startTime;++e<this.timeline.length;){var r=this.timeline[e];if(a!==r.startTime)break;"noteOn"===r.type&&(!t||r.noteNumber<t.noteNumber)&&(t=r)}return t}}},{key:"scheduleTimelineEvents",value:function(e,t,a){return n(function(){var n,r,i;return s(this,function(s){switch(s.label){case 0:if(!(a<this.timeline.length)||(n=this.timeline[a]).startTime>e+this.lookAhead)return[3,10];switch(n.type){case"noteOn":return[3,1];case"noteOff":return[3,3];case"controller":return[3,4];case"programChange":return[3,5];case"channelAftertouch":return[3,6];case"pitchBend":return[3,7];case"sysEx":return[3,8]}return[3,9];case 1:if(0===n.velocity)return[3,3];return[4,this.scheduleNoteOn(n.channel,n.noteNumber,n.velocity,n.startTime+this.startDelay-t,n.portamento)];case 2:return s.sent(),[3,9];case 3:return(r=this.findPortamentoTarget(a))&&(r.portamento=!0),(i=this.scheduleNoteRelease(this.omni?0:n.channel,n.noteNumber,n.velocity,n.startTime+this.startDelay-t,null==r?void 0:r.noteNumber,!1))&&this.notePromises.push(i),[3,9];case 4:return this.handleControlChange(this.omni?0:n.channel,n.controllerType,n.value),[3,9];case 5:return this.handleProgramChange(n.channel,n.programNumber),[3,9];case 6:return this.handleChannelPressure(n.channel,n.amount),[3,9];case 7:return this.setPitchBend(n.channel,n.value),[3,9];case 8:this.handleSysEx(n.data),s.label=9;case 9:return a++,[3,0];case 10:return[2,a]}})}).call(this)}},{key:"getQueueIndex",value:function(e){for(var t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}},{key:"playNotes",value:function(){var e=this;return new Promise(function(t){e.isPlaying=!0,e.isPaused=!1,e.startTime=e.audioContext.currentTime;var a=e.getQueueIndex(e.resumeTime),r=e.resumeTime-e.startTime;e.notePromises=[];var i=function(){return n(function(){var e,n;return s(this,function(s){switch(s.label){case 0:if(!(a>=this.timeline.length))return[3,2];return[4,Promise.all(this.notePromises)];case 1:return s.sent(),this.notePromises=[],this.exclusiveClassMap.clear(),t(),[2];case 2:return e=this.audioContext.currentTime+r,[4,this.scheduleTimelineEvents(e,r,a)];case 3:if(a=s.sent(),!this.isPausing)return[3,5];return[4,this.stopNotes(0,!0)];case 4:return s.sent(),this.notePromises=[],t(),this.isPausing=!1,this.isPaused=!0,[2];case 5:if(!this.isStopping)return[3,7];return[4,this.stopNotes(0,!0)];case 6:return s.sent(),this.exclusiveClassMap.clear(),this.notePromises=[],t(),this.isStopping=!1,this.isPaused=!1,[2];case 7:if(!this.isSeeking)return[3,9];return this.stopNotes(0,!0),this.exclusiveClassMap.clear(),this.startTime=this.audioContext.currentTime,a=this.getQueueIndex(this.resumeTime),r=this.resumeTime-this.startTime,this.isSeeking=!1,[4,i()];case 8:return s.sent(),[3,12];case 9:return n=this.audioContext.currentTime+this.noteCheckInterval,[4,this.scheduleTask(function(){},n)];case 10:return s.sent(),[4,i()];case 11:s.sent(),s.label=12;case 12:return[2]}})}).call(e)};i()})}},{key:"ticksToSecond",value:function(e,t){return e*t/this.ticksPerBeat}},{key:"secondToTicks",value:function(e,t){return e*this.ticksPerBeat/t}},{key:"extractMidiData",value:function(e){for(var t=new Set,n=[],a=Array(16),r=0;r<a.length;r++)a[r]={programNumber:-1,bankMSB:this.channels[r].bankMSB,bankLSB:this.channels[r].bankLSB};for(var i=0;i<e.tracks.length;i++)for(var s=e.tracks[i],o=0,u=0;u<s.length;u++){var c=s[u];switch(o+=c.deltaTime,c.ticks=o,c.type){case"noteOn":var l=a[c.channel];if(l.programNumber<0){switch(l.programNumber=c.programNumber,l.bankMSB){case 120:t.add("128:0");break;case 121:t.add("".concat(l.bankLSB,":0"));break;default:var h=128*l.bankMSB+l.bankLSB;t.add("".concat(h,":0"))}l.programNumber=0}break;case"controller":switch(c.controllerType){case 0:a[c.channel].bankMSB=c.value;break;case 32:a[c.channel].bankLSB=c.value}break;case"programChange":var d=a[c.channel];switch(d.programNumber=c.programNumber,d.bankMSB){case 120:t.add("128:".concat(d.programNumber));break;case 121:t.add("".concat(d.bankLSB,":").concat(d.programNumber));break;default:var f=128*d.bankMSB+d.bankLSB;t.add("".concat(f,":").concat(d.programNumber))}}delete c.deltaTime,n.push(c)}var v={controller:0,sysEx:1,noteOff:2,noteOn:3};n.sort(function(e,t){return e.ticks!==t.ticks?e.ticks-t.ticks:(v[e.type]||4)-(v[t.type]||4)});for(var m=0,p=0,y=.5,b=0;b<n.length;b++){var g=n[b],S=this.ticksToSecond(g.ticks-p,y);g.startTime=m+S,"setTempo"===g.type&&(m+=this.ticksToSecond(g.ticks-p,y),y=g.microsecondsPerBeat/1e6,p=g.ticks)}return{instruments:t,timeline:n}}},{key:"stopChannelNotes",value:function(e,t,a){return n(function(){var n,r,i;return s(this,function(s){switch(s.label){case 0:return n=this,r=this.audioContext.currentTime,(i=this.channels[e]).scheduledNotes.forEach(function(i){for(var s=0;s<i.length;s++){var o=i[s];if(o){var u=n.scheduleNoteRelease(e,o.noteNumber,t,r,void 0,a);n.notePromises.push(u)}}}),i.scheduledNotes.clear(),[4,Promise.all(this.notePromises)];case 1:return s.sent(),[2]}})}).call(this)}},{key:"stopNotes",value:function(e,t){for(var n=0;n<this.channels.length;n++)this.stopChannelNotes(n,e,t);return Promise.all(this.notePromises)}},{key:"start",value:function(){return n(function(){return s(this,function(e){switch(e.label){case 0:if(this.isPlaying||this.isPaused)return[2];return this.resumeTime=0,[4,this.playNotes()];case 1:return e.sent(),this.isPlaying=!1,[2]}})}).call(this)}},{key:"stop",value:function(){this.isPlaying&&(this.isStopping=!0)}},{key:"pause",value:function(){if(this.isPlaying&&!this.isPaused){var e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}}},{key:"resume",value:function(){return n(function(){return s(this,function(e){switch(e.label){case 0:if(!this.isPaused)return[2];return[4,this.playNotes()];case 1:return e.sent(),this.isPlaying=!1,[2]}})}).call(this)}},{key:"seekTo",value:function(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}},{key:"calcTotalTime",value:function(){for(var e=0,t=0;t<this.timeline.length;t++){var n=this.timeline[t];e<n.startTime&&(e=n.startTime)}return e}},{key:"currentTime",value:function(){var e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}},{key:"getActiveNotes",value:function(e,t){var n=this,a=new Map;return e.scheduledNotes.forEach(function(e){var r=n.getActiveNote(e,t);r&&a.set(r.noteNumber,r)}),a}},{key:"getActiveNote",value:function(e,t){for(var n=e.length-1;n>=0;n--){var a=e[n];if(!a)return;if(!(t<a.startTime))return a.ending?null:a}return e[0]}},{key:"createConvolutionReverbImpulse",value:function(e,t,n){for(var a=e.sampleRate,r=a*t,i=new AudioBuffer({numberOfChannels:2,length:r,sampleRate:a}),s=Math.min(a*n,r),o=0;o<i.numberOfChannels;o++){for(var u=i.getChannelData(o),c=0;c<s;c++)u[c]=2*Math.random()-1;for(var l=1/(a*t),h=s;h<r;h++){var d=Math.exp(-(h-s)*l);u[h]=(2*Math.random()-1)*d}}return i}},{key:"createConvolutionReverb",value:function(e,t){var n=new GainNode(e),a=new ConvolverNode(e,{buffer:t});return n.connect(a),{input:n,output:a,convolverNode:a}}},{key:"createCombFilter",value:function(e,t,n,a){var r=new DelayNode(e,{maxDelayTime:n,delayTime:n}),i=new GainNode(e,{gain:a});return t.connect(r),r.connect(i),i.connect(r),r}},{key:"createAllpassFilter",value:function(e,t,n,a){var r=new DelayNode(e,{maxDelayTime:n,delayTime:n}),i=new GainNode(e,{gain:a}),s=new GainNode(e,{gain:1-a});return t.connect(r),r.connect(i),i.connect(r),r.connect(s),s}},{key:"generateDistributedArray",value:function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.1,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.05,r=e*n,i=Array(t),s=0;s<t;s++){var o=e-r+s/(t-1||1)*2*r;i[s]=o*(1-(2*Math.random()-1)*a)}return i}},{key:"createSchroederReverb",value:function(e,t,n,a,r){for(var i=new GainNode(e),s=new GainNode(e),o=0;o<n.length;o++)this.createCombFilter(e,i,n[o],t[o]).connect(s);for(var u=[],c=0;c<r.length;c++){var l=this.createAllpassFilter(e,0===c?s:u.at(-1),r[c],a[c]);u.push(l)}return{input:i,output:u.at(-1)}}},{key:"createChorusEffect",value:function(e){for(var t=new GainNode(e),n=new GainNode(e),a=new GainNode(e),r=new OscillatorNode(e,{frequency:this.chorus.modRate}),i=new GainNode(e,{gain:this.chorus.modDepth/2}),s=this.chorus.delayTimes,o=[],u=[],c=0;c<s.length;c++){var l=new DelayNode(e,{maxDelayTime:.1,delayTime:s[c]}),h=new GainNode(e,{gain:this.chorus.feedback});o.push(l),u.push(h),t.connect(l),i.connect(l.delayTime),l.connect(h),h.connect(l),l.connect(n)}return n.connect(a),r.connect(i),r.start(),{input:t,output:n,sendGain:a,lfo:r,lfoGain:i,delayNodes:o,feedbackGains:u}}},{key:"cbToRatio",value:function(e){return Math.pow(10,e/200)}},{key:"centToHz",value:function(e){return 8.176*Math.pow(2,e/1200)}},{key:"calcSemitoneOffset",value:function(e){var t=this.masterCoarseTuning+this.masterFineTuning,n=e.coarseTuning+e.fineTuning;return e.pitchBend*e.pitchBendRange+(t+n)}},{key:"calcPlaybackRate",value:function(e,t,n){return e.playbackRate(t)*Math.pow(2,n/12)}},{key:"setPortamentoStartVolumeEnvelope",value:function(e,t){var n=t.instrumentKey,a=t.startTime,r=this.cbToRatio(-n.initialAttenuation)*(1-n.volSustain),i=a+n.volDelay,s=i+e.portamentoTime;t.volumeNode.gain.cancelScheduledValues(a).setValueAtTime(0,i).linearRampToValueAtTime(r,s)}},{key:"setVolumeEnvelope",value:function(e){var t=e.instrumentKey,n=e.startTime,a=this.cbToRatio(-t.initialAttenuation),r=a*(1-t.volSustain),i=n+t.volDelay,s=i+t.volAttack,o=s+t.volHold,u=o+t.volDecay;e.volumeNode.gain.cancelScheduledValues(n).setValueAtTime(0,n).setValueAtTime(1e-6,i).exponentialRampToValueAtTime(a,s).setValueAtTime(a,o).linearRampToValueAtTime(r,u)}},{key:"setPitch",value:function(e,t){var n=e.instrumentKey,a=e.noteNumber,r=e.startTime,i=n.modEnvToPitch/100;if(e.bufferSource.playbackRate.value=this.calcPlaybackRate(n,a,t),0!==i){var s=e.bufferSource.playbackRate.value,o=this.calcPlaybackRate(n,a,t+i),u=r+n.modDelay,c=u+n.modAttack,l=c+n.modHold,h=l+n.modDecay;e.bufferSource.playbackRate.value.setValueAtTime(s,u).exponentialRampToValueAtTime(o,c).setValueAtTime(o,l).linearRampToValueAtTime(s,h)}}},{key:"clampCutoffFrequency",value:function(e){return Math.max(20,Math.min(e,2e4))}},{key:"setPortamentoStartFilterEnvelope",value:function(e,t){var n=t.instrumentKey,a=t.noteNumber,r=t.startTime,i=1-(.1+a/127*.2)*e.softPedal,s=this.centToHz(n.initialFilterFc)*i,o=s+(this.centToHz(n.initialFilterFc+n.modEnvToFilterFc)*i-s)*(1-n.modSustain),u=this.clampCutoffFrequency(s),c=this.clampCutoffFrequency(o),l=r+e.portamentoTime,h=r+n.modDelay;t.filterNode.frequency.cancelScheduledValues(r).setValueAtTime(u,r).setValueAtTime(u,h).linearRampToValueAtTime(c,l)}},{key:"setFilterEnvelope",value:function(e,t){var n=t.instrumentKey,a=t.noteNumber,r=t.startTime,i=1-(.1+a/127*.2)*e.softPedal,s=this.centToHz(n.initialFilterFc)*i,o=this.centToHz(n.initialFilterFc+n.modEnvToFilterFc)*i,u=s+(o-s)*(1-n.modSustain),c=this.clampCutoffFrequency(s),l=this.clampCutoffFrequency(o),h=this.clampCutoffFrequency(u),d=r+n.modDelay,f=d+n.modAttack,v=f+n.modHold,m=v+n.modDecay;t.filterNode.frequency.cancelScheduledValues(r).setValueAtTime(c,r).setValueAtTime(c,d).exponentialRampToValueAtTime(l,f).setValueAtTime(l,v).linearRampToValueAtTime(h,m)}},{key:"startModulation",value:function(e,t,n){var a=t.instrumentKey,r=a.modLfoToPitch,i=a.modLfoToVolume;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(a.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:a.modLfoToFilterFc});var s=Math.abs(r)+e.modulationDepth;t.modulationDepth=new GainNode(this.audioContext,{gain:s*(0<r?1:-1)});var o=this.cbToRatio(Math.abs(i))-1;t.volumeDepth=new GainNode(this.audioContext,{gain:o*(0<i?1:-1)}),t.modulationLFO.start(n+a.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeNode.gain)}},{key:"startVibrato",value:function(e,t,n){var a=t.instrumentKey,r=a.vibLfoToPitch;t.vibratoLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(a.freqVibLFO)*e.vibratoRate});var i=Math.abs(r)*e.vibratoDepth;t.vibratoDepth=new GainNode(this.audioContext,{gain:i*(0<r)}),t.vibratoLFO.start(n+a.delayVibLFO*e.vibratoDelay),t.vibratoLFO.connect(t.vibratoDepth),t.vibratoDepth.connect(t.bufferSource.detune)}},{key:"createNote",value:function(e,t,a,r,i,o,u){return n(function(){var n,c;return s(this,function(s){switch(s.label){case 0:return n=this.calcSemitoneOffset(e),c=new l(a,r,i,t),[4,this.createNoteBufferNode(t,u)];case 1:return c.bufferSource=s.sent(),c.volumeNode=new GainNode(this.audioContext),c.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:t.initialFilterQ/10}),o?(this.setPortamentoStartVolumeEnvelope(e,c),this.setPortamentoStartFilterEnvelope(e,c)):(this.setVolumeEnvelope(c),this.setFilterEnvelope(e,c)),0<e.vibratoDepth&&this.startVibrato(e,c,i),0<e.modulationDepth?(this.setPitch(c,n),this.startModulation(e,c,i)):c.bufferSource.playbackRate.value=this.calcPlaybackRate(t,a,n),this.mono&&e.currentBufferSource&&(e.currentBufferSource.stop(i),e.currentBufferSource=c.bufferSource),c.bufferSource.connect(c.filterNode),c.filterNode.connect(c.volumeNode),0<e.reverbSendLevel&&0<t.reverbEffectsSend&&(c.reverbEffectsSend=new GainNode(this.audioContext,{gain:t.reverbEffectsSend}),c.volumeNode.connect(c.reverbEffectsSend),c.reverbEffectsSend.connect(this.reverbEffect.input)),0<e.chorusSendLevel&&0<t.chorusEffectsSend&&(c.chorusEffectsSend=new GainNode(this.audioContext,{gain:t.chorusEffectsSend}),c.volumeNode.connect(c.chorusEffectsSend),c.chorusEffectsSend.connect(this.chorusEffect.input)),c.bufferSource.start(i),[2,c]}})}).call(this)}},{key:"calcBank",value:function(e,t){return 121===e.bankMSB?0:t%9<=1&&120===e.bankMSB?128:e.bank}},{key:"scheduleNoteOn",value:function(t,a,r,i,o){return n(function(){var n,u,c,l,h,d,f,v,m,p,y,b;return s(this,function(s){switch(s.label){case 0:if(n=this.channels[t],u=this.calcBank(n,t),void 0===(c=this.soundFontTable[n.program].get(u))||(h=3===(l=this.soundFonts[c]).parsed.info.version.major,!(d=l.getInstrumentKey(u,n.program,a,r))))return[2];return[4,this.createNote(n,d,a,r,i,o,h)];case 1:if((f=s.sent()).volumeNode.connect(n.gainL),f.volumeNode.connect(n.gainR),n.sostenutoPedal&&n.sostenutoNotes.set(a,f),0!==(v=d.exclusiveClass)){if(this.exclusiveClassMap.has(v)){var g;p=(m=function(e){if(Array.isArray(e))return e}(g=this.exclusiveClassMap.get(v))||function(e,t){var n,a,r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],s=!0,o=!1;try{for(r=r.call(e);!(s=(n=r.next()).done)&&(i.push(n.value),i.length!==t);s=!0);}catch(e){o=!0,a=e}finally{try{s||null==r.return||r.return()}finally{if(o)throw a}}return i}}(g,2)||function(t,n){if(t){if("string"==typeof t)return e(t,2);var a=Object.prototype.toString.call(t).slice(8,-1);if("Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return e(t,n)}}(g,2)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())[0],y=m[1],p.ending||this.scheduleNoteRelease(y,p.noteNumber,0,i,void 0,!0)}this.exclusiveClassMap.set(v,[f,t])}return(b=n.scheduledNotes).has(a)?b.get(a).push(f):b.set(a,[f]),[2]}})}).call(this)}},{key:"noteOn",value:function(e,t,n,a){var r=this.audioContext.currentTime;return this.scheduleNoteOn(e,t,n,r,a)}},{key:"stopNote",value:function(e,t,n,a){var r=n[a];return r.volumeNode.gain.cancelScheduledValues(e).linearRampToValueAtTime(0,t),r.ending=!0,this.scheduleTask(function(){r.bufferSource.loop=!1},t),new Promise(function(e){r.bufferSource.onended=function(){n[a]=null,r.bufferSource.disconnect(),r.volumeNode.disconnect(),r.filterNode.disconnect(),r.modulationDepth&&(r.volumeDepth.disconnect(),r.modulationDepth.disconnect(),r.modulationLFO.stop()),r.vibratoDepth&&(r.vibratoDepth.disconnect(),r.vibratoLFO.stop()),r.reverbEffectsSend&&r.reverbEffectsSend.disconnect(),r.chorusEffectsSend&&r.chorusEffectsSend.disconnect(),e()},r.bufferSource.stop(t)})}},{key:"scheduleNoteRelease",value:function(e,t,n,a,r,i){var s=this.channels[e];if(!(!i&&(s.sustainPedal||s.sostenutoNotes.has(t)))&&s.scheduledNotes.has(t))for(var o=s.scheduledNotes.get(t),u=0;u<o.length;u++){var c=o[u];if(c&&!c.ending)if(void 0===r){var l=a+c.instrumentKey.volRelease,h=a+c.instrumentKey.modRelease;c.filterNode.frequency.cancelScheduledValues(a).linearRampToValueAtTime(0,h);var d=Math.min(l,h);return this.stopNote(a,d,o,u)}else{var f=a+s.portamentoTime,v=(r-t)*100,m=c.bufferSource.detune.value+v;return c.bufferSource.detune.cancelScheduledValues(a).linearRampToValueAtTime(m,f),this.stopNote(a,f,o,u)}}}},{key:"releaseNote",value:function(e,t,n,a){var r=this.audioContext.currentTime;return this.scheduleNoteRelease(e,t,n,r,a,!1)}},{key:"releaseSustainPedal",value:function(e,t){var n=this,a=2*t,r=this.channels[e],i=[];return r.sustainPedal=!1,r.scheduledNotes.forEach(function(t){for(var r=0;r<t.length;r++){var s=t[r];if(s){var o=s.noteNumber,u=n.releaseNote(e,o,a);i.push(u)}}}),i}},{key:"releaseSostenutoPedal",value:function(e,t){var n=this,a=2*t,r=this.channels[e],i=[];return r.sostenutoPedal=!1,r.sostenutoNotes.forEach(function(t){var r=t.noteNumber,s=n.releaseNote(e,r,a);i.push(s)}),r.sostenutoNotes.clear(),i}},{key:"handleMIDIMessage",value:function(e,t,n){var a=omni?0:15&e,r=240&e;switch(r){case 128:return this.releaseNote(a,t,n);case 144:return this.noteOn(a,t,n);case 176:return this.handleControlChange(a,t,n);case 192:return this.handleProgramChange(a,t);case 208:return this.handleChannelPressure(a,t);case 224:return this.handlePitchBendMessage(a,t,n);default:console.warn("Unsupported MIDI message: ".concat(r.toString(16)))}}},{key:"handleProgramChange",value:function(e,t){var n=this.channels[e];n.bank=128*n.bankMSB+n.bankLSB,n.program=t}},{key:"handleChannelPressure",value:function(e,t){var n=this.audioContext.currentTime,a=this.channels[e];a.channelPressure=t/=64;var r=this.getActiveNotes(a,n);1!==a.channelPressure.amplitudeControl&&r.forEach(function(e){var a=e.volumeNode.gain.value;e.volumeNode.gain.cancelScheduledValues(n).setValueAtTime(a*t,n)})}},{key:"handlePitchBendMessage",value:function(e,t,n){this.setPitchBend(e,128*n+t-8192)}},{key:"setPitchBend",value:function(e,t){var n=this.channels[e],a=n.pitchBend;n.pitchBend=t/8192;var r=(n.pitchBend-a)*n.pitchBendRange*100;this.updateDetune(n,r)}},{key:"createControlChangeHandlers",value:function(){return{0:this.setBankMSB,1:this.setModulationDepth,5:this.setPortamentoTime,6:this.dataEntryMSB,7:this.setVolume,10:this.setPan,11:this.setExpression,32:this.setBankLSB,38:this.dataEntryLSB,64:this.setSustainPedal,65:this.setPortamento,66:this.setSostenutoPedal,67:this.setSoftPedal,91:this.setReverbSendLevel,93:this.setChorusSendLevel,100:this.setRPNLSB,101:this.setRPNMSB,120:this.allSoundOff,121:this.resetAllControllers,123:this.allNotesOff,124:this.omniOff,125:this.omniOn,126:this.monoOn,127:this.polyOn}}},{key:"handleControlChange",value:function(e,t,n){var a=this.controlChangeHandlers[t];a?a.call(this,e,n):console.warn("Unsupported Control change: controller=".concat(t," value=").concat(n))}},{key:"setBankMSB",value:function(e,t){this.channels[e].bankMSB=t}},{key:"updateModulation",value:function(e){var t=this,n=this.audioContext.currentTime;e.scheduledNotes.forEach(function(a){for(var r=0;r<a.length;r++){var i=a[r];if(i)if(i.modulationDepth)i.modulationDepth.gain.setValueAtTime(e.modulationDepth,n);else{var s=t.calcSemitoneOffset(e);t.setPitch(i,s),t.startModulation(e,i,n)}}})}},{key:"setModulationDepth",value:function(e,t){var n=this.channels[e];n.modulationDepth=t/127*n.modulationDepthRange,this.updateModulation(n)}},{key:"setPortamentoTime",value:function(e,t){this.channels[e].portamentoTime=Math.exp(5*Math.log(10)/127*t)}},{key:"setVolume",value:function(e,t){var n=this.channels[e];n.volume=t/127,this.updateChannelVolume(n)}},{key:"panToGain",value:function(e){var t=Math.PI/2*Math.max(0,e-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}},{key:"setPan",value:function(e,t){var n=this.channels[e];n.pan=t,this.updateChannelVolume(n)}},{key:"setExpression",value:function(e,t){var n=this.channels[e];n.expression=t/127,this.updateChannelVolume(n)}},{key:"setBankLSB",value:function(e,t){this.channels[e].bankLSB=t}},{key:"dataEntryLSB",value:function(e,t){this.channels[e].dataLSB=t,this.handleRPN(e)}},{key:"updateChannelVolume",value:function(e){var t=this.audioContext.currentTime,n=e.volume*e.expression,a=this.panToGain(e.pan),r=a.gainLeft,i=a.gainRight;e.gainL.gain.cancelScheduledValues(t).setValueAtTime(n*r,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(n*i,t)}},{key:"setSustainPedal",value:function(e,t){var n=t>=64;this.channels[e].sustainPedal=n,n||this.releaseSustainPedal(e,t)}},{key:"setPortamento",value:function(e,t){this.channels[e].portamento=t>=64}},{key:"setReverbSendLevel",value:function(e,t){var n=this,a=this.channels[e],r=this.reverbEffect;if(0<a.reverbSendLevel)if(0<t){var i=this.audioContext.currentTime;a.reverbSendLevel=t/127,r.input.gain.cancelScheduledValues(i),r.input.gain.setValueAtTime(a.reverbSendLevel,i)}else a.scheduledNotes.forEach(function(e){for(var t=0;t<e.length;t++){var n=e[t];n&&(n.instrumentKey.reverbEffectsSend<=0||n.reverbEffectsSend.disconnect())}});else if(0<t){var s=this.audioContext.currentTime;a.scheduledNotes.forEach(function(e){for(var t=0;t<e.length;t++){var a=e[t];a&&(a.instrumentKey.reverbEffectsSend<=0||(a.reverbEffectsSend||(a.reverbEffectsSend=new GainNode(n.audioContext,{gain:a.instrumentKey.reverbEffectsSend}),a.volumeNode.connect(a.reverbEffectsSend)),a.reverbEffectsSend.connect(r.input)))}}),a.reverbSendLevel=t/127,r.input.gain.cancelScheduledValues(s),r.input.gain.setValueAtTime(a.reverbSendLevel,s)}}},{key:"setChorusSendLevel",value:function(e,t){var n=this,a=this.channels[e],r=this.chorusEffect;if(0<a.chorusSendLevel)if(0<t){var i=this.audioContext.currentTime;a.chorusSendLevel=t/127,r.input.gain.cancelScheduledValues(i),r.input.gain.setValueAtTime(a.chorusSendLevel,i)}else a.scheduledNotes.forEach(function(e){for(var t=0;t<e.length;t++){var n=e[t];n&&(n.instrumentKey.chorusEffectsSend<=0||n.chorusEffectsSend.disconnect())}});else if(0<t){var s=this.audioContext.currentTime;a.scheduledNotes.forEach(function(e){for(var t=0;t<e.length;t++){var a=e[t];a&&(a.instrumentKey.chorusEffectsSend<=0||(a.chorusEffectsSend||(a.chorusEffectsSend=new GainNode(n.audioContext,{gain:a.instrumentKey.chorusEffectsSend}),a.volumeNode.connect(a.chorusEffectsSend)),a.chorusEffectsSend.connect(r.input)))}}),a.chorusSendLevel=t/127,r.input.gain.cancelScheduledValues(s),r.input.gain.setValueAtTime(a.chorusSendLevel,s)}}},{key:"setSostenutoPedal",value:function(e,t){var n=t>=64,a=this.channels[e];if(a.sostenutoPedal=n,n){var r=this.audioContext.currentTime,i=this.getActiveNotes(a,r);a.sostenutoNotes=new Map(i)}else this.releaseSostenutoPedal(e,t)}},{key:"setSoftPedal",value:function(e,t){this.channels[e].softPedal=t/127}},{key:"limitData",value:function(e,t,n,a,r){r<e.dataLSB?(e.dataMSB++,e.dataLSB=a):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=r),n<e.dataMSB?(e.dataMSB=n,e.dataLSB=r):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=a)}},{key:"limitDataMSB",value:function(e,t,n){n<e.dataMSB?e.dataMSB=n:e.dataMSB<0&&(e.dataMSB=t)}},{key:"handleRPN",value:function(e){var t=this.channels[e];switch(128*t.rpnMSB+t.rpnLSB){case 0:this.handlePitchBendRangeRPN(e);break;case 1:this.handleFineTuningRPN(e);break;case 2:this.handleCoarseTuningRPN(e);break;case 5:this.handleModulationDepthRangeRPN(e);break;default:console.warn("Channel ".concat(e,": Unsupported RPN MSB=").concat(t.rpnMSB," LSB=").concat(t.rpnLSB))}}},{key:"setRPNMSB",value:function(e,t){this.channels[e].rpnMSB=t}},{key:"setRPNLSB",value:function(e,t){this.channels[e].rpnLSB=t}},{key:"dataEntryMSB",value:function(e,t){this.channels[e].dataMSB=t,this.handleRPN(e)}},{key:"updateDetune",value:function(e,t){var n=this.audioContext.currentTime;e.scheduledNotes.forEach(function(e){for(var a=0;a<e.length;a++){var r=e[a];if(r){var i=r.bufferSource,s=i.detune.value+t;i.detune.cancelScheduledValues(n).setValueAtTime(s,n)}}})}},{key:"handlePitchBendRangeRPN",value:function(e){var t=this.channels[e];this.limitData(t,0,127,0,99);var n=t.dataMSB+t.dataLSB/100;this.setPitchBendRange(e,n)}},{key:"setPitchBendRange",value:function(e,t){var n=this.channels[e],a=n.pitchBendRange;n.pitchBendRange=t;var r=(n.pitchBendRange-a)*n.pitchBend*100;this.updateDetune(n,r)}},{key:"handleFineTuningRPN",value:function(e){var t=this.channels[e];this.limitData(t,0,127,0,127);var n=(128*t.dataMSB+t.dataLSB-8192)/8192;this.setFineTuning(e,n)}},{key:"setFineTuning",value:function(e,t){var n=this.channels[e],a=n.fineTuning;n.fineTuning=t;var r=n.fineTuning-a;this.updateDetune(n,r)}},{key:"handleCoarseTuningRPN",value:function(e){var t=this.channels[e];this.limitDataMSB(t,0,127);var n=t.dataMSB-64;this.setFineTuning(e,n)}},{key:"setCoarseTuning",value:function(e,t){var n=this.channels[e],a=n.coarseTuning;n.coarseTuning=t;var r=n.coarseTuning-a;this.updateDetune(n,r)}},{key:"handleModulationDepthRangeRPN",value:function(e){var t=this.channels[e];this.limitData(t,0,127,0,127);var n=(dataMSB+dataLSB/128)*100;this.setModulationDepthRange(e,n)}},{key:"setModulationDepthRange",value:function(e,t){var n=this.channels[e];n.modulationDepthRange=t,n.modulationDepth=modulation/127*t,this.updateModulation(n)}},{key:"allSoundOff",value:function(e){return this.stopChannelNotes(e,0,!0)}},{key:"resetAllControllers",value:function(e){Object.assign(this.channels[e],this.effectSettings)}},{key:"allNotesOff",value:function(e){return this.stopChannelNotes(e,0,!1)}},{key:"omniOff",value:function(){this.omni=!1}},{key:"omniOn",value:function(){this.omni=!0}},{key:"monoOn",value:function(){this.mono=!0}},{key:"polyOn",value:function(){this.mono=!1}},{key:"handleUniversalNonRealTimeExclusiveMessage",value:function(e){if(9===e[2])switch(e[3]){case 1:this.GM1SystemOn();break;case 2:break;case 3:this.GM2SystemOn();break;default:console.warn("Unsupported Exclusive Message: ".concat(e))}else console.warn("Unsupported Exclusive Message: ".concat(e))}},{key:"GM1SystemOn",value:function(){for(var e=0;e<this.channels.length;e++){var t=this.channels[e];t.bankMSB=0,t.bankLSB=0,t.bank=0}this.channels[9].bankMSB=1,this.channels[9].bank=128}},{key:"GM2SystemOn",value:function(){for(var e=0;e<this.channels.length;e++){var t=this.channels[e];t.bankMSB=121,t.bankLSB=0,t.bank=15488}this.channels[9].bankMSB=120,this.channels[9].bank=15360}},{key:"handleUniversalRealTimeExclusiveMessage",value:function(e){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e);case 3:return this.handleMasterFineTuningSysEx(e);case 4:return this.handleMasterCoarseTuningSysEx(e);case 5:return this.handleGlobalParameterControlSysEx(e);default:console.warn("Unsupported Exclusive Message: ".concat(e))}break;case 8:case 9:case 10:e[3],console.warn("Unsupported Exclusive Message: ".concat(e));break;default:console.warn("Unsupported Exclusive Message: ".concat(e))}}},{key:"handleMasterVolumeSysEx",value:function(e){var t=(128*e[5]+e[4])/16383;this.setMasterVolume(t)}},{key:"setMasterVolume",value:function(e){if(e<0&&1<e)console.error("Master Volume is out of range");else{var t=this.audioContext.currentTime;this.masterGain.gain.cancelScheduledValues(t),this.masterGain.gain.setValueAtTime(e*e,t)}}},{key:"handleMasterFineTuningSysEx",value:function(e){var t=(128*e[5]+e[4]-8192)/8192;this.setMasterFineTuning(t)}},{key:"setMasterFineTuning",value:function(e){e<-1&&1<e?console.error("Master Fine Tuning value is out of range"):this.masterFineTuning=e}},{key:"handleMasterCoarseTuningSysEx",value:function(e){var t=e[4];this.setMasterCoarseTuning(t)}},{key:"setMasterCoarseTuning",value:function(e){e<0&&127<e?console.error("Master Coarse Tuning value is out of range"):this.masterCoarseTuning=e-64}},{key:"handleGlobalParameterControlSysEx",value:function(e){if(1===e[7])switch(e[8]){case 1:return this.handleReverbParameterSysEx(e);case 2:return this.handleChorusParameterSysEx(e);default:console.warn("Unsupported Global Parameter Control Message: ".concat(e))}else console.warn("Unsupported Global Parameter Control Message: ".concat(e))}},{key:"handleReverbParameterSysEx",value:function(e){switch(e[9]){case 0:return this.setReverbType(e[10]);case 1:return this.setReverbTime(e[10])}}},{key:"setReverbType",value:function(e){this.reverb.time=this.getReverbTimeFromType(e),this.reverb.feedback=8===e?.9:.8;var t=this.audioContext,n=this.options;this.reverbEffect=n.reverbAlgorithm(t)}},{key:"getReverbTimeFromType",value:function(e){switch(e){case 0:return this.getReverbTime(44);case 1:case 8:return this.getReverbTime(50);case 2:return this.getReverbTime(56);case 3:case 4:return this.getReverbTime(64);default:console.warn("Unsupported Reverb Time: ".concat(e))}}},{key:"setReverbTime",value:function(e){this.reverb.time=this.getReverbTime(e);var t=this.audioContext,n=this.options;this.reverbEffect=n.reverbAlgorithm(t)}},{key:"getReverbTime",value:function(e){return Math.pow(Math.E,(e-40)*.025)}},{key:"calcDelay",value:function(e,t){return-e*Math.log10(t)/3}},{key:"handleChorusParameterSysEx",value:function(e){switch(e[9]){case 0:return this.setChorusType(e[10]);case 1:return this.setChorusModRate(e[10]);case 2:return this.setChorusModDepth(e[10]);case 3:return this.setChorusFeedback(e[10]);case 4:return this.setChorusSendToReverb(e[10])}}},{key:"setChorusType",value:function(e){switch(e){case 0:return this.setChorusParameter(3,5,0,0);case 1:return this.setChorusParameter(9,19,5,0);case 2:return this.setChorusParameter(3,19,8,0);case 3:return this.setChorusParameter(9,16,16,0);case 4:return this.setChorusParameter(2,24,64,0);case 5:return this.setChorusParameter(1,5,112,0);default:console.warn("Unsupported Chorus Type: ".concat(e))}}},{key:"setChorusParameter",value:function(e,t,n,a){this.setChorusModRate(e),this.setChorusModDepth(t),this.setChorusFeedback(n),this.setChorusSendToReverb(a)}},{key:"setChorusModRate",value:function(e){var t=this.audioContext.currentTime,n=this.getChorusModRate(e);this.chorus.modRate=n,this.chorusEffect.lfo.frequency.setValueAtTime(n,t)}},{key:"getChorusModRate",value:function(e){return .122*e}},{key:"setChorusModDepth",value:function(e){var t=this.audioContext.currentTime,n=this.getChorusModDepth(e);this.chorus.modDepth=n,this.chorusEffect.lfoGain.gain.cancelScheduledValues(t).setValueAtTime(n/2,t)}},{key:"getChorusModDepth",value:function(e){return(e+1)/3200}},{key:"setChorusFeedback",value:function(e){var t=this.audioContext.currentTime,n=this.getChorusFeedback(e);this.chorus.feedback=n;for(var a=this.chorusEffect,r=0;r<a.feedbackGains.length;r++)a.feedbackGains[r].gain.cancelScheduledValues(t).setValueAtTime(n,t)}},{key:"getChorusFeedback",value:function(e){return .00763*e}},{key:"setChorusSendToReverb",value:function(e){var t=this.getChorusSendToReverb(e),n=this.chorusEffect.sendGain;if(0<this.chorus.sendToReverb)if(this.chorus.sendToReverb=t,0<t){var a=this.audioContext.currentTime;n.gain.cancelScheduledValues(a).setValueAtTime(t,a)}else n.disconnect();else if(this.chorus.sendToReverb=t,0<t){var r=this.audioContext.currentTime;n.connect(this.reverbEffect.input),n.gain.cancelScheduledValues(r).setValueAtTime(t,r)}}},{key:"getChorusSendToReverb",value:function(e){return .00787*e}},{key:"handleExclusiveMessage",value:function(e){console.warn("Unsupported Exclusive Message: ".concat(e))}},{key:"handleSysEx",value:function(e){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e);case 127:return this.handleUniversalRealTimeExclusiveMessage(e);default:return this.handleExclusiveMessage(e)}}},{key:"scheduleTask",value:function(e,t){var n=this;return new Promise(function(a){var r=new AudioBufferSourceNode(n.audioContext);r.onended=function(){e(),a()},r.start(t),r.stop(t)})}}],function(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}(h.prototype,t),h}();r(MidyGM2,"channelSettings",{currentBufferSource:null,volume:100/127,pan:64,portamentoTime:1,reverbSendLevel:0,chorusSendLevel:0,vibratoRate:1,vibratoDepth:1,vibratoDelay:1,bank:15488,bankMSB:121,bankLSB:0,dataMSB:0,dataLSB:0,program:0,pitchBend:0,fineTuning:0,coarseTuning:0,modulationDepthRange:50}),r(MidyGM2,"effectSettings",{expression:1,modulationDepth:0,sustainPedal:!1,portamento:!1,sostenutoPedal:!1,softPedal:0,rpnMSB:127,rpnLSB:127,channelPressure:0,pitchBendRange:2}),r(MidyGM2,"controllerDestinationSettings",{pitchControl:0,filterCutoffControl:0,amplitudeControl:1,lfoPitchDepth:0,lfoFilterDepth:0,lfoAmplitudeDepth:0});