var e={};function t(e){this.buffer=e,this.bufferLen=this.buffer.length,this.pos=0}function n(){this.buffer=[]}t.prototype.eof=function(){return this.pos>=this.bufferLen},t.prototype.readUInt8=function(){var e=this.buffer[this.pos];return this.pos+=1,e},t.prototype.readInt8=function(){var e=this.readUInt8();return 128&e?e-256:e},t.prototype.readUInt16=function(){return(this.readUInt8()<<8)+this.readUInt8()},t.prototype.readInt16=function(){var e=this.readUInt16();return 32768&e?e-65536:e},t.prototype.readUInt24=function(){return(this.readUInt8()<<16)+(this.readUInt8()<<8)+this.readUInt8()},t.prototype.readInt24=function(){var e=this.readUInt24();return 8388608&e?e-0x1000000:e},t.prototype.readUInt32=function(){return(this.readUInt8()<<24)+(this.readUInt8()<<16)+(this.readUInt8()<<8)+this.readUInt8()},t.prototype.readBytes=function(e){var t=this.buffer.slice(this.pos,this.pos+e);return this.pos+=e,t},t.prototype.readString=function(e){var t=this.readBytes(e);return String.fromCharCode.apply(null,t)},t.prototype.readVarInt=function(){for(var e=0;!this.eof();){var t=this.readUInt8();if(!(128&t))return e+t;e+=127&t,e<<=7}return e},t.prototype.readChunk=function(){var e=this.readString(4),t=this.readUInt32();return{id:e,length:t,data:this.readBytes(t)}},n.prototype.writeUInt8=function(e){this.buffer.push(255&e)},n.prototype.writeInt8=n.prototype.writeUInt8,n.prototype.writeUInt16=function(e){this.writeUInt8(e>>8&255),this.writeUInt8(255&e)},n.prototype.writeInt16=n.prototype.writeUInt16,n.prototype.writeUInt24=function(e){this.writeUInt8(e>>16&255),this.writeUInt8(e>>8&255),this.writeUInt8(255&e)},n.prototype.writeInt24=n.prototype.writeUInt24,n.prototype.writeUInt32=function(e){this.writeUInt8(e>>24&255),this.writeUInt8(e>>16&255),this.writeUInt8(e>>8&255),this.writeUInt8(255&e)},n.prototype.writeInt32=n.prototype.writeUInt32,n.prototype.writeBytes=function(e){this.buffer=this.buffer.concat(Array.prototype.slice.call(e,0))},n.prototype.writeString=function(e){var t,n=e.length,r=[];for(t=0;t<n;t++)r.push(e.codePointAt(t));this.writeBytes(r)},n.prototype.writeVarInt=function(e){if(e<0)throw"Cannot write negative variable-length integer";if(e<=127)this.writeUInt8(e);else{var t=e,n=[];for(n.push(127&t),t>>=7;t;){var r=127&t|128;n.push(r),t>>=7}this.writeBytes(n.reverse())}},n.prototype.writeChunk=function(e,t){this.writeString(e),this.writeUInt32(t.length),this.writeBytes(t)};var r=e.parseMidi=function(e){var n,r,a,i=new t(e),s=i.readChunk();if("MThd"!=s.id)throw"Bad MIDI file.  Expected 'MHdr', got: '"+s.id+"'";for(var o=(r={format:(n=new t(s.data)).readUInt16(),numTracks:n.readUInt16()},32768&(a=n.readUInt16())?(r.framesPerSecond=256-(a>>8),r.ticksPerFrame=255&a):r.ticksPerBeat=a,r),l=[],u=0;!i.eof()&&u<o.numTracks;u++){var h=i.readChunk();if("MTrk"!=h.id)throw"Bad MIDI file.  Expected 'MTrk', got: '"+h.id+"'";var c=function(e){for(var n,r=new t(e),a=[];!r.eof();){var i=function(){var e={};e.deltaTime=r.readVarInt();var t=r.readUInt8();if(240==(240&t)){if(255!==t){if(240==t)return e.type="sysEx",i=r.readVarInt(),e.data=r.readBytes(i),e;if(247==t)return e.type="endSysEx",i=r.readVarInt(),e.data=r.readBytes(i),e;throw"Unrecognised MIDI event type byte: "+t}e.meta=!0;var a=r.readUInt8(),i=r.readVarInt();switch(a){case 0:if(e.type="sequenceNumber",2!==i)throw"Expected length for sequenceNumber event is 2, got "+i;return e.number=r.readUInt16(),e;case 1:return e.type="text",e.text=r.readString(i),e;case 2:return e.type="copyrightNotice",e.text=r.readString(i),e;case 3:return e.type="trackName",e.text=r.readString(i),e;case 4:return e.type="instrumentName",e.text=r.readString(i),e;case 5:return e.type="lyrics",e.text=r.readString(i),e;case 6:return e.type="marker",e.text=r.readString(i),e;case 7:return e.type="cuePoint",e.text=r.readString(i),e;case 32:if(e.type="channelPrefix",1!=i)throw"Expected length for channelPrefix event is 1, got "+i;return e.channel=r.readUInt8(),e;case 33:if(e.type="portPrefix",1!=i)throw"Expected length for portPrefix event is 1, got "+i;return e.port=r.readUInt8(),e;case 47:if(e.type="endOfTrack",0!=i)throw"Expected length for endOfTrack event is 0, got "+i;return e;case 81:if(e.type="setTempo",3!=i)throw"Expected length for setTempo event is 3, got "+i;return e.microsecondsPerBeat=r.readUInt24(),e;case 84:if(e.type="smpteOffset",5!=i)throw"Expected length for smpteOffset event is 5, got "+i;var s=r.readUInt8();return e.frameRate=({0:24,32:25,64:29,96:30})[96&s],e.hour=31&s,e.min=r.readUInt8(),e.sec=r.readUInt8(),e.frame=r.readUInt8(),e.subFrame=r.readUInt8(),e;case 88:if(e.type="timeSignature",2!=i&&4!=i)throw"Expected length for timeSignature event is 4 or 2, got "+i;return e.numerator=r.readUInt8(),e.denominator=1<<r.readUInt8(),4===i?(e.metronome=r.readUInt8(),e.thirtyseconds=r.readUInt8()):(e.metronome=36,e.thirtyseconds=8),e;case 89:if(e.type="keySignature",2!=i)throw"Expected length for keySignature event is 2, got "+i;return e.key=r.readInt8(),e.scale=r.readUInt8(),e;case 127:return e.type="sequencerSpecific",e.data=r.readBytes(i),e;default:return e.type="unknownMeta",e.data=r.readBytes(i),e.metatypeByte=a,e}}if(0==(128&t)){if(null===n)throw"Running status byte encountered before status byte";o=t,t=n,e.running=!0}else o=r.readUInt8(),n=t;var o,l=t>>4;switch(e.channel=15&t,l){case 8:return e.type="noteOff",e.noteNumber=o,e.velocity=r.readUInt8(),e;case 9:var u=r.readUInt8();return e.type=0===u?"noteOff":"noteOn",e.noteNumber=o,e.velocity=u,0===u&&(e.byte9=!0),e;case 10:return e.type="noteAftertouch",e.noteNumber=o,e.amount=r.readUInt8(),e;case 11:return e.type="controller",e.controllerType=o,e.value=r.readUInt8(),e;case 12:return e.type="programChange",e.programNumber=o,e;case 13:return e.type="channelAftertouch",e.amount=o,e;case 14:return e.type="pitchBend",e.value=o+(r.readUInt8()<<7)-8192,e;default:throw"Unrecognised MIDI event type: "+l}}();a.push(i)}return a}(h.data);l.push(c)}return{header:o,tracks:l}};e.writeMidi=function(e,t){if("object"!=typeof e)throw"Invalid MIDI data";t=t||{};var r,a,i,s,o=e.header||{},l=e.tracks||[],u=l.length,h=new n;for(r=null==o.format?1:o.format,a=128,o.timeDivision?a=o.timeDivision:o.ticksPerFrame&&o.framesPerSecond?a=-(255&o.framesPerSecond)<<8|255&o.ticksPerFrame:o.ticksPerBeat&&(a=32767&o.ticksPerBeat),(i=new n).writeUInt16(r),i.writeUInt16(u),i.writeUInt16(a),h.writeChunk("MThd",i.buffer),s=0;s<u;s++)!function(e,t,r){var a,i=new n,s=t.length,o=null;for(a=0;a<s;a++)!1!==r.running&&(r.running||t[a].running)||(o=null),o=function(e,t,n,r){var a=t.type,i=t.deltaTime,s=t.text||"",o=t.data||[],l=null;switch(e.writeVarInt(i),a){case"sequenceNumber":e.writeUInt8(255),e.writeUInt8(0),e.writeVarInt(2),e.writeUInt16(t.number);break;case"text":e.writeUInt8(255),e.writeUInt8(1),e.writeVarInt(s.length),e.writeString(s);break;case"copyrightNotice":e.writeUInt8(255),e.writeUInt8(2),e.writeVarInt(s.length),e.writeString(s);break;case"trackName":e.writeUInt8(255),e.writeUInt8(3),e.writeVarInt(s.length),e.writeString(s);break;case"instrumentName":e.writeUInt8(255),e.writeUInt8(4),e.writeVarInt(s.length),e.writeString(s);break;case"lyrics":e.writeUInt8(255),e.writeUInt8(5),e.writeVarInt(s.length),e.writeString(s);break;case"marker":e.writeUInt8(255),e.writeUInt8(6),e.writeVarInt(s.length),e.writeString(s);break;case"cuePoint":e.writeUInt8(255),e.writeUInt8(7),e.writeVarInt(s.length),e.writeString(s);break;case"channelPrefix":e.writeUInt8(255),e.writeUInt8(32),e.writeVarInt(1),e.writeUInt8(t.channel);break;case"portPrefix":e.writeUInt8(255),e.writeUInt8(33),e.writeVarInt(1),e.writeUInt8(t.port);break;case"endOfTrack":e.writeUInt8(255),e.writeUInt8(47),e.writeVarInt(0);break;case"setTempo":e.writeUInt8(255),e.writeUInt8(81),e.writeVarInt(3),e.writeUInt24(t.microsecondsPerBeat);break;case"smpteOffset":e.writeUInt8(255),e.writeUInt8(84),e.writeVarInt(5);var u=31&t.hour|({24:0,25:32,29:64,30:96})[t.frameRate];e.writeUInt8(u),e.writeUInt8(t.min),e.writeUInt8(t.sec),e.writeUInt8(t.frame),e.writeUInt8(t.subFrame);break;case"timeSignature":e.writeUInt8(255),e.writeUInt8(88),e.writeVarInt(4),e.writeUInt8(t.numerator);var h=255&Math.floor(Math.log(t.denominator)/Math.LN2);e.writeUInt8(h),e.writeUInt8(t.metronome),e.writeUInt8(t.thirtyseconds||8);break;case"keySignature":e.writeUInt8(255),e.writeUInt8(89),e.writeVarInt(2),e.writeInt8(t.key),e.writeUInt8(t.scale);break;case"sequencerSpecific":e.writeUInt8(255),e.writeUInt8(127),e.writeVarInt(o.length),e.writeBytes(o);break;case"unknownMeta":null!=t.metatypeByte&&(e.writeUInt8(255),e.writeUInt8(t.metatypeByte),e.writeVarInt(o.length),e.writeBytes(o));break;case"sysEx":e.writeUInt8(240),e.writeVarInt(o.length),e.writeBytes(o);break;case"endSysEx":e.writeUInt8(247),e.writeVarInt(o.length),e.writeBytes(o);break;case"noteOff":(l=(!1!==r&&t.byte9||r&&0==t.velocity?144:128)|t.channel)!==n&&e.writeUInt8(l),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteOn":(l=144|t.channel)!==n&&e.writeUInt8(l),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteAftertouch":(l=160|t.channel)!==n&&e.writeUInt8(l),e.writeUInt8(t.noteNumber),e.writeUInt8(t.amount);break;case"controller":(l=176|t.channel)!==n&&e.writeUInt8(l),e.writeUInt8(t.controllerType),e.writeUInt8(t.value);break;case"programChange":(l=192|t.channel)!==n&&e.writeUInt8(l),e.writeUInt8(t.programNumber);break;case"channelAftertouch":(l=208|t.channel)!==n&&e.writeUInt8(l),e.writeUInt8(t.amount);break;case"pitchBend":(l=224|t.channel)!==n&&e.writeUInt8(l);var c=8192+t.value;e.writeUInt8(127&c),e.writeUInt8(c>>7&127);break;default:throw"Unrecognized event type: "+a}return l}(i,t[a],o,r.useByte9ForNoteOff);e.writeChunk("MTrk",i.buffer)}(h,l[s],t);return h.buffer};class a{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=String.fromCharCode(...Array.from(this.data.subarray(this.offset,this.offset+=e))),n=t.indexOf("\0");return n>0?t.substring(0,n):t}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}}function i(e,t,n){let r=new a(e,t);return new o(r.readString(4),r.readDWORD(n),r.offset)}function s(e,t=0,n,{padding:r=!0,bigEndian:a=!1}={}){let o=[],l=n+t,u=t;for(;u<l;){let n=i(e,u,a);u=n.offset+n.size,r&&1==(u-t&1)&&u++,o.push(n)}return o}class o{constructor(e,t,n){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:n})}}let l=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];class u{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){return new u(e.readInt8(),e.readInt8())}}class h{constructor(e,t,n,r,a,i,s,o,l,u,h){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:h})}static parse(e,t){function n(e){for(let n=0;n<t.length;n++)if(t[n].type===e)return t[n]}function r(t){return new a(e,t.offset)}function i(e){let t=n(e);return t?r(t).readString(t.size):null}function s(e){let t=n(e);return t?u.parse(r(t)):null}let o=i("ICMT"),l=i("ICOP"),c=i("ICRD"),d=i("IENG"),f=i("INAM"),m=i("IPRD"),p=i("ISFT"),b=s("ifil"),g=i("isng");return new h(o,l,c,d,f,m,p,b,g,i("irom"),s("iver"))}}class c{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){return new c(e.readWORD(),e.readWORD())}}class d{constructor(e,t,n,r,a,i,s){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:s})}get isEnd(){return"EOP"===this.presetName}static parse(e){let t=e.readString(20),n=e.readWORD(),r=e.readWORD(),a=e.readWORD(),i=e.readDWORD();return new d(t,n,r,a,i,e.readDWORD(),e.readDWORD())}}class f{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){return new f(e.readByte(),e.readByte())}}class m{constructor(e,t,n,r,a){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:a})}get isEnd(){return 0===this.sourceOper&&0===this.destinationOper&&0===this.value&&0===this.amountSourceOper&&0===this.transOper}static parse(e){let t=e.readWORD(),n=e.readWORD(),r=e.readInt16();return new m(t,n,r,e.readWORD(),e.readWORD())}}class p{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return l[this.code]}get isEnd(){return 0===this.code&&0===this.value}static parse(e){let t,n=e.readWORD();switch(l[n]){case"keyRange":case"velRange":t=f.parse(e);break;default:t=e.readInt16()}return new p(n,t)}}class b{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return"EOI"===this.instrumentName}static parse(e){let t=new b;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}}class g{constructor(e,t,n,r,a,i,s,o,l,u){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:u})}get isEnd(){return"EOS"===this.sampleName}static parse(e,t){let n=e.readString(20),r=e.readDWORD(),a=e.readDWORD(),i=e.readDWORD(),s=e.readDWORD(),o=e.readDWORD(),l=e.readByte(),u=e.readInt8(),h=e.readWORD(),c=e.readWORD();return t||(i-=r,s-=r),new g(n,r,a,i,s,o,l,u,h,c)}}class v{constructor(e,t,n){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.value=t,this.max=n}clamp(){return Math.max(this.min,Math.min(this.value,this.max))}}function w(e,t,n,r,i={}){if(e.type!==n)throw Error("invalid chunk type:"+e.type);let o=new a(t,e.offset),l=o.readString(4);if(l!==r)throw Error("invalid signature:"+l);return s(t,o.offset,e.size-4,i)}function y(e,t,n,r,i,s){let o=[];if(e.type!==n)throw Error("invalid chunk type:"+e.type);let l=new a(t,e.offset),u=e.offset+e.size;for(;l.offset<u;){let e=r.parse(l,s);if(i&&i(e))break;o.push(e)}return o}let T=(e,t)=>y(e,t,"phdr",d,e=>e.isEnd),S=(e,t)=>y(e,t,"pbag",c),I=(e,t)=>y(e,t,"inst",b,e=>e.isEnd),k=(e,t)=>y(e,t,"ibag",c),P=(e,t)=>y(e,t,"pmod",m,e=>e.isEnd),M=(e,t)=>y(e,t,"imod",m,e=>e.isEnd),O=(e,t)=>y(e,t,"pgen",p,e=>e.isEnd),C=(e,t)=>y(e,t,"igen",p),N=(e,t,n)=>y(e,t,"shdr",g,e=>e.isEnd,n),R=new Map(l.map((e,t)=>[e,t])),E=["keyRange","velRange"],B=new Set(["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey","keynum","velocity"].map(e=>R.get(e))),D=[["keynum","keyRange"],["velocity","velRange"]];function U(e){return E.includes(e)}let x={startAddrsOffset:new v(0,0,32767),endAddrsOffset:new v(-32768,0,0),startloopAddrsOffset:new v(-32768,0,32767),endloopAddrsOffset:new v(-32768,0,32767),startAddrsCoarseOffset:new v(0,0,32767),modLfoToPitch:new v(-12e3,0,12e3),vibLfoToPitch:new v(-12e3,0,12e3),modEnvToPitch:new v(-12e3,0,12e3),initialFilterFc:new v(1500,13500,13500),initialFilterQ:new v(0,0,960),modLfoToFilterFc:new v(-12e3,0,12e3),modEnvToFilterFc:new v(-12e3,0,12e3),endAddrsCoarseOffset:new v(-32768,0,0),modLfoToVolume:new v(-960,0,960),chorusEffectsSend:new v(0,0,1e3),reverbEffectsSend:new v(0,0,1e3),pan:new v(-500,0,500),delayModLFO:new v(-12e3,-12e3,5e3),freqModLFO:new v(-16e3,0,4500),delayVibLFO:new v(-12e3,-12e3,5e3),freqVibLFO:new v(-16e3,0,4500),delayModEnv:new v(-12e3,-12e3,5e3),attackModEnv:new v(-12e3,-12e3,8e3),holdModEnv:new v(-12e3,-12e3,5e3),decayModEnv:new v(-12e3,-12e3,8e3),sustainModEnv:new v(0,0,1e3),releaseModEnv:new v(-12e3,-12e3,8e3),keynumToModEnvHold:new v(-1200,0,1200),keynumToModEnvDecay:new v(-1200,0,1200),delayVolEnv:new v(-12e3,-12e3,5e3),attackVolEnv:new v(-12e3,-12e3,8e3),holdVolEnv:new v(-12e3,-12e3,5e3),decayVolEnv:new v(-12e3,-12e3,8e3),sustainVolEnv:new v(0,0,1440),releaseVolEnv:new v(-12e3,-12e3,8e3),keynumToVolEnvHold:new v(-1200,0,1200),keynumToVolEnvDecay:new v(-1200,0,1200),instrument:new v(-1,-1,32767),keyRange:new f(0,127),velRange:new f(0,127),startloopAddrsCoarseOffset:new v(-32768,0,32767),keynum:new v(-1,-1,127),velocity:new v(-1,-1,127),initialAttenuation:new v(0,0,1440),endloopAddrsCoarseOffset:new v(-32768,0,32767),coarseTune:new v(-120,0,120),fineTune:new v(-99,0,99),sampleID:new v(-1,-1,32767),sampleModes:new v(0,0,3),scaleTuning:new v(0,100,100),exclusiveClass:new v(0,0,127),overridingRootKey:new v(-1,-1,127)};class V{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.parsed=e}getGenerators(e,t,n,r){let a=Array(r-n);for(let i=n;i<r;i++){let r=t[i].generatorIndex,s=t[i+1].generatorIndex;a[i-n]=e.slice(r,s)}return a}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],n=this.parsed.presetHeaders[e+1],r=n?n.presetBagIndex:this.parsed.presetZone.length-1;return this.getGenerators(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,r)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],n=this.parsed.instruments[e+1],r=n?n.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGenerators(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,r)}findInstrumentZone(e,t,n){let r,a=this.getInstrumentGenerators(e);for(let e=0;e<a.length;e++){let i=function(e){let t={};for(let n=0;n<e.length;n++){let r=e[n],a=r.type;if(void 0!==a)if(U(a))t[a]=r.value;else{let e=x[a];t[a]=new v(e.min,r.value,e.max)}}for(let e=0;e<D.length;e++){let[n,r]=D[e],a=t[n];a instanceof v&&0<=a.value&&(t[r]=new f(a.value,a.value))}return t}(a[e]);if(void 0!==i.sampleID){if((!i.keyRange||i.keyRange.in(t))&&(!i.velRange||i.velRange.in(n)))return r?{...r,...i}:i}else r=i}}findInstrument(e,t,n){let r,a=this.getPresetGenerators(e);for(let e=0;e<a.length;e++){let i=function(e){let t={};for(let n=0;n<e.length;n++){let r=e[n],a=r.type;if(void 0!==a&&!B.has(r.code))if(U(a))t[a]=r.value;else{let e=x[a];t[a]=new v(e.min,r.value,e.max)}}return t}(a[e]);if(void 0===i.instrument){r=i;continue}if(i.keyRange&&!i.keyRange.in(t)||i.velRange&&!i.velRange.in(n))continue;let s=this.findInstrumentZone(i.instrument.value,t,n);if(s)return r?this.getInstrument({...r,...i},s):this.getInstrument(i,s)}return null}getInstrument(e,t){let n={...x,...t},r=Object.keys(e);for(let t=0;t<r.length;t++){let a=r[t];if(U(a))continue;let i=n[a],s=e[a];n[a]=new v(i.min,i.value+s.value,i.max)}return n}getInstrumentKey(e,t,n,r){let a=this.parsed.presetHeaders.findIndex(n=>n.preset===t&&n.bank===e);if(a<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let i=this.findInstrument(a,n,r);if(!i)return console.warn("instrument not found: bank=%s instrument=%s",e,t),null;let s={},o=Object.keys(i);for(let e=0;e<o.length;e++){let t=o[e];U(t)?s[t]=i[t]:s[t]=i[t].clamp()}let l=F(s.holdModEnv+(n-60)*s.keynumToModEnvHold),u=F(s.decayModEnv+(n-60)*s.keynumToModEnvDecay),h=F(s.holdVolEnv+(n-60)*s.keynumToVolEnvHold),c=F(s.decayVolEnv+(n-60)*s.keynumToVolEnvDecay),d=this.parsed.samples[s.sampleID],f=this.parsed.sampleHeaders[s.sampleID],m=s.coarseTune+s.fineTune/100,p=-1===s.overridingRootKey?f.originalPitch:s.overridingRootKey,b=m+f.pitchCorrection/100-p,g=s.scaleTuning/100;return{start:32768*s.startAddrsCoarseOffset+s.startAddrsOffset,end:32768*s.endAddrsCoarseOffset+s.endAddrsOffset,loopStart:f.loopStart+32768*s.startloopAddrsCoarseOffset+s.startloopAddrsOffset,loopEnd:f.loopEnd+32768*s.endloopAddrsCoarseOffset+s.endloopAddrsOffset,modLfoToPitch:s.modLfoToPitch,vibLfoToPitch:s.vibLfoToPitch,modEnvToPitch:s.modEnvToPitch,initialFilterFc:s.initialFilterFc,initialFilterQ:s.initialFilterQ,modLfoToFilterFc:s.modLfoToFilterFc,modEnvToFilterFc:s.modEnvToFilterFc,modLfoToVolume:s.modLfoToVolume,chorusEffectsSend:s.chorusEffectsSend/1e3,reverbEffectsSend:s.reverbEffectsSend/1e3,pan:s.pan,delayModLFO:F(s.delayModLFO),freqModLFO:s.freqModLFO,delayVibLFO:F(s.delayVibLFO),freqVibLFO:s.freqVibLFO,modDelay:F(s.delayModEnv),modAttack:F(s.attackModEnv),modHold:l,modDecay:u,modSustain:s.sustainModEnv/1e3,modRelease:F(s.releaseModEnv),volDelay:F(s.delayVolEnv),volAttack:F(s.attackVolEnv),volHold:h,volDecay:c,volSustain:s.sustainVolEnv/1e3,volRelease:F(s.releaseVolEnv),initialAttenuation:s.initialAttenuation,playbackRate:e=>Math.pow(Math.pow(2,1/12),(e+b)*g),sample:d,sampleRate:f.sampleRate,sampleName:f.sampleName,sampleModes:s.sampleModes,exclusiveClass:s.exclusiveClass}}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let n=0;n<t.length;n++){let r=t[n];e[r.bank]||(e[r.bank]={}),e[r.bank][r.preset]=r.presetName}return e}}function F(e){return Math.pow(2,e/1200)}class A{bufferSource;filterNode;volumeNode;volumeDepth;modulationLFO;modulationDepth;vibratoLFO;vibratoDepth;constructor(e,t,n,r){this.noteNumber=e,this.velocity=t,this.startTime=n,this.instrumentKey=r}}class L{ticksPerBeat=120;totalTime=0;masterFineTuning=0;masterCoarseTuning=0;reverb={time:this.getReverbTime(64),feedback:.8};chorus={modRate:this.getChorusModRate(3),modDepth:this.getChorusModDepth(19),feedback:this.getChorusFeedback(8),sendToReverb:this.getChorusSendToReverb(0),delayTimes:this.generateDistributedArray(.02,2,.5)};mono=!1;omni=!1;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=this.initSoundFontTable();isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;timeline=[];instruments=[];notePromises=[];static channelSettings={currentBufferSource:null,volume:100/127,pan:64,portamentoTime:1,reverbSendLevel:0,chorusSendLevel:0,vibratoRate:1,vibratoDepth:1,vibratoDelay:1,bank:15488,bankMSB:121,bankLSB:0,dataMSB:0,dataLSB:0,program:0,pitchBend:0,fineTuning:0,coarseTuning:0,modulationDepthRange:50};static effectSettings={expression:1,modulationDepth:0,sustainPedal:!1,portamento:!1,sostenutoPedal:!1,softPedal:0,rpnMSB:127,rpnLSB:127,channelPressure:0,pitchBendRange:2};static controllerDestinationSettings={pitchControl:0,filterCutoffControl:0,amplitudeControl:1,lfoPitchDepth:0,lfoFilterDepth:0,lfoAmplitudeDepth:0};defaultOptions={reverbAlgorithm:e=>{let{time:t,feedback:n}=this.reverb,r=this.generateDistributedArray(n,4),a=r.map(e=>this.calcDelay(t,e)),i=this.generateDistributedArray(n,4),s=i.map(e=>this.calcDelay(t,e));return this.createSchroederReverb(e,r,a,i,s)}};constructor(e,t=this.defaultOptions){this.audioContext=e,this.options={...this.defaultOptions,...t},this.masterGain=new GainNode(e),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.reverbEffect=this.options.reverbAlgorithm(e),this.chorusEffect=this.createChorusEffect(e),this.chorusEffect.output.connect(this.masterGain),this.reverbEffect.output.connect(this.masterGain),this.masterGain.connect(e.destination),this.GM2SystemOn()}initSoundFontTable(){let e=Array(128);for(let t=0;t<128;t++)e[t]=new Map;return e}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let n=e.parsed.presetHeaders;for(let e=0;e<n.length;e++){let r=n[e];r.presetName.startsWith("\0")||this.soundFontTable[r.preset].set(r.bank,t)}}async loadSoundFont(e){let t=await fetch(e),n=new V(function(e,t={}){var n,r,a,o,l;let u=s(e,0,e.length,t);if(1!==u.length)throw Error("wrong chunk length");let c=u[0];if(null===c)throw Error("chunk not found");let d=function(e,t,n={}){let r=w(e,t,"RIFF","sfbk",n);if(3!==r.length)throw Error("invalid sfbk structure");let a=function(e,t){let n=w(e,t,"LIST","INFO");return h.parse(t,n)}(r[0],t),s=3===a.version.major;return s&&"LIST"!==r[2].type&&(r[2]=i(t,r[2].offset-9,!1)),{info:a,samplingData:function(e,t){let n=w(e,t,"LIST","sdta");return{offsetMSB:n[0].offset,offsetLSB:n[1]?.offset}}(r[1],t),...function(e,t,n){let r=w(e,t,"LIST","pdta");if(9!==r.length)throw Error("invalid pdta chunk");return{presetHeaders:T(r[0],t),presetZone:S(r[1],t),presetModulators:P(r[2],t),presetGenerators:O(r[3],t),instruments:I(r[4],t),instrumentZone:k(r[5],t),instrumentModulators:M(r[6],t),instrumentGenerators:C(r[7],t),sampleHeaders:N(r[8],t,n)}}(r[2],t,s)}}(c,e,t),f=3===d.info.version.major;return{...d,samples:(n=d.sampleHeaders,r=d.samplingData.offsetMSB,a=d.samplingData.offsetLSB,o=e,l=f,n.map(e=>{let{start:t,end:n}=e;return l||(t*=2,n*=2),new Uint8Array(o.subarray(r+t,r+n))}))}}(new Uint8Array(await t.arrayBuffer())));this.addSoundFont(n)}async loadMIDI(e){let t=await fetch(e),n=r(new Uint8Array(await t.arrayBuffer()));this.ticksPerBeat=n.header.ticksPerBeat;let a=this.extractMidiData(n);this.instruments=a.instruments,this.timeline=a.timeline,this.totalTime=this.calcTotalTime()}setChannelAudioNodes(e){let{gainLeft:t,gainRight:n}=this.panToGain(this.constructor.channelSettings.pan),r=new GainNode(e,{gain:t}),a=new GainNode(e,{gain:n}),i=new ChannelMergerNode(e,{numberOfInputs:2});return r.connect(i,0,0),a.connect(i,0,1),i.connect(this.masterGain),{gainL:r,gainR:a,merger:i}}createChannels(e){return Array.from({length:16},()=>({...this.constructor.channelSettings,...this.constructor.effectSettings,...this.setChannelAudioNodes(e),scheduledNotes:new Map,sostenutoNotes:new Map,channelPressure:{...this.constructor.controllerDestinationSettings}}))}async createNoteBuffer(e,t){let n=e.start,r=e.sample.length+e.end;if(t){let t=e.sample.slice(n,r);return await this.audioContext.decodeAudioData(t.buffer)}{let t=e.sample.subarray(n,r),a=new AudioBuffer({numberOfChannels:1,length:t.length,sampleRate:e.sampleRate}),i=a.getChannelData(0),s=new Int16Array(t.buffer);for(let e=0;e<s.length;e++)i[e]=s[e]/32768;return a}}async createNoteBufferNode(e,t){let n=new AudioBufferSourceNode(this.audioContext);return n.buffer=await this.createNoteBuffer(e,t),n.loop=e.sampleModes%2!=0,n.loop&&(n.loopStart=e.loopStart/e.sampleRate,n.loopEnd=e.loopEnd/e.sampleRate),n}findPortamentoTarget(e){let t,n=this.timeline[e];if(!this.channels[n.channel].portamento)return;let r=n.startTime;for(;++e<this.timeline.length;){let n=this.timeline[e];if(r!==n.startTime)break;"noteOn"===n.type&&(!t||n.noteNumber<t.noteNumber)&&(t=n)}return t}async scheduleTimelineEvents(e,t,n){for(;n<this.timeline.length;){let r=this.timeline[n];if(r.startTime>e+this.lookAhead)break;switch(r.type){case"noteOn":if(0!==r.velocity){await this.scheduleNoteOn(r.channel,r.noteNumber,r.velocity,r.startTime+this.startDelay-t,r.portamento);break}case"noteOff":{let e=this.findPortamentoTarget(n);e&&(e.portamento=!0);let a=this.scheduleNoteRelease(this.omni?0:r.channel,r.noteNumber,r.velocity,r.startTime+this.startDelay-t,e?.noteNumber,!1);a&&this.notePromises.push(a);break}case"controller":this.handleControlChange(this.omni?0:r.channel,r.controllerType,r.value);break;case"programChange":this.handleProgramChange(r.channel,r.programNumber);break;case"channelAftertouch":this.handleChannelPressure(r.channel,r.amount);break;case"pitchBend":this.setPitchBend(r.channel,r.value);break;case"sysEx":this.handleSysEx(r.data)}n++}return n}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}playNotes(){return new Promise(e=>{this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime;this.notePromises=[];let r=async()=>{if(t>=this.timeline.length){await Promise.all(this.notePromises),this.notePromises=[],e();return}let a=this.audioContext.currentTime+n;if(t=await this.scheduleTimelineEvents(a,n,t),this.isPausing){await this.stopNotes(0,!0),this.notePromises=[],e(),this.isPausing=!1,this.isPaused=!0;return}if(this.isStopping){await this.stopNotes(0,!0),this.notePromises=[],e(),this.isStopping=!1,this.isPaused=!1;return}if(this.isSeeking)this.stopNotes(0,!0),this.startTime=this.audioContext.currentTime,t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime,this.isSeeking=!1,await r();else{let e=this.audioContext.currentTime+this.noteCheckInterval;await this.scheduleTask(()=>{},e),await r()}};r()})}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}extractMidiData(e){let t=new Set,n=[],r=Array(16);for(let e=0;e<r.length;e++)r[e]={programNumber:-1,bankMSB:this.channels[e].bankMSB,bankLSB:this.channels[e].bankLSB};for(let a=0;a<e.tracks.length;a++){let i=e.tracks[a],s=0;for(let e=0;e<i.length;e++){let a=i[e];switch(s+=a.deltaTime,a.ticks=s,a.type){case"noteOn":{let e=r[a.channel];if(e.programNumber<0){switch(e.programNumber=a.programNumber,e.bankMSB){case 120:t.add("128:0");break;case 121:t.add(`${e.bankLSB}:0`);break;default:{let n=128*e.bankMSB+e.bankLSB;t.add(`${n}:0`)}}e.programNumber=0}break}case"controller":switch(a.controllerType){case 0:r[a.channel].bankMSB=a.value;break;case 32:r[a.channel].bankLSB=a.value}break;case"programChange":{let e=r[a.channel];switch(e.programNumber=a.programNumber,e.bankMSB){case 120:t.add(`128:${e.programNumber}`);break;case 121:t.add(`${e.bankLSB}:${e.programNumber}`);break;default:{let n=128*e.bankMSB+e.bankLSB;t.add(`${n}:${e.programNumber}`)}}}}delete a.deltaTime,n.push(a)}}let a={controller:0,sysEx:1,noteOff:2,noteOn:3};n.sort((e,t)=>e.ticks!==t.ticks?e.ticks-t.ticks:(a[e.type]||4)-(a[t.type]||4));let i=0,s=0,o=.5;for(let e=0;e<n.length;e++){let t=n[e],r=this.ticksToSecond(t.ticks-s,o);t.startTime=i+r,"setTempo"===t.type&&(i+=this.ticksToSecond(t.ticks-s,o),o=t.microsecondsPerBeat/1e6,s=t.ticks)}return{instruments:t,timeline:n}}async stopChannelNotes(e,t,n){let r=this.audioContext.currentTime,a=this.channels[e];a.scheduledNotes.forEach(a=>{for(let i=0;i<a.length;i++){let s=a[i];if(!s)continue;let o=this.scheduleNoteRelease(e,s.noteNumber,t,r,void 0,n);this.notePromises.push(o)}}),a.scheduledNotes.clear(),await Promise.all(this.notePromises)}stopNotes(e,t){for(let n=0;n<this.channels.length;n++)this.stopChannelNotes(n,e,t);return Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,await this.playNotes(),this.isPlaying=!1)}stop(){this.isPlaying&&(this.isStopping=!0)}pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}async resume(){this.isPaused&&(await this.playNotes(),this.isPlaying=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let n=this.timeline[t];e<n.startTime&&(e=n.startTime)}return e}currentTime(){let e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}getActiveNotes(e,t){let n=new Map;return e.scheduledNotes.forEach(e=>{let r=this.getActiveNote(e,t);r&&n.set(r.noteNumber,r)}),n}getActiveNote(e,t){for(let n=e.length-1;n>=0;n--){let r=e[n];if(!r)return;if(!(t<r.startTime))return r.ending?null:r}return e[0]}createConvolutionReverbImpulse(e,t,n){let r=e.sampleRate,a=r*t,i=new AudioBuffer({numberOfChannels:2,length:a,sampleRate:r}),s=Math.min(r*n,a);for(let e=0;e<i.numberOfChannels;e++){let n=i.getChannelData(e);for(let e=0;e<s;e++)n[e]=2*Math.random()-1;let o=1/(r*t);for(let e=s;e<a;e++){let t=Math.exp(-(e-s)*o);n[e]=(2*Math.random()-1)*t}}return i}createConvolutionReverb(e,t){let n=new GainNode(e),r=new ConvolverNode(e,{buffer:t});return r.connect(n),{input:r,output:n,convolverNode:r}}createCombFilter(e,t,n,r){let a=new DelayNode(e,{maxDelayTime:n,delayTime:n}),i=new GainNode(e,{gain:r});return t.connect(a),a.connect(i),i.connect(a),a}createAllpassFilter(e,t,n,r){let a=new DelayNode(e,{maxDelayTime:n,delayTime:n}),i=new GainNode(e,{gain:r}),s=new GainNode(e,{gain:1-r});return t.connect(a),a.connect(i),i.connect(a),a.connect(s),s}generateDistributedArray(e,t,n=.1,r=.05){let a=e*n,i=Array(t);for(let n=0;n<t;n++){let s=e-a+n/(t-1||1)*2*a;i[n]=s*(1-(2*Math.random()-1)*r)}return i}createSchroederReverb(e,t,n,r,a){let i=new GainNode(e),s=new GainNode(e),o=new GainNode(e);for(let r=0;r<n.length;r++)this.createCombFilter(e,i,n[r],t[r]).connect(o);let l=[];for(let t=0;t<a.length;t++){let n=this.createAllpassFilter(e,0===t?o:l.at(-1),a[t],r[t]);l.push(n)}return l.at(-1).connect(s),{input:i,output:s}}createChorusEffect(e){let t=new GainNode(e),n=new GainNode(e),r=new GainNode(e),a=new OscillatorNode(e,{frequency:this.chorus.modRate}),i=new GainNode(e,{gain:this.chorus.modDepth/2}),s=this.chorus.delayTimes,o=[],l=[];for(let r=0;r<s.length;r++){let a=new DelayNode(e,{maxDelayTime:.1,delayTime:s[r]}),u=new GainNode(e,{gain:this.chorus.feedback});o.push(a),l.push(u),t.connect(a),i.connect(a.delayTime),a.connect(u),u.connect(a),a.connect(n)}return n.connect(r),a.connect(i),a.start(),{input:t,output:n,sendGain:r,lfo:a,lfoGain:i,delayNodes:o,feedbackGains:l}}cbToRatio(e){return Math.pow(10,e/200)}centToHz(e){return 8.176*Math.pow(2,e/1200)}calcSemitoneOffset(e){let t=this.masterCoarseTuning+this.masterFineTuning,n=e.coarseTuning+e.fineTuning;return e.pitchBend*e.pitchBendRange+(t+n)}calcPlaybackRate(e,t,n){return e.playbackRate(t)*Math.pow(2,n/12)}setPortamentoStartVolumeEnvelope(e,t){let{instrumentKey:n,startTime:r}=t,a=this.cbToRatio(-n.initialAttenuation)*(1-n.volSustain),i=r+n.volDelay,s=i+e.portamentoTime;t.volumeNode.gain.cancelScheduledValues(r).setValueAtTime(0,i).linearRampToValueAtTime(a,s)}setVolumeEnvelope(e){let{instrumentKey:t,startTime:n}=e,r=this.cbToRatio(-t.initialAttenuation),a=r*(1-t.volSustain),i=n+t.volDelay,s=i+t.volAttack,o=s+t.volHold,l=o+t.volDecay;e.volumeNode.gain.cancelScheduledValues(n).setValueAtTime(0,n).setValueAtTime(1e-6,i).exponentialRampToValueAtTime(r,s).setValueAtTime(r,o).linearRampToValueAtTime(a,l)}setPitch(e,t){let{instrumentKey:n,noteNumber:r,startTime:a}=e,i=n.modEnvToPitch/100;if(e.bufferSource.playbackRate.value=this.calcPlaybackRate(n,r,t),0===i)return;let s=e.bufferSource.playbackRate.value,o=this.calcPlaybackRate(n,r,t+i),l=a+n.modDelay,u=l+n.modAttack,h=u+n.modHold,c=h+n.modDecay;e.bufferSource.playbackRate.value.setValueAtTime(s,l).exponentialRampToValueAtTime(o,u).setValueAtTime(o,h).linearRampToValueAtTime(s,c)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setPortamentoStartFilterEnvelope(e,t){let{instrumentKey:n,noteNumber:r,startTime:a}=t,i=1-(.1+r/127*.2)*e.softPedal,s=this.centToHz(n.initialFilterFc)*i,o=s+(this.centToHz(n.initialFilterFc+n.modEnvToFilterFc)*i-s)*(1-n.modSustain),l=this.clampCutoffFrequency(s),u=this.clampCutoffFrequency(o),h=a+e.portamentoTime,c=a+n.modDelay;t.filterNode.frequency.cancelScheduledValues(a).setValueAtTime(l,a).setValueAtTime(l,c).linearRampToValueAtTime(u,h)}setFilterEnvelope(e,t){let{instrumentKey:n,noteNumber:r,startTime:a}=t,i=1-(.1+r/127*.2)*e.softPedal,s=this.centToHz(n.initialFilterFc)*i,o=this.centToHz(n.initialFilterFc+n.modEnvToFilterFc)*i,l=s+(o-s)*(1-n.modSustain),u=this.clampCutoffFrequency(s),h=this.clampCutoffFrequency(o),c=this.clampCutoffFrequency(l),d=a+n.modDelay,f=d+n.modAttack,m=f+n.modHold,p=m+n.modDecay;t.filterNode.frequency.cancelScheduledValues(a).setValueAtTime(u,a).setValueAtTime(u,d).exponentialRampToValueAtTime(h,f).setValueAtTime(h,m).linearRampToValueAtTime(c,p)}startModulation(e,t,n){let{instrumentKey:r}=t,{modLfoToPitch:a,modLfoToVolume:i}=r;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(r.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:r.modLfoToFilterFc});let s=Math.abs(a)+e.modulationDepth;t.modulationDepth=new GainNode(this.audioContext,{gain:s*(0<a?1:-1)});let o=this.cbToRatio(Math.abs(i))-1;t.volumeDepth=new GainNode(this.audioContext,{gain:o*(0<i?1:-1)}),t.modulationLFO.start(n+r.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeNode.gain)}startVibrato(e,t,n){let{instrumentKey:r}=t,{vibLfoToPitch:a}=r;t.vibratoLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(r.freqVibLFO)*e.vibratoRate});let i=Math.abs(a)*e.vibratoDepth;t.vibratoDepth=new GainNode(this.audioContext,{gain:i*(0<a)}),t.vibratoLFO.start(n+r.delayVibLFO*e.vibratoDelay),t.vibratoLFO.connect(t.vibratoDepth),t.vibratoDepth.connect(t.bufferSource.detune)}async createNote(e,t,n,r,a,i,s){let o=this.calcSemitoneOffset(e),l=new A(n,r,a,t);return l.bufferSource=await this.createNoteBufferNode(t,s),l.volumeNode=new GainNode(this.audioContext),l.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:t.initialFilterQ/10}),i?(this.setPortamentoStartVolumeEnvelope(e,l),this.setPortamentoStartFilterEnvelope(e,l)):(this.setVolumeEnvelope(l),this.setFilterEnvelope(e,l)),0<e.vibratoDepth&&this.startVibrato(e,l,a),0<e.modulationDepth?(this.setPitch(l,o),this.startModulation(e,l,a)):l.bufferSource.playbackRate.value=this.calcPlaybackRate(t,n,o),this.mono&&e.currentBufferSource&&(e.currentBufferSource.stop(a),e.currentBufferSource=l.bufferSource),l.bufferSource.connect(l.filterNode),l.filterNode.connect(l.volumeNode),l.bufferSource.start(a),l}calcBank(e,t){return 121===e.bankMSB?0:t%9<=1&&120===e.bankMSB?128:e.bank}async scheduleNoteOn(e,t,n,r,a){let i=this.channels[e],s=this.calcBank(i,e),o=this.soundFontTable[i.program].get(s);if(void 0===o)return;let l=this.soundFonts[o],u=3===l.parsed.info.version.major,h=l.getInstrumentKey(s,i.program,t,n);if(!h)return;let c=await this.createNote(i,h,t,n,r,a,u);c.volumeNode.connect(i.gainL),c.volumeNode.connect(i.gainR),i.sostenutoPedal&&i.sostenutoNotes.set(t,c);let d=i.scheduledNotes;d.has(t)?d.get(t).push(c):d.set(t,[c])}noteOn(e,t,n,r){let a=this.audioContext.currentTime;return this.scheduleNoteOn(e,t,n,a,r)}stopNote(e,t,n,r){let a=n[r];return a.volumeNode.gain.cancelScheduledValues(e).linearRampToValueAtTime(0,t),a.ending=!0,this.scheduleTask(()=>{a.bufferSource.loop=!1},t),new Promise(e=>{a.bufferSource.onended=()=>{n[r]=null,a.bufferSource.disconnect(),a.volumeNode.disconnect(),a.filterNode.disconnect(),a.modulationDepth&&(a.volumeDepth.disconnect(),a.modulationDepth.disconnect(),a.modulationLFO.stop()),a.vibratoDepth&&(a.vibratoDepth.disconnect(),a.vibratoLFO.stop()),e()},a.bufferSource.stop(t)})}scheduleNoteRelease(e,t,n,r,a,i){let s=this.channels[e];if(!i&&(s.sustainPedal||s.sostenutoNotes.has(t))||!s.scheduledNotes.has(t))return;let o=s.scheduledNotes.get(t);for(let e=0;e<o.length;e++){let n=o[e];if(n&&!n.ending)if(void 0===a){let t=r+n.instrumentKey.volRelease,a=r+n.instrumentKey.modRelease;return n.filterNode.frequency.cancelScheduledValues(r).linearRampToValueAtTime(0,a),this.stopNote(r,t,o,e)}else{let i=r+s.portamentoTime,l=(a-t)*100,u=n.bufferSource.detune.value+l;return n.bufferSource.detune.cancelScheduledValues(r).linearRampToValueAtTime(u,i),this.stopNote(r,i,o,e)}}}releaseNote(e,t,n,r){let a=this.audioContext.currentTime;return this.scheduleNoteRelease(e,t,n,a,r,!1)}releaseSustainPedal(e,t){let n=2*t,r=this.channels[e],a=[];return r.sustainPedal=!1,r.scheduledNotes.forEach(t=>{for(let r=0;r<t.length;r++){let i=t[r];if(!i)continue;let{noteNumber:s}=i,o=this.releaseNote(e,s,n);a.push(o)}}),a}releaseSostenutoPedal(e,t){let n=2*t,r=this.channels[e],a=[];return r.sostenutoPedal=!1,r.sostenutoNotes.forEach(t=>{let{noteNumber:r}=t,i=this.releaseNote(e,r,n);a.push(i)}),r.sostenutoNotes.clear(),a}handleMIDIMessage(e,t,n){let r=omni?0:15&e,a=240&e;switch(a){case 128:return this.releaseNote(r,t,n);case 144:return this.noteOn(r,t,n);case 176:return this.handleControlChange(r,t,n);case 192:return this.handleProgramChange(r,t);case 208:return this.handleChannelPressure(r,t);case 224:return this.handlePitchBendMessage(r,t,n);default:console.warn(`Unsupported MIDI message: ${a.toString(16)}`)}}handleProgramChange(e,t){let n=this.channels[e];n.bank=128*n.bankMSB+n.bankLSB,n.program=t}handleChannelPressure(e,t){let n=this.audioContext.currentTime,r=this.channels[e];r.channelPressure=t/=64;let a=this.getActiveNotes(r,n);1!==r.channelPressure.amplitudeControl&&a.forEach(e=>{let r=e.volumeNode.gain.value;e.volumeNode.gain.cancelScheduledValues(n).setValueAtTime(r*t,n)})}handlePitchBendMessage(e,t,n){this.setPitchBend(e,128*n+t-8192)}setPitchBend(e,t){let n=this.channels[e],r=n.pitchBend;n.pitchBend=t/8192;let a=(n.pitchBend-r)*n.pitchBendRange*100;this.updateDetune(n,a)}createControlChangeHandlers(){return{0:this.setBankMSB,1:this.setModulationDepth,5:this.setPortamentoTime,6:this.dataEntryMSB,7:this.setVolume,10:this.setPan,11:this.setExpression,32:this.setBankLSB,38:this.dataEntryLSB,64:this.setSustainPedal,65:this.setPortamento,66:this.setSostenutoPedal,67:this.setSoftPedal,91:this.setReverbSendLevel,93:this.setChorusSendLevel,100:this.setRPNLSB,101:this.setRPNMSB,120:this.allSoundOff,121:this.resetAllControllers,123:this.allNotesOff,124:this.omniOff,125:this.omniOn,126:this.monoOn,127:this.polyOn}}handleControlChange(e,t,n){let r=this.controlChangeHandlers[t];r?r.call(this,e,n):console.warn(`Unsupported Control change: controller=${t} value=${n}`)}setBankMSB(e,t){this.channels[e].bankMSB=t}updateModulation(e){let t=this.audioContext.currentTime;e.scheduledNotes.forEach(n=>{for(let r=0;r<n.length;r++){let a=n[r];if(a)if(a.modulationDepth)a.modulationDepth.gain.setValueAtTime(e.modulationDepth,t);else{let n=this.calcSemitoneOffset(e);this.setPitch(a,n),this.startModulation(e,a,t)}}})}setModulationDepth(e,t){let n=this.channels[e];n.modulationDepth=t/127*n.modulationDepthRange,this.updateModulation(n)}setPortamentoTime(e,t){this.channels[e].portamentoTime=Math.exp(5*Math.log(10)/127*t)}setVolume(e,t){let n=this.channels[e];n.volume=t/127,this.updateChannelVolume(n)}panToGain(e){let t=Math.PI/2*Math.max(0,e-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t){let n=this.channels[e];n.pan=t,this.updateChannelVolume(n)}setExpression(e,t){let n=this.channels[e];n.expression=t/127,this.updateChannelVolume(n)}setBankLSB(e,t){this.channels[e].bankLSB=t}dataEntryLSB(e,t){this.channels[e].dataLSB=t,this.handleRPN(e)}updateChannelVolume(e){let t=this.audioContext.currentTime,n=e.volume*e.expression,{gainLeft:r,gainRight:a}=this.panToGain(e.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(n*r,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(n*a,t)}setSustainPedal(e,t){let n=t>=64;this.channels[e].sustainPedal=n,n||this.releaseSustainPedal(e,t)}setPortamento(e,t){this.channels[e].portamento=t>=64}setReverbSendLevel(e,t){let n=this.channels[e],r=this.reverbEffect;if(0<n.reverbSendLevel)if(0<t){let e=this.audioContext.currentTime;n.reverbSendLevel=t/127,r.output.gain.cancelScheduledValues(e),r.output.gain.setValueAtTime(n.reverbSendLevel,e)}else n.merger.disconnect(r.input);else if(0<t){n.merger.connect(r.input);let e=this.audioContext.currentTime;n.reverbSendLevel=t/127,r.output.gain.cancelScheduledValues(e),r.output.gain.setValueAtTime(n.reverbSendLevel,e)}}setChorusSendLevel(e,t){let n=this.channels[e],r=this.chorusEffect;if(0<n.chorusSendLevel)if(0<t){let e=this.audioContext.currentTime;n.chorusSendLevel=t/127,r.output.gain.cancelScheduledValues(e),r.output.gain.setValueAtTime(n.chorusSendLevel,e)}else n.merger.disconnect(r.input);else if(0<t){n.merger.connect(r.input);let e=this.audioContext.currentTime;n.chorusSendLevel=t/127,r.output.gain.cancelScheduledValues(e),r.output.gain.setValueAtTime(n.chorusSendLevel,e)}}setSostenutoPedal(e,t){let n=t>=64,r=this.channels[e];if(r.sostenutoPedal=n,n){let e=this.audioContext.currentTime,t=this.getActiveNotes(r,e);r.sostenutoNotes=new Map(t)}else this.releaseSostenutoPedal(e,t)}setSoftPedal(e,t){this.channels[e].softPedal=t/127}limitData(e,t,n,r,a){a<e.dataLSB?(e.dataMSB++,e.dataLSB=r):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=a),n<e.dataMSB?(e.dataMSB=n,e.dataLSB=a):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=r)}limitDataMSB(e,t,n){n<e.dataMSB?e.dataMSB=n:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e){let t=this.channels[e];switch(128*t.rpnMSB+t.rpnLSB){case 0:this.handlePitchBendRangeRPN(e);break;case 1:this.handleFineTuningRPN(e);break;case 2:this.handleCoarseTuningRPN(e);break;case 5:this.handleModulationDepthRangeRPN(e);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${t.rpnMSB} LSB=${t.rpnLSB}`)}}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t){this.channels[e].dataMSB=t,this.handleRPN(e)}updateDetune(e,t){let n=this.audioContext.currentTime;e.scheduledNotes.forEach(e=>{for(let r=0;r<e.length;r++){let a=e[r];if(!a)continue;let{bufferSource:i}=a,s=i.detune.value+t;i.detune.cancelScheduledValues(n).setValueAtTime(s,n)}})}handlePitchBendRangeRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,99);let n=t.dataMSB+t.dataLSB/100;this.setPitchBendRange(e,n)}setPitchBendRange(e,t){let n=this.channels[e],r=n.pitchBendRange;n.pitchBendRange=t;let a=(n.pitchBendRange-r)*n.pitchBend*100;this.updateDetune(n,a)}handleFineTuningRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,127);let n=(128*t.dataMSB+t.dataLSB-8192)/8192;this.setFineTuning(e,n)}setFineTuning(e,t){let n=this.channels[e],r=n.fineTuning;n.fineTuning=t;let a=n.fineTuning-r;this.updateDetune(n,a)}handleCoarseTuningRPN(e){let t=this.channels[e];this.limitDataMSB(t,0,127);let n=t.dataMSB-64;this.setFineTuning(e,n)}setCoarseTuning(e,t){let n=this.channels[e],r=n.coarseTuning;n.coarseTuning=t;let a=n.coarseTuning-r;this.updateDetune(n,a)}handleModulationDepthRangeRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,127);let n=(dataMSB+dataLSB/128)*100;this.setModulationDepthRange(e,n)}setModulationDepthRange(e,t){let n=this.channels[e];n.modulationDepthRange=t,n.modulationDepth=modulation/127*t,this.updateModulation(n)}allSoundOff(e){return this.stopChannelNotes(e,0,!0)}resetAllControllers(e){Object.assign(this.channels[e],this.effectSettings)}allNotesOff(e){return this.stopChannelNotes(e,0,!1)}omniOff(){this.omni=!1}omniOn(){this.omni=!0}monoOn(){this.mono=!0}polyOn(){this.mono=!1}handleUniversalNonRealTimeExclusiveMessage(e){if(9===e[2])switch(e[3]){case 1:this.GM1SystemOn();break;case 2:break;case 3:this.GM2SystemOn();break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}else console.warn(`Unsupported Exclusive Message: ${e}`)}GM1SystemOn(){for(let e=0;e<this.channels.length;e++){let t=this.channels[e];t.bankMSB=0,t.bankLSB=0,t.bank=0}this.channels[9].bankMSB=1,this.channels[9].bank=128}GM2SystemOn(){for(let e=0;e<this.channels.length;e++){let t=this.channels[e];t.bankMSB=121,t.bankLSB=0,t.bank=15488}this.channels[9].bankMSB=120,this.channels[9].bank=15360}handleUniversalRealTimeExclusiveMessage(e){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e);case 3:return this.handleMasterFineTuningSysEx(e);case 4:return this.handleMasterCoarseTuningSysEx(e);case 5:return this.handleGlobalParameterControlSysEx(e);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 8:case 9:case 10:e[3],console.warn(`Unsupported Exclusive Message: ${e}`);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e){let t=(128*e[5]+e[4])/16383;this.setMasterVolume(t)}setMasterVolume(e){if(e<0&&1<e)console.error("Master Volume is out of range");else{let t=this.audioContext.currentTime;this.masterGain.gain.cancelScheduledValues(t),this.masterGain.gain.setValueAtTime(e*e,t)}}handleMasterFineTuningSysEx(e){let t=(128*e[5]+e[4]-8192)/8192;this.setMasterFineTuning(t)}setMasterFineTuning(e){e<-1&&1<e?console.error("Master Fine Tuning value is out of range"):this.masterFineTuning=e}handleMasterCoarseTuningSysEx(e){let t=e[4];this.setMasterCoarseTuning(t)}setMasterCoarseTuning(e){e<0&&127<e?console.error("Master Coarse Tuning value is out of range"):this.masterCoarseTuning=e-64}handleGlobalParameterControlSysEx(e){if(1===e[7])switch(e[8]){case 1:return this.handleReverbParameterSysEx(e);case 2:return this.handleChorusParameterSysEx(e);default:console.warn(`Unsupported Global Parameter Control Message: ${e}`)}else console.warn(`Unsupported Global Parameter Control Message: ${e}`)}handleReverbParameterSysEx(e){switch(e[9]){case 0:return this.setReverbType(e[10]);case 1:return this.setReverbTime(e[10])}}setReverbType(e){this.reverb.time=this.getReverbTimeFromType(e),this.reverb.feedback=8===e?.9:.8;let{audioContext:t,options:n}=this;this.reverbEffect=n.reverbAlgorithm(t)}getReverbTimeFromType(e){switch(e){case 0:return this.getReverbTime(44);case 1:case 8:return this.getReverbTime(50);case 2:return this.getReverbTime(56);case 3:case 4:return this.getReverbTime(64);default:console.warn(`Unsupported Reverb Time: ${e}`)}}setReverbTime(e){this.reverb.time=this.getReverbTime(e);let{audioContext:t,channels:n,options:r}=this;for(let e=0;e<n.length;e++)n[e].reverbEffect=r.reverbAlgorithm(t)}getReverbTime(e){return Math.pow(Math.E,(e-40)*.025)}calcDelay(e,t){return-e*Math.log10(t)/3}handleChorusParameterSysEx(e){switch(e[9]){case 0:return this.setChorusType(e[10]);case 1:return this.setChorusModRate(e[10]);case 2:return this.setChorusModDepth(e[10]);case 3:return this.setChorusFeedback(e[10]);case 4:return this.setChorusSendToReverb(e[10])}}setChorusType(e){switch(e){case 0:return this.setChorusParameter(3,5,0,0);case 1:return this.setChorusParameter(9,19,5,0);case 2:return this.setChorusParameter(3,19,8,0);case 3:return this.setChorusParameter(9,16,16,0);case 4:return this.setChorusParameter(2,24,64,0);case 5:return this.setChorusParameter(1,5,112,0);default:console.warn(`Unsupported Chorus Type: ${e}`)}}setChorusParameter(e,t,n,r){this.setChorusModRate(e),this.setChorusModDepth(t),this.setChorusFeedback(n),this.setChorusSendToReverb(r)}setChorusModRate(e){let t=this.audioContext.currentTime,n=this.getChorusModRate(e);this.chorus.modRate=n;for(let e=0;e<this.channels.length;e++)this.channels[e].chorusEffect.lfo.frequency.setValueAtTime(n,t)}getChorusModRate(e){return .122*e}setChorusModDepth(e){let t=this.audioContext.currentTime,n=this.getChorusModDepth(e);this.chorus.modDepth=n;for(let e=0;e<this.channels.length;e++)this.channels[e].chorusEffect.lfoGain.gain.cancelScheduledValues(t).setValueAtTime(n/2,t)}getChorusModDepth(e){return(e+1)/3200}setChorusFeedback(e){let t=this.audioContext.currentTime,n=this.getChorusFeedback(e);this.chorus.feedback=n;for(let e=0;e<this.channels.length;e++){let r=this.channels[e].chorusEffect;for(let e=0;e<r.feedbackGains.length;e++)r.feedbackGains[e].gain.cancelScheduledValues(t).setValueAtTime(n,t)}}getChorusFeedback(e){return .00763*e}setChorusSendToReverb(e){let t=this.getChorusSendToReverb(e);if(0<t){let e=this.audioContext.currentTime;this.chorus.sendToReverb=t,this.chorusEffect.sendGain.gain.cancelScheduledValues(e).setValueAtTime(t,e)}else 0!==this.chorus.sendToReverb&&this.chorusEffect.sendGain.disconnect(this.reverbEffect.input)}getChorusSendToReverb(e){return .00787*e}handleExclusiveMessage(e){console.warn(`Unsupported Exclusive Message: ${e}`)}handleSysEx(e){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e);case 127:return this.handleUniversalRealTimeExclusiveMessage(e);default:return this.handleExclusiveMessage(e)}}scheduleTask(e,t){return new Promise(n=>{let r=new AudioBufferSourceNode(this.audioContext);r.onended=()=>{e(),n()},r.start(t),r.stop(t)})}}export{L as MidyGM2};