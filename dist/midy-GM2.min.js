var Re=Object.create;var me=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var Le=Object.getOwnPropertyNames;var Ue=Object.getPrototypeOf,je=Object.prototype.hasOwnProperty;var se=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var Ge=(i,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Le(e))!je.call(i,n)&&n!==t&&me(i,n,{get:()=>e[n],enumerable:!(s=Ae(e,n))||s.enumerable});return i};var He=(i,e,t)=>(t=i!=null?Re(Ue(i)):{},Ge(e||!i||!i.__esModule?me(t,"default",{value:i,enumerable:!0}):t,i));var ye=se((Tt,be)=>{function qe(i){var e=new P(i),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var s=Ke(t.data),n=[],o=0;!e.eof()&&o<s.numTracks;o++){var r=e.readChunk();if(r.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+r.id+"'";var a=We(r.data);n.push(a)}return{header:s,tracks:n}}function Ke(i){var e=new P(i),t=e.readUInt16(),s=e.readUInt16(),n={format:t,numTracks:s},o=e.readUInt16();return o&32768?(n.framesPerSecond=256-(o>>8),n.ticksPerFrame=o&255):n.ticksPerBeat=o,n}function We(i){for(var e=new P(i),t=[];!e.eof();){var s=o();t.push(s)}return t;var n;function o(){var r={};r.deltaTime=e.readVarInt();var a=e.readUInt8();if((a&240)===240)if(a===255){r.meta=!0;var c=e.readUInt8(),l=e.readVarInt();switch(c){case 0:if(r.type="sequenceNumber",l!==2)throw"Expected length for sequenceNumber event is 2, got "+l;return r.number=e.readUInt16(),r;case 1:return r.type="text",r.text=e.readString(l),r;case 2:return r.type="copyrightNotice",r.text=e.readString(l),r;case 3:return r.type="trackName",r.text=e.readString(l),r;case 4:return r.type="instrumentName",r.text=e.readString(l),r;case 5:return r.type="lyrics",r.text=e.readString(l),r;case 6:return r.type="marker",r.text=e.readString(l),r;case 7:return r.type="cuePoint",r.text=e.readString(l),r;case 32:if(r.type="channelPrefix",l!=1)throw"Expected length for channelPrefix event is 1, got "+l;return r.channel=e.readUInt8(),r;case 33:if(r.type="portPrefix",l!=1)throw"Expected length for portPrefix event is 1, got "+l;return r.port=e.readUInt8(),r;case 47:if(r.type="endOfTrack",l!=0)throw"Expected length for endOfTrack event is 0, got "+l;return r;case 81:if(r.type="setTempo",l!=3)throw"Expected length for setTempo event is 3, got "+l;return r.microsecondsPerBeat=e.readUInt24(),r;case 84:if(r.type="smpteOffset",l!=5)throw"Expected length for smpteOffset event is 5, got "+l;var u=e.readUInt8(),h={0:24,32:25,64:29,96:30};return r.frameRate=h[u&96],r.hour=u&31,r.min=e.readUInt8(),r.sec=e.readUInt8(),r.frame=e.readUInt8(),r.subFrame=e.readUInt8(),r;case 88:if(r.type="timeSignature",l!=2&&l!=4)throw"Expected length for timeSignature event is 4 or 2, got "+l;return r.numerator=e.readUInt8(),r.denominator=1<<e.readUInt8(),l===4?(r.metronome=e.readUInt8(),r.thirtyseconds=e.readUInt8()):(r.metronome=36,r.thirtyseconds=8),r;case 89:if(r.type="keySignature",l!=2)throw"Expected length for keySignature event is 2, got "+l;return r.key=e.readInt8(),r.scale=e.readUInt8(),r;case 127:return r.type="sequencerSpecific",r.data=e.readBytes(l),r;default:return r.type="unknownMeta",r.data=e.readBytes(l),r.metatypeByte=c,r}}else if(a==240){r.type="sysEx";var l=e.readVarInt();return r.data=e.readBytes(l),r}else if(a==247){r.type="endSysEx";var l=e.readVarInt();return r.data=e.readBytes(l),r}else throw"Unrecognised MIDI event type byte: "+a;else{var d;if((a&128)===0){if(n===null)throw"Running status byte encountered before status byte";d=a,a=n,r.running=!0}else d=e.readUInt8(),n=a;var f=a>>4;switch(r.channel=a&15,f){case 8:return r.type="noteOff",r.noteNumber=d,r.velocity=e.readUInt8(),r;case 9:var m=e.readUInt8();return r.type=m===0?"noteOff":"noteOn",r.noteNumber=d,r.velocity=m,m===0&&(r.byte9=!0),r;case 10:return r.type="noteAftertouch",r.noteNumber=d,r.amount=e.readUInt8(),r;case 11:return r.type="controller",r.controllerType=d,r.value=e.readUInt8(),r;case 12:return r.type="programChange",r.programNumber=d,r;case 13:return r.type="channelAftertouch",r.amount=d,r;case 14:return r.type="pitchBend",r.value=d+(e.readUInt8()<<7)-8192,r;default:throw"Unrecognised MIDI event type: "+f}}}}function P(i){this.buffer=i,this.bufferLen=this.buffer.length,this.pos=0}P.prototype.eof=function(){return this.pos>=this.bufferLen};P.prototype.readUInt8=function(){var i=this.buffer[this.pos];return this.pos+=1,i};P.prototype.readInt8=function(){var i=this.readUInt8();return i&128?i-256:i};P.prototype.readUInt16=function(){var i=this.readUInt8(),e=this.readUInt8();return(i<<8)+e};P.prototype.readInt16=function(){var i=this.readUInt16();return i&32768?i-65536:i};P.prototype.readUInt24=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(i<<16)+(e<<8)+t};P.prototype.readInt24=function(){var i=this.readUInt24();return i&8388608?i-16777216:i};P.prototype.readUInt32=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),s=this.readUInt8();return(i<<24)+(e<<16)+(t<<8)+s};P.prototype.readBytes=function(i){var e=this.buffer.slice(this.pos,this.pos+i);return this.pos+=i,e};P.prototype.readString=function(i){var e=this.readBytes(i);return String.fromCharCode.apply(null,e)};P.prototype.readVarInt=function(){for(var i=0;!this.eof();){var e=this.readUInt8();if(e&128)i+=e&127,i<<=7;else return i+e}return i};P.prototype.readChunk=function(){var i=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:i,length:e,data:t}};be.exports=qe});var ve=se((kt,ge)=>{function $e(i,e){if(typeof i!="object")throw"Invalid MIDI data";e=e||{};var t=i.header||{},s=i.tracks||[],n,o=s.length,r=new y;for(ze(r,t,o),n=0;n<o;n++)Ze(r,s[n],e);return r.buffer}function ze(i,e,t){var s=e.format==null?1:e.format,n=128;e.timeDivision?n=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?n=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(n=e.ticksPerBeat&32767);var o=new y;o.writeUInt16(s),o.writeUInt16(t),o.writeUInt16(n),i.writeChunk("MThd",o.buffer)}function Ze(i,e,t){var s=new y,n,o=e.length,r=null;for(n=0;n<o;n++)(t.running===!1||!t.running&&!e[n].running)&&(r=null),r=Qe(s,e[n],r,t.useByte9ForNoteOff);i.writeChunk("MTrk",s.buffer)}function Qe(i,e,t,s){var n=e.type,o=e.deltaTime,r=e.text||"",a=e.data||[],c=null;switch(i.writeVarInt(o),n){case"sequenceNumber":i.writeUInt8(255),i.writeUInt8(0),i.writeVarInt(2),i.writeUInt16(e.number);break;case"text":i.writeUInt8(255),i.writeUInt8(1),i.writeVarInt(r.length),i.writeString(r);break;case"copyrightNotice":i.writeUInt8(255),i.writeUInt8(2),i.writeVarInt(r.length),i.writeString(r);break;case"trackName":i.writeUInt8(255),i.writeUInt8(3),i.writeVarInt(r.length),i.writeString(r);break;case"instrumentName":i.writeUInt8(255),i.writeUInt8(4),i.writeVarInt(r.length),i.writeString(r);break;case"lyrics":i.writeUInt8(255),i.writeUInt8(5),i.writeVarInt(r.length),i.writeString(r);break;case"marker":i.writeUInt8(255),i.writeUInt8(6),i.writeVarInt(r.length),i.writeString(r);break;case"cuePoint":i.writeUInt8(255),i.writeUInt8(7),i.writeVarInt(r.length),i.writeString(r);break;case"channelPrefix":i.writeUInt8(255),i.writeUInt8(32),i.writeVarInt(1),i.writeUInt8(e.channel);break;case"portPrefix":i.writeUInt8(255),i.writeUInt8(33),i.writeVarInt(1),i.writeUInt8(e.port);break;case"endOfTrack":i.writeUInt8(255),i.writeUInt8(47),i.writeVarInt(0);break;case"setTempo":i.writeUInt8(255),i.writeUInt8(81),i.writeVarInt(3),i.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":i.writeUInt8(255),i.writeUInt8(84),i.writeVarInt(5);var l={24:0,25:32,29:64,30:96},u=e.hour&31|l[e.frameRate];i.writeUInt8(u),i.writeUInt8(e.min),i.writeUInt8(e.sec),i.writeUInt8(e.frame),i.writeUInt8(e.subFrame);break;case"timeSignature":i.writeUInt8(255),i.writeUInt8(88),i.writeVarInt(4),i.writeUInt8(e.numerator);var h=Math.floor(Math.log(e.denominator)/Math.LN2)&255;i.writeUInt8(h),i.writeUInt8(e.metronome),i.writeUInt8(e.thirtyseconds||8);break;case"keySignature":i.writeUInt8(255),i.writeUInt8(89),i.writeVarInt(2),i.writeInt8(e.key),i.writeUInt8(e.scale);break;case"sequencerSpecific":i.writeUInt8(255),i.writeUInt8(127),i.writeVarInt(a.length),i.writeBytes(a);break;case"unknownMeta":e.metatypeByte!=null&&(i.writeUInt8(255),i.writeUInt8(e.metatypeByte),i.writeVarInt(a.length),i.writeBytes(a));break;case"sysEx":i.writeUInt8(240),i.writeVarInt(a.length),i.writeBytes(a);break;case"endSysEx":i.writeUInt8(247),i.writeVarInt(a.length),i.writeBytes(a);break;case"noteOff":var d=s!==!1&&e.byte9||s&&e.velocity==0?144:128;c=d|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.velocity);break;case"noteOn":c=144|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.velocity);break;case"noteAftertouch":c=160|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.amount);break;case"controller":c=176|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.controllerType),i.writeUInt8(e.value);break;case"programChange":c=192|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.programNumber);break;case"channelAftertouch":c=208|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.amount);break;case"pitchBend":c=224|e.channel,c!==t&&i.writeUInt8(c);var f=8192+e.value,m=f&127,E=f>>7&127;i.writeUInt8(m),i.writeUInt8(E);break;default:throw"Unrecognized event type: "+n}return c}function y(){this.buffer=[]}y.prototype.writeUInt8=function(i){this.buffer.push(i&255)};y.prototype.writeInt8=y.prototype.writeUInt8;y.prototype.writeUInt16=function(i){var e=i>>8&255,t=i&255;this.writeUInt8(e),this.writeUInt8(t)};y.prototype.writeInt16=y.prototype.writeUInt16;y.prototype.writeUInt24=function(i){var e=i>>16&255,t=i>>8&255,s=i&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(s)};y.prototype.writeInt24=y.prototype.writeUInt24;y.prototype.writeUInt32=function(i){var e=i>>24&255,t=i>>16&255,s=i>>8&255,n=i&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(s),this.writeUInt8(n)};y.prototype.writeInt32=y.prototype.writeUInt32;y.prototype.writeBytes=function(i){this.buffer=this.buffer.concat(Array.prototype.slice.call(i,0))};y.prototype.writeString=function(i){var e,t=i.length,s=[];for(e=0;e<t;e++)s.push(i.codePointAt(e));this.writeBytes(s)};y.prototype.writeVarInt=function(i){if(i<0)throw"Cannot write negative variable-length integer";if(i<=127)this.writeUInt8(i);else{var e=i,t=[];for(t.push(e&127),e>>=7;e;){var s=e&127|128;t.push(s),e>>=7}this.writeBytes(t.reverse())}};y.prototype.writeChunk=function(i,e){this.writeString(i),this.writeUInt32(e.length),this.writeBytes(e)};ge.exports=$e});var Se=se(ne=>{ne.parseMidi=ye();ne.writeMidi=ve()});var Ne=He(Se());var F=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,s=t+e,n=this.data,o=n.subarray(t,s).indexOf(0);o<0&&(o=e);let r=new Array(o);for(let a=0;a<o;a++)r[a]=n[t+a];return this.offset=s,String.fromCharCode(...r)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function oe(i,e,t){let s=new F(i,e),n=s.readString(4),o=s.readDWORD(t);return new re(n,o,s.offset)}function ae(i,e=0,t,{padding:s=!0,bigEndian:n=!1}={}){let o=[],r=t+e,a=e;for(;a<r;){let c=oe(i,a,n);a=c.offset+c.size,s&&(a-e&1)===1&&a++,o.push(c)}return o}var re=class{constructor(e,t,s){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:s})}};var k=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var b=class i{constructor(e,t,s,n,o){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:o})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,s=e&127,n=e>>7&1,o=e>>8&1,r=e>>9&1;return new i(t,r,o,n,s)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var ie=class i{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),s=e.readInt8();return new i(t,s)}},G=class i{constructor(e,t,s,n,o,r,a,c,l,u,h){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:h})}static parse(e,t){function s(x){for(let g=0;g<t.length;g++)if(t[g].type===x)return t[g]}function n(x){return new F(e,x.offset)}function o(x){let g=s(x);return g?n(g).readString(g.size):null}function r(x){let g=s(x);return g?ie.parse(n(g)):null}let a=o("ICMT"),c=o("ICOP"),l=o("ICRD"),u=o("IENG"),h=o("INAM"),d=o("IPRD"),f=o("ISFT"),m=r("ifil"),E=o("isng"),B=o("irom"),O=r("iver");return new i(a,c,l,u,h,d,f,m,E,B,O)}},N=class i{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),s=e.readWORD();return new i(t,s)}},H=class i{constructor(e,t,s,n,o,r,a){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:a})}get isEnd(){let{presetName:e,preset:t,bank:s,library:n,genre:o,morphology:r}=this;return e==="EOP"||e===""&&t+s+n+o+r===0}static parse(e){let t=e.readString(20),s=e.readWORD(),n=e.readWORD(),o=e.readWORD(),r=e.readDWORD(),a=e.readDWORD(),c=e.readDWORD();return new i(t,s,n,o,r,a,c)}},D=class i{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),s=e.readByte();return new i(t,s)}},v=class i{constructor(e,t,s,n,o){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"amount",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:o})}transform(e){let t=this.amount*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),s=e.readWORD(),n=e.readInt16(),o=e.readWORD(),r=e.readWORD(),a=b.parse(t),c=b.parse(o);return new i(a,s,n,c,r)}},R=class i{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return k[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),s=k[t],n;switch(s){case"keyRange":case"velRange":n=D.parse(e);break;case"instrument":case"sampleID":n=e.readUInt16();break;default:n=e.readInt16();break}return new i(t,n)}},q=class i{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new i;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},K=class i{constructor(e,t,s,n,o,r,a,c,l,u){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:u})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let s=e.readString(20),n=e.readDWORD(),o=e.readDWORD(),r=e.readDWORD(),a=e.readDWORD(),c=e.readDWORD(),l=e.readByte(),u=e.readInt8(),h=e.readWORD(),d=e.readWORD();return t||(r-=n,a-=n),new i(s,n,o,r,a,c,l,u,h,d)}};var p=class{constructor(e,t,s){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=s}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};var _e=["pcm16","pcm24","compressed"],Je=new Set(_e),W=class{constructor(e,t,s){if(Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Je.has(e))throw new Error(`Invalid AudioDataType: ${e}`);this.type=e,this.sampleHeader=t,this.data=s}decodePCM(e){let{type:t}=this;if(t==="pcm16"){let n=e.byteLength/2,o=new Float32Array(n),r=new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);for(let a=0;a<n;a++)o[a]=r[a]/32768;return o}else{let n=e.byteLength/3,o=new Float32Array(n);for(let r=0;r<n;r++){let a=r*3,c=e[a]|e[a+1]<<8|e[a+2]<<16;c&8388608&&(c|=4278190080),o[r]=c/8388608}return o}}async toAudioBuffer(e,t,s){if(this.type==="compressed"){let n=this.data.slice().buffer;return await e.decodeAudioData(n)}else{let n=this.data.subarray(t,s),o=this.decodePCM(n),r=new AudioBuffer({numberOfChannels:1,length:o.length,sampleRate:this.sampleHeader.sampleRate});return r.getChannelData(0).set(o),r}}};function ce(i,e={}){let t=ae(i,0,i.length,e);if(t.length!==1)throw new Error("wrong chunk length");let s=t[0];if(s===null)throw new Error("chunk not found");function n(c,l,u={}){let h=$(c,l,"RIFF","sfbk",u);if(h.length!==3)throw new Error("invalid sfbk structure");let d=Xe(h[0],l),f=d.version.major===3;return f&&h[2].type!=="LIST"&&(h[2]=oe(l,h[2].offset-9,!1)),{info:d,samplingData:Ye(h[1],l),...o(h[2],l,f)}}function o(c,l,u){let h=$(c,l,"LIST","pdta");if(h.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:et(h[0],l),presetZone:tt(h[1],l),presetModulators:rt(h[2],l),presetGenerators:at(h[3],l),instruments:st(h[4],l),instrumentZone:nt(h[5],l),instrumentModulators:ot(h[6],l),instrumentGenerators:it(h[7],l),sampleHeaders:ct(h[8],l,u)}}let r=n(s,i,e),a=r.info.version.major===3;return{...r,samples:lt(r.sampleHeaders,r.samplingData.offsetMSB,r.samplingData.offsetLSB,i,a)}}function $(i,e,t,s,n={}){if(i.type!==t)throw new Error("invalid chunk type:"+i.type);let o=new F(e,i.offset),r=o.readString(4);if(r!==s)throw new Error("invalid signature:"+r);return ae(e,o.offset,i.size-4,n)}function Xe(i,e){let t=$(i,e,"LIST","INFO");return G.parse(e,t)}function Ye(i,e){let t=$(i,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function M(i,e,t,s,n,o){let r=[];if(i.type!==t)throw new Error("invalid chunk type:"+i.type);let a=new F(e,i.offset),c=i.offset+i.size;for(;a.offset<c;){let l=s.parse(a,o);if(n&&n(l))break;r.push(l)}return r}var et=(i,e)=>M(i,e,"phdr",H,t=>t.isEnd),tt=(i,e)=>M(i,e,"pbag",N),st=(i,e)=>M(i,e,"inst",q,t=>t.isEnd),nt=(i,e)=>M(i,e,"ibag",N),rt=(i,e)=>M(i,e,"pmod",v),ot=(i,e)=>M(i,e,"imod",v),at=(i,e)=>M(i,e,"pgen",R,t=>t.isEnd),it=(i,e)=>M(i,e,"igen",R),ct=(i,e,t)=>M(i,e,"shdr",K,s=>s.isEnd,t);function lt(i,e,t,s,n){let o=new Array(i.length),r=n?1:2,a=n?"compressed":t?"pcm24":"pcm16";for(let c=0;c<i.length;c++){let{start:l,end:u}=i[c],h=e+l*r,d=e+u*r,f=s.subarray(h,d);o[c]=new W(a,i[c],f)}return o}var Te=new Map;for(let i=0;i<k.length;i++)Te.set(k[i],i);var ut=["instrument","sampleID"],ke=["keyRange","velRange"],Fe=["keynum","velocity"],Me=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],we=[...Me,...Fe],Ee=new Set;for(let i=0;i<we.length;i++){let e=we[i],t=Te.get(e);t!==void 0&&Ee.add(t)}function De(i){let e={},t=Object.keys(i);for(let s of t){let n=i[s];if(A(s))e[s]=n;else{let o=n;e[s]=o.clamp(o.defaultValue)}}return e}var Pe=[["keynum","keyRange"],["velocity","velRange"]],ht=new Set(ke);function A(i){return ht.has(i)}var dt=new Set([...ut,...ke,...Fe,...Me]);function ft(){let i=[],e=k.length;for(let t=0;t<e;t++){let s=k[t];s!==void 0&&!dt.has(s)&&i.push(s)}return i}var Z=ft(),pt=new Set(Z);function le(i){return pt.has(i)}function Oe(i){let e={};for(let t=0;t<i.length;t++){let s=i[t],n=s.type;if(n!==void 0&&!Ee.has(s.code))if(A(n))e[n]=s.value;else{let o=n;e[o]=s.value}}return e}function Ce(i){let e={};for(let t=0;t<i.length;t++){let s=i[t],n=s.type;if(n!==void 0)if(A(n))e[n]=s.value;else{let o=n;e[o]=s.value}}for(let t=0;t<Pe.length;t++){let[s,n]=Pe[t],o=e[s];o!==void 0&&(e[n]=new D(o,o))}return e}var I=-32768,V=32767,xe=0,z=65535,Q={startAddrsOffset:new p(0,0,V),endAddrsOffset:new p(I,0,0),startloopAddrsOffset:new p(I,0,V),endloopAddrsOffset:new p(I,0,V),startAddrsCoarseOffset:new p(0,0,V),modLfoToPitch:new p(-12e3,0,12e3),vibLfoToPitch:new p(-12e3,0,12e3),modEnvToPitch:new p(-12e3,0,12e3),initialFilterFc:new p(1500,13500,13500),initialFilterQ:new p(0,0,960),modLfoToFilterFc:new p(-12e3,0,12e3),modEnvToFilterFc:new p(-12e3,0,12e3),endAddrsCoarseOffset:new p(I,0,0),modLfoToVolume:new p(-960,0,960),chorusEffectsSend:new p(0,0,1e3),reverbEffectsSend:new p(0,0,1e3),pan:new p(-500,0,500),delayModLFO:new p(-12e3,-12e3,5e3),freqModLFO:new p(-16e3,0,4500),delayVibLFO:new p(-12e3,-12e3,5e3),freqVibLFO:new p(-16e3,0,4500),delayModEnv:new p(-12e3,-12e3,5e3),attackModEnv:new p(-12e3,-12e3,8e3),holdModEnv:new p(-12e3,-12e3,5e3),decayModEnv:new p(-12e3,-12e3,8e3),sustainModEnv:new p(0,0,1e3),releaseModEnv:new p(-12e3,-12e3,8e3),keynumToModEnvHold:new p(-1200,0,1200),keynumToModEnvDecay:new p(-1200,0,1200),delayVolEnv:new p(-12e3,-12e3,5e3),attackVolEnv:new p(-12e3,-12e3,8e3),holdVolEnv:new p(-12e3,-12e3,5e3),decayVolEnv:new p(-12e3,-12e3,8e3),sustainVolEnv:new p(0,0,1440),releaseVolEnv:new p(-12e3,-12e3,8e3),keynumToVolEnvHold:new p(-1200,0,1200),keynumToVolEnvDecay:new p(-1200,0,1200),instrument:new p(xe,z,z),keyRange:new D(0,127),velRange:new D(0,127),startloopAddrsCoarseOffset:new p(I,0,V),keynum:new p(-1,-1,127),velocity:new p(-1,-1,127),initialAttenuation:new p(0,0,1440),endloopAddrsCoarseOffset:new p(I,0,V),coarseTune:new p(-120,0,120),fineTune:new p(-99,0,99),sampleID:new p(xe,z,z),sampleModes:new p(0,0,3),scaleTuning:new p(0,100,100),exclusiveClass:new p(0,0,127),overridingRootKey:new p(-1,-1,127)};function T(i){return Math.pow(2,i/1200)}var _=class{constructor(e,t,s,n,o){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(r,a)=>{r.modLfoToPitch=this.clamp("modLfoToPitch",a)},vibLfoToPitch:(r,a)=>{r.vibLfoToPitch=this.clamp("vibLfoToPitch",a)},modEnvToPitch:(r,a)=>{r.modEnvToPitch=this.clamp("modEnvToPitch",a)},initialFilterFc:(r,a)=>{r.initialFilterFc=this.clamp("initialFilterFc",a)},initialFilterQ:(r,a)=>{r.initialFilterQ=this.clamp("initialFilterQ",a)},modLfoToFilterFc:(r,a)=>{r.modLfoToFilterFc=this.clamp("modLfoToFilterFc",a)},modEnvToFilterFc:(r,a)=>{r.modEnvToFilterFc=this.clamp("modEnvToFilterFc",a)},modLfoToVolume:(r,a)=>{r.modLfoToVolume=this.clamp("modLfoToVolume",a)},chorusEffectsSend:(r,a)=>{r.chorusEffectsSend=this.clamp("chorusEffectsSend",a)/1e3},reverbEffectsSend:(r,a)=>{r.reverbEffectsSend=this.clamp("reverbEffectsSend",a)/1e3},pan:(r,a)=>{r.pan=this.clamp("pan",a)/1e3},delayModLFO:(r,a)=>{r.delayModLFO=T(this.clamp("delayModLFO",a))},freqModLFO:(r,a)=>{r.freqModLFO=this.clamp("freqModLFO",a)},delayVibLFO:(r,a)=>{r.delayVibLFO=T(this.clamp("delayVibLFO",a))},freqVibLFO:(r,a)=>{r.freqVibLFO=this.clamp("freqVibLFO",a)},delayModEnv:(r,a)=>{r.modDelay=T(this.clamp("delayModEnv",a))},attackModEnv:(r,a)=>{r.modAttack=T(this.clamp("attackModEnv",a))},holdModEnv:(r,a)=>{let c=this.clamp("holdModEnv",a),l=this.clamp("keynumToModEnvHold",a);r.modHold=this.getModHold(c,l)},decayModEnv:(r,a)=>{let c=this.clamp("decayModEnv",a),l=this.clamp("keynumToModEnvDecay",a);r.modDecay=this.getModDecay(c,l)},sustainModEnv:(r,a)=>{r.modSustain=this.clamp("sustainModEnv",a)/1e3},releaseModEnv:(r,a)=>{r.modRelease=T(this.clamp("releaseModEnv",a))},keynumToModEnvHold:(r,a)=>{let c=this.clamp("holdModEnv",a),l=this.clamp("keynumToModEnvHold",a);r.modHold=this.getModHold(c,l)},keynumToModEnvDecay:(r,a)=>{let c=this.clamp("decayModEnv",a),l=this.clamp("keynumToModEnvDecay",a);r.modDecay=this.getModDecay(c,l)},delayVolEnv:(r,a)=>{r.volDelay=T(this.clamp("delayVolEnv",a))},attackVolEnv:(r,a)=>{r.volAttack=T(this.clamp("attackVolEnv",a))},holdVolEnv:(r,a)=>{let c=this.clamp("holdVolEnv",a),l=this.clamp("keynumToVolEnvHold",a);r.volHold=this.getVolHold(c,l)},decayVolEnv:(r,a)=>{let c=this.clamp("decayVolEnv",a),l=this.clamp("keynumToVolEnvDecay",a);r.volDecay=this.getVolDecay(c,l)},sustainVolEnv:(r,a)=>{r.volSustain=this.clamp("sustainVolEnv",a)/1e3},releaseVolEnv:(r,a)=>{r.volRelease=T(this.clamp("releaseVolEnv",a))},keynumToVolEnvHold:(r,a)=>{let c=this.clamp("holdVolEnv",a),l=this.clamp("keynumToVolEnvHold",a);r.modHold=this.getVolHold(c,l)},keynumToVolEnvDecay:(r,a)=>{let c=this.clamp("decayVolEnv",a),l=this.clamp("keynumToVolEnvDecay",a);r.modDecay=this.getVolDecay(c,l)},initialAttenuation:(r,a)=>{r.initialAttenuation=this.clamp("initialAttenuation",a)},coarseTune:(r,a)=>{r.playbackRate=this.getPlaybackRate(a)},fineTune:(r,a)=>{r.playbackRate=this.getPlaybackRate(a)},scaleTuning:(r,a)=>{r.playbackRate=this.getPlaybackRate(a)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],s=t.sourceOper.controllerType,n=t.destinationOper,o=this.controllerToDestinations.get(s);o?o.add(t.destinationOper):this.controllerToDestinations.set(s,new Set([n]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],s=t.destinationOper,n=this.destinationToModulators.get(s);n?n.push(t):this.destinationToModulators.set(s,[t])}}getModHold(e,t){return T(e+(this.key-60)*t)}getModDecay(e,t){return T(e+(this.key-60)*t)}getVolHold(e,t){return T(e+(this.key-60)*t)}getVolDecay(e,t){return T(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("coarseTune",e),s=this.clamp("fineTune",e)/100,n=this.clamp("overridingRootKey",e),o=this.clamp("scaleTuning",e)/100,r=t+s,a=n===-1?this.sampleHeader.originalPitch:n,c=r+this.sampleHeader.pitchCorrection/100-a;return Math.pow(Math.pow(2,1/12),(this.key+c)*o)}transformParams(e,t){let s={},n=this.controllerToDestinations.get(e);if(!n)return s;for(let o of n){let r=k[o];if(!r||!le(r))continue;let a=this.destinationToModulators.get(o);if(a){s[r]=this.generators[r];for(let c of a){let l=c.sourceOper,u=l.map(t[l.controllerType]),h=1,d=c.amountSourceOper;if(!(d.cc===0&&d.index===0)){let m=t[d.controllerType];h=d.map(m)}let f=c.transform(u*h);Number.isNaN(f)||(s[r]+=f)}}}return s}transformAllParams(e){let t=structuredClone(this.generators);for(let s of this.modulators){let n=s.sourceOper.controllerType,o=e[n];if(!o)continue;let r=k[s.destinationOper];if(!r||!le(r))continue;let c=s.sourceOper.map(o),l=1,u=s.amountSourceOper;if(!(u.cc===0&&u.index===0)){let d=e[u.controllerType];l=u.map(d)}let h=s.transform(c*l);Number.isNaN(h)||(t[r]+=h)}return t}clamp(e,t){return Q[e].clamp(t[e])}getParams(e,t){let s={},n=structuredClone(this.generators),o=this.transformParams(e,t),r=Object.keys(o);for(let a of r)n[a]=o[a];for(let a of r)this.voiceHandlers[a](s,n);return s}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,instrument:this.generators.instrument,sampleID:this.generators.sampleID,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},s=this.transformAllParams(e);for(let n=0;n<Z.length;n++){let o=Z[n];this.voiceHandlers[o](t,s)}return t}};var Ie=[new v(b.parse(1282),48,960,b.parse(0),0),new v(b.parse(258),8,-2400,b.parse(0),0),new v(b.parse(13),6,50,b.parse(0),0),new v(b.parse(129),6,50,b.parse(0),0),new v(b.parse(1415),48,960,b.parse(0),0),new v(b.parse(650),48,1,b.parse(0),0),new v(b.parse(1419),48,960,b.parse(0),0),new v(b.parse(219),16,.2,b.parse(0),0),new v(b.parse(221),15,.2,b.parse(0),0),new v(b.parse(526),51,127,b.parse(16),0)];var J=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},X=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},L=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,s,n){let o=new Array(n-s);for(let r=s;r<n;r++){let a=t[r].generatorIndex,c=t[r+1].generatorIndex;o[r-s]=e.slice(a,c)}return o}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],s=this.parsed.presetHeaders[e+1],n=s?s.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,n)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],s=this.parsed.instruments[e+1],n=s?s.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,n)}getModulators(e,t,s,n){let o=new Array(n-s);for(let r=s;r<n;r++){let a=t[r].modulatorIndex,c=t[r+1].modulatorIndex;o[r-s]=e.slice(a,c)}return o}getPresetModulators(e){let t=this.parsed.presetHeaders[e],s=this.parsed.presetHeaders[e+1],n=s?s.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,n)}getInstrumentModulators(e){let t=this.parsed.instruments[e],s=this.parsed.instruments[e+1],n=s?s.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,n)}findInstrumentZone(e,t,s){let n=this.getInstrumentGenerators(e),o=this.getInstrumentModulators(e),r,a=[];for(let c=0;c<n.length;c++){let l=Ce(n[c]);if(l.sampleID===void 0){r=l,a=o[c];continue}if(!(l.keyRange&&!l.keyRange.in(t))&&!(l.velRange&&!l.velRange.in(s)))if(r){let u={...r,...l},h=[...a,...o[c]];return new J(u,h)}else return new J(l,o[c])}}findInstrument(e,t,s){let n=this.getPresetGenerators(e),o=this.getPresetModulators(e),r,a=[];for(let c=0;c<n.length;c++){let l=Oe(n[c]);if(l.instrument===void 0){r=l,a=o[c];continue}if(l.keyRange&&!l.keyRange.in(t)||l.velRange&&!l.velRange.in(s))continue;let u=this.findInstrumentZone(l.instrument,t,s);if(u)if(r){let h={...r,...l},d=[...a,...o[c]],f=new X(h,d);return this.createVoice(t,f,u)}else{let h=new X(l,o[c]);return this.createVoice(t,h,u)}}return null}createVoice(e,t,s){let n=De(Q);Object.assign(n,s.generators);let o=Object.keys(t.generators);for(let u=0;u<o.length;u++){let h=o[u];A(h)||(n[h]+=t.generators[h])}let r=[...Ie,...t.modulators,...s.modulators],a=n.sampleID,c=this.parsed.samples[a],l=this.parsed.sampleHeaders[a];return new _(e,n,r,c,l)}getVoice(e,t,s,n){let o=this.parsed.presetHeaders.findIndex(a=>a.preset===t&&a.bank===e);if(o<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let r=this.findInstrument(o,s,n);return r||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let s=0;s<t.length;s++){let n=t[s];e[n.bank]||(e[n.bank]={}),e[n.bank][n.preset]=n.presetName}return e}};var he=class{voice;voiceParams;adjustedBaseFreq=2e4;index=-1;ending=!1;bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;modulationLFO;modulationDepth;vibratoLFO;vibratoDepth;reverbSend;chorusSend;portamentoNoteNumber=-1;constructor(e,t,s){this.noteNumber=e,this.velocity=t,this.startTime=s,this.ready=new Promise(n=>{this.resolveReady=n})}},j=new Array(57),mt=10,S=new Uint8Array(128);S[42]=1;S[44]=1;S[46]=1;S[71]=2;S[72]=2;S[73]=3;S[74]=3;S[78]=4;S[79]=4;S[80]=5;S[81]=5;S[29]=6;S[30]=6;S[86]=7;S[87]=7;j[0]=S;var ee=new Uint8Array(128);ee[42]=8;ee[44]=8;ee[46]=8;j[25]=ee;var te=new Uint8Array(128);te[27]=9;te[28]=9;te[29]=9;j[48]=te;var fe=new Uint8Array(128);fe[41]=10;fe[42]=10;j[56]=fe;var Y={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},channelPressure:{type:13,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepthMSB:{type:129,defaultValue:0},portamentoTimeMSB:{type:133,defaultValue:0},volumeMSB:{type:135,defaultValue:100/127},panMSB:{type:138,defaultValue:64/127},expressionMSB:{type:139,defaultValue:1},sustainPedal:{type:192,defaultValue:0},portamento:{type:193,defaultValue:0},sostenutoPedal:{type:194,defaultValue:0},softPedal:{type:195,defaultValue:0},reverbSendLevel:{type:219,defaultValue:0},chorusSendLevel:{type:221,defaultValue:0}},de=class{array=new Float32Array(256);constructor(){let e=Object.entries(Y);for(let[t,{type:s,defaultValue:n}]of e)this.array[s]=n,Object.defineProperty(this,t,{get:()=>this.array[s],set:o=>this.array[s]=o,enumerable:!0,configurable:!0})}},bt=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],yt=new Set(bt),gt=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain"],vt=new Set(gt),St=["modEnvToPitch","modDelay","modAttack","modHold","modDecay","modSustain","playbackRate"],wt=new Set(St),Ve=new Int8Array([64,64,64,0,0,0]);function U(i){return Math.pow(10,i/200)}var ue=1/-Math.log(U(-1e3)),Pt=1/-Math.log(U(-600)),Be=class extends EventTarget{mode="GM2";masterFineTuning=0;masterCoarseTuning=0;reverb={algorithm:"SchroederReverb",time:this.getReverbTime(64),feedback:.8};chorus={modRate:this.getChorusModRate(3),modDepth:this.getChorusModDepth(19),feedback:this.getChorusFeedback(8),sendToReverb:this.getChorusSendToReverb(0),delayTimes:this.generateDistributedArray(.02,2,.5)};numChannels=16;ticksPerBeat=120;totalTime=0;lastActiveSensing=0;activeSensingThreshold=.3;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=Array.from({length:128},()=>[]);voiceCounter=new Map;voiceCache=new Map;realtimeVoiceCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;totalTimeEventTypes=new Set(["noteOff"]);tempo=1;loop=!1;playPromise;timeline=[];notePromises=[];instruments=new Set;exclusiveClassNotes=new Array(128);drumExclusiveClassNotes=new Array(this.numChannels*mt);static channelSettings={scheduleIndex:0,detune:0,programNumber:0,bankMSB:121,bankLSB:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,mono:!1,modulationDepthRange:50,fineTuning:0,coarseTuning:0};constructor(e){super(),this.audioContext=e,this.masterVolume=new GainNode(e),this.scheduler=new GainNode(e,{gain:0}),this.schedulerBuffer=new AudioBuffer({length:1,sampleRate:e.sampleRate}),this.messageHandlers=this.createMessageHandlers(),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.keyBasedControllerHandlers=this.createKeyBasedControllerHandlers(),this.channels=this.createChannels(e),this.reverbEffect=this.createReverbEffect(e),this.chorusEffect=this.createChorusEffect(e),this.chorusEffect.output.connect(this.masterVolume),this.reverbEffect.output.connect(this.masterVolume),this.masterVolume.connect(e.destination),this.scheduler.connect(e.destination),this.GM2SystemOn()}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let s=e.parsed.presetHeaders,n=this.soundFontTable;for(let o=0;o<s.length;o++){let{preset:r,bank:a}=s[o];n[r][a]=t}}async toUint8Array(e){let t;if(typeof e=="string"){let n=await(await fetch(e)).arrayBuffer();t=new Uint8Array(n)}else if(e instanceof Uint8Array)t=e;else throw new TypeError("input must be a URL string or Uint8Array");return t}async loadSoundFont(e){if(this.voiceCounter.clear(),Array.isArray(e)){let t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=this.toUint8Array(e[n]);let s=await Promise.all(t);for(let n=0;n<s.length;n++){let o=ce(s[n]),r=new L(o);this.addSoundFont(r)}}else{let t=await this.toUint8Array(e),s=ce(t),n=new L(s);this.addSoundFont(n)}}async loadMIDI(e){this.voiceCounter.clear();let t=await this.toUint8Array(e),s=(0,Ne.parseMidi)(t);this.ticksPerBeat=s.header.ticksPerBeat;let n=this.extractMidiData(s);this.instruments=n.instruments,this.timeline=n.timeline,this.totalTime=this.calcTotalTime()}cacheVoiceIds(){let{channels:e,timeline:t,voiceCounter:s}=this;for(let n=0;n<t.length;n++){let o=t[n];switch(o.type){case"noteOn":{let r=this.getVoiceId(e[o.channel],o.noteNumber,o.velocity);s.set(r,(s.get(r)??0)+1);break}case"controller":o.controllerType===0?this.setBankMSB(o.channel,o.value):o.controllerType===32&&this.setBankLSB(o.channel,o.value);break;case"programChange":this.setProgramChange(o.channel,o.programNumber,o.startTime)}}for(let[n,o]of s)o===1&&s.delete(n);this.GM2SystemOn()}getVoiceId(e,t,s){let n=e.programNumber,o=this.soundFontTable[n];if(!o)return;let r=e.isDrum?128:e.bankLSB;if(o[r]===void 0){if(e.isDrum)return;r=0}let a=o[r];if(a===void 0)return;let l=this.soundFonts[a].getVoice(r,n,t,s),{instrument:u,sampleID:h}=l.generators;return a*2**32+(u<<16)+h}createChannelAudioNodes(e){let{gainLeft:t,gainRight:s}=this.panToGain(Y.panMSB.defaultValue),n=new GainNode(e,{gain:t}),o=new GainNode(e,{gain:s}),r=new ChannelMergerNode(e,{numberOfInputs:2});return n.connect(r,0,0),o.connect(r,0,1),r.connect(this.masterVolume),{gainL:n,gainR:o,merger:r}}resetChannelTable(e){e.controlTable.fill(-1),e.scaleOctaveTuningTable.fill(0),e.channelPressureTable.set(Ve),e.keyBasedTable.fill(-1)}createChannels(e){return Array.from({length:this.numChannels},()=>({currentBufferSource:null,isDrum:!1,state:new de,...this.constructor.channelSettings,...this.createChannelAudioNodes(e),scheduledNotes:[],sustainNotes:[],sostenutoNotes:[],controlTable:this.initControlTable(),scaleOctaveTuningTable:new Int8Array(12),channelPressureTable:new Int8Array(Ve),keyBasedTable:new Int8Array(16384).fill(-1),keyBasedGainLs:new Array(128),keyBasedGainRs:new Array(128)}))}async createAudioBuffer(e){let{sample:t,start:s,end:n}=e,o=t.data.length+n;return await t.toAudioBuffer(this.audioContext,s,o)}isLoopDrum(e,t){let s=e.programNumber;return s===48&&t===88||s===56&&47<=t&&t<=84}createBufferSource(e,t,s,n){let o=new AudioBufferSourceNode(this.audioContext);return o.buffer=n,o.loop=e.isDrum?this.isLoopDrum(e,t):s.sampleModes%2!==0,o.loop&&(o.loopStart=s.loopStart/s.sampleRate,o.loopEnd=s.loopEnd/s.sampleRate),o}scheduleTimelineEvents(e,t){let s=this.resumeTime-this.startTime,n=e+s+this.lookAhead,o=this.startDelay-s,r=this.timeline,a=1/this.tempo;for(;t<r.length;){let c=r[t],l=c.startTime*a;if(n<l)break;let u=l+o;switch(c.type){case"noteOn":this.noteOn(c.channel,c.noteNumber,c.velocity,u);break;case"noteOff":{this.noteOff(c.channel,c.noteNumber,c.velocity,u,!1);break}case"controller":this.setControlChange(c.channel,c.controllerType,c.value,u);break;case"programChange":this.setProgramChange(c.channel,c.programNumber,u);break;case"channelAftertouch":this.setChannelPressure(c.channel,c.amount,u);break;case"pitchBend":this.setPitchBend(c.channel,c.value+8192,u);break;case"sysEx":this.handleSysEx(c.data,u)}t++}return t}getQueueIndex(e){let t=this.timeline,s=1/this.tempo;for(let n=0;n<t.length;n++)if(e<=t[n].startTime*s)return n;return 0}resetAllStates(){this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.voiceCache.clear(),this.realtimeVoiceCache.clear();let e=this.channels;for(let t=0;t<e.length;t++)e[t].scheduledNotes=[],this.resetChannelStates(t)}updateStates(e,t){let{timeline:s,resumeTime:n}=this,o=1/this.tempo,r=this.audioContext.currentTime;t<e&&(e=0);for(let a=e;a<t;a++){let c=s[a];switch(c.type){case"controller":this.setControlChange(c.channel,c.controllerType,c.value,r-n+c.startTime*o);break;case"programChange":this.setProgramChange(c.channel,c.programNumber,r-n+c.startTime*o);break;case"pitchBend":this.setPitchBend(c.channel,c.value+8192,r-n+c.startTime*o);break;case"sysEx":this.handleSysEx(c.data,r-n+c.startTime*o)}}}async playNotes(){let e=this.audioContext;e.state==="suspended"&&await e.resume();let t=this.isPaused;this.isPlaying=!0,this.isPaused=!1,this.startTime=e.currentTime,t?this.dispatchEvent(new Event("resumed")):this.dispatchEvent(new Event("started"));let s=this.getQueueIndex(this.resumeTime),n;for(this.notePromises=[];;){let o=e.currentTime;if(0<this.lastActiveSensing&&this.activeSensingThreshold<performance.now()-this.lastActiveSensing){await this.stopNotes(0,!0,o),await e.suspend(),n="aborted";break}if(this.totalTime<this.currentTime()||this.timeline.length<=s)if(await this.stopNotes(0,!0,o),this.loop){this.resetAllStates(),this.startTime=e.currentTime,this.resumeTime=0,s=0,this.dispatchEvent(new Event("looped"));continue}else{await e.suspend(),n="ended";break}if(this.isPausing){await this.stopNotes(0,!0,o),await e.suspend(),this.isPausing=!1,n="paused";break}else if(this.isStopping){await this.stopNotes(0,!0,o),await e.suspend(),this.isStopping=!1,n="stopped";break}else if(this.isSeeking){this.stopNotes(0,!0,o),this.startTime=e.currentTime;let a=this.getQueueIndex(this.resumeTime);this.updateStates(s,a),s=a,this.isSeeking=!1,this.dispatchEvent(new Event("seeked"));continue}s=this.scheduleTimelineEvents(o,s);let r=o+this.noteCheckInterval;await this.scheduleTask(()=>{},r)}n!=="paused"&&(this.resetAllStates(),this.lastActiveSensing=0),this.isPlaying=!1,n==="paused"?(this.isPaused=!0,this.dispatchEvent(new Event("paused"))):(this.isPaused=!1,this.dispatchEvent(new Event(n)))}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}getSoundFontId(e){let t=e.programNumber,n=(e.isDrum?128:e.bankLSB).toString().padStart(3,"0"),o=t.toString().padStart(3,"0");return`${n}:${o}`}extractMidiData(e){let t=new Set,s=[],n=this.channels;for(let l=0;l<e.tracks.length;l++){let u=e.tracks[l],h=0;for(let d=0;d<u.length;d++){let f=u[d];switch(h+=f.deltaTime,f.ticks=h,f.type){case"noteOn":{let m=n[f.channel];t.add(this.getSoundFontId(m));break}case"controller":switch(f.controllerType){case 0:this.setBankMSB(f.channel,f.value);break;case 32:this.setBankLSB(f.channel,f.value);break}break;case"programChange":{let m=n[f.channel];this.setProgramChange(f.channel,f.programNumber),t.add(this.getSoundFontId(m));break}case"sysEx":{let m=f.data;if(m[0]===126&&m[1]===9&&m[2]===3)switch(m[3]){case 1:this.GM1SystemOn(scheduleTime);break;case 2:break;case 3:this.GM2SystemOn(scheduleTime);break;default:console.warn(`Unsupported Exclusive Message: ${m}`)}}}delete f.deltaTime,s.push(f)}}let o={controller:0,sysEx:1,noteOff:2,noteOn:3};s.sort((l,u)=>l.ticks!==u.ticks?l.ticks-u.ticks:(o[l.type]||4)-(o[u.type]||4));let r=0,a=0,c=.5;for(let l=0;l<s.length;l++){let u=s[l],h=this.ticksToSecond(u.ticks-a,c);u.startTime=r+h,u.type==="setTempo"&&(r+=this.ticksToSecond(u.ticks-a,c),c=u.microsecondsPerBeat/1e6,a=u.ticks)}return{instruments:t,timeline:s}}stopActiveNotes(e,t,s,n){let o=this.channels[e],r=[];return this.processActiveNotes(o,n,a=>{let c=this.noteOff(e,a.noteNumber,t,n,s);this.notePromises.push(c),r.push(c)}),Promise.all(r)}stopChannelNotes(e,t,s,n){let o=this.channels[e],r=[];return this.processScheduledNotes(o,a=>{let c=this.noteOff(e,a.noteNumber,t,n,s);this.notePromises.push(c),r.push(c)}),Promise.all(r)}stopNotes(e,t,s){let n=this.channels;for(let r=0;r<n.length;r++)this.stopChannelNotes(r,e,t,s);let o=Promise.all(this.notePromises);return this.notePromises=[],o}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,this.voiceCounter.size===0&&this.cacheVoiceIds(),this.playPromise=this.playNotes(),await this.playPromise)}async stop(){this.isPlaying&&(this.isStopping=!0,await this.playPromise)}async pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime=e+this.resumeTime-this.startTime,this.isPausing=!0,await this.playPromise}async resume(){this.isPaused&&(this.playPromise=this.playNotes(),await this.playPromise)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=this.totalTimeEventTypes,t=this.timeline,s=1/this.tempo,n=0;for(let o=0;o<t.length;o++){let r=t[o];if(!e.has(r.type))continue;let a=r.startTime*s;n<a&&(n=a)}return n+this.startDelay}currentTime(){return this.isPlaying?this.audioContext.currentTime+this.resumeTime-this.startTime:this.resumeTime}async processScheduledNotes(e,t){let s=e.scheduledNotes,n=[];for(let o=e.scheduleIndex;o<s.length;o++){let r=s[o];if(!r||r.ending)continue;let a=r.ready.then(()=>t(r));n.push(a)}await Promise.all(n)}async processActiveNotes(e,t,s){let n=e.scheduledNotes,o=[];for(let r=e.scheduleIndex;r<n.length;r++){let a=n[r];if(!a||a.ending)continue;if(t<a.startTime)break;let c=a.ready.then(()=>s(a));o.push(c)}await Promise.all(o)}createConvolutionReverbImpulse(e,t,s){let n=e.sampleRate,o=n*t,r=new AudioBuffer({numberOfChannels:2,length:o,sampleRate:n}),a=Math.min(n*s,o);for(let c=0;c<r.numberOfChannels;c++){let l=r.getChannelData(c);for(let h=0;h<a;h++)l[h]=Math.random()*2-1;let u=1/(n*t);for(let h=a;h<o;h++){let d=Math.exp(-(h-a)*u);l[h]=(Math.random()*2-1)*d}}return r}createConvolutionReverb(e,t){let s=new ConvolverNode(e,{buffer:t});return{input:s,output:s,convolverNode:s}}createCombFilter(e,t,s,n){let o=new DelayNode(e,{maxDelayTime:s,delayTime:s}),r=new GainNode(e,{gain:n});return t.connect(o),o.connect(r),r.connect(o),o}createAllpassFilter(e,t,s,n){let o=new DelayNode(e,{maxDelayTime:s,delayTime:s}),r=new GainNode(e,{gain:n}),a=new GainNode(e,{gain:1-n});return t.connect(o),o.connect(r),r.connect(o),o.connect(a),a}generateDistributedArray(e,t,s=.1,n=.05){let o=e*s,r=new Array(t);for(let a=0;a<t;a++){let c=a/(t-1||1),l=e-o+c*2*o;r[a]=l*(1-(Math.random()*2-1)*n)}return r}createSchroederReverb(e,t,s,n,o){let r=new GainNode(e),a=new GainNode(e);for(let u=0;u<s.length;u++)this.createCombFilter(e,r,s[u],t[u]).connect(a);let c=[];for(let u=0;u<o.length;u++){let h=this.createAllpassFilter(e,u===0?a:c.at(-1),o[u],n[u]);c.push(h)}let l=c.at(-1);return{input:r,output:l}}createReverbEffect(e){let{algorithm:t,time:s,feedback:n}=this.reverb;switch(t){case"ConvolutionReverb":{let o=this.createConvolutionReverbImpulse(e,s,this.calcDelay(s,n));return this.createConvolutionReverb(e,o)}case"SchroederReverb":{let o=this.generateDistributedArray(n,4),r=o.map(l=>this.calcDelay(s,l)),a=this.generateDistributedArray(n,4),c=a.map(l=>this.calcDelay(s,l));return this.createSchroederReverb(e,o,r,a,c)}}}createChorusEffect(e){let t=new GainNode(e),s=new GainNode(e),n=new GainNode(e),o=new OscillatorNode(e,{frequency:this.chorus.modRate}),r=new GainNode(e,{gain:this.chorus.modDepth/2}),a=this.chorus.delayTimes,c=[],l=[];for(let u=0;u<a.length;u++){let h=a[u],d=new DelayNode(e,{maxDelayTime:.1,delayTime:h}),f=new GainNode(e,{gain:this.chorus.feedback});c.push(d),l.push(f),t.connect(d),r.connect(d.delayTime),d.connect(f),f.connect(d),d.connect(s)}return s.connect(n),o.connect(r),o.start(),{input:t,output:s,sendGain:n,lfo:o,lfoGain:r,delayNodes:c,feedbackGains:l}}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=e.isDrum?0:this.masterCoarseTuning+this.masterFineTuning,s=e.coarseTuning+e.fineTuning,n=t+s,o=e.state.pitchWheel*2-1,r=e.state.pitchWheelSensitivity*12800,a=o*r,c=e.channelPressureTable[0];if(0<=c){let u=(c-64)/37.5*e.state.channelPressure;return n+a+u}else return n+a}calcNoteDetune(e,t){return e.scaleOctaveTuningTable[t.noteNumber%12]}updateChannelDetune(e,t){this.processScheduledNotes(e,s=>{this.updateDetune(e,s,t)})}updateDetune(e,t,s){let n=this.calcNoteDetune(e,t),o=e.detune+n;if(this.isPortamento(e,t)){let r=t.startTime,a=(t.noteNumber-t.portamentoNoteNumber)*100,c=r+this.getPortamentoTime(e,t);t.bufferSource.detune.cancelScheduledValues(s).setValueAtTime(o-a,s).linearRampToValueAtTime(o,c)}else t.bufferSource.detune.cancelScheduledValues(s).setValueAtTime(o,s)}getPortamentoTime(e,t){let s=Math.abs(t.noteNumber-t.portamentoNoteNumber),n=Math.ceil(e.state.portamentoTimeMSB*127);return s/this.getPitchIncrementSpeed(n)/10}getPitchIncrementSpeed(e){let t=[[0,1e3],[6,100],[16,20],[32,10],[48,5],[64,2.5],[80,1],[96,.4],[112,.15],[127,.01]],s=new Array(t.length);for(let w=0;w<t.length;w++){let[C,pe]=t[w];if(e===C)return pe;s[w]=[C,Math.log(pe)]}let n=0;for(let w=1;w<s.length;w++)if(e<=s[w][0]){n=w-1;break}let[o,r]=s[n],[a,c]=s[n+1],l=a-o,u=(e-o)/l,h,d;if(n===0)h=(c-r)/l;else{let[w,C]=s[n-1];h=(c-C)/(a-w)}if(n===s.length-2)d=(c-r)/l;else{let[w,C]=s[n+2];d=(C-r)/(w-o)}let f=u*u,m=f*u,E=2*m-3*f+1,B=m-2*f+u,O=-2*m+3*f,x=m-f,g=E*r+O*c+l*(B*h+x*d);return Math.exp(g)}setPortamentoVolumeEnvelope(e,t,s){let{voiceParams:n,startTime:o}=t,a=U(-n.initialAttenuation)*(1+this.getAmplitudeControl(e))*(1-n.volSustain),c=o+this.getPortamentoTime(e,t);t.volumeEnvelopeNode.gain.cancelScheduledValues(s).linearRampToValueAtTime(a,c)}setVolumeEnvelope(e,t,s){let{voiceParams:n,startTime:o}=t,r=U(-n.initialAttenuation)*(1+this.getAmplitudeControl(e)),a=r*(1-n.volSustain),c=o+n.volDelay,l=c+n.volAttack,u=l+n.volHold,h=n.volDecay;t.volumeEnvelopeNode.gain.cancelScheduledValues(s).setValueAtTime(0,o).setValueAtTime(0,c).linearRampToValueAtTime(r,l).setValueAtTime(r,u).setTargetAtTime(a,u,h*ue)}setPortamentoPitchEnvelope(e,t){let s=e.voiceParams.playbackRate,n=e.startTime+this.getPortamentoTime(channel,e);e.bufferSource.playbackRate.cancelScheduledValues(t).linearRampToValueAtTime(s,n)}setPitchEnvelope(e,t){let{voiceParams:s}=e,n=s.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(n,e.startTime);let o=s.modEnvToPitch;if(o===0)return;let a=this.rateToCent(n)+o,c=this.centToRate(a),l=e.startTime+s.modDelay,u=l+s.modAttack,h=u+s.modHold,d=s.modDecay;e.bufferSource.playbackRate.setValueAtTime(n,l).linearRampToValueAtTime(c,u).setValueAtTime(c,h).setTargetAtTime(n,h,d*ue)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setPortamentoFilterEnvelope(e,t,s){let{voiceParams:n,startTime:o}=t,r=this.getSoftPedalFactor(e,t),a=n.initialFilterFc+this.getFilterCutoffControl(e),c=a+n.modEnvToFilterFc*(1-n.modSustain),l=this.centToHz(a),u=this.centToHz(c),h=this.clampCutoffFrequency(l*r),d=this.clampCutoffFrequency(u*r),f=o+this.getPortamentoTime(e,t),m=o+n.modDelay;t.adjustedBaseFreq=d,t.filterNode.frequency.cancelScheduledValues(s).setValueAtTime(h,o).setValueAtTime(h,m).linearRampToValueAtTime(d,f)}setFilterEnvelope(e,t,s){let{voiceParams:n,startTime:o}=t,r=n.modEnvToFilterFc,a=n.initialFilterFc+this.getFilterCutoffControl(e),c=a+r,l=a+r*(1-n.modSustain),u=this.getSoftPedalFactor(e,t),h=this.centToHz(a)*u,d=this.centToHz(c)*u,f=this.centToHz(l)*u,m=this.clampCutoffFrequency(h),E=this.clampCutoffFrequency(d),B=this.clampCutoffFrequency(f),O=o+n.modDelay,x=O+n.modAttack,g=x+n.modHold,w=n.modDecay;t.adjustedBaseFreq=m,t.filterNode.frequency.cancelScheduledValues(s).setValueAtTime(m,o).setValueAtTime(m,O).linearRampToValueAtTime(E,x).setValueAtTime(E,g).setTargetAtTime(B,g,w*ue)}startModulation(e,t,s){let n=this.audioContext,{voiceParams:o}=t;t.modulationLFO=new OscillatorNode(n,{frequency:this.centToHz(o.freqModLFO)}),t.filterDepth=new GainNode(n,{gain:o.modLfoToFilterFc}),t.modulationDepth=new GainNode(n),this.setModLfoToPitch(e,t,s),t.volumeDepth=new GainNode(n),this.setModLfoToVolume(t,s),t.modulationLFO.start(t.startTime+o.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}startVibrato(e,t,s){let{voiceParams:n}=t,o=e.state,r=o.vibratoRate*2,a=o.vibratoDelay*2;t.vibratoLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(n.freqVibLFO)*r}),t.vibratoLFO.start(t.startTime+n.delayVibLFO*a),t.vibratoDepth=new GainNode(this.audioContext),this.setVibLfoToPitch(e,t,s),t.vibratoLFO.connect(t.vibratoDepth),t.vibratoDepth.connect(t.bufferSource.detune)}async getAudioBuffer(e,t,s,n,o){let r=this.getVoiceId(e,t,s);if(o){let a=this.realtimeVoiceCache.get(r);if(a)return a;let c=await this.createAudioBuffer(n);return this.realtimeVoiceCache.set(r,c),c}else{let a=this.voiceCache.get(r);if(a)return a.counter+=1,a.maxCount<=a.counter&&this.voiceCache.delete(r),a.audioBuffer;{let c=this.voiceCounter.get(r)??0,l=await this.createAudioBuffer(n),u={audioBuffer:l,maxCount:c,counter:1};return this.voiceCache.set(r,u),l}}}async setNoteAudioNode(e,t,s){let n=this.audioContext,o=n.currentTime,{noteNumber:r,velocity:a,startTime:c}=t,l=e.state,u=this.getControllerState(e,r,a),h=t.voice.getAllParams(u);t.voiceParams=h;let d=await this.getAudioBuffer(e,r,a,h,s);t.bufferSource=this.createBufferSource(e,r,h,d),t.volumeEnvelopeNode=new GainNode(n),t.filterNode=new BiquadFilterNode(n,{type:"lowpass",Q:h.initialFilterQ/10});let f=e.scheduledNotes.at(-1);if(f&&f.noteNumber!==r&&(t.portamentoNoteNumber=f.noteNumber),!e.isDrum&&this.isPortamento(e,t)?(this.setPortamentoVolumeEnvelope(e,t,o),this.setPortamentoFilterEnvelope(e,t,o),this.setPortamentoPitchEnvelope(t,o)):(this.setVolumeEnvelope(e,t,o),this.setFilterEnvelope(e,t,o),this.setPitchEnvelope(t,o)),this.updateDetune(e,t,o),0<l.vibratoDepth&&this.startVibrato(e,t,o),0<l.modulationDepthMSB&&this.startModulation(e,t,o),e.mono&&e.currentBufferSource&&(e.currentBufferSource.stop(c),e.currentBufferSource=t.bufferSource),t.bufferSource.connect(t.filterNode),t.filterNode.connect(t.volumeEnvelopeNode),this.setChorusSend(e,t,o),this.setReverbSend(e,t,o),h.sample.type==="compressed"){let m=h.start/d.sampleRate;t.bufferSource.start(c,m)}else t.bufferSource.start(c);return t}handleExclusiveClass(e,t,s){let n=e.voiceParams.exclusiveClass;if(n===0)return;let o=this.exclusiveClassNotes[n];if(o){let[r,a]=o;r&&!r.ending&&this.noteOff(a,r.noteNumber,0,s,!0)}this.exclusiveClassNotes[n]=[e,t]}handleDrumExclusiveClass(e,t,s){let n=this.channels[t];if(!n.isDrum)return;let o=j[n.programNumber];if(!o)return;let r=o[e.noteNumber];if(r===0)return;let a=(r-1)*this.channels.length+t,c=this.drumExclusiveClassNotes[a];c&&!c.ending&&this.noteOff(t,c.noteNumber,0,s,!0),this.drumExclusiveClassNotes[a]=e}setNoteRouting(e,t,s){let n=this.channels[e],{noteNumber:o,volumeEnvelopeNode:r}=t;if(n.isDrum){let{keyBasedGainLs:a,keyBasedGainRs:c}=n,l=a[o],u=c[o];if(!l){let h=this.createChannelAudioNodes(this.audioContext);l=a[o]=h.gainL,u=c[o]=h.gainR}r.connect(l),r.connect(u)}else r.connect(n.gainL),r.connect(n.gainR);.5<=n.state.sustainPedal&&n.sustainNotes.push(t),this.handleExclusiveClass(t,e,s),this.handleDrumExclusiveClass(t,e,s)}async noteOn(e,t,s,n){let o=this.channels[e],r=n===void 0;r&&(n=this.audioContext.currentTime);let a=new he(t,s,n),c=o.scheduledNotes;a.index=c.length,c.push(a);let l=o.programNumber,u=this.soundFontTable[l];if(!u)return;let h=o.isDrum?128:o.bankLSB;if(u[h]===void 0){if(o.isDrum)return;h=0}let d=u[h];if(d===void 0)return;let f=this.soundFonts[d];a.voice=f.getVoice(h,l,t,s),a.voice&&(await this.setNoteAudioNode(o,a,r),this.setNoteRouting(e,a,n),a.resolveReady())}disconnectNote(e){e.bufferSource.disconnect(),e.filterNode.disconnect(),e.volumeEnvelopeNode.disconnect(),e.modulationDepth&&(e.volumeDepth.disconnect(),e.modulationDepth.disconnect(),e.modulationLFO.stop()),e.vibratoDepth&&(e.vibratoDepth.disconnect(),e.vibratoLFO.stop()),e.reverbSend&&e.reverbSend.disconnect(),e.chorusSend&&e.chorusSend.disconnect()}releaseNote(e,t,s){s??=this.audioContext.currentTime;let n=t.voiceParams.volRelease,o=s+n,r=s+t.voiceParams.modRelease;return t.filterNode.frequency.cancelScheduledValues(s).linearRampToValueAtTime(t.adjustedBaseFreq,r),t.volumeEnvelopeNode.gain.cancelScheduledValues(s).setTargetAtTime(0,s,n*Pt),new Promise(a=>{this.scheduleTask(()=>{let c=t.bufferSource;c.loop=!1,c.stop(o),this.disconnectNote(t),e.scheduledNotes[t.index]=void 0,a()},o)})}noteOff(e,t,s,n,o){let r=this.channels[e],a=r.state;if(!o){if(r.isDrum){if(!this.isLoopDrum(r,t))return}else if(.5<=a.sustainPedal||.5<=a.sostenutoPedal)return}let c=this.findNoteOffIndex(r,t);if(c<0)return;let l=r.scheduledNotes[c];l.ending=!0,this.setNoteIndex(r,c);let u=l.ready.then(()=>this.releaseNote(r,l,n));return this.notePromises.push(u),u}setNoteIndex(e,t){let s=!0;for(let n=e.scheduleIndex;n<t;n++){let o=e.scheduledNotes[n];if(o&&!o.ending){s=!1;break}}s&&(e.scheduleIndex=t+1)}findNoteOffIndex(e,t){let s=e.scheduledNotes;for(let n=e.scheduleIndex;n<s.length;n++){let o=s[n];if(o&&!o.ending&&o.noteNumber===t)return n}return-1}releaseSustainPedal(e,t,s){let n=t*2,o=this.channels[e],r=[];for(let a=0;a<o.sustainNotes.length;a++){let c=this.noteOff(e,o.sustainNotes[a].noteNumber,n,s);r.push(c)}return o.sustainNotes=[],r}releaseSostenutoPedal(e,t,s){let n=t*2,o=this.channels[e],r=[],a=o.sostenutoNotes;o.state.sostenutoPedal=0;for(let c=0;c<a.length;c++){let l=a[c],u=this.noteOff(e,l.noteNumber,n,s);r.push(u)}return o.sostenutoNotes=[],r}createMessageHandlers(){let e=new Array(256);return e[128]=(t,s)=>this.noteOff(t[0]&15,t[1],t[2],s),e[144]=(t,s)=>this.noteOn(t[0]&15,t[1],t[2],s),e[176]=(t,s)=>this.setControlChange(t[0]&15,t[1],t[2],s),e[192]=(t,s)=>this.setProgramChange(t[0]&15,t[1],s),e[208]=(t,s)=>this.setChannelPressure(t[0]&15,t[1],s),e[224]=(t,s)=>this.handlePitchBendMessage(t[0]&15,t[1],t[2],s),e[254]=(t,s)=>this.activeSensing(),e}handleMessage(e,t){let s=e[0];if(s===240)return this.handleSysEx(e.subarray(1),t);let n=this.messageHandlers[s];n&&n(e,t)}activeSensing(){this.lastActiveSensing=performance.now()}setProgramChange(e,t,s){let n=this.channels[e];if(n.programNumber=t,this.mode==="GM2")switch(n.bankMSB){case 120:n.isDrum=!0,n.keyBasedTable.fill(-1);break;case 121:n.isDrum=!1;break}}setChannelPressure(e,t,s){0<=s||(s=this.audioContext.currentTime);let n=this.channels[e];if(n.isDrum)return;let o=n.state.channelPressure,r=t/127;n.state.channelPressure=r;let a=n.channelPressureTable[0];if(0<=a){let l=(a-64)/37.5;n.detune+=l*(r-o)}let c=n.channelPressureTable;this.processActiveNotes(n,s,l=>{this.setEffects(n,l,c,s)}),this.applyVoiceParams(n,13,s)}handlePitchBendMessage(e,t,s,n){let o=s*128+t;this.setPitchBend(e,o,n)}setPitchBend(e,t,s){let n=this.channels[e];if(n.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=n.state,r=o.pitchWheel*2-1,a=(t-8192)/8192;o.pitchWheel=t/16383,n.detune+=(a-r)*o.pitchWheelSensitivity*12800,this.updateChannelDetune(n,s),this.applyVoiceParams(n,14,s)}setModLfoToPitch(e,t,s){if(t.modulationDepth){let n=t.voiceParams.modLfoToPitch+this.getLFOPitchDepth(e,t),r=(Math.abs(n)+e.state.modulationDepthMSB)*Math.sign(n);t.modulationDepth.gain.cancelScheduledValues(s).setValueAtTime(r,s)}else this.startModulation(e,t,s)}setVibLfoToPitch(e,t,s){if(t.vibratoDepth){let n=e.state.vibratoDepth*2,o=t.voiceParams.vibLfoToPitch,a=Math.abs(o)*n*Math.sign(o);t.vibratoDepth.gain.cancelScheduledValues(s).setValueAtTime(a,s)}else this.startVibrato(e,t,s)}setModLfoToFilterFc(e,t,s){let n=t.voiceParams.modLfoToFilterFc+this.getLFOFilterDepth(e);t.filterDepth.gain.cancelScheduledValues(s).setValueAtTime(n,s)}setModLfoToVolume(e,t,s){let n=t.voiceParams.modLfoToVolume,r=(U(Math.abs(n))-1)*Math.sign(n)*(1+this.getLFOAmplitudeDepth(e));t.volumeDepth.gain.cancelScheduledValues(s).setValueAtTime(r,s)}setReverbSend(e,t,s){let n=t.voiceParams.reverbEffectsSend*e.state.reverbSendLevel;if(e.isDrum){let o=this.getKeyBasedValue(e,t.noteNumber,91);0<=o&&(n=o/127)}if(!t.reverbSend)0<n&&(t.reverbSend=new GainNode(this.audioContext,{gain:n}),t.volumeEnvelopeNode.connect(t.reverbSend),t.reverbSend.connect(this.reverbEffect.input));else if(t.reverbSend.gain.cancelScheduledValues(s).setValueAtTime(n,s),0<n)t.volumeEnvelopeNode.connect(t.reverbSend);else try{t.volumeEnvelopeNode.disconnect(t.reverbSend)}catch{}}setChorusSend(e,t,s){let n=t.voiceParams.chorusEffectsSend*e.state.chorusSendLevel;if(e.isDrum){let o=this.getKeyBasedValue(e,t.noteNumber,93);0<=o&&(n=o/127)}if(!t.chorusSend)0<n&&(t.chorusSend=new GainNode(this.audioContext,{gain:n}),t.volumeEnvelopeNode.connect(t.chorusSend),t.chorusSend.connect(this.chorusEffect.input));else if(t.chorusSend.gain.cancelScheduledValues(s).setValueAtTime(n,s),0<n)t.volumeEnvelopeNode.connect(t.chorusSend);else try{t.volumeEnvelopeNode.disconnect(t.chorusSend)}catch{}}setDelayModLFO(e){let t=e.startTime+e.voiceParams.delayModLFO;try{e.modulationLFO.start(t)}catch{}}setFreqModLFO(e,t){let s=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(s,t)}setFreqVibLFO(e,t,s){let n=e.state.vibratoRate*2,o=t.voiceParams.freqVibLFO;t.vibratoLFO.frequency.cancelScheduledValues(s).setValueAtTime(o*n,s)}setDelayVibLFO(e,t){let s=e.state.vibratoDelay*2,n=t.voiceParams.delayVibLFO,o=t.startTime+n*s;try{t.vibratoLFO.start(o)}catch{}}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,s)=>{0<e.state.modulationDepthMSB&&this.setModLfoToPitch(e,t,s)},vibLfoToPitch:(e,t,s)=>{0<e.state.vibratoDepth&&this.setVibLfoToPitch(e,t,s)},modLfoToFilterFc:(e,t,s)=>{0<e.state.modulationDepthMSB&&this.setModLfoToFilterFc(e,t,s)},modLfoToVolume:(e,t,s)=>{0<e.state.modulationDepthMSB&&this.setModLfoToVolume(e,t,s)},chorusEffectsSend:(e,t,s)=>{this.setChorusSend(e,t,s)},reverbEffectsSend:(e,t,s)=>{this.setReverbSend(e,t,s)},delayModLFO:(e,t,s)=>{0<channel.state.modulationDepthMSB&&this.setDelayModLFO(t)},freqModLFO:(e,t,s)=>{0<channel.state.modulationDepthMSB&&this.setFreqModLFO(t,s)},delayVibLFO:(e,t,s)=>{0<e.state.vibratoDepth&&setDelayVibLFO(e,t)},freqVibLFO:(e,t,s)=>{0<e.state.vibratoDepth&&this.setFreqVibLFO(e,t,s)}}}getControllerState(e,t,s){let n=new Float32Array(e.state.array.length);return n.set(e.state.array),n[2]=s/127,n[3]=t/127,n[13]=n.channelPressure/127,n}applyVoiceParams(e,t,s){this.processScheduledNotes(e,n=>{let o=this.getControllerState(e,n.noteNumber,n.velocity),r=n.voice.getParams(t,o),a=!1,c=!1,l=!1;for(let[u,h]of Object.entries(r)){let d=n.voiceParams[u];h!==d&&(n.voiceParams[u]=h,u in this.voiceParamsHandlers?this.voiceParamsHandlers[u](e,n,s):(yt.has(u)&&(a=!0),vt.has(u)&&(c=!0),wt.has(u)&&(l=!0)))}a&&this.setVolumeEnvelope(e,n,s),c&&this.setFilterEnvelope(e,n,s),l&&this.setPitchEnvelope(n,s)})}createControlChangeHandlers(){let e=new Array(128);return e[0]=this.setBankMSB,e[1]=this.setModulationDepth,e[5]=this.setPortamentoTime,e[6]=this.dataEntryMSB,e[7]=this.setVolume,e[10]=this.setPan,e[11]=this.setExpression,e[32]=this.setBankLSB,e[38]=this.dataEntryLSB,e[64]=this.setSustainPedal,e[65]=this.setPortamento,e[66]=this.setSostenutoPedal,e[67]=this.setSoftPedal,e[91]=this.setReverbSendLevel,e[93]=this.setChorusSendLevel,e[100]=this.setRPNLSB,e[101]=this.setRPNMSB,e[120]=this.allSoundOff,e[121]=this.resetAllControllers,e[123]=this.allNotesOff,e[124]=this.omniOff,e[125]=this.omniOn,e[126]=this.monoOn,e[127]=this.polyOn,e}setControlChange(e,t,s,n){let o=this.controlChangeHandlers[t];if(o){o.call(this,e,s,n);let r=this.channels[e];this.applyVoiceParams(r,t+128,n),this.setControlChangeEffects(r,t,n)}else console.warn(`Unsupported Control change: controllerType=${t} value=${s}`)}setBankMSB(e,t){this.channels[e].bankMSB=t}updateModulation(e,t){let s=e.state.modulationDepthMSB*e.modulationDepthRange;this.processScheduledNotes(e,n=>{n.modulationDepth?n.modulationDepth.gain.setValueAtTime(s,t):this.startModulation(e,n,t)})}setModulationDepth(e,t,s){let n=this.channels[e];n.isDrum||(0<=s||(s=this.audioContext.currentTime),n.state.modulationDepthMSB=t/127,this.updateModulation(n,s))}updatePortamento(e,t){e.isDrum||this.processScheduledNotes(e,s=>{this.isPortamento(e,s)?(this.setPortamentoVolumeEnvelope(e,s,t),this.setPortamentoFilterEnvelope(e,s,t),this.setPortamentoPitchEnvelope(s,t),this.updateDetune(e,s,t)):(this.setVolumeEnvelope(e,s,t),this.setFilterEnvelope(e,s,t),this.setPitchEnvelope(s,t),this.updateDetune(e,s,t))})}setPortamentoTime(e,t,s){0<=s||(s=this.audioContext.currentTime);let n=this.channels[e];n.state.portamentoTimeMSB=t/127,!n.isDrum&&this.updatePortamento(n,s)}setVolume(e,t,s){0<=s||(s=this.audioContext.currentTime);let n=this.channels[e];if(n.state.volumeMSB=t/127,n.isDrum)for(let o=0;o<128;o++)this.updateKeyBasedVolume(n,o,s);else this.updateChannelVolume(n,s)}panToGain(e){let t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t,s){0<=s||(s=this.audioContext.currentTime);let n=this.channels[e];if(n.state.panMSB=t/127,n.isDrum)for(let o=0;o<128;o++)this.updateKeyBasedVolume(n,o,s);else this.updateChannelVolume(n,s)}setExpression(e,t,s){0<=s||(s=this.audioContext.currentTime);let n=this.channels[e];n.state.expressionMSB=t/127,this.updateChannelVolume(n,s)}setBankLSB(e,t){this.channels[e].bankLSB=t}dataEntryLSB(e,t,s){this.channels[e].dataLSB=t,this.handleRPN(e,s)}updateChannelVolume(e,t){let s=e.state,n=s.volumeMSB*s.expressionMSB,{gainLeft:o,gainRight:r}=this.panToGain(s.panMSB);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(n*o,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(n*r,t)}updateKeyBasedVolume(e,t,s){let n=e.keyBasedGainLs[t];if(!n)return;let o=e.keyBasedGainRs[t],r=e.state,a=r.volumeMSB*r.expressionMSB,c=r.panMSB,l=this.getKeyBasedValue(e,t,7),u=0<=l?a*l/64:a,h=this.getKeyBasedValue(e,t,10),d=0<=h?h/127:c,{gainLeft:f,gainRight:m}=this.panToGain(d);n.gain.cancelScheduledValues(s).setValueAtTime(u*f,s),o.gain.cancelScheduledValues(s).setValueAtTime(u*m,s)}setSustainPedal(e,t,s){let n=this.channels[e];n.isDrum||(0<=s||(s=this.audioContext.currentTime),n.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(n,o=>{n.sustainNotes.push(o)}):this.releaseSustainPedal(e,t,s))}isPortamento(e,t){return .5<=e.state.portamento&&0<=t.portamentoNoteNumber}setPortamento(e,t,s){let n=this.channels[e];n.isDrum||(0<=s||(s=this.audioContext.currentTime),n.state.portamento=t/127,this.updatePortamento(n,s))}setSostenutoPedal(e,t,s){let n=this.channels[e];if(!n.isDrum)if(0<=s||(s=this.audioContext.currentTime),n.state.sostenutoPedal=t/127,64<=t){let o=[];this.processActiveNotes(n,s,r=>{o.push(r)}),n.sostenutoNotes=o}else this.releaseSostenutoPedal(e,t,s)}getSoftPedalFactor(e,t){return 1-(.1+t.noteNumber/127*.2)*e.state.softPedal}setSoftPedal(e,t,s){let n=this.channels[e];if(n.isDrum)return;let o=n.state;0<=s||(s=this.audioContext.currentTime),o.softPedal=t/127,this.processScheduledNotes(n,r=>{this.isPortamento(n,r)?(this.setPortamentoVolumeEnvelope(n,r,s),this.setPortamentoFilterEnvelope(n,r,s)):(this.setVolumeEnvelope(n,r,s),this.setFilterEnvelope(n,r,s))})}setReverbSendLevel(e,t,s){0<=s||(s=this.audioContext.currentTime);let n=this.channels[e],o=n.state;o.reverbSendLevel=t/127,this.processScheduledNotes(n,r=>{this.setReverbSend(n,r,s)})}setChorusSendLevel(e,t,s){0<=s||(s=this.audioContext.currentTime);let n=this.channels[e],o=n.state;o.chorusSendLevel=t/127,this.processScheduledNotes(n,r=>{this.setChorusSend(n,r,s)})}limitData(e,t,s,n,o){o<e.dataLSB?(e.dataMSB++,e.dataLSB=n):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=o),s<e.dataMSB?(e.dataMSB=s,e.dataLSB=o):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=n)}limitDataMSB(e,t,s){s<e.dataMSB?e.dataMSB=s:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e,t){let s=this.channels[e];switch(s.rpnMSB*128+s.rpnLSB){case 0:this.handlePitchBendRangeRPN(e,t);break;case 1:this.handleFineTuningRPN(e,t);break;case 2:this.handleCoarseTuningRPN(e,t);break;case 5:this.handleModulationDepthRangeRPN(e,t);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${s.rpnMSB} LSB=${s.rpnLSB}`)}}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,s){this.channels[e].dataMSB=t,this.handleRPN(e,s)}handlePitchBendRangeRPN(e,t){let s=this.channels[e];this.limitData(s,0,127,0,127);let n=(s.dataMSB+s.dataLSB/128)*100;this.setPitchBendRange(e,n,t)}setPitchBendRange(e,t,s){let n=this.channels[e];if(n.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=n.state,r=o.pitchWheelSensitivity,a=t/12800;o.pitchWheelSensitivity=a,n.detune+=(o.pitchWheel*2-1)*(a-r)*12800,this.updateChannelDetune(n,s),this.applyVoiceParams(n,16,s)}handleFineTuningRPN(e,t){let s=this.channels[e];this.limitData(s,0,127,0,127);let o=(s.dataMSB*128+s.dataLSB-8192)/8192*100;this.setFineTuning(e,o,t)}setFineTuning(e,t,s){let n=this.channels[e];if(n.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=n.fineTuning,r=t;n.fineTuning=r,n.detune+=r-o,this.updateChannelDetune(n,s)}handleCoarseTuningRPN(e,t){let s=this.channels[e];this.limitDataMSB(s,0,127);let n=(s.dataMSB-64)*100;this.setCoarseTuning(e,n,t)}setCoarseTuning(e,t,s){let n=this.channels[e];if(n.isDrum)return;0<=s||(s=this.audioContext.currentTime);let o=n.coarseTuning,r=t;n.coarseTuning=r,n.detune+=r-o,this.updateChannelDetune(n,s)}handleModulationDepthRangeRPN(e,t){let s=this.channels[e];this.limitData(s,0,127,0,127);let n=(s.dataMSB+s.dataLSB/128)*100;this.setModulationDepthRange(e,n,t)}setModulationDepthRange(e,t,s){let n=this.channels[e];n.isDrum||(0<=s||(s=this.audioContext.currentTime),n.modulationDepthRange=t,this.updateModulation(n,s))}allSoundOff(e,t,s){return 0<=s||(s=this.audioContext.currentTime),this.stopActiveNotes(e,0,!0,s)}resetChannelStates(e){let t=this.audioContext.currentTime,s=this.channels[e],n=s.state,o=Object.entries(Y);for(let[r,{type:a,defaultValue:c}]of o)128<=a?this.setControlChange(e,a-128,Math.ceil(c*127),t):n[r]=c;for(let r of Object.keys(this.constructor.channelSettings))s[r]=this.constructor.channelSettings[r];this.resetChannelTable(s),this.mode="GM2",this.masterFineTuning=0,this.masterCoarseTuning=0}resetAllControllers(e,t,s){let n=["channelPressure","pitchWheel","expressionMSB","modulationDepthMSB","sustainPedal","portamento","sostenutoPedal","softPedal"],o=this.channels[e],r=o.state;for(let c=0;c<n.length;c++){let l=n[c],{type:u,defaultValue:h}=Y[l];128<=u?this.setControlChange(e,u-128,Math.ceil(h*127),s):r[l]=h}this.setPitchBend(e,8192,s);let a=["rpnMSB","rpnLSB"];for(let c=0;c<a.length;c++){let l=a[c];o[l]=this.constructor.channelSettings[l]}}allNotesOff(e,t,s){return 0<=s||(s=this.audioContext.currentTime),this.stopActiveNotes(e,0,!1,s)}omniOff(e,t,s){this.allNotesOff(e,t,s)}omniOn(e,t,s){this.allNotesOff(e,t,s)}monoOn(e,t,s){let n=this.channels[e];this.allNotesOff(e,t,s),n.mono=!0}polyOn(e,t,s){let n=this.channels[e];this.allNotesOff(e,t,s),n.mono=!1}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 8:if(e[3]===8)return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!1,t);console.warn(`Unsupported Exclusive Message: ${e}`);break;case 9:switch(e[3]){case 1:this.GM1SystemOn(t);break;case 2:break;case 3:this.GM2SystemOn(t);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(e){let t=this.channels;0<=e||(e=this.audioContext.currentTime),this.mode="GM1";for(let s=0;s<t.length;s++){this.allSoundOff(s,0,e);let n=t[s];n.bankMSB=0,n.bankLSB=0,n.isDrum=!1}t[9].bankMSB=1,t[9].isDrum=!0}GM2SystemOn(e){let t=this.channels;0<=e||(e=this.audioContext.currentTime),this.mode="GM2";for(let s=0;s<t.length;s++){this.allSoundOff(s,0,e);let n=t[s];n.bankMSB=121,n.bankLSB=0,n.isDrum=!1}t[9].bankMSB=120,t[9].isDrum=!0}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e,t);case 3:return this.handleMasterFineTuningSysEx(e,t);case 4:return this.handleMasterCoarseTuningSysEx(e,t);case 5:return this.handleGlobalParameterControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:return this.handlePressureSysEx(e,"channelPressureTable",t);case 3:return this.handleControlChangeSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 10:if(e[3]===1)return this.handleKeyBasedInstrumentControlSysEx(e,t);console.warn(`Unsupported Exclusive Message: ${e}`);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){let s=(e[5]*128+e[4])/16383;this.setMasterVolume(s,t)}setMasterVolume(e,t){0<=t||(t=this.audioContext.currentTime),this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleMasterFineTuningSysEx(e,t){let n=((e[5]*128+e[4])/16383-8192)/8192*100;this.setMasterFineTuning(n,t)}setMasterFineTuning(e,t){let s=this.masterFineTuning,n=e;this.masterFineTuning=n;let o=n-s;for(let r=0;r<this.channels.length;r++){let a=this.channels[r];a.isDrum||(a.detune+=o,this.updateChannelDetune(a,t))}}handleMasterCoarseTuningSysEx(e,t){let s=(e[4]-64)*100;this.setMasterCoarseTuning(s,t)}setMasterCoarseTuning(e,t){let s=this.masterCoarseTuning,n=e;this.masterCoarseTuning=n;let o=n-s;for(let r=0;r<this.channels.length;r++){let a=this.channels[r];a.isDrum||(a.detune+=o,this.updateChannelDetune(a,t))}}handleGlobalParameterControlSysEx(e,t){if(e[7]===1)switch(e[8]){case 1:return this.handleReverbParameterSysEx(e);case 2:return this.handleChorusParameterSysEx(e,t);default:console.warn(`Unsupported Global Parameter Control Message: ${e}`)}else console.warn(`Unsupported Global Parameter Control Message: ${e}`)}handleReverbParameterSysEx(e){switch(e[9]){case 0:return this.setReverbType(e[10]);case 1:return this.setReverbTime(e[10])}}setReverbType(e){this.reverb.time=this.getReverbTimeFromType(e),this.reverb.feedback=e===8?.9:.8,this.reverbEffect=this.createReverbEffect(this.audioContext)}getReverbTimeFromType(e){switch(e){case 0:return this.getReverbTime(44);case 1:return this.getReverbTime(50);case 2:return this.getReverbTime(56);case 3:return this.getReverbTime(64);case 4:return this.getReverbTime(64);case 8:return this.getReverbTime(50);default:console.warn(`Unsupported Reverb Time: ${e}`)}}setReverbTime(e){this.reverb.time=this.getReverbTime(e),this.reverbEffect=this.createReverbEffect(this.audioContext)}getReverbTime(e){return Math.exp((e-40)*.025)}calcDelay(e,t){return-e*Math.log10(t)/3}handleChorusParameterSysEx(e,t){switch(e[9]){case 0:return this.setChorusType(e[10],t);case 1:return this.setChorusModRate(e[10],t);case 2:return this.setChorusModDepth(e[10],t);case 3:return this.setChorusFeedback(e[10],t);case 4:return this.setChorusSendToReverb(e[10],t)}}setChorusType(e,t){switch(e){case 0:return this.setChorusParameter(3,5,0,0,t);case 1:return this.setChorusParameter(9,19,5,0,t);case 2:return this.setChorusParameter(3,19,8,0,t);case 3:return this.setChorusParameter(9,16,16,0,t);case 4:return this.setChorusParameter(2,24,64,0,t);case 5:return this.setChorusParameter(1,5,112,0,t);default:console.warn(`Unsupported Chorus Type: ${e}`)}}setChorusParameter(e,t,s,n,o){this.setChorusModRate(e,o),this.setChorusModDepth(t,o),this.setChorusFeedback(s,o),this.setChorusSendToReverb(n,o)}setChorusModRate(e,t){let s=this.getChorusModRate(e);this.chorus.modRate=s,this.chorusEffect.lfo.frequency.setValueAtTime(s,t)}getChorusModRate(e){return e*.122}setChorusModDepth(e,t){let s=this.getChorusModDepth(e);this.chorus.modDepth=s,this.chorusEffect.lfoGain.gain.cancelScheduledValues(t).setValueAtTime(s/2,t)}getChorusModDepth(e){return(e+1)/3200}setChorusFeedback(e,t){let s=this.getChorusFeedback(e);this.chorus.feedback=s;let n=this.chorusEffect;for(let o=0;o<n.feedbackGains.length;o++)n.feedbackGains[o].gain.cancelScheduledValues(t).setValueAtTime(s,t)}getChorusFeedback(e){return e*.00763}setChorusSendToReverb(e,t){let s=this.getChorusSendToReverb(e),n=this.chorusEffect.sendGain;0<this.chorus.sendToReverb?(this.chorus.sendToReverb=s,0<s?n.gain.cancelScheduledValues(t).setValueAtTime(s,t):n.disconnect()):(this.chorus.sendToReverb=s,0<s&&(n.connect(this.reverbEffect.input),n.gain.cancelScheduledValues(t).setValueAtTime(s,t)))}getChorusSendToReverb(e){return e*.00787}getChannelBitmap(e){let t=new Array(this.channels.length).fill(!1),s=e[4]&3,n=e[5]&127,o=e[6]&127;for(let r=0;r<7;r++)o&1<<r&&(t[r]=!0);for(let r=0;r<7;r++)n&1<<r&&(t[r+7]=!0);for(let r=0;r<2;r++)s&1<<r&&(t[r+14]=!0);return t}handleScaleOctaveTuning1ByteFormatSysEx(e,t,s){if(e.length<19){console.error("Data length is too short");return}let n=this.getChannelBitmap(e);for(let o=0;o<n.length;o++){if(!n[o])continue;let r=this.channels[o];if(!r.isDrum){for(let a=0;a<12;a++){let c=e[a+7]-64;r.scaleOctaveTuningTable[a]=c}t&&this.updateChannelDetune(r,s)}}}getFilterCutoffControl(e){let t=e.channelPressureTable[1];return(0<=t?(t-64)*e.state.channelPressure:0)*15}getAmplitudeControl(e){let t=e.channelPressureTable[2];return 0<=t?e.state.channelPressure*127/t:0}getLFOPitchDepth(e){let t=e.channelPressureTable[3];return(0<=t?t*e.state.channelPressure:0)/127*600}getLFOFilterDepth(e){let t=e.channelPressureTable[4];return(0<=t?t*e.state.channelPressure:0)/127*2400}getLFOAmplitudeDepth(e){let t=e.channelPressureTable[5];return(0<=t?t*e.state.channelPressure:0)/127}setEffects(e,t,s,n){0<s[0]&&this.updateDetune(e,t,n),.5<=e.state.portamemento&&0<=t.portamentoNoteNumber?(0<s[1]&&this.setPortamentoFilterEnvelope(e,t,n),0<s[2]&&this.setPortamentoVolumeEnvelope(e,t,n)):(0<s[1]&&this.setFilterEnvelope(e,t,n),0<s[2]&&this.setVolumeEnvelope(e,t,n)),0<s[3]&&this.setModLfoToPitch(e,t,n),0<s[4]&&this.setModLfoToFilterFc(e,t,n),0<s[5]&&this.setModLfoToVolume(e,t,n)}handlePressureSysEx(e,t,s){let n=e[4],o=this.channels[n];if(o.isDrum)return;let r=o[t];for(let a=5;a<e.length-1;a+=2){let c=e[a],l=e[a+1];r[c]=l}this.processActiveNotes(o,s,a=>{this.setEffects(o,a,r,s)})}initControlTable(){return new Int8Array(768).fill(-1)}setControlChangeEffects(e,t,s){let o=t*6,r=e.controlTable.subarray(o,o+6);this.processScheduledNotes(e,a=>{this.setEffects(e,a,r,s)})}handleControlChangeSysEx(e,t){let s=e[4],n=this.channels[s];if(n.isDrum)return;let o=6,r=e[5],a=r*o,c=n.controlTable;for(let l=6;l<e.length;l+=2){let u=e[l],h=e[l+1];c[a+u]=h}this.setControlChangeEffects(n,r,t)}getKeyBasedValue(e,t,s){let n=t*128+s;return e.keyBasedTable[n]}createKeyBasedControllerHandlers(){let e=new Array(128);return e[7]=(t,s,n)=>this.updateKeyBasedVolume(t,s,n),e[10]=(t,s,n)=>this.updateKeyBasedVolume(t,s,n),e[91]=(t,s,n)=>this.processScheduledNotes(t,o=>{o.noteNumber===s&&this.setReverbSend(t,o,n)}),e[93]=(t,s,n)=>this.processScheduledNotes(t,o=>{o.noteNumber===s&&this.setChorusSend(t,o,n)}),e}handleKeyBasedInstrumentControlSysEx(e,t){let s=e[4],n=this.channels[s];if(!n.isDrum)return;let o=e[5],r=n.keyBasedTable;for(let a=6;a<e.length;a+=2){let c=e[a],l=e[a+1],u=o*128+c;r[u]=l;let h=this.keyBasedControllerHandlers[c];h&&h(n,o,t)}}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(s=>{let n=new AudioBufferSourceNode(this.audioContext,{buffer:this.schedulerBuffer});n.connect(this.scheduler),n.onended=()=>{try{e()}finally{n.disconnect(),s()}},n.start(t)})}};export{Be as MidyGM2};
