var De=Object.create;var de=Object.defineProperty;var Ie=Object.getOwnPropertyDescriptor;var Ne=Object.getOwnPropertyNames;var Be=Object.getPrototypeOf,Re=Object.prototype.hasOwnProperty;var Y=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var Le=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ne(e))!Re.call(i,r)&&r!==t&&de(i,r,{get:()=>e[r],enumerable:!(n=Ie(e,r))||n.enumerable});return i};var Ae=(i,e,t)=>(t=i!=null?De(Be(i)):{},Le(e||!i||!i.__esModule?de(t,"default",{value:i,enumerable:!0}):t,i));var pe=Y((ft,fe)=>{function Ue(i){var e=new S(i),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var n=Ge(t.data),r=[],o=0;!e.eof()&&o<n.numTracks;o++){var s=e.readChunk();if(s.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+s.id+"'";var a=je(s.data);r.push(a)}return{header:n,tracks:r}}function Ge(i){var e=new S(i),t=e.readUInt16(),n=e.readUInt16(),r={format:t,numTracks:n},o=e.readUInt16();return o&32768?(r.framesPerSecond=256-(o>>8),r.ticksPerFrame=o&255):r.ticksPerBeat=o,r}function je(i){for(var e=new S(i),t=[];!e.eof();){var n=o();t.push(n)}return t;var r;function o(){var s={};s.deltaTime=e.readVarInt();var a=e.readUInt8();if((a&240)===240)if(a===255){s.meta=!0;var c=e.readUInt8(),l=e.readVarInt();switch(c){case 0:if(s.type="sequenceNumber",l!==2)throw"Expected length for sequenceNumber event is 2, got "+l;return s.number=e.readUInt16(),s;case 1:return s.type="text",s.text=e.readString(l),s;case 2:return s.type="copyrightNotice",s.text=e.readString(l),s;case 3:return s.type="trackName",s.text=e.readString(l),s;case 4:return s.type="instrumentName",s.text=e.readString(l),s;case 5:return s.type="lyrics",s.text=e.readString(l),s;case 6:return s.type="marker",s.text=e.readString(l),s;case 7:return s.type="cuePoint",s.text=e.readString(l),s;case 32:if(s.type="channelPrefix",l!=1)throw"Expected length for channelPrefix event is 1, got "+l;return s.channel=e.readUInt8(),s;case 33:if(s.type="portPrefix",l!=1)throw"Expected length for portPrefix event is 1, got "+l;return s.port=e.readUInt8(),s;case 47:if(s.type="endOfTrack",l!=0)throw"Expected length for endOfTrack event is 0, got "+l;return s;case 81:if(s.type="setTempo",l!=3)throw"Expected length for setTempo event is 3, got "+l;return s.microsecondsPerBeat=e.readUInt24(),s;case 84:if(s.type="smpteOffset",l!=5)throw"Expected length for smpteOffset event is 5, got "+l;var h=e.readUInt8(),u={0:24,32:25,64:29,96:30};return s.frameRate=u[h&96],s.hour=h&31,s.min=e.readUInt8(),s.sec=e.readUInt8(),s.frame=e.readUInt8(),s.subFrame=e.readUInt8(),s;case 88:if(s.type="timeSignature",l!=2&&l!=4)throw"Expected length for timeSignature event is 4 or 2, got "+l;return s.numerator=e.readUInt8(),s.denominator=1<<e.readUInt8(),l===4?(s.metronome=e.readUInt8(),s.thirtyseconds=e.readUInt8()):(s.metronome=36,s.thirtyseconds=8),s;case 89:if(s.type="keySignature",l!=2)throw"Expected length for keySignature event is 2, got "+l;return s.key=e.readInt8(),s.scale=e.readUInt8(),s;case 127:return s.type="sequencerSpecific",s.data=e.readBytes(l),s;default:return s.type="unknownMeta",s.data=e.readBytes(l),s.metatypeByte=c,s}}else if(a==240){s.type="sysEx";var l=e.readVarInt();return s.data=e.readBytes(l),s}else if(a==247){s.type="endSysEx";var l=e.readVarInt();return s.data=e.readBytes(l),s}else throw"Unrecognised MIDI event type byte: "+a;else{var d;if((a&128)===0){if(r===null)throw"Running status byte encountered before status byte";d=a,a=r,s.running=!0}else d=e.readUInt8(),r=a;var f=a>>4;switch(s.channel=a&15,f){case 8:return s.type="noteOff",s.noteNumber=d,s.velocity=e.readUInt8(),s;case 9:var m=e.readUInt8();return s.type=m===0?"noteOff":"noteOn",s.noteNumber=d,s.velocity=m,m===0&&(s.byte9=!0),s;case 10:return s.type="noteAftertouch",s.noteNumber=d,s.amount=e.readUInt8(),s;case 11:return s.type="controller",s.controllerType=d,s.value=e.readUInt8(),s;case 12:return s.type="programChange",s.programNumber=d,s;case 13:return s.type="channelAftertouch",s.amount=d,s;case 14:return s.type="pitchBend",s.value=d+(e.readUInt8()<<7)-8192,s;default:throw"Unrecognised MIDI event type: "+f}}}}function S(i){this.buffer=i,this.bufferLen=this.buffer.length,this.pos=0}S.prototype.eof=function(){return this.pos>=this.bufferLen};S.prototype.readUInt8=function(){var i=this.buffer[this.pos];return this.pos+=1,i};S.prototype.readInt8=function(){var i=this.readUInt8();return i&128?i-256:i};S.prototype.readUInt16=function(){var i=this.readUInt8(),e=this.readUInt8();return(i<<8)+e};S.prototype.readInt16=function(){var i=this.readUInt16();return i&32768?i-65536:i};S.prototype.readUInt24=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(i<<16)+(e<<8)+t};S.prototype.readInt24=function(){var i=this.readUInt24();return i&8388608?i-16777216:i};S.prototype.readUInt32=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8();return(i<<24)+(e<<16)+(t<<8)+n};S.prototype.readBytes=function(i){var e=this.buffer.slice(this.pos,this.pos+i);return this.pos+=i,e};S.prototype.readString=function(i){var e=this.readBytes(i);return String.fromCharCode.apply(null,e)};S.prototype.readVarInt=function(){for(var i=0;!this.eof();){var e=this.readUInt8();if(e&128)i+=e&127,i<<=7;else return i+e}return i};S.prototype.readChunk=function(){var i=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:i,length:e,data:t}};fe.exports=Ue});var be=Y((pt,me)=>{function He(i,e){if(typeof i!="object")throw"Invalid MIDI data";e=e||{};var t=i.header||{},n=i.tracks||[],r,o=n.length,s=new g;for(qe(s,t,o),r=0;r<o;r++)Ke(s,n[r],e);return s.buffer}function qe(i,e,t){var n=e.format==null?1:e.format,r=128;e.timeDivision?r=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?r=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(r=e.ticksPerBeat&32767);var o=new g;o.writeUInt16(n),o.writeUInt16(t),o.writeUInt16(r),i.writeChunk("MThd",o.buffer)}function Ke(i,e,t){var n=new g,r,o=e.length,s=null;for(r=0;r<o;r++)(t.running===!1||!t.running&&!e[r].running)&&(s=null),s=We(n,e[r],s,t.useByte9ForNoteOff);i.writeChunk("MTrk",n.buffer)}function We(i,e,t,n){var r=e.type,o=e.deltaTime,s=e.text||"",a=e.data||[],c=null;switch(i.writeVarInt(o),r){case"sequenceNumber":i.writeUInt8(255),i.writeUInt8(0),i.writeVarInt(2),i.writeUInt16(e.number);break;case"text":i.writeUInt8(255),i.writeUInt8(1),i.writeVarInt(s.length),i.writeString(s);break;case"copyrightNotice":i.writeUInt8(255),i.writeUInt8(2),i.writeVarInt(s.length),i.writeString(s);break;case"trackName":i.writeUInt8(255),i.writeUInt8(3),i.writeVarInt(s.length),i.writeString(s);break;case"instrumentName":i.writeUInt8(255),i.writeUInt8(4),i.writeVarInt(s.length),i.writeString(s);break;case"lyrics":i.writeUInt8(255),i.writeUInt8(5),i.writeVarInt(s.length),i.writeString(s);break;case"marker":i.writeUInt8(255),i.writeUInt8(6),i.writeVarInt(s.length),i.writeString(s);break;case"cuePoint":i.writeUInt8(255),i.writeUInt8(7),i.writeVarInt(s.length),i.writeString(s);break;case"channelPrefix":i.writeUInt8(255),i.writeUInt8(32),i.writeVarInt(1),i.writeUInt8(e.channel);break;case"portPrefix":i.writeUInt8(255),i.writeUInt8(33),i.writeVarInt(1),i.writeUInt8(e.port);break;case"endOfTrack":i.writeUInt8(255),i.writeUInt8(47),i.writeVarInt(0);break;case"setTempo":i.writeUInt8(255),i.writeUInt8(81),i.writeVarInt(3),i.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":i.writeUInt8(255),i.writeUInt8(84),i.writeVarInt(5);var l={24:0,25:32,29:64,30:96},h=e.hour&31|l[e.frameRate];i.writeUInt8(h),i.writeUInt8(e.min),i.writeUInt8(e.sec),i.writeUInt8(e.frame),i.writeUInt8(e.subFrame);break;case"timeSignature":i.writeUInt8(255),i.writeUInt8(88),i.writeVarInt(4),i.writeUInt8(e.numerator);var u=Math.floor(Math.log(e.denominator)/Math.LN2)&255;i.writeUInt8(u),i.writeUInt8(e.metronome),i.writeUInt8(e.thirtyseconds||8);break;case"keySignature":i.writeUInt8(255),i.writeUInt8(89),i.writeVarInt(2),i.writeInt8(e.key),i.writeUInt8(e.scale);break;case"sequencerSpecific":i.writeUInt8(255),i.writeUInt8(127),i.writeVarInt(a.length),i.writeBytes(a);break;case"unknownMeta":e.metatypeByte!=null&&(i.writeUInt8(255),i.writeUInt8(e.metatypeByte),i.writeVarInt(a.length),i.writeBytes(a));break;case"sysEx":i.writeUInt8(240),i.writeVarInt(a.length),i.writeBytes(a);break;case"endSysEx":i.writeUInt8(247),i.writeVarInt(a.length),i.writeBytes(a);break;case"noteOff":var d=n!==!1&&e.byte9||n&&e.velocity==0?144:128;c=d|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.velocity);break;case"noteOn":c=144|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.velocity);break;case"noteAftertouch":c=160|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.noteNumber),i.writeUInt8(e.amount);break;case"controller":c=176|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.controllerType),i.writeUInt8(e.value);break;case"programChange":c=192|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.programNumber);break;case"channelAftertouch":c=208|e.channel,c!==t&&i.writeUInt8(c),i.writeUInt8(e.amount);break;case"pitchBend":c=224|e.channel,c!==t&&i.writeUInt8(c);var f=8192+e.value,m=f&127,w=f>>7&127;i.writeUInt8(m),i.writeUInt8(w);break;default:throw"Unrecognized event type: "+r}return c}function g(){this.buffer=[]}g.prototype.writeUInt8=function(i){this.buffer.push(i&255)};g.prototype.writeInt8=g.prototype.writeUInt8;g.prototype.writeUInt16=function(i){var e=i>>8&255,t=i&255;this.writeUInt8(e),this.writeUInt8(t)};g.prototype.writeInt16=g.prototype.writeUInt16;g.prototype.writeUInt24=function(i){var e=i>>16&255,t=i>>8&255,n=i&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n)};g.prototype.writeInt24=g.prototype.writeUInt24;g.prototype.writeUInt32=function(i){var e=i>>24&255,t=i>>16&255,n=i>>8&255,r=i&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(r)};g.prototype.writeInt32=g.prototype.writeUInt32;g.prototype.writeBytes=function(i){this.buffer=this.buffer.concat(Array.prototype.slice.call(i,0))};g.prototype.writeString=function(i){var e,t=i.length,n=[];for(e=0;e<t;e++)n.push(i.codePointAt(e));this.writeBytes(n)};g.prototype.writeVarInt=function(i){if(i<0)throw"Cannot write negative variable-length integer";if(i<=127)this.writeUInt8(i);else{var e=i,t=[];for(t.push(e&127),e>>=7;e;){var n=e&127|128;t.push(n),e>>=7}this.writeBytes(t.reverse())}};g.prototype.writeChunk=function(i,e){this.writeString(i),this.writeUInt32(e.length),this.writeBytes(e)};me.exports=He});var ge=Y(ee=>{ee.parseMidi=pe();ee.writeMidi=be()});var Me=Ae(ge());var E=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,n=t+e,r=this.data;this.offset=n;let o=n;for(let c=t+1;c<n;c++)if(r[c]===0){o=c;break}let s=o-t,a=new Array(s);for(let c=0;c<s;c++)a[c]=r[t+c];return String.fromCharCode(...a)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function ne(i,e,t){let n=new E(i,e),r=n.readString(4),o=n.readDWORD(t);return new te(r,o,n.offset)}function re(i,e=0,t,{padding:n=!0,bigEndian:r=!1}={}){let o=[],s=t+e,a=e;for(;a<s;){let c=ne(i,a,r);a=c.offset+c.size,n&&(a-e&1)===1&&a++,o.push(c)}return o}var te=class{constructor(e,t,n){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:n})}};var k=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var b=class i{constructor(e,t,n,r,o){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:o})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,n=e&127,r=e>>7&1,o=e>>8&1,s=e>>9&1;return new i(t,s,o,r,n)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var se=class i{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),n=e.readInt8();return new i(t,n)}},U=class i{constructor(e,t,n,r,o,s,a,c,l,h,u){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:h}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:u})}static parse(e,t){function n(F){for(let P=0;P<t.length;P++)if(t[P].type===F)return t[P]}function r(F){return new E(e,F.offset)}function o(F){let P=n(F);return P?r(P).readString(P.size):null}function s(F){let P=n(F);return P?se.parse(r(P)):null}let a=o("ICMT"),c=o("ICOP"),l=o("ICRD"),h=o("IENG"),u=o("INAM"),d=o("IPRD"),f=o("ISFT"),m=s("ifil"),w=o("isng"),V=o("irom"),N=s("iver");return new i(a,c,l,h,u,d,f,m,w,V,N)}},B=class i{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),n=e.readWORD();return new i(t,n)}},G=class i{constructor(e,t,n,r,o,s,a){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:a})}get isEnd(){return this.presetName==="EOP"}static parse(e){let t=e.readString(20),n=e.readWORD(),r=e.readWORD(),o=e.readWORD(),s=e.readDWORD(),a=e.readDWORD(),c=e.readDWORD();return new i(t,n,r,o,s,a,c)}},M=class i{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),n=e.readByte();return new i(t,n)}},y=class i{constructor(e,t,n,r,o){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:o})}transform(e){let t=this.value*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),n=e.readWORD(),r=e.readInt16(),o=e.readWORD(),s=e.readWORD(),a=b.parse(t),c=b.parse(o);return new i(a,n,r,c,s)}},R=class i{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return k[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),n=k[t],r;switch(n){case"keyRange":case"velRange":r=M.parse(e);break;default:r=e.readInt16();break}return new i(t,r)}},j=class i{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new i;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},H=class i{constructor(e,t,n,r,o,s,a,c,l,h){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:h})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let n=e.readString(20),r=e.readDWORD(),o=e.readDWORD(),s=e.readDWORD(),a=e.readDWORD(),c=e.readDWORD(),l=e.readByte(),h=e.readInt8(),u=e.readWORD(),d=e.readWORD();return t||(s-=r,a-=r),new i(n,r,o,s,a,c,l,h,u,d)}};var p=class{constructor(e,t,n){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=n}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};function ye(i,e={}){let t=re(i,0,i.length,e);if(t.length!==1)throw new Error("wrong chunk length");let n=t[0];if(n===null)throw new Error("chunk not found");function r(c,l,h={}){let u=q(c,l,"RIFF","sfbk",h);if(u.length!==3)throw new Error("invalid sfbk structure");let d=$e(u[0],l),f=d.version.major===3;return f&&u[2].type!=="LIST"&&(u[2]=ne(l,u[2].offset-9,!1)),{info:d,samplingData:ze(u[1],l),...o(u[2],l,f)}}function o(c,l,h){let u=q(c,l,"LIST","pdta");if(u.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:Ze(u[0],l),presetZone:Qe(u[1],l),presetModulators:Xe(u[2],l),presetGenerators:et(u[3],l),instruments:_e(u[4],l),instrumentZone:Je(u[5],l),instrumentModulators:Ye(u[6],l),instrumentGenerators:tt(u[7],l),sampleHeaders:nt(u[8],l,h)}}let s=r(n,i,e),a=s.info.version.major===3;return{...s,samples:rt(s.sampleHeaders,s.samplingData.offsetMSB,s.samplingData.offsetLSB,i,a)}}function q(i,e,t,n,r={}){if(i.type!==t)throw new Error("invalid chunk type:"+i.type);let o=new E(e,i.offset),s=o.readString(4);if(s!==n)throw new Error("invalid signature:"+s);return re(e,o.offset,i.size-4,r)}function $e(i,e){let t=q(i,e,"LIST","INFO");return U.parse(e,t)}function ze(i,e){let t=q(i,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function O(i,e,t,n,r,o){let s=[];if(i.type!==t)throw new Error("invalid chunk type:"+i.type);let a=new E(e,i.offset),c=i.offset+i.size;for(;a.offset<c;){let l=n.parse(a,o);if(r&&r(l))break;s.push(l)}return s}var Ze=(i,e)=>O(i,e,"phdr",G,t=>t.isEnd),Qe=(i,e)=>O(i,e,"pbag",B),_e=(i,e)=>O(i,e,"inst",j,t=>t.isEnd),Je=(i,e)=>O(i,e,"ibag",B),Xe=(i,e)=>O(i,e,"pmod",y),Ye=(i,e)=>O(i,e,"imod",y),et=(i,e)=>O(i,e,"pgen",R,t=>t.isEnd),tt=(i,e)=>O(i,e,"igen",R),nt=(i,e,t)=>O(i,e,"shdr",H,n=>n.isEnd,t);function rt(i,e,t,n,r){let o=new Array(i.length),s=r?1:2;for(let a=0;a<i.length;a++){let{start:c,end:l}=i[a],h=e+c*s,u=e+l*s;o[a]=n.subarray(h,u)}return o}var we=new Map;for(let i=0;i<k.length;i++)we.set(k[i],i);var st=["instrument","sampleID"],Pe=["keyRange","velRange"],xe=["keynum","velocity"],Te=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],ve=[...Te,...xe],ke=new Set;for(let i=0;i<ve.length;i++){let e=ve[i],t=we.get(e);t!==void 0&&ke.add(t)}function Ee(i){let e={},t=Object.keys(i);for(let n of t){let r=i[n];if(L(n))e[n]=r;else{let o=r;e[n]=o.clamp(o.defaultValue)}}return e}var Se=[["keynum","keyRange"],["velocity","velRange"]],ot=new Set(Pe);function L(i){return ot.has(i)}var at=new Set([...st,...Pe,...xe,...Te]);function it(){let i=[],e=k.length;for(let t=0;t<e;t++){let n=k[t];n!==void 0&&!at.has(n)&&i.push(n)}return i}var K=it(),ct=new Set(K);function oe(i){return ct.has(i)}function Fe(i){let e={};for(let t=0;t<i.length;t++){let n=i[t],r=n.type;if(r!==void 0&&!ke.has(n.code))if(L(r))e[r]=n.value;else{let o=r;e[o]=n.value}}return e}function Oe(i){let e={};for(let t=0;t<i.length;t++){let n=i[t],r=n.type;if(r!==void 0)if(L(r))e[r]=n.value;else{let o=r;e[o]=n.value}}for(let t=0;t<Se.length;t++){let[n,r]=Se[t],o=e[n];o!==void 0&&(e[r]=new M(o,o))}return e}var I=-32768,C=32767,W={startAddrsOffset:new p(0,0,C),endAddrsOffset:new p(I,0,0),startloopAddrsOffset:new p(I,0,C),endloopAddrsOffset:new p(I,0,C),startAddrsCoarseOffset:new p(0,0,C),modLfoToPitch:new p(-12e3,0,12e3),vibLfoToPitch:new p(-12e3,0,12e3),modEnvToPitch:new p(-12e3,0,12e3),initialFilterFc:new p(1500,13500,13500),initialFilterQ:new p(0,0,960),modLfoToFilterFc:new p(-12e3,0,12e3),modEnvToFilterFc:new p(-12e3,0,12e3),endAddrsCoarseOffset:new p(I,0,0),modLfoToVolume:new p(-960,0,960),chorusEffectsSend:new p(0,0,1e3),reverbEffectsSend:new p(0,0,1e3),pan:new p(-500,0,500),delayModLFO:new p(-12e3,-12e3,5e3),freqModLFO:new p(-16e3,0,4500),delayVibLFO:new p(-12e3,-12e3,5e3),freqVibLFO:new p(-16e3,0,4500),delayModEnv:new p(-12e3,-12e3,5e3),attackModEnv:new p(-12e3,-12e3,8e3),holdModEnv:new p(-12e3,-12e3,5e3),decayModEnv:new p(-12e3,-12e3,8e3),sustainModEnv:new p(0,0,1e3),releaseModEnv:new p(-12e3,-12e3,8e3),keynumToModEnvHold:new p(-1200,0,1200),keynumToModEnvDecay:new p(-1200,0,1200),delayVolEnv:new p(-12e3,-12e3,5e3),attackVolEnv:new p(-12e3,-12e3,8e3),holdVolEnv:new p(-12e3,-12e3,5e3),decayVolEnv:new p(-12e3,-12e3,8e3),sustainVolEnv:new p(0,0,1440),releaseVolEnv:new p(-12e3,-12e3,8e3),keynumToVolEnvHold:new p(-1200,0,1200),keynumToVolEnvDecay:new p(-1200,0,1200),instrument:new p(-1,-1,C),keyRange:new M(0,127),velRange:new M(0,127),startloopAddrsCoarseOffset:new p(I,0,C),keynum:new p(-1,-1,127),velocity:new p(-1,-1,127),initialAttenuation:new p(0,0,1440),endloopAddrsCoarseOffset:new p(I,0,C),coarseTune:new p(-120,0,120),fineTune:new p(-99,0,99),sampleID:new p(-1,-1,C),sampleModes:new p(0,0,3),scaleTuning:new p(0,100,100),exclusiveClass:new p(0,0,127),overridingRootKey:new p(-1,-1,127)};function T(i){return Math.pow(2,i/1200)}var $=class{constructor(e,t,n,r,o){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(s,a)=>{s.modLfoToPitch=this.clamp("modLfoToPitch",a)},vibLfoToPitch:(s,a)=>{s.vibLfoToPitch=this.clamp("vibLfoToPitch",a)},modEnvToPitch:(s,a)=>{s.modEnvToPitch=this.clamp("modEnvToPitch",a)},initialFilterFc:(s,a)=>{s.initialFilterFc=this.clamp("initialFilterFc",a)},initialFilterQ:(s,a)=>{s.initialFilterQ=this.clamp("initialFilterQ",a)},modLfoToFilterFc:(s,a)=>{s.modLfoToFilterFc=this.clamp("modLfoToFilterFc",a)},modEnvToFilterFc:(s,a)=>{s.modEnvToFilterFc=this.clamp("modEnvToFilterFc",a)},modLfoToVolume:(s,a)=>{s.modLfoToVolume=this.clamp("modLfoToVolume",a)},chorusEffectsSend:(s,a)=>{s.chorusEffectsSend=this.clamp("chorusEffectsSend",a)/1e3},reverbEffectsSend:(s,a)=>{s.reverbEffectsSend=this.clamp("reverbEffectsSend",a)/1e3},pan:(s,a)=>{s.pan=this.clamp("pan",a)/1e3},delayModLFO:(s,a)=>{s.delayModLFO=T(this.clamp("delayModLFO",a))},freqModLFO:(s,a)=>{s.freqModLFO=this.clamp("freqModLFO",a)},delayVibLFO:(s,a)=>{s.delayVibLFO=T(this.clamp("delayVibLFO",a))},freqVibLFO:(s,a)=>{s.freqVibLFO=this.clamp("freqVibLFO",a)},delayModEnv:(s,a)=>{s.modDelay=T(this.clamp("delayModEnv",a))},attackModEnv:(s,a)=>{s.modAttack=T(this.clamp("attackModEnv",a))},holdModEnv:(s,a)=>{let c=this.clamp("holdModEnv",a),l=this.clamp("keynumToModEnvHold",a);s.modHold=this.getModHold(c,l)},decayModEnv:(s,a)=>{let c=this.clamp("decayModEnv",a),l=this.clamp("keynumToModEnvDecay",a);s.modDecay=this.getModDecay(c,l)},sustainModEnv:(s,a)=>{s.modSustain=this.clamp("sustainModEnv",a)/1e3},releaseModEnv:(s,a)=>{s.modRelease=T(this.clamp("releaseModEnv",a))},keynumToModEnvHold:(s,a)=>{let c=this.clamp("holdModEnv",a),l=this.clamp("keynumToModEnvHold",a);s.modHold=this.getModHold(c,l)},keynumToModEnvDecay:(s,a)=>{let c=this.clamp("decayModEnv",a),l=this.clamp("keynumToModEnvDecay",a);s.modDecay=this.getModDecay(c,l)},delayVolEnv:(s,a)=>{s.volDelay=T(this.clamp("delayVolEnv",a))},attackVolEnv:(s,a)=>{s.volAttack=T(this.clamp("attackVolEnv",a))},holdVolEnv:(s,a)=>{let c=this.clamp("holdVolEnv",a),l=this.clamp("keynumToVolEnvHold",a);s.volHold=this.getVolHold(c,l)},decayVolEnv:(s,a)=>{let c=this.clamp("decayVolEnv",a),l=this.clamp("keynumToVolEnvDecay",a);s.volDecay=this.getVolDecay(c,l)},sustainVolEnv:(s,a)=>{s.volSustain=this.clamp("sustainVolEnv",a)/1e3},releaseVolEnv:(s,a)=>{s.volRelease=T(this.clamp("releaseVolEnv",a))},keynumToVolEnvHold:(s,a)=>{let c=this.clamp("holdVolEnv",a),l=this.clamp("keynumToVolEnvHold",a);s.modHold=this.getVolHold(c,l)},keynumToVolEnvDecay:(s,a)=>{let c=this.clamp("decayVolEnv",a),l=this.clamp("keynumToVolEnvDecay",a);s.modDecay=this.getVolDecay(c,l)},initialAttenuation:(s,a)=>{s.initialAttenuation=this.clamp("initialAttenuation",a)},coarseTune:(s,a)=>{s.playbackRate=this.getPlaybackRate(a)},fineTune:(s,a)=>{s.playbackRate=this.getPlaybackRate(a)},scaleTuning:(s,a)=>{s.playbackRate=this.getPlaybackRate(a)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],n=t.sourceOper.controllerType,r=t.destinationOper,o=this.controllerToDestinations.get(n);o?o.add(t.destinationOper):this.controllerToDestinations.set(n,new Set([r]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],n=t.destinationOper,r=this.destinationToModulators.get(n);r?r.push(t):this.destinationToModulators.set(n,[t])}}getModHold(e,t){return T(e+(this.key-60)*t)}getModDecay(e,t){return T(e+(this.key-60)*t)}getVolHold(e,t){return T(e+(this.key-60)*t)}getVolDecay(e,t){return T(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("coarseTune",e),n=this.clamp("fineTune",e)/100,r=this.clamp("overridingRootKey",e),o=this.clamp("scaleTuning",e)/100,s=t+n,a=r===-1?this.sampleHeader.originalPitch:r,c=s+this.sampleHeader.pitchCorrection/100-a;return Math.pow(Math.pow(2,1/12),(this.key+c)*o)}transformParams(e,t){let n={},r=this.controllerToDestinations.get(e);if(!r)return n;for(let o of r){let s=k[o];if(!s||!oe(s))continue;let a=this.destinationToModulators.get(o);if(a){n[s]=this.generators[s];for(let c of a){let l=c.sourceOper,h=l.map(t[l.controllerType]),u=1,d=c.amountSourceOper;if(!(d.cc===0&&d.index===0)){let m=t[d.controllerType];u=d.map(m)}let f=c.transform(h*u);Number.isNaN(f)||(n[s]+=f)}}}return n}transformAllParams(e){let t=structuredClone(this.generators);for(let n of this.modulators){let r=n.sourceOper.controllerType,o=e[r];if(!o)continue;let s=k[n.destinationOper];if(!s||!oe(s))continue;let c=n.sourceOper.map(o),l=1,h=n.amountSourceOper;if(!(h.cc===0&&h.index===0)){let d=e[h.controllerType];l=h.map(d)}let u=n.transform(c*l);Number.isNaN(u)||(t[s]+=u)}return t}clamp(e,t){return W[e].clamp(t[e])}getParams(e,t){let n={},r=structuredClone(this.generators),o=this.transformParams(e,t),s=Object.keys(o);for(let a of s)r[a]=o[a];for(let a of s)this.voiceHandlers[a](n,r);return n}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},n=this.transformAllParams(e);for(let r=0;r<K.length;r++){let o=K[r];this.voiceHandlers[o](t,n)}return t}};var Ve=[new y(b.parse(1282),48,960,b.parse(0),0),new y(b.parse(258),8,-2400,b.parse(0),0),new y(b.parse(13),6,50,b.parse(0),0),new y(b.parse(129),6,50,b.parse(0),0),new y(b.parse(1415),48,960,b.parse(0),0),new y(b.parse(650),48,1,b.parse(0),0),new y(b.parse(1419),48,960,b.parse(0),0),new y(b.parse(219),16,.2,b.parse(0),0),new y(b.parse(221),15,.2,b.parse(0),0),new y(b.parse(526),51,127,b.parse(16),0)];var z=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},Z=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},Q=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,n,r){let o=new Array(r-n);for(let s=n;s<r;s++){let a=t[s].generatorIndex,c=t[s+1].generatorIndex;o[s-n]=e.slice(a,c)}return o}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],n=this.parsed.presetHeaders[e+1],r=n?n.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,r)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],n=this.parsed.instruments[e+1],r=n?n.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,r)}getModulators(e,t,n,r){let o=new Array(r-n);for(let s=n;s<r;s++){let a=t[s].modulatorIndex,c=t[s+1].modulatorIndex;o[s-n]=e.slice(a,c)}return o}getPresetModulators(e){let t=this.parsed.presetHeaders[e],n=this.parsed.presetHeaders[e+1],r=n?n.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,r)}getInstrumentModulators(e){let t=this.parsed.instruments[e],n=this.parsed.instruments[e+1],r=n?n.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,r)}findInstrumentZone(e,t,n){let r=this.getInstrumentGenerators(e),o=this.getInstrumentModulators(e),s,a=[];for(let c=0;c<r.length;c++){let l=Oe(r[c]);if(l.sampleID===void 0){s=l,a=o[c];continue}if(!(l.keyRange&&!l.keyRange.in(t))&&!(l.velRange&&!l.velRange.in(n)))if(s){let h={...s,...l},u=[...a,...o[c]];return new z(h,u)}else return new z(l,o[c])}}findInstrument(e,t,n){let r=this.getPresetGenerators(e),o=this.getPresetModulators(e),s,a=[];for(let c=0;c<r.length;c++){let l=Fe(r[c]);if(l.instrument===void 0){s=l,a=o[c];continue}if(l.keyRange&&!l.keyRange.in(t)||l.velRange&&!l.velRange.in(n))continue;let h=this.findInstrumentZone(l.instrument,t,n);if(h)if(s){let u={...s,...l},d=[...a,...o[c]],f=new Z(u,d);return this.createVoice(t,f,h)}else{let u=new Z(l,o[c]);return this.createVoice(t,u,h)}}return null}createVoice(e,t,n){let r=Ee(W);Object.assign(r,n.generators);let o=Object.keys(t.generators);for(let h=0;h<o.length;h++){let u=o[h];L(u)||(r[u]+=t.generators[u])}let s=[...Ve,...t.modulators,...n.modulators],a=r.sampleID,c=this.parsed.samples[a],l=this.parsed.sampleHeaders[a];return new $(e,r,s,c,l)}getVoice(e,t,n,r){let o=this.parsed.presetHeaders.findIndex(a=>a.preset===t&&a.bank===e);if(o<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let s=this.findInstrument(o,n,r);return s||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let n=0;n<t.length;n++){let r=t[n];e[r.bank]||(e[r.bank]={}),e[r.bank][r.preset]=r.presetName}return e}};var ae=class{index=-1;ending=!1;bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;volumeNode;gainL;gainR;modulationLFO;modulationDepth;vibratoLFO;vibratoDepth;reverbEffectsSend;chorusEffectsSend;portamentoNoteNumber=-1;constructor(e,t,n,r,o){this.noteNumber=e,this.velocity=t,this.startTime=n,this.voice=r,this.voiceParams=o}},A=new Array(57),lt=10,v=new Uint8Array(128);v[42]=1;v[44]=1;v[46]=1;v[71]=2;v[72]=2;v[73]=3;v[74]=3;v[78]=4;v[79]=4;v[80]=5;v[81]=5;v[29]=6;v[30]=6;v[86]=7;v[87]=7;A[0]=v;var J=new Uint8Array(128);J[42]=8;J[44]=8;J[46]=8;A[25]=J;var X=new Uint8Array(128);X[27]=9;X[28]=9;X[29]=9;A[48]=X;var ue=new Uint8Array(128);ue[41]=10;ue[42]=10;A[56]=ue;var _={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},channelPressure:{type:13,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepth:{type:129,defaultValue:0},portamentoTime:{type:133,defaultValue:0},volume:{type:135,defaultValue:100/127},pan:{type:138,defaultValue:64/127},expression:{type:139,defaultValue:1},sustainPedal:{type:192,defaultValue:0},portamento:{type:193,defaultValue:0},sostenutoPedal:{type:194,defaultValue:0},softPedal:{type:195,defaultValue:0},reverbSendLevel:{type:219,defaultValue:0},chorusSendLevel:{type:221,defaultValue:0}},ie=class{array=new Float32Array(256);constructor(){let e=Object.entries(_);for(let[t,{type:n,defaultValue:r}]of e)this.array[n]=r,Object.defineProperty(this,t,{get:()=>this.array[n],set:o=>this.array[n]=o,enumerable:!0,configurable:!0})}},ce=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain","modRelease","playbackRate"],ut=new Set(ce),le=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],ht=new Set(le),Ce=class{mode="GM2";masterFineTuning=0;masterCoarseTuning=0;reverb={time:this.getReverbTime(64),feedback:.8};chorus={modRate:this.getChorusModRate(3),modDepth:this.getChorusModDepth(19),feedback:this.getChorusFeedback(8),sendToReverb:this.getChorusSendToReverb(0),delayTimes:this.generateDistributedArray(.02,2,.5)};numChannels=16;ticksPerBeat=120;totalTime=0;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=this.initSoundFontTable();audioBufferCounter=new Map;audioBufferCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;timeline=[];instruments=[];notePromises=[];exclusiveClassNotes=new Array(128);drumExclusiveClassNotes=new Array(this.numChannels*lt);static channelSettings={detune:0,programNumber:0,bank:15488,bankMSB:121,bankLSB:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,mono:!1,modulationDepthRange:50,fineTuning:0,coarseTuning:0};defaultOptions={reverbAlgorithm:e=>{let{time:t,feedback:n}=this.reverb,r=this.generateDistributedArray(n,4),o=r.map(c=>this.calcDelay(t,c)),s=this.generateDistributedArray(n,4),a=s.map(c=>this.calcDelay(t,c));return this.createSchroederReverb(e,r,o,s,a)}};constructor(e,t=this.defaultOptions){this.audioContext=e,this.options={...this.defaultOptions,...t},this.masterVolume=new GainNode(e),this.scheduler=new GainNode(e,{gain:0}),this.schedulerBuffer=new AudioBuffer({length:1,sampleRate:e.sampleRate}),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.reverbEffect=this.options.reverbAlgorithm(e),this.chorusEffect=this.createChorusEffect(e),this.chorusEffect.output.connect(this.masterVolume),this.reverbEffect.output.connect(this.masterVolume),this.masterVolume.connect(e.destination),this.scheduler.connect(e.destination),this.GM2SystemOn()}initSoundFontTable(){let e=new Array(128);for(let t=0;t<128;t++)e[t]=new Map;return e}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let n=e.parsed.presetHeaders;for(let r=0;r<n.length;r++){let o=n[r];o.presetName.startsWith("\0")||this.soundFontTable[o.preset].set(o.bank,t)}}async loadSoundFont(e){let t;if(typeof e=="string"){let s=await(await fetch(e)).arrayBuffer();t=new Uint8Array(s)}else if(e instanceof Uint8Array)t=e;else throw new TypeError("input must be a URL string or Uint8Array");let n=ye(t),r=new Q(n);this.addSoundFont(r)}async loadMIDI(e){let t;if(typeof e=="string"){let s=await(await fetch(e)).arrayBuffer();t=new Uint8Array(s)}else if(e instanceof Uint8Array)t=e;else throw new TypeError("input must be a URL string or Uint8Array");let n=(0,Me.parseMidi)(t);this.ticksPerBeat=n.header.ticksPerBeat;let r=this.extractMidiData(n);this.instruments=r.instruments,this.timeline=r.timeline,this.totalTime=this.calcTotalTime()}setChannelAudioNodes(e){let{gainLeft:t,gainRight:n}=this.panToGain(_.pan.defaultValue),r=new GainNode(e,{gain:t}),o=new GainNode(e,{gain:n}),s=new ChannelMergerNode(e,{numberOfInputs:2});return r.connect(s,0,0),o.connect(s,0,1),s.connect(this.masterVolume),{gainL:r,gainR:o,merger:s}}resetChannelTable(e){this.resetControlTable(e.controlTable),e.scaleOctaveTuningTable.fill(0),e.channelPressureTable.set([64,64,64,0,0,0]),e.polyphonicKeyPressureTable.set([64,64,64,0,0,0]),e.keyBasedInstrumentControlTable.fill(-1)}createChannels(e){return Array.from({length:this.numChannels},()=>({currentBufferSource:null,isDrum:!1,state:new ie,...this.constructor.channelSettings,...this.setChannelAudioNodes(e),scheduledNotes:[],sustainNotes:[],sostenutoNotes:[],controlTable:this.initControlTable(),scaleOctaveTuningTable:new Int8Array(12),channelPressureTable:new Uint8Array([64,64,64,0,0,0]),keyBasedInstrumentControlTable:new Int8Array(16384).fill(-1)}))}async createNoteBuffer(e,t){let n=e.start,r=e.sample.length+e.end;if(t){let o=e.sample,s=o.byteOffset+n,a=o.byteOffset+r,c=o.buffer.slice(s,a);return await this.audioContext.decodeAudioData(c)}else{let o=e.sample,s=o.byteOffset+n,a=o.byteOffset+r,c=o.buffer.slice(s,a),l=new AudioBuffer({numberOfChannels:1,length:o.length,sampleRate:e.sampleRate}),h=l.getChannelData(0),u=new Int16Array(c);for(let d=0;d<u.length;d++)h[d]=u[d]/32768;return l}}isLoopDrum(e,t){let n=e.programNumber;return n===48&&t===88||n===56&&47<=t&&t<=84}createBufferSource(e,t,n,r){let o=new AudioBufferSourceNode(this.audioContext);return o.buffer=r,o.loop=n.sampleModes%2!==0,e.isDrum&&(o.loop=this.isLoopDrum(e,t)),o.loop&&(o.loopStart=n.loopStart/n.sampleRate,o.loopEnd=n.loopEnd/n.sampleRate),o}async scheduleTimelineEvents(e,t,n){for(;n<this.timeline.length;){let r=this.timeline[n];if(r.startTime>e+this.lookAhead)break;let o=this.startDelay-t,s=r.startTime+o;switch(r.type){case"noteOn":await this.scheduleNoteOn(r.channel,r.noteNumber,r.velocity,s);break;case"noteOff":{let a=this.scheduleNoteOff(r.channel,r.noteNumber,r.velocity,s,!1);a&&this.notePromises.push(a);break}case"controller":this.handleControlChange(r.channel,r.controllerType,r.value,s);break;case"programChange":this.handleProgramChange(r.channel,r.programNumber,s);break;case"channelAftertouch":this.handleChannelPressure(r.channel,r.amount,s);break;case"pitchBend":this.setPitchBend(r.channel,r.value+8192,s);break;case"sysEx":this.handleSysEx(r.data,s)}n++}return n}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}playNotes(){return new Promise(e=>{this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime;this.notePromises=[];let r=async()=>{if(t>=this.timeline.length){await Promise.all(this.notePromises),this.notePromises=[],this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.audioBufferCache.clear();for(let a=0;a<this.channels.length;a++)this.resetAllStates(a);e();return}let o=this.audioContext.currentTime,s=o+n;if(t=await this.scheduleTimelineEvents(s,n,t),this.isPausing){await this.stopNotes(0,!0,o),this.notePromises=[],this.isPausing=!1,this.isPaused=!0,e();return}else if(this.isStopping){await this.stopNotes(0,!0,o),this.notePromises=[],this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.audioBufferCache.clear();for(let a=0;a<this.channels.length;a++)this.resetAllStates(a);this.isStopping=!1,this.isPaused=!1,e();return}else if(this.isSeeking)this.stopNotes(0,!0,o),this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.startTime=this.audioContext.currentTime,t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime,this.isSeeking=!1,await r();else{let a=o+this.noteCheckInterval;await this.scheduleTask(()=>{},a),await r()}};r()})}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}getAudioBufferId(e,t,n){return`${e}:${t}:${n}`}extractMidiData(e){this.audioBufferCounter.clear();let t=new Set,n=[],r=new Array(this.channels.length);for(let l=0;l<r.length;l++)r[l]={programNumber:-1,bankMSB:this.channels[l].bankMSB,bankLSB:this.channels[l].bankLSB};for(let l=0;l<e.tracks.length;l++){let h=e.tracks[l],u=0;for(let d=0;d<h.length;d++){let f=h[d];switch(u+=f.deltaTime,f.ticks=u,f.type){case"noteOn":{let m=r[f.channel],w=this.getAudioBufferId(m.programNumber,f.noteNumber,f.velocity);if(this.audioBufferCounter.set(w,(this.audioBufferCounter.get(w)??0)+1),m.programNumber<0){switch(m.programNumber=f.programNumber,m.bankMSB){case 120:t.add("128:0");break;case 121:t.add(`${m.bankLSB}:0`);break;default:{let V=m.bankMSB*128+m.bankLSB;t.add(`${V}:0`)}}m.programNumber=0}break}case"controller":switch(f.controllerType){case 0:r[f.channel].bankMSB=f.value;break;case 32:r[f.channel].bankLSB=f.value;break}break;case"programChange":{let m=r[f.channel];switch(m.programNumber=f.programNumber,m.bankMSB){case 120:t.add(`128:${m.programNumber}`);break;case 121:t.add(`${m.bankLSB}:${m.programNumber}`);break;default:{let w=m.bankMSB*128+m.bankLSB;t.add(`${w}:${m.programNumber}`)}}}}delete f.deltaTime,n.push(f)}}for(let[l,h]of this.audioBufferCounter)h===1&&this.audioBufferCounter.delete(l);let o={controller:0,sysEx:1,noteOff:2,noteOn:3};n.sort((l,h)=>l.ticks!==h.ticks?l.ticks-h.ticks:(o[l.type]||4)-(o[h.type]||4));let s=0,a=0,c=.5;for(let l=0;l<n.length;l++){let h=n[l],u=this.ticksToSecond(h.ticks-a,c);h.startTime=s+u,h.type==="setTempo"&&(s+=this.ticksToSecond(h.ticks-a,c),c=h.microsecondsPerBeat/1e6,a=h.ticks)}return{instruments:t,timeline:n}}stopActiveNotes(e,t,n,r){let o=this.channels[e],s=[];return this.processActiveNotes(o,r,a=>{let c=this.scheduleNoteOff(e,a.noteNumber,t,r,n);this.notePromises.push(c),s.push(c)}),Promise.all(s)}stopChannelNotes(e,t,n,r){let o=this.channels[e],s=[];return this.processScheduledNotes(o,a=>{let c=this.scheduleNoteOff(e,a.noteNumber,t,r,n);this.notePromises.push(c),s.push(c)}),o.scheduledNotes=[],Promise.all(s)}stopNotes(e,t,n){let r=[];for(let o=0;o<this.channels.length;o++)r.push(this.stopChannelNotes(o,e,t,n));return Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,await this.playNotes(),this.isPlaying=!1)}stop(){this.isPlaying&&(this.isStopping=!0)}pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}async resume(){this.isPaused&&(await this.playNotes(),this.isPlaying=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let n=this.timeline[t];e<n.startTime&&(e=n.startTime)}return e}currentTime(){let e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}processScheduledNotes(e,t){let n=e.scheduledNotes;for(let r=0;r<n.length;r++){let o=n[r];o&&(o.ending||t(o))}}processActiveNotes(e,t,n){let r=e.scheduledNotes;for(let o=0;o<r.length;o++){let s=r[o];s&&(s.ending||t<s.startTime||n(s))}}createConvolutionReverbImpulse(e,t,n){let r=e.sampleRate,o=r*t,s=new AudioBuffer({numberOfChannels:2,length:o,sampleRate:r}),a=Math.min(r*n,o);for(let c=0;c<s.numberOfChannels;c++){let l=s.getChannelData(c);for(let u=0;u<a;u++)l[u]=Math.random()*2-1;let h=1/(r*t);for(let u=a;u<o;u++){let d=Math.exp(-(u-a)*h);l[u]=(Math.random()*2-1)*d}}return s}createConvolutionReverb(e,t){let n=new GainNode(e),r=new ConvolverNode(e,{buffer:t});return n.connect(r),{input:n,output:r,convolverNode:r}}createCombFilter(e,t,n,r){let o=new DelayNode(e,{maxDelayTime:n,delayTime:n}),s=new GainNode(e,{gain:r});return t.connect(o),o.connect(s),s.connect(o),o}createAllpassFilter(e,t,n,r){let o=new DelayNode(e,{maxDelayTime:n,delayTime:n}),s=new GainNode(e,{gain:r}),a=new GainNode(e,{gain:1-r});return t.connect(o),o.connect(s),s.connect(o),o.connect(a),a}generateDistributedArray(e,t,n=.1,r=.05){let o=e*n,s=new Array(t);for(let a=0;a<t;a++){let c=a/(t-1||1),l=e-o+c*2*o;s[a]=l*(1-(Math.random()*2-1)*r)}return s}createSchroederReverb(e,t,n,r,o){let s=new GainNode(e),a=new GainNode(e);for(let h=0;h<n.length;h++)this.createCombFilter(e,s,n[h],t[h]).connect(a);let c=[];for(let h=0;h<o.length;h++){let u=this.createAllpassFilter(e,h===0?a:c.at(-1),o[h],r[h]);c.push(u)}let l=c.at(-1);return{input:s,output:l}}createChorusEffect(e){let t=new GainNode(e),n=new GainNode(e),r=new GainNode(e),o=new OscillatorNode(e,{frequency:this.chorus.modRate}),s=new GainNode(e,{gain:this.chorus.modDepth/2}),a=this.chorus.delayTimes,c=[],l=[];for(let h=0;h<a.length;h++){let u=a[h],d=new DelayNode(e,{maxDelayTime:.1,delayTime:u}),f=new GainNode(e,{gain:this.chorus.feedback});c.push(d),l.push(f),t.connect(d),s.connect(d.delayTime),d.connect(f),f.connect(d),d.connect(n)}return n.connect(r),o.connect(s),o.start(),{input:t,output:n,sendGain:r,lfo:o,lfoGain:s,delayNodes:c,feedbackGains:l}}cbToRatio(e){return Math.pow(10,e/200)}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=e.isDrum?0:this.masterCoarseTuning+this.masterFineTuning,n=e.coarseTuning+e.fineTuning,r=t+n,o=e.state.pitchWheel*2-1,s=e.state.pitchWheelSensitivity*12800,a=o*s,l=(e.channelPressureTable[0]-64)/37.5*e.state.channelPressure;return r+a+l}calcNoteDetune(e,t){return e.scaleOctaveTuningTable[t.noteNumber%12]}updateChannelDetune(e,t){this.processScheduledNotes(e,n=>{this.updateDetune(e,n,t)})}updateDetune(e,t,n){let r=this.calcNoteDetune(e,t),o=e.detune+r;if(.5<=e.state.portamento&&0<=t.portamentoNoteNumber){let s=t.startTime,a=(t.noteNumber-t.portamentoNoteNumber)*100,c=s+this.getPortamentoTime(e,t);t.bufferSource.detune.cancelScheduledValues(n).setValueAtTime(o-a,n).linearRampToValueAtTime(o,c)}else t.bufferSource.detune.cancelScheduledValues(n).setValueAtTime(o,n)}getPortamentoTime(e,t){let n=Math.abs(t.noteNumber-t.portamentoNoteNumber),r=Math.ceil(e.state.portamentoTime*127);return n/this.getPitchIncrementSpeed(r)/10}getPitchIncrementSpeed(e){let t=[[0,1e3],[6,100],[16,20],[32,10],[48,5],[64,2.5],[80,1],[96,.4],[112,.15],[127,.01]],n=new Array(t.length);for(let x=0;x<t.length;x++){let[D,he]=t[x];if(e===D)return he;n[x]=[D,Math.log(he)]}let r=0;for(let x=1;x<n.length;x++)if(e<=n[x][0]){r=x-1;break}let[o,s]=n[r],[a,c]=n[r+1],l=a-o,h=(e-o)/l,u,d;if(r===0)u=(c-s)/l;else{let[x,D]=n[r-1];u=(c-D)/(a-x)}if(r===n.length-2)d=(c-s)/l;else{let[x,D]=n[r+2];d=(D-s)/(x-o)}let f=h*h,m=f*h,w=2*m-3*f+1,V=m-2*f+h,N=-2*m+3*f,F=m-f,P=w*s+N*c+l*(V*u+F*d);return Math.exp(P)}setPortamentoVolumeEnvelope(e,t,n){let{voiceParams:r,startTime:o}=t,a=this.cbToRatio(-r.initialAttenuation)*(1+this.getAmplitudeControl(e))*(1-r.volSustain),h=o+r.volDelay+r.volAttack+r.volHold;t.volumeEnvelopeNode.gain.cancelScheduledValues(n).setValueAtTime(a,h)}setVolumeEnvelope(e,t,n){let{voiceParams:r,startTime:o}=t,s=this.cbToRatio(-r.initialAttenuation)*(1+this.getAmplitudeControl(e)),a=s*(1-r.volSustain),c=o+r.volDelay,l=c+r.volAttack,h=l+r.volHold,u=h+r.volDecay;t.volumeEnvelopeNode.gain.cancelScheduledValues(n).setValueAtTime(0,o).setValueAtTime(1e-6,c).exponentialRampToValueAtTime(s,l).setValueAtTime(s,h).linearRampToValueAtTime(a,u)}setPortamentoPitchEnvelope(e,t){let n=e.voiceParams.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(n,t)}setPitchEnvelope(e,t){let{voiceParams:n}=e,r=n.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(r,t);let o=n.modEnvToPitch;if(o===0)return;let a=this.rateToCent(r)+o,c=this.centToRate(a),l=e.startTime+n.modDelay,h=l+n.modAttack,u=h+n.modHold,d=u+n.modDecay;e.bufferSource.playbackRate.setValueAtTime(r,l).exponentialRampToValueAtTime(c,h).setValueAtTime(c,u).linearRampToValueAtTime(r,d)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setPortamentoFilterEnvelope(e,t,n){let{voiceParams:r,startTime:o}=t,s=this.getSoftPedalFactor(e,t),a=r.initialFilterFc+this.getFilterCutoffControl(e),c=this.centToHz(a)*s,l=this.centToHz(r.initialFilterFc+r.modEnvToFilterFc)*s,h=c+(l-c)*(1-r.modSustain),u=this.clampCutoffFrequency(c),d=this.clampCutoffFrequency(h),f=o+this.getPortamentoTime(e,t),m=o+r.modDelay;t.filterNode.frequency.cancelScheduledValues(n).setValueAtTime(u,o).setValueAtTime(u,m).linearRampToValueAtTime(d,f)}setFilterEnvelope(e,t,n){let{voiceParams:r,startTime:o}=t,s=this.getSoftPedalFactor(e,t),a=r.initialFilterFc+this.getFilterCutoffControl(e),c=this.centToHz(a)*s,l=this.centToHz(a+r.modEnvToFilterFc)*s,h=c+(l-c)*(1-r.modSustain),u=this.clampCutoffFrequency(c),d=this.clampCutoffFrequency(l),f=this.clampCutoffFrequency(h),m=o+r.modDelay,w=m+r.modAttack,V=w+r.modHold,N=V+r.modDecay;t.filterNode.frequency.cancelScheduledValues(n).setValueAtTime(u,o).setValueAtTime(u,m).exponentialRampToValueAtTime(d,w).setValueAtTime(d,V).linearRampToValueAtTime(f,N)}startModulation(e,t,n){let{voiceParams:r}=t;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(r.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:r.modLfoToFilterFc}),t.modulationDepth=new GainNode(this.audioContext),this.setModLfoToPitch(e,t,n),t.volumeDepth=new GainNode(this.audioContext),this.setModLfoToVolume(t,n),t.modulationLFO.start(t.startTime+r.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}startVibrato(e,t,n){let{voiceParams:r}=t,o=e.state;t.vibratoLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(r.freqVibLFO)*o.vibratoRate*2}),t.vibratoLFO.start(t.startTime+r.delayVibLFO*o.vibratoDelay*2),t.vibratoDepth=new GainNode(this.audioContext),this.setVibLfoToPitch(e,t,n),t.vibratoLFO.connect(t.vibratoDepth),t.vibratoDepth.connect(t.bufferSource.detune)}async getAudioBuffer(e,t,n,r,o){let s=this.getAudioBufferId(e,t,n),a=this.audioBufferCache.get(s);if(a)return a.counter+=1,a.maxCount<=a.counter&&this.audioBufferCache.delete(s),a.audioBuffer;{let c=this.audioBufferCounter.get(s)??0,l=await this.createNoteBuffer(r,o),h={audioBuffer:l,maxCount:c,counter:1};return this.audioBufferCache.set(s,h),l}}async createNote(e,t,n,r,o,s){let a=this.audioContext.currentTime,c=e.state,l=this.getControllerState(e,n,r),h=t.getAllParams(l),u=new ae(n,r,o,t,h),d=await this.getAudioBuffer(e.programNumber,n,r,h,s);u.bufferSource=this.createBufferSource(e,n,h,d),u.volumeNode=new GainNode(this.audioContext),u.gainL=new GainNode(this.audioContext),u.gainR=new GainNode(this.audioContext),u.volumeEnvelopeNode=new GainNode(this.audioContext),u.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:h.initialFilterQ/10});let f=e.scheduledNotes.at(-1);return f&&f.noteNumber!==n&&(u.portamentoNoteNumber=f.noteNumber),.5<=e.state.portamento&&0<=u.portamentoNoteNumber?(this.setPortamentoVolumeEnvelope(e,u,a),this.setPortamentoFilterEnvelope(e,u,a),this.setPortamentoPitchEnvelope(u,a)):(this.setVolumeEnvelope(e,u,a),this.setFilterEnvelope(e,u,a),this.setPitchEnvelope(u,a)),this.updateDetune(e,u,a),0<c.vibratoDepth&&this.startVibrato(e,u,a),0<c.modulationDepth&&this.startModulation(e,u,a),e.mono&&e.currentBufferSource&&(e.currentBufferSource.stop(o),e.currentBufferSource=u.bufferSource),u.bufferSource.connect(u.filterNode),u.filterNode.connect(u.volumeEnvelopeNode),u.volumeEnvelopeNode.connect(u.volumeNode),u.volumeNode.connect(u.gainL),u.volumeNode.connect(u.gainR),0<c.chorusSendLevel&&this.setChorusEffectsSend(e,u,0,a),0<c.reverbSendLevel&&this.setReverbEffectsSend(e,u,0,a),u.bufferSource.start(o),u}calcBank(e){switch(this.mode){case"GM1":return e.isDrum?128:0;case"GM2":return e.bankMSB===121?0:e.isDrum?128:e.bank;default:return e.bank}}handleExclusiveClass(e,t,n){let r=e.voiceParams.exclusiveClass;if(r===0)return;let o=this.exclusiveClassNotes[r];if(o){let[s,a]=o;s&&!s.ending&&this.scheduleNoteOff(a,s.noteNumber,0,n,!0)}this.exclusiveClassNotes[r]=[e,t]}handleDrumExclusiveClass(e,t,n){let r=this.channels[t];if(!r.isDrum)return;let o=A[r.programNumber];if(!o)return;let s=o[e.noteNumber];if(s===0)return;let a=(s-1)*this.channels.length+t,c=this.drumExclusiveClassNotes[a];c&&!c.ending&&this.scheduleNoteOff(t,c.noteNumber,0,n,!0),this.drumExclusiveClassNotes[a]=e}isDrumNoteOffException(e,t){if(!e.isDrum)return!1;let n=e.programNumber;return!(n===48&&t===88||n===56&&47<=t&&t<=84)}async scheduleNoteOn(e,t,n,r,o){let s=this.channels[e],a=this.calcBank(s,e),c=this.soundFontTable[s.programNumber].get(a);if(c===void 0)return;let l=this.soundFonts[c],h=l.getVoice(a,s.programNumber,t,n);if(!h)return;let u=l.parsed.info.version.major===3,d=await this.createNote(s,h,t,n,r,u);d.noteOffEvent=o,d.gainL.connect(s.gainL),d.gainR.connect(s.gainR),.5<=s.state.sustainPedal&&s.sustainNotes.push(d),this.handleExclusiveClass(d,e,r),this.handleDrumExclusiveClass(d,e,r);let f=s.scheduledNotes;d.index=f.length,f.push(d)}noteOn(e,t,n,r){return r??=this.audioContext.currentTime,this.scheduleNoteOn(e,t,n,r,void 0)}disconnectNote(e){e.bufferSource.disconnect(),e.filterNode.disconnect(),e.volumeEnvelopeNode.disconnect(),e.volumeNode.disconnect(),e.gainL.disconnect(),e.gainR.disconnect(),e.modulationDepth&&(e.volumeDepth.disconnect(),e.modulationDepth.disconnect(),e.modulationLFO.stop()),e.vibratoDepth&&(e.vibratoDepth.disconnect(),e.vibratoLFO.stop()),e.reverbEffectsSend&&e.reverbEffectsSend.disconnect(),e.chorusEffectsSend&&e.chorusEffectsSend.disconnect()}releaseNote(e,t,n){let r=n+t.voiceParams.volRelease,o=n+t.voiceParams.modRelease,s=Math.min(r,o);return t.filterNode.frequency.cancelScheduledValues(n).linearRampToValueAtTime(0,o),t.volumeEnvelopeNode.gain.cancelScheduledValues(n).linearRampToValueAtTime(0,r),new Promise(a=>{this.scheduleTask(()=>{let c=t.bufferSource;c.loop=!1,c.stop(s),this.disconnectNote(t),e.scheduledNotes[t.index]=void 0,a()},s)})}scheduleNoteOff(e,t,n,r,o){let s=this.channels[e],a=s.state;if(!o){if(s.isDrum){if(!this.isLoopDrum(s,t))return}else if(.5<=a.sustainPedal||.5<=a.sostenutoPedal)return}let c=this.findNoteOffTarget(s,t);c&&(c.ending=!0,this.releaseNote(s,c,r))}findNoteOffTarget(e,t){let n=e.scheduledNotes;for(let r=0;r<n.length;r++){let o=n[r];if(o&&!o.ending&&o.noteNumber===t)return o}}noteOff(e,t,n,r){return r??=this.audioContext.currentTime,this.scheduleNoteOff(e,t,n,r,!1)}releaseSustainPedal(e,t,n){let r=t*2,o=this.channels[e],s=[];for(let a=0;a<o.sustainNotes.length;a++){let c=this.scheduleNoteOff(e,o.sustainNotes[a].noteNumber,r,n);s.push(c)}return o.sustainNotes=[],s}releaseSostenutoPedal(e,t,n){let r=t*2,o=this.channels[e],s=[],a=o.sostenutoNotes;o.state.sostenutoPedal=0;for(let c=0;c<a.length;c++){let l=a[c],h=this.scheduleNoteOff(e,l.noteNumber,r,n);s.push(h)}return o.sostenutoNotes=[],s}handleMIDIMessage(e,t,n,r){let o=e&15,s=e&240;switch(s){case 128:return this.noteOff(o,t,n,r);case 144:return this.noteOn(o,t,n,r);case 176:return this.handleControlChange(o,t,n,r);case 192:return this.handleProgramChange(o,t,r);case 208:return this.handleChannelPressure(o,t,r);case 224:return this.handlePitchBendMessage(o,t,n,r);default:console.warn(`Unsupported MIDI message: ${s.toString(16)}`)}}handleProgramChange(e,t,n){let r=this.channels[e];if(r.bank=r.bankMSB*128+r.bankLSB,r.programNumber=t,this.mode==="GM2")switch(r.bankMSB){case 120:r.isDrum=!0;break;case 121:r.isDrum=!1;break}}handleChannelPressure(e,t,n){let r=this.channels[e];if(r.isDrum)return;let o=r.state.channelPressure,s=t/127;if(r.state.channelPressure=s,r.channelPressureTable[0]!==64){let c=(r.channelPressureTable[0]-64)/37.5;r.detune+=c*(s-o)}let a=r.channelPressureTable;this.processActiveNotes(r,n,c=>{this.setControllerParameters(r,c,a)}),this.applyVoiceParams(r,13)}handlePitchBendMessage(e,t,n,r){let o=n*128+t;this.setPitchBend(e,o,r)}setPitchBend(e,t,n){let r=this.channels[e];if(r.isDrum)return;n??=this.audioContext.currentTime;let o=r.state,s=o.pitchWheel*2-1,a=(t-8192)/8192;o.pitchWheel=t/16383,r.detune+=(a-s)*o.pitchWheelSensitivity*12800,this.updateChannelDetune(r,n),this.applyVoiceParams(r,14,n)}setModLfoToPitch(e,t,n){let r=t.voiceParams.modLfoToPitch+this.getLFOPitchDepth(e),s=(Math.abs(r)+e.state.modulationDepth)*Math.sign(r);t.modulationDepth.gain.cancelScheduledValues(n).setValueAtTime(s,n)}setVibLfoToPitch(e,t,n){let r=t.voiceParams.vibLfoToPitch,o=Math.abs(r)*e.state.vibratoDepth*2,s=0<r;t.vibratoDepth.gain.cancelScheduledValues(n).setValueAtTime(o*s,n)}setModLfoToFilterFc(e,t,n){let r=t.voiceParams.modLfoToFilterFc+this.getLFOFilterDepth(e);t.filterDepth.gain.cancelScheduledValues(n).setValueAtTime(r,n)}setModLfoToVolume(e,t,n){let r=t.voiceParams.modLfoToVolume,s=(this.cbToRatio(Math.abs(r))-1)*Math.sign(r)*(1+this.getLFOAmplitudeDepth(e));t.volumeDepth.gain.cancelScheduledValues(n).setValueAtTime(s,n)}setReverbEffectsSend(e,t,n,r){let o=this.getKeyBasedInstrumentControlValue(e,t.noteNumber,91),s=t.voiceParams.reverbEffectsSend;0<=o&&(s*=o/127/e.state.reverbSendLevel),0<n?0<s?t.reverbEffectsSend.gain.cancelScheduledValues(r).setValueAtTime(s,r):t.reverbEffectsSend.disconnect():0<s&&(t.reverbEffectsSend||(t.reverbEffectsSend=new GainNode(this.audioContext,{gain:s}),t.volumeNode.connect(t.reverbEffectsSend)),t.reverbEffectsSend.connect(this.reverbEffect.input))}setChorusEffectsSend(e,t,n,r){let o=this.getKeyBasedInstrumentControlValue(e,t.noteNumber,93),s=t.voiceParams.chorusEffectsSend;0<=o&&(s*=o/127/e.state.chorusSendLevel),0<n?0<vaule?t.chorusEffectsSend.gain.cancelScheduledValues(r).setValueAtTime(s,r):t.chorusEffectsSend.disconnect():0<s&&(t.chorusEffectsSend||(t.chorusEffectsSend=new GainNode(this.audioContext,{gain:s}),t.volumeNode.connect(t.chorusEffectsSend)),t.chorusEffectsSend.connect(this.chorusEffect.input))}setDelayModLFO(e,t){let n=e.startTime;n<t||(e.modulationLFO.stop(t),e.modulationLFO.start(n+e.voiceParams.delayModLFO),e.modulationLFO.connect(e.filterDepth))}setFreqModLFO(e,t){let n=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(n,t)}setFreqVibLFO(e,t,n){let r=t.voiceParams.freqVibLFO;t.vibratoLFO.frequency.cancelScheduledValues(n).setValueAtTime(r*e.state.vibratoRate*2,n)}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,n,r)=>{0<e.state.modulationDepth&&this.setModLfoToPitch(e,t,r)},vibLfoToPitch:(e,t,n,r)=>{0<e.state.vibratoDepth&&this.setVibLfoToPitch(e,t,r)},modLfoToFilterFc:(e,t,n,r)=>{0<e.state.modulationDepth&&this.setModLfoToFilterFc(e,t,r)},modLfoToVolume:(e,t,n,r)=>{0<e.state.modulationDepth&&this.setModLfoToVolume(e,t,r)},chorusEffectsSend:(e,t,n,r)=>{this.setChorusEffectsSend(e,t,n,r)},reverbEffectsSend:(e,t,n,r)=>{this.setReverbEffectsSend(e,t,n,r)},delayModLFO:(e,t,n,r)=>this.setDelayModLFO(t,r),freqModLFO:(e,t,n,r)=>this.setFreqModLFO(t,r),delayVibLFO:(e,t,n,r)=>{if(0<e.state.vibratoDepth){let o=e.state.vibratoDelay*2,s=t.startTime+n*o;if(r<s)return;let a=t.voiceParams.delayVibLFO,c=t.startTime+a*o;t.vibratoLFO.stop(r),t.vibratoLFO.start(c)}},freqVibLFO:(e,t,n,r)=>{0<e.state.vibratoDepth&&this.setFreqVibLFO(e,t,r)}}}getControllerState(e,t,n){let r=new Float32Array(e.state.array.length);return r.set(e.state.array),r[2]=n/127,r[3]=t/127,r[13]=r.channelPressure/127,r}applyVoiceParams(e,t,n){this.processScheduledNotes(e,r=>{let o=this.getControllerState(e,r.noteNumber,r.velocity),s=r.voice.getParams(t,o),a=!1,c=!1;for(let[l,h]of Object.entries(s)){let u=r.voiceParams[l];if(h!==u){if(r.voiceParams[l]=h,l in this.voiceParamsHandlers)this.voiceParamsHandlers[l](e,r,u,n);else if(ut.has(l)){if(a)continue;a=!0;let d=r.voiceParams;for(let f=0;f<ce.length;f++){let m=ce[f];m in s&&(d[m]=s[m])}.5<=e.state.portamento&&0<=r.portamentoNoteNumber?this.setPortamentoFilterEnvelope(e,r,n):this.setFilterEnvelope(e,r,n),this.setPitchEnvelope(r,n)}else if(ht.has(l)){if(c)continue;c=!0;let d=r.voiceParams;for(let f=0;f<le.length;f++){let m=le[f];m in s&&(d[m]=s[m])}this.setVolumeEnvelope(e,r,n)}}}})}createControlChangeHandlers(){let e=new Array(128);return e[0]=this.setBankMSB,e[1]=this.setModulationDepth,e[5]=this.setPortamentoTime,e[6]=this.dataEntryMSB,e[7]=this.setVolume,e[10]=this.setPan,e[11]=this.setExpression,e[32]=this.setBankLSB,e[38]=this.dataEntryLSB,e[64]=this.setSustainPedal,e[65]=this.setPortamento,e[66]=this.setSostenutoPedal,e[67]=this.setSoftPedal,e[91]=this.setReverbSendLevel,e[93]=this.setChorusSendLevel,e[100]=this.setRPNLSB,e[101]=this.setRPNMSB,e[120]=this.allSoundOff,e[121]=this.resetAllControllers,e[123]=this.allNotesOff,e[124]=this.omniOff,e[125]=this.omniOn,e[126]=this.monoOn,e[127]=this.polyOn,e}handleControlChange(e,t,n,r){let o=this.controlChangeHandlers[t];if(o){o.call(this,e,n,r);let s=this.channels[e];this.applyVoiceParams(s,t+128,r),this.applyControlTable(s,t)}else console.warn(`Unsupported Control change: controllerType=${t} value=${n}`)}setBankMSB(e,t){this.channels[e].bankMSB=t}updateModulation(e,t){let n=e.state.modulationDepth*e.modulationDepthRange;this.processScheduledNotes(e,r=>{r.modulationDepth?r.modulationDepth.gain.setValueAtTime(n,t):(this.setPitchEnvelope(r,t),this.startModulation(e,r,t))})}setModulationDepth(e,t,n){let r=this.channels[e];r.isDrum||(n??=this.audioContext.currentTime,r.state.modulationDepth=t/127,this.updateModulation(r,n))}updatePortamento(e,t){this.processScheduledNotes(e,n=>{.5<=e.state.portamento?0<=n.portamentoNoteNumber&&(this.setPortamentoVolumeEnvelope(e,n,t),this.setPortamentoFilterEnvelope(e,n,t),this.setPortamentoPitchEnvelope(n,t),this.updateDetune(e,n,t)):0<=n.portamentoNoteNumber&&(this.setVolumeEnvelope(e,n,t),this.setFilterEnvelope(e,n,t),this.setPitchEnvelope(n,t),this.updateDetune(e,n,t))})}setPortamentoTime(e,t,n){let r=this.channels[e];n??=this.audioContext.currentTime,r.state.portamentoTime=t/127,!r.isDrum&&this.updatePortamento(r,n)}setKeyBasedVolume(e,t){this.processScheduledNotes(e,n=>{let r=this.getKeyBasedInstrumentControlValue(e,n.noteNumber,7);0<=r&&n.volumeNode.gain.cancelScheduledValues(t).setValueAtTime(r/127,t)})}setVolume(e,t,n){n??=this.audioContext.currentTime;let r=this.channels[e];r.state.volume=t/127,this.updateChannelVolume(r,n),this.setKeyBasedVolume(r,n)}panToGain(e){let t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setKeyBasedPan(e,t){this.processScheduledNotes(e,n=>{let r=this.getKeyBasedInstrumentControlValue(e,n.noteNumber,10);if(0<=r){let{gainLeft:o,gainRight:s}=this.panToGain(r/127);n.gainL.gain.cancelScheduledValues(t).setValueAtTime(o,t),n.gainR.gain.cancelScheduledValues(t).setValueAtTime(s,t)}})}setPan(e,t,n){n??=this.audioContext.currentTime;let r=this.channels[e];r.state.pan=t/127,this.updateChannelVolume(r,n),this.setKeyBasedPan(r,n)}setExpression(e,t,n){n??=this.audioContext.currentTime;let r=this.channels[e];r.state.expression=t/127,this.updateChannelVolume(r,n)}setBankLSB(e,t){this.channels[e].bankLSB=t}dataEntryLSB(e,t,n){this.channels[e].dataLSB=t,this.handleRPN(e,n)}updateChannelVolume(e,t){let n=e.state,r=n.volume*n.expression,{gainLeft:o,gainRight:s}=this.panToGain(n.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(r*o,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(r*s,t)}setSustainPedal(e,t,n){let r=this.channels[e];r.isDrum||(n??=this.audioContext.currentTime,r.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(r,o=>{r.sustainNotes.push(o)}):this.releaseSustainPedal(e,t,n))}setPortamento(e,t,n){let r=this.channels[e];r.isDrum||(n??=this.audioContext.currentTime,r.state.portamento=t/127,this.updatePortamento(r,n))}setSostenutoPedal(e,t,n){let r=this.channels[e];if(!r.isDrum)if(n??=this.audioContext.currentTime,r.state.sostenutoPedal=t/127,64<=t){let o=[];this.processActiveNotes(r,n,s=>{o.push(s)}),r.sostenutoNotes=o}else this.releaseSostenutoPedal(e,t,n)}getSoftPedalFactor(e,t){return 1-(.1+t.noteNumber/127*.2)*e.state.softPedal}setSoftPedal(e,t,n){let r=this.channels[e];if(r.isDrum)return;let o=r.state;n??=this.audioContext.currentTime,o.softPedal=t/127,this.processScheduledNotes(r,s=>{.5<=o.portamento&&0<=s.portamentoNoteNumber?(this.setPortamentoVolumeEnvelope(r,s,n),this.setPortamentoFilterEnvelope(r,s,n)):(this.setVolumeEnvelope(r,s,n),this.setFilterEnvelope(r,s,n))})}setReverbSendLevel(e,t,n){n??=this.audioContext.currentTime;let r=this.channels[e],o=r.state,s=this.reverbEffect;0<o.reverbSendLevel?0<t?(o.reverbSendLevel=t/127,s.input.gain.cancelScheduledValues(n).setValueAtTime(o.reverbSendLevel,n)):this.processScheduledNotes(r,a=>{if(a.voiceParams.reverbEffectsSend<=0)return!1;a.reverbEffectsSend&&a.reverbEffectsSend.disconnect()}):0<t&&(this.processScheduledNotes(r,a=>{this.setReverbEffectsSend(r,a,0,n)}),o.reverbSendLevel=t/127,s.input.gain.cancelScheduledValues(n).setValueAtTime(o.reverbSendLevel,n))}setChorusSendLevel(e,t,n){n??=this.audioContext.currentTime;let r=this.channels[e],o=r.state,s=this.chorusEffect;0<o.chorusSendLevel?0<t?(o.chorusSendLevel=t/127,s.input.gain.cancelScheduledValues(n).setValueAtTime(o.chorusSendLevel,n)):this.processScheduledNotes(r,a=>{if(a.voiceParams.chorusEffectsSend<=0)return!1;a.chorusEffectsSend&&a.chorusEffectsSend.disconnect()}):0<t&&(this.processScheduledNotes(r,a=>{this.setChorusEffectsSend(r,a,0,n)}),o.chorusSendLevel=t/127,s.input.gain.cancelScheduledValues(n).setValueAtTime(o.chorusSendLevel,n))}limitData(e,t,n,r,o){o<e.dataLSB?(e.dataMSB++,e.dataLSB=r):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=o),n<e.dataMSB?(e.dataMSB=n,e.dataLSB=o):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=r)}limitDataMSB(e,t,n){n<e.dataMSB?e.dataMSB=n:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e,t){let n=this.channels[e];switch(n.rpnMSB*128+n.rpnLSB){case 0:this.handlePitchBendRangeRPN(e,t);break;case 1:this.handleFineTuningRPN(e,t);break;case 2:this.handleCoarseTuningRPN(e,t);break;case 5:this.handleModulationDepthRangeRPN(e,t);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${n.rpnMSB} LSB=${n.rpnLSB}`)}}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,n){this.channels[e].dataMSB=t,this.handleRPN(e,n)}handlePitchBendRangeRPN(e,t){let n=this.channels[e];this.limitData(n,0,127,0,99);let r=n.dataMSB+n.dataLSB/100;this.setPitchBendRange(e,r,t)}setPitchBendRange(e,t,n){let r=this.channels[e];if(r.isDrum)return;n??=this.audioContext.currentTime;let o=r.state,s=o.pitchWheelSensitivity,a=t/128;o.pitchWheelSensitivity=a,r.detune+=(o.pitchWheel*2-1)*(a-s)*12800,this.updateChannelDetune(r,n),this.applyVoiceParams(r,16,n)}handleFineTuningRPN(e,t){let n=this.channels[e];this.limitData(n,0,127,0,127);let r=n.dataMSB*128+n.dataLSB;this.setFineTuning(e,r,t)}setFineTuning(e,t,n){let r=this.channels[e];if(r.isDrum)return;n??=this.audioContext.currentTime;let o=r.fineTuning,s=(t-8192)/8.192;r.fineTuning=s,r.detune+=s-o,this.updateChannelDetune(r,n)}handleCoarseTuningRPN(e,t){let n=this.channels[e];this.limitDataMSB(n,0,127);let r=n.dataMSB;this.setCoarseTuning(e,r,t)}setCoarseTuning(e,t,n){let r=this.channels[e];if(r.isDrum)return;n??=this.audioContext.currentTime;let o=r.coarseTuning,s=(t-64)*100;r.coarseTuning=s,r.detune+=s-o,this.updateChannelDetune(r,n)}handleModulationDepthRangeRPN(e,t){let n=this.channels[e];this.limitData(n,0,127,0,127);let r=(dataMSB+dataLSB/128)*100;this.setModulationDepthRange(e,r,t)}setModulationDepthRange(e,t,n){let r=this.channels[e];r.isDrum||(n??=this.audioContext.currentTime,r.modulationDepthRange=t,this.updateModulation(r,n))}allSoundOff(e,t,n){return n??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!0,n)}resetAllStates(e){let t=this.audioContext.currentTime,n=this.channels[e],r=n.state,o=Object.entries(_);for(let[s,{type:a,defaultValue:c}]of o)128<=a?this.handleControlChange(e,a-128,Math.ceil(c*127),t):r[s]=c;for(let s of Object.keys(this.constructor.channelSettings))n[s]=this.constructor.channelSettings[s];this.resetChannelTable(n),this.mode="GM2",this.masterFineTuning=0,this.masterCoarseTuning=0}resetAllControllers(e,t,n){let r=["channelPressure","pitchWheel","expression","modulationDepth","sustainPedal","portamento","sostenutoPedal","softPedal"],o=this.channels[e],s=o.state;for(let c=0;c<r.length;c++){let l=r[c],{type:h,defaultValue:u}=_[l];128<=h?this.handleControlChange(e,h-128,Math.ceil(u*127),n):s[l]=u}this.setPitchBend(e,8192,n);let a=["rpnMSB","rpnLSB"];for(let c=0;c<a.length;c++){let l=a[c];o[l]=this.constructor.channelSettings[l]}}allNotesOff(e,t,n){return n??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!1,n)}omniOff(e,t,n){this.allNotesOff(e,t,n)}omniOn(e,t,n){this.allNotesOff(e,t,n)}monoOn(e,t,n){let r=this.channels[e];this.allNotesOff(e,t,n),r.mono=!0}polyOn(e,t,n){let r=this.channels[e];this.allNotesOff(e,t,n),r.mono=!1}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 8:switch(e[3]){case 8:return this.handleScaleOctaveTuning1ByteFormatSysEx(e,!1,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:this.GM1SystemOn(t);break;case 2:break;case 3:this.GM2SystemOn(t);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(e){e??=this.audioContext.currentTime,this.mode="GM1";for(let t=0;t<this.channels.length;t++){this.allSoundOff(t,0,e);let n=this.channels[t];n.bankMSB=0,n.bankLSB=0,n.bank=0,n.isDrum=!1}this.channels[9].bankMSB=1,this.channels[9].bank=128,this.channels[9].isDrum=!0}GM2SystemOn(e){e??=this.audioContext.currentTime,this.mode="GM2";for(let t=0;t<this.channels.length;t++){this.allSoundOff(t,0,e);let n=this.channels[t];n.bankMSB=121,n.bankLSB=0,n.bank=15488,n.isDrum=!1}this.channels[9].bankMSB=120,this.channels[9].bank=15360,this.channels[9].isDrum=!0}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e,t);case 3:return this.handleMasterFineTuningSysEx(e,t);case 4:return this.handleMasterCoarseTuningSysEx(e,t);case 5:return this.handleGlobalParameterControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 9:switch(e[3]){case 1:return this.handlePressureSysEx(e,"channelPressureTable");case 3:return this.handleControlChangeSysEx(e);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;case 10:switch(e[3]){case 1:return this.handleKeyBasedInstrumentControlSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){let n=(e[5]*128+e[4])/16383;this.setMasterVolume(n,t)}setMasterVolume(e,t){t??=this.audioContext.currentTime,e<0&&1<e?console.error("Master Volume is out of range"):this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleMasterFineTuningSysEx(e,t){let n=e[5]*128+e[4];this.setMasterFineTuning(n,t)}setMasterFineTuning(e,t){let n=this.masterFineTuning,r=(e-8192)/8.192;this.masterFineTuning=r;let o=r-n;for(let s=0;s<this.channels.length;s++){let a=this.channels[s];a.isDrum||(a.detune+=o,this.updateChannelDetune(a,t))}}handleMasterCoarseTuningSysEx(e,t){let n=e[4];this.setMasterCoarseTuning(n,t)}setMasterCoarseTuning(e,t){let n=this.masterCoarseTuning,r=(e-64)*100;this.masterCoarseTuning=r;let o=r-n;for(let s=0;s<this.channels.length;s++){let a=this.channels[s];a.isDrum||(a.detune+=o,this.updateChannelDetune(a,t))}}handleGlobalParameterControlSysEx(e,t){if(e[7]===1)switch(e[8]){case 1:return this.handleReverbParameterSysEx(e);case 2:return this.handleChorusParameterSysEx(e,t);default:console.warn(`Unsupported Global Parameter Control Message: ${e}`)}else console.warn(`Unsupported Global Parameter Control Message: ${e}`)}handleReverbParameterSysEx(e){switch(e[9]){case 0:return this.setReverbType(e[10]);case 1:return this.setReverbTime(e[10])}}setReverbType(e){this.reverb.time=this.getReverbTimeFromType(e),this.reverb.feedback=e===8?.9:.8;let{audioContext:t,options:n}=this;this.reverbEffect=n.reverbAlgorithm(t)}getReverbTimeFromType(e){switch(e){case 0:return this.getReverbTime(44);case 1:return this.getReverbTime(50);case 2:return this.getReverbTime(56);case 3:return this.getReverbTime(64);case 4:return this.getReverbTime(64);case 8:return this.getReverbTime(50);default:console.warn(`Unsupported Reverb Time: ${e}`)}}setReverbTime(e){this.reverb.time=this.getReverbTime(e);let{audioContext:t,options:n}=this;this.reverbEffect=n.reverbAlgorithm(t)}getReverbTime(e){return Math.exp((e-40)*.025)}calcDelay(e,t){return-e*Math.log10(t)/3}handleChorusParameterSysEx(e,t){switch(e[9]){case 0:return this.setChorusType(e[10],t);case 1:return this.setChorusModRate(e[10],t);case 2:return this.setChorusModDepth(e[10],t);case 3:return this.setChorusFeedback(e[10],t);case 4:return this.setChorusSendToReverb(e[10],t)}}setChorusType(e,t){switch(e){case 0:return this.setChorusParameter(3,5,0,0,t);case 1:return this.setChorusParameter(9,19,5,0,t);case 2:return this.setChorusParameter(3,19,8,0,t);case 3:return this.setChorusParameter(9,16,16,0,t);case 4:return this.setChorusParameter(2,24,64,0,t);case 5:return this.setChorusParameter(1,5,112,0,t);default:console.warn(`Unsupported Chorus Type: ${e}`)}}setChorusParameter(e,t,n,r,o){this.setChorusModRate(e,o),this.setChorusModDepth(t,o),this.setChorusFeedback(n,o),this.setChorusSendToReverb(r,o)}setChorusModRate(e,t){let n=this.getChorusModRate(e);this.chorus.modRate=n,this.chorusEffect.lfo.frequency.setValueAtTime(n,t)}getChorusModRate(e){return e*.122}setChorusModDepth(e,t){let n=this.getChorusModDepth(e);this.chorus.modDepth=n,this.chorusEffect.lfoGain.gain.cancelScheduledValues(t).setValueAtTime(n/2,t)}getChorusModDepth(e){return(e+1)/3200}setChorusFeedback(e,t){let n=this.getChorusFeedback(e);this.chorus.feedback=n;let r=this.chorusEffect;for(let o=0;o<r.feedbackGains.length;o++)r.feedbackGains[o].gain.cancelScheduledValues(t).setValueAtTime(n,t)}getChorusFeedback(e){return e*.00763}setChorusSendToReverb(e,t){let n=this.getChorusSendToReverb(e),r=this.chorusEffect.sendGain;0<this.chorus.sendToReverb?(this.chorus.sendToReverb=n,0<n?r.gain.cancelScheduledValues(t).setValueAtTime(n,t):r.disconnect()):(this.chorus.sendToReverb=n,0<n&&(r.connect(this.reverbEffect.input),r.gain.cancelScheduledValues(t).setValueAtTime(n,t)))}getChorusSendToReverb(e){return e*.00787}getChannelBitmap(e){let t=new Array(this.channels.length).fill(!1),n=e[4]&3,r=e[5]&127,o=e[6]&127;for(let s=0;s<7;s++)o&1<<s&&(t[s]=!0);for(let s=0;s<7;s++)r&1<<s&&(t[s+7]=!0);for(let s=0;s<2;s++)n&1<<s&&(t[s+14]=!0);return t}handleScaleOctaveTuning1ByteFormatSysEx(e,t,n){if(e.length<19){console.error("Data length is too short");return}let r=this.getChannelBitmap(e);for(let o=0;o<r.length;o++){if(!r[o])continue;let s=this.channels[o];if(!s.isDrum){for(let a=0;a<12;a++){let c=e[a+7]-64;s.scaleOctaveTuningTable[a]=c}t&&this.updateChannelDetune(s,n)}}}getFilterCutoffControl(e){return(e.channelPressureTable[1]-64)*e.state.channelPressure*15}getAmplitudeControl(e){return e.channelPressureTable[2]*e.state.channelPressure/64}getLFOPitchDepth(e){return e.channelPressureTable[3]*e.state.channelPressure/127*600}getLFOFilterDepth(e){return e.channelPressureTable[4]*e.state.channelPressure/127*2400}getLFOAmplitudeDepth(e){return e.channelPressureTable[5]*e.state.channelPressure/127}setControllerParameters(e,t,n){n[0]!==64&&this.updateDetune(e,t),.5<=e.state.portamemento&&0<=t.portamentoNoteNumber?(n[1]!==64&&this.setPortamentoFilterEnvelope(e,t),n[2]!==64&&this.setPortamentoVolumeEnvelope(e,t)):(n[1]!==64&&this.setFilterEnvelope(e,t),n[2]!==64&&this.setVolumeEnvelope(e,t)),n[3]!==0&&this.setModLfoToPitch(e,t),n[4]!==0&&this.setModLfoToFilterFc(e,t),n[5]!==0&&this.setModLfoToVolume(e,t)}handlePressureSysEx(e,t){let n=e[4],r=this.channels[n];if(r.isDrum)return;let o=r[t];for(let s=5;s<e.length-1;s+=2){let a=e[s],c=e[s+1];o[a]=c}}initControlTable(){let n=new Uint8Array(768);return this.resetControlTable(n)}resetControlTable(e){let r=[64,64,64,0,0,0];for(let o=0;o<128;o++){let s=o*6;e.set(r,s)}return e}applyControlTable(e,t){let r=t*6,o=e.controlTable.subarray(r,r+6);this.processScheduledNotes(e,s=>{this.setControllerParameters(e,s,o)})}handleControlChangeSysEx(e){let t=e[4],n=this.channels[t];if(n.isDrum)return;let r=e[5],o=n.controlTable[r];for(let s=6;s<e.length-1;s+=2){let a=e[s],c=e[s+1];o[a]=c}}getKeyBasedInstrumentControlValue(e,t,n){let r=t*128+n;return e.keyBasedInstrumentControlTable[r]}handleKeyBasedInstrumentControlSysEx(e,t){let n=e[4],r=this.channels[n];if(r.isDrum)return;let o=e[5],s=r.keyBasedInstrumentControlTable;for(let a=6;a<e.length-1;a+=2){let c=e[a],l=e[a+1],h=o*128+c;s[h]=l}this.handleChannelPressure(n,r.state.channelPressure*127,t)}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(n=>{let r=new AudioBufferSourceNode(this.audioContext,{buffer:this.schedulerBuffer});r.connect(this.scheduler),r.onended=()=>{try{e()}finally{r.disconnect(),n()}},r.start(t)})}};export{Ce as MidyGM2};
