var Te=Object.create;var se=Object.defineProperty;var ke=Object.getOwnPropertyDescriptor;var Se=Object.getOwnPropertyNames;var Fe=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty;var $=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var Me=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Se(e))!Ee.call(o,s)&&s!==t&&se(o,s,{get:()=>e[s],enumerable:!(n=ke(e,s))||n.enumerable});return o};var Ve=(o,e,t)=>(t=o!=null?Te(Fe(o)):{},Me(e||!o||!o.__esModule?se(t,"default",{value:o,enumerable:!0}):t,o));var ae=$((at,oe)=>{function De(o){var e=new v(o),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var n=Ce(t.data),s=[],a=0;!e.eof()&&a<n.numTracks;a++){var r=e.readChunk();if(r.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+r.id+"'";var i=Ne(r.data);s.push(i)}return{header:n,tracks:s}}function Ce(o){var e=new v(o),t=e.readUInt16(),n=e.readUInt16(),s={format:t,numTracks:n},a=e.readUInt16();return a&32768?(s.framesPerSecond=256-(a>>8),s.ticksPerFrame=a&255):s.ticksPerBeat=a,s}function Ne(o){for(var e=new v(o),t=[];!e.eof();){var n=a();t.push(n)}return t;var s;function a(){var r={};r.deltaTime=e.readVarInt();var i=e.readUInt8();if((i&240)===240)if(i===255){r.meta=!0;var l=e.readUInt8(),u=e.readVarInt();switch(l){case 0:if(r.type="sequenceNumber",u!==2)throw"Expected length for sequenceNumber event is 2, got "+u;return r.number=e.readUInt16(),r;case 1:return r.type="text",r.text=e.readString(u),r;case 2:return r.type="copyrightNotice",r.text=e.readString(u),r;case 3:return r.type="trackName",r.text=e.readString(u),r;case 4:return r.type="instrumentName",r.text=e.readString(u),r;case 5:return r.type="lyrics",r.text=e.readString(u),r;case 6:return r.type="marker",r.text=e.readString(u),r;case 7:return r.type="cuePoint",r.text=e.readString(u),r;case 32:if(r.type="channelPrefix",u!=1)throw"Expected length for channelPrefix event is 1, got "+u;return r.channel=e.readUInt8(),r;case 33:if(r.type="portPrefix",u!=1)throw"Expected length for portPrefix event is 1, got "+u;return r.port=e.readUInt8(),r;case 47:if(r.type="endOfTrack",u!=0)throw"Expected length for endOfTrack event is 0, got "+u;return r;case 81:if(r.type="setTempo",u!=3)throw"Expected length for setTempo event is 3, got "+u;return r.microsecondsPerBeat=e.readUInt24(),r;case 84:if(r.type="smpteOffset",u!=5)throw"Expected length for smpteOffset event is 5, got "+u;var d=e.readUInt8(),c={0:24,32:25,64:29,96:30};return r.frameRate=c[d&96],r.hour=d&31,r.min=e.readUInt8(),r.sec=e.readUInt8(),r.frame=e.readUInt8(),r.subFrame=e.readUInt8(),r;case 88:if(r.type="timeSignature",u!=2&&u!=4)throw"Expected length for timeSignature event is 4 or 2, got "+u;return r.numerator=e.readUInt8(),r.denominator=1<<e.readUInt8(),u===4?(r.metronome=e.readUInt8(),r.thirtyseconds=e.readUInt8()):(r.metronome=36,r.thirtyseconds=8),r;case 89:if(r.type="keySignature",u!=2)throw"Expected length for keySignature event is 2, got "+u;return r.key=e.readInt8(),r.scale=e.readUInt8(),r;case 127:return r.type="sequencerSpecific",r.data=e.readBytes(u),r;default:return r.type="unknownMeta",r.data=e.readBytes(u),r.metatypeByte=l,r}}else if(i==240){r.type="sysEx";var u=e.readVarInt();return r.data=e.readBytes(u),r}else if(i==247){r.type="endSysEx";var u=e.readVarInt();return r.data=e.readBytes(u),r}else throw"Unrecognised MIDI event type byte: "+i;else{var h;if((i&128)===0){if(s===null)throw"Running status byte encountered before status byte";h=i,i=s,r.running=!0}else h=e.readUInt8(),s=i;var p=i>>4;switch(r.channel=i&15,p){case 8:return r.type="noteOff",r.noteNumber=h,r.velocity=e.readUInt8(),r;case 9:var m=e.readUInt8();return r.type=m===0?"noteOff":"noteOn",r.noteNumber=h,r.velocity=m,m===0&&(r.byte9=!0),r;case 10:return r.type="noteAftertouch",r.noteNumber=h,r.amount=e.readUInt8(),r;case 11:return r.type="controller",r.controllerType=h,r.value=e.readUInt8(),r;case 12:return r.type="programChange",r.programNumber=h,r;case 13:return r.type="channelAftertouch",r.amount=h,r;case 14:return r.type="pitchBend",r.value=h+(e.readUInt8()<<7)-8192,r;default:throw"Unrecognised MIDI event type: "+p}}}}function v(o){this.buffer=o,this.bufferLen=this.buffer.length,this.pos=0}v.prototype.eof=function(){return this.pos>=this.bufferLen};v.prototype.readUInt8=function(){var o=this.buffer[this.pos];return this.pos+=1,o};v.prototype.readInt8=function(){var o=this.readUInt8();return o&128?o-256:o};v.prototype.readUInt16=function(){var o=this.readUInt8(),e=this.readUInt8();return(o<<8)+e};v.prototype.readInt16=function(){var o=this.readUInt16();return o&32768?o-65536:o};v.prototype.readUInt24=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(o<<16)+(e<<8)+t};v.prototype.readInt24=function(){var o=this.readUInt24();return o&8388608?o-16777216:o};v.prototype.readUInt32=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8();return(o<<24)+(e<<16)+(t<<8)+n};v.prototype.readBytes=function(o){var e=this.buffer.slice(this.pos,this.pos+o);return this.pos+=o,e};v.prototype.readString=function(o){var e=this.readBytes(o);return String.fromCharCode.apply(null,e)};v.prototype.readVarInt=function(){for(var o=0;!this.eof();){var e=this.readUInt8();if(e&128)o+=e&127,o<<=7;else return o+e}return o};v.prototype.readChunk=function(){var o=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:o,length:e,data:t}};oe.exports=De});var le=$((it,ie)=>{function Ue(o,e){if(typeof o!="object")throw"Invalid MIDI data";e=e||{};var t=o.header||{},n=o.tracks||[],s,a=n.length,r=new b;for(Be(r,t,a),s=0;s<a;s++)Re(r,n[s],e);return r.buffer}function Be(o,e,t){var n=e.format==null?1:e.format,s=128;e.timeDivision?s=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?s=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(s=e.ticksPerBeat&32767);var a=new b;a.writeUInt16(n),a.writeUInt16(t),a.writeUInt16(s),o.writeChunk("MThd",a.buffer)}function Re(o,e,t){var n=new b,s,a=e.length,r=null;for(s=0;s<a;s++)(t.running===!1||!t.running&&!e[s].running)&&(r=null),r=Ae(n,e[s],r,t.useByte9ForNoteOff);o.writeChunk("MTrk",n.buffer)}function Ae(o,e,t,n){var s=e.type,a=e.deltaTime,r=e.text||"",i=e.data||[],l=null;switch(o.writeVarInt(a),s){case"sequenceNumber":o.writeUInt8(255),o.writeUInt8(0),o.writeVarInt(2),o.writeUInt16(e.number);break;case"text":o.writeUInt8(255),o.writeUInt8(1),o.writeVarInt(r.length),o.writeString(r);break;case"copyrightNotice":o.writeUInt8(255),o.writeUInt8(2),o.writeVarInt(r.length),o.writeString(r);break;case"trackName":o.writeUInt8(255),o.writeUInt8(3),o.writeVarInt(r.length),o.writeString(r);break;case"instrumentName":o.writeUInt8(255),o.writeUInt8(4),o.writeVarInt(r.length),o.writeString(r);break;case"lyrics":o.writeUInt8(255),o.writeUInt8(5),o.writeVarInt(r.length),o.writeString(r);break;case"marker":o.writeUInt8(255),o.writeUInt8(6),o.writeVarInt(r.length),o.writeString(r);break;case"cuePoint":o.writeUInt8(255),o.writeUInt8(7),o.writeVarInt(r.length),o.writeString(r);break;case"channelPrefix":o.writeUInt8(255),o.writeUInt8(32),o.writeVarInt(1),o.writeUInt8(e.channel);break;case"portPrefix":o.writeUInt8(255),o.writeUInt8(33),o.writeVarInt(1),o.writeUInt8(e.port);break;case"endOfTrack":o.writeUInt8(255),o.writeUInt8(47),o.writeVarInt(0);break;case"setTempo":o.writeUInt8(255),o.writeUInt8(81),o.writeVarInt(3),o.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":o.writeUInt8(255),o.writeUInt8(84),o.writeVarInt(5);var u={24:0,25:32,29:64,30:96},d=e.hour&31|u[e.frameRate];o.writeUInt8(d),o.writeUInt8(e.min),o.writeUInt8(e.sec),o.writeUInt8(e.frame),o.writeUInt8(e.subFrame);break;case"timeSignature":o.writeUInt8(255),o.writeUInt8(88),o.writeVarInt(4),o.writeUInt8(e.numerator);var c=Math.floor(Math.log(e.denominator)/Math.LN2)&255;o.writeUInt8(c),o.writeUInt8(e.metronome),o.writeUInt8(e.thirtyseconds||8);break;case"keySignature":o.writeUInt8(255),o.writeUInt8(89),o.writeVarInt(2),o.writeInt8(e.key),o.writeUInt8(e.scale);break;case"sequencerSpecific":o.writeUInt8(255),o.writeUInt8(127),o.writeVarInt(i.length),o.writeBytes(i);break;case"unknownMeta":e.metatypeByte!=null&&(o.writeUInt8(255),o.writeUInt8(e.metatypeByte),o.writeVarInt(i.length),o.writeBytes(i));break;case"sysEx":o.writeUInt8(240),o.writeVarInt(i.length),o.writeBytes(i);break;case"endSysEx":o.writeUInt8(247),o.writeVarInt(i.length),o.writeBytes(i);break;case"noteOff":var h=n!==!1&&e.byte9||n&&e.velocity==0?144:128;l=h|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteOn":l=144|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteAftertouch":l=160|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.noteNumber),o.writeUInt8(e.amount);break;case"controller":l=176|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.controllerType),o.writeUInt8(e.value);break;case"programChange":l=192|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.programNumber);break;case"channelAftertouch":l=208|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.amount);break;case"pitchBend":l=224|e.channel,l!==t&&o.writeUInt8(l);var p=8192+e.value,m=p&127,w=p>>7&127;o.writeUInt8(m),o.writeUInt8(w);break;default:throw"Unrecognized event type: "+s}return l}function b(){this.buffer=[]}b.prototype.writeUInt8=function(o){this.buffer.push(o&255)};b.prototype.writeInt8=b.prototype.writeUInt8;b.prototype.writeUInt16=function(o){var e=o>>8&255,t=o&255;this.writeUInt8(e),this.writeUInt8(t)};b.prototype.writeInt16=b.prototype.writeUInt16;b.prototype.writeUInt24=function(o){var e=o>>16&255,t=o>>8&255,n=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n)};b.prototype.writeInt24=b.prototype.writeUInt24;b.prototype.writeUInt32=function(o){var e=o>>24&255,t=o>>16&255,n=o>>8&255,s=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(s)};b.prototype.writeInt32=b.prototype.writeUInt32;b.prototype.writeBytes=function(o){this.buffer=this.buffer.concat(Array.prototype.slice.call(o,0))};b.prototype.writeString=function(o){var e,t=o.length,n=[];for(e=0;e<t;e++)n.push(o.codePointAt(e));this.writeBytes(n)};b.prototype.writeVarInt=function(o){if(o<0)throw"Cannot write negative variable-length integer";if(o<=127)this.writeUInt8(o);else{var e=o,t=[];for(t.push(e&127),e>>=7;e;){var n=e&127|128;t.push(n),e>>=7}this.writeBytes(t.reverse())}};b.prototype.writeChunk=function(o,e){this.writeString(o),this.writeUInt32(e.length),this.writeBytes(e)};ie.exports=Ue});var ue=$(Z=>{Z.parseMidi=ae();Z.writeMidi=le()});var Pe=Ve(ue());var T=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,n=t+e,s=this.data;this.offset=n;let a=n;for(let l=t+1;l<n;l++)if(s[l]===0){a=l;break}let r=a-t,i=new Array(r);for(let l=0;l<r;l++)i[l]=s[t+l];return String.fromCharCode(...i)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function Q(o,e,t){let n=new T(o,e),s=n.readString(4),a=n.readDWORD(t);return new z(s,a,n.offset)}function J(o,e=0,t,{padding:n=!0,bigEndian:s=!1}={}){let a=[],r=t+e,i=e;for(;i<r;){let l=Q(o,i,s);i=l.offset+l.size,n&&(i-e&1)===1&&i++,a.push(l)}return a}var z=class{constructor(e,t,n){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:n})}};var O=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var y=class o{constructor(e,t,n,s,a){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:a})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,n=e&127,s=e>>7&1,a=e>>8&1,r=e>>9&1;return new o(t,r,a,s,n)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var X=class o{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),n=e.readInt8();return new o(t,n)}},U=class o{constructor(e,t,n,s,a,r,i,l,u,d,c){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:d}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:c})}static parse(e,t){function n(F){for(let P=0;P<t.length;P++)if(t[P].type===F)return t[P]}function s(F){return new T(e,F.offset)}function a(F){let P=n(F);return P?s(P).readString(P.size):null}function r(F){let P=n(F);return P?X.parse(s(P)):null}let i=a("ICMT"),l=a("ICOP"),u=a("ICRD"),d=a("IENG"),c=a("INAM"),h=a("IPRD"),p=a("ISFT"),m=r("ifil"),w=a("isng"),M=a("irom"),Oe=r("iver");return new o(i,l,u,d,c,h,p,m,w,M,Oe)}},D=class o{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),n=e.readWORD();return new o(t,n)}},B=class o{constructor(e,t,n,s,a,r,i){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:i})}get isEnd(){return this.presetName==="EOP"}static parse(e){let t=e.readString(20),n=e.readWORD(),s=e.readWORD(),a=e.readWORD(),r=e.readDWORD(),i=e.readDWORD(),l=e.readDWORD();return new o(t,n,s,a,r,i,l)}},E=class o{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),n=e.readByte();return new o(t,n)}},g=class o{constructor(e,t,n,s,a){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:a})}transform(e){let t=this.value*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),n=e.readWORD(),s=e.readInt16(),a=e.readWORD(),r=e.readWORD(),i=y.parse(t),l=y.parse(a);return new o(i,n,s,l,r)}},C=class o{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return O[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),n=O[t],s;switch(n){case"keyRange":case"velRange":s=E.parse(e);break;default:s=e.readInt16();break}return new o(t,s)}},R=class o{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new o;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},A=class o{constructor(e,t,n,s,a,r,i,l,u,d){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:d})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let n=e.readString(20),s=e.readDWORD(),a=e.readDWORD(),r=e.readDWORD(),i=e.readDWORD(),l=e.readDWORD(),u=e.readByte(),d=e.readInt8(),c=e.readWORD(),h=e.readWORD();return t||(r-=s,i-=s),new o(n,s,a,r,i,l,u,d,c,h)}};var f=class{constructor(e,t,n){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=n}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};function ce(o,e={}){let t=J(o,0,o.length,e);if(t.length!==1)throw new Error("wrong chunk length");let n=t[0];if(n===null)throw new Error("chunk not found");function s(l,u,d={}){let c=L(l,u,"RIFF","sfbk",d);if(c.length!==3)throw new Error("invalid sfbk structure");let h=Le(c[0],u),p=h.version.major===3;return p&&c[2].type!=="LIST"&&(c[2]=Q(u,c[2].offset-9,!1)),{info:h,samplingData:je(c[1],u),...a(c[2],u,p)}}function a(l,u,d){let c=L(l,u,"LIST","pdta");if(c.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:He(c[0],u),presetZone:Ge(c[1],u),presetModulators:Ke(c[2],u),presetGenerators:$e(c[3],u),instruments:qe(c[4],u),instrumentZone:We(c[5],u),instrumentModulators:_e(c[6],u),instrumentGenerators:Ze(c[7],u),sampleHeaders:ze(c[8],u,d)}}let r=s(n,o,e),i=r.info.version.major===3;return{...r,samples:Qe(r.sampleHeaders,r.samplingData.offsetMSB,r.samplingData.offsetLSB,o,i)}}function L(o,e,t,n,s={}){if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let a=new T(e,o.offset),r=a.readString(4);if(r!==n)throw new Error("invalid signature:"+r);return J(e,a.offset,o.size-4,s)}function Le(o,e){let t=L(o,e,"LIST","INFO");return U.parse(e,t)}function je(o,e){let t=L(o,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function k(o,e,t,n,s,a){let r=[];if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let i=new T(e,o.offset),l=o.offset+o.size;for(;i.offset<l;){let u=n.parse(i,a);if(s&&s(u))break;r.push(u)}return r}var He=(o,e)=>k(o,e,"phdr",B,t=>t.isEnd),Ge=(o,e)=>k(o,e,"pbag",D),qe=(o,e)=>k(o,e,"inst",R,t=>t.isEnd),We=(o,e)=>k(o,e,"ibag",D),Ke=(o,e)=>k(o,e,"pmod",g),_e=(o,e)=>k(o,e,"imod",g),$e=(o,e)=>k(o,e,"pgen",C,t=>t.isEnd),Ze=(o,e)=>k(o,e,"igen",C),ze=(o,e,t)=>k(o,e,"shdr",A,n=>n.isEnd,t);function Qe(o,e,t,n,s){let a=new Array(o.length),r=s?1:2;for(let i=0;i<o.length;i++){let{start:l,end:u}=o[i],d=e+l*r,c=e+u*r;a[i]=n.subarray(d,c)}return a}var fe=new Map;for(let o=0;o<O.length;o++)fe.set(O[o],o);var Je=["instrument","sampleID"],pe=["keyRange","velRange"],me=["keynum","velocity"],ye=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],de=[...ye,...me],be=new Set;for(let o=0;o<de.length;o++){let e=de[o],t=fe.get(e);t!==void 0&&be.add(t)}function ge(o){let e={},t=Object.keys(o);for(let n of t){let s=o[n];if(N(n))e[n]=s;else{let a=s;e[n]=a.clamp(a.defaultValue)}}return e}var he=[["keynum","keyRange"],["velocity","velRange"]],Xe=new Set(pe);function N(o){return Xe.has(o)}var Ye=new Set([...Je,...pe,...me,...ye]);function et(){let o=[],e=O.length;for(let t=0;t<e;t++){let n=O[t];n!==void 0&&!Ye.has(n)&&o.push(n)}return o}var j=et(),tt=new Set(j);function Y(o){return tt.has(o)}function ve(o){let e={};for(let t=0;t<o.length;t++){let n=o[t],s=n.type;if(s!==void 0&&!be.has(n.code))if(N(s))e[s]=n.value;else{let a=s;e[a]=n.value}}return e}function we(o){let e={};for(let t=0;t<o.length;t++){let n=o[t],s=n.type;if(s!==void 0)if(N(s))e[s]=n.value;else{let a=s;e[a]=n.value}}for(let t=0;t<he.length;t++){let[n,s]=he[t],a=e[n];a!==void 0&&(e[s]=new E(a,a))}return e}var V=-32768,S=32767,H={startAddrsOffset:new f(0,0,S),endAddrsOffset:new f(V,0,0),startloopAddrsOffset:new f(V,0,S),endloopAddrsOffset:new f(V,0,S),startAddrsCoarseOffset:new f(0,0,S),modLfoToPitch:new f(-12e3,0,12e3),vibLfoToPitch:new f(-12e3,0,12e3),modEnvToPitch:new f(-12e3,0,12e3),initialFilterFc:new f(1500,13500,13500),initialFilterQ:new f(0,0,960),modLfoToFilterFc:new f(-12e3,0,12e3),modEnvToFilterFc:new f(-12e3,0,12e3),endAddrsCoarseOffset:new f(V,0,0),modLfoToVolume:new f(-960,0,960),chorusEffectsSend:new f(0,0,1e3),reverbEffectsSend:new f(0,0,1e3),pan:new f(-500,0,500),delayModLFO:new f(-12e3,-12e3,5e3),freqModLFO:new f(-16e3,0,4500),delayVibLFO:new f(-12e3,-12e3,5e3),freqVibLFO:new f(-16e3,0,4500),delayModEnv:new f(-12e3,-12e3,5e3),attackModEnv:new f(-12e3,-12e3,8e3),holdModEnv:new f(-12e3,-12e3,5e3),decayModEnv:new f(-12e3,-12e3,8e3),sustainModEnv:new f(0,0,1e3),releaseModEnv:new f(-12e3,-12e3,8e3),keynumToModEnvHold:new f(-1200,0,1200),keynumToModEnvDecay:new f(-1200,0,1200),delayVolEnv:new f(-12e3,-12e3,5e3),attackVolEnv:new f(-12e3,-12e3,8e3),holdVolEnv:new f(-12e3,-12e3,5e3),decayVolEnv:new f(-12e3,-12e3,8e3),sustainVolEnv:new f(0,0,1440),releaseVolEnv:new f(-12e3,-12e3,8e3),keynumToVolEnvHold:new f(-1200,0,1200),keynumToVolEnvDecay:new f(-1200,0,1200),instrument:new f(-1,-1,S),keyRange:new E(0,127),velRange:new E(0,127),startloopAddrsCoarseOffset:new f(V,0,S),keynum:new f(-1,-1,127),velocity:new f(-1,-1,127),initialAttenuation:new f(0,0,1440),endloopAddrsCoarseOffset:new f(V,0,S),coarseTune:new f(-120,0,120),fineTune:new f(-99,0,99),sampleID:new f(-1,-1,S),sampleModes:new f(0,0,3),scaleTuning:new f(0,100,100),exclusiveClass:new f(0,0,127),overridingRootKey:new f(-1,-1,127)};function x(o){return Math.pow(2,o/1200)}var G=class{constructor(e,t,n,s,a){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(r,i)=>{r.modLfoToPitch=this.clamp("modLfoToPitch",i)},vibLfoToPitch:(r,i)=>{r.vibLfoToPitch=this.clamp("vibLfoToPitch",i)},modEnvToPitch:(r,i)=>{r.modEnvToPitch=this.clamp("modEnvToPitch",i)},initialFilterFc:(r,i)=>{r.initialFilterFc=this.clamp("initialFilterFc",i)},initialFilterQ:(r,i)=>{r.initialFilterQ=this.clamp("initialFilterQ",i)},modLfoToFilterFc:(r,i)=>{r.modLfoToFilterFc=this.clamp("modLfoToFilterFc",i)},modEnvToFilterFc:(r,i)=>{r.modEnvToFilterFc=this.clamp("modEnvToFilterFc",i)},modLfoToVolume:(r,i)=>{r.modLfoToVolume=this.clamp("modLfoToVolume",i)},chorusEffectsSend:(r,i)=>{r.chorusEffectsSend=this.clamp("chorusEffectsSend",i)/1e3},reverbEffectsSend:(r,i)=>{r.reverbEffectsSend=this.clamp("reverbEffectsSend",i)/1e3},pan:(r,i)=>{r.pan=this.clamp("pan",i)/1e3},delayModLFO:(r,i)=>{r.delayModLFO=x(this.clamp("delayModLFO",i))},freqModLFO:(r,i)=>{r.freqModLFO=this.clamp("freqModLFO",i)},delayVibLFO:(r,i)=>{r.delayVibLFO=x(this.clamp("delayVibLFO",i))},freqVibLFO:(r,i)=>{r.freqVibLFO=this.clamp("freqVibLFO",i)},delayModEnv:(r,i)=>{r.modDelay=x(this.clamp("delayModEnv",i))},attackModEnv:(r,i)=>{r.modAttack=x(this.clamp("attackModEnv",i))},holdModEnv:(r,i)=>{let l=this.clamp("holdModEnv",i),u=this.clamp("keynumToModEnvHold",i);r.modHold=this.getModHold(l,u)},decayModEnv:(r,i)=>{let l=this.clamp("decayModEnv",i),u=this.clamp("keynumToModEnvDecay",i);r.modDecay=this.getModDecay(l,u)},sustainModEnv:(r,i)=>{r.modSustain=this.clamp("sustainModEnv",i)/1e3},releaseModEnv:(r,i)=>{r.modRelease=x(this.clamp("releaseModEnv",i))},keynumToModEnvHold:(r,i)=>{let l=this.clamp("holdModEnv",i),u=this.clamp("keynumToModEnvHold",i);r.modHold=this.getModHold(l,u)},keynumToModEnvDecay:(r,i)=>{let l=this.clamp("decayModEnv",i),u=this.clamp("keynumToModEnvDecay",i);r.modDecay=this.getModDecay(l,u)},delayVolEnv:(r,i)=>{r.volDelay=x(this.clamp("delayVolEnv",i))},attackVolEnv:(r,i)=>{r.volAttack=x(this.clamp("attackVolEnv",i))},holdVolEnv:(r,i)=>{let l=this.clamp("holdVolEnv",i),u=this.clamp("keynumToVolEnvHold",i);r.volHold=this.getVolHold(l,u)},decayVolEnv:(r,i)=>{let l=this.clamp("decayVolEnv",i),u=this.clamp("keynumToVolEnvDecay",i);r.volDecay=this.getVolDecay(l,u)},sustainVolEnv:(r,i)=>{r.volSustain=this.clamp("sustainVolEnv",i)/1e3},releaseVolEnv:(r,i)=>{r.volRelease=x(this.clamp("releaseVolEnv",i))},keynumToVolEnvHold:(r,i)=>{let l=this.clamp("holdVolEnv",i),u=this.clamp("keynumToVolEnvHold",i);r.modHold=this.getVolHold(l,u)},keynumToVolEnvDecay:(r,i)=>{let l=this.clamp("decayVolEnv",i),u=this.clamp("keynumToVolEnvDecay",i);r.modDecay=this.getVolDecay(l,u)},initialAttenuation:(r,i)=>{r.initialAttenuation=this.clamp("initialAttenuation",i)},coarseTune:(r,i)=>{r.playbackRate=this.getPlaybackRate(i)},fineTune:(r,i)=>{r.playbackRate=this.getPlaybackRate(i)},scaleTuning:(r,i)=>{r.playbackRate=this.getPlaybackRate(i)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],n=t.sourceOper.controllerType,s=t.destinationOper,a=this.controllerToDestinations.get(n);a?a.add(t.destinationOper):this.controllerToDestinations.set(n,new Set([s]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],n=t.destinationOper,s=this.destinationToModulators.get(n);s?s.push(t):this.destinationToModulators.set(n,[t])}}getModHold(e,t){return x(e+(this.key-60)*t)}getModDecay(e,t){return x(e+(this.key-60)*t)}getVolHold(e,t){return x(e+(this.key-60)*t)}getVolDecay(e,t){return x(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("coarseTune",e),n=this.clamp("fineTune",e)/100,s=this.clamp("overridingRootKey",e),a=this.clamp("scaleTuning",e)/100,r=t+n,i=s===-1?this.sampleHeader.originalPitch:s,l=r+this.sampleHeader.pitchCorrection/100-i;return Math.pow(Math.pow(2,1/12),(this.key+l)*a)}transformParams(e,t){let n={},s=this.controllerToDestinations.get(e);if(!s)return n;for(let a of s){let r=O[a];if(!r||!Y(r))continue;let i=this.destinationToModulators.get(a);if(i){n[r]=this.generators[r];for(let l of i){let u=l.sourceOper,d=u.map(t[u.controllerType]),c=1,h=l.amountSourceOper;if(!(h.cc===0&&h.index===0)){let m=t[h.controllerType];c=h.map(m)}let p=l.transform(d*c);Number.isNaN(p)||(n[r]+=p)}}}return n}transformAllParams(e){let t=structuredClone(this.generators);for(let n of this.modulators){let s=n.sourceOper.controllerType,a=e[s];if(!a)continue;let r=O[n.destinationOper];if(!r||!Y(r))continue;let l=n.sourceOper.map(a),u=1,d=n.amountSourceOper;if(!(d.cc===0&&d.index===0)){let h=e[d.controllerType];u=d.map(h)}let c=n.transform(l*u);Number.isNaN(c)||(t[r]+=c)}return t}clamp(e,t){return H[e].clamp(t[e])}getParams(e,t){let n={},s=structuredClone(this.generators),a=this.transformParams(e,t),r=Object.keys(a);for(let i of r)s[i]=a[i];for(let i of r)this.voiceHandlers[i](n,s);return n}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},n=this.transformAllParams(e);for(let s=0;s<j.length;s++){let a=j[s];this.voiceHandlers[a](t,n)}return t}};var xe=[new g(y.parse(1282),48,960,y.parse(0),0),new g(y.parse(258),8,-2400,y.parse(0),0),new g(y.parse(13),6,50,y.parse(0),0),new g(y.parse(129),6,50,y.parse(0),0),new g(y.parse(1415),48,960,y.parse(0),0),new g(y.parse(650),48,1,y.parse(0),0),new g(y.parse(1419),48,960,y.parse(0),0),new g(y.parse(219),16,.2,y.parse(0),0),new g(y.parse(221),15,.2,y.parse(0),0),new g(y.parse(526),51,127,y.parse(16),0)];var q=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},W=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},K=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,n,s){let a=new Array(s-n);for(let r=n;r<s;r++){let i=t[r].generatorIndex,l=t[r+1].generatorIndex;a[r-n]=e.slice(i,l)}return a}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],n=this.parsed.presetHeaders[e+1],s=n?n.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,s)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],n=this.parsed.instruments[e+1],s=n?n.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,s)}getModulators(e,t,n,s){let a=new Array(s-n);for(let r=n;r<s;r++){let i=t[r].modulatorIndex,l=t[r+1].modulatorIndex;a[r-n]=e.slice(i,l)}return a}getPresetModulators(e){let t=this.parsed.presetHeaders[e],n=this.parsed.presetHeaders[e+1],s=n?n.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,s)}getInstrumentModulators(e){let t=this.parsed.instruments[e],n=this.parsed.instruments[e+1],s=n?n.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,s)}findInstrumentZone(e,t,n){let s=this.getInstrumentGenerators(e),a=this.getInstrumentModulators(e),r,i=[];for(let l=0;l<s.length;l++){let u=we(s[l]);if(u.sampleID===void 0){r=u,i=a[l];continue}if(!(u.keyRange&&!u.keyRange.in(t))&&!(u.velRange&&!u.velRange.in(n)))if(r){let d={...r,...u},c=[...i,...a[l]];return new q(d,c)}else return new q(u,a[l])}}findInstrument(e,t,n){let s=this.getPresetGenerators(e),a=this.getPresetModulators(e),r,i=[];for(let l=0;l<s.length;l++){let u=ve(s[l]);if(u.instrument===void 0){r=u,i=a[l];continue}if(u.keyRange&&!u.keyRange.in(t)||u.velRange&&!u.velRange.in(n))continue;let d=this.findInstrumentZone(u.instrument,t,n);if(d)if(r){let c={...r,...u},h=[...i,...a[l]],p=new W(c,h);return this.createVoice(t,p,d)}else{let c=new W(u,a[l]);return this.createVoice(t,c,d)}}return null}createVoice(e,t,n){let s=ge(H);Object.assign(s,n.generators);let a=Object.keys(t.generators);for(let d=0;d<a.length;d++){let c=a[d];N(c)||(s[c]+=t.generators[c])}let r=[...xe,...t.modulators,...n.modulators],i=s.sampleID,l=this.parsed.samples[i],u=this.parsed.sampleHeaders[i];return new G(e,s,r,l,u)}getVoice(e,t,n,s){let a=this.parsed.presetHeaders.findIndex(i=>i.preset===t&&i.bank===e);if(a<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let r=this.findInstrument(a,n,s);return r||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let n=0;n<t.length;n++){let s=t[n];e[s.bank]||(e[s.bank]={}),e[s.bank][s.preset]=s.presetName}return e}};var ee=class{index=-1;bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;modulationLFO;modulationDepth;constructor(e,t,n,s,a){this.noteNumber=e,this.velocity=t,this.startTime=n,this.voice=s,this.voiceParams=a}},I=new Uint8Array(128);I[42]=1;I[44]=1;I[46]=1,I[71]=2;I[72]=2;I[73]=3;I[74]=3;I[78]=4;I[79]=4;I[80]=5;I[81]=5;var nt=5,_={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepth:{type:129,defaultValue:0},volume:{type:135,defaultValue:100/127},pan:{type:138,defaultValue:64/127},expression:{type:139,defaultValue:1},sustainPedal:{type:192,defaultValue:0}},te=class{array=new Float32Array(256);constructor(){let e=Object.entries(_);for(let[t,{type:n,defaultValue:s}]of e)this.array[n]=s,Object.defineProperty(this,t,{get:()=>this.array[n],set:a=>this.array[n]=a,enumerable:!0,configurable:!0})}},ne=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain","modRelease","playbackRate"],rt=new Set(ne),re=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],st=new Set(re),Ie=class{mode="GM1";numChannels=16;ticksPerBeat=120;totalTime=0;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=this.initSoundFontTable();audioBufferCounter=new Map;audioBufferCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;timeline=[];instruments=[];notePromises=[];exclusiveClassNotes=new Array(128);drumExclusiveClassNotes=new Array(this.numChannels*nt);static channelSettings={detune:0,programNumber:0,bank:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,modulationDepthRange:50};constructor(e){this.audioContext=e,this.masterVolume=new GainNode(e),this.scheduler=new GainNode(e,{gain:0}),this.schedulerBuffer=new AudioBuffer({length:1,sampleRate:e.sampleRate}),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.masterVolume.connect(e.destination),this.scheduler.connect(e.destination),this.GM1SystemOn()}initSoundFontTable(){let e=new Array(128);for(let t=0;t<128;t++)e[t]=new Map;return e}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let n=e.parsed.presetHeaders;for(let s=0;s<n.length;s++){let a=n[s];a.presetName.startsWith("\0")||this.soundFontTable[a.preset].set(a.bank,t)}}async loadSoundFont(e){let n=await(await fetch(e)).arrayBuffer(),s=ce(new Uint8Array(n)),a=new K(s);this.addSoundFont(a)}async loadMIDI(e){let n=await(await fetch(e)).arrayBuffer(),s=(0,Pe.parseMidi)(new Uint8Array(n));this.ticksPerBeat=s.header.ticksPerBeat;let a=this.extractMidiData(s);this.instruments=a.instruments,this.timeline=a.timeline,this.totalTime=this.calcTotalTime()}setChannelAudioNodes(e){let{gainLeft:t,gainRight:n}=this.panToGain(_.pan.defaultValue),s=new GainNode(e,{gain:t}),a=new GainNode(e,{gain:n}),r=new ChannelMergerNode(e,{numberOfInputs:2});return s.connect(r,0,0),a.connect(r,0,1),r.connect(this.masterVolume),{gainL:s,gainR:a,merger:r}}createChannels(e){return Array.from({length:this.numChannels},()=>({currentBufferSource:null,isDrum:!1,state:new te,...this.constructor.channelSettings,...this.setChannelAudioNodes(e),scheduledNotes:[],sustainNotes:[]}))}async createNoteBuffer(e,t){let n=e.start,s=e.sample.length+e.end;if(t){let a=e.sample,r=a.byteOffset+n,i=a.byteOffset+s,l=a.buffer.slice(r,i);return await this.audioContext.decodeAudioData(l)}else{let a=e.sample,r=a.byteOffset+n,i=a.byteOffset+s,l=a.buffer.slice(r,i),u=new AudioBuffer({numberOfChannels:1,length:a.length,sampleRate:e.sampleRate}),d=u.getChannelData(0),c=new Int16Array(l);for(let h=0;h<c.length;h++)d[h]=c[h]/32768;return u}}createBufferSource(e,t){let n=new AudioBufferSourceNode(this.audioContext);return n.buffer=t,n.loop=e.sampleModes%2!==0,n.loop&&(n.loopStart=e.loopStart/e.sampleRate,n.loopEnd=e.loopEnd/e.sampleRate),n}async scheduleTimelineEvents(e,t,n){for(;n<this.timeline.length;){let s=this.timeline[n];if(s.startTime>e+this.lookAhead)break;let a=this.startDelay-t,r=s.startTime+a;switch(s.type){case"noteOn":{let i={...s.noteOffEvent,startTime:s.noteOffEvent.startTime+a};await this.scheduleNoteOn(s.channel,s.noteNumber,s.velocity,r,i);break}case"controller":this.handleControlChange(s.channel,s.controllerType,s.value,r);break;case"programChange":this.handleProgramChange(s.channel,s.programNumber,r);break;case"pitchBend":this.setPitchBend(s.channel,s.value+8192,r);break;case"sysEx":this.handleSysEx(s.data,r)}n++}return n}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}playNotes(){return new Promise(e=>{this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime;this.notePromises=[];let s=async()=>{if(t>=this.timeline.length){await Promise.all(this.notePromises),this.notePromises=[],this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.audioBufferCache.clear();for(let i=0;i<this.channels.length;i++)this.resetAllStates(i);e();return}let a=this.audioContext.currentTime,r=a+n;if(t=await this.scheduleTimelineEvents(r,n,t),this.isPausing){await this.stopNotes(0,!0,a),this.notePromises=[],this.isPausing=!1,this.isPaused=!0,e();return}else if(this.isStopping){await this.stopNotes(0,!0,a),this.notePromises=[],this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.audioBufferCache.clear();for(let i=0;i<this.channels.length;i++)this.resetAllStates(i);this.isStopping=!1,this.isPaused=!1,e();return}else if(this.isSeeking)this.stopNotes(0,!0,a),this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.startTime=this.audioContext.currentTime,t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime,this.isSeeking=!1,await s();else{let i=a+this.noteCheckInterval;await this.scheduleTask(()=>{},i),await s()}};s()})}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}getAudioBufferId(e,t,n){return`${e}:${t}:${n}`}extractMidiData(e){let t=new Set,n=[],s=new Array(this.channels.length);for(let d=0;d<s.length;d++)s[d]={programNumber:-1,bank:this.channels[d].bank};for(let d=0;d<e.tracks.length;d++){let c=e.tracks[d],h=0;for(let p=0;p<c.length;p++){let m=c[p];switch(h+=m.deltaTime,m.ticks=h,m.type){case"noteOn":{let w=s[m.channel],M=this.getAudioBufferId(w.programNumber,m.noteNumber,m.velocity);this.audioBufferCounter.set(M,(this.audioBufferCounter.get(M)??0)+1),w.programNumber<0&&(t.add(`${w.bank}:0`),w.programNumber=0);break}case"programChange":{let w=s[m.channel];w.programNumber=m.programNumber,t.add(`${w.bankNumber}:${w.programNumber}`)}}delete m.deltaTime,n.push(m)}}for(let[d,c]of this.audioBufferCounter)c===1&&this.audioBufferCounter.delete(d);let a={controller:0,sysEx:1};n.sort((d,c)=>d.ticks!==c.ticks?d.ticks-c.ticks:(a[d.type]||2)-(a[c.type]||2));let r=0,i=0,l=.5;for(let d=0;d<n.length;d++){let c=n[d],h=this.ticksToSecond(c.ticks-i,l);c.startTime=r+h,c.type==="setTempo"&&(r+=this.ticksToSecond(c.ticks-i,l),l=c.microsecondsPerBeat/1e6,i=c.ticks)}let u=new Array(this.channels.length*128);for(let d=0;d<u.length;d++)u[d]=[];for(let d=0;d<n.length;d++){let c=n[d];switch(c.type){case"noteOn":{let h=c.channel*128+c.noteNumber;u[h].push(c);break}case"noteOff":{let h=c.channel*128+c.noteNumber,p=u[h].pop();if(p)p.noteOffEvent=c;else{let m=JSON.stringify(c,null,2);console.warn(`noteOff without matching noteOn: ${m}`)}}}}return{instruments:t,timeline:n}}stopActiveNotes(e,t,n,s){let a=this.channels[e],r=[];return this.processActiveNotes(a,s,i=>{let l=this.scheduleNoteOff(e,i.noteNumber,t,s,n,void 0);this.notePromises.push(l),r.push(l)}),Promise.all(r)}stopChannelNotes(e,t,n,s){let a=this.channels[e],r=[];return this.processScheduledNotes(a,i=>{let l=this.scheduleNoteOff(e,i,t,s,n);this.notePromises.push(l),r.push(l)}),a.scheduledNotes=[],Promise.all(r)}stopNotes(e,t,n){let s=[];for(let a=0;a<this.channels.length;a++)s.push(this.stopChannelNotes(a,e,t,n));return Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,await this.playNotes(),this.isPlaying=!1)}stop(){this.isPlaying&&(this.isStopping=!0)}pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}async resume(){this.isPaused&&(await this.playNotes(),this.isPlaying=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let n=this.timeline[t];e<n.startTime&&(e=n.startTime)}return e}currentTime(){let e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}processScheduledNotes(e,t){let n=e.scheduledNotes;for(let s=0;s<n.length;s++){let a=n[s];a&&(a.ending||t(a))}}processActiveNotes(e,t,n){let s=e.scheduledNotes;for(let a=0;a<s.length;a++){let r=s[a];if(!r||r.ending)continue;let i=r.noteOffEvent;i&&i.startTime<t||t<r.startTime||n(r)}}cbToRatio(e){return Math.pow(10,e/200)}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=e.state.pitchWheel*2-1,n=e.state.pitchWheelSensitivity*12800;return t*n}updateChannelDetune(e,t){this.processScheduledNotes(e,n=>{this.updateDetune(e,n,t)})}updateDetune(e,t,n){t.bufferSource.detune.cancelScheduledValues(n).setValueAtTime(e.detune,n)}setVolumeEnvelope(e,t){let{voiceParams:n,startTime:s}=e,a=this.cbToRatio(-n.initialAttenuation),r=a*(1-n.volSustain),i=s+n.volDelay,l=i+n.volAttack,u=l+n.volHold,d=u+n.volDecay;e.volumeEnvelopeNode.gain.cancelScheduledValues(t).setValueAtTime(0,s).setValueAtTime(1e-6,i).exponentialRampToValueAtTime(a,l).setValueAtTime(a,u).linearRampToValueAtTime(r,d)}setPitchEnvelope(e,t){let{voiceParams:n}=e,s=n.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(s,t);let a=n.modEnvToPitch;if(a===0)return;let i=this.rateToCent(s)+a,l=this.centToRate(i),u=e.startTime+n.modDelay,d=u+n.modAttack,c=d+n.modHold,h=c+n.modDecay;e.bufferSource.playbackRate.setValueAtTime(s,u).exponentialRampToValueAtTime(l,d).setValueAtTime(l,c).linearRampToValueAtTime(s,h)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setFilterEnvelope(e,t){let{voiceParams:n,startTime:s}=e,a=this.centToHz(n.initialFilterFc),r=this.centToHz(n.initialFilterFc+n.modEnvToFilterFc),i=a+(r-a)*(1-n.modSustain),l=this.clampCutoffFrequency(a),u=this.clampCutoffFrequency(r),d=this.clampCutoffFrequency(i),c=s+n.modDelay,h=c+n.modAttack,p=h+n.modHold,m=p+n.modDecay;e.filterNode.frequency.cancelScheduledValues(t).setValueAtTime(l,s).setValueAtTime(l,c).exponentialRampToValueAtTime(u,h).setValueAtTime(u,p).linearRampToValueAtTime(d,m)}startModulation(e,t,n){let{voiceParams:s}=t;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(s.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:s.modLfoToFilterFc}),t.modulationDepth=new GainNode(this.audioContext),this.setModLfoToPitch(e,t,n),t.volumeDepth=new GainNode(this.audioContext),this.setModLfoToVolume(t,n),t.modulationLFO.start(t.startTime+s.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}async getAudioBuffer(e,t,n,s,a){let r=this.getAudioBufferId(e,t,n),i=this.audioBufferCache.get(r);if(i)return i.counter+=1,i.maxCount<=i.counter&&this.audioBufferCache.delete(r),i.audioBuffer;{let l=this.audioBufferCounter.get(r)??0,u=await this.createNoteBuffer(s,a),d={audioBuffer:u,maxCount:l,counter:1};return this.audioBufferCache.set(r,d),u}}async createNote(e,t,n,s,a,r){let i=this.audioContext.currentTime,l=e.state,u=this.getControllerState(e,n,s),d=t.getAllParams(u),c=new ee(n,s,a,t,d),h=await this.getAudioBuffer(e.programNumber,n,s,d,r);return c.bufferSource=this.createBufferSource(d,h),c.volumeEnvelopeNode=new GainNode(this.audioContext),c.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:d.initialFilterQ/10}),this.setVolumeEnvelope(c,i),this.setFilterEnvelope(c,i),this.setPitchEnvelope(c,i),this.updateDetune(e,c,i),0<l.modulationDepth&&this.startModulation(e,c,i),c.bufferSource.connect(c.filterNode),c.filterNode.connect(c.volumeEnvelopeNode),c.bufferSource.start(a),c}handleExclusiveClass(e,t,n){let s=e.voiceParams.exclusiveClass;if(s===0)return;let a=this.exclusiveClassNotes[s];if(a){let[r,i]=a;r&&!r.ending&&this.scheduleNoteOff(i,r,0,n,!0)}this.exclusiveClassNotes[s]=[e,t]}handleDrumExclusiveClass(e,t,n){if(!this.channels[t].isDrum)return;let a=I[noteNumber];if(a===0)return;let r=a*this.channels.length+t,i=this.drumExclusiveClassNotes[r];i&&!i.ending&&this.scheduleNoteOff(t,i,0,n,!0),this.drumExclusiveClassNotes[r]=e}async scheduleNoteOn(e,t,n,s,a){let r=this.channels[e],i=r.bank,l=this.soundFontTable[r.programNumber].get(i);if(l===void 0)return;let u=this.soundFonts[l],d=u.getVoice(i,r.programNumber,t,n);if(!d)return;let c=u.parsed.info.version.major===3,h=await this.createNote(r,d,t,n,s,c);h.noteOffEvent=a,h.volumeEnvelopeNode.connect(r.gainL),h.volumeEnvelopeNode.connect(r.gainR),.5<=r.state.sustainPedal&&r.sustainNotes.push(h),this.handleExclusiveClass(h,e,s),this.handleDrumExclusiveClass(h,e,s);let p=r.scheduledNotes;if(h.index=p.length,p.push(h),r.isDrum){let m=s+h.bufferSource.buffer.duration,w=new Promise(M=>{h.bufferSource.onended=()=>{p[h.index]=void 0,this.disconnectNote(h),M()},h.bufferSource.stop(m)});this.notePromises.push(w)}else if(a){let m=this.scheduleNoteOff(e,h,a.velocity,a.startTime,!1);m&&this.notePromises.push(m)}}noteOn(e,t,n,s){return s??=this.audioContext.currentTime,this.scheduleNoteOn(e,t,n,s,void 0)}disconnectNote(e){e.bufferSource.disconnect(),e.filterNode.disconnect(),e.volumeEnvelopeNode.disconnect(),e.modulationDepth&&(e.volumeDepth.disconnect(),e.modulationDepth.disconnect(),e.modulationLFO.stop())}stopNote(e,t,n,s){return t.volumeEnvelopeNode.gain.cancelScheduledValues(n).linearRampToValueAtTime(0,s),t.ending=!0,this.scheduleTask(()=>{t.bufferSource.loop=!1},s),new Promise(a=>{t.bufferSource.onended=()=>{e.scheduledNotes[t.index]=void 0,this.disconnectNote(t),a()},t.bufferSource.stop(s)})}scheduleNoteOff(e,t,n,s,a){let r=this.channels[e];if(r.isDrum||!a&&.5<=r.state.sustainPedal)return;let i=s+t.voiceParams.volRelease,l=s+t.voiceParams.modRelease;t.filterNode.frequency.cancelScheduledValues(s).linearRampToValueAtTime(0,l);let u=Math.min(i,l);return this.stopNote(r,t,s,u)}findNoteOffTarget(e,t){let n=e.scheduledNotes;for(let s=0;s<n.length;s++){let a=n[s];if(a&&!a.ending&&a.noteNumber===t)return a}}noteOff(e,t,n,s){s??=this.audioContext.currentTime;let a=this.channels[e],r=this.findNoteOffTarget(a,t);return this.scheduleNoteOff(e,r,n,s,!1)}releaseSustainPedal(e,t,n){let s=t*2,a=this.channels[e],r=[];for(let i=0;i<a.sustainNotes.length;i++){let l=this.scheduleNoteOff(e,a.sustainNotes[i],s,n);r.push(l)}return a.sustainNotes=[],r}handleMIDIMessage(e,t,n,s){let a=e&15,r=e&240;switch(r){case 128:return this.noteOff(a,t,n,s);case 144:return this.noteOn(a,t,n,s);case 176:return this.handleControlChange(a,t,n,s);case 192:return this.handleProgramChange(a,t,s);case 224:return this.handlePitchBendMessage(a,t,n,s);default:console.warn(`Unsupported MIDI message: ${r.toString(16)}`)}}handleProgramChange(e,t,n){let s=this.channels[e];s.programNumber=t}handlePitchBendMessage(e,t,n,s){let a=n*128+t;this.setPitchBend(e,a,s)}setPitchBend(e,t,n){let s=this.channels[e];n??=this.audioContext.currentTime;let a=s.state,r=a.pitchWheel*2-1,i=(t-8192)/8192;a.pitchWheel=t/16383,s.detune+=(i-r)*a.pitchWheelSensitivity*12800,this.updateChannelDetune(s,n),this.applyVoiceParams(s,14,n)}setModLfoToPitch(e,t,n){let s=t.voiceParams.modLfoToPitch,r=(Math.abs(s)+e.state.modulationDepth)*Math.sign(s);t.modulationDepth.gain.cancelScheduledValues(n).setValueAtTime(r,n)}setModLfoToFilterFc(e,t){let n=e.voiceParams.modLfoToFilterFc;e.filterDepth.gain.cancelScheduledValues(t).setValueAtTime(n,t)}setModLfoToVolume(e,t){let n=e.voiceParams.modLfoToVolume,a=(this.cbToRatio(Math.abs(n))-1)*Math.sign(n);e.volumeDepth.gain.cancelScheduledValues(t).setValueAtTime(a,t)}setDelayModLFO(e,t){let n=e.startTime;n<t||(e.modulationLFO.stop(t),e.modulationLFO.start(n+e.voiceParams.delayModLFO),e.modulationLFO.connect(e.filterDepth))}setFreqModLFO(e,t){let n=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(n,t)}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,n,s)=>{0<e.state.modulationDepth&&this.setModLfoToPitch(e,t,s)},vibLfoToPitch:(e,t,n,s)=>{},modLfoToFilterFc:(e,t,n,s)=>{0<e.state.modulationDepth&&this.setModLfoToFilterFc(t,s)},modLfoToVolume:(e,t,n,s)=>{0<e.state.modulationDepth&&this.setModLfoToVolume(t,s)},chorusEffectsSend:(e,t,n,s)=>{},reverbEffectsSend:(e,t,n,s)=>{},delayModLFO:(e,t,n,s)=>this.setDelayModLFO(t,s),freqModLFO:(e,t,n,s)=>this.setFreqModLFO(t,s),delayVibLFO:(e,t,n,s)=>{},freqVibLFO:(e,t,n,s)=>{}}}getControllerState(e,t,n){let s=new Float32Array(e.state.array.length);return s.set(e.state.array),s[2]=n/127,s[3]=t/127,s}applyVoiceParams(e,t,n){this.processScheduledNotes(e,s=>{let a=this.getControllerState(e,s.noteNumber,s.velocity),r=s.voice.getParams(t,a),i=!1,l=!1;for(let[u,d]of Object.entries(r)){let c=s.voiceParams[u];if(d!==c){if(s.voiceParams[u]=d,u in this.voiceParamsHandlers)this.voiceParamsHandlers[u](e,s,c,n);else if(rt.has(u)){if(i)continue;i=!0;let h=s.voiceParams;for(let p=0;p<ne.length;p++){let m=ne[p];m in r&&(h[m]=r[m])}this.setFilterEnvelope(s,n),this.setPitchEnvelope(s,n)}else if(st.has(u)){if(l)continue;l=!0;let h=s.voiceParams;for(let p=0;p<re.length;p++){let m=re[p];m in r&&(h[m]=r[m])}this.setVolumeEnvelope(s,n)}}}})}createControlChangeHandlers(){let e=new Array(128);return e[1]=this.setModulationDepth,e[6]=this.dataEntryMSB,e[7]=this.setVolume,e[10]=this.setPan,e[11]=this.setExpression,e[38]=this.dataEntryLSB,e[64]=this.setSustainPedal,e[100]=this.setRPNLSB,e[101]=this.setRPNMSB,e[120]=this.allSoundOff,e[121]=this.resetAllControllers,e[123]=this.allNotesOff,e}handleControlChange(e,t,n,s){let a=this.controlChangeHandlers[t];if(a){a.call(this,e,n,s);let r=this.channels[e];this.applyVoiceParams(r,t+128,s)}else console.warn(`Unsupported Control change: controllerType=${t} value=${n}`)}updateModulation(e,t){let n=e.state.modulationDepth*e.modulationDepthRange;this.processScheduledNotes(e,s=>{s.modulationDepth?s.modulationDepth.gain.setValueAtTime(n,t):(this.setPitchEnvelope(s,t),this.startModulation(e,s,t))})}setModulationDepth(e,t,n){let s=this.channels[e];n??=this.audioContext.currentTime,s.state.modulationDepth=t/127,this.updateModulation(s,n)}setVolume(e,t,n){n??=this.audioContext.currentTime;let s=this.channels[e];s.state.volume=t/127,this.updateChannelVolume(s,n)}panToGain(e){let t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t,n){n??=this.audioContext.currentTime;let s=this.channels[e];s.state.pan=t/127,this.updateChannelVolume(s,n)}setExpression(e,t,n){n??=this.audioContext.currentTime;let s=this.channels[e];s.state.expression=t/127,this.updateChannelVolume(s,n)}dataEntryLSB(e,t,n){this.channels[e].dataLSB=t,this.handleRPN(e,n)}updateChannelVolume(e,t){let n=e.state,s=n.volume*n.expression,{gainLeft:a,gainRight:r}=this.panToGain(n.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(s*a,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(s*r,t)}setSustainPedal(e,t,n){let s=this.channels[e];n??=this.audioContext.currentTime,s.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(s,a=>{s.sustainNotes.push(a)}):this.releaseSustainPedal(e,t,n)}limitData(e,t,n,s,a){a<e.dataLSB?(e.dataMSB++,e.dataLSB=s):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=a),n<e.dataMSB?(e.dataMSB=n,e.dataLSB=a):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=s)}handleRPN(e,t){let n=this.channels[e];switch(n.rpnMSB*128+n.rpnLSB){case 0:this.handlePitchBendRangeRPN(e,t);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${n.rpnMSB} LSB=${n.rpnLSB}`)}}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,n){this.channels[e].dataMSB=t,this.handleRPN(e,n)}handlePitchBendRangeRPN(e,t){let n=this.channels[e];this.limitData(n,0,127,0,99);let s=n.dataMSB+n.dataLSB/100;this.setPitchBendRange(e,s,t)}setPitchBendRange(e,t,n){let s=this.channels[e];n??=this.audioContext.currentTime;let a=s.state,r=a.pitchWheelSensitivity,i=t/128;a.pitchWheelSensitivity=i,s.detune+=(a.pitchWheel*2-1)*(i-r)*12800,this.updateChannelDetune(s,n),this.applyVoiceParams(s,16,n)}allSoundOff(e,t,n){return n??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!0,n)}resetAllStates(e){let t=this.audioContext.currentTime,n=this.channels[e],s=n.state,a=Object.entries(_);for(let[r,{type:i,defaultValue:l}]of a)128<=i?this.handleControlChange(e,i-128,Math.ceil(l*127),t):s[r]=l;for(let r of Object.keys(this.constructor.channelSettings))n[r]=this.constructor.channelSettings[r];this.mode="GM1"}resetAllControllers(e,t,n){let s=["pitchWheel","expression","modulationDepth","sustainPedal"],a=this.channels[e],r=a.state;for(let l=0;l<s.length;l++){let u=s[l],{type:d,defaultValue:c}=_[u];128<=d?this.handleControlChange(e,d-128,Math.ceil(c*127),n):r[u]=c}this.setPitchBend(e,8192,n);let i=["rpnMSB","rpnLSB"];for(let l=0;l<i.length;l++){let u=i[l];a[u]=this.constructor.channelSettings[u]}}allNotesOff(e,t,n){return n??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!1,n)}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 9:switch(e[3]){case 1:this.GM1SystemOn(t);break;case 2:break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(e){e??=this.audioContext.currentTime,this.mode="GM1";for(let t=0;t<this.channels.length;t++){this.allSoundOff(t,0,e);let n=this.channels[t];n.bank=0,n.isDrum=!1}this.channels[9].bank=128,this.channels[9].isDrum=!0}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){let n=(e[5]*128+e[4])/16383;this.setMasterVolume(n,t)}setMasterVolume(e,t){t??=this.audioContext.currentTime,e<0&&1<e?console.error("Master Volume is out of range"):this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(n=>{let s=new AudioBufferSourceNode(this.audioContext,{buffer:this.schedulerBuffer});s.connect(this.scheduler),s.onended=()=>{try{e()}finally{s.disconnect(),n()}},s.start(t)})}};export{Ie as MidyGMLite};
