var e={};function t(e){this.buffer=e,this.bufferLen=this.buffer.length,this.pos=0}function r(){this.buffer=[]}t.prototype.eof=function(){return this.pos>=this.bufferLen},t.prototype.readUInt8=function(){var e=this.buffer[this.pos];return this.pos+=1,e},t.prototype.readInt8=function(){var e=this.readUInt8();return 128&e?e-256:e},t.prototype.readUInt16=function(){return(this.readUInt8()<<8)+this.readUInt8()},t.prototype.readInt16=function(){var e=this.readUInt16();return 32768&e?e-65536:e},t.prototype.readUInt24=function(){return(this.readUInt8()<<16)+(this.readUInt8()<<8)+this.readUInt8()},t.prototype.readInt24=function(){var e=this.readUInt24();return 8388608&e?e-0x1000000:e},t.prototype.readUInt32=function(){return(this.readUInt8()<<24)+(this.readUInt8()<<16)+(this.readUInt8()<<8)+this.readUInt8()},t.prototype.readBytes=function(e){var t=this.buffer.slice(this.pos,this.pos+e);return this.pos+=e,t},t.prototype.readString=function(e){var t=this.readBytes(e);return String.fromCharCode.apply(null,t)},t.prototype.readVarInt=function(){for(var e=0;!this.eof();){var t=this.readUInt8();if(!(128&t))return e+t;e+=127&t,e<<=7}return e},t.prototype.readChunk=function(){var e=this.readString(4),t=this.readUInt32();return{id:e,length:t,data:this.readBytes(t)}},r.prototype.writeUInt8=function(e){this.buffer.push(255&e)},r.prototype.writeInt8=r.prototype.writeUInt8,r.prototype.writeUInt16=function(e){this.writeUInt8(e>>8&255),this.writeUInt8(255&e)},r.prototype.writeInt16=r.prototype.writeUInt16,r.prototype.writeUInt24=function(e){this.writeUInt8(e>>16&255),this.writeUInt8(e>>8&255),this.writeUInt8(255&e)},r.prototype.writeInt24=r.prototype.writeUInt24,r.prototype.writeUInt32=function(e){this.writeUInt8(e>>24&255),this.writeUInt8(e>>16&255),this.writeUInt8(e>>8&255),this.writeUInt8(255&e)},r.prototype.writeInt32=r.prototype.writeUInt32,r.prototype.writeBytes=function(e){this.buffer=this.buffer.concat(Array.prototype.slice.call(e,0))},r.prototype.writeString=function(e){var t,r=e.length,n=[];for(t=0;t<r;t++)n.push(e.codePointAt(t));this.writeBytes(n)},r.prototype.writeVarInt=function(e){if(e<0)throw"Cannot write negative variable-length integer";if(e<=127)this.writeUInt8(e);else{var t=e,r=[];for(r.push(127&t),t>>=7;t;){var n=127&t|128;r.push(n),t>>=7}this.writeBytes(r.reverse())}},r.prototype.writeChunk=function(e,t){this.writeString(e),this.writeUInt32(t.length),this.writeBytes(t)};var n=e.parseMidi=function(e){var r,n,i,a=new t(e),s=a.readChunk();if("MThd"!=s.id)throw"Bad MIDI file.  Expected 'MHdr', got: '"+s.id+"'";for(var o=(n={format:(r=new t(s.data)).readUInt16(),numTracks:r.readUInt16()},32768&(i=r.readUInt16())?(n.framesPerSecond=256-(i>>8),n.ticksPerFrame=255&i):n.ticksPerBeat=i,n),l=[],u=0;!a.eof()&&u<o.numTracks;u++){var d=a.readChunk();if("MTrk"!=d.id)throw"Bad MIDI file.  Expected 'MTrk', got: '"+d.id+"'";var c=function(e){for(var r,n=new t(e),i=[];!n.eof();){var a=function(){var e={};e.deltaTime=n.readVarInt();var t=n.readUInt8();if(240==(240&t)){if(255!==t){if(240==t)return e.type="sysEx",a=n.readVarInt(),e.data=n.readBytes(a),e;if(247==t)return e.type="endSysEx",a=n.readVarInt(),e.data=n.readBytes(a),e;throw"Unrecognised MIDI event type byte: "+t}e.meta=!0;var i=n.readUInt8(),a=n.readVarInt();switch(i){case 0:if(e.type="sequenceNumber",2!==a)throw"Expected length for sequenceNumber event is 2, got "+a;return e.number=n.readUInt16(),e;case 1:return e.type="text",e.text=n.readString(a),e;case 2:return e.type="copyrightNotice",e.text=n.readString(a),e;case 3:return e.type="trackName",e.text=n.readString(a),e;case 4:return e.type="instrumentName",e.text=n.readString(a),e;case 5:return e.type="lyrics",e.text=n.readString(a),e;case 6:return e.type="marker",e.text=n.readString(a),e;case 7:return e.type="cuePoint",e.text=n.readString(a),e;case 32:if(e.type="channelPrefix",1!=a)throw"Expected length for channelPrefix event is 1, got "+a;return e.channel=n.readUInt8(),e;case 33:if(e.type="portPrefix",1!=a)throw"Expected length for portPrefix event is 1, got "+a;return e.port=n.readUInt8(),e;case 47:if(e.type="endOfTrack",0!=a)throw"Expected length for endOfTrack event is 0, got "+a;return e;case 81:if(e.type="setTempo",3!=a)throw"Expected length for setTempo event is 3, got "+a;return e.microsecondsPerBeat=n.readUInt24(),e;case 84:if(e.type="smpteOffset",5!=a)throw"Expected length for smpteOffset event is 5, got "+a;var s=n.readUInt8();return e.frameRate=({0:24,32:25,64:29,96:30})[96&s],e.hour=31&s,e.min=n.readUInt8(),e.sec=n.readUInt8(),e.frame=n.readUInt8(),e.subFrame=n.readUInt8(),e;case 88:if(e.type="timeSignature",2!=a&&4!=a)throw"Expected length for timeSignature event is 4 or 2, got "+a;return e.numerator=n.readUInt8(),e.denominator=1<<n.readUInt8(),4===a?(e.metronome=n.readUInt8(),e.thirtyseconds=n.readUInt8()):(e.metronome=36,e.thirtyseconds=8),e;case 89:if(e.type="keySignature",2!=a)throw"Expected length for keySignature event is 2, got "+a;return e.key=n.readInt8(),e.scale=n.readUInt8(),e;case 127:return e.type="sequencerSpecific",e.data=n.readBytes(a),e;default:return e.type="unknownMeta",e.data=n.readBytes(a),e.metatypeByte=i,e}}else{if(0==(128&t)){if(null===r)throw"Running status byte encountered before status byte";o=t,t=r,e.running=!0}else o=n.readUInt8(),r=t;var o,l=t>>4;switch(e.channel=15&t,l){case 8:return e.type="noteOff",e.noteNumber=o,e.velocity=n.readUInt8(),e;case 9:var u=n.readUInt8();return e.type=0===u?"noteOff":"noteOn",e.noteNumber=o,e.velocity=u,0===u&&(e.byte9=!0),e;case 10:return e.type="noteAftertouch",e.noteNumber=o,e.amount=n.readUInt8(),e;case 11:return e.type="controller",e.controllerType=o,e.value=n.readUInt8(),e;case 12:return e.type="programChange",e.programNumber=o,e;case 13:return e.type="channelAftertouch",e.amount=o,e;case 14:return e.type="pitchBend",e.value=o+(n.readUInt8()<<7)-8192,e;default:throw"Unrecognised MIDI event type: "+l}}}();i.push(a)}return i}(d.data);l.push(c)}return{header:o,tracks:l}};e.writeMidi=function(e,t){if("object"!=typeof e)throw"Invalid MIDI data";t=t||{};var n,i,a,s,o=e.header||{},l=e.tracks||[],u=l.length,d=new r;for(n=null==o.format?1:o.format,i=128,o.timeDivision?i=o.timeDivision:o.ticksPerFrame&&o.framesPerSecond?i=-(255&o.framesPerSecond)<<8|255&o.ticksPerFrame:o.ticksPerBeat&&(i=32767&o.ticksPerBeat),(a=new r).writeUInt16(n),a.writeUInt16(u),a.writeUInt16(i),d.writeChunk("MThd",a.buffer),s=0;s<u;s++)!function(e,t,n){var i,a=new r,s=t.length,o=null;for(i=0;i<s;i++)!1!==n.running&&(n.running||t[i].running)||(o=null),o=function(e,t,r,n){var i=t.type,a=t.deltaTime,s=t.text||"",o=t.data||[],l=null;switch(e.writeVarInt(a),i){case"sequenceNumber":e.writeUInt8(255),e.writeUInt8(0),e.writeVarInt(2),e.writeUInt16(t.number);break;case"text":e.writeUInt8(255),e.writeUInt8(1),e.writeVarInt(s.length),e.writeString(s);break;case"copyrightNotice":e.writeUInt8(255),e.writeUInt8(2),e.writeVarInt(s.length),e.writeString(s);break;case"trackName":e.writeUInt8(255),e.writeUInt8(3),e.writeVarInt(s.length),e.writeString(s);break;case"instrumentName":e.writeUInt8(255),e.writeUInt8(4),e.writeVarInt(s.length),e.writeString(s);break;case"lyrics":e.writeUInt8(255),e.writeUInt8(5),e.writeVarInt(s.length),e.writeString(s);break;case"marker":e.writeUInt8(255),e.writeUInt8(6),e.writeVarInt(s.length),e.writeString(s);break;case"cuePoint":e.writeUInt8(255),e.writeUInt8(7),e.writeVarInt(s.length),e.writeString(s);break;case"channelPrefix":e.writeUInt8(255),e.writeUInt8(32),e.writeVarInt(1),e.writeUInt8(t.channel);break;case"portPrefix":e.writeUInt8(255),e.writeUInt8(33),e.writeVarInt(1),e.writeUInt8(t.port);break;case"endOfTrack":e.writeUInt8(255),e.writeUInt8(47),e.writeVarInt(0);break;case"setTempo":e.writeUInt8(255),e.writeUInt8(81),e.writeVarInt(3),e.writeUInt24(t.microsecondsPerBeat);break;case"smpteOffset":e.writeUInt8(255),e.writeUInt8(84),e.writeVarInt(5);var u=31&t.hour|({24:0,25:32,29:64,30:96})[t.frameRate];e.writeUInt8(u),e.writeUInt8(t.min),e.writeUInt8(t.sec),e.writeUInt8(t.frame),e.writeUInt8(t.subFrame);break;case"timeSignature":e.writeUInt8(255),e.writeUInt8(88),e.writeVarInt(4),e.writeUInt8(t.numerator);var d=255&Math.floor(Math.log(t.denominator)/Math.LN2);e.writeUInt8(d),e.writeUInt8(t.metronome),e.writeUInt8(t.thirtyseconds||8);break;case"keySignature":e.writeUInt8(255),e.writeUInt8(89),e.writeVarInt(2),e.writeInt8(t.key),e.writeUInt8(t.scale);break;case"sequencerSpecific":e.writeUInt8(255),e.writeUInt8(127),e.writeVarInt(o.length),e.writeBytes(o);break;case"unknownMeta":null!=t.metatypeByte&&(e.writeUInt8(255),e.writeUInt8(t.metatypeByte),e.writeVarInt(o.length),e.writeBytes(o));break;case"sysEx":e.writeUInt8(240),e.writeVarInt(o.length),e.writeBytes(o);break;case"endSysEx":e.writeUInt8(247),e.writeVarInt(o.length),e.writeBytes(o);break;case"noteOff":(l=(!1!==n&&t.byte9||n&&0==t.velocity?144:128)|t.channel)!==r&&e.writeUInt8(l),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteOn":(l=144|t.channel)!==r&&e.writeUInt8(l),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteAftertouch":(l=160|t.channel)!==r&&e.writeUInt8(l),e.writeUInt8(t.noteNumber),e.writeUInt8(t.amount);break;case"controller":(l=176|t.channel)!==r&&e.writeUInt8(l),e.writeUInt8(t.controllerType),e.writeUInt8(t.value);break;case"programChange":(l=192|t.channel)!==r&&e.writeUInt8(l),e.writeUInt8(t.programNumber);break;case"channelAftertouch":(l=208|t.channel)!==r&&e.writeUInt8(l),e.writeUInt8(t.amount);break;case"pitchBend":(l=224|t.channel)!==r&&e.writeUInt8(l);var c=8192+t.value;e.writeUInt8(127&c),e.writeUInt8(c>>7&127);break;default:throw"Unrecognized event type: "+i}return l}(a,t[i],o,n.useByte9ForNoteOff);e.writeChunk("MTrk",a.buffer)}(d,l[s],t);return d.buffer};class i{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ip",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.data=e,this.ip=t}readString(e){let t=String.fromCharCode(...Array.from(this.data.subarray(this.ip,this.ip+=e))),r=t.indexOf("\0");return r>0?t.substring(0,r):t}readWORD(){return this.data[this.ip++]|this.data[this.ip++]<<8}readDWORD(e=!1){return e?(this.data[this.ip++]<<24|this.data[this.ip++]<<16|this.data[this.ip++]<<8|this.data[this.ip++])>>>0:(this.data[this.ip++]|this.data[this.ip++]<<8|this.data[this.ip++]<<16|this.data[this.ip++]<<24)>>>0}readByte(){return this.data[this.ip++]}readAt(e){return this.data[this.ip+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}}function a(e,t,r){let n=new i(e,t);return new o(n.readString(4),n.readDWORD(r),n.ip)}function s(e,t=0,r,{padding:n=!0,bigEndian:i=!1}={}){let o=[],l=r+t,u=t;for(;u<l;){let r=a(e,u,i);u=r.offset+r.size,n&&1==(u-t&1)&&u++,o.push(r)}return o}class o{constructor(e,t,r){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.type=e,this.size=t,this.offset=r}}let l=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];class u{constructor(){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}static parse(e){let t=new u;return t.major=e.readInt8(),t.minor=e.readInt8(),t}}class d{constructor(){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}static parse(e,t){function r(e){return t.find(t=>t.type===e)}function n(t){return new i(e,t.offset)}function a(e){let t=r(e);return t?n(t).readString(t.size):null}function s(e){let t=r(e);return t?u.parse(n(t)):null}let o=new d;return o.comment=a("ICMT"),o.copyright=a("ICOP"),o.creationDate=a("ICRD"),o.engineer=a("IENG"),o.name=a("INAM"),o.product=a("IPRD"),o.software=a("ISFT"),o.version=s("ifil"),o.soundEngine=a("isng"),o.romName=a("irom"),o.romVersion=s("iver"),o}}class c{constructor(){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}static parse(e){let t=new c;return t.generatorIndex=e.readWORD(),t.modulatorIndex=e.readWORD(),t}}class h{constructor(){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return"EOP"===this.presetName}static parse(e){let t=new h;return t.presetName=e.readString(20),t.preset=e.readWORD(),t.bank=e.readWORD(),t.presetBagIndex=e.readWORD(),t.library=e.readDWORD(),t.genre=e.readDWORD(),t.morphology=e.readDWORD(),t}}class f{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){return new f(e.readByte(),e.readByte())}}class p{constructor(){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get type(){return l[this.destinationOper]}get isEnd(){return 0===this.sourceOper&&0===this.destinationOper&&0===this.value&&0===this.amountSourceOper&&0===this.transOper}static parse(e){let t=new p;switch(t.sourceOper=e.readWORD(),t.destinationOper=e.readWORD(),t.type){case"keyRange":case"velRange":case"keynum":case"velocity":t.value=f.parse(e);break;default:t.value=e.readInt16()}return t.amountSourceOper=e.readWORD(),t.transOper=e.readWORD(),t}}class m{constructor(){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get type(){return l[this.code]}get isEnd(){return 0===this.code&&0===this.value}static parse(e){let t=new m;switch(t.code=e.readWORD(),t.type){case"keynum":case"keyRange":case"velRange":case"velocity":t.value=f.parse(e);break;default:t.value=e.readInt16()}return t}}class b{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return"EOI"===this.instrumentName}static parse(e){let t=new b;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}}class g{constructor(){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return"EOS"===this.sampleName}static parse(e,t){let r=new g;return r.sampleName=e.readString(20),r.start=e.readDWORD(),r.end=e.readDWORD(),r.loopStart=e.readDWORD(),r.loopEnd=e.readDWORD(),r.sampleRate=e.readDWORD(),r.originalPitch=e.readByte(),r.pitchCorrection=e.readInt8(),r.sampleLink=e.readWORD(),r.sampleType=e.readWORD(),t||(r.loopStart-=r.start,r.loopEnd-=r.start),r}}function y(e,t,r,n,a={}){if(e.type!==r)throw Error("invalid chunk type:"+e.type);let o=new i(t,e.offset),l=o.readString(4);if(l!==n)throw Error("invalid signature:"+l);return s(t,o.ip,e.size-4,a)}function v(e,t,r,n,a,s){let o=[];if(e.type!==r)throw Error("invalid chunk type:"+e.type);let l=new i(t,e.offset),u=e.offset+e.size;for(;l.ip<u;){let e=n.parse(l,s);if(a&&a(e))break;o.push(e)}return o}let w=(e,t)=>v(e,t,"phdr",h,e=>e.isEnd),I=(e,t)=>v(e,t,"pbag",c),O=(e,t)=>v(e,t,"inst",b,e=>e.isEnd),T=(e,t)=>v(e,t,"ibag",c),k=(e,t)=>v(e,t,"pmod",p,e=>e.isEnd),P=(e,t)=>v(e,t,"imod",p,e=>e.isEnd),S=(e,t)=>v(e,t,"pgen",m,e=>e.isEnd),U=(e,t)=>v(e,t,"igen",m),E=(e,t,r)=>v(e,t,"shdr",g,e=>e.isEnd,r);function N(e){let t={};for(let r of e){let e=r.type;void 0!==e&&(t[e]=r.value)}return t}let M={keynum:void 0,instrument:void 0,velocity:void 0,exclusiveClass:void 0,keyRange:new f(0,127),velRange:new f(0,127),sampleID:void 0,delayVolEnv:-12e3,attackVolEnv:-12e3,decayVolEnv:-12e3,holdVolEnv:-12e3,sustainVolEnv:0,releaseVolEnv:-12e3,delayModEnv:-12e3,attackModEnv:-12e3,decayModEnv:-12e3,holdModEnv:-12e3,sustainModEnv:0,releaseModEnv:-12e3,modEnvToPitch:0,modEnvToFilterFc:0,modLfoToFilterFc:0,modLfoToPitch:0,modLfoToVolume:0,vibLfoToPitch:0,chorusEffectsSend:0,reverbEffectsSend:0,delayModLFO:0,freqModLFO:0,delayVibLFO:0,keynumToModEnvDecay:0,keynumToModEnvHold:0,keynumToVolEnvDecay:0,keynumToVolEnvHold:0,coarseTune:0,fineTune:0,scaleTuning:100,freqVibLFO:0,startAddrsOffset:0,startAddrsCoarseOffset:0,endAddrsOffset:0,endAddrsCoarseOffset:0,startloopAddrsOffset:0,startloopAddrsCoarseOffset:0,initialAttenuation:0,endloopAddrsOffset:0,endloopAddrsCoarseOffset:0,overridingRootKey:void 0,initialFilterQ:1,initialFilterFc:13500,sampleModes:0,pan:0};class R{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.parsed=e}getGenerators(e,t,r,n){let i=Array(n-r);for(let a=r;a<n;a++){let n=t[a].generatorIndex,s=t[a+1].generatorIndex;i[a-r]=e.slice(n,s)}return i}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],r=this.parsed.presetHeaders[e+1],n=r?r.presetBagIndex:this.parsed.presetZone.length-1;return this.getGenerators(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,n)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],r=this.parsed.instruments[e+1],n=r?r.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGenerators(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,n)}getInstrumentKey(e,t,r,n=100){let i,a,s;let o=this.parsed.presetHeaders.findIndex(r=>r.preset===t&&r.bank===e);if(o<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let l=this.getPresetGenerators(o);for(let e=0;e<l.length;e++){let t=N(l[e]);if(void 0===t.instrument){i=t;continue}if(t.keyRange&&!t.keyRange.in(r)||t.velRange&&!t.velRange.in(n))continue;let o=this.getInstrumentGenerators(t.instrument);for(let e=0;e<o.length;e++){let t=N(o[e]);if(void 0!==t.sampleID){if((!t.keyRange||t.keyRange.in(r))&&(!t.velRange||t.velRange.in(n))){s=t;break}}else a=t}if(s)break}if(!s)return console.warn("instrument not found: bank=%s instrument=%s",e,t),null;if(void 0===s.sampleID)throw Error("Invalid SoundFont: sampleID not found");let u={...M,...x(i||{}),...x(a||{}),...x(s)},d=this.parsed.samples[u.sampleID],c=this.parsed.sampleHeaders[u.sampleID],h=u.coarseTune+u.fineTune/100+c.pitchCorrection/100-(u.overridingRootKey||c.originalPitch),f=u.scaleTuning/100;return{sample:d,sampleRate:c.sampleRate,sampleName:c.sampleName,sampleModes:u.sampleModes,playbackRate:e=>Math.pow(Math.pow(2,1/12),(e+h)*f),modLfoToPitch:u.modLfoToPitch,vibLfoToPitch:u.vibLfoToPitch,modEnvToPitch:u.modEnvToPitch,initialFilterFc:u.initialFilterFc,initialFilterQ:u.initialFilterQ,modLfoToFilterFc:u.modLfoToFilterFc,modEnvToFilterFc:u.modEnvToFilterFc,modLfoToVolume:u.modLfoToVolume,scaleTuning:f,start:32768*u.startAddrsCoarseOffset+u.startAddrsOffset,end:32768*u.endAddrsCoarseOffset+u.endAddrsOffset,loopStart:c.loopStart+32768*u.startloopAddrsCoarseOffset+u.startloopAddrsOffset,loopEnd:c.loopEnd+32768*u.endloopAddrsCoarseOffset+u.endloopAddrsOffset,volDelay:B(u.delayVolEnv),volAttack:B(u.attackVolEnv),volHold:B(u.holdVolEnv),volDecay:B(u.decayVolEnv),volSustain:u.sustainVolEnv/1e3,volRelease:B(u.releaseVolEnv),modDelay:B(u.delayModEnv),modAttack:B(u.attackModEnv),modHold:B(u.holdModEnv),modDecay:B(u.decayModEnv),modSustain:u.sustainModEnv/1e3,modRelease:B(u.releaseModEnv),keyRange:u.keyRange,velRange:u.velRange,delayModLFO:B(u.delayModLFO),freqModLFO:u.freqModLFO,delayVibLFO:B(u.delayVibLFO),freqVibLFO:u.freqVibLFO,initialAttenuation:u.initialAttenuation,pan:u.pan}}getPresetNames(){let e={};return this.parsed.presetHeaders.forEach(t=>{e[t.bank]||(e[t.bank]={}),e[t.bank][t.preset]=t.presetName}),e}}function B(e){return Math.pow(2,e/1200)}function x(e){let t={};for(let r in e)void 0!==e[r]&&(t[r]=e[r]);return t}class F{bufferSource;gainNode;filterNode;modLFO;modLFOGain;constructor(e,t,r,n){this.noteNumber=e,this.velocity=t,this.startTime=r,this.instrumentKey=n}}class V{ticksPerBeat=120;totalTime=0;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=this.initSoundFontTable();isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;timeline=[];instruments=[];notePromises=[];static channelSettings={volume:100/127,pan:64,bank:0,dataMSB:0,dataLSB:0,program:0,pitchBend:0,modulationDepthRange:.5};static effectSettings={expression:1,modulation:0,sustainPedal:!1,rpnMSB:127,rpnLSB:127,pitchBendRange:2};constructor(e){this.audioContext=e,this.masterGain=new GainNode(e),this.masterGain.connect(e.destination),this.channels=this.createChannels(e),this.GM1SystemOn()}initSoundFontTable(){let e=Array(128);for(let t=0;t<128;t++)e[t]=new Map;return e}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e),e.parsed.presetHeaders.forEach(e=>{e.presetName.startsWith("\0")||this.soundFontTable[e.preset].set(e.bank,t)})}async loadSoundFont(e){let t=await fetch(e),r=new R(function(e,t={}){var r,n,i,o,l;let u=s(e,0,e.length,t);if(1!==u.length)throw Error("wrong chunk length");let c=u[0];if(null===c)throw Error("chunk not found");let h=function(e,t,r={}){let n=y(e,t,"RIFF","sfbk",r);if(3!==n.length)throw Error("invalid sfbk structure");let i=function(e,t){let r=y(e,t,"LIST","INFO");return d.parse(t,r)}(n[0],t),s=3===i.version.major;return s&&"LIST"!==n[2].type&&(n[2]=a(t,n[2].offset-9,!1)),{info:i,samplingData:function(e,t){let r=y(e,t,"LIST","sdta");return{offsetMSB:r[0].offset,offsetLSB:r[1]?.offset}}(n[1],t),...function(e,t,r){let n=y(e,t,"LIST","pdta");if(9!==n.length)throw Error("invalid pdta chunk");return{presetHeaders:w(n[0],t),presetZone:I(n[1],t),presetModulators:k(n[2],t),presetGenerators:S(n[3],t),instruments:O(n[4],t),instrumentZone:T(n[5],t),instrumentModulators:P(n[6],t),instrumentGenerators:U(n[7],t),sampleHeaders:E(n[8],t,r)}}(n[2],t,s)}}(c,e,t),f=3===h.info.version.major;return{...h,samples:(r=h.sampleHeaders,n=h.samplingData.offsetMSB,i=h.samplingData.offsetLSB,o=e,l=f,r.map(e=>{let{start:t,end:r}=e;return l||(t*=2,r*=2),new Uint8Array(o.subarray(n+t,n+r))}))}}(new Uint8Array(await t.arrayBuffer())));this.addSoundFont(r)}async loadMIDI(e){let t=await fetch(e),r=n(new Uint8Array(await t.arrayBuffer()));this.ticksPerBeat=r.header.ticksPerBeat;let i=this.extractMidiData(r);this.instruments=i.instruments,this.timeline=i.timeline,this.totalTime=this.calcTotalTime()}setChannelAudioNodes(e){let{gainLeft:t,gainRight:r}=this.panToGain(this.constructor.channelSettings.pan),n=new GainNode(e,{gain:t}),i=new GainNode(e,{gain:r}),a=new ChannelMergerNode(e,{numberOfInputs:2});return n.connect(a,0,0),i.connect(a,0,1),{gainL:n,gainR:i,merger:a}}createChannels(e){return Array.from({length:16},()=>({...this.constructor.channelSettings,...this.constructor.effectSettings,...this.setChannelAudioNodes(e),scheduledNotes:new Map}))}async createNoteBuffer(e,t){let r=e.sample.length+e.end;if(t){let t=new Uint8Array(e.sample.length);t.set(e.sample);let n=await this.audioContext.decodeAudioData(t.buffer);for(let e=0;e<n.numberOfChannels;e++){let t=n.getChannelData(e);t.set(t.subarray(0,r))}return n}{let t=e.sample.subarray(0,r),n=this.convertToFloat32Array(t),i=new AudioBuffer({numberOfChannels:1,length:t.length,sampleRate:e.sampleRate});return i.getChannelData(0).set(n),i}}async createNoteBufferNode(e,t){let r=new AudioBufferSourceNode(this.audioContext);return r.buffer=await this.createNoteBuffer(e,t),r.loop=e.sampleModes%2!=0,r.loop&&(r.loopStart=e.loopStart/e.sampleRate,r.loopEnd=e.loopEnd/e.sampleRate),r}convertToFloat32Array(e){let t=new Int16Array(e.buffer),r=new Float32Array(t.length);for(let e=0;e<t.length;e++)r[e]=t[e]/32768;return r}async scheduleTimelineEvents(e,t,r){for(;r<this.timeline.length;){let n=this.timeline[r];if(n.startTime>e+this.lookAhead)break;switch(n.type){case"noteOn":if(0!==n.velocity){await this.scheduleNoteOn(n.channel,n.noteNumber,n.velocity,n.startTime+this.startDelay-t);break}case"noteOff":{let e=this.scheduleNoteRelease(n.channel,n.noteNumber,n.velocity,n.startTime+this.startDelay-t);e&&this.notePromises.push(e);break}case"controller":this.handleControlChange(n.channel,n.controllerType,n.value);break;case"programChange":this.handleProgramChange(n.channel,n.programNumber);break;case"pitchBend":this.setPitchBend(n.channel,n.value);break;case"sysEx":this.handleSysEx(n.data)}r++}return r}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}playNotes(){return new Promise(e=>{this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let t=this.getQueueIndex(this.resumeTime),r=this.resumeTime-this.startTime;this.notePromises=[];let n=async()=>{if(t>=this.timeline.length){await Promise.all(this.notePromises),this.notePromises=[],e();return}let i=this.audioContext.currentTime+r;if(t=await this.scheduleTimelineEvents(i,r,t),this.isPausing){await this.stopNotes(),this.notePromises=[],e(),this.isPausing=!1,this.isPaused=!0;return}if(this.isStopping){await this.stopNotes(),this.notePromises=[],e(),this.isStopping=!1,this.isPaused=!1;return}if(this.isSeeking)this.stopNotes(),this.startTime=this.audioContext.currentTime,t=this.getQueueIndex(this.resumeTime),r=this.resumeTime-this.startTime,this.isSeeking=!1,await n();else{let e=this.audioContext.currentTime+this.noteCheckInterval;await this.scheduleTask(()=>{},e),await n()}};n()})}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}extractMidiData(e){let t=new Set,r=[],n=Array(16);for(let e=0;e<n.length;e++)n[e]={programNumber:-1,bank:this.channels[e].bank};e.tracks.forEach(e=>{let i=0;e.forEach(e=>{switch(i+=e.deltaTime,e.ticks=i,e.type){case"noteOn":{let r=n[e.channel];r.programNumber<0&&(t.add(`${r.bank}:0`),r.programNumber=0);break}case"programChange":{let r=n[e.channel];r.programNumber=e.programNumber,t.add(`${r.bankNumber}:${r.programNumber}`)}}delete e.deltaTime,r.push(e)})});let i={controller:0,sysEx:1};r.sort((e,t)=>e.ticks!==t.ticks?e.ticks-t.ticks:(i[e.type]||2)-(i[t.type]||2));let a=0,s=0,o=.5;for(let e=0;e<r.length;e++){let t=r[e],n=this.ticksToSecond(t.ticks-s,o);t.startTime=a+n,"setTempo"===t.type&&(a+=this.ticksToSecond(t.ticks-s,o),o=t.microsecondsPerBeat/1e6,s=t.ticks)}return{instruments:t,timeline:r}}stopNotes(){let e=this.audioContext.currentTime;return this.channels.forEach((t,r)=>{t.scheduledNotes.forEach(t=>{t.forEach(t=>{if(t){let n=this.scheduleNoteRelease(r,t.noteNumber,0,e,!0);this.notePromises.push(n)}})}),t.scheduledNotes.clear()}),Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,await this.playNotes(),this.isPlaying=!1)}stop(){this.isPlaying&&(this.isStopping=!0)}pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}async resume(){this.isPaused&&(await this.playNotes(),this.isPlaying=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let r=this.timeline[t];e<r.startTime&&(e=r.startTime)}return e}currentTime(){let e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}getActiveNotes(e,t){let r=new Map;return e.scheduledNotes.forEach(e=>{let n=this.getActiveNote(e,t);n&&r.set(n.noteNumber,n)}),r}getActiveNote(e,t){for(let r=e.length-1;r>=0;r--){let n=e[r];if(!n)return;if(!(t<n.startTime))return n.ending?null:n}return e[0]}connectEffects(e,t){t.connect(e.merger),merger.connect(this.masterGain)}cbToRatio(e){return Math.pow(10,e/200)}centToHz(e){return 8.176*Math.pow(2,e/1200)}calcSemitoneOffset(e){return e.pitchBend*e.pitchBendRange}calcPlaybackRate(e,t,r){return e.playbackRate(t)*Math.pow(2,r/12)}setVolumeEnvelope(e,t){let{instrumentKey:r,startTime:n,velocity:i}=t;t.gainNode=new GainNode(this.audioContext,{gain:0});let a=i/127*e.volume*e.expression;0===a&&(a=1e-6);let s=this.cbToRatio(-r.initialAttenuation)*a,o=s*(1-r.volSustain),l=n+r.volDelay,u=l+r.volAttack,d=u+r.volHold,c=d+r.volDecay;t.gainNode.gain.setValueAtTime(1e-6,l).exponentialRampToValueAtTime(s,u).setValueAtTime(s,d).linearRampToValueAtTime(o,c)}setFilterEnvelope(e,t){let{instrumentKey:r,startTime:n,noteNumber:i}=t,a=1-(.1+i/127*.2)*e.softPedal,s=this.audioContext.sampleRate/2,o=this.centToHz(r.initialFilterFc)*a,l=this.centToHz(r.initialFilterFc+r.modEnvToFilterFc)*a,u=(o+(l-o)*(1-r.modSustain))*a,d=n+r.modDelay,c=d+r.modAttack,h=c+r.modHold,f=h+r.modDecay,p=Math.min(s,o),m=Math.min(s,l),b=Math.min(s,u);t.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:r.initialFilterQ/10,frequency:p}),t.filterNode.frequency.setValueAtTime(p,d).exponentialRampToValueAtTime(m,c).setValueAtTime(m,h).linearRampToValueAtTime(b,f),t.bufferSource.detune.setValueAtTime(t.bufferSource.detune.value+r.modEnvToPitch,d)}startModulation(e,t,r){let{instrumentKey:n}=t;t.modLFOGain=new GainNode(this.audioContext,{gain:this.cbToRatio(n.modLfoToVolume+e.modulation)}),t.modLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(n.freqModLFO)}),t.modLFO.start(r),t.filterNode.frequency.setValueAtTime(t.filterNode.frequency.value+n.modLfoToFilterFc,r),t.bufferSource.detune.setValueAtTime(t.bufferSource.detune.value+n.modLfoToPitch,r),t.modLFO.connect(t.modLFOGain),t.modLFOGain.connect(t.bufferSource.detune)}async createNote(e,t,r,n,i,a){let s=this.calcSemitoneOffset(e),o=new F(r,n,i,t);if(o.bufferSource=await this.createNoteBufferNode(t,a),o.bufferSource.playbackRate.value=this.calcPlaybackRate(t,r,s),this.setVolumeEnvelope(e,o),this.setFilterEnvelope(e,o),e.modulation>0){let r=i+t.delayModLFO;this.startModulation(e,o,r)}return o.bufferSource.connect(o.filterNode),o.filterNode.connect(o.gainNode),o.bufferSource.start(i,t.start/t.sampleRate),o}async scheduleNoteOn(e,t,r,n){let i=this.channels[e],a=i.bank,s=this.soundFontTable[i.program].get(a);if(void 0===s)return;let o=this.soundFonts[s],l=3===o.parsed.info.version.major,u=o.getInstrumentKey(a,i.program,t);if(!u)return;let d=await this.createNote(i,u,t,r,n,l);this.connectEffects(i,d.gainNode);let c=i.scheduledNotes;c.has(t)?c.get(t).push(d):c.set(t,[d])}noteOn(e,t,r){let n=this.audioContext.currentTime;return this.scheduleNoteOn(e,t,r,n)}scheduleNoteRelease(e,t,r,n,i=!1){let a=this.channels[e];if(i&&a.sustainPedal||!a.scheduledNotes.has(t))return;let s=a.scheduledNotes.get(t);for(let e=0;e<s.length;e++){let t=s[e];if(!t||t.ending)continue;let i=(r+127)/127,a=n+t.instrumentKey.volRelease*i;t.gainNode.gain.cancelScheduledValues(n).linearRampToValueAtTime(0,a);let o=Math.min(this.audioContext.sampleRate/2,this.centToHz(t.instrumentKey.initialFilterFc)),l=n+t.instrumentKey.modRelease*i;return t.filterNode.frequency.cancelScheduledValues(n).linearRampToValueAtTime(o,l),t.ending=!0,this.scheduleTask(()=>{t.bufferSource.loop=!1},n),new Promise(r=>{t.bufferSource.onended=()=>{s[e]=null,t.bufferSource.disconnect(),t.filterNode.disconnect(),t.gainNode.disconnect(),t.modLFOGain&&t.modLFOGain.disconnect(),t.modLFO&&t.modLFO.stop(),r()},bufferSource.stop(a)})}}releaseNote(e,t,r){let n=this.audioContext.currentTime;return this.scheduleNoteRelease(e,t,r,n)}releaseSustainPedal(e,t){let r=2*t,n=this.channels[e],i=[];return n.sustainPedal=!1,n.scheduledNotes.forEach(t=>{t.forEach(t=>{if(t){let{noteNumber:n}=t,a=this.releaseNote(e,n,r);i.push(a)}})}),i}handleMIDIMessage(e,t,r){let n=15&e,i=240&e;switch(i){case 128:return this.releaseNote(n,t,r);case 144:return this.noteOn(n,t,r);case 176:return this.handleControlChange(n,t,r);case 192:return this.handleProgramChange(n,t);case 224:return this.handlePitchBendMessage(n,t,r);default:console.warn(`Unsupported MIDI message: ${i.toString(16)}`)}}handleProgramChange(e,t){this.channels[e].program=t}handlePitchBendMessage(e,t,r){this.setPitchBend(e,128*r+t)}setPitchBend(e,t){let r=this.channels[e],n=r.pitchBend;r.pitchBend=(t-8192)/8192;let i=(r.pitchBend-n)*r.pitchBendRange*100;this.updateDetune(r,i)}handleControlChange(e,t,r){switch(t){case 1:return this.setModulation(e,r);case 6:return this.dataEntryMSB(e,r);case 7:return this.setVolume(e,r);case 10:return this.setPan(e,r);case 11:return this.setExpression(e,r);case 38:return this.dataEntryLSB(e,r);case 64:return this.setSustainPedal(e,r);case 100:return this.setRPNLSB(e,r);case 101:return this.setRPNMSB(e,r);case 120:return this.allSoundOff(e);case 121:return this.resetAllControllers(e);case 123:return this.allNotesOff(e);default:console.warn(`Unsupported Control change: controller=${t} value=${r}`)}}updateModulation(e){let t=this.audioContext.currentTime;this.getActiveNotes(e,t).forEach(r=>{if(r.modLFO){let{gainNode:n,instrumentKey:i}=r;n.gain.setValueAtTime(this.cbToRatio(i.modLfoToVolume+e.modulation),t)}else this.startModulation(e,r,t)})}setModulation(e,t){let r=this.channels[e];r.modulation=t/127*r.modulationDepthRange,this.updateModulation(r)}setVolume(e,t){let r=this.channels[e];r.volume=t/127,this.updateChannelGain(r)}panToGain(e){let t=Math.PI/2*Math.max(0,e-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t){let r=this.channels[e];r.pan=t,this.updateChannelGain(r)}setExpression(e,t){let r=this.channels[e];r.expression=t/127,this.updateChannelGain(r)}dataEntryLSB(e,t){this.channels[e].dataLSB=t,this.handleRPN(e)}updateChannelGain(e){let t=this.audioContext.currentTime,r=e.volume*e.expression,{gainLeft:n,gainRight:i}=this.panToGain(e.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(r*n,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(r*i,t)}setSustainPedal(e,t){let r=t>=64;this.channels[e].sustainPedal=r,r||this.releaseSustainPedal(e,t)}handleRPN(e){let t=this.channels[e];128*t.rpnMSB+t.rpnLSB===0?this.handlePitchBendRangeRPN(e):console.warn(`Channel ${e}: Unsupported RPN MSB=${t.rpnMSB} LSB=${t.rpnLSB}`)}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t){this.channels[e].dataMSB=t,this.handleRPN(e)}updateDetune(e,t){let r=this.audioContext.currentTime;this.getActiveNotes(e,r).forEach(e=>{let{bufferSource:n}=e,i=n.detune.value+t;n.detune.cancelScheduledValues(r).setValueAtTime(i,r)})}handlePitchBendRangeRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,99);let r=t.dataMSB+t.dataLSB/100;this.setPitchBendRange(e,r)}setPitchBendRange(e,t){let r=this.channels[e],n=r.pitchBendRange;r.pitchBendRange=t;let i=(r.pitchBendRange-n)*r.pitchBend*100;this.updateDetune(r,i)}allSoundOff(e){let t=this.audioContext.currentTime,r=this.channels[e],n=[];return r.scheduledNotes.forEach(r=>{if(this.getActiveNote(r,t)){let r=this.scheduleNoteRelease(e,noteNumber,0,t,!0);n.push(r)}}),n}resetAllControllers(e){Object.assign(this.channels[e],this.effectSettings)}allNotesOff(e){let t=this.audioContext.currentTime,r=this.channels[e],n=[];return r.scheduledNotes.forEach(r=>{if(this.getActiveNote(r,t)){let r=this.scheduleNoteRelease(e,noteNumber,0,t,!1);n.push(r)}}),n}handleUniversalNonRealTimeExclusiveMessage(e){if(9===e[2])switch(e[3]){case 1:this.GM1SystemOn();break;case 2:break;default:console.warn(`Unsupported Exclusive Message ${e}`)}else console.warn(`Unsupported Exclusive Message ${e}`)}GM1SystemOn(){this.channels.forEach(e=>{e.bankMSB=0,e.bankLSB=0,e.bank=0}),this.channels[9].bankMSB=1,this.channels[9].bank=128}handleUniversalRealTimeExclusiveMessage(e){if(4===e[2]){if(1===e[3])return this.handleMasterVolumeSysEx(e);console.warn(`Unsupported Exclusive Message ${e}`)}else console.warn(`Unsupported Exclusive Message ${e}`)}handleMasterVolumeSysEx(e){let t=(128*e[5]+e[4])/16383;this.setMasterVolume(t)}setMasterVolume(e){if(e<0&&1<e)console.error("Master Volume is out of range");else{let t=this.audioContext.currentTime;this.masterGain.gain.cancelScheduledValues(t),this.masterGain.gain.setValueAtTime(e*e,t)}}handleExclusiveMessage(e){console.warn(`Unsupported Exclusive Message ${e}`)}handleSysEx(e){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e);case 127:return this.handleUniversalRealTimeExclusiveMessage(e);default:return this.handleExclusiveMessage(e)}}scheduleTask(e,t){return new Promise(r=>{let n=new AudioBufferSourceNode(this.audioContext);n.onended=()=>{e(),r()},n.start(t),n.stop(t)})}}export{V as MidyGMLite};