var Ee=Object.create;var le=Object.defineProperty;var Ve=Object.getOwnPropertyDescriptor;var De=Object.getOwnPropertyNames;var Ce=Object.getPrototypeOf,Be=Object.prototype.hasOwnProperty;var X=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var Ue=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of De(e))!Be.call(o,s)&&s!==t&&le(o,s,{get:()=>e[s],enumerable:!(r=Ve(e,s))||r.enumerable});return o};var Ne=(o,e,t)=>(t=o!=null?Ee(Ce(o)):{},Ue(e||!o||!o.__esModule?le(t,"default",{value:o,enumerable:!0}):t,o));var de=X((gt,ue)=>{function Ae(o){var e=new w(o),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var r=Le(t.data),s=[],a=0;!e.eof()&&a<r.numTracks;a++){var n=e.readChunk();if(n.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+n.id+"'";var c=Re(n.data);s.push(c)}return{header:r,tracks:s}}function Le(o){var e=new w(o),t=e.readUInt16(),r=e.readUInt16(),s={format:t,numTracks:r},a=e.readUInt16();return a&32768?(s.framesPerSecond=256-(a>>8),s.ticksPerFrame=a&255):s.ticksPerBeat=a,s}function Re(o){for(var e=new w(o),t=[];!e.eof();){var r=a();t.push(r)}return t;var s;function a(){var n={};n.deltaTime=e.readVarInt();var c=e.readUInt8();if((c&240)===240)if(c===255){n.meta=!0;var l=e.readUInt8(),u=e.readVarInt();switch(l){case 0:if(n.type="sequenceNumber",u!==2)throw"Expected length for sequenceNumber event is 2, got "+u;return n.number=e.readUInt16(),n;case 1:return n.type="text",n.text=e.readString(u),n;case 2:return n.type="copyrightNotice",n.text=e.readString(u),n;case 3:return n.type="trackName",n.text=e.readString(u),n;case 4:return n.type="instrumentName",n.text=e.readString(u),n;case 5:return n.type="lyrics",n.text=e.readString(u),n;case 6:return n.type="marker",n.text=e.readString(u),n;case 7:return n.type="cuePoint",n.text=e.readString(u),n;case 32:if(n.type="channelPrefix",u!=1)throw"Expected length for channelPrefix event is 1, got "+u;return n.channel=e.readUInt8(),n;case 33:if(n.type="portPrefix",u!=1)throw"Expected length for portPrefix event is 1, got "+u;return n.port=e.readUInt8(),n;case 47:if(n.type="endOfTrack",u!=0)throw"Expected length for endOfTrack event is 0, got "+u;return n;case 81:if(n.type="setTempo",u!=3)throw"Expected length for setTempo event is 3, got "+u;return n.microsecondsPerBeat=e.readUInt24(),n;case 84:if(n.type="smpteOffset",u!=5)throw"Expected length for smpteOffset event is 5, got "+u;var d=e.readUInt8(),h={0:24,32:25,64:29,96:30};return n.frameRate=h[d&96],n.hour=d&31,n.min=e.readUInt8(),n.sec=e.readUInt8(),n.frame=e.readUInt8(),n.subFrame=e.readUInt8(),n;case 88:if(n.type="timeSignature",u!=2&&u!=4)throw"Expected length for timeSignature event is 4 or 2, got "+u;return n.numerator=e.readUInt8(),n.denominator=1<<e.readUInt8(),u===4?(n.metronome=e.readUInt8(),n.thirtyseconds=e.readUInt8()):(n.metronome=36,n.thirtyseconds=8),n;case 89:if(n.type="keySignature",u!=2)throw"Expected length for keySignature event is 2, got "+u;return n.key=e.readInt8(),n.scale=e.readUInt8(),n;case 127:return n.type="sequencerSpecific",n.data=e.readBytes(u),n;default:return n.type="unknownMeta",n.data=e.readBytes(u),n.metatypeByte=l,n}}else if(c==240){n.type="sysEx";var u=e.readVarInt();return n.data=e.readBytes(u),n}else if(c==247){n.type="endSysEx";var u=e.readVarInt();return n.data=e.readBytes(u),n}else throw"Unrecognised MIDI event type byte: "+c;else{var p;if((c&128)===0){if(s===null)throw"Running status byte encountered before status byte";p=c,c=s,n.running=!0}else p=e.readUInt8(),s=c;var m=c>>4;switch(n.channel=c&15,m){case 8:return n.type="noteOff",n.noteNumber=p,n.velocity=e.readUInt8(),n;case 9:var v=e.readUInt8();return n.type=v===0?"noteOff":"noteOn",n.noteNumber=p,n.velocity=v,v===0&&(n.byte9=!0),n;case 10:return n.type="noteAftertouch",n.noteNumber=p,n.amount=e.readUInt8(),n;case 11:return n.type="controller",n.controllerType=p,n.value=e.readUInt8(),n;case 12:return n.type="programChange",n.programNumber=p,n;case 13:return n.type="channelAftertouch",n.amount=p,n;case 14:return n.type="pitchBend",n.value=p+(e.readUInt8()<<7)-8192,n;default:throw"Unrecognised MIDI event type: "+m}}}}function w(o){this.buffer=o,this.bufferLen=this.buffer.length,this.pos=0}w.prototype.eof=function(){return this.pos>=this.bufferLen};w.prototype.readUInt8=function(){var o=this.buffer[this.pos];return this.pos+=1,o};w.prototype.readInt8=function(){var o=this.readUInt8();return o&128?o-256:o};w.prototype.readUInt16=function(){var o=this.readUInt8(),e=this.readUInt8();return(o<<8)+e};w.prototype.readInt16=function(){var o=this.readUInt16();return o&32768?o-65536:o};w.prototype.readUInt24=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(o<<16)+(e<<8)+t};w.prototype.readInt24=function(){var o=this.readUInt24();return o&8388608?o-16777216:o};w.prototype.readUInt32=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),r=this.readUInt8();return(o<<24)+(e<<16)+(t<<8)+r};w.prototype.readBytes=function(o){var e=this.buffer.slice(this.pos,this.pos+o);return this.pos+=o,e};w.prototype.readString=function(o){var e=this.readBytes(o);return String.fromCharCode.apply(null,e)};w.prototype.readVarInt=function(){for(var o=0;!this.eof();){var e=this.readUInt8();if(e&128)o+=e&127,o<<=7;else return o+e}return o};w.prototype.readChunk=function(){var o=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:o,length:e,data:t}};ue.exports=Ae});var fe=X((bt,he)=>{function je(o,e){if(typeof o!="object")throw"Invalid MIDI data";e=e||{};var t=o.header||{},r=o.tracks||[],s,a=r.length,n=new g;for(He(n,t,a),s=0;s<a;s++)Ge(n,r[s],e);return n.buffer}function He(o,e,t){var r=e.format==null?1:e.format,s=128;e.timeDivision?s=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?s=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(s=e.ticksPerBeat&32767);var a=new g;a.writeUInt16(r),a.writeUInt16(t),a.writeUInt16(s),o.writeChunk("MThd",a.buffer)}function Ge(o,e,t){var r=new g,s,a=e.length,n=null;for(s=0;s<a;s++)(t.running===!1||!t.running&&!e[s].running)&&(n=null),n=qe(r,e[s],n,t.useByte9ForNoteOff);o.writeChunk("MTrk",r.buffer)}function qe(o,e,t,r){var s=e.type,a=e.deltaTime,n=e.text||"",c=e.data||[],l=null;switch(o.writeVarInt(a),s){case"sequenceNumber":o.writeUInt8(255),o.writeUInt8(0),o.writeVarInt(2),o.writeUInt16(e.number);break;case"text":o.writeUInt8(255),o.writeUInt8(1),o.writeVarInt(n.length),o.writeString(n);break;case"copyrightNotice":o.writeUInt8(255),o.writeUInt8(2),o.writeVarInt(n.length),o.writeString(n);break;case"trackName":o.writeUInt8(255),o.writeUInt8(3),o.writeVarInt(n.length),o.writeString(n);break;case"instrumentName":o.writeUInt8(255),o.writeUInt8(4),o.writeVarInt(n.length),o.writeString(n);break;case"lyrics":o.writeUInt8(255),o.writeUInt8(5),o.writeVarInt(n.length),o.writeString(n);break;case"marker":o.writeUInt8(255),o.writeUInt8(6),o.writeVarInt(n.length),o.writeString(n);break;case"cuePoint":o.writeUInt8(255),o.writeUInt8(7),o.writeVarInt(n.length),o.writeString(n);break;case"channelPrefix":o.writeUInt8(255),o.writeUInt8(32),o.writeVarInt(1),o.writeUInt8(e.channel);break;case"portPrefix":o.writeUInt8(255),o.writeUInt8(33),o.writeVarInt(1),o.writeUInt8(e.port);break;case"endOfTrack":o.writeUInt8(255),o.writeUInt8(47),o.writeVarInt(0);break;case"setTempo":o.writeUInt8(255),o.writeUInt8(81),o.writeVarInt(3),o.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":o.writeUInt8(255),o.writeUInt8(84),o.writeVarInt(5);var u={24:0,25:32,29:64,30:96},d=e.hour&31|u[e.frameRate];o.writeUInt8(d),o.writeUInt8(e.min),o.writeUInt8(e.sec),o.writeUInt8(e.frame),o.writeUInt8(e.subFrame);break;case"timeSignature":o.writeUInt8(255),o.writeUInt8(88),o.writeVarInt(4),o.writeUInt8(e.numerator);var h=Math.floor(Math.log(e.denominator)/Math.LN2)&255;o.writeUInt8(h),o.writeUInt8(e.metronome),o.writeUInt8(e.thirtyseconds||8);break;case"keySignature":o.writeUInt8(255),o.writeUInt8(89),o.writeVarInt(2),o.writeInt8(e.key),o.writeUInt8(e.scale);break;case"sequencerSpecific":o.writeUInt8(255),o.writeUInt8(127),o.writeVarInt(c.length),o.writeBytes(c);break;case"unknownMeta":e.metatypeByte!=null&&(o.writeUInt8(255),o.writeUInt8(e.metatypeByte),o.writeVarInt(c.length),o.writeBytes(c));break;case"sysEx":o.writeUInt8(240),o.writeVarInt(c.length),o.writeBytes(c);break;case"endSysEx":o.writeUInt8(247),o.writeVarInt(c.length),o.writeBytes(c);break;case"noteOff":var p=r!==!1&&e.byte9||r&&e.velocity==0?144:128;l=p|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteOn":l=144|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteAftertouch":l=160|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.noteNumber),o.writeUInt8(e.amount);break;case"controller":l=176|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.controllerType),o.writeUInt8(e.value);break;case"programChange":l=192|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.programNumber);break;case"channelAftertouch":l=208|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.amount);break;case"pitchBend":l=224|e.channel,l!==t&&o.writeUInt8(l);var m=8192+e.value,v=m&127,M=m>>7&127;o.writeUInt8(v),o.writeUInt8(M);break;default:throw"Unrecognized event type: "+s}return l}function g(){this.buffer=[]}g.prototype.writeUInt8=function(o){this.buffer.push(o&255)};g.prototype.writeInt8=g.prototype.writeUInt8;g.prototype.writeUInt16=function(o){var e=o>>8&255,t=o&255;this.writeUInt8(e),this.writeUInt8(t)};g.prototype.writeInt16=g.prototype.writeUInt16;g.prototype.writeUInt24=function(o){var e=o>>16&255,t=o>>8&255,r=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(r)};g.prototype.writeInt24=g.prototype.writeUInt24;g.prototype.writeUInt32=function(o){var e=o>>24&255,t=o>>16&255,r=o>>8&255,s=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(r),this.writeUInt8(s)};g.prototype.writeInt32=g.prototype.writeUInt32;g.prototype.writeBytes=function(o){this.buffer=this.buffer.concat(Array.prototype.slice.call(o,0))};g.prototype.writeString=function(o){var e,t=o.length,r=[];for(e=0;e<t;e++)r.push(o.codePointAt(e));this.writeBytes(r)};g.prototype.writeVarInt=function(o){if(o<0)throw"Cannot write negative variable-length integer";if(o<=127)this.writeUInt8(o);else{var e=o,t=[];for(t.push(e&127),e>>=7;e;){var r=e&127|128;t.push(r),e>>=7}this.writeBytes(t.reverse())}};g.prototype.writeChunk=function(o,e){this.writeString(o),this.writeUInt32(e.length),this.writeBytes(e)};he.exports=je});var pe=X(Y=>{Y.parseMidi=de();Y.writeMidi=fe()});var Me=Ne(pe());var T=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,r=t+e,s=this.data,a=s.subarray(t,r).indexOf(0);a<0&&(a=e);let n=new Array(a);for(let c=0;c<a;c++)n[c]=s[t+c];return this.offset=r,String.fromCharCode(...n)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function te(o,e,t){let r=new T(o,e),s=r.readString(4),a=r.readDWORD(t);return new ee(s,a,r.offset)}function re(o,e=0,t,{padding:r=!0,bigEndian:s=!1}={}){let a=[],n=t+e,c=e;for(;c<n;){let l=te(o,c,s);c=l.offset+l.size,r&&(c-e&1)===1&&c++,a.push(l)}return a}var ee=class{constructor(e,t,r){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:r})}};var S=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var y=class o{constructor(e,t,r,s,a){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:a})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,r=e&127,s=e>>7&1,a=e>>8&1,n=e>>9&1;return new o(t,n,a,s,r)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var ne=class o{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),r=e.readInt8();return new o(t,r)}},L=class o{constructor(e,t,r,s,a,n,c,l,u,d,h){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:d}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:h})}static parse(e,t){function r(O){for(let P=0;P<t.length;P++)if(t[P].type===O)return t[P]}function s(O){return new T(e,O.offset)}function a(O){let P=r(O);return P?s(P).readString(P.size):null}function n(O){let P=r(O);return P?ne.parse(s(P)):null}let c=a("ICMT"),l=a("ICOP"),u=a("ICRD"),d=a("IENG"),h=a("INAM"),p=a("IPRD"),m=a("ISFT"),v=n("ifil"),M=a("isng"),N=a("irom"),A=n("iver");return new o(c,l,u,d,h,p,m,v,M,N,A)}},D=class o{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),r=e.readWORD();return new o(t,r)}},R=class o{constructor(e,t,r,s,a,n,c){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:c})}get isEnd(){let{presetName:e,preset:t,bank:r,library:s,genre:a,morphology:n}=this;return e==="EOP"||e===""&&t+r+s+a+n===0}static parse(e){let t=e.readString(20),r=e.readWORD(),s=e.readWORD(),a=e.readWORD(),n=e.readDWORD(),c=e.readDWORD(),l=e.readDWORD();return new o(t,r,s,a,n,c,l)}},F=class o{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),r=e.readByte();return new o(t,r)}},b=class o{constructor(e,t,r,s,a){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"amount",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:a})}transform(e){let t=this.amount*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),r=e.readWORD(),s=e.readInt16(),a=e.readWORD(),n=e.readWORD(),c=y.parse(t),l=y.parse(a);return new o(c,r,s,l,n)}},C=class o{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return S[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),r=S[t],s;switch(r){case"keyRange":case"velRange":s=F.parse(e);break;case"instrument":case"sampleID":s=e.readUInt16();break;default:s=e.readInt16();break}return new o(t,s)}},j=class o{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new o;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},H=class o{constructor(e,t,r,s,a,n,c,l,u,d){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:d})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let r=e.readString(20),s=e.readDWORD(),a=e.readDWORD(),n=e.readDWORD(),c=e.readDWORD(),l=e.readDWORD(),u=e.readByte(),d=e.readInt8(),h=e.readWORD(),p=e.readWORD();return t||(n-=s,c-=s),new o(r,s,a,n,c,l,u,d,h,p)}};var f=class{constructor(e,t,r){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=r}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};var We=["pcm16","pcm24","compressed"],Ke=new Set(We),G=class{constructor(e,t,r){if(Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Ke.has(e))throw new Error(`Invalid AudioDataType: ${e}`);this.type=e,this.sampleHeader=t,this.data=r}decodePCM(e){let{type:t}=this;if(t==="pcm16"){let s=e.byteLength/2,a=new Float32Array(s),n=new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);for(let c=0;c<s;c++)a[c]=n[c]/32768;return a}else{let s=e.byteLength/3,a=new Float32Array(s);for(let n=0;n<s;n++){let c=n*3,l=e[c]|e[c+1]<<8|e[c+2]<<16;l&8388608&&(l|=4278190080),a[n]=l/8388608}return a}}async toAudioBuffer(e,t,r){if(this.type==="compressed"){let s=this.data.slice().buffer;return await e.decodeAudioData(s)}else{let s=this.data.subarray(t,r),a=this.decodePCM(s),n=new AudioBuffer({numberOfChannels:1,length:a.length,sampleRate:this.sampleHeader.sampleRate});return n.getChannelData(0).set(a),n}}};function se(o,e={}){let t=re(o,0,o.length,e);if(t.length!==1)throw new Error("wrong chunk length");let r=t[0];if(r===null)throw new Error("chunk not found");function s(l,u,d={}){let h=q(l,u,"RIFF","sfbk",d);if(h.length!==3)throw new Error("invalid sfbk structure");let p=$e(h[0],u),m=p.version.major===3;return m&&h[2].type!=="LIST"&&(h[2]=te(u,h[2].offset-9,!1)),{info:p,samplingData:Ze(h[1],u),...a(h[2],u,m)}}function a(l,u,d){let h=q(l,u,"LIST","pdta");if(h.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:_e(h[0],u),presetZone:ze(h[1],u),presetModulators:Xe(h[2],u),presetGenerators:et(h[3],u),instruments:Qe(h[4],u),instrumentZone:Je(h[5],u),instrumentModulators:Ye(h[6],u),instrumentGenerators:tt(h[7],u),sampleHeaders:rt(h[8],u,d)}}let n=s(r,o,e),c=n.info.version.major===3;return{...n,samples:nt(n.sampleHeaders,n.samplingData.offsetMSB,n.samplingData.offsetLSB,o,c)}}function q(o,e,t,r,s={}){if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let a=new T(e,o.offset),n=a.readString(4);if(n!==r)throw new Error("invalid signature:"+n);return re(e,a.offset,o.size-4,s)}function $e(o,e){let t=q(o,e,"LIST","INFO");return L.parse(e,t)}function Ze(o,e){let t=q(o,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function k(o,e,t,r,s,a){let n=[];if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let c=new T(e,o.offset),l=o.offset+o.size;for(;c.offset<l;){let u=r.parse(c,a);if(s&&s(u))break;n.push(u)}return n}var _e=(o,e)=>k(o,e,"phdr",R,t=>t.isEnd),ze=(o,e)=>k(o,e,"pbag",D),Qe=(o,e)=>k(o,e,"inst",j,t=>t.isEnd),Je=(o,e)=>k(o,e,"ibag",D),Xe=(o,e)=>k(o,e,"pmod",b),Ye=(o,e)=>k(o,e,"imod",b),et=(o,e)=>k(o,e,"pgen",C,t=>t.isEnd),tt=(o,e)=>k(o,e,"igen",C),rt=(o,e,t)=>k(o,e,"shdr",H,r=>r.isEnd,t);function nt(o,e,t,r,s){let a=new Array(o.length),n=s?1:2,c=s?"compressed":t?"pcm24":"pcm16";for(let l=0;l<o.length;l++){let{start:u,end:d}=o[l],h=e+u*n,p=e+d*n,m=r.subarray(h,p);a[l]=new G(c,o[l],m)}return a}var be=new Map;for(let o=0;o<S.length;o++)be.set(S[o],o);var st=["instrument","sampleID"],ve=["keyRange","velRange"],we=["keynum","velocity"],xe=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],me=[...xe,...we],Ie=new Set;for(let o=0;o<me.length;o++){let e=me[o],t=be.get(e);t!==void 0&&Ie.add(t)}function Pe(o){let e={},t=Object.keys(o);for(let r of t){let s=o[r];if(B(r))e[r]=s;else{let a=s;e[r]=a.clamp(a.defaultValue)}}return e}var ye=[["keynum","keyRange"],["velocity","velRange"]],ot=new Set(ve);function B(o){return ot.has(o)}var at=new Set([...st,...ve,...we,...xe]);function it(){let o=[],e=S.length;for(let t=0;t<e;t++){let r=S[t];r!==void 0&&!at.has(r)&&o.push(r)}return o}var K=it(),ct=new Set(K);function oe(o){return ct.has(o)}function Se(o){let e={};for(let t=0;t<o.length;t++){let r=o[t],s=r.type;if(s!==void 0&&!Ie.has(r.code))if(B(s))e[s]=r.value;else{let a=s;e[a]=r.value}}return e}function Te(o){let e={};for(let t=0;t<o.length;t++){let r=o[t],s=r.type;if(s!==void 0)if(B(s))e[s]=r.value;else{let a=s;e[a]=r.value}}for(let t=0;t<ye.length;t++){let[r,s]=ye[t],a=e[r];a!==void 0&&(e[s]=new F(a,a))}return e}var E=-32768,V=32767,ge=0,W=65535,$={startAddrsOffset:new f(0,0,V),endAddrsOffset:new f(E,0,0),startloopAddrsOffset:new f(E,0,V),endloopAddrsOffset:new f(E,0,V),startAddrsCoarseOffset:new f(0,0,V),modLfoToPitch:new f(-12e3,0,12e3),vibLfoToPitch:new f(-12e3,0,12e3),modEnvToPitch:new f(-12e3,0,12e3),initialFilterFc:new f(1500,13500,13500),initialFilterQ:new f(0,0,960),modLfoToFilterFc:new f(-12e3,0,12e3),modEnvToFilterFc:new f(-12e3,0,12e3),endAddrsCoarseOffset:new f(E,0,0),modLfoToVolume:new f(-960,0,960),chorusEffectsSend:new f(0,0,1e3),reverbEffectsSend:new f(0,0,1e3),pan:new f(-500,0,500),delayModLFO:new f(-12e3,-12e3,5e3),freqModLFO:new f(-16e3,0,4500),delayVibLFO:new f(-12e3,-12e3,5e3),freqVibLFO:new f(-16e3,0,4500),delayModEnv:new f(-12e3,-12e3,5e3),attackModEnv:new f(-12e3,-12e3,8e3),holdModEnv:new f(-12e3,-12e3,5e3),decayModEnv:new f(-12e3,-12e3,8e3),sustainModEnv:new f(0,0,1e3),releaseModEnv:new f(-12e3,-12e3,8e3),keynumToModEnvHold:new f(-1200,0,1200),keynumToModEnvDecay:new f(-1200,0,1200),delayVolEnv:new f(-12e3,-12e3,5e3),attackVolEnv:new f(-12e3,-12e3,8e3),holdVolEnv:new f(-12e3,-12e3,5e3),decayVolEnv:new f(-12e3,-12e3,8e3),sustainVolEnv:new f(0,0,1440),releaseVolEnv:new f(-12e3,-12e3,8e3),keynumToVolEnvHold:new f(-1200,0,1200),keynumToVolEnvDecay:new f(-1200,0,1200),instrument:new f(ge,W,W),keyRange:new F(0,127),velRange:new F(0,127),startloopAddrsCoarseOffset:new f(E,0,V),keynum:new f(-1,-1,127),velocity:new f(-1,-1,127),initialAttenuation:new f(0,0,1440),endloopAddrsCoarseOffset:new f(E,0,V),coarseTune:new f(-120,0,120),fineTune:new f(-99,0,99),sampleID:new f(ge,W,W),sampleModes:new f(0,0,3),scaleTuning:new f(0,100,100),exclusiveClass:new f(0,0,127),overridingRootKey:new f(-1,-1,127)};function x(o){return Math.pow(2,o/1200)}var Z=class{constructor(e,t,r,s,a){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(n,c)=>{n.modLfoToPitch=this.clamp("modLfoToPitch",c)},vibLfoToPitch:(n,c)=>{n.vibLfoToPitch=this.clamp("vibLfoToPitch",c)},modEnvToPitch:(n,c)=>{n.modEnvToPitch=this.clamp("modEnvToPitch",c)},initialFilterFc:(n,c)=>{n.initialFilterFc=this.clamp("initialFilterFc",c)},initialFilterQ:(n,c)=>{n.initialFilterQ=this.clamp("initialFilterQ",c)},modLfoToFilterFc:(n,c)=>{n.modLfoToFilterFc=this.clamp("modLfoToFilterFc",c)},modEnvToFilterFc:(n,c)=>{n.modEnvToFilterFc=this.clamp("modEnvToFilterFc",c)},modLfoToVolume:(n,c)=>{n.modLfoToVolume=this.clamp("modLfoToVolume",c)},chorusEffectsSend:(n,c)=>{n.chorusEffectsSend=this.clamp("chorusEffectsSend",c)/1e3},reverbEffectsSend:(n,c)=>{n.reverbEffectsSend=this.clamp("reverbEffectsSend",c)/1e3},pan:(n,c)=>{n.pan=this.clamp("pan",c)/1e3},delayModLFO:(n,c)=>{n.delayModLFO=x(this.clamp("delayModLFO",c))},freqModLFO:(n,c)=>{n.freqModLFO=this.clamp("freqModLFO",c)},delayVibLFO:(n,c)=>{n.delayVibLFO=x(this.clamp("delayVibLFO",c))},freqVibLFO:(n,c)=>{n.freqVibLFO=this.clamp("freqVibLFO",c)},delayModEnv:(n,c)=>{n.modDelay=x(this.clamp("delayModEnv",c))},attackModEnv:(n,c)=>{n.modAttack=x(this.clamp("attackModEnv",c))},holdModEnv:(n,c)=>{let l=this.clamp("holdModEnv",c),u=this.clamp("keynumToModEnvHold",c);n.modHold=this.getModHold(l,u)},decayModEnv:(n,c)=>{let l=this.clamp("decayModEnv",c),u=this.clamp("keynumToModEnvDecay",c);n.modDecay=this.getModDecay(l,u)},sustainModEnv:(n,c)=>{n.modSustain=this.clamp("sustainModEnv",c)/1e3},releaseModEnv:(n,c)=>{n.modRelease=x(this.clamp("releaseModEnv",c))},keynumToModEnvHold:(n,c)=>{let l=this.clamp("holdModEnv",c),u=this.clamp("keynumToModEnvHold",c);n.modHold=this.getModHold(l,u)},keynumToModEnvDecay:(n,c)=>{let l=this.clamp("decayModEnv",c),u=this.clamp("keynumToModEnvDecay",c);n.modDecay=this.getModDecay(l,u)},delayVolEnv:(n,c)=>{n.volDelay=x(this.clamp("delayVolEnv",c))},attackVolEnv:(n,c)=>{n.volAttack=x(this.clamp("attackVolEnv",c))},holdVolEnv:(n,c)=>{let l=this.clamp("holdVolEnv",c),u=this.clamp("keynumToVolEnvHold",c);n.volHold=this.getVolHold(l,u)},decayVolEnv:(n,c)=>{let l=this.clamp("decayVolEnv",c),u=this.clamp("keynumToVolEnvDecay",c);n.volDecay=this.getVolDecay(l,u)},sustainVolEnv:(n,c)=>{n.volSustain=this.clamp("sustainVolEnv",c)/1e3},releaseVolEnv:(n,c)=>{n.volRelease=x(this.clamp("releaseVolEnv",c))},keynumToVolEnvHold:(n,c)=>{let l=this.clamp("holdVolEnv",c),u=this.clamp("keynumToVolEnvHold",c);n.modHold=this.getVolHold(l,u)},keynumToVolEnvDecay:(n,c)=>{let l=this.clamp("decayVolEnv",c),u=this.clamp("keynumToVolEnvDecay",c);n.modDecay=this.getVolDecay(l,u)},initialAttenuation:(n,c)=>{n.initialAttenuation=this.clamp("initialAttenuation",c)},coarseTune:(n,c)=>{n.detune=this.getDetune(c)},fineTune:(n,c)=>{n.detune=this.getDetune(c)},scaleTuning:(n,c)=>{n.playbackRate=this.getPlaybackRate(c)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],r=t.sourceOper.controllerType,s=t.destinationOper,a=this.controllerToDestinations.get(r);a?a.add(t.destinationOper):this.controllerToDestinations.set(r,new Set([s]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],r=t.destinationOper,s=this.destinationToModulators.get(r);s?s.push(t):this.destinationToModulators.set(r,[t])}}getModHold(e,t){return x(e+(this.key-60)*t)}getModDecay(e,t){return x(e+(this.key-60)*t)}getVolHold(e,t){return x(e+(this.key-60)*t)}getVolDecay(e,t){return x(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("overridingRootKey",e),r=this.clamp("scaleTuning",e),s=t===-1?this.sampleHeader.originalPitch:t;return Math.pow(2,(this.key-s)*r/1200)}getDetune(e){let t=this.clamp("coarseTune",e)*100,r=this.clamp("fineTune",e),s=this.sampleHeader.pitchCorrection;return t+r+s}transformParams(e,t){let r={},s=this.controllerToDestinations.get(e);if(!s)return r;for(let a of s){let n=S[a];if(!n||!oe(n))continue;let c=this.destinationToModulators.get(a);if(c){r[n]=this.generators[n];for(let l of c){let u=l.sourceOper,d=u.map(t[u.controllerType]),h=1,p=l.amountSourceOper;if(!(p.cc===0&&p.index===0)){let v=t[p.controllerType];h=p.map(v)}let m=l.transform(d*h);Number.isNaN(m)||(r[n]+=m)}}}return r}transformAllParams(e){let t=structuredClone(this.generators);for(let r of this.modulators){let s=r.sourceOper.controllerType,a=e[s];if(!a)continue;let n=S[r.destinationOper];if(!n||!oe(n))continue;let l=r.sourceOper.map(a),u=1,d=r.amountSourceOper;if(!(d.cc===0&&d.index===0)){let p=e[d.controllerType];u=d.map(p)}let h=r.transform(l*u);Number.isNaN(h)||(t[n]+=h)}return t}clamp(e,t){return $[e].clamp(t[e])}getParams(e,t){let r={},s=structuredClone(this.generators),a=this.transformParams(e,t),n=Object.keys(a);for(let c of n)s[c]=a[c];for(let c of n)this.voiceHandlers[c](r,s);return r}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,instrument:this.generators.instrument,sampleID:this.generators.sampleID,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},r=this.transformAllParams(e);for(let s=0;s<K.length;s++){let a=K[s];this.voiceHandlers[a](t,r)}return t}};var Oe=[new b(y.parse(1282),48,960,y.parse(0),0),new b(y.parse(258),8,-2400,y.parse(0),0),new b(y.parse(13),6,50,y.parse(0),0),new b(y.parse(129),6,50,y.parse(0),0),new b(y.parse(1415),48,960,y.parse(0),0),new b(y.parse(650),48,1,y.parse(0),0),new b(y.parse(1419),48,960,y.parse(0),0),new b(y.parse(219),16,.2,y.parse(0),0),new b(y.parse(221),15,.2,y.parse(0),0),new b(y.parse(526),51,127,y.parse(16),0)];var _=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},z=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},U=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,r,s){let a=new Array(s-r);for(let n=r;n<s;n++){let c=t[n].generatorIndex,l=t[n+1].generatorIndex;a[n-r]=e.slice(c,l)}return a}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],r=this.parsed.presetHeaders[e+1],s=r?r.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,s)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],r=this.parsed.instruments[e+1],s=r?r.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,s)}getModulators(e,t,r,s){let a=new Array(s-r);for(let n=r;n<s;n++){let c=t[n].modulatorIndex,l=t[n+1].modulatorIndex;a[n-r]=e.slice(c,l)}return a}getPresetModulators(e){let t=this.parsed.presetHeaders[e],r=this.parsed.presetHeaders[e+1],s=r?r.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,s)}getInstrumentModulators(e){let t=this.parsed.instruments[e],r=this.parsed.instruments[e+1],s=r?r.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,s)}findInstrumentZone(e,t,r){let s=this.getInstrumentGenerators(e),a=this.getInstrumentModulators(e),n,c=[];for(let l=0;l<s.length;l++){let u=Te(s[l]);if(u.sampleID===void 0){n=u,c=a[l];continue}if(!(u.keyRange&&!u.keyRange.in(t))&&!(u.velRange&&!u.velRange.in(r)))if(n){let d={...n,...u},h=[...c,...a[l]];return new _(d,h)}else return new _(u,a[l])}}findInstrument(e,t,r){let s=this.getPresetGenerators(e),a=this.getPresetModulators(e),n,c=[];for(let l=0;l<s.length;l++){let u=Se(s[l]);if(u.instrument===void 0){n=u,c=a[l];continue}if(u.keyRange&&!u.keyRange.in(t)||u.velRange&&!u.velRange.in(r))continue;let d=this.findInstrumentZone(u.instrument,t,r);if(d)if(n){let h={...n,...u},p=[...c,...a[l]],m=new z(h,p);return this.createVoice(t,m,d)}else{let h=new z(u,a[l]);return this.createVoice(t,h,d)}}return null}createVoice(e,t,r){let s=Pe($);Object.assign(s,r.generators);let a=Object.keys(t.generators);for(let d=0;d<a.length;d++){let h=a[d];B(h)||(s[h]+=t.generators[h])}let n=[...Oe,...t.modulators,...r.modulators],c=s.sampleID,l=this.parsed.samples[c],u=this.parsed.sampleHeaders[c];return new Z(e,s,n,l,u)}getVoice(e,t,r,s){let a=this.parsed.presetHeaders.findIndex(c=>c.preset===t&&c.bank===e);if(a<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let n=this.findInstrument(a,r,s);return n||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let r=0;r<t.length;r++){let s=t[r];e[s.bank]||(e[s.bank]={}),e[s.bank][s.preset]=s.presetName}return e}};var ie=class{voice;voiceParams;adjustedBaseFreq=2e4;index=-1;ending=!1;bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;modulationLFO;modulationDepth;constructor(e,t,r){this.noteNumber=e,this.velocity=t,this.startTime=r,this.ready=new Promise(s=>{this.resolveReady=s})}},I=new Uint8Array(128);I[42]=1;I[44]=1;I[46]=1,I[71]=2;I[72]=2;I[73]=3;I[74]=3;I[78]=4;I[79]=4;I[80]=5;I[81]=5;var lt=5,Q={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepthMSB:{type:129,defaultValue:0},volumeMSB:{type:135,defaultValue:100/127},panMSB:{type:138,defaultValue:64/127},expressionMSB:{type:139,defaultValue:1},sustainPedal:{type:192,defaultValue:0}},ce=class{array=new Float32Array(256);constructor(){let e=Object.entries(Q);for(let[t,{type:r,defaultValue:s}]of e)this.array[r]=s,Object.defineProperty(this,t,{get:()=>this.array[r],set:a=>this.array[r]=a,enumerable:!0,configurable:!0})}},ut=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],dt=new Set(ut),ht=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain"],ft=new Set(ht),pt=["modEnvToPitch","modDelay","modAttack","modHold","modDecay","modSustain","playbackRate"],mt=new Set(pt);function J(o){return Math.pow(10,o/200)}var ae=1/-Math.log(J(-1e3)),ke=1/-Math.log(J(-600)),Fe=class extends EventTarget{perceptualSmoothingTime=.004;mode="GM1";numChannels=16;ticksPerBeat=120;totalTime=0;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=Array.from({length:128},()=>[]);voiceCounter=new Map;voiceCache=new Map;realtimeVoiceCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;totalTimeEventTypes=new Set(["noteOff"]);tempo=1;loop=!1;playPromise;timeline=[];notePromises=[];instruments=new Set;exclusiveClassNotes=new Array(128);drumExclusiveClassNotes=new Array(this.numChannels*lt);static channelSettings={scheduleIndex:0,detune:0,programNumber:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,modulationDepthRange:50};constructor(e){super(),this.audioContext=e,this.masterVolume=new GainNode(e),this.scheduler=new GainNode(e,{gain:0}),this.schedulerBuffer=new AudioBuffer({length:1,sampleRate:e.sampleRate}),this.messageHandlers=this.createMessageHandlers(),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.masterVolume.connect(e.destination),this.scheduler.connect(e.destination),this.GM1SystemOn()}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let r=e.parsed.presetHeaders,s=this.soundFontTable;for(let a=0;a<r.length;a++){let{preset:n,bank:c}=r[a];s[n][c]=t}}async toUint8Array(e){let t;if(typeof e=="string"){let s=await(await fetch(e)).arrayBuffer();t=new Uint8Array(s)}else if(e instanceof Uint8Array)t=e;else throw new TypeError("input must be a URL string or Uint8Array");return t}async loadSoundFont(e){if(this.voiceCounter.clear(),Array.isArray(e)){let t=new Array(e.length);for(let s=0;s<e.length;s++)t[s]=this.toUint8Array(e[s]);let r=await Promise.all(t);for(let s=0;s<r.length;s++){let a=se(r[s]),n=new U(a);this.addSoundFont(n)}}else{let t=await this.toUint8Array(e),r=se(t),s=new U(r);this.addSoundFont(s)}}async loadMIDI(e){this.voiceCounter.clear();let t=await this.toUint8Array(e),r=(0,Me.parseMidi)(t);this.ticksPerBeat=r.header.ticksPerBeat;let s=this.extractMidiData(r);this.instruments=s.instruments,this.timeline=s.timeline,this.totalTime=this.calcTotalTime()}cacheVoiceIds(){let{channels:e,timeline:t,voiceCounter:r}=this;for(let s=0;s<t.length;s++){let a=t[s];switch(a.type){case"noteOn":{let n=this.getVoiceId(e[a.channel],a.noteNumber,a.velocity);r.set(n,(r.get(n)??0)+1);break}case"controller":a.controllerType===0?this.setBankMSB(a.channel,a.value):a.controllerType===32&&this.setBankLSB(a.channel,a.value);break;case"programChange":this.setProgramChange(a.channel,a.programNumber,a.startTime)}}for(let[s,a]of r)a===1&&r.delete(s);this.GM1SystemOn()}getVoiceId(e,t,r){let s=e.programNumber,a=this.soundFontTable[s];if(!a)return;let n=e.isDrum?128:0;if(a[n]===void 0){if(e.isDrum)return;n=0}let c=a[n];if(c===void 0)return;let u=this.soundFonts[c].getVoice(n,s,t,r),{instrument:d,sampleID:h}=u.generators;return c*2**32+(d<<16)+h}createChannelAudioNodes(e){let{gainLeft:t,gainRight:r}=this.panToGain(Q.panMSB.defaultValue),s=new GainNode(e,{gain:t}),a=new GainNode(e,{gain:r}),n=new ChannelMergerNode(e,{numberOfInputs:2});return s.connect(n,0,0),a.connect(n,0,1),n.connect(this.masterVolume),{gainL:s,gainR:a,merger:n}}createChannels(e){return Array.from({length:this.numChannels},()=>({currentBufferSource:null,isDrum:!1,state:new ce,...this.constructor.channelSettings,...this.createChannelAudioNodes(e),scheduledNotes:[],sustainNotes:[]}))}async createAudioBuffer(e){let{sample:t,start:r,end:s}=e,a=t.data.length+s;return await t.toAudioBuffer(this.audioContext,r,a)}createBufferSource(e,t,r){let s=new AudioBufferSourceNode(this.audioContext);return s.buffer=r,s.loop=t.sampleModes%2!==0,e.isDrum&&(s.loop=!1),s.loop&&(s.loopStart=t.loopStart/t.sampleRate,s.loopEnd=t.loopEnd/t.sampleRate),s}scheduleTimelineEvents(e,t){let r=this.resumeTime-this.startTime,s=e+r+this.lookAhead,a=this.startDelay-r,n=this.timeline,c=1/this.tempo;for(;t<n.length;){let l=n[t],u=l.startTime*c;if(s<u)break;let d=u+a;switch(l.type){case"noteOn":this.noteOn(l.channel,l.noteNumber,l.velocity,d);break;case"noteOff":{this.noteOff(l.channel,l.noteNumber,l.velocity,d,!1);break}case"controller":this.setControlChange(l.channel,l.controllerType,l.value,d);break;case"programChange":this.setProgramChange(l.channel,l.programNumber,d);break;case"pitchBend":this.setPitchBend(l.channel,l.value+8192,d);break;case"sysEx":this.handleSysEx(l.data,d)}t++}return t}getQueueIndex(e){let t=this.timeline,r=1/this.tempo;for(let s=0;s<t.length;s++)if(e<=t[s].startTime*r)return s;return 0}resetAllStates(){this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.voiceCache.clear(),this.realtimeVoiceCache.clear();let e=this.channels;for(let t=0;t<e.length;t++)e[t].scheduledNotes=[],this.resetChannelStates(i)}updateStates(e,t){let{timeline:r,resumeTime:s}=this,a=1/this.tempo,n=this.audioContext.currentTime;t<e&&(e=0);for(let c=e;c<t;c++){let l=r[c];switch(l.type){case"controller":this.setControlChange(l.channel,l.controllerType,l.value,n-s+l.startTime*a);break;case"programChange":this.setProgramChange(l.channel,l.programNumber,n-s+l.startTime*a);break;case"pitchBend":this.setPitchBend(l.channel,l.value+8192,n-s+l.startTime*a);break;case"sysEx":this.handleSysEx(l.data,n-s+l.startTime*a)}}}async playNotes(){let e=this.audioContext;e.state==="suspended"&&await e.resume();let t=this.isPaused;this.isPlaying=!0,this.isPaused=!1,this.startTime=e.currentTime,t?this.dispatchEvent(new Event("resumed")):this.dispatchEvent(new Event("started"));let r=this.getQueueIndex(this.resumeTime),s;for(this.notePromises=[];;){let a=e.currentTime;if(this.totalTime<this.currentTime()||this.timeline.length<=r)if(await this.stopNotes(0,!0,a),this.loop){this.resetAllStates(),this.startTime=e.currentTime,this.resumeTime=0,r=0,this.dispatchEvent(new Event("looped"));continue}else{await e.suspend(),s="ended";break}if(this.isPausing){await this.stopNotes(0,!0,a),await e.suspend(),this.isPausing=!1,s="paused";break}else if(this.isStopping){await this.stopNotes(0,!0,a),await e.suspend(),this.isStopping=!1,s="stopped";break}else if(this.isSeeking){this.stopNotes(0,!0,a),this.startTime=e.currentTime;let c=this.getQueueIndex(this.resumeTime);this.updateStates(r,c),r=c,this.isSeeking=!1,this.dispatchEvent(new Event("seeked"));continue}r=this.scheduleTimelineEvents(a,r);let n=a+this.noteCheckInterval;await this.scheduleTask(()=>{},n)}s!=="paused"&&this.resetAllStates(),this.isPlaying=!1,s==="paused"?(this.isPaused=!0,this.dispatchEvent(new Event("paused"))):(this.isPaused=!1,this.dispatchEvent(new Event(s)))}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}getSoundFontId(e){let t=e.programNumber,r=e.isDrum?"128":"000",s=t.toString().padStart(3,"0");return`${r}:${s}`}extractMidiData(e){let t=new Set,r=[],s=this.channels;for(let u=0;u<e.tracks.length;u++){let d=e.tracks[u],h=0;for(let p=0;p<d.length;p++){let m=d[p];switch(h+=m.deltaTime,m.ticks=h,m.type){case"noteOn":{let v=s[m.channel];t.add(this.getSoundFontId(v));break}case"programChange":{let v=s[m.channel];this.setProgramChange(m.channel,m.programNumber),t.add(this.getSoundFontId(v));break}}delete m.deltaTime,r.push(m)}}let a={controller:0,sysEx:1};r.sort((u,d)=>u.ticks!==d.ticks?u.ticks-d.ticks:(a[u.type]||2)-(a[d.type]||2));let n=0,c=0,l=.5;for(let u=0;u<r.length;u++){let d=r[u],h=this.ticksToSecond(d.ticks-c,l);d.startTime=n+h,d.type==="setTempo"&&(n+=this.ticksToSecond(d.ticks-c,l),l=d.microsecondsPerBeat/1e6,c=d.ticks)}return{instruments:t,timeline:r}}stopActiveNotes(e,t,r,s){let a=this.channels[e],n=[];return this.processActiveNotes(a,s,c=>{let l=this.noteOff(e,c.noteNumber,t,s,r);this.notePromises.push(l),n.push(l)}),Promise.all(n)}stopChannelNotes(e,t,r,s){let a=this.channels[e],n=[];return this.processScheduledNotes(a,c=>{let l=this.noteOff(e,c.noteNumber,t,s,r);this.notePromises.push(l),n.push(l)}),Promise.all(n)}stopNotes(e,t,r){let s=this.channels;for(let n=0;n<s.length;n++)this.stopChannelNotes(n,e,t,r);let a=Promise.all(this.notePromises);return this.notePromises=[],a}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,this.voiceCounter.size===0&&this.cacheVoiceIds(),this.playPromise=this.playNotes(),await this.playPromise)}async stop(){this.isPlaying&&(this.isStopping=!0,await this.playPromise)}async pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime=e+this.resumeTime-this.startTime,this.isPausing=!0,await this.playPromise}async resume(){this.isPaused&&(this.playPromise=this.playNotes(),await this.playPromise)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}tempoChange(e){let t=this.tempo/e;this.resumeTime=this.resumeTime*t,this.tempo=e,this.totalTime=this.calcTotalTime(),this.seekTo(this.currentTime()*t)}calcTotalTime(){let e=this.totalTimeEventTypes,t=this.timeline,r=1/this.tempo,s=0;for(let a=0;a<t.length;a++){let n=t[a];if(!e.has(n.type))continue;let c=n.startTime*r;s<c&&(s=c)}return s+this.startDelay}currentTime(){return this.isPlaying?this.audioContext.currentTime+this.resumeTime-this.startTime:this.resumeTime}async processScheduledNotes(e,t){let r=e.scheduledNotes,s=[];for(let a=e.scheduleIndex;a<r.length;a++){let n=r[a];if(!n||n.ending)continue;let c=n.ready.then(()=>t(n));s.push(c)}await Promise.all(s)}async processActiveNotes(e,t,r){let s=e.scheduledNotes,a=[];for(let n=e.scheduleIndex;n<s.length;n++){let c=s[n];if(!c||c.ending)continue;if(t<c.startTime)break;let l=c.ready.then(()=>r(c));a.push(l)}await Promise.all(a)}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=e.state.pitchWheel*2-1,r=e.state.pitchWheelSensitivity*12800;return t*r}updateChannelDetune(e,t){this.processScheduledNotes(e,r=>{this.setDetune(e,r,t)})}calcNoteDetune(e,t){return e.detune+t.voiceParams.detune}setVolumeEnvelope(e,t){let{voiceParams:r,startTime:s}=e,a=J(-r.initialAttenuation),n=a*(1-r.volSustain),c=s+r.volDelay,l=c+r.volAttack,u=l+r.volHold,d=r.volDecay;e.volumeEnvelopeNode.gain.cancelScheduledValues(t).setValueAtTime(0,s).setValueAtTime(1e-6,c).exponentialRampToValueAtTime(a,l).setValueAtTime(a,u).setTargetAtTime(n,u,d*ae)}setDetune(e,t,r){let s=this.calcNoteDetune(e,t);t.bufferSource.detune.cancelScheduledValues(r).setValueAtTime(s,r);let a=this.perceptualSmoothingTime/5;t.bufferSource.detune.cancelAndHoldAtTime(r).setTargetAtTime(s,r,a)}setPitchEnvelope(e,t){let{bufferSource:r,voiceParams:s}=e,a=s.playbackRate;r.playbackRate.cancelScheduledValues(t).setValueAtTime(a,t);let n=s.modEnvToPitch;if(n===0)return;let c=a*this.centToRate(n),l=e.startTime+s.modDelay,u=l+s.modAttack,d=u+s.modHold,h=s.modDecay;r.playbackRate.setValueAtTime(a,l).exponentialRampToValueAtTime(c,u).setValueAtTime(c,d).setTargetAtTime(a,d,h*ae)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setFilterEnvelope(e,t){let{voiceParams:r,startTime:s}=e,a=r.modEnvToFilterFc,n=r.initialFilterFc,c=n+a,l=n+a*(1-r.modSustain),u=this.centToHz(n),d=this.centToHz(c),h=this.centToHz(l),p=this.clampCutoffFrequency(u),m=this.clampCutoffFrequency(d),v=this.clampCutoffFrequency(h),M=s+r.modDelay,N=M+r.modAttack,A=N+r.modHold,O=r.modDecay;e.adjustedBaseFreq=p,e.filterNode.frequency.cancelScheduledValues(t).setValueAtTime(p,s).setValueAtTime(p,M).exponentialRampToValueAtTime(m,N).setValueAtTime(m,A).setTargetAtTime(v,A,O*ae)}startModulation(e,t,r){let s=this.audioContext,{voiceParams:a}=t;t.modulationLFO=new OscillatorNode(s,{frequency:this.centToHz(a.freqModLFO)}),t.filterDepth=new GainNode(s,{gain:a.modLfoToFilterFc}),t.modulationDepth=new GainNode(s),this.setModLfoToPitch(e,t,r),t.volumeDepth=new GainNode(s),this.setModLfoToVolume(t,r),t.modulationLFO.start(t.startTime+a.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}async getAudioBuffer(e,t,r,s,a){let n=this.getVoiceId(e,t,r);if(a){let c=this.realtimeVoiceCache.get(n);if(c)return c;let l=await this.createAudioBuffer(s);return this.realtimeVoiceCache.set(n,l),l}else{let c=this.voiceCache.get(n);if(c)return c.counter+=1,c.maxCount<=c.counter&&this.voiceCache.delete(n),c.audioBuffer;{let l=this.voiceCounter.get(n)??0,u=await this.createAudioBuffer(s),d={audioBuffer:u,maxCount:l,counter:1};return this.voiceCache.set(n,d),u}}}async setNoteAudioNode(e,t,r){let s=this.audioContext,a=s.currentTime,{noteNumber:n,velocity:c,startTime:l}=t,u=e.state,d=this.getControllerState(e,n,c),h=t.voice.getAllParams(d);t.voiceParams=h;let p=await this.getAudioBuffer(e,n,c,h,r);if(t.bufferSource=this.createBufferSource(e,h,p),t.volumeEnvelopeNode=new GainNode(s),t.filterNode=new BiquadFilterNode(s,{type:"lowpass",Q:h.initialFilterQ/10}),this.setVolumeEnvelope(t,a),this.setFilterEnvelope(t,a),this.setPitchEnvelope(t,a),this.setDetune(e,t,a),0<u.modulationDepthMSB&&this.startModulation(e,t,a),t.bufferSource.connect(t.filterNode),t.filterNode.connect(t.volumeEnvelopeNode),h.sample.type==="compressed"){let m=h.start/p.sampleRate;t.bufferSource.start(l,m)}else t.bufferSource.start(l);return t}handleExclusiveClass(e,t,r){let s=e.voiceParams.exclusiveClass;if(s===0)return;let a=this.exclusiveClassNotes[s];if(a){let[n,c]=a;n&&!n.ending&&this.noteOff(c,n.noteNumber,0,r,!0)}this.exclusiveClassNotes[s]=[e,t]}handleDrumExclusiveClass(e,t,r){if(!this.channels[t].isDrum)return;let a=I[e.noteNumber];if(a===0)return;let n=a*this.channels.length+t,c=this.drumExclusiveClassNotes[n];c&&!c.ending&&this.noteOff(t,c.noteNumber,0,r,!0),this.drumExclusiveClassNotes[n]=e}setNoteRouting(e,t,r){let s=this.channels[e],a=t.volumeEnvelopeNode;a.connect(s.gainL),a.connect(s.gainR),.5<=s.state.sustainPedal&&s.sustainNotes.push(t),this.handleExclusiveClass(t,e,r),this.handleDrumExclusiveClass(t,e,r)}async noteOn(e,t,r,s){let a=this.channels[e],n=s===void 0;n&&(s=this.audioContext.currentTime);let c=new ie(t,r,s),l=a.scheduledNotes;c.index=l.length,l.push(c);let u=a.programNumber,d=this.soundFontTable[u];if(!d)return;let h=a.isDrum?128:0;if(d[h]===void 0){if(a.isDrum)return;h=0}let p=d[h];if(p===void 0)return;let m=this.soundFonts[p];c.voice=m.getVoice(h,u,t,r),c.voice&&(await this.setNoteAudioNode(a,c,n),this.setNoteRouting(e,c,s),c.resolveReady())}disconnectNote(e){e.bufferSource.disconnect(),e.filterNode.disconnect(),e.volumeEnvelopeNode.disconnect(),e.modulationDepth&&(e.volumeDepth.disconnect(),e.modulationDepth.disconnect(),e.modulationLFO.stop())}releaseNote(e,t,r){r??=this.audioContext.currentTime;let s=t.voiceParams.volRelease,a=r+s;return t.filterNode.frequency.cancelScheduledValues(r).setTargetAtTime(t.adjustedBaseFreq,r,t.voiceParams.modRelease*ke),t.volumeEnvelopeNode.gain.cancelScheduledValues(r).setTargetAtTime(0,r,s*ke),new Promise(n=>{this.scheduleTask(()=>{let c=t.bufferSource;c.loop=!1,c.stop(a),this.disconnectNote(t),e.scheduledNotes[t.index]=void 0,n()},a)})}noteOff(e,t,r,s,a){let n=this.channels[e];if(!a&&(n.isDrum||.5<=n.state.sustainPedal))return;let c=this.findNoteOffIndex(n,t);if(c<0)return;let l=n.scheduledNotes[c];l.ending=!0,this.setNoteIndex(n,c);let u=l.ready.then(()=>this.releaseNote(n,l,s));return this.notePromises.push(u),u}setNoteIndex(e,t){let r=!0;for(let s=e.scheduleIndex;s<t;s++){let a=e.scheduledNotes[s];if(a&&!a.ending){r=!1;break}}r&&(e.scheduleIndex=t+1)}findNoteOffIndex(e,t){let r=e.scheduledNotes;for(let s=e.scheduleIndex;s<r.length;s++){let a=r[s];if(a&&!a.ending&&a.noteNumber===t)return s}return-1}releaseSustainPedal(e,t,r){let s=t*2,a=this.channels[e],n=[];for(let c=0;c<a.sustainNotes.length;c++){let l=this.noteOff(e,a.sustainNotes[c].noteNumber,s,r);n.push(l)}return a.sustainNotes=[],n}createMessageHandlers(){let e=new Array(256);return e[128]=(t,r)=>this.noteOff(t[0]&15,t[1],t[2],r),e[144]=(t,r)=>this.noteOn(t[0]&15,t[1],t[2],r),e[176]=(t,r)=>this.setControlChange(t[0]&15,t[1],t[2],r),e[192]=(t,r)=>this.setProgramChange(t[0]&15,t[1],r),e[224]=(t,r)=>this.handlePitchBendMessage(t[0]&15,t[1],t[2],r),e}handleMessage(e,t){let r=e[0];if(r===240)return this.handleSysEx(e.subarray(1),t);let s=this.messageHandlers[r];s&&s(e,t)}handleChannelMessage(e,t,r,s){let a=e&15,n=e&240;switch(n){case 128:return this.noteOff(a,t,r,s);case 144:return this.noteOn(a,t,r,s);case 176:return this.setControlChange(a,t,r,s);case 192:return this.setProgramChange(a,t,s);case 224:return this.handlePitchBendMessage(a,t,r,s);default:console.warn(`Unsupported MIDI message: ${n.toString(16)}`)}}setProgramChange(e,t,r){let s=this.channels[e];s.programNumber=t}handlePitchBendMessage(e,t,r,s){let a=r*128+t;this.setPitchBend(e,a,s)}setPitchBend(e,t,r){let s=this.channels[e];0<=r||(r=this.audioContext.currentTime);let a=s.state,n=a.pitchWheel*2-1,c=(t-8192)/8192;a.pitchWheel=t/16383,s.detune+=(c-n)*a.pitchWheelSensitivity*12800,this.updateChannelDetune(s,r),this.applyVoiceParams(s,14,r)}setModLfoToPitch(e,t,r){if(t.modulationDepth){let s=t.voiceParams.modLfoToPitch,n=(Math.abs(s)+e.state.modulationDepthMSB)*Math.sign(s);t.modulationDepth.gain.cancelScheduledValues(r).setValueAtTime(n,r)}else this.startModulation(e,t,r)}setModLfoToFilterFc(e,t){let r=e.voiceParams.modLfoToFilterFc;e.filterDepth.gain.cancelScheduledValues(t).setValueAtTime(r,t)}setModLfoToVolume(e,t){let r=e.voiceParams.modLfoToVolume,a=(J(Math.abs(r))-1)*Math.sign(r);e.volumeDepth.gain.cancelScheduledValues(t).setValueAtTime(a,t)}setDelayModLFO(e,t){let r=e.startTime;r<t||(e.modulationLFO.stop(t),e.modulationLFO.start(r+e.voiceParams.delayModLFO),e.modulationLFO.connect(e.filterDepth))}setFreqModLFO(e,t){let r=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(r,t)}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,r)=>{0<e.state.modulationDepthMSB&&this.setModLfoToPitch(e,t,r)},vibLfoToPitch:(e,t,r)=>{},modLfoToFilterFc:(e,t,r)=>{0<e.state.modulationDepthMSB&&this.setModLfoToFilterFc(t,r)},modLfoToVolume:(e,t,r)=>{0<e.state.modulationDepthMSB&&this.setModLfoToVolume(t,r)},chorusEffectsSend:(e,t,r)=>{},reverbEffectsSend:(e,t,r)=>{},delayModLFO:(e,t,r)=>{0<channel.state.modulationDepth&&this.setDelayModLFO(t,r)},freqModLFO:(e,t,r)=>{0<channel.state.modulationDepthMSB&&this.setFreqModLFO(t,r)},delayVibLFO:(e,t,r)=>{},freqVibLFO:(e,t,r)=>{},detune:(e,t,r)=>{this.setDetune(e,t,r)}}}getControllerState(e,t,r){let s=new Float32Array(e.state.array.length);return s.set(e.state.array),s[2]=r/127,s[3]=t/127,s}applyVoiceParams(e,t,r){this.processScheduledNotes(e,s=>{let a=this.getControllerState(e,s.noteNumber,s.velocity),n=s.voice.getParams(t,a),c=!1,l=!1,u=!1;for(let[d,h]of Object.entries(n)){let p=s.voiceParams[d];h!==p&&(s.voiceParams[d]=h,d in this.voiceParamsHandlers?this.voiceParamsHandlers[d](e,s,r):(dt.has(d)&&(c=!0),ft.has(d)&&(l=!0),mt.has(d)&&(u=!0)))}c&&this.setVolumeEnvelope(s,r),l&&this.setFilterEnvelope(s,r),u&&this.setPitchEnvelope(s,r)})}createControlChangeHandlers(){let e=new Array(128);return e[1]=this.setModulationDepth,e[6]=this.dataEntryMSB,e[7]=this.setVolume,e[10]=this.setPan,e[11]=this.setExpression,e[38]=this.dataEntryLSB,e[64]=this.setSustainPedal,e[100]=this.setRPNLSB,e[101]=this.setRPNMSB,e[120]=this.allSoundOff,e[121]=this.resetAllControllers,e[123]=this.allNotesOff,e}setControlChange(e,t,r,s){let a=this.controlChangeHandlers[t];if(a){a.call(this,e,r,s);let n=this.channels[e];this.applyVoiceParams(n,t+128,s)}else console.warn(`Unsupported Control change: controllerType=${t} value=${r}`)}updateModulation(e,t){let r=e.state.modulationDepthMSB*e.modulationDepthRange;this.processScheduledNotes(e,s=>{s.modulationDepth?s.modulationDepth.gain.setValueAtTime(r,t):this.startModulation(e,s,t)})}setModulationDepth(e,t,r){let s=this.channels[e];0<=r||(r=this.audioContext.currentTime),s.state.modulationDepthMSB=t/127,this.updateModulation(s,r)}setVolume(e,t,r){0<=r||(r=this.audioContext.currentTime);let s=this.channels[e];s.state.volumeMSB=t/127,this.updateChannelVolume(s,r)}panToGain(e){let t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t,r){0<=r||(r=this.audioContext.currentTime);let s=this.channels[e];s.state.panMSB=t/127,this.updateChannelVolume(s,r)}setExpression(e,t,r){0<=r||(r=this.audioContext.currentTime);let s=this.channels[e];s.state.expressionMSB=t/127,this.updateChannelVolume(s,r)}dataEntryLSB(e,t,r){this.channels[e].dataLSB=t,this.handleRPN(e,r)}updateChannelVolume(e,t){let r=e.state,s=r.volumeMSB*r.expressionMSB,{gainLeft:a,gainRight:n}=this.panToGain(r.panMSB);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(s*a,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(s*n,t)}setSustainPedal(e,t,r){let s=this.channels[e];0<=r||(r=this.audioContext.currentTime),s.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(s,a=>{s.sustainNotes.push(a)}):this.releaseSustainPedal(e,t,r)}limitData(e,t,r,s,a){a<e.dataLSB?(e.dataMSB++,e.dataLSB=s):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=a),r<e.dataMSB?(e.dataMSB=r,e.dataLSB=a):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=s)}handleRPN(e,t){let r=this.channels[e];switch(r.rpnMSB*128+r.rpnLSB){case 0:this.handlePitchBendRangeRPN(e,t);break;case 16383:break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${r.rpnMSB} LSB=${r.rpnLSB}`)}}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,r){this.channels[e].dataMSB=t,this.handleRPN(e,r)}handlePitchBendRangeRPN(e,t){let r=this.channels[e];this.limitData(r,0,127,0,127);let s=(r.dataMSB+r.dataLSB/128)*100;this.setPitchBendRange(e,s,t)}setPitchBendRange(e,t,r){let s=this.channels[e];0<=r||(r=this.audioContext.currentTime);let a=s.state,n=a.pitchWheelSensitivity,c=t/12800;a.pitchWheelSensitivity=c,s.detune+=(a.pitchWheel*2-1)*(c-n)*12800,this.updateChannelDetune(s,r),this.applyVoiceParams(s,16,r)}allSoundOff(e,t,r){return 0<=r||(r=this.audioContext.currentTime),this.stopActiveNotes(e,0,!0,r)}resetChannelStates(e){let t=this.audioContext.currentTime,r=this.channels[e],s=r.state,a=Object.entries(Q);for(let[n,{type:c,defaultValue:l}]of a)128<=c?this.setControlChange(e,c-128,Math.ceil(l*127),t):s[n]=l;for(let n of Object.keys(this.constructor.channelSettings))r[n]=this.constructor.channelSettings[n];this.mode="GM1"}resetAllControllers(e,t,r){let s=["pitchWheel","expressionMSB","modulationDepthMSB","sustainPedal"],a=this.channels[e],n=a.state;for(let l=0;l<s.length;l++){let u=s[l],{type:d,defaultValue:h}=Q[u];128<=d?this.setControlChange(e,d-128,Math.ceil(h*127),r):n[u]=h}this.setPitchBend(e,8192,r);let c=["rpnMSB","rpnLSB"];for(let l=0;l<c.length;l++){let u=c[l];a[u]=this.constructor.channelSettings[u]}}allNotesOff(e,t,r){return 0<=r||(r=this.audioContext.currentTime),this.stopActiveNotes(e,0,!1,r)}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 9:switch(e[3]){case 1:this.GM1SystemOn(t);break;case 2:break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(e){let t=this.channels;0<=e||(e=this.audioContext.currentTime),this.mode="GM1";for(let r=0;r<t.length;r++){this.allSoundOff(r,0,e);let s=t[r];s.isDrum=!1}t[9].isDrum=!0}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:if(e[3]===1)return this.handleMasterVolumeSysEx(e,t);console.warn(`Unsupported Exclusive Message: ${e}`);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){let r=(e[5]*128+e[4])/16383;this.setMasterVolume(r,t)}setMasterVolume(e,t){0<=t||(t=this.audioContext.currentTime),this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(r=>{let s=new AudioBufferSourceNode(this.audioContext,{buffer:this.schedulerBuffer});s.connect(this.scheduler),s.onended=()=>{try{e()}finally{s.disconnect(),r()}},s.start(t)})}};export{Fe as MidyGMLite};
