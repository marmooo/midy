var Se=Object.create;var se=Object.defineProperty;var ke=Object.getOwnPropertyDescriptor;var Fe=Object.getOwnPropertyNames;var Ee=Object.getPrototypeOf,Me=Object.prototype.hasOwnProperty;var _=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var Ve=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Fe(e))!Me.call(o,n)&&n!==t&&se(o,n,{get:()=>e[n],enumerable:!(r=ke(e,n))||r.enumerable});return o};var De=(o,e,t)=>(t=o!=null?Se(Ee(o)):{},Ve(e||!o||!o.__esModule?se(t,"default",{value:o,enumerable:!0}):t,o));var ae=_((ft,oe)=>{function Ce(o){var e=new v(o),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var r=Ue(t.data),n=[],i=0;!e.eof()&&i<r.numTracks;i++){var s=e.readChunk();if(s.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+s.id+"'";var a=Ne(s.data);n.push(a)}return{header:r,tracks:n}}function Ue(o){var e=new v(o),t=e.readUInt16(),r=e.readUInt16(),n={format:t,numTracks:r},i=e.readUInt16();return i&32768?(n.framesPerSecond=256-(i>>8),n.ticksPerFrame=i&255):n.ticksPerBeat=i,n}function Ne(o){for(var e=new v(o),t=[];!e.eof();){var r=i();t.push(r)}return t;var n;function i(){var s={};s.deltaTime=e.readVarInt();var a=e.readUInt8();if((a&240)===240)if(a===255){s.meta=!0;var l=e.readUInt8(),c=e.readVarInt();switch(l){case 0:if(s.type="sequenceNumber",c!==2)throw"Expected length for sequenceNumber event is 2, got "+c;return s.number=e.readUInt16(),s;case 1:return s.type="text",s.text=e.readString(c),s;case 2:return s.type="copyrightNotice",s.text=e.readString(c),s;case 3:return s.type="trackName",s.text=e.readString(c),s;case 4:return s.type="instrumentName",s.text=e.readString(c),s;case 5:return s.type="lyrics",s.text=e.readString(c),s;case 6:return s.type="marker",s.text=e.readString(c),s;case 7:return s.type="cuePoint",s.text=e.readString(c),s;case 32:if(s.type="channelPrefix",c!=1)throw"Expected length for channelPrefix event is 1, got "+c;return s.channel=e.readUInt8(),s;case 33:if(s.type="portPrefix",c!=1)throw"Expected length for portPrefix event is 1, got "+c;return s.port=e.readUInt8(),s;case 47:if(s.type="endOfTrack",c!=0)throw"Expected length for endOfTrack event is 0, got "+c;return s;case 81:if(s.type="setTempo",c!=3)throw"Expected length for setTempo event is 3, got "+c;return s.microsecondsPerBeat=e.readUInt24(),s;case 84:if(s.type="smpteOffset",c!=5)throw"Expected length for smpteOffset event is 5, got "+c;var u=e.readUInt8(),d={0:24,32:25,64:29,96:30};return s.frameRate=d[u&96],s.hour=u&31,s.min=e.readUInt8(),s.sec=e.readUInt8(),s.frame=e.readUInt8(),s.subFrame=e.readUInt8(),s;case 88:if(s.type="timeSignature",c!=2&&c!=4)throw"Expected length for timeSignature event is 4 or 2, got "+c;return s.numerator=e.readUInt8(),s.denominator=1<<e.readUInt8(),c===4?(s.metronome=e.readUInt8(),s.thirtyseconds=e.readUInt8()):(s.metronome=36,s.thirtyseconds=8),s;case 89:if(s.type="keySignature",c!=2)throw"Expected length for keySignature event is 2, got "+c;return s.key=e.readInt8(),s.scale=e.readUInt8(),s;case 127:return s.type="sequencerSpecific",s.data=e.readBytes(c),s;default:return s.type="unknownMeta",s.data=e.readBytes(c),s.metatypeByte=l,s}}else if(a==240){s.type="sysEx";var c=e.readVarInt();return s.data=e.readBytes(c),s}else if(a==247){s.type="endSysEx";var c=e.readVarInt();return s.data=e.readBytes(c),s}else throw"Unrecognised MIDI event type byte: "+a;else{var f;if((a&128)===0){if(n===null)throw"Running status byte encountered before status byte";f=a,a=n,s.running=!0}else f=e.readUInt8(),n=a;var p=a>>4;switch(s.channel=a&15,p){case 8:return s.type="noteOff",s.noteNumber=f,s.velocity=e.readUInt8(),s;case 9:var y=e.readUInt8();return s.type=y===0?"noteOff":"noteOn",s.noteNumber=f,s.velocity=y,y===0&&(s.byte9=!0),s;case 10:return s.type="noteAftertouch",s.noteNumber=f,s.amount=e.readUInt8(),s;case 11:return s.type="controller",s.controllerType=f,s.value=e.readUInt8(),s;case 12:return s.type="programChange",s.programNumber=f,s;case 13:return s.type="channelAftertouch",s.amount=f,s;case 14:return s.type="pitchBend",s.value=f+(e.readUInt8()<<7)-8192,s;default:throw"Unrecognised MIDI event type: "+p}}}}function v(o){this.buffer=o,this.bufferLen=this.buffer.length,this.pos=0}v.prototype.eof=function(){return this.pos>=this.bufferLen};v.prototype.readUInt8=function(){var o=this.buffer[this.pos];return this.pos+=1,o};v.prototype.readInt8=function(){var o=this.readUInt8();return o&128?o-256:o};v.prototype.readUInt16=function(){var o=this.readUInt8(),e=this.readUInt8();return(o<<8)+e};v.prototype.readInt16=function(){var o=this.readUInt16();return o&32768?o-65536:o};v.prototype.readUInt24=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(o<<16)+(e<<8)+t};v.prototype.readInt24=function(){var o=this.readUInt24();return o&8388608?o-16777216:o};v.prototype.readUInt32=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),r=this.readUInt8();return(o<<24)+(e<<16)+(t<<8)+r};v.prototype.readBytes=function(o){var e=this.buffer.slice(this.pos,this.pos+o);return this.pos+=o,e};v.prototype.readString=function(o){var e=this.readBytes(o);return String.fromCharCode.apply(null,e)};v.prototype.readVarInt=function(){for(var o=0;!this.eof();){var e=this.readUInt8();if(e&128)o+=e&127,o<<=7;else return o+e}return o};v.prototype.readChunk=function(){var o=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:o,length:e,data:t}};oe.exports=Ce});var le=_((pt,ie)=>{function Ae(o,e){if(typeof o!="object")throw"Invalid MIDI data";e=e||{};var t=o.header||{},r=o.tracks||[],n,i=r.length,s=new b;for(Re(s,t,i),n=0;n<i;n++)Be(s,r[n],e);return s.buffer}function Re(o,e,t){var r=e.format==null?1:e.format,n=128;e.timeDivision?n=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?n=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(n=e.ticksPerBeat&32767);var i=new b;i.writeUInt16(r),i.writeUInt16(t),i.writeUInt16(n),o.writeChunk("MThd",i.buffer)}function Be(o,e,t){var r=new b,n,i=e.length,s=null;for(n=0;n<i;n++)(t.running===!1||!t.running&&!e[n].running)&&(s=null),s=Le(r,e[n],s,t.useByte9ForNoteOff);o.writeChunk("MTrk",r.buffer)}function Le(o,e,t,r){var n=e.type,i=e.deltaTime,s=e.text||"",a=e.data||[],l=null;switch(o.writeVarInt(i),n){case"sequenceNumber":o.writeUInt8(255),o.writeUInt8(0),o.writeVarInt(2),o.writeUInt16(e.number);break;case"text":o.writeUInt8(255),o.writeUInt8(1),o.writeVarInt(s.length),o.writeString(s);break;case"copyrightNotice":o.writeUInt8(255),o.writeUInt8(2),o.writeVarInt(s.length),o.writeString(s);break;case"trackName":o.writeUInt8(255),o.writeUInt8(3),o.writeVarInt(s.length),o.writeString(s);break;case"instrumentName":o.writeUInt8(255),o.writeUInt8(4),o.writeVarInt(s.length),o.writeString(s);break;case"lyrics":o.writeUInt8(255),o.writeUInt8(5),o.writeVarInt(s.length),o.writeString(s);break;case"marker":o.writeUInt8(255),o.writeUInt8(6),o.writeVarInt(s.length),o.writeString(s);break;case"cuePoint":o.writeUInt8(255),o.writeUInt8(7),o.writeVarInt(s.length),o.writeString(s);break;case"channelPrefix":o.writeUInt8(255),o.writeUInt8(32),o.writeVarInt(1),o.writeUInt8(e.channel);break;case"portPrefix":o.writeUInt8(255),o.writeUInt8(33),o.writeVarInt(1),o.writeUInt8(e.port);break;case"endOfTrack":o.writeUInt8(255),o.writeUInt8(47),o.writeVarInt(0);break;case"setTempo":o.writeUInt8(255),o.writeUInt8(81),o.writeVarInt(3),o.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":o.writeUInt8(255),o.writeUInt8(84),o.writeVarInt(5);var c={24:0,25:32,29:64,30:96},u=e.hour&31|c[e.frameRate];o.writeUInt8(u),o.writeUInt8(e.min),o.writeUInt8(e.sec),o.writeUInt8(e.frame),o.writeUInt8(e.subFrame);break;case"timeSignature":o.writeUInt8(255),o.writeUInt8(88),o.writeVarInt(4),o.writeUInt8(e.numerator);var d=Math.floor(Math.log(e.denominator)/Math.LN2)&255;o.writeUInt8(d),o.writeUInt8(e.metronome),o.writeUInt8(e.thirtyseconds||8);break;case"keySignature":o.writeUInt8(255),o.writeUInt8(89),o.writeVarInt(2),o.writeInt8(e.key),o.writeUInt8(e.scale);break;case"sequencerSpecific":o.writeUInt8(255),o.writeUInt8(127),o.writeVarInt(a.length),o.writeBytes(a);break;case"unknownMeta":e.metatypeByte!=null&&(o.writeUInt8(255),o.writeUInt8(e.metatypeByte),o.writeVarInt(a.length),o.writeBytes(a));break;case"sysEx":o.writeUInt8(240),o.writeVarInt(a.length),o.writeBytes(a);break;case"endSysEx":o.writeUInt8(247),o.writeVarInt(a.length),o.writeBytes(a);break;case"noteOff":var f=r!==!1&&e.byte9||r&&e.velocity==0?144:128;l=f|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteOn":l=144|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteAftertouch":l=160|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.noteNumber),o.writeUInt8(e.amount);break;case"controller":l=176|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.controllerType),o.writeUInt8(e.value);break;case"programChange":l=192|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.programNumber);break;case"channelAftertouch":l=208|e.channel,l!==t&&o.writeUInt8(l),o.writeUInt8(e.amount);break;case"pitchBend":l=224|e.channel,l!==t&&o.writeUInt8(l);var p=8192+e.value,y=p&127,Z=p>>7&127;o.writeUInt8(y),o.writeUInt8(Z);break;default:throw"Unrecognized event type: "+n}return l}function b(){this.buffer=[]}b.prototype.writeUInt8=function(o){this.buffer.push(o&255)};b.prototype.writeInt8=b.prototype.writeUInt8;b.prototype.writeUInt16=function(o){var e=o>>8&255,t=o&255;this.writeUInt8(e),this.writeUInt8(t)};b.prototype.writeInt16=b.prototype.writeUInt16;b.prototype.writeUInt24=function(o){var e=o>>16&255,t=o>>8&255,r=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(r)};b.prototype.writeInt24=b.prototype.writeUInt24;b.prototype.writeUInt32=function(o){var e=o>>24&255,t=o>>16&255,r=o>>8&255,n=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(r),this.writeUInt8(n)};b.prototype.writeInt32=b.prototype.writeUInt32;b.prototype.writeBytes=function(o){this.buffer=this.buffer.concat(Array.prototype.slice.call(o,0))};b.prototype.writeString=function(o){var e,t=o.length,r=[];for(e=0;e<t;e++)r.push(o.codePointAt(e));this.writeBytes(r)};b.prototype.writeVarInt=function(o){if(o<0)throw"Cannot write negative variable-length integer";if(o<=127)this.writeUInt8(o);else{var e=o,t=[];for(t.push(e&127),e>>=7;e;){var r=e&127|128;t.push(r),e>>=7}this.writeBytes(t.reverse())}};b.prototype.writeChunk=function(o,e){this.writeString(o),this.writeUInt32(e.length),this.writeBytes(e)};ie.exports=Ae});var ce=_(z=>{z.parseMidi=ae();z.writeMidi=le()});var Pe=De(ce());var T=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,r=t+e,n=this.data,i=n.subarray(t,r).indexOf(0);i<0&&(i=e);let s=new Array(i);for(let a=0;a<i;a++)s[a]=n[t+a];return this.offset=r,String.fromCharCode(...s)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function J(o,e,t){let r=new T(o,e),n=r.readString(4),i=r.readDWORD(t);return new Q(n,i,r.offset)}function X(o,e=0,t,{padding:r=!0,bigEndian:n=!1}={}){let i=[],s=t+e,a=e;for(;a<s;){let l=J(o,a,n);a=l.offset+l.size,r&&(a-e&1)===1&&a++,i.push(l)}return i}var Q=class{constructor(e,t,r){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:r})}};var P=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var m=class o{constructor(e,t,r,n,i){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:i})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,r=e&127,n=e>>7&1,i=e>>8&1,s=e>>9&1;return new o(t,s,i,n,r)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var Y=class o{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),r=e.readInt8();return new o(t,r)}},U=class o{constructor(e,t,r,n,i,s,a,l,c,u,d){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:d})}static parse(e,t){function r(S){for(let I=0;I<t.length;I++)if(t[I].type===S)return t[I]}function n(S){return new T(e,S.offset)}function i(S){let I=r(S);return I?n(I).readString(I.size):null}function s(S){let I=r(S);return I?Y.parse(n(I)):null}let a=i("ICMT"),l=i("ICOP"),c=i("ICRD"),u=i("IENG"),d=i("INAM"),f=i("IPRD"),p=i("ISFT"),y=s("ifil"),Z=i("isng"),Te=i("irom"),Oe=s("iver");return new o(a,l,c,u,d,f,p,y,Z,Te,Oe)}},M=class o{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),r=e.readWORD();return new o(t,r)}},N=class o{constructor(e,t,r,n,i,s,a){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:a})}get isEnd(){let{presetName:e,preset:t,bank:r,library:n,genre:i,morphology:s}=this;return e==="EOP"||e===""&&t+r+n+i+s===0}static parse(e){let t=e.readString(20),r=e.readWORD(),n=e.readWORD(),i=e.readWORD(),s=e.readDWORD(),a=e.readDWORD(),l=e.readDWORD();return new o(t,r,n,i,s,a,l)}},k=class o{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),r=e.readByte();return new o(t,r)}},g=class o{constructor(e,t,r,n,i){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"amount",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:i})}transform(e){let t=this.amount*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),r=e.readWORD(),n=e.readInt16(),i=e.readWORD(),s=e.readWORD(),a=m.parse(t),l=m.parse(i);return new o(a,r,n,l,s)}},V=class o{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return P[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),r=P[t],n;switch(r){case"keyRange":case"velRange":n=k.parse(e);break;case"instrument":case"sampleID":n=e.readUInt16();break;default:n=e.readInt16();break}return new o(t,n)}},A=class o{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new o;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},R=class o{constructor(e,t,r,n,i,s,a,l,c,u){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:u})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let r=e.readString(20),n=e.readDWORD(),i=e.readDWORD(),s=e.readDWORD(),a=e.readDWORD(),l=e.readDWORD(),c=e.readByte(),u=e.readInt8(),d=e.readWORD(),f=e.readWORD();return t||(s-=n,a-=n),new o(r,n,i,s,a,l,c,u,d,f)}};var h=class{constructor(e,t,r){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=r}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};var je=["pcm16","pcm24","compressed"],He=new Set(je),B=class{constructor(e,t,r){if(Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!He.has(e))throw new Error(`Invalid AudioDataType: ${e}`);this.type=e,this.sampleHeader=t,this.data=r}decodePCM(e){let{type:t}=this;if(t==="pcm16"){let n=e.byteLength/2,i=new Float32Array(n),s=new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);for(let a=0;a<n;a++)i[a]=s[a]/32768;return i}else{let n=e.byteLength/3,i=new Float32Array(n);for(let s=0;s<n;s++){let a=s*3,l=e[a]|e[a+1]<<8|e[a+2]<<16;l&8388608&&(l|=4278190080),i[s]=l/8388608}return i}}async toAudioBuffer(e,t,r){if(this.type==="compressed"){let n=this.data.slice(t,r);return await e.decodeAudioData(n.buffer)}else{let n=this.data.subarray(t,r),i=this.decodePCM(n),s=new AudioBuffer({numberOfChannels:1,length:i.length,sampleRate:this.sampleHeader.sampleRate});return s.getChannelData(0).set(i),s}}};function ee(o,e={}){let t=X(o,0,o.length,e);if(t.length!==1)throw new Error("wrong chunk length");let r=t[0];if(r===null)throw new Error("chunk not found");function n(l,c,u={}){let d=L(l,c,"RIFF","sfbk",u);if(d.length!==3)throw new Error("invalid sfbk structure");let f=Ge(d[0],c),p=f.version.major===3;return p&&d[2].type!=="LIST"&&(d[2]=J(c,d[2].offset-9,!1)),{info:f,samplingData:We(d[1],c),...i(d[2],c,p)}}function i(l,c,u){let d=L(l,c,"LIST","pdta");if(d.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:qe(d[0],c),presetZone:Ke(d[1],c),presetModulators:_e(d[2],c),presetGenerators:Qe(d[3],c),instruments:$e(d[4],c),instrumentZone:Ze(d[5],c),instrumentModulators:ze(d[6],c),instrumentGenerators:Je(d[7],c),sampleHeaders:Xe(d[8],c,u)}}let s=n(r,o,e),a=s.info.version.major===3;return{...s,samples:Ye(s.sampleHeaders,s.samplingData.offsetMSB,s.samplingData.offsetLSB,o,a)}}function L(o,e,t,r,n={}){if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let i=new T(e,o.offset),s=i.readString(4);if(s!==r)throw new Error("invalid signature:"+s);return X(e,i.offset,o.size-4,n)}function Ge(o,e){let t=L(o,e,"LIST","INFO");return U.parse(e,t)}function We(o,e){let t=L(o,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function O(o,e,t,r,n,i){let s=[];if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let a=new T(e,o.offset),l=o.offset+o.size;for(;a.offset<l;){let c=r.parse(a,i);if(n&&n(c))break;s.push(c)}return s}var qe=(o,e)=>O(o,e,"phdr",N,t=>t.isEnd),Ke=(o,e)=>O(o,e,"pbag",M),$e=(o,e)=>O(o,e,"inst",A,t=>t.isEnd),Ze=(o,e)=>O(o,e,"ibag",M),_e=(o,e)=>O(o,e,"pmod",g),ze=(o,e)=>O(o,e,"imod",g),Qe=(o,e)=>O(o,e,"pgen",V,t=>t.isEnd),Je=(o,e)=>O(o,e,"igen",V),Xe=(o,e,t)=>O(o,e,"shdr",R,r=>r.isEnd,t);function Ye(o,e,t,r,n){let i=new Array(o.length),s=n?1:2,a=n?"compressed":t?"pcm24":"pcm16";for(let l=0;l<o.length;l++){let{start:c,end:u}=o[l],d=e+c*s,f=e+u*s,p=r.subarray(d,f);i[l]=new B(a,o[l],p)}return i}var fe=new Map;for(let o=0;o<P.length;o++)fe.set(P[o],o);var et=["instrument","sampleID"],pe=["keyRange","velRange"],me=["keynum","velocity"],ye=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],ue=[...ye,...me],be=new Set;for(let o=0;o<ue.length;o++){let e=ue[o],t=fe.get(e);t!==void 0&&be.add(t)}function ge(o){let e={},t=Object.keys(o);for(let r of t){let n=o[r];if(D(r))e[r]=n;else{let i=n;e[r]=i.clamp(i.defaultValue)}}return e}var de=[["keynum","keyRange"],["velocity","velRange"]],tt=new Set(pe);function D(o){return tt.has(o)}var rt=new Set([...et,...pe,...me,...ye]);function nt(){let o=[],e=P.length;for(let t=0;t<e;t++){let r=P[t];r!==void 0&&!rt.has(r)&&o.push(r)}return o}var H=nt(),st=new Set(H);function te(o){return st.has(o)}function ve(o){let e={};for(let t=0;t<o.length;t++){let r=o[t],n=r.type;if(n!==void 0&&!be.has(r.code))if(D(n))e[n]=r.value;else{let i=n;e[i]=r.value}}return e}function xe(o){let e={};for(let t=0;t<o.length;t++){let r=o[t],n=r.type;if(n!==void 0)if(D(n))e[n]=r.value;else{let i=n;e[i]=r.value}}for(let t=0;t<de.length;t++){let[r,n]=de[t],i=e[r];i!==void 0&&(e[n]=new k(i,i))}return e}var F=-32768,E=32767,he=0,j=65535,G={startAddrsOffset:new h(0,0,E),endAddrsOffset:new h(F,0,0),startloopAddrsOffset:new h(F,0,E),endloopAddrsOffset:new h(F,0,E),startAddrsCoarseOffset:new h(0,0,E),modLfoToPitch:new h(-12e3,0,12e3),vibLfoToPitch:new h(-12e3,0,12e3),modEnvToPitch:new h(-12e3,0,12e3),initialFilterFc:new h(1500,13500,13500),initialFilterQ:new h(0,0,960),modLfoToFilterFc:new h(-12e3,0,12e3),modEnvToFilterFc:new h(-12e3,0,12e3),endAddrsCoarseOffset:new h(F,0,0),modLfoToVolume:new h(-960,0,960),chorusEffectsSend:new h(0,0,1e3),reverbEffectsSend:new h(0,0,1e3),pan:new h(-500,0,500),delayModLFO:new h(-12e3,-12e3,5e3),freqModLFO:new h(-16e3,0,4500),delayVibLFO:new h(-12e3,-12e3,5e3),freqVibLFO:new h(-16e3,0,4500),delayModEnv:new h(-12e3,-12e3,5e3),attackModEnv:new h(-12e3,-12e3,8e3),holdModEnv:new h(-12e3,-12e3,5e3),decayModEnv:new h(-12e3,-12e3,8e3),sustainModEnv:new h(0,0,1e3),releaseModEnv:new h(-12e3,-12e3,8e3),keynumToModEnvHold:new h(-1200,0,1200),keynumToModEnvDecay:new h(-1200,0,1200),delayVolEnv:new h(-12e3,-12e3,5e3),attackVolEnv:new h(-12e3,-12e3,8e3),holdVolEnv:new h(-12e3,-12e3,5e3),decayVolEnv:new h(-12e3,-12e3,8e3),sustainVolEnv:new h(0,0,1440),releaseVolEnv:new h(-12e3,-12e3,8e3),keynumToVolEnvHold:new h(-1200,0,1200),keynumToVolEnvDecay:new h(-1200,0,1200),instrument:new h(he,j,j),keyRange:new k(0,127),velRange:new k(0,127),startloopAddrsCoarseOffset:new h(F,0,E),keynum:new h(-1,-1,127),velocity:new h(-1,-1,127),initialAttenuation:new h(0,0,1440),endloopAddrsCoarseOffset:new h(F,0,E),coarseTune:new h(-120,0,120),fineTune:new h(-99,0,99),sampleID:new h(he,j,j),sampleModes:new h(0,0,3),scaleTuning:new h(0,100,100),exclusiveClass:new h(0,0,127),overridingRootKey:new h(-1,-1,127)};function x(o){return Math.pow(2,o/1200)}var W=class{constructor(e,t,r,n,i){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(s,a)=>{s.modLfoToPitch=this.clamp("modLfoToPitch",a)},vibLfoToPitch:(s,a)=>{s.vibLfoToPitch=this.clamp("vibLfoToPitch",a)},modEnvToPitch:(s,a)=>{s.modEnvToPitch=this.clamp("modEnvToPitch",a)},initialFilterFc:(s,a)=>{s.initialFilterFc=this.clamp("initialFilterFc",a)},initialFilterQ:(s,a)=>{s.initialFilterQ=this.clamp("initialFilterQ",a)},modLfoToFilterFc:(s,a)=>{s.modLfoToFilterFc=this.clamp("modLfoToFilterFc",a)},modEnvToFilterFc:(s,a)=>{s.modEnvToFilterFc=this.clamp("modEnvToFilterFc",a)},modLfoToVolume:(s,a)=>{s.modLfoToVolume=this.clamp("modLfoToVolume",a)},chorusEffectsSend:(s,a)=>{s.chorusEffectsSend=this.clamp("chorusEffectsSend",a)/1e3},reverbEffectsSend:(s,a)=>{s.reverbEffectsSend=this.clamp("reverbEffectsSend",a)/1e3},pan:(s,a)=>{s.pan=this.clamp("pan",a)/1e3},delayModLFO:(s,a)=>{s.delayModLFO=x(this.clamp("delayModLFO",a))},freqModLFO:(s,a)=>{s.freqModLFO=this.clamp("freqModLFO",a)},delayVibLFO:(s,a)=>{s.delayVibLFO=x(this.clamp("delayVibLFO",a))},freqVibLFO:(s,a)=>{s.freqVibLFO=this.clamp("freqVibLFO",a)},delayModEnv:(s,a)=>{s.modDelay=x(this.clamp("delayModEnv",a))},attackModEnv:(s,a)=>{s.modAttack=x(this.clamp("attackModEnv",a))},holdModEnv:(s,a)=>{let l=this.clamp("holdModEnv",a),c=this.clamp("keynumToModEnvHold",a);s.modHold=this.getModHold(l,c)},decayModEnv:(s,a)=>{let l=this.clamp("decayModEnv",a),c=this.clamp("keynumToModEnvDecay",a);s.modDecay=this.getModDecay(l,c)},sustainModEnv:(s,a)=>{s.modSustain=this.clamp("sustainModEnv",a)/1e3},releaseModEnv:(s,a)=>{s.modRelease=x(this.clamp("releaseModEnv",a))},keynumToModEnvHold:(s,a)=>{let l=this.clamp("holdModEnv",a),c=this.clamp("keynumToModEnvHold",a);s.modHold=this.getModHold(l,c)},keynumToModEnvDecay:(s,a)=>{let l=this.clamp("decayModEnv",a),c=this.clamp("keynumToModEnvDecay",a);s.modDecay=this.getModDecay(l,c)},delayVolEnv:(s,a)=>{s.volDelay=x(this.clamp("delayVolEnv",a))},attackVolEnv:(s,a)=>{s.volAttack=x(this.clamp("attackVolEnv",a))},holdVolEnv:(s,a)=>{let l=this.clamp("holdVolEnv",a),c=this.clamp("keynumToVolEnvHold",a);s.volHold=this.getVolHold(l,c)},decayVolEnv:(s,a)=>{let l=this.clamp("decayVolEnv",a),c=this.clamp("keynumToVolEnvDecay",a);s.volDecay=this.getVolDecay(l,c)},sustainVolEnv:(s,a)=>{s.volSustain=this.clamp("sustainVolEnv",a)/1e3},releaseVolEnv:(s,a)=>{s.volRelease=x(this.clamp("releaseVolEnv",a))},keynumToVolEnvHold:(s,a)=>{let l=this.clamp("holdVolEnv",a),c=this.clamp("keynumToVolEnvHold",a);s.modHold=this.getVolHold(l,c)},keynumToVolEnvDecay:(s,a)=>{let l=this.clamp("decayVolEnv",a),c=this.clamp("keynumToVolEnvDecay",a);s.modDecay=this.getVolDecay(l,c)},initialAttenuation:(s,a)=>{s.initialAttenuation=this.clamp("initialAttenuation",a)},coarseTune:(s,a)=>{s.playbackRate=this.getPlaybackRate(a)},fineTune:(s,a)=>{s.playbackRate=this.getPlaybackRate(a)},scaleTuning:(s,a)=>{s.playbackRate=this.getPlaybackRate(a)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],r=t.sourceOper.controllerType,n=t.destinationOper,i=this.controllerToDestinations.get(r);i?i.add(t.destinationOper):this.controllerToDestinations.set(r,new Set([n]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],r=t.destinationOper,n=this.destinationToModulators.get(r);n?n.push(t):this.destinationToModulators.set(r,[t])}}getModHold(e,t){return x(e+(this.key-60)*t)}getModDecay(e,t){return x(e+(this.key-60)*t)}getVolHold(e,t){return x(e+(this.key-60)*t)}getVolDecay(e,t){return x(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("coarseTune",e),r=this.clamp("fineTune",e)/100,n=this.clamp("overridingRootKey",e),i=this.clamp("scaleTuning",e)/100,s=t+r,a=n===-1?this.sampleHeader.originalPitch:n,l=s+this.sampleHeader.pitchCorrection/100-a;return Math.pow(Math.pow(2,1/12),(this.key+l)*i)}transformParams(e,t){let r={},n=this.controllerToDestinations.get(e);if(!n)return r;for(let i of n){let s=P[i];if(!s||!te(s))continue;let a=this.destinationToModulators.get(i);if(a){r[s]=this.generators[s];for(let l of a){let c=l.sourceOper,u=c.map(t[c.controllerType]),d=1,f=l.amountSourceOper;if(!(f.cc===0&&f.index===0)){let y=t[f.controllerType];d=f.map(y)}let p=l.transform(u*d);Number.isNaN(p)||(r[s]+=p)}}}return r}transformAllParams(e){let t=structuredClone(this.generators);for(let r of this.modulators){let n=r.sourceOper.controllerType,i=e[n];if(!i)continue;let s=P[r.destinationOper];if(!s||!te(s))continue;let l=r.sourceOper.map(i),c=1,u=r.amountSourceOper;if(!(u.cc===0&&u.index===0)){let f=e[u.controllerType];c=u.map(f)}let d=r.transform(l*c);Number.isNaN(d)||(t[s]+=d)}return t}clamp(e,t){return G[e].clamp(t[e])}getParams(e,t){let r={},n=structuredClone(this.generators),i=this.transformParams(e,t),s=Object.keys(i);for(let a of s)n[a]=i[a];for(let a of s)this.voiceHandlers[a](r,n);return r}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,instrument:this.generators.instrument,sampleID:this.generators.sampleID,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},r=this.transformAllParams(e);for(let n=0;n<H.length;n++){let i=H[n];this.voiceHandlers[i](t,r)}return t}};var we=[new g(m.parse(1282),48,960,m.parse(0),0),new g(m.parse(258),8,-2400,m.parse(0),0),new g(m.parse(13),6,50,m.parse(0),0),new g(m.parse(129),6,50,m.parse(0),0),new g(m.parse(1415),48,960,m.parse(0),0),new g(m.parse(650),48,1,m.parse(0),0),new g(m.parse(1419),48,960,m.parse(0),0),new g(m.parse(219),16,.2,m.parse(0),0),new g(m.parse(221),15,.2,m.parse(0),0),new g(m.parse(526),51,127,m.parse(16),0)];var q=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},K=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},C=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,r,n){let i=new Array(n-r);for(let s=r;s<n;s++){let a=t[s].generatorIndex,l=t[s+1].generatorIndex;i[s-r]=e.slice(a,l)}return i}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],r=this.parsed.presetHeaders[e+1],n=r?r.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,n)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],r=this.parsed.instruments[e+1],n=r?r.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,n)}getModulators(e,t,r,n){let i=new Array(n-r);for(let s=r;s<n;s++){let a=t[s].modulatorIndex,l=t[s+1].modulatorIndex;i[s-r]=e.slice(a,l)}return i}getPresetModulators(e){let t=this.parsed.presetHeaders[e],r=this.parsed.presetHeaders[e+1],n=r?r.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,n)}getInstrumentModulators(e){let t=this.parsed.instruments[e],r=this.parsed.instruments[e+1],n=r?r.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,n)}findInstrumentZone(e,t,r){let n=this.getInstrumentGenerators(e),i=this.getInstrumentModulators(e),s,a=[];for(let l=0;l<n.length;l++){let c=xe(n[l]);if(c.sampleID===void 0){s=c,a=i[l];continue}if(!(c.keyRange&&!c.keyRange.in(t))&&!(c.velRange&&!c.velRange.in(r)))if(s){let u={...s,...c},d=[...a,...i[l]];return new q(u,d)}else return new q(c,i[l])}}findInstrument(e,t,r){let n=this.getPresetGenerators(e),i=this.getPresetModulators(e),s,a=[];for(let l=0;l<n.length;l++){let c=ve(n[l]);if(c.instrument===void 0){s=c,a=i[l];continue}if(c.keyRange&&!c.keyRange.in(t)||c.velRange&&!c.velRange.in(r))continue;let u=this.findInstrumentZone(c.instrument,t,r);if(u)if(s){let d={...s,...c},f=[...a,...i[l]],p=new K(d,f);return this.createVoice(t,p,u)}else{let d=new K(c,i[l]);return this.createVoice(t,d,u)}}return null}createVoice(e,t,r){let n=ge(G);Object.assign(n,r.generators);let i=Object.keys(t.generators);for(let u=0;u<i.length;u++){let d=i[u];D(d)||(n[d]+=t.generators[d])}let s=[...we,...t.modulators,...r.modulators],a=n.sampleID,l=this.parsed.samples[a],c=this.parsed.sampleHeaders[a];return new W(e,n,s,l,c)}getVoice(e,t,r,n){let i=this.parsed.presetHeaders.findIndex(a=>a.preset===t&&a.bank===e);if(i<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let s=this.findInstrument(i,r,n);return s||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let r=0;r<t.length;r++){let n=t[r];e[n.bank]||(e[n.bank]={}),e[n.bank][n.preset]=n.presetName}return e}};var re=class{voice;voiceParams;index=-1;ending=!1;pending=!0;bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;modulationLFO;modulationDepth;constructor(e,t,r){this.noteNumber=e,this.velocity=t,this.startTime=r}},w=new Uint8Array(128);w[42]=1;w[44]=1;w[46]=1,w[71]=2;w[72]=2;w[73]=3;w[74]=3;w[78]=4;w[79]=4;w[80]=5;w[81]=5;var ot=5,$={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepth:{type:129,defaultValue:0},volume:{type:135,defaultValue:100/127},pan:{type:138,defaultValue:64/127},expression:{type:139,defaultValue:1},sustainPedal:{type:192,defaultValue:0}},ne=class{array=new Float32Array(256);constructor(){let e=Object.entries($);for(let[t,{type:r,defaultValue:n}]of e)this.array[r]=n,Object.defineProperty(this,t,{get:()=>this.array[r],set:i=>this.array[r]=i,enumerable:!0,configurable:!0})}},at=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],it=new Set(at),lt=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain"],ct=new Set(lt),ut=["modEnvToPitch","modDelay","modAttack","modHold","modDecay","modSustain","playbackRate"],dt=new Set(ut),Ie=class{mode="GM1";numChannels=16;ticksPerBeat=120;totalTime=0;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=Array.from({length:128},()=>[]);voiceCounter=new Map;voiceCache=new Map;realtimeVoiceCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;playPromise;timeline=[];notePromises=[];instruments=new Set;exclusiveClassNotes=new Array(128);drumExclusiveClassNotes=new Array(this.numChannels*ot);static channelSettings={scheduleIndex:0,detune:0,programNumber:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,modulationDepthRange:50};constructor(e){this.audioContext=e,this.masterVolume=new GainNode(e),this.scheduler=new GainNode(e,{gain:0}),this.schedulerBuffer=new AudioBuffer({length:1,sampleRate:e.sampleRate}),this.messageHandlers=this.createMessageHandlers(),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.masterVolume.connect(e.destination),this.scheduler.connect(e.destination),this.GM1SystemOn()}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let r=e.parsed.presetHeaders,n=this.soundFontTable;for(let i=0;i<r.length;i++){let{preset:s,bank:a}=r[i];n[s][a]=t}}async toUint8Array(e){let t;if(typeof e=="string"){let n=await(await fetch(e)).arrayBuffer();t=new Uint8Array(n)}else if(e instanceof Uint8Array)t=e;else throw new TypeError("input must be a URL string or Uint8Array");return t}async loadSoundFont(e){if(this.voiceCounter.clear(),Array.isArray(e)){let t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=this.toUint8Array(e[n]);let r=await Promise.all(t);for(let n=0;n<r.length;n++){let i=ee(r[n]),s=new C(i);this.addSoundFont(s)}}else{let t=await this.toUint8Array(e),r=ee(t),n=new C(r);this.addSoundFont(n)}}async loadMIDI(e){this.voiceCounter.clear();let t=await this.toUint8Array(e),r=(0,Pe.parseMidi)(t);this.ticksPerBeat=r.header.ticksPerBeat;let n=this.extractMidiData(r);this.instruments=n.instruments,this.timeline=n.timeline,this.totalTime=this.calcTotalTime()}cacheVoiceIds(){let e=this.timeline;for(let t=0;t<e.length;t++){let r=e[t];switch(r.type){case"noteOn":{let n=this.getVoiceId(this.channels[r.channel],r.noteNumber,r.velocity);this.voiceCounter.set(n,(this.voiceCounter.get(n)??0)+1);break}case"controller":r.controllerType===0?this.setBankMSB(r.channel,r.value):r.controllerType===32&&this.setBankLSB(r.channel,r.value);break;case"programChange":this.setProgramChange(r.channel,r.programNumber,r.startTime)}}for(let[t,r]of this.voiceCounter)r===1&&this.voiceCounter.delete(t);this.GM1SystemOn()}getVoiceId(e,t,r){let n=e.programNumber,i=this.soundFontTable[n];if(!i)return;let s=e.isDrum?128:0,a=i[s];if(a===void 0)return;let c=this.soundFonts[a].getVoice(s,n,t,r),{instrument:u,sampleID:d}=c.generators;return a*2**32+(u<<16)+d}createChannelAudioNodes(e){let{gainLeft:t,gainRight:r}=this.panToGain($.pan.defaultValue),n=new GainNode(e,{gain:t}),i=new GainNode(e,{gain:r}),s=new ChannelMergerNode(e,{numberOfInputs:2});return n.connect(s,0,0),i.connect(s,0,1),s.connect(this.masterVolume),{gainL:n,gainR:i,merger:s}}createChannels(e){return Array.from({length:this.numChannels},()=>({currentBufferSource:null,isDrum:!1,state:new ne,...this.constructor.channelSettings,...this.createChannelAudioNodes(e),scheduledNotes:[],sustainNotes:[]}))}async createAudioBuffer(e){let t=e.sample,r=e.start,n=t.data.length+e.end;return await t.toAudioBuffer(this.audioContext,r,n)}createBufferSource(e,t,r){let n=new AudioBufferSourceNode(this.audioContext);return n.buffer=r,n.loop=t.sampleModes%2!==0,e.isDrum&&(n.loop=!1),n.loop&&(n.loopStart=t.loopStart/t.sampleRate,n.loopEnd=t.loopEnd/t.sampleRate),n}async scheduleTimelineEvents(e,t){let r=this.resumeTime-this.startTime,n=e+r+this.lookAhead,i=this.startDelay-r,s=this.timeline;for(;t<s.length;){let a=s[t];if(n<a.startTime)break;let l=a.startTime+i;switch(a.type){case"noteOn":await this.noteOn(a.channel,a.noteNumber,a.velocity,l);break;case"noteOff":{let c=this.noteOff(a.channel,a.noteNumber,a.velocity,l,!1);c&&this.notePromises.push(c);break}case"controller":this.setControlChange(a.channel,a.controllerType,a.value,l);break;case"programChange":this.setProgramChange(a.channel,a.programNumber,l);break;case"pitchBend":this.setPitchBend(a.channel,a.value+8192,l);break;case"sysEx":this.handleSysEx(a.data,l)}t++}return t}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}resetAllStates(){this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.voiceCache.clear(),this.realtimeVoiceCache.clear();for(let e=0;e<this.channels.length;e++)this.channels[e].scheduledNotes=[],this.resetChannelStates(e)}updateStates(e,t){t<e&&(e=0);for(let r=e;r<t;r++){let n=this.timeline[r];switch(n.type){case"controller":this.setControlChange(n.channel,n.controllerType,n.value,0);break;case"programChange":this.setProgramChange(n.channel,n.programNumber,0);break;case"pitchBend":this.setPitchBend(n.channel,n.value+8192,0);break;case"sysEx":this.handleSysEx(n.data,0)}}}async playNotes(){this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let e=this.getQueueIndex(this.resumeTime),t=!1;for(this.notePromises=[];e<this.timeline.length;){let r=this.audioContext.currentTime;if(this.isPausing){await this.stopNotes(0,!0,r),await this.audioContext.suspend(),this.notePromises=[];break}else if(this.isStopping){await this.stopNotes(0,!0,r),await this.audioContext.suspend(),t=!0;break}else if(this.isSeeking){await this.stopNotes(0,!0,r),this.startTime=this.audioContext.currentTime;let i=this.getQueueIndex(this.resumeTime);this.updateStates(e,i),e=i,this.isSeeking=!1;continue}e=await this.scheduleTimelineEvents(r,e);let n=r+this.noteCheckInterval;await this.scheduleTask(()=>{},n)}t&&(this.notePromises=[],this.resetAllStates()),this.isPlaying=!1}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}getSoundFontId(e){let t=e.programNumber,r=e.isDrum?"128":"000",n=t.toString().padStart(3,"0");return`${r}:${n}`}extractMidiData(e){let t=new Set,r=[],n=this.channels;for(let c=0;c<e.tracks.length;c++){let u=e.tracks[c],d=0;for(let f=0;f<u.length;f++){let p=u[f];switch(d+=p.deltaTime,p.ticks=d,p.type){case"noteOn":{let y=n[p.channel];t.add(this.getSoundFontId(y));break}case"programChange":{let y=n[p.channel];this.setProgramChange(p.channel,p.programNumber),t.add(this.getSoundFontId(y));break}}delete p.deltaTime,r.push(p)}}let i={controller:0,sysEx:1};r.sort((c,u)=>c.ticks!==u.ticks?c.ticks-u.ticks:(i[c.type]||2)-(i[u.type]||2));let s=0,a=0,l=.5;for(let c=0;c<r.length;c++){let u=r[c],d=this.ticksToSecond(u.ticks-a,l);u.startTime=s+d,u.type==="setTempo"&&(s+=this.ticksToSecond(u.ticks-a,l),l=u.microsecondsPerBeat/1e6,a=u.ticks)}return{instruments:t,timeline:r}}stopActiveNotes(e,t,r,n){let i=this.channels[e],s=[];return this.processActiveNotes(i,n,a=>{let l=this.noteOff(e,a.noteNumber,t,n,r);this.notePromises.push(l),s.push(l)}),Promise.all(s)}stopChannelNotes(e,t,r,n){let i=this.channels[e],s=[];return this.processScheduledNotes(i,a=>{let l=this.noteOff(e,a.noteNumber,t,n,r);this.notePromises.push(l),s.push(l)}),Promise.all(s)}stopNotes(e,t,r){let n=[];for(let i=0;i<this.channels.length;i++)n.push(this.stopChannelNotes(i,e,t,r));return Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,this.voiceCounter.size===0&&this.cacheVoiceIds(),this.playPromise=this.playNotes(),await this.playPromise)}async stop(){this.isPlaying&&(this.isStopping=!0,await this.playPromise,this.isStopping=!1)}async pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime=e-this.startTime-this.startDelay,this.isPausing=!0,await this.playPromise,this.isPausing=!1,this.isPaused=!0}async resume(){this.isPaused&&(this.playPromise=this.playNotes(),await this.playPromise,this.isPaused=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let r=this.timeline[t];e<r.startTime&&(e=r.startTime)}return e+this.startDelay}currentTime(){return this.isPlaying?this.audioContext.currentTime+this.resumeTime-this.startTime:this.resumeTime}processScheduledNotes(e,t){let r=e.scheduledNotes;for(let n=e.scheduleIndex;n<r.length;n++){let i=r[n];i&&(i.ending||t(i))}}processActiveNotes(e,t,r){let n=e.scheduledNotes;for(let i=e.scheduleIndex;i<n.length;i++){let s=n[i];if(s&&!s.ending){if(t<s.startTime)break;r(s)}}}cbToRatio(e){return Math.pow(10,e/200)}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=e.state.pitchWheel*2-1,r=e.state.pitchWheelSensitivity*12800;return t*r}updateChannelDetune(e,t){this.processScheduledNotes(e,r=>{this.updateDetune(e,r,t)})}updateDetune(e,t,r){t.bufferSource.detune.cancelScheduledValues(r).setValueAtTime(e.detune,r)}setVolumeEnvelope(e,t){let{voiceParams:r,startTime:n}=e,i=this.cbToRatio(-r.initialAttenuation),s=i*(1-r.volSustain),a=n+r.volDelay,l=a+r.volAttack,c=l+r.volHold,u=c+r.volDecay;e.volumeEnvelopeNode.gain.cancelScheduledValues(t).setValueAtTime(0,n).setValueAtTime(1e-6,a).exponentialRampToValueAtTime(i,l).setValueAtTime(i,c).linearRampToValueAtTime(s,u)}setPitchEnvelope(e,t){let{voiceParams:r}=e,n=r.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(n,t);let i=r.modEnvToPitch;if(i===0)return;let a=this.rateToCent(n)+i,l=this.centToRate(a),c=e.startTime+r.modDelay,u=c+r.modAttack,d=u+r.modHold,f=d+r.modDecay;e.bufferSource.playbackRate.setValueAtTime(n,c).exponentialRampToValueAtTime(l,u).setValueAtTime(l,d).linearRampToValueAtTime(n,f)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setFilterEnvelope(e,t){let{voiceParams:r,startTime:n}=e,i=this.centToHz(r.initialFilterFc),s=this.centToHz(r.initialFilterFc+r.modEnvToFilterFc),a=i+(s-i)*(1-r.modSustain),l=this.clampCutoffFrequency(i),c=this.clampCutoffFrequency(s),u=this.clampCutoffFrequency(a),d=n+r.modDelay,f=d+r.modAttack,p=f+r.modHold,y=p+r.modDecay;e.filterNode.frequency.cancelScheduledValues(t).setValueAtTime(l,n).setValueAtTime(l,d).exponentialRampToValueAtTime(c,f).setValueAtTime(c,p).linearRampToValueAtTime(u,y)}startModulation(e,t,r){let{voiceParams:n}=t;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(n.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:n.modLfoToFilterFc}),t.modulationDepth=new GainNode(this.audioContext),this.setModLfoToPitch(e,t,r),t.volumeDepth=new GainNode(this.audioContext),this.setModLfoToVolume(t,r),t.modulationLFO.start(t.startTime+n.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}async getAudioBuffer(e,t,r,n,i){let s=this.getVoiceId(e,t,r);if(i){let a=this.realtimeVoiceCache.get(s);if(a)return a;let l=await this.createAudioBuffer(n);return this.realtimeVoiceCache.set(s,l),l}else{let a=this.voiceCache.get(s);if(a)return a.counter+=1,a.maxCount<=a.counter&&this.voiceCache.delete(s),a.audioBuffer;{let l=this.voiceCounter.get(s)??0,c=await this.createAudioBuffer(n),u={audioBuffer:c,maxCount:l,counter:1};return this.voiceCache.set(s,u),c}}}async setNoteAudioNode(e,t,r){let n=this.audioContext.currentTime,{noteNumber:i,velocity:s,startTime:a}=t,l=e.state,c=this.getControllerState(e,i,s),u=t.voice.getAllParams(c);t.voiceParams=u;let d=await this.getAudioBuffer(e,i,s,u,r);return t.bufferSource=this.createBufferSource(e,u,d),t.volumeEnvelopeNode=new GainNode(this.audioContext),t.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:u.initialFilterQ/10}),this.setVolumeEnvelope(t,n),this.setFilterEnvelope(t,n),this.setPitchEnvelope(t,n),this.updateDetune(e,t,n),0<l.modulationDepth&&this.startModulation(e,t,n),t.bufferSource.connect(t.filterNode),t.filterNode.connect(t.volumeEnvelopeNode),t.bufferSource.start(a),t}handleExclusiveClass(e,t,r){let n=e.voiceParams.exclusiveClass;if(n===0)return;let i=this.exclusiveClassNotes[n];if(i){let[s,a]=i;s&&!s.ending&&this.noteOff(a,s.noteNumber,0,r,!0)}this.exclusiveClassNotes[n]=[e,t]}handleDrumExclusiveClass(e,t,r){if(!this.channels[t].isDrum)return;let i=w[e.noteNumber];if(i===0)return;let s=i*this.channels.length+t,a=this.drumExclusiveClassNotes[s];a&&!a.ending&&this.noteOff(t,a.noteNumber,0,r,!0),this.drumExclusiveClassNotes[s]=e}setNoteRouting(e,t,r){let n=this.channels[e],i=t.volumeEnvelopeNode;i.connect(n.gainL),i.connect(n.gainR),.5<=n.state.sustainPedal&&n.sustainNotes.push(t),this.handleExclusiveClass(t,e,r),this.handleDrumExclusiveClass(t,e,r)}async noteOn(e,t,r,n){let i=this.channels[e],s=n===void 0;s&&(n=this.audioContext.currentTime);let a=new re(t,r,n),l=i.scheduledNotes;a.index=l.length,l.push(a);let c=i.programNumber,u=this.soundFontTable[c];if(!u)return;let d=i.isDrum?128:0,f=u[d];if(f===void 0)return;let p=this.soundFonts[f];if(a.voice=p.getVoice(d,c,t,r),!a.voice)return;await this.setNoteAudioNode(i,a,s),this.setNoteRouting(e,a,n),a.pending=!1;let y=a.offEvent;y&&this.noteOff(e,t,y.velocity,y.startTime)}disconnectNote(e){e.bufferSource.disconnect(),e.filterNode.disconnect(),e.volumeEnvelopeNode.disconnect(),e.modulationDepth&&(e.volumeDepth.disconnect(),e.modulationDepth.disconnect(),e.modulationLFO.stop())}releaseNote(e,t,r){r??=this.audioContext.currentTime;let n=r+t.voiceParams.volRelease,i=r+t.voiceParams.modRelease,s=Math.min(n,i);return t.filterNode.frequency.cancelScheduledValues(r).linearRampToValueAtTime(0,i),t.volumeEnvelopeNode.gain.cancelScheduledValues(r).linearRampToValueAtTime(0,n),new Promise(a=>{this.scheduleTask(()=>{let l=t.bufferSource;l.loop=!1,l.stop(s),this.disconnectNote(t),e.scheduledNotes[t.index]=void 0,a()},s)})}noteOff(e,t,r,n,i){let s=this.channels[e];if(!i&&(s.isDrum||.5<=s.state.sustainPedal))return;let a=this.findNoteOffIndex(s,t);if(a<0)return;let l=s.scheduledNotes[a];if(l.pending){l.offEvent={velocity:r,startTime:n};return}l.ending=!0,this.setNoteIndex(s,a),this.releaseNote(s,l,n)}setNoteIndex(e,t){let r=!0;for(let n=e.scheduleIndex;n<t;n++){let i=e.scheduledNotes[n];if(i&&!i.ending){r=!1;break}}r&&(e.scheduleIndex=t+1)}findNoteOffIndex(e,t){let r=e.scheduledNotes;for(let n=e.scheduleIndex;n<r.length;n++){let i=r[n];if(i&&!i.ending&&i.noteNumber===t)return n}return-1}releaseSustainPedal(e,t,r){let n=t*2,i=this.channels[e],s=[];for(let a=0;a<i.sustainNotes.length;a++){let l=this.noteOff(e,i.sustainNotes[a].noteNumber,n,r);s.push(l)}return i.sustainNotes=[],s}createMessageHandlers(){let e=new Array(256);return e[128]=(t,r)=>this.noteOff(t[0]&15,t[1],t[2],r),e[144]=(t,r)=>this.noteOn(t[0]&15,t[1],t[2],r),e[176]=(t,r)=>this.setControlChange(t[0]&15,t[1],t[2],r),e[192]=(t,r)=>this.setProgramChange(t[0]&15,t[1],r),e[224]=(t,r)=>this.handlePitchBendMessage(t[0]&15,t[1],t[2],r),e}handleMessage(e,t){let r=e[0];if(r===240)return this.handleSysEx(e.subarray(1),t);let n=this.messageHandlers[r];n&&n(e,t)}handleChannelMessage(e,t,r,n){let i=e&15,s=e&240;switch(s){case 128:return this.noteOff(i,t,r,n);case 144:return this.noteOn(i,t,r,n);case 176:return this.setControlChange(i,t,r,n);case 192:return this.setProgramChange(i,t,n);case 224:return this.handlePitchBendMessage(i,t,r,n);default:console.warn(`Unsupported MIDI message: ${s.toString(16)}`)}}setProgramChange(e,t,r){let n=this.channels[e];n.programNumber=t}handlePitchBendMessage(e,t,r,n){let i=r*128+t;this.setPitchBend(e,i,n)}setPitchBend(e,t,r){let n=this.channels[e];r??=this.audioContext.currentTime;let i=n.state,s=i.pitchWheel*2-1,a=(t-8192)/8192;i.pitchWheel=t/16383,n.detune+=(a-s)*i.pitchWheelSensitivity*12800,this.updateChannelDetune(n,r),this.applyVoiceParams(n,14,r)}setModLfoToPitch(e,t,r){if(t.modulationDepth){let n=t.voiceParams.modLfoToPitch,s=(Math.abs(n)+e.state.modulationDepth)*Math.sign(n);t.modulationDepth.gain.cancelScheduledValues(r).setValueAtTime(s,r)}else this.startModulation(e,t,r)}setModLfoToFilterFc(e,t){let r=e.voiceParams.modLfoToFilterFc;e.filterDepth.gain.cancelScheduledValues(t).setValueAtTime(r,t)}setModLfoToVolume(e,t){let r=e.voiceParams.modLfoToVolume,i=(this.cbToRatio(Math.abs(r))-1)*Math.sign(r);e.volumeDepth.gain.cancelScheduledValues(t).setValueAtTime(i,t)}setDelayModLFO(e,t){let r=e.startTime;r<t||(e.modulationLFO.stop(t),e.modulationLFO.start(r+e.voiceParams.delayModLFO),e.modulationLFO.connect(e.filterDepth))}setFreqModLFO(e,t){let r=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(r,t)}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,r)=>{0<e.state.modulationDepth&&this.setModLfoToPitch(e,t,r)},vibLfoToPitch:(e,t,r)=>{},modLfoToFilterFc:(e,t,r)=>{0<e.state.modulationDepth&&this.setModLfoToFilterFc(t,r)},modLfoToVolume:(e,t,r)=>{0<e.state.modulationDepth&&this.setModLfoToVolume(t,r)},chorusEffectsSend:(e,t,r)=>{},reverbEffectsSend:(e,t,r)=>{},delayModLFO:(e,t,r)=>{0<channel.state.modulationDepth&&this.setDelayModLFO(t,r)},freqModLFO:(e,t,r)=>{0<channel.state.modulationDepth&&this.setFreqModLFO(t,r)},delayVibLFO:(e,t,r)=>{},freqVibLFO:(e,t,r)=>{}}}getControllerState(e,t,r){let n=new Float32Array(e.state.array.length);return n.set(e.state.array),n[2]=r/127,n[3]=t/127,n}applyVoiceParams(e,t,r){this.processScheduledNotes(e,n=>{let i=this.getControllerState(e,n.noteNumber,n.velocity),s=n.voice.getParams(t,i),a=!1,l=!1,c=!1;for(let[u,d]of Object.entries(s)){let f=n.voiceParams[u];d!==f&&(n.voiceParams[u]=d,u in this.voiceParamsHandlers?this.voiceParamsHandlers[u](e,n,r):(it.has(u)&&(a=!0),ct.has(u)&&(l=!0),dt.has(u)&&(c=!0)))}a&&this.setVolumeEnvelope(n,r),l&&this.setFilterEnvelope(n,r),c&&this.setPitchEnvelope(n,r)})}createControlChangeHandlers(){let e=new Array(128);return e[1]=this.setModulationDepth,e[6]=this.dataEntryMSB,e[7]=this.setVolume,e[10]=this.setPan,e[11]=this.setExpression,e[38]=this.dataEntryLSB,e[64]=this.setSustainPedal,e[100]=this.setRPNLSB,e[101]=this.setRPNMSB,e[120]=this.allSoundOff,e[121]=this.resetAllControllers,e[123]=this.allNotesOff,e}setControlChange(e,t,r,n){let i=this.controlChangeHandlers[t];if(i){i.call(this,e,r,n);let s=this.channels[e];this.applyVoiceParams(s,t+128,n)}else console.warn(`Unsupported Control change: controllerType=${t} value=${r}`)}updateModulation(e,t){let r=e.state.modulationDepth*e.modulationDepthRange;this.processScheduledNotes(e,n=>{n.modulationDepth?n.modulationDepth.gain.setValueAtTime(r,t):this.startModulation(e,n,t)})}setModulationDepth(e,t,r){let n=this.channels[e];r??=this.audioContext.currentTime,n.state.modulationDepth=t/127,this.updateModulation(n,r)}setVolume(e,t,r){r??=this.audioContext.currentTime;let n=this.channels[e];n.state.volume=t/127,this.updateChannelVolume(n,r)}panToGain(e){let t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t,r){r??=this.audioContext.currentTime;let n=this.channels[e];n.state.pan=t/127,this.updateChannelVolume(n,r)}setExpression(e,t,r){r??=this.audioContext.currentTime;let n=this.channels[e];n.state.expression=t/127,this.updateChannelVolume(n,r)}dataEntryLSB(e,t,r){this.channels[e].dataLSB=t,this.handleRPN(e,r)}updateChannelVolume(e,t){let r=e.state,n=r.volume*r.expression,{gainLeft:i,gainRight:s}=this.panToGain(r.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(n*i,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(n*s,t)}setSustainPedal(e,t,r){let n=this.channels[e];r??=this.audioContext.currentTime,n.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(n,i=>{n.sustainNotes.push(i)}):this.releaseSustainPedal(e,t,r)}limitData(e,t,r,n,i){i<e.dataLSB?(e.dataMSB++,e.dataLSB=n):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=i),r<e.dataMSB?(e.dataMSB=r,e.dataLSB=i):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=n)}handleRPN(e,t){let r=this.channels[e];switch(r.rpnMSB*128+r.rpnLSB){case 0:this.handlePitchBendRangeRPN(e,t);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${r.rpnMSB} LSB=${r.rpnLSB}`)}}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,r){this.channels[e].dataMSB=t,this.handleRPN(e,r)}handlePitchBendRangeRPN(e,t){let r=this.channels[e];this.limitData(r,0,127,0,127);let n=(r.dataMSB+r.dataLSB/128)*100;this.setPitchBendRange(e,n,t)}setPitchBendRange(e,t,r){let n=this.channels[e];r??=this.audioContext.currentTime;let i=n.state,s=i.pitchWheelSensitivity,a=t/12800;i.pitchWheelSensitivity=a,n.detune+=(i.pitchWheel*2-1)*(a-s)*12800,this.updateChannelDetune(n,r),this.applyVoiceParams(n,16,r)}allSoundOff(e,t,r){return r??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!0,r)}resetChannelStates(e){let t=this.audioContext.currentTime,r=this.channels[e],n=r.state,i=Object.entries($);for(let[s,{type:a,defaultValue:l}]of i)128<=a?this.setControlChange(e,a-128,Math.ceil(l*127),t):n[s]=l;for(let s of Object.keys(this.constructor.channelSettings))r[s]=this.constructor.channelSettings[s];this.mode="GM1"}resetAllControllers(e,t,r){let n=["pitchWheel","expression","modulationDepth","sustainPedal"],i=this.channels[e],s=i.state;for(let l=0;l<n.length;l++){let c=n[l],{type:u,defaultValue:d}=$[c];128<=u?this.setControlChange(e,u-128,Math.ceil(d*127),r):s[c]=d}this.setPitchBend(e,8192,r);let a=["rpnMSB","rpnLSB"];for(let l=0;l<a.length;l++){let c=a[l];i[c]=this.constructor.channelSettings[c]}}allNotesOff(e,t,r){return r??=this.audioContext.currentTime,this.stopActiveNotes(e,0,!1,r)}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 9:switch(e[3]){case 1:this.GM1SystemOn(t);break;case 2:break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(e){e??=this.audioContext.currentTime,this.mode="GM1";for(let t=0;t<this.channels.length;t++){this.allSoundOff(t,0,e);let r=this.channels[t];r.isDrum=!1}this.channels[9].isDrum=!0}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){let r=(e[5]*128+e[4])/16383;this.setMasterVolume(r,t)}setMasterVolume(e,t){t??=this.audioContext.currentTime,this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(r=>{let n=new AudioBufferSourceNode(this.audioContext,{buffer:this.schedulerBuffer});n.connect(this.scheduler),n.onended=()=>{try{e()}finally{n.disconnect(),r()}},n.start(t)})}};export{Ie as MidyGMLite};
