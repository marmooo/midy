var Pe=Object.create;var ne=Object.defineProperty;var ke=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Fe=Object.getPrototypeOf,Me=Object.prototype.hasOwnProperty;var K=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var Se=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Oe(e))!Me.call(o,s)&&s!==t&&ne(o,s,{get:()=>e[s],enumerable:!(r=ke(e,s))||r.enumerable});return o};var Ee=(o,e,t)=>(t=o!=null?Pe(Fe(o)):{},Se(e||!o||!o.__esModule?ne(t,"default",{value:o,enumerable:!0}):t,o));var oe=K((st,se)=>{function Ve(o){var e=new v(o),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var r=De(t.data),s=[],a=0;!e.eof()&&a<r.numTracks;a++){var n=e.readChunk();if(n.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+n.id+"'";var i=Ue(n.data);s.push(i)}return{header:r,tracks:s}}function De(o){var e=new v(o),t=e.readUInt16(),r=e.readUInt16(),s={format:t,numTracks:r},a=e.readUInt16();return a&32768?(s.framesPerSecond=256-(a>>8),s.ticksPerFrame=a&255):s.ticksPerBeat=a,s}function Ue(o){for(var e=new v(o),t=[];!e.eof();){var r=a();t.push(r)}return t;var s;function a(){var n={};n.deltaTime=e.readVarInt();var i=e.readUInt8();if((i&240)===240)if(i===255){n.meta=!0;var c=e.readUInt8(),l=e.readVarInt();switch(c){case 0:if(n.type="sequenceNumber",l!==2)throw"Expected length for sequenceNumber event is 2, got "+l;return n.number=e.readUInt16(),n;case 1:return n.type="text",n.text=e.readString(l),n;case 2:return n.type="copyrightNotice",n.text=e.readString(l),n;case 3:return n.type="trackName",n.text=e.readString(l),n;case 4:return n.type="instrumentName",n.text=e.readString(l),n;case 5:return n.type="lyrics",n.text=e.readString(l),n;case 6:return n.type="marker",n.text=e.readString(l),n;case 7:return n.type="cuePoint",n.text=e.readString(l),n;case 32:if(n.type="channelPrefix",l!=1)throw"Expected length for channelPrefix event is 1, got "+l;return n.channel=e.readUInt8(),n;case 33:if(n.type="portPrefix",l!=1)throw"Expected length for portPrefix event is 1, got "+l;return n.port=e.readUInt8(),n;case 47:if(n.type="endOfTrack",l!=0)throw"Expected length for endOfTrack event is 0, got "+l;return n;case 81:if(n.type="setTempo",l!=3)throw"Expected length for setTempo event is 3, got "+l;return n.microsecondsPerBeat=e.readUInt24(),n;case 84:if(n.type="smpteOffset",l!=5)throw"Expected length for smpteOffset event is 5, got "+l;var d=e.readUInt8(),u={0:24,32:25,64:29,96:30};return n.frameRate=u[d&96],n.hour=d&31,n.min=e.readUInt8(),n.sec=e.readUInt8(),n.frame=e.readUInt8(),n.subFrame=e.readUInt8(),n;case 88:if(n.type="timeSignature",l!=2&&l!=4)throw"Expected length for timeSignature event is 4 or 2, got "+l;return n.numerator=e.readUInt8(),n.denominator=1<<e.readUInt8(),l===4?(n.metronome=e.readUInt8(),n.thirtyseconds=e.readUInt8()):(n.metronome=36,n.thirtyseconds=8),n;case 89:if(n.type="keySignature",l!=2)throw"Expected length for keySignature event is 2, got "+l;return n.key=e.readInt8(),n.scale=e.readUInt8(),n;case 127:return n.type="sequencerSpecific",n.data=e.readBytes(l),n;default:return n.type="unknownMeta",n.data=e.readBytes(l),n.metatypeByte=c,n}}else if(i==240){n.type="sysEx";var l=e.readVarInt();return n.data=e.readBytes(l),n}else if(i==247){n.type="endSysEx";var l=e.readVarInt();return n.data=e.readBytes(l),n}else throw"Unrecognised MIDI event type byte: "+i;else{var f;if((i&128)===0){if(s===null)throw"Running status byte encountered before status byte";f=i,i=s,n.running=!0}else f=e.readUInt8(),s=i;var p=i>>4;switch(n.channel=i&15,p){case 8:return n.type="noteOff",n.noteNumber=f,n.velocity=e.readUInt8(),n;case 9:var m=e.readUInt8();return n.type=m===0?"noteOff":"noteOn",n.noteNumber=f,n.velocity=m,m===0&&(n.byte9=!0),n;case 10:return n.type="noteAftertouch",n.noteNumber=f,n.amount=e.readUInt8(),n;case 11:return n.type="controller",n.controllerType=f,n.value=e.readUInt8(),n;case 12:return n.type="programChange",n.programNumber=f,n;case 13:return n.type="channelAftertouch",n.amount=f,n;case 14:return n.type="pitchBend",n.value=f+(e.readUInt8()<<7)-8192,n;default:throw"Unrecognised MIDI event type: "+p}}}}function v(o){this.buffer=o,this.bufferLen=this.buffer.length,this.pos=0}v.prototype.eof=function(){return this.pos>=this.bufferLen};v.prototype.readUInt8=function(){var o=this.buffer[this.pos];return this.pos+=1,o};v.prototype.readInt8=function(){var o=this.readUInt8();return o&128?o-256:o};v.prototype.readUInt16=function(){var o=this.readUInt8(),e=this.readUInt8();return(o<<8)+e};v.prototype.readInt16=function(){var o=this.readUInt16();return o&32768?o-65536:o};v.prototype.readUInt24=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(o<<16)+(e<<8)+t};v.prototype.readInt24=function(){var o=this.readUInt24();return o&8388608?o-16777216:o};v.prototype.readUInt32=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),r=this.readUInt8();return(o<<24)+(e<<16)+(t<<8)+r};v.prototype.readBytes=function(o){var e=this.buffer.slice(this.pos,this.pos+o);return this.pos+=o,e};v.prototype.readString=function(o){var e=this.readBytes(o);return String.fromCharCode.apply(null,e)};v.prototype.readVarInt=function(){for(var o=0;!this.eof();){var e=this.readUInt8();if(e&128)o+=e&127,o<<=7;else return o+e}return o};v.prototype.readChunk=function(){var o=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:o,length:e,data:t}};se.exports=Ve});var ie=K((ot,ae)=>{function Re(o,e){if(typeof o!="object")throw"Invalid MIDI data";e=e||{};var t=o.header||{},r=o.tracks||[],s,a=r.length,n=new b;for(Ne(n,t,a),s=0;s<a;s++)Ce(n,r[s],e);return n.buffer}function Ne(o,e,t){var r=e.format==null?1:e.format,s=128;e.timeDivision?s=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?s=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(s=e.ticksPerBeat&32767);var a=new b;a.writeUInt16(r),a.writeUInt16(t),a.writeUInt16(s),o.writeChunk("MThd",a.buffer)}function Ce(o,e,t){var r=new b,s,a=e.length,n=null;for(s=0;s<a;s++)(t.running===!1||!t.running&&!e[s].running)&&(n=null),n=Le(r,e[s],n,t.useByte9ForNoteOff);o.writeChunk("MTrk",r.buffer)}function Le(o,e,t,r){var s=e.type,a=e.deltaTime,n=e.text||"",i=e.data||[],c=null;switch(o.writeVarInt(a),s){case"sequenceNumber":o.writeUInt8(255),o.writeUInt8(0),o.writeVarInt(2),o.writeUInt16(e.number);break;case"text":o.writeUInt8(255),o.writeUInt8(1),o.writeVarInt(n.length),o.writeString(n);break;case"copyrightNotice":o.writeUInt8(255),o.writeUInt8(2),o.writeVarInt(n.length),o.writeString(n);break;case"trackName":o.writeUInt8(255),o.writeUInt8(3),o.writeVarInt(n.length),o.writeString(n);break;case"instrumentName":o.writeUInt8(255),o.writeUInt8(4),o.writeVarInt(n.length),o.writeString(n);break;case"lyrics":o.writeUInt8(255),o.writeUInt8(5),o.writeVarInt(n.length),o.writeString(n);break;case"marker":o.writeUInt8(255),o.writeUInt8(6),o.writeVarInt(n.length),o.writeString(n);break;case"cuePoint":o.writeUInt8(255),o.writeUInt8(7),o.writeVarInt(n.length),o.writeString(n);break;case"channelPrefix":o.writeUInt8(255),o.writeUInt8(32),o.writeVarInt(1),o.writeUInt8(e.channel);break;case"portPrefix":o.writeUInt8(255),o.writeUInt8(33),o.writeVarInt(1),o.writeUInt8(e.port);break;case"endOfTrack":o.writeUInt8(255),o.writeUInt8(47),o.writeVarInt(0);break;case"setTempo":o.writeUInt8(255),o.writeUInt8(81),o.writeVarInt(3),o.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":o.writeUInt8(255),o.writeUInt8(84),o.writeVarInt(5);var l={24:0,25:32,29:64,30:96},d=e.hour&31|l[e.frameRate];o.writeUInt8(d),o.writeUInt8(e.min),o.writeUInt8(e.sec),o.writeUInt8(e.frame),o.writeUInt8(e.subFrame);break;case"timeSignature":o.writeUInt8(255),o.writeUInt8(88),o.writeVarInt(4),o.writeUInt8(e.numerator);var u=Math.floor(Math.log(e.denominator)/Math.LN2)&255;o.writeUInt8(u),o.writeUInt8(e.metronome),o.writeUInt8(e.thirtyseconds||8);break;case"keySignature":o.writeUInt8(255),o.writeUInt8(89),o.writeVarInt(2),o.writeInt8(e.key),o.writeUInt8(e.scale);break;case"sequencerSpecific":o.writeUInt8(255),o.writeUInt8(127),o.writeVarInt(i.length),o.writeBytes(i);break;case"unknownMeta":e.metatypeByte!=null&&(o.writeUInt8(255),o.writeUInt8(e.metatypeByte),o.writeVarInt(i.length),o.writeBytes(i));break;case"sysEx":o.writeUInt8(240),o.writeVarInt(i.length),o.writeBytes(i);break;case"endSysEx":o.writeUInt8(247),o.writeVarInt(i.length),o.writeBytes(i);break;case"noteOff":var f=r!==!1&&e.byte9||r&&e.velocity==0?144:128;c=f|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteOn":c=144|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteAftertouch":c=160|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.noteNumber),o.writeUInt8(e.amount);break;case"controller":c=176|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.controllerType),o.writeUInt8(e.value);break;case"programChange":c=192|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.programNumber);break;case"channelAftertouch":c=208|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.amount);break;case"pitchBend":c=224|e.channel,c!==t&&o.writeUInt8(c);var p=8192+e.value,m=p&127,w=p>>7&127;o.writeUInt8(m),o.writeUInt8(w);break;default:throw"Unrecognized event type: "+s}return c}function b(){this.buffer=[]}b.prototype.writeUInt8=function(o){this.buffer.push(o&255)};b.prototype.writeInt8=b.prototype.writeUInt8;b.prototype.writeUInt16=function(o){var e=o>>8&255,t=o&255;this.writeUInt8(e),this.writeUInt8(t)};b.prototype.writeInt16=b.prototype.writeUInt16;b.prototype.writeUInt24=function(o){var e=o>>16&255,t=o>>8&255,r=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(r)};b.prototype.writeInt24=b.prototype.writeUInt24;b.prototype.writeUInt32=function(o){var e=o>>24&255,t=o>>16&255,r=o>>8&255,s=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(r),this.writeUInt8(s)};b.prototype.writeInt32=b.prototype.writeUInt32;b.prototype.writeBytes=function(o){this.buffer=this.buffer.concat(Array.prototype.slice.call(o,0))};b.prototype.writeString=function(o){var e,t=o.length,r=[];for(e=0;e<t;e++)r.push(o.codePointAt(e));this.writeBytes(r)};b.prototype.writeVarInt=function(o){if(o<0)throw"Cannot write negative variable-length integer";if(o<=127)this.writeUInt8(o);else{var e=o,t=[];for(t.push(e&127),e>>=7;e;){var r=e&127|128;t.push(r),e>>=7}this.writeBytes(t.reverse())}};b.prototype.writeChunk=function(o,e){this.writeString(o),this.writeUInt32(e.length),this.writeBytes(e)};ae.exports=Re});var le=K($=>{$.parseMidi=oe();$.writeMidi=ie()});var Te=Ee(le());var P=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,r=t+e,s=this.data;this.offset=r;let a=r;for(let c=t+1;c<r;c++)if(s[c]===0){a=c;break}let n=a-t,i=new Array(n);for(let c=0;c<n;c++)i[c]=s[t+c];return String.fromCharCode(...i)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function Z(o,e,t){let r=new P(o,e),s=r.readString(4),a=r.readDWORD(t);return new _(s,a,r.offset)}function z(o,e=0,t,{padding:r=!0,bigEndian:s=!1}={}){let a=[],n=t+e,i=e;for(;i<n;){let c=Z(o,i,s);i=c.offset+c.size,r&&(i-e&1)===1&&i++,a.push(c)}return a}var _=class{constructor(e,t,r){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:r})}};var I=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var y=class o{constructor(e,t,r,s,a){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:a})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,r=e&127,s=e>>7&1,a=e>>8&1,n=e>>9&1;return new o(t,n,a,s,r)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var Q=class o{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),r=e.readInt8();return new o(t,r)}},U=class o{constructor(e,t,r,s,a,n,i,c,l,d,u){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:d}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:u})}static parse(e,t){function r(F){for(let T=0;T<t.length;T++)if(t[T].type===F)return t[T]}function s(F){return new P(e,F.offset)}function a(F){let T=r(F);return T?s(T).readString(T.size):null}function n(F){let T=r(F);return T?Q.parse(s(T)):null}let i=a("ICMT"),c=a("ICOP"),l=a("ICRD"),d=a("IENG"),u=a("INAM"),f=a("IPRD"),p=a("ISFT"),m=n("ifil"),w=a("isng"),W=a("irom"),Ie=n("iver");return new o(i,c,l,d,u,f,p,m,w,W,Ie)}},E=class o{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),r=e.readWORD();return new o(t,r)}},R=class o{constructor(e,t,r,s,a,n,i){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:i})}get isEnd(){return this.presetName==="EOP"}static parse(e){let t=e.readString(20),r=e.readWORD(),s=e.readWORD(),a=e.readWORD(),n=e.readDWORD(),i=e.readDWORD(),c=e.readDWORD();return new o(t,r,s,a,n,i,c)}},M=class o{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),r=e.readByte();return new o(t,r)}},g=class o{constructor(e,t,r,s,a){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:a})}transform(e){let t=this.value*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),r=e.readWORD(),s=e.readInt16(),a=e.readWORD(),n=e.readWORD(),i=y.parse(t),c=y.parse(a);return new o(i,r,s,c,n)}},V=class o{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return I[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),r=I[t],s;switch(r){case"keyRange":case"velRange":s=M.parse(e);break;default:s=e.readInt16();break}return new o(t,s)}},N=class o{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new o;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},C=class o{constructor(e,t,r,s,a,n,i,c,l,d){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:d})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let r=e.readString(20),s=e.readDWORD(),a=e.readDWORD(),n=e.readDWORD(),i=e.readDWORD(),c=e.readDWORD(),l=e.readByte(),d=e.readInt8(),u=e.readWORD(),f=e.readWORD();return t||(n-=s,i-=s),new o(r,s,a,n,i,c,l,d,u,f)}};var h=class{constructor(e,t,r){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=r}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};function ce(o,e={}){let t=z(o,0,o.length,e);if(t.length!==1)throw new Error("wrong chunk length");let r=t[0];if(r===null)throw new Error("chunk not found");function s(c,l,d={}){let u=L(c,l,"RIFF","sfbk",d);if(u.length!==3)throw new Error("invalid sfbk structure");let f=Be(u[0],l),p=f.version.major===3;return p&&u[2].type!=="LIST"&&(u[2]=Z(l,u[2].offset-9,!1)),{info:f,samplingData:Ae(u[1],l),...a(u[2],l,p)}}function a(c,l,d){let u=L(c,l,"LIST","pdta");if(u.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:je(u[0],l),presetZone:He(u[1],l),presetModulators:We(u[2],l),presetGenerators:$e(u[3],l),instruments:Ge(u[4],l),instrumentZone:qe(u[5],l),instrumentModulators:Ke(u[6],l),instrumentGenerators:_e(u[7],l),sampleHeaders:Ze(u[8],l,d)}}let n=s(r,o,e),i=n.info.version.major===3;return{...n,samples:ze(n.sampleHeaders,n.samplingData.offsetMSB,n.samplingData.offsetLSB,o,i)}}function L(o,e,t,r,s={}){if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let a=new P(e,o.offset),n=a.readString(4);if(n!==r)throw new Error("invalid signature:"+n);return z(e,a.offset,o.size-4,s)}function Be(o,e){let t=L(o,e,"LIST","INFO");return U.parse(e,t)}function Ae(o,e){let t=L(o,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function k(o,e,t,r,s,a){let n=[];if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let i=new P(e,o.offset),c=o.offset+o.size;for(;i.offset<c;){let l=r.parse(i,a);if(s&&s(l))break;n.push(l)}return n}var je=(o,e)=>k(o,e,"phdr",R,t=>t.isEnd),He=(o,e)=>k(o,e,"pbag",E),Ge=(o,e)=>k(o,e,"inst",N,t=>t.isEnd),qe=(o,e)=>k(o,e,"ibag",E),We=(o,e)=>k(o,e,"pmod",g),Ke=(o,e)=>k(o,e,"imod",g),$e=(o,e)=>k(o,e,"pgen",V,t=>t.isEnd),_e=(o,e)=>k(o,e,"igen",V),Ze=(o,e,t)=>k(o,e,"shdr",C,r=>r.isEnd,t);function ze(o,e,t,r,s){let a=new Array(o.length),n=s?1:2;for(let i=0;i<o.length;i++){let{start:c,end:l}=o[i],d=e+c*n,u=e+l*n;a[i]=r.subarray(d,u)}return a}var he=new Map;for(let o=0;o<I.length;o++)he.set(I[o],o);var Qe=["instrument","sampleID"],fe=["keyRange","velRange"],pe=["keynum","velocity"],me=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],ue=[...me,...pe],ye=new Set;for(let o=0;o<ue.length;o++){let e=ue[o],t=he.get(e);t!==void 0&&ye.add(t)}function be(o){let e={},t=Object.keys(o);for(let r of t){let s=o[r];if(D(r))e[r]=s;else{let a=s;e[r]=a.clamp(a.defaultValue)}}return e}var de=[["keynum","keyRange"],["velocity","velRange"]],Je=new Set(fe);function D(o){return Je.has(o)}var Xe=new Set([...Qe,...fe,...pe,...me]);function Ye(){let o=[],e=I.length;for(let t=0;t<e;t++){let r=I[t];r!==void 0&&!Xe.has(r)&&o.push(r)}return o}var B=Ye(),et=new Set(B);function J(o){return et.has(o)}function ge(o){let e={};for(let t=0;t<o.length;t++){let r=o[t],s=r.type;if(s!==void 0&&!ye.has(r.code))if(D(s))e[s]=r.value;else{let a=s;e[a]=r.value}}return e}function ve(o){let e={};for(let t=0;t<o.length;t++){let r=o[t],s=r.type;if(s!==void 0)if(D(s))e[s]=r.value;else{let a=s;e[a]=r.value}}for(let t=0;t<de.length;t++){let[r,s]=de[t],a=e[r];a!==void 0&&(e[s]=new M(a,a))}return e}var S=-32768,O=32767,A={startAddrsOffset:new h(0,0,O),endAddrsOffset:new h(S,0,0),startloopAddrsOffset:new h(S,0,O),endloopAddrsOffset:new h(S,0,O),startAddrsCoarseOffset:new h(0,0,O),modLfoToPitch:new h(-12e3,0,12e3),vibLfoToPitch:new h(-12e3,0,12e3),modEnvToPitch:new h(-12e3,0,12e3),initialFilterFc:new h(1500,13500,13500),initialFilterQ:new h(0,0,960),modLfoToFilterFc:new h(-12e3,0,12e3),modEnvToFilterFc:new h(-12e3,0,12e3),endAddrsCoarseOffset:new h(S,0,0),modLfoToVolume:new h(-960,0,960),chorusEffectsSend:new h(0,0,1e3),reverbEffectsSend:new h(0,0,1e3),pan:new h(-500,0,500),delayModLFO:new h(-12e3,-12e3,5e3),freqModLFO:new h(-16e3,0,4500),delayVibLFO:new h(-12e3,-12e3,5e3),freqVibLFO:new h(-16e3,0,4500),delayModEnv:new h(-12e3,-12e3,5e3),attackModEnv:new h(-12e3,-12e3,8e3),holdModEnv:new h(-12e3,-12e3,5e3),decayModEnv:new h(-12e3,-12e3,8e3),sustainModEnv:new h(0,0,1e3),releaseModEnv:new h(-12e3,-12e3,8e3),keynumToModEnvHold:new h(-1200,0,1200),keynumToModEnvDecay:new h(-1200,0,1200),delayVolEnv:new h(-12e3,-12e3,5e3),attackVolEnv:new h(-12e3,-12e3,8e3),holdVolEnv:new h(-12e3,-12e3,5e3),decayVolEnv:new h(-12e3,-12e3,8e3),sustainVolEnv:new h(0,0,1440),releaseVolEnv:new h(-12e3,-12e3,8e3),keynumToVolEnvHold:new h(-1200,0,1200),keynumToVolEnvDecay:new h(-1200,0,1200),instrument:new h(-1,-1,O),keyRange:new M(0,127),velRange:new M(0,127),startloopAddrsCoarseOffset:new h(S,0,O),keynum:new h(-1,-1,127),velocity:new h(-1,-1,127),initialAttenuation:new h(0,0,1440),endloopAddrsCoarseOffset:new h(S,0,O),coarseTune:new h(-120,0,120),fineTune:new h(-99,0,99),sampleID:new h(-1,-1,O),sampleModes:new h(0,0,3),scaleTuning:new h(0,100,100),exclusiveClass:new h(0,0,127),overridingRootKey:new h(-1,-1,127)};function x(o){return Math.pow(2,o/1200)}var j=class{constructor(e,t,r,s,a){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(n,i)=>{n.modLfoToPitch=this.clamp("modLfoToPitch",i)},vibLfoToPitch:(n,i)=>{n.vibLfoToPitch=this.clamp("vibLfoToPitch",i)},modEnvToPitch:(n,i)=>{n.modEnvToPitch=this.clamp("modEnvToPitch",i)},initialFilterFc:(n,i)=>{n.initialFilterFc=this.clamp("initialFilterFc",i)},initialFilterQ:(n,i)=>{n.initialFilterQ=this.clamp("initialFilterQ",i)},modLfoToFilterFc:(n,i)=>{n.modLfoToFilterFc=this.clamp("modLfoToFilterFc",i)},modEnvToFilterFc:(n,i)=>{n.modEnvToFilterFc=this.clamp("modEnvToFilterFc",i)},modLfoToVolume:(n,i)=>{n.modLfoToVolume=this.clamp("modLfoToVolume",i)},chorusEffectsSend:(n,i)=>{n.chorusEffectsSend=this.clamp("chorusEffectsSend",i)/1e3},reverbEffectsSend:(n,i)=>{n.reverbEffectsSend=this.clamp("reverbEffectsSend",i)/1e3},pan:(n,i)=>{n.pan=this.clamp("pan",i)/1e3},delayModLFO:(n,i)=>{n.delayModLFO=x(this.clamp("delayModLFO",i))},freqModLFO:(n,i)=>{n.freqModLFO=this.clamp("freqModLFO",i)},delayVibLFO:(n,i)=>{n.delayVibLFO=x(this.clamp("delayVibLFO",i))},freqVibLFO:(n,i)=>{n.freqVibLFO=this.clamp("freqVibLFO",i)},delayModEnv:(n,i)=>{n.modDelay=x(this.clamp("delayModEnv",i))},attackModEnv:(n,i)=>{n.modAttack=x(this.clamp("attackModEnv",i))},holdModEnv:(n,i)=>{let c=this.clamp("holdModEnv",i),l=this.clamp("keynumToModEnvHold",i);n.modHold=this.getModHold(c,l)},decayModEnv:(n,i)=>{let c=this.clamp("decayModEnv",i),l=this.clamp("keynumToModEnvDecay",i);n.modDecay=this.getModDecay(c,l)},sustainModEnv:(n,i)=>{n.modSustain=this.clamp("sustainModEnv",i)/1e3},releaseModEnv:(n,i)=>{n.modRelease=x(this.clamp("releaseModEnv",i))},keynumToModEnvHold:(n,i)=>{let c=this.clamp("holdModEnv",i),l=this.clamp("keynumToModEnvHold",i);n.modHold=this.getModHold(c,l)},keynumToModEnvDecay:(n,i)=>{let c=this.clamp("decayModEnv",i),l=this.clamp("keynumToModEnvDecay",i);n.modDecay=this.getModDecay(c,l)},delayVolEnv:(n,i)=>{n.volDelay=x(this.clamp("delayVolEnv",i))},attackVolEnv:(n,i)=>{n.volAttack=x(this.clamp("attackVolEnv",i))},holdVolEnv:(n,i)=>{let c=this.clamp("holdVolEnv",i),l=this.clamp("keynumToVolEnvHold",i);n.volHold=this.getVolHold(c,l)},decayVolEnv:(n,i)=>{let c=this.clamp("decayVolEnv",i),l=this.clamp("keynumToVolEnvDecay",i);n.volDecay=this.getVolDecay(c,l)},sustainVolEnv:(n,i)=>{n.volSustain=this.clamp("sustainVolEnv",i)/1e3},releaseVolEnv:(n,i)=>{n.volRelease=x(this.clamp("releaseVolEnv",i))},keynumToVolEnvHold:(n,i)=>{let c=this.clamp("holdVolEnv",i),l=this.clamp("keynumToVolEnvHold",i);n.modHold=this.getVolHold(c,l)},keynumToVolEnvDecay:(n,i)=>{let c=this.clamp("decayVolEnv",i),l=this.clamp("keynumToVolEnvDecay",i);n.modDecay=this.getVolDecay(c,l)},initialAttenuation:(n,i)=>{n.initialAttenuation=this.clamp("initialAttenuation",i)},coarseTune:(n,i)=>{n.playbackRate=this.getPlaybackRate(i)},fineTune:(n,i)=>{n.playbackRate=this.getPlaybackRate(i)},scaleTuning:(n,i)=>{n.playbackRate=this.getPlaybackRate(i)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],r=t.sourceOper.controllerType,s=t.destinationOper,a=this.controllerToDestinations.get(r);a?a.add(t.destinationOper):this.controllerToDestinations.set(r,new Set([s]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],r=t.destinationOper,s=this.destinationToModulators.get(r);s?s.push(t):this.destinationToModulators.set(r,[t])}}getModHold(e,t){return x(e+(this.key-60)*t)}getModDecay(e,t){return x(e+(this.key-60)*t)}getVolHold(e,t){return x(e+(this.key-60)*t)}getVolDecay(e,t){return x(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("coarseTune",e),r=this.clamp("fineTune",e)/100,s=this.clamp("overridingRootKey",e),a=this.clamp("scaleTuning",e)/100,n=t+r,i=s===-1?this.sampleHeader.originalPitch:s,c=n+this.sampleHeader.pitchCorrection/100-i;return Math.pow(Math.pow(2,1/12),(this.key+c)*a)}transformParams(e,t){let r={},s=this.controllerToDestinations.get(e);if(!s)return r;for(let a of s){let n=I[a];if(!n||!J(n))continue;let i=this.destinationToModulators.get(a);if(i){r[n]=this.generators[n];for(let c of i){let l=c.sourceOper,d=l.map(t[l.controllerType]),u=1,f=c.amountSourceOper;if(!(f.cc===0&&f.index===0)){let m=t[f.controllerType];u=f.map(m)}let p=c.transform(d*u);Number.isNaN(p)||(r[n]+=p)}}}return r}transformAllParams(e){let t=structuredClone(this.generators);for(let r of this.modulators){let s=r.sourceOper.controllerType,a=e[s];if(!a)continue;let n=I[r.destinationOper];if(!n||!J(n))continue;let c=r.sourceOper.map(a),l=1,d=r.amountSourceOper;if(!(d.cc===0&&d.index===0)){let f=e[d.controllerType];l=d.map(f)}let u=r.transform(c*l);Number.isNaN(u)||(t[n]+=u)}return t}clamp(e,t){return A[e].clamp(t[e])}getParams(e,t){let r={},s=structuredClone(this.generators),a=this.transformParams(e,t),n=Object.keys(a);for(let i of n)s[i]=a[i];for(let i of n)this.voiceHandlers[i](r,s);return r}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},r=this.transformAllParams(e);for(let s=0;s<B.length;s++){let a=B[s];this.voiceHandlers[a](t,r)}return t}};var we=[new g(y.parse(1282),48,960,y.parse(0),0),new g(y.parse(258),8,-2400,y.parse(0),0),new g(y.parse(13),6,50,y.parse(0),0),new g(y.parse(129),6,50,y.parse(0),0),new g(y.parse(1415),48,960,y.parse(0),0),new g(y.parse(650),48,1,y.parse(0),0),new g(y.parse(1419),48,960,y.parse(0),0),new g(y.parse(219),16,.2,y.parse(0),0),new g(y.parse(221),15,.2,y.parse(0),0),new g(y.parse(526),51,127,y.parse(16),0)];var H=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},G=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},q=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,r,s){let a=new Array(s-r);for(let n=r;n<s;n++){let i=t[n].generatorIndex,c=t[n+1].generatorIndex;a[n-r]=e.slice(i,c)}return a}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],r=this.parsed.presetHeaders[e+1],s=r?r.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,s)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],r=this.parsed.instruments[e+1],s=r?r.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,s)}getModulators(e,t,r,s){let a=new Array(s-r);for(let n=r;n<s;n++){let i=t[n].modulatorIndex,c=t[n+1].modulatorIndex;a[n-r]=e.slice(i,c)}return a}getPresetModulators(e){let t=this.parsed.presetHeaders[e],r=this.parsed.presetHeaders[e+1],s=r?r.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,s)}getInstrumentModulators(e){let t=this.parsed.instruments[e],r=this.parsed.instruments[e+1],s=r?r.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,s)}findInstrumentZone(e,t,r){let s=this.getInstrumentGenerators(e),a=this.getInstrumentModulators(e),n,i=[];for(let c=0;c<s.length;c++){let l=ve(s[c]);if(l.sampleID===void 0){n=l,i=a[c];continue}if(!(l.keyRange&&!l.keyRange.in(t))&&!(l.velRange&&!l.velRange.in(r)))if(n){let d={...n,...l},u=[...i,...a[c]];return new H(d,u)}else return new H(l,a[c])}}findInstrument(e,t,r){let s=this.getPresetGenerators(e),a=this.getPresetModulators(e),n,i=[];for(let c=0;c<s.length;c++){let l=ge(s[c]);if(l.instrument===void 0){n=l,i=a[c];continue}if(l.keyRange&&!l.keyRange.in(t)||l.velRange&&!l.velRange.in(r))continue;let d=this.findInstrumentZone(l.instrument,t,r);if(d)if(n){let u={...n,...l},f=[...i,...a[c]],p=new G(u,f);return this.createVoice(t,p,d)}else{let u=new G(l,a[c]);return this.createVoice(t,u,d)}}return null}createVoice(e,t,r){let s=be(A);Object.assign(s,r.generators);let a=Object.keys(t.generators);for(let d=0;d<a.length;d++){let u=a[d];D(u)||(s[u]+=t.generators[u])}let n=[...we,...t.modulators,...r.modulators],i=s.sampleID,c=this.parsed.samples[i],l=this.parsed.sampleHeaders[i];return new j(e,s,n,c,l)}getVoice(e,t,r,s){let a=this.parsed.presetHeaders.findIndex(i=>i.preset===t&&i.bank===e);if(a<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let n=this.findInstrument(a,r,s);return n||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let r=0;r<t.length;r++){let s=t[r];e[s.bank]||(e[s.bank]={}),e[s.bank][s.preset]=s.presetName}return e}};var X=class{bufferSource;filterNode;volumeEnvelopeNode;volumeDepth;modulationLFO;modulationDepth;constructor(e,t,r,s,a){this.noteNumber=e,this.velocity=t,this.startTime=r,this.voice=s,this.voiceParams=a}},Y={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepth:{type:129,defaultValue:0},volume:{type:135,defaultValue:100/127},pan:{type:138,defaultValue:.5},expression:{type:139,defaultValue:1},sustainPedal:{type:192,defaultValue:0}},ee=class{array=new Float32Array(256);constructor(){let e=Object.entries(Y);for(let[t,{type:r,defaultValue:s}]of e)this.array[r]=s,Object.defineProperty(this,t,{get:()=>this.array[r],set:a=>this.array[r]=a,enumerable:!0,configurable:!0})}},te=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain","modRelease","playbackRate"],tt=new Set(te),re=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],rt=new Set(re),xe=class{ticksPerBeat=120;totalTime=0;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=this.initSoundFontTable();isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;timeline=[];instruments=[];notePromises=[];exclusiveClassMap=new Map;static channelSettings={currentBufferSource:null,detune:0,program:0,bank:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127};constructor(e){this.audioContext=e,this.masterVolume=new GainNode(e),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.masterVolume.connect(e.destination),this.GM1SystemOn()}initSoundFontTable(){let e=new Array(128);for(let t=0;t<128;t++)e[t]=new Map;return e}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let r=e.parsed.presetHeaders;for(let s=0;s<r.length;s++){let a=r[s];a.presetName.startsWith("\0")||this.soundFontTable[a.preset].set(a.bank,t)}}async loadSoundFont(e){let r=await(await fetch(e)).arrayBuffer(),s=ce(new Uint8Array(r)),a=new q(s);this.addSoundFont(a)}async loadMIDI(e){let r=await(await fetch(e)).arrayBuffer(),s=(0,Te.parseMidi)(new Uint8Array(r));this.ticksPerBeat=s.header.ticksPerBeat;let a=this.extractMidiData(s);this.instruments=a.instruments,this.timeline=a.timeline,this.totalTime=this.calcTotalTime()}setChannelAudioNodes(e){let{gainLeft:t,gainRight:r}=this.panToGain(Y.pan.defaultValue),s=new GainNode(e,{gain:t}),a=new GainNode(e,{gain:r}),n=new ChannelMergerNode(e,{numberOfInputs:2});return s.connect(n,0,0),a.connect(n,0,1),n.connect(this.masterVolume),{gainL:s,gainR:a,merger:n}}createChannels(e){return Array.from({length:16},()=>({...this.constructor.channelSettings,state:new ee,...this.setChannelAudioNodes(e),scheduledNotes:new Map}))}async createNoteBuffer(e,t){let r=e.start,s=e.sample.length+e.end;if(t){let a=e.sample,n=a.byteOffset+r,i=a.byteOffset+s,c=a.buffer.slice(n,i);return await this.audioContext.decodeAudioData(c)}else{let a=e.sample,n=a.byteOffset+r,i=a.byteOffset+s,c=a.buffer.slice(n,i),l=new AudioBuffer({numberOfChannels:1,length:a.length,sampleRate:e.sampleRate}),d=l.getChannelData(0),u=new Int16Array(c);for(let f=0;f<u.length;f++)d[f]=u[f]/32768;return l}}async createNoteBufferNode(e,t){let r=new AudioBufferSourceNode(this.audioContext),s=await this.createNoteBuffer(e,t);return r.buffer=s,r.loop=e.sampleModes%2!==0,r.loop&&(r.loopStart=e.loopStart/e.sampleRate,r.loopEnd=e.loopEnd/e.sampleRate),r}async scheduleTimelineEvents(e,t,r){for(;r<this.timeline.length;){let s=this.timeline[r];if(s.startTime>e+this.lookAhead)break;switch(s.type){case"noteOn":if(s.velocity!==0){await this.scheduleNoteOn(s.channel,s.noteNumber,s.velocity,s.startTime+this.startDelay-t);break}case"noteOff":{let a=this.scheduleNoteRelease(s.channel,s.noteNumber,s.velocity,s.startTime+this.startDelay-t);a&&this.notePromises.push(a);break}case"controller":this.handleControlChange(s.channel,s.controllerType,s.value);break;case"programChange":this.handleProgramChange(s.channel,s.programNumber);break;case"pitchBend":this.setPitchBend(s.channel,s.value+8192);break;case"sysEx":this.handleSysEx(s.data)}r++}return r}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}playNotes(){return new Promise(e=>{this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let t=this.getQueueIndex(this.resumeTime),r=this.resumeTime-this.startTime;this.notePromises=[];let s=async()=>{if(t>=this.timeline.length){await Promise.all(this.notePromises),this.notePromises=[],this.exclusiveClassMap.clear(),e();return}let a=this.audioContext.currentTime+r;if(t=await this.scheduleTimelineEvents(a,r,t),this.isPausing){await this.stopNotes(0,!0),this.notePromises=[],e(),this.isPausing=!1,this.isPaused=!0;return}else if(this.isStopping){await this.stopNotes(0,!0),this.exclusiveClassMap.clear(),this.notePromises=[],e(),this.isStopping=!1,this.isPaused=!1;return}else if(this.isSeeking)this.stopNotes(0,!0),this.exclusiveClassMap.clear(),this.startTime=this.audioContext.currentTime,t=this.getQueueIndex(this.resumeTime),r=this.resumeTime-this.startTime,this.isSeeking=!1,await s();else{let i=this.audioContext.currentTime+this.noteCheckInterval;await this.scheduleTask(()=>{},i),await s()}};s()})}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}extractMidiData(e){let t=new Set,r=[],s=new Array(16);for(let l=0;l<s.length;l++)s[l]={programNumber:-1,bank:this.channels[l].bank};for(let l=0;l<e.tracks.length;l++){let d=e.tracks[l],u=0;for(let f=0;f<d.length;f++){let p=d[f];switch(u+=p.deltaTime,p.ticks=u,p.type){case"noteOn":{let m=s[p.channel];m.programNumber<0&&(t.add(`${m.bank}:0`),m.programNumber=0);break}case"programChange":{let m=s[p.channel];m.programNumber=p.programNumber,t.add(`${m.bankNumber}:${m.programNumber}`)}}delete p.deltaTime,r.push(p)}}let a={controller:0,sysEx:1};r.sort((l,d)=>l.ticks!==d.ticks?l.ticks-d.ticks:(a[l.type]||2)-(a[d.type]||2));let n=0,i=0,c=.5;for(let l=0;l<r.length;l++){let d=r[l],u=this.ticksToSecond(d.ticks-i,c);d.startTime=n+u,d.type==="setTempo"&&(n+=this.ticksToSecond(d.ticks-i,c),c=d.microsecondsPerBeat/1e6,i=d.ticks)}return{instruments:t,timeline:r}}async stopChannelNotes(e,t,r){let s=this.audioContext.currentTime,a=this.channels[e];a.scheduledNotes.forEach(n=>{for(let i=0;i<n.length;i++){let c=n[i];if(!c)continue;let l=this.scheduleNoteRelease(e,c.noteNumber,t,s,r);this.notePromises.push(l)}}),a.scheduledNotes.clear(),await Promise.all(this.notePromises)}stopNotes(e,t){for(let r=0;r<this.channels.length;r++)this.stopChannelNotes(r,e,t);return Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,await this.playNotes(),this.isPlaying=!1)}stop(){this.isPlaying&&(this.isStopping=!0)}pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}async resume(){this.isPaused&&(await this.playNotes(),this.isPlaying=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let r=this.timeline[t];e<r.startTime&&(e=r.startTime)}return e}currentTime(){let e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}getActiveNotes(e,t){let r=new Map;return e.scheduledNotes.forEach(s=>{let a=this.getActiveNote(s,t);a&&r.set(a.noteNumber,a)}),r}getActiveNote(e,t){for(let r=e.length-1;r>=0;r--){let s=e[r];if(!s)return;if(!(t<s.startTime))return s.ending?null:s}return e[0]}cbToRatio(e){return Math.pow(10,e/200)}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=e.state.pitchWheel*2-1,r=e.state.pitchWheelSensitivity*12800;return t*r}updateDetune(e){let t=this.audioContext.currentTime;e.scheduledNotes.forEach(r=>{for(let s=0;s<r.length;s++){let a=r[s];a&&a.bufferSource.detune.cancelScheduledValues(t).setValueAtTime(e.detune,t)}})}setVolumeEnvelope(e){let t=this.audioContext.currentTime,{voiceParams:r,startTime:s}=e,a=this.cbToRatio(-r.initialAttenuation),n=a*(1-r.volSustain),i=s+r.volDelay,c=i+r.volAttack,l=c+r.volHold,d=l+r.volDecay;e.volumeEnvelopeNode.gain.cancelScheduledValues(t).setValueAtTime(0,s).setValueAtTime(1e-6,i).exponentialRampToValueAtTime(a,c).setValueAtTime(a,l).linearRampToValueAtTime(n,d)}setPitchEnvelope(e){let t=this.audioContext.currentTime,{voiceParams:r}=e,s=r.playbackRate;e.bufferSource.playbackRate.cancelScheduledValues(t).setValueAtTime(s,t);let a=r.modEnvToPitch;if(a===0)return;let i=this.rateToCent(s)+a,c=this.centToRate(i),l=startTime+r.modDelay,d=l+r.modAttack,u=d+r.modHold,f=u+r.modDecay;e.bufferSource.playbackRate.setValueAtTime(s,l).exponentialRampToValueAtTime(c,d).setValueAtTime(c,u).linearRampToValueAtTime(s,f)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setFilterEnvelope(e){let t=this.audioContext.currentTime,{voiceParams:r,startTime:s}=e,a=this.centToHz(r.initialFilterFc),n=this.centToHz(r.initialFilterFc+r.modEnvToFilterFc),i=a+(n-a)*(1-r.modSustain),c=this.clampCutoffFrequency(a),l=this.clampCutoffFrequency(n),d=this.clampCutoffFrequency(i),u=s+r.modDelay,f=u+r.modAttack,p=f+r.modHold,m=p+r.modDecay;e.filterNode.frequency.cancelScheduledValues(t).setValueAtTime(c,s).setValueAtTime(c,u).exponentialRampToValueAtTime(l,f).setValueAtTime(l,p).linearRampToValueAtTime(d,m)}startModulation(e,t,r){let{voiceParams:s}=t;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(s.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:s.modLfoToFilterFc}),t.modulationDepth=new GainNode(this.audioContext),this.setModLfoToPitch(e,t),t.volumeDepth=new GainNode(this.audioContext),this.setModLfoToVolume(t),t.modulationLFO.start(r+s.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}async createNote(e,t,r,s,a,n){let i=e.state,c=t.getAllParams(i.array),l=new X(r,s,a,t,c);return l.bufferSource=await this.createNoteBufferNode(c,n),l.volumeEnvelopeNode=new GainNode(this.audioContext),l.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:c.initialFilterQ/10}),this.setVolumeEnvelope(l),this.setFilterEnvelope(l),this.setPitchEnvelope(l),0<i.modulationDepth&&this.startModulation(e,l,a),l.bufferSource.connect(l.filterNode),l.filterNode.connect(l.volumeEnvelopeNode),l.bufferSource.start(a),l}async scheduleNoteOn(e,t,r,s){let a=this.channels[e],n=a.bank,i=this.soundFontTable[a.program].get(n);if(i===void 0)return;let c=this.soundFonts[i],l=c.parsed.info.version.major===3,d=c.getVoice(n,a.program,t,r);if(!d)return;let u=await this.createNote(a,d,t,r,s,l);u.volumeEnvelopeNode.connect(a.gainL),u.volumeEnvelopeNode.connect(a.gainR);let f=u.voiceParams.exclusiveClass;if(f!==0){if(this.exclusiveClassMap.has(f)){let m=this.exclusiveClassMap.get(f),[w,W]=m;w.ending||this.scheduleNoteRelease(W,w.noteNumber,0,s,void 0,!0)}this.exclusiveClassMap.set(f,[u,e])}let p=a.scheduledNotes;p.has(t)?p.get(t).push(u):p.set(t,[u])}noteOn(e,t,r){let s=this.audioContext.currentTime;return this.scheduleNoteOn(e,t,r,s)}stopNote(e,t,r,s){let a=r[s];return a.volumeEnvelopeNode.gain.cancelScheduledValues(e).linearRampToValueAtTime(0,t),a.ending=!0,this.scheduleTask(()=>{a.bufferSource.loop=!1},t),new Promise(n=>{a.bufferSource.onended=()=>{r[s]=null,a.bufferSource.disconnect(),a.filterNode.disconnect(),a.volumeEnvelopeNode.disconnect(),a.modulationDepth&&(a.volumeDepth.disconnect(),a.modulationDepth.disconnect(),a.modulationLFO.stop()),n()},a.bufferSource.stop(t)})}scheduleNoteRelease(e,t,r,s,a){let n=this.channels[e];if(!a&&.5<n.state.sustainPedal||!n.scheduledNotes.has(t))return;let i=n.scheduledNotes.get(t);for(let c=0;c<i.length;c++){let l=i[c];if(!l||l.ending)continue;let d=s+l.voiceParams.volRelease,u=s+l.voiceParams.modRelease;l.filterNode.frequency.cancelScheduledValues(s).linearRampToValueAtTime(0,u);let f=Math.min(d,u);return this.stopNote(s,f,i,c)}}releaseNote(e,t,r){let s=this.audioContext.currentTime;return this.scheduleNoteRelease(e,t,r,s)}releaseSustainPedal(e,t){let r=t*2,s=this.channels[e],a=[];return s.state.sustainPedal=t,s.scheduledNotes.forEach(n=>{for(let i=0;i<n.length;i++){let c=n[i];if(!c)continue;let{noteNumber:l}=c,d=this.releaseNote(e,l,r);a.push(d)}}),a}handleMIDIMessage(e,t,r){let s=e&15,a=e&240;switch(a){case 128:return this.releaseNote(s,t,r);case 144:return this.noteOn(s,t,r);case 176:return this.handleControlChange(s,t,r);case 192:return this.handleProgramChange(s,t);case 224:return this.handlePitchBendMessage(s,t,r);default:console.warn(`Unsupported MIDI message: ${a.toString(16)}`)}}handleProgramChange(e,t){let r=this.channels[e];r.program=t}handlePitchBendMessage(e,t,r){let s=r*128+t;this.setPitchBend(e,s)}setPitchBend(e,t){let r=this.channels[e],s=r.state,a=s.pitchWheel*2-1,n=(t-8192)/8192;s.pitchWheel=t/16383,r.detune+=(n-a)*s.pitchWheelSensitivity*12800,this.updateDetune(r),this.applyVoiceParams(r,14)}setModLfoToPitch(e,t){let r=this.audioContext.currentTime,s=t.voiceParams.modLfoToPitch,n=(Math.abs(s)+e.state.modulationDepth)*Math.sign(s);t.modulationDepth.gain.cancelScheduledValues(r).setValueAtTime(n,r)}setModLfoToFilterFc(e){let t=this.audioContext.currentTime,r=e.voiceParams.modLfoToFilterFc;e.filterDepth.gain.cancelScheduledValues(t).setValueAtTime(r,t)}setModLfoToVolume(e){let t=this.audioContext.currentTime,r=e.voiceParams.modLfoToVolume,a=(this.cbToRatio(Math.abs(r))-1)*Math.sign(r);e.volumeDepth.gain.cancelScheduledValues(t).setValueAtTime(a,t)}setDelayModLFO(e){let t=this.audioContext.currentTime,r=e.startTime;r<t||(e.modulationLFO.stop(t),e.modulationLFO.start(r+e.voiceParams.delayModLFO),e.modulationLFO.connect(e.filterDepth))}setFreqModLFO(e){let t=this.audioContext.currentTime,r=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(r,t)}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,r)=>{0<e.state.modulationDepth&&this.setModLfoToPitch(e,t)},vibLfoToPitch:(e,t,r)=>{},modLfoToFilterFc:(e,t,r)=>{0<e.state.modulationDepth&&this.setModLfoToFilterFc(t)},modLfoToVolume:(e,t,r)=>{0<e.state.modulationDepth&&this.setModLfoToVolume(t)},chorusEffectsSend:(e,t,r)=>{},reverbEffectsSend:(e,t,r)=>{},delayModLFO:(e,t,r)=>this.setDelayModLFO(t),freqModLFO:(e,t,r)=>this.setFreqModLFO(t),delayVibLFO:(e,t,r)=>{},freqVibLFO:(e,t,r)=>{}}}getControllerState(e,t,r){let s=new Float32Array(e.state.array.length);return s.set(e.state.array),s[2]=r/127,s[3]=t/127,s}applyVoiceParams(e,t){e.scheduledNotes.forEach(r=>{for(let s=0;s<r.length;s++){let a=r[s];if(!a)continue;let n=this.getControllerState(e,a.noteNumber,a.velocity),i=a.voice.getParams(t,n),c=!1,l=!1;for(let[d,u]of Object.entries(i)){let f=a.voiceParams[d];if(u!==f){if(a.voiceParams[d]=u,d in this.voiceParamsHandlers)this.voiceParamsHandlers[d](e,a,f);else if(tt.has(d)){if(c)continue;c=!0;let p=a.voiceParams;for(let m=0;m<te.length;m++){let w=te[m];w in i&&(p[w]=i[w])}this.setFilterEnvelope(e,a),this.setPitchEnvelope(a)}else if(rt.has(d)){if(l)continue;l=!0;let p=a.voiceParams;for(let m=0;m<re.length;m++){let w=re[m];w in i&&(p[w]=i[w])}this.setVolumeEnvelope(e,a)}}}}})}createControlChangeHandlers(){return{1:this.setModulationDepth,6:this.dataEntryMSB,7:this.setVolume,10:this.setPan,11:this.setExpression,38:this.dataEntryLSB,64:this.setSustainPedal,100:this.setRPNLSB,101:this.setRPNMSB,120:this.allSoundOff,121:this.resetAllControllers,123:this.allNotesOff}}handleControlChange(e,t,r){let s=this.controlChangeHandlers[t];if(s){s.call(this,e,r);let a=this.channels[e];this.applyVoiceParams(a,controller+128)}else console.warn(`Unsupported Control change: controllerType=${t} value=${r}`)}updateModulation(e){let t=this.audioContext.currentTime,r=e.state.modulationDepth*e.modulationDepthRange;e.scheduledNotes.forEach(s=>{for(let a=0;a<s.length;a++){let n=s[a];n&&(n.modulationDepth?n.modulationDepth.gain.setValueAtTime(r,t):(this.setPitchEnvelope(n),this.startModulation(e,n,t)))}})}setModulationDepth(e,t){let r=this.channels[e];r.state.modulationDepth=t/127,this.updateModulation(r)}setVolume(e,t){let r=this.channels[e];r.state.volume=t/127,this.updateChannelVolume(r)}panToGain(e){let t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t){let r=this.channels[e];r.state.pan=t/127,this.updateChannelVolume(r)}setExpression(e,t){let r=this.channels[e];r.state.expression=t/127,this.updateChannelVolume(r)}dataEntryLSB(e,t){this.channels[e].dataLSB=t,this.handleRPN(e)}updateChannelVolume(e){let t=this.audioContext.currentTime,r=e.state,s=r.volume*r.expression,{gainLeft:a,gainRight:n}=this.panToGain(r.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(s*a,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(s*n,t)}setSustainPedal(e,t){this.channels[e].state.sustainPedal=t/127,t<64&&this.releaseSustainPedal(e,t)}limitData(e,t,r,s,a){a<e.dataLSB?(e.dataMSB++,e.dataLSB=s):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=a),r<e.dataMSB?(e.dataMSB=r,e.dataLSB=a):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=s)}handleRPN(e){let t=this.channels[e];switch(t.rpnMSB*128+t.rpnLSB){case 0:this.handlePitchBendRangeRPN(e);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${t.rpnMSB} LSB=${t.rpnLSB}`)}}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t){this.channels[e].dataMSB=t,this.handleRPN(e)}handlePitchBendRangeRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,99);let r=t.dataMSB+t.dataLSB/100;this.setPitchBendRange(e,r)}setPitchBendRange(e,t){let r=this.channels[e],s=r.state;s.pitchWheelSensitivity=t/128;let a=(s.pitchWheel*2-1)*t*100;this.updateDetune(r,a),this.applyVoiceParams(r,16)}allSoundOff(e){return this.stopChannelNotes(e,0,!0)}resetAllControllers(e){let t=["expression","modulationDepth","sustainPedal","pitchWheelSensitivity"],r=this.channels[e],s=r.state;for(let n=0;n<t.length;n++){let i=t[n];s[i]=Y[i]}let a=["rpnMSB","rpnLSB"];for(let n=0;n<a.length;n++){let i=a[n];r[i]=this.constructor.channelSettings[i]}}allNotesOff(e){return this.stopChannelNotes(e,0,!1)}handleUniversalNonRealTimeExclusiveMessage(e){switch(e[2]){case 9:switch(e[3]){case 1:this.GM1SystemOn();break;case 2:break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(){for(let e=0;e<this.channels.length;e++){let t=this.channels[e];t.bank=0}this.channels[9].bank=128}handleUniversalRealTimeExclusiveMessage(e){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e){let t=(e[5]*128+e[4])/16383;this.setMasterVolume(t)}setMasterVolume(e){if(e<0&&1<e)console.error("Master Volume is out of range");else{let t=this.audioContext.currentTime;this.masterVolume.gain.cancelScheduledValues(t),this.masterVolume.gain.setValueAtTime(e*e,t)}}handleExclusiveMessage(e){console.warn(`Unsupported Exclusive Message: ${e}`)}handleSysEx(e){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e);case 127:return this.handleUniversalRealTimeExclusiveMessage(e);default:return this.handleExclusiveMessage(e)}}scheduleTask(e,t){return new Promise(r=>{let s=new AudioBufferSourceNode(this.audioContext);s.onended=()=>{e(),r()},s.start(t),s.stop(t)})}};export{xe as MidyGMLite};
