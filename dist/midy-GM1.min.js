var Me=Object.create;var ie=Object.defineProperty;var Fe=Object.getOwnPropertyDescriptor;var Ee=Object.getOwnPropertyNames;var Ve=Object.getPrototypeOf,De=Object.prototype.hasOwnProperty;var Q=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var Ce=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ee(e))!De.call(o,r)&&r!==t&&ie(o,r,{get:()=>e[r],enumerable:!(n=Fe(e,r))||n.enumerable});return o};var Be=(o,e,t)=>(t=o!=null?Me(Ve(o)):{},Ce(e||!o||!o.__esModule?ie(t,"default",{value:o,enumerable:!0}):t,o));var le=Q((pt,ce)=>{function Ue(o){var e=new v(o),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var n=Ne(t.data),r=[],a=0;!e.eof()&&a<n.numTracks;a++){var s=e.readChunk();if(s.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+s.id+"'";var i=Ae(s.data);r.push(i)}return{header:n,tracks:r}}function Ne(o){var e=new v(o),t=e.readUInt16(),n=e.readUInt16(),r={format:t,numTracks:n},a=e.readUInt16();return a&32768?(r.framesPerSecond=256-(a>>8),r.ticksPerFrame=a&255):r.ticksPerBeat=a,r}function Ae(o){for(var e=new v(o),t=[];!e.eof();){var n=a();t.push(n)}return t;var r;function a(){var s={};s.deltaTime=e.readVarInt();var i=e.readUInt8();if((i&240)===240)if(i===255){s.meta=!0;var c=e.readUInt8(),l=e.readVarInt();switch(c){case 0:if(s.type="sequenceNumber",l!==2)throw"Expected length for sequenceNumber event is 2, got "+l;return s.number=e.readUInt16(),s;case 1:return s.type="text",s.text=e.readString(l),s;case 2:return s.type="copyrightNotice",s.text=e.readString(l),s;case 3:return s.type="trackName",s.text=e.readString(l),s;case 4:return s.type="instrumentName",s.text=e.readString(l),s;case 5:return s.type="lyrics",s.text=e.readString(l),s;case 6:return s.type="marker",s.text=e.readString(l),s;case 7:return s.type="cuePoint",s.text=e.readString(l),s;case 32:if(s.type="channelPrefix",l!=1)throw"Expected length for channelPrefix event is 1, got "+l;return s.channel=e.readUInt8(),s;case 33:if(s.type="portPrefix",l!=1)throw"Expected length for portPrefix event is 1, got "+l;return s.port=e.readUInt8(),s;case 47:if(s.type="endOfTrack",l!=0)throw"Expected length for endOfTrack event is 0, got "+l;return s;case 81:if(s.type="setTempo",l!=3)throw"Expected length for setTempo event is 3, got "+l;return s.microsecondsPerBeat=e.readUInt24(),s;case 84:if(s.type="smpteOffset",l!=5)throw"Expected length for smpteOffset event is 5, got "+l;var u=e.readUInt8(),d={0:24,32:25,64:29,96:30};return s.frameRate=d[u&96],s.hour=u&31,s.min=e.readUInt8(),s.sec=e.readUInt8(),s.frame=e.readUInt8(),s.subFrame=e.readUInt8(),s;case 88:if(s.type="timeSignature",l!=2&&l!=4)throw"Expected length for timeSignature event is 4 or 2, got "+l;return s.numerator=e.readUInt8(),s.denominator=1<<e.readUInt8(),l===4?(s.metronome=e.readUInt8(),s.thirtyseconds=e.readUInt8()):(s.metronome=36,s.thirtyseconds=8),s;case 89:if(s.type="keySignature",l!=2)throw"Expected length for keySignature event is 2, got "+l;return s.key=e.readInt8(),s.scale=e.readUInt8(),s;case 127:return s.type="sequencerSpecific",s.data=e.readBytes(l),s;default:return s.type="unknownMeta",s.data=e.readBytes(l),s.metatypeByte=c,s}}else if(i==240){s.type="sysEx";var l=e.readVarInt();return s.data=e.readBytes(l),s}else if(i==247){s.type="endSysEx";var l=e.readVarInt();return s.data=e.readBytes(l),s}else throw"Unrecognised MIDI event type byte: "+i;else{var f;if((i&128)===0){if(r===null)throw"Running status byte encountered before status byte";f=i,i=r,s.running=!0}else f=e.readUInt8(),r=i;var p=i>>4;switch(s.channel=i&15,p){case 8:return s.type="noteOff",s.noteNumber=f,s.velocity=e.readUInt8(),s;case 9:var b=e.readUInt8();return s.type=b===0?"noteOff":"noteOn",s.noteNumber=f,s.velocity=b,b===0&&(s.byte9=!0),s;case 10:return s.type="noteAftertouch",s.noteNumber=f,s.amount=e.readUInt8(),s;case 11:return s.type="controller",s.controllerType=f,s.value=e.readUInt8(),s;case 12:return s.type="programChange",s.programNumber=f,s;case 13:return s.type="channelAftertouch",s.amount=f,s;case 14:return s.type="pitchBend",s.value=f+(e.readUInt8()<<7)-8192,s;default:throw"Unrecognised MIDI event type: "+p}}}}function v(o){this.buffer=o,this.bufferLen=this.buffer.length,this.pos=0}v.prototype.eof=function(){return this.pos>=this.bufferLen};v.prototype.readUInt8=function(){var o=this.buffer[this.pos];return this.pos+=1,o};v.prototype.readInt8=function(){var o=this.readUInt8();return o&128?o-256:o};v.prototype.readUInt16=function(){var o=this.readUInt8(),e=this.readUInt8();return(o<<8)+e};v.prototype.readInt16=function(){var o=this.readUInt16();return o&32768?o-65536:o};v.prototype.readUInt24=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(o<<16)+(e<<8)+t};v.prototype.readInt24=function(){var o=this.readUInt24();return o&8388608?o-16777216:o};v.prototype.readUInt32=function(){var o=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8();return(o<<24)+(e<<16)+(t<<8)+n};v.prototype.readBytes=function(o){var e=this.buffer.slice(this.pos,this.pos+o);return this.pos+=o,e};v.prototype.readString=function(o){var e=this.readBytes(o);return String.fromCharCode.apply(null,e)};v.prototype.readVarInt=function(){for(var o=0;!this.eof();){var e=this.readUInt8();if(e&128)o+=e&127,o<<=7;else return o+e}return o};v.prototype.readChunk=function(){var o=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:o,length:e,data:t}};ce.exports=Ue});var de=Q((mt,ue)=>{function Re(o,e){if(typeof o!="object")throw"Invalid MIDI data";e=e||{};var t=o.header||{},n=o.tracks||[],r,a=n.length,s=new y;for(Le(s,t,a),r=0;r<a;r++)je(s,n[r],e);return s.buffer}function Le(o,e,t){var n=e.format==null?1:e.format,r=128;e.timeDivision?r=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?r=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(r=e.ticksPerBeat&32767);var a=new y;a.writeUInt16(n),a.writeUInt16(t),a.writeUInt16(r),o.writeChunk("MThd",a.buffer)}function je(o,e,t){var n=new y,r,a=e.length,s=null;for(r=0;r<a;r++)(t.running===!1||!t.running&&!e[r].running)&&(s=null),s=He(n,e[r],s,t.useByte9ForNoteOff);o.writeChunk("MTrk",n.buffer)}function He(o,e,t,n){var r=e.type,a=e.deltaTime,s=e.text||"",i=e.data||[],c=null;switch(o.writeVarInt(a),r){case"sequenceNumber":o.writeUInt8(255),o.writeUInt8(0),o.writeVarInt(2),o.writeUInt16(e.number);break;case"text":o.writeUInt8(255),o.writeUInt8(1),o.writeVarInt(s.length),o.writeString(s);break;case"copyrightNotice":o.writeUInt8(255),o.writeUInt8(2),o.writeVarInt(s.length),o.writeString(s);break;case"trackName":o.writeUInt8(255),o.writeUInt8(3),o.writeVarInt(s.length),o.writeString(s);break;case"instrumentName":o.writeUInt8(255),o.writeUInt8(4),o.writeVarInt(s.length),o.writeString(s);break;case"lyrics":o.writeUInt8(255),o.writeUInt8(5),o.writeVarInt(s.length),o.writeString(s);break;case"marker":o.writeUInt8(255),o.writeUInt8(6),o.writeVarInt(s.length),o.writeString(s);break;case"cuePoint":o.writeUInt8(255),o.writeUInt8(7),o.writeVarInt(s.length),o.writeString(s);break;case"channelPrefix":o.writeUInt8(255),o.writeUInt8(32),o.writeVarInt(1),o.writeUInt8(e.channel);break;case"portPrefix":o.writeUInt8(255),o.writeUInt8(33),o.writeVarInt(1),o.writeUInt8(e.port);break;case"endOfTrack":o.writeUInt8(255),o.writeUInt8(47),o.writeVarInt(0);break;case"setTempo":o.writeUInt8(255),o.writeUInt8(81),o.writeVarInt(3),o.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":o.writeUInt8(255),o.writeUInt8(84),o.writeVarInt(5);var l={24:0,25:32,29:64,30:96},u=e.hour&31|l[e.frameRate];o.writeUInt8(u),o.writeUInt8(e.min),o.writeUInt8(e.sec),o.writeUInt8(e.frame),o.writeUInt8(e.subFrame);break;case"timeSignature":o.writeUInt8(255),o.writeUInt8(88),o.writeVarInt(4),o.writeUInt8(e.numerator);var d=Math.floor(Math.log(e.denominator)/Math.LN2)&255;o.writeUInt8(d),o.writeUInt8(e.metronome),o.writeUInt8(e.thirtyseconds||8);break;case"keySignature":o.writeUInt8(255),o.writeUInt8(89),o.writeVarInt(2),o.writeInt8(e.key),o.writeUInt8(e.scale);break;case"sequencerSpecific":o.writeUInt8(255),o.writeUInt8(127),o.writeVarInt(i.length),o.writeBytes(i);break;case"unknownMeta":e.metatypeByte!=null&&(o.writeUInt8(255),o.writeUInt8(e.metatypeByte),o.writeVarInt(i.length),o.writeBytes(i));break;case"sysEx":o.writeUInt8(240),o.writeVarInt(i.length),o.writeBytes(i);break;case"endSysEx":o.writeUInt8(247),o.writeVarInt(i.length),o.writeBytes(i);break;case"noteOff":var f=n!==!1&&e.byte9||n&&e.velocity==0?144:128;c=f|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteOn":c=144|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.noteNumber),o.writeUInt8(e.velocity);break;case"noteAftertouch":c=160|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.noteNumber),o.writeUInt8(e.amount);break;case"controller":c=176|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.controllerType),o.writeUInt8(e.value);break;case"programChange":c=192|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.programNumber);break;case"channelAftertouch":c=208|e.channel,c!==t&&o.writeUInt8(c),o.writeUInt8(e.amount);break;case"pitchBend":c=224|e.channel,c!==t&&o.writeUInt8(c);var p=8192+e.value,b=p&127,O=p>>7&127;o.writeUInt8(b),o.writeUInt8(O);break;default:throw"Unrecognized event type: "+r}return c}function y(){this.buffer=[]}y.prototype.writeUInt8=function(o){this.buffer.push(o&255)};y.prototype.writeInt8=y.prototype.writeUInt8;y.prototype.writeUInt16=function(o){var e=o>>8&255,t=o&255;this.writeUInt8(e),this.writeUInt8(t)};y.prototype.writeInt16=y.prototype.writeUInt16;y.prototype.writeUInt24=function(o){var e=o>>16&255,t=o>>8&255,n=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n)};y.prototype.writeInt24=y.prototype.writeUInt24;y.prototype.writeUInt32=function(o){var e=o>>24&255,t=o>>16&255,n=o>>8&255,r=o&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(r)};y.prototype.writeInt32=y.prototype.writeUInt32;y.prototype.writeBytes=function(o){this.buffer=this.buffer.concat(Array.prototype.slice.call(o,0))};y.prototype.writeString=function(o){var e,t=o.length,n=[];for(e=0;e<t;e++)n.push(o.codePointAt(e));this.writeBytes(n)};y.prototype.writeVarInt=function(o){if(o<0)throw"Cannot write negative variable-length integer";if(o<=127)this.writeUInt8(o);else{var e=o,t=[];for(t.push(e&127),e>>=7;e;){var n=e&127|128;t.push(n),e>>=7}this.writeBytes(t.reverse())}};y.prototype.writeChunk=function(o,e){this.writeString(o),this.writeUInt32(e.length),this.writeBytes(e)};ue.exports=Re});var he=Q(J=>{J.parseMidi=le();J.writeMidi=de()});var Oe=Be(he());var I=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,n=t+e,r=this.data,a=r.subarray(t,n).indexOf(0);a<0&&(a=e);let s=new Array(a);for(let i=0;i<a;i++)s[i]=r[t+i];return this.offset=n,String.fromCharCode(...s)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function Y(o,e,t){let n=new I(o,e),r=n.readString(4),a=n.readDWORD(t);return new X(r,a,n.offset)}function ee(o,e=0,t,{padding:n=!0,bigEndian:r=!1}={}){let a=[],s=t+e,i=e;for(;i<s;){let c=Y(o,i,r);i=c.offset+c.size,n&&(i-e&1)===1&&i++,a.push(c)}return a}var X=class{constructor(e,t,n){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:n})}};var T=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var m=class o{constructor(e,t,n,r,a){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"polarity",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"direction",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"cc",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:a})}get controllerType(){return this.cc<<7|this.index}static parse(e){let t=e>>10&63,n=e&127,r=e>>7&1,a=e>>8&1,s=e>>9&1;return new o(t,s,a,r,n)}map(e){let t=e;switch(this.polarity===1?(t=(t-.5)*2,this.direction===1&&(t*=-1)):this.direction===1&&(t=1-t),this.type){case 0:break;case 1:t=Math.sign(t)*Math.log(Math.abs(t));break;case 2:t=Math.sign(t)*Math.exp(-Math.abs(t));break;case 3:t=t>=.5?1:0;break;default:console.warn(`unexpected type: ${this.type}`);break}return t}};var te=class o{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),n=e.readInt8();return new o(t,n)}},N=class o{constructor(e,t,n,r,a,s,i,c,l,u,d){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:d})}static parse(e,t){function n(S){for(let x=0;x<t.length;x++)if(t[x].type===S)return t[x]}function r(S){return new I(e,S.offset)}function a(S){let x=n(S);return x?r(x).readString(x.size):null}function s(S){let x=n(S);return x?te.parse(r(x)):null}let i=a("ICMT"),c=a("ICOP"),l=a("ICRD"),u=a("IENG"),d=a("INAM"),f=a("IPRD"),p=a("ISFT"),b=s("ifil"),O=a("isng"),B=a("irom"),U=s("iver");return new o(i,c,l,u,d,f,p,b,O,B,U)}},E=class o{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),n=e.readWORD();return new o(t,n)}},A=class o{constructor(e,t,n,r,a,s,i){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:i})}get isEnd(){let{presetName:e,preset:t,bank:n,library:r,genre:a,morphology:s}=this;return e==="EOP"||e===""&&t+n+r+a+s===0}static parse(e){let t=e.readString(20),n=e.readWORD(),r=e.readWORD(),a=e.readWORD(),s=e.readDWORD(),i=e.readDWORD(),c=e.readDWORD();return new o(t,n,r,a,s,i,c)}},k=class o{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),n=e.readByte();return new o(t,n)}},g=class o{constructor(e,t,n,r,a){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"amount",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:a})}transform(e){let t=this.amount*e;switch(this.transOper){case 0:return t;case 2:return Math.abs(t);default:return t}}static parse(e){let t=e.readWORD(),n=e.readWORD(),r=e.readInt16(),a=e.readWORD(),s=e.readWORD(),i=m.parse(t),c=m.parse(a);return new o(i,n,r,c,s)}},V=class o{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return T[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),n=T[t],r;switch(n){case"keyRange":case"velRange":r=k.parse(e);break;case"instrument":case"sampleID":r=e.readUInt16();break;default:r=e.readInt16();break}return new o(t,r)}},R=class o{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new o;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},L=class o{constructor(e,t,n,r,a,s,i,c,l,u){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:u})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let n=e.readString(20),r=e.readDWORD(),a=e.readDWORD(),s=e.readDWORD(),i=e.readDWORD(),c=e.readDWORD(),l=e.readByte(),u=e.readInt8(),d=e.readWORD(),f=e.readWORD();return t||(s-=r,i-=r),new o(n,r,a,s,i,c,l,u,d,f)}};var h=class{constructor(e,t,n){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.defaultValue=t,this.max=n}clamp(e){return Math.max(this.min,Math.min(e,this.max))}};var Ge=["pcm16","pcm24","compressed"],qe=new Set(Ge),j=class{constructor(e,t,n){if(Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!qe.has(e))throw new Error(`Invalid AudioDataType: ${e}`);this.type=e,this.sampleHeader=t,this.data=n}decodePCM(e){let{type:t}=this;if(t==="pcm16"){let r=e.byteLength/2,a=new Float32Array(r),s=new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);for(let i=0;i<r;i++)a[i]=s[i]/32768;return a}else{let r=e.byteLength/3,a=new Float32Array(r);for(let s=0;s<r;s++){let i=s*3,c=e[i]|e[i+1]<<8|e[i+2]<<16;c&8388608&&(c|=4278190080),a[s]=c/8388608}return a}}async toAudioBuffer(e,t,n){if(this.type==="compressed"){let r=this.data.slice().buffer;return await e.decodeAudioData(r)}else{let r=this.data.subarray(t,n),a=this.decodePCM(r),s=new AudioBuffer({numberOfChannels:1,length:a.length,sampleRate:this.sampleHeader.sampleRate});return s.getChannelData(0).set(a),s}}};function ne(o,e={}){let t=ee(o,0,o.length,e);if(t.length!==1)throw new Error("wrong chunk length");let n=t[0];if(n===null)throw new Error("chunk not found");function r(c,l,u={}){let d=H(c,l,"RIFF","sfbk",u);if(d.length!==3)throw new Error("invalid sfbk structure");let f=We(d[0],l),p=f.version.major===3;return p&&d[2].type!=="LIST"&&(d[2]=Y(l,d[2].offset-9,!1)),{info:f,samplingData:Ke(d[1],l),...a(d[2],l,p)}}function a(c,l,u){let d=H(c,l,"LIST","pdta");if(d.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:$e(d[0],l),presetZone:Ze(d[1],l),presetModulators:Qe(d[2],l),presetGenerators:Xe(d[3],l),instruments:_e(d[4],l),instrumentZone:ze(d[5],l),instrumentModulators:Je(d[6],l),instrumentGenerators:Ye(d[7],l),sampleHeaders:et(d[8],l,u)}}let s=r(n,o,e),i=s.info.version.major===3;return{...s,samples:tt(s.sampleHeaders,s.samplingData.offsetMSB,s.samplingData.offsetLSB,o,i)}}function H(o,e,t,n,r={}){if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let a=new I(e,o.offset),s=a.readString(4);if(s!==n)throw new Error("invalid signature:"+s);return ee(e,a.offset,o.size-4,r)}function We(o,e){let t=H(o,e,"LIST","INFO");return N.parse(e,t)}function Ke(o,e){let t=H(o,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function P(o,e,t,n,r,a){let s=[];if(o.type!==t)throw new Error("invalid chunk type:"+o.type);let i=new I(e,o.offset),c=o.offset+o.size;for(;i.offset<c;){let l=n.parse(i,a);if(r&&r(l))break;s.push(l)}return s}var $e=(o,e)=>P(o,e,"phdr",A,t=>t.isEnd),Ze=(o,e)=>P(o,e,"pbag",E),_e=(o,e)=>P(o,e,"inst",R,t=>t.isEnd),ze=(o,e)=>P(o,e,"ibag",E),Qe=(o,e)=>P(o,e,"pmod",g),Je=(o,e)=>P(o,e,"imod",g),Xe=(o,e)=>P(o,e,"pgen",V,t=>t.isEnd),Ye=(o,e)=>P(o,e,"igen",V),et=(o,e,t)=>P(o,e,"shdr",L,n=>n.isEnd,t);function tt(o,e,t,n,r){let a=new Array(o.length),s=r?1:2,i=r?"compressed":t?"pcm24":"pcm16";for(let c=0;c<o.length;c++){let{start:l,end:u}=o[c],d=e+l*s,f=e+u*s,p=n.subarray(d,f);a[c]=new j(i,o[c],p)}return a}var ye=new Map;for(let o=0;o<T.length;o++)ye.set(T[o],o);var nt=["instrument","sampleID"],ge=["keyRange","velRange"],be=["keynum","velocity"],ve=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],fe=[...ve,...be],we=new Set;for(let o=0;o<fe.length;o++){let e=fe[o],t=ye.get(e);t!==void 0&&we.add(t)}function xe(o){let e={},t=Object.keys(o);for(let n of t){let r=o[n];if(D(n))e[n]=r;else{let a=r;e[n]=a.clamp(a.defaultValue)}}return e}var pe=[["keynum","keyRange"],["velocity","velRange"]],rt=new Set(ge);function D(o){return rt.has(o)}var st=new Set([...nt,...ge,...be,...ve]);function ot(){let o=[],e=T.length;for(let t=0;t<e;t++){let n=T[t];n!==void 0&&!st.has(n)&&o.push(n)}return o}var q=ot(),at=new Set(q);function re(o){return at.has(o)}function Te(o){let e={};for(let t=0;t<o.length;t++){let n=o[t],r=n.type;if(r!==void 0&&!we.has(n.code))if(D(r))e[r]=n.value;else{let a=r;e[a]=n.value}}return e}function Ie(o){let e={};for(let t=0;t<o.length;t++){let n=o[t],r=n.type;if(r!==void 0)if(D(r))e[r]=n.value;else{let a=r;e[a]=n.value}}for(let t=0;t<pe.length;t++){let[n,r]=pe[t],a=e[n];a!==void 0&&(e[r]=new k(a,a))}return e}var M=-32768,F=32767,me=0,G=65535,W={startAddrsOffset:new h(0,0,F),endAddrsOffset:new h(M,0,0),startloopAddrsOffset:new h(M,0,F),endloopAddrsOffset:new h(M,0,F),startAddrsCoarseOffset:new h(0,0,F),modLfoToPitch:new h(-12e3,0,12e3),vibLfoToPitch:new h(-12e3,0,12e3),modEnvToPitch:new h(-12e3,0,12e3),initialFilterFc:new h(1500,13500,13500),initialFilterQ:new h(0,0,960),modLfoToFilterFc:new h(-12e3,0,12e3),modEnvToFilterFc:new h(-12e3,0,12e3),endAddrsCoarseOffset:new h(M,0,0),modLfoToVolume:new h(-960,0,960),chorusEffectsSend:new h(0,0,1e3),reverbEffectsSend:new h(0,0,1e3),pan:new h(-500,0,500),delayModLFO:new h(-12e3,-12e3,5e3),freqModLFO:new h(-16e3,0,4500),delayVibLFO:new h(-12e3,-12e3,5e3),freqVibLFO:new h(-16e3,0,4500),delayModEnv:new h(-12e3,-12e3,5e3),attackModEnv:new h(-12e3,-12e3,8e3),holdModEnv:new h(-12e3,-12e3,5e3),decayModEnv:new h(-12e3,-12e3,8e3),sustainModEnv:new h(0,0,1e3),releaseModEnv:new h(-12e3,-12e3,8e3),keynumToModEnvHold:new h(-1200,0,1200),keynumToModEnvDecay:new h(-1200,0,1200),delayVolEnv:new h(-12e3,-12e3,5e3),attackVolEnv:new h(-12e3,-12e3,8e3),holdVolEnv:new h(-12e3,-12e3,5e3),decayVolEnv:new h(-12e3,-12e3,8e3),sustainVolEnv:new h(0,0,1440),releaseVolEnv:new h(-12e3,-12e3,8e3),keynumToVolEnvHold:new h(-1200,0,1200),keynumToVolEnvDecay:new h(-1200,0,1200),instrument:new h(me,G,G),keyRange:new k(0,127),velRange:new k(0,127),startloopAddrsCoarseOffset:new h(M,0,F),keynum:new h(-1,-1,127),velocity:new h(-1,-1,127),initialAttenuation:new h(0,0,1440),endloopAddrsCoarseOffset:new h(M,0,F),coarseTune:new h(-120,0,120),fineTune:new h(-99,0,99),sampleID:new h(me,G,G),sampleModes:new h(0,0,3),scaleTuning:new h(0,100,100),exclusiveClass:new h(0,0,127),overridingRootKey:new h(-1,-1,127)};function w(o){return Math.pow(2,o/1200)}var K=class{constructor(e,t,n,r,a){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"sampleHeader",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"controllerToDestinations",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"destinationToModulators",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"voiceHandlers",{enumerable:!0,configurable:!0,writable:!0,value:{modLfoToPitch:(s,i)=>{s.modLfoToPitch=this.clamp("modLfoToPitch",i)},vibLfoToPitch:(s,i)=>{s.vibLfoToPitch=this.clamp("vibLfoToPitch",i)},modEnvToPitch:(s,i)=>{s.modEnvToPitch=this.clamp("modEnvToPitch",i)},initialFilterFc:(s,i)=>{s.initialFilterFc=this.clamp("initialFilterFc",i)},initialFilterQ:(s,i)=>{s.initialFilterQ=this.clamp("initialFilterQ",i)},modLfoToFilterFc:(s,i)=>{s.modLfoToFilterFc=this.clamp("modLfoToFilterFc",i)},modEnvToFilterFc:(s,i)=>{s.modEnvToFilterFc=this.clamp("modEnvToFilterFc",i)},modLfoToVolume:(s,i)=>{s.modLfoToVolume=this.clamp("modLfoToVolume",i)},chorusEffectsSend:(s,i)=>{s.chorusEffectsSend=this.clamp("chorusEffectsSend",i)/1e3},reverbEffectsSend:(s,i)=>{s.reverbEffectsSend=this.clamp("reverbEffectsSend",i)/1e3},pan:(s,i)=>{s.pan=this.clamp("pan",i)/1e3},delayModLFO:(s,i)=>{s.delayModLFO=w(this.clamp("delayModLFO",i))},freqModLFO:(s,i)=>{s.freqModLFO=this.clamp("freqModLFO",i)},delayVibLFO:(s,i)=>{s.delayVibLFO=w(this.clamp("delayVibLFO",i))},freqVibLFO:(s,i)=>{s.freqVibLFO=this.clamp("freqVibLFO",i)},delayModEnv:(s,i)=>{s.modDelay=w(this.clamp("delayModEnv",i))},attackModEnv:(s,i)=>{s.modAttack=w(this.clamp("attackModEnv",i))},holdModEnv:(s,i)=>{let c=this.clamp("holdModEnv",i),l=this.clamp("keynumToModEnvHold",i);s.modHold=this.getModHold(c,l)},decayModEnv:(s,i)=>{let c=this.clamp("decayModEnv",i),l=this.clamp("keynumToModEnvDecay",i);s.modDecay=this.getModDecay(c,l)},sustainModEnv:(s,i)=>{s.modSustain=this.clamp("sustainModEnv",i)/1e3},releaseModEnv:(s,i)=>{s.modRelease=w(this.clamp("releaseModEnv",i))},keynumToModEnvHold:(s,i)=>{let c=this.clamp("holdModEnv",i),l=this.clamp("keynumToModEnvHold",i);s.modHold=this.getModHold(c,l)},keynumToModEnvDecay:(s,i)=>{let c=this.clamp("decayModEnv",i),l=this.clamp("keynumToModEnvDecay",i);s.modDecay=this.getModDecay(c,l)},delayVolEnv:(s,i)=>{s.volDelay=w(this.clamp("delayVolEnv",i))},attackVolEnv:(s,i)=>{s.volAttack=w(this.clamp("attackVolEnv",i))},holdVolEnv:(s,i)=>{let c=this.clamp("holdVolEnv",i),l=this.clamp("keynumToVolEnvHold",i);s.volHold=this.getVolHold(c,l)},decayVolEnv:(s,i)=>{let c=this.clamp("decayVolEnv",i),l=this.clamp("keynumToVolEnvDecay",i);s.volDecay=this.getVolDecay(c,l)},sustainVolEnv:(s,i)=>{s.volSustain=this.clamp("sustainVolEnv",i)/1e3},releaseVolEnv:(s,i)=>{s.volRelease=w(this.clamp("releaseVolEnv",i))},keynumToVolEnvHold:(s,i)=>{let c=this.clamp("holdVolEnv",i),l=this.clamp("keynumToVolEnvHold",i);s.modHold=this.getVolHold(c,l)},keynumToVolEnvDecay:(s,i)=>{let c=this.clamp("decayVolEnv",i),l=this.clamp("keynumToVolEnvDecay",i);s.modDecay=this.getVolDecay(c,l)},initialAttenuation:(s,i)=>{s.initialAttenuation=this.clamp("initialAttenuation",i)},coarseTune:(s,i)=>{s.detune=this.getDetune(i)},fineTune:(s,i)=>{s.detune=this.getDetune(i)},scaleTuning:(s,i)=>{s.playbackRate=this.getPlaybackRate(i)}}}),this.setControllerToDestinations(),this.setDestinationToModulators()}setControllerToDestinations(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],n=t.sourceOper.controllerType,r=t.destinationOper,a=this.controllerToDestinations.get(n);a?a.add(t.destinationOper):this.controllerToDestinations.set(n,new Set([r]))}}setDestinationToModulators(){for(let e=0;e<this.modulators.length;e++){let t=this.modulators[e],n=t.destinationOper,r=this.destinationToModulators.get(n);r?r.push(t):this.destinationToModulators.set(n,[t])}}getModHold(e,t){return w(e+(this.key-60)*t)}getModDecay(e,t){return w(e+(this.key-60)*t)}getVolHold(e,t){return w(e+(this.key-60)*t)}getVolDecay(e,t){return w(e+(this.key-60)*t)}getPlaybackRate(e){let t=this.clamp("overridingRootKey",e),n=this.clamp("scaleTuning",e),r=t===-1?this.sampleHeader.originalPitch:t;return Math.pow(2,(this.key-r)*n/1200)}getDetune(e){let t=this.clamp("coarseTune",e)*100,n=this.clamp("fineTune",e),r=this.sampleHeader.pitchCorrection;return t+n+r}transformParams(e,t){let n={},r=this.controllerToDestinations.get(e);if(!r)return n;for(let a of r){let s=T[a];if(!s||!re(s))continue;let i=this.destinationToModulators.get(a);if(i){n[s]=this.generators[s];for(let c of i){let l=c.sourceOper,u=l.map(t[l.controllerType]),d=1,f=c.amountSourceOper;if(!(f.cc===0&&f.index===0)){let b=t[f.controllerType];d=f.map(b)}let p=c.transform(u*d);Number.isNaN(p)||(n[s]+=p)}}}return n}transformAllParams(e){let t=structuredClone(this.generators);for(let n of this.modulators){let r=n.sourceOper.controllerType,a=e[r];if(!a)continue;let s=T[n.destinationOper];if(!s||!re(s))continue;let c=n.sourceOper.map(a),l=1,u=n.amountSourceOper;if(!(u.cc===0&&u.index===0)){let f=e[u.controllerType];l=u.map(f)}let d=n.transform(c*l);Number.isNaN(d)||(t[s]+=d)}return t}clamp(e,t){return W[e].clamp(t[e])}getParams(e,t){let n={},r=structuredClone(this.generators),a=this.transformParams(e,t),s=Object.keys(a);for(let i of s)r[i]=a[i];for(let i of s)this.voiceHandlers[i](n,r);return n}getAllParams(e){let t={start:this.generators.startAddrsCoarseOffset*32768+this.generators.startAddrsOffset,end:this.generators.endAddrsCoarseOffset*32768+this.generators.endAddrsOffset,loopStart:this.sampleHeader.loopStart+this.generators.startloopAddrsCoarseOffset*32768+this.generators.startloopAddrsOffset,loopEnd:this.sampleHeader.loopEnd+this.generators.endloopAddrsCoarseOffset*32768+this.generators.endloopAddrsOffset,instrument:this.generators.instrument,sampleID:this.generators.sampleID,sample:this.sample,sampleRate:this.sampleHeader.sampleRate,sampleName:this.sampleHeader.sampleName,sampleModes:this.generators.sampleModes,exclusiveClass:this.clamp("exclusiveClass",this.generators)},n=this.transformAllParams(e);for(let r=0;r<q.length;r++){let a=q[r];this.voiceHandlers[a](t,n)}return t}};var Se=[new g(m.parse(1282),48,960,m.parse(0),0),new g(m.parse(258),8,-2400,m.parse(0),0),new g(m.parse(13),6,50,m.parse(0),0),new g(m.parse(129),6,50,m.parse(0),0),new g(m.parse(1415),48,960,m.parse(0),0),new g(m.parse(650),48,1,m.parse(0),0),new g(m.parse(1419),48,960,m.parse(0),0),new g(m.parse(219),16,.2,m.parse(0),0),new g(m.parse(221),15,.2,m.parse(0),0),new g(m.parse(526),51,127,m.parse(16),0)];var $=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},Z=class{constructor(e,t){Object.defineProperty(this,"generators",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulators",{enumerable:!0,configurable:!0,writable:!0,value:t})}},C=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:e})}getGeneratorParams(e,t,n,r){let a=new Array(r-n);for(let s=n;s<r;s++){let i=t[s].generatorIndex,c=t[s+1].generatorIndex;a[s-n]=e.slice(i,c)}return a}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],n=this.parsed.presetHeaders[e+1],r=n?n.presetBagIndex:this.parsed.presetZone.length-1;return this.getGeneratorParams(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,r)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],n=this.parsed.instruments[e+1],r=n?n.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGeneratorParams(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,r)}getModulators(e,t,n,r){let a=new Array(r-n);for(let s=n;s<r;s++){let i=t[s].modulatorIndex,c=t[s+1].modulatorIndex;a[s-n]=e.slice(i,c)}return a}getPresetModulators(e){let t=this.parsed.presetHeaders[e],n=this.parsed.presetHeaders[e+1],r=n?n.presetBagIndex:this.parsed.presetZone.length-1;return this.getModulators(this.parsed.presetModulators,this.parsed.presetZone,t.presetBagIndex,r)}getInstrumentModulators(e){let t=this.parsed.instruments[e],n=this.parsed.instruments[e+1],r=n?n.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getModulators(this.parsed.instrumentModulators,this.parsed.instrumentZone,t.instrumentBagIndex,r)}findInstrumentZone(e,t,n){let r=this.getInstrumentGenerators(e),a=this.getInstrumentModulators(e),s,i=[];for(let c=0;c<r.length;c++){let l=Ie(r[c]);if(l.sampleID===void 0){s=l,i=a[c];continue}if(!(l.keyRange&&!l.keyRange.in(t))&&!(l.velRange&&!l.velRange.in(n)))if(s){let u={...s,...l},d=[...i,...a[c]];return new $(u,d)}else return new $(l,a[c])}}findInstrument(e,t,n){let r=this.getPresetGenerators(e),a=this.getPresetModulators(e),s,i=[];for(let c=0;c<r.length;c++){let l=Te(r[c]);if(l.instrument===void 0){s=l,i=a[c];continue}if(l.keyRange&&!l.keyRange.in(t)||l.velRange&&!l.velRange.in(n))continue;let u=this.findInstrumentZone(l.instrument,t,n);if(u)if(s){let d={...s,...l},f=[...i,...a[c]],p=new Z(d,f);return this.createVoice(t,p,u)}else{let d=new Z(l,a[c]);return this.createVoice(t,d,u)}}return null}createVoice(e,t,n){let r=xe(W);Object.assign(r,n.generators);let a=Object.keys(t.generators);for(let u=0;u<a.length;u++){let d=a[u];D(d)||(r[d]+=t.generators[d])}let s=[...Se,...t.modulators,...n.modulators],i=r.sampleID,c=this.parsed.samples[i],l=this.parsed.sampleHeaders[i];return new K(e,r,s,c,l)}getVoice(e,t,n,r){let a=this.parsed.presetHeaders.findIndex(i=>i.preset===t&&i.bank===e);if(a<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let s=this.findInstrument(a,n,r);return s||(console.warn("instrument not found: bank=%s instrument=%s",e,t),null)}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let n=0;n<t.length;n++){let r=t[n];e[r.bank]||(e[r.bank]={}),e[r.bank][r.preset]=r.presetName}return e}};var oe=class{voice;voiceParams;adjustedBaseFreq=2e4;index=-1;ending=!1;bufferSource;filterNode;filterDepth;volumeEnvelopeNode;volumeDepth;modulationLFO;modulationDepth;constructor(e,t,n){this.noteNumber=e,this.velocity=t,this.startTime=n,this.ready=new Promise(r=>{this.resolveReady=r})}},_={noteOnVelocity:{type:2,defaultValue:0},noteOnKeyNumber:{type:3,defaultValue:0},pitchWheel:{type:14,defaultValue:8192/16383},pitchWheelSensitivity:{type:16,defaultValue:2/128},link:{type:127,defaultValue:0},modulationDepthMSB:{type:129,defaultValue:0},volumeMSB:{type:135,defaultValue:100/127},panMSB:{type:138,defaultValue:64/127},expressionMSB:{type:139,defaultValue:1},sustainPedal:{type:192,defaultValue:0}},ae=class{array=new Float32Array(256);constructor(){let e=Object.entries(_);for(let[t,{type:n,defaultValue:r}]of e)this.array[n]=r,Object.defineProperty(this,t,{get:()=>this.array[n],set:a=>this.array[n]=a,enumerable:!0,configurable:!0})}},it=["volDelay","volAttack","volHold","volDecay","volSustain","volRelease","initialAttenuation"],ct=new Set(it),lt=["modEnvToPitch","initialFilterFc","modEnvToFilterFc","modDelay","modAttack","modHold","modDecay","modSustain"],ut=new Set(lt),dt=["modEnvToPitch","modDelay","modAttack","modHold","modDecay","modSustain","playbackRate"],ht=new Set(dt);function z(o){return Math.pow(10,o/200)}var se=1/-Math.log(z(-1e3)),Pe=1/-Math.log(z(-600)),ke=class extends EventTarget{perceptualSmoothingTime=.004;mode="GM1";numChannels=16;ticksPerBeat=120;totalTime=0;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=Array.from({length:128},()=>[]);voiceCounter=new Map;voiceCache=new Map;realtimeVoiceCache=new Map;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;totalTimeEventTypes=new Set(["noteOff"]);tempo=1;loop=!1;playPromise;timeline=[];notePromises=[];instruments=new Set;exclusiveClassNotes=new Array(128);static channelSettings={scheduleIndex:0,detune:0,programNumber:0,dataMSB:0,dataLSB:0,rpnMSB:127,rpnLSB:127,modulationDepthRange:50,fineTuning:0,coarseTuning:0};constructor(e){super(),this.audioContext=e,this.masterVolume=new GainNode(e),this.scheduler=new GainNode(e,{gain:0}),this.schedulerBuffer=new AudioBuffer({length:1,sampleRate:e.sampleRate}),this.messageHandlers=this.createMessageHandlers(),this.voiceParamsHandlers=this.createVoiceParamsHandlers(),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.masterVolume.connect(e.destination),this.scheduler.connect(e.destination),this.GM1SystemOn()}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let n=e.parsed.presetHeaders,r=this.soundFontTable;for(let a=0;a<n.length;a++){let{preset:s,bank:i}=n[a];r[s][i]=t}}async toUint8Array(e){let t;if(typeof e=="string"){let r=await(await fetch(e)).arrayBuffer();t=new Uint8Array(r)}else if(e instanceof Uint8Array)t=e;else throw new TypeError("input must be a URL string or Uint8Array");return t}async loadSoundFont(e){if(this.voiceCounter.clear(),Array.isArray(e)){let t=new Array(e.length);for(let r=0;r<e.length;r++)t[r]=this.toUint8Array(e[r]);let n=await Promise.all(t);for(let r=0;r<n.length;r++){let a=ne(n[r]),s=new C(a);this.addSoundFont(s)}}else{let t=await this.toUint8Array(e),n=ne(t),r=new C(n);this.addSoundFont(r)}}async loadMIDI(e){this.voiceCounter.clear();let t=await this.toUint8Array(e),n=(0,Oe.parseMidi)(t);this.ticksPerBeat=n.header.ticksPerBeat;let r=this.extractMidiData(n);this.instruments=r.instruments,this.timeline=r.timeline,this.totalTime=this.calcTotalTime()}cacheVoiceIds(){let{channels:e,timeline:t,voiceCounter:n}=this;for(let r=0;r<t.length;r++){let a=t[r];switch(a.type){case"noteOn":{let s=this.getVoiceId(e[a.channel],a.noteNumber,a.velocity);n.set(s,(n.get(s)??0)+1);break}case"controller":a.controllerType===0?this.setBankMSB(a.channel,a.value):a.controllerType===32&&this.setBankLSB(a.channel,a.value);break;case"programChange":this.setProgramChange(a.channel,a.programNumber,a.startTime)}}for(let[r,a]of n)a===1&&n.delete(r);this.GM1SystemOn()}getVoiceId(e,t,n){let r=e.programNumber,a=this.soundFontTable[r];if(!a)return;let s=e.isDrum?128:0;if(a[s]===void 0){if(e.isDrum)return;s=0}let i=a[s];if(i===void 0)return;let l=this.soundFonts[i].getVoice(s,r,t,n),{instrument:u,sampleID:d}=l.generators;return i*2**32+(u<<16)+d}createChannelAudioNodes(e){let{gainLeft:t,gainRight:n}=this.panToGain(_.panMSB.defaultValue),r=new GainNode(e,{gain:t}),a=new GainNode(e,{gain:n}),s=new ChannelMergerNode(e,{numberOfInputs:2});return r.connect(s,0,0),a.connect(s,0,1),s.connect(this.masterVolume),{gainL:r,gainR:a,merger:s}}createChannels(e){return Array.from({length:this.numChannels},()=>({currentBufferSource:null,isDrum:!1,state:new ae,...this.constructor.channelSettings,...this.createChannelAudioNodes(e),scheduledNotes:[],sustainNotes:[]}))}async createAudioBuffer(e){let{sample:t,start:n,end:r}=e,a=t.data.length+r;return await t.toAudioBuffer(this.audioContext,n,a)}createBufferSource(e,t){let n=new AudioBufferSourceNode(this.audioContext);return n.buffer=t,n.loop=e.sampleModes%2!==0,n.loop&&(n.loopStart=e.loopStart/e.sampleRate,n.loopEnd=e.loopEnd/e.sampleRate),n}scheduleTimelineEvents(e,t){let n=this.resumeTime-this.startTime,r=e+n+this.lookAhead,a=this.startDelay-n,s=this.timeline,i=1/this.tempo;for(;t<s.length;){let c=s[t],l=c.startTime*i;if(r<l)break;let u=l+a;switch(c.type){case"noteOn":this.noteOn(c.channel,c.noteNumber,c.velocity,u);break;case"noteOff":{this.noteOff(c.channel,c.noteNumber,c.velocity,u,!1);break}case"controller":this.setControlChange(c.channel,c.controllerType,c.value,u);break;case"programChange":this.setProgramChange(c.channel,c.programNumber,u);break;case"pitchBend":this.setPitchBend(c.channel,c.value+8192,u);break;case"sysEx":this.handleSysEx(c.data,u)}t++}return t}getQueueIndex(e){let t=this.timeline,n=1/this.tempo;for(let r=0;r<t.length;r++)if(e<=t[r].startTime*n)return r;return 0}resetAllStates(){this.exclusiveClassNotes.fill(void 0),this.drumExclusiveClassNotes.fill(void 0),this.voiceCache.clear(),this.realtimeVoiceCache.clear();let e=this.channels;for(let t=0;t<e.length;t++)e[t].scheduledNotes=[],this.resetChannelStates(t)}updateStates(e,t){let{timeline:n,resumeTime:r}=this,a=1/this.tempo,s=this.audioContext.currentTime;t<e&&(e=0);for(let i=e;i<t;i++){let c=n[i];switch(c.type){case"controller":this.setControlChange(c.channel,c.controllerType,c.value,s-r+c.startTime*a);break;case"programChange":this.setProgramChange(c.channel,c.programNumber,s-r+c.startTime*a);break;case"pitchBend":this.setPitchBend(c.channel,c.value+8192,s-r+c.startTime*a);break;case"sysEx":this.handleSysEx(c.data,s-r+c.startTime*a)}}}async playNotes(){let e=this.audioContext;e.state==="suspended"&&await e.resume();let t=this.isPaused;this.isPlaying=!0,this.isPaused=!1,this.startTime=e.currentTime,t?this.dispatchEvent(new Event("resumed")):this.dispatchEvent(new Event("started"));let n=this.getQueueIndex(this.resumeTime),r;for(this.notePromises=[];;){let a=e.currentTime;if(this.totalTime<this.currentTime()||this.timeline.length<=n)if(await this.stopNotes(0,!0,a),this.loop){this.resetAllStates(),this.startTime=e.currentTime,this.resumeTime=0,n=0,this.dispatchEvent(new Event("looped"));continue}else{await e.suspend(),r="ended";break}if(this.isPausing){await this.stopNotes(0,!0,a),await e.suspend(),this.isPausing=!1,r="paused";break}else if(this.isStopping){await this.stopNotes(0,!0,a),await e.suspend(),this.isStopping=!1,r="stopped";break}else if(this.isSeeking){this.stopNotes(0,!0,a),this.startTime=e.currentTime;let i=this.getQueueIndex(this.resumeTime);this.updateStates(n,i),n=i,this.isSeeking=!1,this.dispatchEvent(new Event("seeked"));continue}n=this.scheduleTimelineEvents(a,n);let s=a+this.noteCheckInterval;await this.scheduleTask(()=>{},s)}r!=="paused"&&this.resetAllStates(),this.isPlaying=!1,r==="paused"?(this.isPaused=!0,this.dispatchEvent(new Event("paused"))):(this.isPaused=!1,this.dispatchEvent(new Event(r)))}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}getSoundFontId(e){let t=e.programNumber,n=e.isDrum?"128":"000",r=t.toString().padStart(3,"0");return`${n}:${r}`}extractMidiData(e){let t=new Set,n=[],r=this.channels;for(let l=0;l<e.tracks.length;l++){let u=e.tracks[l],d=0;for(let f=0;f<u.length;f++){let p=u[f];switch(d+=p.deltaTime,p.ticks=d,p.type){case"noteOn":{let b=r[p.channel];t.add(this.getSoundFontId(b));break}case"programChange":{let b=r[p.channel];this.setProgramChange(p.channel,p.programNumber),t.add(this.getSoundFontId(b));break}}delete p.deltaTime,n.push(p)}}let a={controller:0,sysEx:1};n.sort((l,u)=>l.ticks!==u.ticks?l.ticks-u.ticks:(a[l.type]||2)-(a[u.type]||2));let s=0,i=0,c=.5;for(let l=0;l<n.length;l++){let u=n[l],d=this.ticksToSecond(u.ticks-i,c);u.startTime=s+d,u.type==="setTempo"&&(s+=this.ticksToSecond(u.ticks-i,c),c=u.microsecondsPerBeat/1e6,i=u.ticks)}return{instruments:t,timeline:n}}stopActiveNotes(e,t,n,r){let a=this.channels[e],s=[];return this.processActiveNotes(a,r,i=>{let c=this.noteOff(e,i.noteNumber,t,r,n);this.notePromises.push(c),s.push(c)}),Promise.all(s)}stopChannelNotes(e,t,n,r){let a=this.channels[e],s=[];return this.processScheduledNotes(a,i=>{let c=this.noteOff(e,i.noteNumber,t,r,n);this.notePromises.push(c),s.push(c)}),Promise.all(s)}stopNotes(e,t,n){let r=this.channels;for(let s=0;s<r.length;s++)this.stopChannelNotes(s,e,t,n);let a=Promise.all(this.notePromises);return this.notePromises=[],a}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,this.voiceCounter.size===0&&this.cacheVoiceIds(),this.playPromise=this.playNotes(),await this.playPromise)}async stop(){this.isPlaying&&(this.isStopping=!0,await this.playPromise)}async pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime=e+this.resumeTime-this.startTime,this.isPausing=!0,await this.playPromise}async resume(){this.isPaused&&(this.playPromise=this.playNotes(),await this.playPromise)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}tempoChange(e){let t=this.tempo/e;this.resumeTime=this.resumeTime*t,this.tempo=e,this.totalTime=this.calcTotalTime(),this.seekTo(this.currentTime()*t)}calcTotalTime(){let e=this.totalTimeEventTypes,t=this.timeline,n=1/this.tempo,r=0;for(let a=0;a<t.length;a++){let s=t[a];if(!e.has(s.type))continue;let i=s.startTime*n;r<i&&(r=i)}return r+this.startDelay}currentTime(){return this.isPlaying?this.audioContext.currentTime+this.resumeTime-this.startTime:this.resumeTime}async processScheduledNotes(e,t){let n=e.scheduledNotes,r=[];for(let a=e.scheduleIndex;a<n.length;a++){let s=n[a];if(!s||s.ending)continue;let i=s.ready.then(()=>t(s));r.push(i)}await Promise.all(r)}async processActiveNotes(e,t,n){let r=e.scheduledNotes,a=[];for(let s=e.scheduleIndex;s<r.length;s++){let i=r[s];if(!i||i.ending)continue;if(t<i.startTime)break;let c=i.ready.then(()=>n(i));a.push(c)}await Promise.all(a)}rateToCent(e){return 1200*Math.log2(e)}centToRate(e){return Math.pow(2,e/1200)}centToHz(e){return 8.176*this.centToRate(e)}calcChannelDetune(e){let t=e.coarseTuning+e.fineTuning,n=e.state.pitchWheel*2-1,r=e.state.pitchWheelSensitivity*12800,a=n*r;return t+a}updateChannelDetune(e,t){this.processScheduledNotes(e,n=>{this.setDetune(e,n,t)})}calcNoteDetune(e,t){return e.detune+t.voiceParams.detune}setVolumeEnvelope(e,t){let{voiceParams:n,startTime:r}=e,a=z(-n.initialAttenuation),s=a*(1-n.volSustain),i=r+n.volDelay,c=i+n.volAttack,l=c+n.volHold,u=n.volDecay;e.volumeEnvelopeNode.gain.cancelScheduledValues(t).setValueAtTime(0,r).setValueAtTime(1e-6,i).exponentialRampToValueAtTime(a,c).setValueAtTime(a,l).setTargetAtTime(s,l,u*se)}setDetune(e,t,n){let r=this.calcNoteDetune(e,t);t.bufferSource.detune.cancelScheduledValues(n).setValueAtTime(r,n);let a=this.perceptualSmoothingTime/5;t.bufferSource.detune.cancelAndHoldAtTime(n).setTargetAtTime(r,n,a)}setPitchEnvelope(e,t){let{bufferSource:n,voiceParams:r}=e,a=r.playbackRate;n.playbackRate.cancelScheduledValues(t).setValueAtTime(a,t);let s=r.modEnvToPitch;if(s===0)return;let i=a*this.centToRate(s),c=e.startTime+r.modDelay,l=c+r.modAttack,u=l+r.modHold,d=r.modDecay;n.playbackRate.setValueAtTime(a,c).exponentialRampToValueAtTime(i,l).setValueAtTime(i,u).setTargetAtTime(a,u,d*se)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setFilterEnvelope(e,t){let{voiceParams:n,startTime:r}=e,a=n.modEnvToFilterFc,s=n.initialFilterFc,i=s+a,c=s+a*(1-n.modSustain),l=this.centToHz(s),u=this.centToHz(i),d=this.centToHz(c),f=this.clampCutoffFrequency(l),p=this.clampCutoffFrequency(u),b=this.clampCutoffFrequency(d),O=r+n.modDelay,B=O+n.modAttack,U=B+n.modHold,S=n.modDecay;e.adjustedBaseFreq=f,e.filterNode.frequency.cancelScheduledValues(t).setValueAtTime(f,r).setValueAtTime(f,O).exponentialRampToValueAtTime(p,B).setValueAtTime(p,U).setTargetAtTime(b,U,S*se)}startModulation(e,t,n){let r=this.audioContext,{voiceParams:a}=t;t.modulationLFO=new OscillatorNode(r,{frequency:this.centToHz(a.freqModLFO)}),t.filterDepth=new GainNode(r,{gain:a.modLfoToFilterFc}),t.modulationDepth=new GainNode(r),this.setModLfoToPitch(e,t,n),t.volumeDepth=new GainNode(r),this.setModLfoToVolume(t,n),t.modulationLFO.start(t.startTime+a.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeEnvelopeNode.gain)}async getAudioBuffer(e,t,n,r,a){let s=this.getVoiceId(e,t,n);if(a){let i=this.realtimeVoiceCache.get(s);if(i)return i;let c=await this.createAudioBuffer(r);return this.realtimeVoiceCache.set(s,c),c}else{let i=this.voiceCache.get(s);if(i)return i.counter+=1,i.maxCount<=i.counter&&this.voiceCache.delete(s),i.audioBuffer;{let c=this.voiceCounter.get(s)??0,l=await this.createAudioBuffer(r),u={audioBuffer:l,maxCount:c,counter:1};return this.voiceCache.set(s,u),l}}}async setNoteAudioNode(e,t,n){let r=this.audioContext,a=r.currentTime,{noteNumber:s,velocity:i,startTime:c}=t,l=e.state,u=this.getControllerState(e,s,i),d=t.voice.getAllParams(u);t.voiceParams=d;let f=await this.getAudioBuffer(e,s,i,d,n);if(t.bufferSource=this.createBufferSource(d,f),t.volumeEnvelopeNode=new GainNode(r),t.filterNode=new BiquadFilterNode(r,{type:"lowpass",Q:d.initialFilterQ/10}),this.setVolumeEnvelope(t,a),this.setFilterEnvelope(t,a),this.setPitchEnvelope(t,a),this.setDetune(e,t,a),0<l.modulationDepthMSB&&this.startModulation(e,t,a),t.bufferSource.connect(t.filterNode),t.filterNode.connect(t.volumeEnvelopeNode),d.sample.type==="compressed"){let p=d.start/f.sampleRate;t.bufferSource.start(c,p)}else t.bufferSource.start(c);return t}handleExclusiveClass(e,t,n){let r=e.voiceParams.exclusiveClass;if(r===0)return;let a=this.exclusiveClassNotes[r];if(a){let[s,i]=a;s&&!s.ending&&this.noteOff(i,s.noteNumber,0,n,!0)}this.exclusiveClassNotes[r]=[e,t]}setNoteRouting(e,t,n){let r=this.channels[e],a=t.volumeEnvelopeNode;a.connect(r.gainL),a.connect(r.gainR),.5<=r.state.sustainPedal&&r.sustainNotes.push(t),this.handleExclusiveClass(t,e,n)}async noteOn(e,t,n,r){let a=this.channels[e],s=r===void 0;s&&(r=this.audioContext.currentTime);let i=new oe(t,n,r),c=a.scheduledNotes;i.index=c.length,c.push(i);let l=a.programNumber,u=this.soundFontTable[l];if(!u)return;let d=a.isDrum?128:0;if(u[d]===void 0){if(a.isDrum)return;d=0}let f=u[d];if(f===void 0)return;let p=this.soundFonts[f];i.voice=p.getVoice(d,l,t,n),i.voice&&(await this.setNoteAudioNode(a,i,s),this.setNoteRouting(e,i,r),i.resolveReady())}disconnectNote(e){e.bufferSource.disconnect(),e.filterNode.disconnect(),e.volumeEnvelopeNode.disconnect(),e.modulationDepth&&(e.volumeDepth.disconnect(),e.modulationDepth.disconnect(),e.modulationLFO.stop())}releaseNote(e,t,n){n??=this.audioContext.currentTime;let r=t.voiceParams.volRelease,a=n+r;return t.filterNode.frequency.cancelScheduledValues(n).setTargetAtTime(t.adjustedBaseFreq,n,t.voiceParams.modRelease*Pe),t.volumeEnvelopeNode.gain.cancelScheduledValues(n).setTargetAtTime(0,n,r*Pe),new Promise(s=>{this.scheduleTask(()=>{let i=t.bufferSource;i.loop=!1,i.stop(a),this.disconnectNote(t),e.scheduledNotes[t.index]=void 0,s()},a)})}noteOff(e,t,n,r,a){let s=this.channels[e];if(!a&&.5<=s.state.sustainPedal)return;let i=this.findNoteOffIndex(s,t);if(i<0)return;let c=s.scheduledNotes[i];c.ending=!0,this.setNoteIndex(s,i);let l=c.ready.then(()=>this.releaseNote(s,c,r));return this.notePromises.push(l),l}setNoteIndex(e,t){let n=!0;for(let r=e.scheduleIndex;r<t;r++){let a=e.scheduledNotes[r];if(a&&!a.ending){n=!1;break}}n&&(e.scheduleIndex=t+1)}findNoteOffIndex(e,t){let n=e.scheduledNotes;for(let r=e.scheduleIndex;r<n.length;r++){let a=n[r];if(a&&!a.ending&&a.noteNumber===t)return r}return-1}releaseSustainPedal(e,t,n){let r=t*2,a=this.channels[e],s=[];for(let i=0;i<a.sustainNotes.length;i++){let c=this.noteOff(e,a.sustainNotes[i].noteNumber,r,n);s.push(c)}return a.sustainNotes=[],s}createMessageHandlers(){let e=new Array(256);return e[128]=(t,n)=>this.noteOff(t[0]&15,t[1],t[2],n),e[144]=(t,n)=>this.noteOn(t[0]&15,t[1],t[2],n),e[176]=(t,n)=>this.setControlChange(t[0]&15,t[1],t[2],n),e[192]=(t,n)=>this.setProgramChange(t[0]&15,t[1],n),e[224]=(t,n)=>this.handlePitchBendMessage(t[0]&15,t[1],t[2],n),e}handleMessage(e,t){let n=e[0];if(n===240)return this.handleSysEx(e.subarray(1),t);let r=this.messageHandlers[n];r&&r(e,t)}handleChannelMessage(e,t,n,r){let a=e&15,s=e&240;switch(s){case 128:return this.noteOff(a,t,n,r);case 144:return this.noteOn(a,t,n,r);case 176:return this.setControlChange(a,t,n,r);case 192:return this.setProgramChange(a,t,r);case 224:return this.handlePitchBendMessage(a,t,n,r);default:console.warn(`Unsupported MIDI message: ${s.toString(16)}`)}}setProgramChange(e,t,n){let r=this.channels[e];r.programNumber=t}handlePitchBendMessage(e,t,n,r){let a=n*128+t;this.setPitchBend(e,a,r)}setPitchBend(e,t,n){let r=this.channels[e];0<=n||(n=this.audioContext.currentTime);let a=r.state,s=a.pitchWheel*2-1,i=(t-8192)/8192;a.pitchWheel=t/16383,r.detune+=(i-s)*a.pitchWheelSensitivity*12800,this.updateChannelDetune(r,n),this.applyVoiceParams(r,14,n)}setModLfoToPitch(e,t,n){if(t.modulationDepth){let r=t.voiceParams.modLfoToPitch,s=(Math.abs(r)+e.state.modulationDepthMSB)*Math.sign(r);t.modulationDepth.gain.cancelScheduledValues(n).setValueAtTime(s,n)}else this.startModulation(e,t,n)}setModLfoToFilterFc(e,t){let n=e.voiceParams.modLfoToFilterFc;e.filterDepth.gain.cancelScheduledValues(t).setValueAtTime(n,t)}setModLfoToVolume(e,t){let n=e.voiceParams.modLfoToVolume,a=(z(Math.abs(n))-1)*Math.sign(n);e.volumeDepth.gain.cancelScheduledValues(t).setValueAtTime(a,t)}setDelayModLFO(e,t){let n=e.startTime;n<t||(e.modulationLFO.stop(t),e.modulationLFO.start(n+e.voiceParams.delayModLFO),e.modulationLFO.connect(e.filterDepth))}setFreqModLFO(e,t){let n=e.voiceParams.freqModLFO;e.modulationLFO.frequency.cancelScheduledValues(t).setValueAtTime(n,t)}createVoiceParamsHandlers(){return{modLfoToPitch:(e,t,n)=>{0<e.state.modulationDepthMSB&&this.setModLfoToPitch(e,t,n)},vibLfoToPitch:(e,t,n)=>{},modLfoToFilterFc:(e,t,n)=>{0<e.state.modulationDepthMSB&&this.setModLfoToFilterFc(t,n)},modLfoToVolume:(e,t,n)=>{0<e.state.modulationDepthMSB&&this.setModLfoToVolume(t,n)},chorusEffectsSend:(e,t,n)=>{},reverbEffectsSend:(e,t,n)=>{},delayModLFO:(e,t,n)=>{0<channel.state.modulationDepth&&this.setDelayModLFO(t,n)},freqModLFO:(e,t,n)=>{0<channel.state.modulationDepthMSB&&this.setFreqModLFO(t,n)},delayVibLFO:(e,t,n)=>{},freqVibLFO:(e,t,n)=>{},detune:(e,t,n)=>{this.setDetune(e,t,n)}}}getControllerState(e,t,n){let r=new Float32Array(e.state.array.length);return r.set(e.state.array),r[2]=n/127,r[3]=t/127,r}applyVoiceParams(e,t,n){this.processScheduledNotes(e,r=>{let a=this.getControllerState(e,r.noteNumber,r.velocity),s=r.voice.getParams(t,a),i=!1,c=!1,l=!1;for(let[u,d]of Object.entries(s)){let f=r.voiceParams[u];d!==f&&(r.voiceParams[u]=d,u in this.voiceParamsHandlers?this.voiceParamsHandlers[u](e,r,n):(ct.has(u)&&(i=!0),ut.has(u)&&(c=!0),ht.has(u)&&(l=!0)))}i&&this.setVolumeEnvelope(r,n),c&&this.setFilterEnvelope(r,n),l&&this.setPitchEnvelope(r,n)})}createControlChangeHandlers(){let e=new Array(128);return e[1]=this.setModulationDepth,e[6]=this.dataEntryMSB,e[7]=this.setVolume,e[10]=this.setPan,e[11]=this.setExpression,e[38]=this.dataEntryLSB,e[64]=this.setSustainPedal,e[100]=this.setRPNLSB,e[101]=this.setRPNMSB,e[120]=this.allSoundOff,e[121]=this.resetAllControllers,e[123]=this.allNotesOff,e}setControlChange(e,t,n,r){let a=this.controlChangeHandlers[t];if(a){a.call(this,e,n,r);let s=this.channels[e];this.applyVoiceParams(s,t+128,r)}else console.warn(`Unsupported Control change: controllerType=${t} value=${n}`)}updateModulation(e,t){let n=e.state.modulationDepthMSB*e.modulationDepthRange;this.processScheduledNotes(e,r=>{r.modulationDepth?r.modulationDepth.gain.setValueAtTime(n,t):this.startModulation(e,r,t)})}setModulationDepth(e,t,n){let r=this.channels[e];0<=n||(n=this.audioContext.currentTime),r.state.modulationDepthMSB=t/127,this.updateModulation(r,n)}setVolume(e,t,n){0<=n||(n=this.audioContext.currentTime);let r=this.channels[e];r.state.volumeMSB=t/127,this.updateChannelVolume(r,n)}panToGain(e){let t=Math.PI/2*Math.max(0,e*127-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t,n){0<=n||(n=this.audioContext.currentTime);let r=this.channels[e];r.state.panMSB=t/127,this.updateChannelVolume(r,n)}setExpression(e,t,n){0<=n||(n=this.audioContext.currentTime);let r=this.channels[e];r.state.expressionMSB=t/127,this.updateChannelVolume(r,n)}dataEntryLSB(e,t,n){this.channels[e].dataLSB=t,this.handleRPN(e,n)}updateChannelVolume(e,t){let n=e.state,r=n.volumeMSB*n.expressionMSB,{gainLeft:a,gainRight:s}=this.panToGain(n.panMSB);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(r*a,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(r*s,t)}setSustainPedal(e,t,n){let r=this.channels[e];0<=n||(n=this.audioContext.currentTime),r.state.sustainPedal=t/127,64<=t?this.processScheduledNotes(r,a=>{r.sustainNotes.push(a)}):this.releaseSustainPedal(e,t,n)}limitData(e,t,n,r,a){a<e.dataLSB?(e.dataMSB++,e.dataLSB=r):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=a),n<e.dataMSB?(e.dataMSB=n,e.dataLSB=a):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=r)}limitDataMSB(e,t,n){n<e.dataMSB?e.dataMSB=n:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e,t){let n=this.channels[e];switch(n.rpnMSB*128+n.rpnLSB){case 0:this.handlePitchBendRangeRPN(e,t);break;case 1:this.handleFineTuningRPN(e,t);break;case 2:this.handleCoarseTuningRPN(e,t);break;case 16383:break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${n.rpnMSB} LSB=${n.rpnLSB}`)}}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t,n){this.channels[e].dataMSB=t,this.handleRPN(e,n)}handlePitchBendRangeRPN(e,t){let n=this.channels[e];this.limitData(n,0,127,0,127);let r=(n.dataMSB+n.dataLSB/128)*100;this.setPitchBendRange(e,r,t)}setPitchBendRange(e,t,n){let r=this.channels[e];0<=n||(n=this.audioContext.currentTime);let a=r.state,s=a.pitchWheelSensitivity,i=t/12800;a.pitchWheelSensitivity=i,r.detune+=(a.pitchWheel*2-1)*(i-s)*12800,this.updateChannelDetune(r,n),this.applyVoiceParams(r,16,n)}handleFineTuningRPN(e,t){let n=this.channels[e];this.limitData(n,0,127,0,127);let a=(n.dataMSB*128+n.dataLSB-8192)/8192*100;this.setFineTuning(e,a,t)}setFineTuning(e,t,n){let r=this.channels[e];0<=n||(n=this.audioContext.currentTime);let a=r.fineTuning,s=t;r.fineTuning=s,r.detune+=s-a,this.updateChannelDetune(r,n)}handleCoarseTuningRPN(e,t){let n=this.channels[e];this.limitDataMSB(n,0,127);let r=(n.dataMSB-64)*100;this.setCoarseTuning(e,r,t)}setCoarseTuning(e,t,n){let r=this.channels[e];0<=n||(n=this.audioContext.currentTime);let a=r.coarseTuning,s=t;r.coarseTuning=s,r.detune+=s-a,this.updateChannelDetune(r,n)}allSoundOff(e,t,n){return 0<=n||(n=this.audioContext.currentTime),this.stopActiveNotes(e,0,!0,n)}resetChannelStates(e){let t=this.audioContext.currentTime,n=this.channels[e],r=n.state,a=Object.entries(_);for(let[s,{type:i,defaultValue:c}]of a)128<=i?this.setControlChange(e,i-128,Math.ceil(c*127),t):r[s]=c;for(let s of Object.keys(this.constructor.channelSettings))n[s]=this.constructor.channelSettings[s];this.mode="GM1"}resetAllControllers(e,t,n){let r=["pitchWheel","expressionMSB","modulationDepthMSB","sustainPedal"],a=this.channels[e],s=a.state;for(let c=0;c<r.length;c++){let l=r[c],{type:u,defaultValue:d}=_[l];128<=u?this.setControlChange(e,u-128,Math.ceil(d*127),n):s[l]=d}this.setPitchBend(e,8192,n);let i=["rpnMSB","rpnLSB"];for(let c=0;c<i.length;c++){let l=i[c];a[l]=this.constructor.channelSettings[l]}}allNotesOff(e,t,n){return 0<=n||(n=this.audioContext.currentTime),this.stopActiveNotes(e,0,!1,n)}handleUniversalNonRealTimeExclusiveMessage(e,t){switch(e[2]){case 9:switch(e[3]){case 1:this.GM1SystemOn(t);break;case 2:break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(e){let t=this.channels;0<=e||(e=this.audioContext.currentTime),this.mode="GM1";for(let n=0;n<t.length;n++){this.allSoundOff(n,0,e);let r=t[n];r.isDrum=!1}t[9].isDrum=!0}handleUniversalRealTimeExclusiveMessage(e,t){switch(e[2]){case 4:if(e[3]===1)return this.handleMasterVolumeSysEx(e,t);console.warn(`Unsupported Exclusive Message: ${e}`);break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e,t){let n=(e[5]*128+e[4])/16383;this.setMasterVolume(n,t)}setMasterVolume(e,t){0<=t||(t=this.audioContext.currentTime),this.masterVolume.gain.cancelScheduledValues(t).setValueAtTime(e*e,t)}handleSysEx(e,t){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e,t);case 127:return this.handleUniversalRealTimeExclusiveMessage(e,t);default:console.warn(`Unsupported Exclusive Message: ${e}`)}}scheduleTask(e,t){return new Promise(n=>{let r=new AudioBufferSourceNode(this.audioContext,{buffer:this.schedulerBuffer});r.connect(this.scheduler),r.onended=()=>{try{e()}finally{r.disconnect(),n()}},r.start(t)})}};export{ke as MidyGM1};
