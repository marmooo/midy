var le=Object.create;var Q=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var he=Object.getOwnPropertyNames;var fe=Object.getPrototypeOf,pe=Object.prototype.hasOwnProperty;var H=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var me=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of he(e))!pe.call(r,s)&&s!==t&&Q(r,s,{get:()=>e[s],enumerable:!(n=de(e,s))||n.enumerable});return r};var ge=(r,e,t)=>(t=r!=null?le(fe(r)):{},me(e||!r||!r.__esModule?Q(t,"default",{value:r,enumerable:!0}):t,r));var X=H((Ge,J)=>{function be(r){var e=new y(r),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var n=ye(t.data),s=[],a=0;!e.eof()&&a<n.numTracks;a++){var i=e.readChunk();if(i.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+i.id+"'";var o=ve(i.data);s.push(o)}return{header:n,tracks:s}}function ye(r){var e=new y(r),t=e.readUInt16(),n=e.readUInt16(),s={format:t,numTracks:n},a=e.readUInt16();return a&32768?(s.framesPerSecond=256-(a>>8),s.ticksPerFrame=a&255):s.ticksPerBeat=a,s}function ve(r){for(var e=new y(r),t=[];!e.eof();){var n=a();t.push(n)}return t;var s;function a(){var i={};i.deltaTime=e.readVarInt();var o=e.readUInt8();if((o&240)===240)if(o===255){i.meta=!0;var u=e.readUInt8(),c=e.readVarInt();switch(u){case 0:if(i.type="sequenceNumber",c!==2)throw"Expected length for sequenceNumber event is 2, got "+c;return i.number=e.readUInt16(),i;case 1:return i.type="text",i.text=e.readString(c),i;case 2:return i.type="copyrightNotice",i.text=e.readString(c),i;case 3:return i.type="trackName",i.text=e.readString(c),i;case 4:return i.type="instrumentName",i.text=e.readString(c),i;case 5:return i.type="lyrics",i.text=e.readString(c),i;case 6:return i.type="marker",i.text=e.readString(c),i;case 7:return i.type="cuePoint",i.text=e.readString(c),i;case 32:if(i.type="channelPrefix",c!=1)throw"Expected length for channelPrefix event is 1, got "+c;return i.channel=e.readUInt8(),i;case 33:if(i.type="portPrefix",c!=1)throw"Expected length for portPrefix event is 1, got "+c;return i.port=e.readUInt8(),i;case 47:if(i.type="endOfTrack",c!=0)throw"Expected length for endOfTrack event is 0, got "+c;return i;case 81:if(i.type="setTempo",c!=3)throw"Expected length for setTempo event is 3, got "+c;return i.microsecondsPerBeat=e.readUInt24(),i;case 84:if(i.type="smpteOffset",c!=5)throw"Expected length for smpteOffset event is 5, got "+c;var h=e.readUInt8(),d={0:24,32:25,64:29,96:30};return i.frameRate=d[h&96],i.hour=h&31,i.min=e.readUInt8(),i.sec=e.readUInt8(),i.frame=e.readUInt8(),i.subFrame=e.readUInt8(),i;case 88:if(i.type="timeSignature",c!=2&&c!=4)throw"Expected length for timeSignature event is 4 or 2, got "+c;return i.numerator=e.readUInt8(),i.denominator=1<<e.readUInt8(),c===4?(i.metronome=e.readUInt8(),i.thirtyseconds=e.readUInt8()):(i.metronome=36,i.thirtyseconds=8),i;case 89:if(i.type="keySignature",c!=2)throw"Expected length for keySignature event is 2, got "+c;return i.key=e.readInt8(),i.scale=e.readUInt8(),i;case 127:return i.type="sequencerSpecific",i.data=e.readBytes(c),i;default:return i.type="unknownMeta",i.data=e.readBytes(c),i.metatypeByte=u,i}}else if(o==240){i.type="sysEx";var c=e.readVarInt();return i.data=e.readBytes(c),i}else if(o==247){i.type="endSysEx";var c=e.readVarInt();return i.data=e.readBytes(c),i}else throw"Unrecognised MIDI event type byte: "+o;else{var f;if((o&128)===0){if(s===null)throw"Running status byte encountered before status byte";f=o,o=s,i.running=!0}else f=e.readUInt8(),s=o;var p=o>>4;switch(i.channel=o&15,p){case 8:return i.type="noteOff",i.noteNumber=f,i.velocity=e.readUInt8(),i;case 9:var m=e.readUInt8();return i.type=m===0?"noteOff":"noteOn",i.noteNumber=f,i.velocity=m,m===0&&(i.byte9=!0),i;case 10:return i.type="noteAftertouch",i.noteNumber=f,i.amount=e.readUInt8(),i;case 11:return i.type="controller",i.controllerType=f,i.value=e.readUInt8(),i;case 12:return i.type="programChange",i.programNumber=f,i;case 13:return i.type="channelAftertouch",i.amount=f,i;case 14:return i.type="pitchBend",i.value=f+(e.readUInt8()<<7)-8192,i;default:throw"Unrecognised MIDI event type: "+p}}}}function y(r){this.buffer=r,this.bufferLen=this.buffer.length,this.pos=0}y.prototype.eof=function(){return this.pos>=this.bufferLen};y.prototype.readUInt8=function(){var r=this.buffer[this.pos];return this.pos+=1,r};y.prototype.readInt8=function(){var r=this.readUInt8();return r&128?r-256:r};y.prototype.readUInt16=function(){var r=this.readUInt8(),e=this.readUInt8();return(r<<8)+e};y.prototype.readInt16=function(){var r=this.readUInt16();return r&32768?r-65536:r};y.prototype.readUInt24=function(){var r=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(r<<16)+(e<<8)+t};y.prototype.readInt24=function(){var r=this.readUInt24();return r&8388608?r-16777216:r};y.prototype.readUInt32=function(){var r=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8();return(r<<24)+(e<<16)+(t<<8)+n};y.prototype.readBytes=function(r){var e=this.buffer.slice(this.pos,this.pos+r);return this.pos+=r,e};y.prototype.readString=function(r){var e=this.readBytes(r);return String.fromCharCode.apply(null,e)};y.prototype.readVarInt=function(){for(var r=0;!this.eof();){var e=this.readUInt8();if(e&128)r+=e&127,r<<=7;else return r+e}return r};y.prototype.readChunk=function(){var r=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:r,length:e,data:t}};J.exports=be});var _=H((He,Y)=>{function we(r,e){if(typeof r!="object")throw"Invalid MIDI data";e=e||{};var t=r.header||{},n=r.tracks||[],s,a=n.length,i=new b;for(xe(i,t,a),s=0;s<a;s++)Ie(i,n[s],e);return i.buffer}function xe(r,e,t){var n=e.format==null?1:e.format,s=128;e.timeDivision?s=e.timeDivision:e.ticksPerFrame&&e.framesPerSecond?s=-(e.framesPerSecond&255)<<8|e.ticksPerFrame&255:e.ticksPerBeat&&(s=e.ticksPerBeat&32767);var a=new b;a.writeUInt16(n),a.writeUInt16(t),a.writeUInt16(s),r.writeChunk("MThd",a.buffer)}function Ie(r,e,t){var n=new b,s,a=e.length,i=null;for(s=0;s<a;s++)(t.running===!1||!t.running&&!e[s].running)&&(i=null),i=Te(n,e[s],i,t.useByte9ForNoteOff);r.writeChunk("MTrk",n.buffer)}function Te(r,e,t,n){var s=e.type,a=e.deltaTime,i=e.text||"",o=e.data||[],u=null;switch(r.writeVarInt(a),s){case"sequenceNumber":r.writeUInt8(255),r.writeUInt8(0),r.writeVarInt(2),r.writeUInt16(e.number);break;case"text":r.writeUInt8(255),r.writeUInt8(1),r.writeVarInt(i.length),r.writeString(i);break;case"copyrightNotice":r.writeUInt8(255),r.writeUInt8(2),r.writeVarInt(i.length),r.writeString(i);break;case"trackName":r.writeUInt8(255),r.writeUInt8(3),r.writeVarInt(i.length),r.writeString(i);break;case"instrumentName":r.writeUInt8(255),r.writeUInt8(4),r.writeVarInt(i.length),r.writeString(i);break;case"lyrics":r.writeUInt8(255),r.writeUInt8(5),r.writeVarInt(i.length),r.writeString(i);break;case"marker":r.writeUInt8(255),r.writeUInt8(6),r.writeVarInt(i.length),r.writeString(i);break;case"cuePoint":r.writeUInt8(255),r.writeUInt8(7),r.writeVarInt(i.length),r.writeString(i);break;case"channelPrefix":r.writeUInt8(255),r.writeUInt8(32),r.writeVarInt(1),r.writeUInt8(e.channel);break;case"portPrefix":r.writeUInt8(255),r.writeUInt8(33),r.writeVarInt(1),r.writeUInt8(e.port);break;case"endOfTrack":r.writeUInt8(255),r.writeUInt8(47),r.writeVarInt(0);break;case"setTempo":r.writeUInt8(255),r.writeUInt8(81),r.writeVarInt(3),r.writeUInt24(e.microsecondsPerBeat);break;case"smpteOffset":r.writeUInt8(255),r.writeUInt8(84),r.writeVarInt(5);var c={24:0,25:32,29:64,30:96},h=e.hour&31|c[e.frameRate];r.writeUInt8(h),r.writeUInt8(e.min),r.writeUInt8(e.sec),r.writeUInt8(e.frame),r.writeUInt8(e.subFrame);break;case"timeSignature":r.writeUInt8(255),r.writeUInt8(88),r.writeVarInt(4),r.writeUInt8(e.numerator);var d=Math.floor(Math.log(e.denominator)/Math.LN2)&255;r.writeUInt8(d),r.writeUInt8(e.metronome),r.writeUInt8(e.thirtyseconds||8);break;case"keySignature":r.writeUInt8(255),r.writeUInt8(89),r.writeVarInt(2),r.writeInt8(e.key),r.writeUInt8(e.scale);break;case"sequencerSpecific":r.writeUInt8(255),r.writeUInt8(127),r.writeVarInt(o.length),r.writeBytes(o);break;case"unknownMeta":e.metatypeByte!=null&&(r.writeUInt8(255),r.writeUInt8(e.metatypeByte),r.writeVarInt(o.length),r.writeBytes(o));break;case"sysEx":r.writeUInt8(240),r.writeVarInt(o.length),r.writeBytes(o);break;case"endSysEx":r.writeUInt8(247),r.writeVarInt(o.length),r.writeBytes(o);break;case"noteOff":var f=n!==!1&&e.byte9||n&&e.velocity==0?144:128;u=f|e.channel,u!==t&&r.writeUInt8(u),r.writeUInt8(e.noteNumber),r.writeUInt8(e.velocity);break;case"noteOn":u=144|e.channel,u!==t&&r.writeUInt8(u),r.writeUInt8(e.noteNumber),r.writeUInt8(e.velocity);break;case"noteAftertouch":u=160|e.channel,u!==t&&r.writeUInt8(u),r.writeUInt8(e.noteNumber),r.writeUInt8(e.amount);break;case"controller":u=176|e.channel,u!==t&&r.writeUInt8(u),r.writeUInt8(e.controllerType),r.writeUInt8(e.value);break;case"programChange":u=192|e.channel,u!==t&&r.writeUInt8(u),r.writeUInt8(e.programNumber);break;case"channelAftertouch":u=208|e.channel,u!==t&&r.writeUInt8(u),r.writeUInt8(e.amount);break;case"pitchBend":u=224|e.channel,u!==t&&r.writeUInt8(u);var p=8192+e.value,m=p&127,T=p>>7&127;r.writeUInt8(m),r.writeUInt8(T);break;default:throw"Unrecognized event type: "+s}return u}function b(){this.buffer=[]}b.prototype.writeUInt8=function(r){this.buffer.push(r&255)};b.prototype.writeInt8=b.prototype.writeUInt8;b.prototype.writeUInt16=function(r){var e=r>>8&255,t=r&255;this.writeUInt8(e),this.writeUInt8(t)};b.prototype.writeInt16=b.prototype.writeUInt16;b.prototype.writeUInt24=function(r){var e=r>>16&255,t=r>>8&255,n=r&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n)};b.prototype.writeInt24=b.prototype.writeUInt24;b.prototype.writeUInt32=function(r){var e=r>>24&255,t=r>>16&255,n=r>>8&255,s=r&255;this.writeUInt8(e),this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(s)};b.prototype.writeInt32=b.prototype.writeUInt32;b.prototype.writeBytes=function(r){this.buffer=this.buffer.concat(Array.prototype.slice.call(r,0))};b.prototype.writeString=function(r){var e,t=r.length,n=[];for(e=0;e<t;e++)n.push(r.codePointAt(e));this.writeBytes(n)};b.prototype.writeVarInt=function(r){if(r<0)throw"Cannot write negative variable-length integer";if(r<=127)this.writeUInt8(r);else{var e=r,t=[];for(t.push(e&127),e>>=7;e;){var n=e&127|128;t.push(n),e>>=7}this.writeBytes(t.reverse())}};b.prototype.writeChunk=function(r,e){this.writeString(r),this.writeUInt32(e.length),this.writeBytes(e)};Y.exports=we});var ee=H(q=>{q.parseMidi=X();q.writeMidi=_()});var ce=ge(ee());var w=class{constructor(e,t){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:t})}readString(e){let t=this.offset,n=t+e,s=this.data;this.offset=n;let a=n;for(let u=t+1;u<n;u++)if(s[u]===0){a=u;break}let i=a-t,o=new Array(i);for(let u=0;u<i;u++)o[u]=s[t+u];return String.fromCharCode(...o)}readWORD(){return this.data[this.offset++]|this.data[this.offset++]<<8}readDWORD(e=!1){return e?(this.data[this.offset++]<<24|this.data[this.offset++]<<16|this.data[this.offset++]<<8|this.data[this.offset++])>>>0:(this.data[this.offset++]|this.data[this.offset++]<<8|this.data[this.offset++]<<16|this.data[this.offset++]<<24)>>>0}readByte(){return this.data[this.offset++]}readAt(e){return this.data[this.offset+e]}readUInt8(){return this.readByte()}readInt8(){return this.readByte()<<24>>24}readUInt16(){return this.readWORD()}readInt16(){return this.readWORD()<<16>>16}readUInt32(){return this.readDWORD()}};function $(r,e,t){let n=new w(r,e),s=n.readString(4),a=n.readDWORD(t);return new W(s,a,n.offset)}function z(r,e=0,t,{padding:n=!0,bigEndian:s=!1}={}){let a=[],i=t+e,o=e;for(;o<i;){let u=$(r,o,s);o=u.offset+u.size,n&&(o-e&1)===1&&o++,a.push(u)}return a}var W=class{constructor(e,t,n){Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:n})}};var P=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"];var K=class r{constructor(e,t){Object.defineProperty(this,"major",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"minor",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readInt8(),n=e.readInt8();return new r(t,n)}},D=class r{constructor(e,t,n,s,a,i,o,u,c,h,d){Object.defineProperty(this,"comment",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"copyright",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"creationDate",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"engineer",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"product",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"software",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"soundEngine",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"romName",{enumerable:!0,configurable:!0,writable:!0,value:h}),Object.defineProperty(this,"romVersion",{enumerable:!0,configurable:!0,writable:!0,value:d})}static parse(e,t){function n(x){for(let g=0;g<t.length;g++)if(t[g].type===x)return t[g]}function s(x){return new w(e,x.offset)}function a(x){let g=n(x);return g?s(g).readString(g.size):null}function i(x){let g=n(x);return g?K.parse(s(g)):null}let o=a("ICMT"),u=a("ICOP"),c=a("ICRD"),h=a("IENG"),d=a("INAM"),f=a("IPRD"),p=a("ISFT"),m=i("ifil"),T=a("isng"),F=a("irom"),G=i("iver");return new r(o,u,c,h,d,f,p,m,T,F,G)}},U=class r{constructor(e,t){Object.defineProperty(this,"generatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"modulatorIndex",{enumerable:!0,configurable:!0,writable:!0,value:t})}static parse(e){let t=e.readWORD(),n=e.readWORD();return new r(t,n)}},N=class r{constructor(e,t,n,s,a,i,o){Object.defineProperty(this,"presetName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"preset",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"bank",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"presetBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"library",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"genre",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"morphology",{enumerable:!0,configurable:!0,writable:!0,value:o})}get isEnd(){return this.presetName==="EOP"}static parse(e){let t=e.readString(20),n=e.readWORD(),s=e.readWORD(),a=e.readWORD(),i=e.readDWORD(),o=e.readDWORD(),u=e.readDWORD();return new r(t,n,s,a,i,o,u)}},S=class r{constructor(e,t){Object.defineProperty(this,"lo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lo=e,this.hi=t}in(e){return this.lo<=e&&e<=this.hi}static parse(e){let t=e.readByte(),n=e.readByte();return new r(t,n)}},R=class r{constructor(e,t,n,s,a){Object.defineProperty(this,"sourceOper",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"destinationOper",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"amountSourceOper",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"transOper",{enumerable:!0,configurable:!0,writable:!0,value:a})}static parse(e){let t=e.readWORD(),n=e.readWORD(),s=e.readInt16(),a=e.readWORD(),i=e.readWORD();return new r(t,n,s,a,i)}},E=class r{constructor(e,t){Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t})}get type(){return P[this.code]}get isEnd(){return this.code===0&&this.value===0}static parse(e){let t=e.readWORD(),n=P[t],s;switch(n){case"keyRange":case"velRange":s=S.parse(e);break;default:s=e.readInt16();break}return new r(t,s)}},C=class r{constructor(){Object.defineProperty(this,"instrumentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentBagIndex",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}get isEnd(){return this.instrumentName==="EOI"}static parse(e){let t=new r;return t.instrumentName=e.readString(20),t.instrumentBagIndex=e.readWORD(),t}},V=class r{constructor(e,t,n,s,a,i,o,u,c,h){Object.defineProperty(this,"sampleName",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"start",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"end",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"loopStart",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"loopEnd",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"sampleRate",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"originalPitch",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"pitchCorrection",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"sampleLink",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"sampleType",{enumerable:!0,configurable:!0,writable:!0,value:h})}get isEnd(){return this.sampleName==="EOS"}static parse(e,t){let n=e.readString(20),s=e.readDWORD(),a=e.readDWORD(),i=e.readDWORD(),o=e.readDWORD(),u=e.readDWORD(),c=e.readByte(),h=e.readInt8(),d=e.readWORD(),f=e.readWORD();return t||(i-=s,o-=s),new r(n,s,a,i,o,u,c,h,d,f)}};var l=class{constructor(e,t,n){Object.defineProperty(this,"min",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"max",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.min=e,this.value=t,this.max=n}clamp(){return Math.max(this.min,Math.min(this.value,this.max))}};function te(r,e={}){let t=z(r,0,r.length,e);if(t.length!==1)throw new Error("wrong chunk length");let n=t[0];if(n===null)throw new Error("chunk not found");function s(u,c,h={}){let d=A(u,c,"RIFF","sfbk",h);if(d.length!==3)throw new Error("invalid sfbk structure");let f=ke(d[0],c),p=f.version.major===3;return p&&d[2].type!=="LIST"&&(d[2]=$(c,d[2].offset-9,!1)),{info:f,samplingData:Se(d[1],c),...a(d[2],c,p)}}function a(u,c,h){let d=A(u,c,"LIST","pdta");if(d.length!==9)throw new Error("invalid pdta chunk");return{presetHeaders:Pe(d[0],c),presetZone:Oe(d[1],c),presetModulators:Ue(d[2],c),presetGenerators:Ee(d[3],c),instruments:Fe(d[4],c),instrumentZone:Me(d[5],c),instrumentModulators:Re(d[6],c),instrumentGenerators:Be(d[7],c),sampleHeaders:De(d[8],c,h)}}let i=s(n,r,e),o=i.info.version.major===3;return{...i,samples:Ne(i.sampleHeaders,i.samplingData.offsetMSB,i.samplingData.offsetLSB,r,o)}}function A(r,e,t,n,s={}){if(r.type!==t)throw new Error("invalid chunk type:"+r.type);let a=new w(e,r.offset),i=a.readString(4);if(i!==n)throw new Error("invalid signature:"+i);return z(e,a.offset,r.size-4,s)}function ke(r,e){let t=A(r,e,"LIST","INFO");return D.parse(e,t)}function Se(r,e){let t=A(r,e,"LIST","sdta");return{offsetMSB:t[0].offset,offsetLSB:t[1]?.offset}}function I(r,e,t,n,s,a){let i=[];if(r.type!==t)throw new Error("invalid chunk type:"+r.type);let o=new w(e,r.offset),u=r.offset+r.size;for(;o.offset<u;){let c=n.parse(o,a);if(s&&s(c))break;i.push(c)}return i}var Pe=(r,e)=>I(r,e,"phdr",N,t=>t.isEnd),Oe=(r,e)=>I(r,e,"pbag",U),Fe=(r,e)=>I(r,e,"inst",C,t=>t.isEnd),Me=(r,e)=>I(r,e,"ibag",U),Ue=(r,e)=>I(r,e,"pmod",R),Re=(r,e)=>I(r,e,"imod",R),Ee=(r,e)=>I(r,e,"pgen",E,t=>t.isEnd),Be=(r,e)=>I(r,e,"igen",E),De=(r,e,t)=>I(r,e,"shdr",V,n=>n.isEnd,t);function Ne(r,e,t,n,s){let a=new Array(r.length),i=s?1:2;for(let o=0;o<r.length;o++){let{start:u,end:c}=r[o],h=e+u*i,d=e+c*i;a[o]=n.subarray(h,d)}return a}var se=new Map;for(let r=0;r<P.length;r++)se.set(P[r],r);var Ce=["keyRange","velRange"],Ve=["keynum","velocity"],Ae=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","endAddrsCoarseOffset","startloopAddrsCoarseOffset","endloopAddrsCoarseOffset","sampleModes","exclusiveClass","overridingRootKey"],ne=[...Ae,...Ve],ie=new Set;for(let r=0;r<ne.length;r++){let e=ne[r],t=se.get(e);t!==void 0&&ie.add(t)}var re=[["keynum","keyRange"],["velocity","velRange"]],Le=new Set(Ce);function B(r){return Le.has(r)}function ae(r){let e={};for(let t=0;t<r.length;t++){let n=r[t],s=n.type;if(s!==void 0&&!ie.has(n.code))if(B(s))e[s]=n.value;else{let a=s,i=L[a];e[a]=new l(i.min,n.value,i.max)}}return e}function oe(r){let e={};for(let t=0;t<r.length;t++){let n=r[t],s=n.type;if(s!==void 0)if(B(s))e[s]=n.value;else{let a=s,i=L[a];e[a]=new l(i.min,n.value,i.max)}}for(let t=0;t<re.length;t++){let[n,s]=re[t],a=e[n];a instanceof l&&0<=a.value&&(e[s]=new S(a.value,a.value))}return e}var O=-32768,k=32767,L={startAddrsOffset:new l(0,0,k),endAddrsOffset:new l(O,0,0),startloopAddrsOffset:new l(O,0,k),endloopAddrsOffset:new l(O,0,k),startAddrsCoarseOffset:new l(0,0,k),modLfoToPitch:new l(-12e3,0,12e3),vibLfoToPitch:new l(-12e3,0,12e3),modEnvToPitch:new l(-12e3,0,12e3),initialFilterFc:new l(1500,13500,13500),initialFilterQ:new l(0,0,960),modLfoToFilterFc:new l(-12e3,0,12e3),modEnvToFilterFc:new l(-12e3,0,12e3),endAddrsCoarseOffset:new l(O,0,0),modLfoToVolume:new l(-960,0,960),chorusEffectsSend:new l(0,0,1e3),reverbEffectsSend:new l(0,0,1e3),pan:new l(-500,0,500),delayModLFO:new l(-12e3,-12e3,5e3),freqModLFO:new l(-16e3,0,4500),delayVibLFO:new l(-12e3,-12e3,5e3),freqVibLFO:new l(-16e3,0,4500),delayModEnv:new l(-12e3,-12e3,5e3),attackModEnv:new l(-12e3,-12e3,8e3),holdModEnv:new l(-12e3,-12e3,5e3),decayModEnv:new l(-12e3,-12e3,8e3),sustainModEnv:new l(0,0,1e3),releaseModEnv:new l(-12e3,-12e3,8e3),keynumToModEnvHold:new l(-1200,0,1200),keynumToModEnvDecay:new l(-1200,0,1200),delayVolEnv:new l(-12e3,-12e3,5e3),attackVolEnv:new l(-12e3,-12e3,8e3),holdVolEnv:new l(-12e3,-12e3,5e3),decayVolEnv:new l(-12e3,-12e3,8e3),sustainVolEnv:new l(0,0,1440),releaseVolEnv:new l(-12e3,-12e3,8e3),keynumToVolEnvHold:new l(-1200,0,1200),keynumToVolEnvDecay:new l(-1200,0,1200),instrument:new l(-1,-1,k),keyRange:new S(0,127),velRange:new S(0,127),startloopAddrsCoarseOffset:new l(O,0,k),keynum:new l(-1,-1,127),velocity:new l(-1,-1,127),initialAttenuation:new l(0,0,1440),endloopAddrsCoarseOffset:new l(O,0,k),coarseTune:new l(-120,0,120),fineTune:new l(-99,0,99),sampleID:new l(-1,-1,k),sampleModes:new l(0,0,3),scaleTuning:new l(0,100,100),exclusiveClass:new l(0,0,127),overridingRootKey:new l(-1,-1,127)};var j=class{constructor(e){Object.defineProperty(this,"parsed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.parsed=e}getGenerators(e,t,n,s){let a=new Array(s-n);for(let i=n;i<s;i++){let o=t[i].generatorIndex,u=t[i+1].generatorIndex;a[i-n]=e.slice(o,u)}return a}getPresetGenerators(e){let t=this.parsed.presetHeaders[e],n=this.parsed.presetHeaders[e+1],s=n?n.presetBagIndex:this.parsed.presetZone.length-1;return this.getGenerators(this.parsed.presetGenerators,this.parsed.presetZone,t.presetBagIndex,s)}getInstrumentGenerators(e){let t=this.parsed.instruments[e],n=this.parsed.instruments[e+1],s=n?n.instrumentBagIndex:this.parsed.instrumentZone.length-1;return this.getGenerators(this.parsed.instrumentGenerators,this.parsed.instrumentZone,t.instrumentBagIndex,s)}findInstrumentZone(e,t,n){let s=this.getInstrumentGenerators(e),a;for(let i=0;i<s.length;i++){let o=oe(s[i]);if(o.sampleID===void 0){a=o;continue}if(!(o.keyRange&&!o.keyRange.in(t))&&!(o.velRange&&!o.velRange.in(n)))return a?{...a,...o}:o}}findInstrument(e,t,n){let s=this.getPresetGenerators(e),a;for(let i=0;i<s.length;i++){let o=ae(s[i]);if(o.instrument===void 0){a=o;continue}if(o.keyRange&&!o.keyRange.in(t)||o.velRange&&!o.velRange.in(n))continue;let u=this.findInstrumentZone(o.instrument.value,t,n);if(u)return a?this.getInstrument({...a,...o},u):this.getInstrument(o,u)}return null}getInstrument(e,t){let n={...L,...t},s=Object.keys(e);for(let a=0;a<s.length;a++){let i=s[a];if(B(i))continue;let o=n[i],u=e[i];n[i]=new l(o.min,o.value+u.value,o.max)}return n}getInstrumentKey(e,t,n,s){let a=this.parsed.presetHeaders.findIndex(g=>g.preset===t&&g.bank===e);if(a<0)return console.warn("preset not found: bank=%s instrument=%s",e,t),null;let i=this.findInstrument(a,n,s);if(!i)return console.warn("instrument not found: bank=%s instrument=%s",e,t),null;let o={},u=Object.keys(i);for(let g=0;g<u.length;g++){let M=u[g];B(M)?o[M]=i[M]:o[M]=i[M].clamp()}let c=v(o.holdModEnv+(n-60)*o.keynumToModEnvHold),h=v(o.decayModEnv+(n-60)*o.keynumToModEnvDecay),d=v(o.holdVolEnv+(n-60)*o.keynumToVolEnvHold),f=v(o.decayVolEnv+(n-60)*o.keynumToVolEnvDecay),p=this.parsed.samples[o.sampleID],m=this.parsed.sampleHeaders[o.sampleID],T=o.coarseTune+o.fineTune/100,F=o.overridingRootKey===-1?m.originalPitch:o.overridingRootKey,G=T+m.pitchCorrection/100-F,x=o.scaleTuning/100;return{start:o.startAddrsCoarseOffset*32768+o.startAddrsOffset,end:o.endAddrsCoarseOffset*32768+o.endAddrsOffset,loopStart:m.loopStart+o.startloopAddrsCoarseOffset*32768+o.startloopAddrsOffset,loopEnd:m.loopEnd+o.endloopAddrsCoarseOffset*32768+o.endloopAddrsOffset,modLfoToPitch:o.modLfoToPitch,vibLfoToPitch:o.vibLfoToPitch,modEnvToPitch:o.modEnvToPitch,initialFilterFc:o.initialFilterFc,initialFilterQ:o.initialFilterQ,modLfoToFilterFc:o.modLfoToFilterFc,modEnvToFilterFc:o.modEnvToFilterFc,modLfoToVolume:o.modLfoToVolume,chorusEffectsSend:o.chorusEffectsSend/1e3,reverbEffectsSend:o.reverbEffectsSend/1e3,pan:o.pan,delayModLFO:v(o.delayModLFO),freqModLFO:o.freqModLFO,delayVibLFO:v(o.delayVibLFO),freqVibLFO:o.freqVibLFO,modDelay:v(o.delayModEnv),modAttack:v(o.attackModEnv),modHold:c,modDecay:h,modSustain:o.sustainModEnv/1e3,modRelease:v(o.releaseModEnv),volDelay:v(o.delayVolEnv),volAttack:v(o.attackVolEnv),volHold:d,volDecay:f,volSustain:o.sustainVolEnv/1e3,volRelease:v(o.releaseVolEnv),initialAttenuation:o.initialAttenuation,playbackRate:g=>Math.pow(Math.pow(2,1/12),(g+G)*x),sample:p,sampleRate:m.sampleRate,sampleName:m.sampleName,sampleModes:o.sampleModes,exclusiveClass:o.exclusiveClass}}getPresetNames(){let e={},t=this.parsed.presetHeaders;for(let n=0;n<t.length;n++){let s=t[n];e[s.bank]||(e[s.bank]={}),e[s.bank][s.preset]=s.presetName}return e}};function v(r){return Math.pow(2,r/1200)}var Z=class{bufferSource;filterNode;volumeNode;volumeDepth;modulationLFO;modulationDepth;vibratoLFO;vibratoDepth;constructor(e,t,n,s){this.noteNumber=e,this.velocity=t,this.startTime=n,this.instrumentKey=s}},ue=class{ticksPerBeat=120;totalTime=0;noteCheckInterval=.1;lookAhead=1;startDelay=.1;startTime=0;resumeTime=0;soundFonts=[];soundFontTable=this.initSoundFontTable();isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;timeline=[];instruments=[];notePromises=[];exclusiveClassMap=new Map;static channelSettings={volume:100/127,pan:64,bank:0,dataMSB:0,dataLSB:0,program:0,pitchBend:0,fineTuning:0,coarseTuning:0,modulationDepthRange:50};static effectSettings={expression:1,modulationDepth:0,sustainPedal:!1,rpnMSB:127,rpnLSB:127,pitchBendRange:2};constructor(e){this.audioContext=e,this.masterGain=new GainNode(e),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.masterGain.connect(e.destination),this.GM1SystemOn()}initSoundFontTable(){let e=new Array(128);for(let t=0;t<128;t++)e[t]=new Map;return e}addSoundFont(e){let t=this.soundFonts.length;this.soundFonts.push(e);let n=e.parsed.presetHeaders;for(let s=0;s<n.length;s++){let a=n[s];a.presetName.startsWith("\0")||this.soundFontTable[a.preset].set(a.bank,t)}}async loadSoundFont(e){let n=await(await fetch(e)).arrayBuffer(),s=te(new Uint8Array(n)),a=new j(s);this.addSoundFont(a)}async loadMIDI(e){let n=await(await fetch(e)).arrayBuffer(),s=(0,ce.parseMidi)(new Uint8Array(n));this.ticksPerBeat=s.header.ticksPerBeat;let a=this.extractMidiData(s);this.instruments=a.instruments,this.timeline=a.timeline,this.totalTime=this.calcTotalTime()}setChannelAudioNodes(e){let{gainLeft:t,gainRight:n}=this.panToGain(this.constructor.channelSettings.pan),s=new GainNode(e,{gain:t}),a=new GainNode(e,{gain:n}),i=new ChannelMergerNode(e,{numberOfInputs:2});return s.connect(i,0,0),a.connect(i,0,1),i.connect(this.masterGain),{gainL:s,gainR:a,merger:i}}createChannels(e){return Array.from({length:16},()=>({...this.constructor.channelSettings,...this.constructor.effectSettings,...this.setChannelAudioNodes(e),scheduledNotes:new Map}))}async createNoteBuffer(e,t){let n=e.start,s=e.sample.length+e.end;if(t){let a=e.sample,i=a.byteOffset+n,o=a.byteOffset+s,u=a.buffer.slice(i,o);return await this.audioContext.decodeAudioData(u)}else{let a=e.sample,i=a.byteOffset+n,o=a.byteOffset+s,u=a.buffer.slice(i,o),c=new AudioBuffer({numberOfChannels:1,length:a.length,sampleRate:e.sampleRate}),h=c.getChannelData(0),d=new Int16Array(u);for(let f=0;f<d.length;f++)h[f]=d[f]/32768;return c}}async createNoteBufferNode(e,t){let n=new AudioBufferSourceNode(this.audioContext),s=await this.createNoteBuffer(e,t);return n.buffer=s,n.loop=e.sampleModes%2!==0,n.loop&&(n.loopStart=e.loopStart/e.sampleRate,n.loopEnd=e.loopEnd/e.sampleRate),n}async scheduleTimelineEvents(e,t,n){for(;n<this.timeline.length;){let s=this.timeline[n];if(s.startTime>e+this.lookAhead)break;switch(s.type){case"noteOn":if(s.velocity!==0){await this.scheduleNoteOn(s.channel,s.noteNumber,s.velocity,s.startTime+this.startDelay-t);break}case"noteOff":{let a=this.scheduleNoteRelease(s.channel,s.noteNumber,s.velocity,s.startTime+this.startDelay-t);a&&this.notePromises.push(a);break}case"controller":this.handleControlChange(s.channel,s.controllerType,s.value);break;case"programChange":this.handleProgramChange(s.channel,s.programNumber);break;case"pitchBend":this.setPitchBend(s.channel,s.value);break;case"sysEx":this.handleSysEx(s.data)}n++}return n}getQueueIndex(e){for(let t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}playNotes(){return new Promise(e=>{this.isPlaying=!0,this.isPaused=!1,this.startTime=this.audioContext.currentTime;let t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime;this.notePromises=[];let s=async()=>{if(t>=this.timeline.length){await Promise.all(this.notePromises),this.notePromises=[],this.exclusiveClassMap.clear(),e();return}let a=this.audioContext.currentTime+n;if(t=await this.scheduleTimelineEvents(a,n,t),this.isPausing){await this.stopNotes(0,!0),this.notePromises=[],e(),this.isPausing=!1,this.isPaused=!0;return}else if(this.isStopping){await this.stopNotes(0,!0),this.exclusiveClassMap.clear(),this.notePromises=[],e(),this.isStopping=!1,this.isPaused=!1;return}else if(this.isSeeking)this.stopNotes(0,!0),this.exclusiveClassMap.clear(),this.startTime=this.audioContext.currentTime,t=this.getQueueIndex(this.resumeTime),n=this.resumeTime-this.startTime,this.isSeeking=!1,await s();else{let o=this.audioContext.currentTime+this.noteCheckInterval;await this.scheduleTask(()=>{},o),await s()}};s()})}ticksToSecond(e,t){return e*t/this.ticksPerBeat}secondToTicks(e,t){return e*this.ticksPerBeat/t}extractMidiData(e){let t=new Set,n=[],s=new Array(16);for(let c=0;c<s.length;c++)s[c]={programNumber:-1,bank:this.channels[c].bank};for(let c=0;c<e.tracks.length;c++){let h=e.tracks[c],d=0;for(let f=0;f<h.length;f++){let p=h[f];switch(d+=p.deltaTime,p.ticks=d,p.type){case"noteOn":{let m=s[p.channel];m.programNumber<0&&(t.add(`${m.bank}:0`),m.programNumber=0);break}case"programChange":{let m=s[p.channel];m.programNumber=p.programNumber,t.add(`${m.bankNumber}:${m.programNumber}`)}}delete p.deltaTime,n.push(p)}}let a={controller:0,sysEx:1};n.sort((c,h)=>c.ticks!==h.ticks?c.ticks-h.ticks:(a[c.type]||2)-(a[h.type]||2));let i=0,o=0,u=.5;for(let c=0;c<n.length;c++){let h=n[c],d=this.ticksToSecond(h.ticks-o,u);h.startTime=i+d,h.type==="setTempo"&&(i+=this.ticksToSecond(h.ticks-o,u),u=h.microsecondsPerBeat/1e6,o=h.ticks)}return{instruments:t,timeline:n}}async stopChannelNotes(e,t,n){let s=this.audioContext.currentTime,a=this.channels[e];a.scheduledNotes.forEach(i=>{for(let o=0;o<i.length;o++){let u=i[o];if(!u)continue;let c=this.scheduleNoteRelease(e,u.noteNumber,t,s,n);this.notePromises.push(c)}}),a.scheduledNotes.clear(),await Promise.all(this.notePromises)}stopNotes(e,t){for(let n=0;n<this.channels.length;n++)this.stopChannelNotes(n,e,t);return Promise.all(this.notePromises)}async start(){this.isPlaying||this.isPaused||(this.resumeTime=0,await this.playNotes(),this.isPlaying=!1)}stop(){this.isPlaying&&(this.isStopping=!0)}pause(){if(!this.isPlaying||this.isPaused)return;let e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}async resume(){this.isPaused&&(await this.playNotes(),this.isPlaying=!1)}seekTo(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}calcTotalTime(){let e=0;for(let t=0;t<this.timeline.length;t++){let n=this.timeline[t];e<n.startTime&&(e=n.startTime)}return e}currentTime(){let e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}getActiveNotes(e,t){let n=new Map;return e.scheduledNotes.forEach(s=>{let a=this.getActiveNote(s,t);a&&n.set(a.noteNumber,a)}),n}getActiveNote(e,t){for(let n=e.length-1;n>=0;n--){let s=e[n];if(!s)return;if(!(t<s.startTime))return s.ending?null:s}return e[0]}cbToRatio(e){return Math.pow(10,e/200)}centToHz(e){return 8.176*Math.pow(2,e/1200)}calcSemitoneOffset(e){let t=e.coarseTuning+e.fineTuning;return e.pitchBend*e.pitchBendRange+t}calcPlaybackRate(e,t,n){return e.playbackRate(t)*Math.pow(2,n/12)}setVolumeEnvelope(e){let{instrumentKey:t,startTime:n}=e,s=this.cbToRatio(-t.initialAttenuation),a=s*(1-t.volSustain),i=n+t.volDelay,o=i+t.volAttack,u=o+t.volHold,c=u+t.volDecay;e.volumeNode.gain.cancelScheduledValues(n).setValueAtTime(0,n).setValueAtTime(1e-6,i).exponentialRampToValueAtTime(s,o).setValueAtTime(s,u).linearRampToValueAtTime(a,c)}setPitch(e,t){let{instrumentKey:n,noteNumber:s,startTime:a}=e,i=n.modEnvToPitch/100;if(e.bufferSource.playbackRate.value=this.calcPlaybackRate(n,s,t),i===0)return;let o=e.bufferSource.playbackRate.value,u=this.calcPlaybackRate(n,s,t+i),c=a+n.modDelay,h=c+n.modAttack,d=h+n.modHold,f=d+n.modDecay;e.bufferSource.playbackRate.value.setValueAtTime(o,c).exponentialRampToValueAtTime(u,h).setValueAtTime(u,d).linearRampToValueAtTime(o,f)}clampCutoffFrequency(e){return Math.max(20,Math.min(e,2e4))}setFilterEnvelope(e){let{instrumentKey:t,startTime:n}=e,s=this.centToHz(t.initialFilterFc),a=this.centToHz(t.initialFilterFc+t.modEnvToFilterFc),i=s+(a-s)*(1-t.modSustain),o=this.clampCutoffFrequency(s),u=this.clampCutoffFrequency(a),c=this.clampCutoffFrequency(i),h=n+t.modDelay,d=h+t.modAttack,f=d+t.modHold,p=f+t.modDecay;e.filterNode.frequency.cancelScheduledValues(n).setValueAtTime(o,n).setValueAtTime(o,h).exponentialRampToValueAtTime(u,d).setValueAtTime(u,f).linearRampToValueAtTime(c,p)}startModulation(e,t,n){let{instrumentKey:s}=t,{modLfoToPitch:a,modLfoToVolume:i}=s;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(s.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:s.modLfoToFilterFc});let o=Math.abs(a)+e.modulationDepth,u=0<a?1:-1;t.modulationDepth=new GainNode(this.audioContext,{gain:o*u});let c=this.cbToRatio(Math.abs(i))-1,h=0<i?1:-1;t.volumeDepth=new GainNode(this.audioContext,{gain:c*h}),t.modulationLFO.start(n+s.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeNode.gain)}async createNote(e,t,n,s,a,i){let o=this.calcSemitoneOffset(e),u=new Z(n,s,a,t);return u.bufferSource=await this.createNoteBufferNode(t,i),u.volumeNode=new GainNode(this.audioContext),u.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:t.initialFilterQ/10}),this.setVolumeEnvelope(u),this.setFilterEnvelope(u),0<e.modulationDepth?(this.setPitch(u,o),this.startModulation(e,u,a)):u.bufferSource.playbackRate.value=this.calcPlaybackRate(t,n,o),u.bufferSource.connect(u.filterNode),u.filterNode.connect(u.volumeNode),u.bufferSource.start(a),u}async scheduleNoteOn(e,t,n,s){let a=this.channels[e],i=0,o=this.soundFontTable[a.program].get(i);if(o===void 0)return;let u=this.soundFonts[o],c=u.parsed.info.version.major===3,h=u.getInstrumentKey(i,a.program,t,n);if(!h)return;let d=await this.createNote(a,h,t,n,s,c);d.volumeNode.connect(a.gainL),d.volumeNode.connect(a.gainR);let f=h.exclusiveClass;if(f!==0){if(this.exclusiveClassMap.has(f)){let m=this.exclusiveClassMap.get(f),[T,F]=m;T.ending||this.scheduleNoteRelease(F,T.noteNumber,0,s,void 0,!0)}this.exclusiveClassMap.set(f,[d,e])}let p=a.scheduledNotes;p.has(t)?p.get(t).push(d):p.set(t,[d])}noteOn(e,t,n){let s=this.audioContext.currentTime;return this.scheduleNoteOn(e,t,n,s)}stopNote(e,t,n,s){let a=n[s];return a.volumeNode.gain.cancelScheduledValues(e).linearRampToValueAtTime(0,t),a.ending=!0,this.scheduleTask(()=>{a.bufferSource.loop=!1},t),new Promise(i=>{a.bufferSource.onended=()=>{n[s]=null,a.bufferSource.disconnect(),a.volumeNode.disconnect(),a.filterNode.disconnect(),a.modulationDepth&&(a.volumeDepth.disconnect(),a.modulationDepth.disconnect(),a.modulationLFO.stop()),a.vibratoDepth&&(a.vibratoDepth.disconnect(),a.vibratoLFO.stop()),i()},a.bufferSource.stop(t)})}scheduleNoteRelease(e,t,n,s,a){let i=this.channels[e];if(!a&&i.sustainPedal||!i.scheduledNotes.has(t))return;let o=i.scheduledNotes.get(t);for(let u=0;u<o.length;u++){let c=o[u];if(!c||c.ending)continue;let h=s+c.instrumentKey.volRelease,d=s+c.instrumentKey.modRelease;c.filterNode.frequency.cancelScheduledValues(s).linearRampToValueAtTime(0,d);let f=Math.min(h,d);return this.stopNote(s,f,o,u)}}releaseNote(e,t,n){let s=this.audioContext.currentTime;return this.scheduleNoteRelease(e,t,n,s)}releaseSustainPedal(e,t){let n=t*2,s=this.channels[e],a=[];return s.sustainPedal=!1,s.scheduledNotes.forEach(i=>{for(let o=0;o<i.length;o++){let u=i[o];if(!u)continue;let{noteNumber:c}=u,h=this.releaseNote(e,c,n);a.push(h)}}),a}handleMIDIMessage(e,t,n){let s=e&15,a=e&240;switch(a){case 128:return this.releaseNote(s,t,n);case 144:return this.noteOn(s,t,n);case 176:return this.handleControlChange(s,t,n);case 192:return this.handleProgramChange(s,t);case 224:return this.handlePitchBendMessage(s,t,n);default:console.warn(`Unsupported MIDI message: ${a.toString(16)}`)}}handleProgramChange(e,t){let n=this.channels[e];n.program=t}handlePitchBendMessage(e,t,n){let s=n*128+t-8192;this.setPitchBend(e,s)}setPitchBend(e,t){let n=this.channels[e],s=n.pitchBend;n.pitchBend=t/8192;let a=(n.pitchBend-s)*n.pitchBendRange*100;this.updateDetune(n,a)}createControlChangeHandlers(){return{1:this.setModulationDepth,6:this.dataEntryMSB,7:this.setVolume,10:this.setPan,11:this.setExpression,38:this.dataEntryLSB,64:this.setSustainPedal,100:this.setRPNLSB,101:this.setRPNMSB,120:this.allSoundOff,121:this.resetAllControllers,123:this.allNotesOff}}handleControlChange(e,t,n){let s=this.controlChangeHandlers[t];s?s.call(this,e,n):console.warn(`Unsupported Control change: controller=${t} value=${n}`)}updateModulation(e){let t=this.audioContext.currentTime;e.scheduledNotes.forEach(n=>{for(let s=0;s<n.length;s++){let a=n[s];if(a)if(a.modulationDepth)a.modulationDepth.gain.setValueAtTime(e.modulationDepth,t);else{let i=this.calcSemitoneOffset(e);this.setPitch(a,i),this.startModulation(e,a,t)}}})}setModulationDepth(e,t){let n=this.channels[e];n.modulationDepth=t/127*n.modulationDepthRange,this.updateModulation(n)}setVolume(e,t){let n=this.channels[e];n.volume=t/127,this.updateChannelVolume(n)}panToGain(e){let t=Math.PI/2*Math.max(0,e-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}setPan(e,t){let n=this.channels[e];n.pan=t,this.updateChannelVolume(n)}setExpression(e,t){let n=this.channels[e];n.expression=t/127,this.updateChannelVolume(n)}dataEntryLSB(e,t){this.channels[e].dataLSB=t,this.handleRPN(e,0)}updateChannelVolume(e){let t=this.audioContext.currentTime,n=e.volume*e.expression,{gainLeft:s,gainRight:a}=this.panToGain(e.pan);e.gainL.gain.cancelScheduledValues(t).setValueAtTime(n*s,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(n*a,t)}setSustainPedal(e,t){let n=t>=64;this.channels[e].sustainPedal=n,n||this.releaseSustainPedal(e,t)}limitData(e,t,n,s,a){a<e.dataLSB?(e.dataMSB++,e.dataLSB=s):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=a),n<e.dataMSB?(e.dataMSB=n,e.dataLSB=a):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=s)}limitDataMSB(e,t,n){n<e.dataMSB?e.dataMSB=n:e.dataMSB<0&&(e.dataMSB=t)}handleRPN(e){let t=this.channels[e];switch(t.rpnMSB*128+t.rpnLSB){case 0:this.handlePitchBendRangeRPN(e);break;case 1:this.handleFineTuningRPN(e);break;case 2:this.handleCoarseTuningRPN(e);break;default:console.warn(`Channel ${e}: Unsupported RPN MSB=${t.rpnMSB} LSB=${t.rpnLSB}`)}}setRPNMSB(e,t){this.channels[e].rpnMSB=t}setRPNLSB(e,t){this.channels[e].rpnLSB=t}dataEntryMSB(e,t){this.channels[e].dataMSB=t,this.handleRPN(e)}updateDetune(e,t){let n=this.audioContext.currentTime;e.scheduledNotes.forEach(s=>{for(let a=0;a<s.length;a++){let i=s[a];if(!i)continue;let{bufferSource:o}=i,u=o.detune.value+t;o.detune.cancelScheduledValues(n).setValueAtTime(u,n)}})}handlePitchBendRangeRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,99);let n=t.dataMSB+t.dataLSB/100;this.setPitchBendRange(e,n)}setPitchBendRange(e,t){let n=this.channels[e],s=n.pitchBendRange;n.pitchBendRange=t;let a=(n.pitchBendRange-s)*n.pitchBend*100;this.updateDetune(n,a)}handleFineTuningRPN(e){let t=this.channels[e];this.limitData(t,0,127,0,127);let n=(t.dataMSB*128+t.dataLSB-8192)/8192;this.setFineTuning(e,n)}setFineTuning(e,t){let n=this.channels[e],s=n.fineTuning;n.fineTuning=t;let a=n.fineTuning-s;this.updateDetune(n,a)}handleCoarseTuningRPN(e){let t=this.channels[e];this.limitDataMSB(t,0,127);let n=t.dataMSB-64;this.setFineTuning(e,n)}setCoarseTuning(e,t){let n=this.channels[e],s=n.coarseTuning;n.coarseTuning=t;let a=n.coarseTuning-s;this.updateDetune(n,a)}allSoundOff(e){return this.stopChannelNotes(e,0,!0)}resetAllControllers(e){Object.assign(this.channels[e],this.effectSettings)}allNotesOff(e){return this.stopChannelNotes(e,0,!1)}handleUniversalNonRealTimeExclusiveMessage(e){switch(e[2]){case 9:switch(e[3]){case 1:this.GM1SystemOn();break;case 2:break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}GM1SystemOn(){for(let e=0;e<this.channels.length;e++){let t=this.channels[e];t.bankMSB=0,t.bankLSB=0,t.bank=0}this.channels[9].bankMSB=1,this.channels[9].bank=128}handleUniversalRealTimeExclusiveMessage(e){switch(e[2]){case 4:switch(e[3]){case 1:return this.handleMasterVolumeSysEx(e);default:console.warn(`Unsupported Exclusive Message: ${e}`)}break;default:console.warn(`Unsupported Exclusive Message: ${e}`)}}handleMasterVolumeSysEx(e){let t=(e[5]*128+e[4])/16383;this.setMasterVolume(t)}setMasterVolume(e){if(e<0&&1<e)console.error("Master Volume is out of range");else{let t=this.audioContext.currentTime;this.masterGain.gain.cancelScheduledValues(t),this.masterGain.gain.setValueAtTime(e*e,t)}}handleExclusiveMessage(e){console.warn(`Unsupported Exclusive Message: ${e}`)}handleSysEx(e){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e);case 127:return this.handleUniversalRealTimeExclusiveMessage(e);default:return this.handleExclusiveMessage(e)}}scheduleTask(e,t){return new Promise(n=>{let s=new AudioBufferSourceNode(this.audioContext);s.onended=()=>{e(),n()},s.start(t),s.stop(t)})}};export{ue as MidyGM1};
