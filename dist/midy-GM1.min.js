function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}function t(e,t,n,a,i,s,r){try{var o=e[s](r),u=o.value}catch(e){n(e);return}o.done?t(u):Promise.resolve(u).then(a,i)}function n(e){return function(){var n=this,a=arguments;return new Promise(function(i,s){var r=e.apply(n,a);function o(e){t(r,i,s,o,u,"next",e)}function u(e){t(r,i,s,o,u,"throw",e)}o(void 0)})}}function a(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n,a,i,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},r=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return r.next=o(0),r.throw=o(1),r.return=o(2),"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function o(o){return function(u){var l=[o,u];if(n)throw TypeError("Generator is already executing.");for(;r&&(r=0,l[0]&&(s=0)),s;)try{if(n=1,a&&(i=2&l[0]?a.return:l[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,l[1])).done)return i;switch(a=0,i&&(l=[2&l[0],i.value]),l[0]){case 0:case 1:i=l;break;case 4:return s.label++,{value:l[1],done:!1};case 5:s.label++,a=l[1],l=[0];continue;case 7:l=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===l[0]||2===l[0])){s=0;continue}if(3===l[0]&&(!i||l[1]>i[0]&&l[1]<i[3])){s.label=l[1];break}if(6===l[0]&&s.label<i[1]){s.label=i[1],i=l;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(l);break}i[2]&&s.ops.pop(),s.trys.pop();continue}l=t.call(e,s)}catch(e){l=[6,e],a=0}finally{n=i=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}}import{parseMidi as r}from"midi-file";import{parse as o,SoundFont as u}from"@marmooo/soundfont-parser";var l=function e(t,n,s,r){"use strict";a(this,e),i(this,"bufferSource",void 0),i(this,"filterNode",void 0),i(this,"volumeNode",void 0),i(this,"volumeDepth",void 0),i(this,"modulationLFO",void 0),i(this,"modulationDepth",void 0),i(this,"vibratoLFO",void 0),i(this,"vibratoDepth",void 0),this.noteNumber=t,this.velocity=n,this.startTime=s,this.instrumentKey=r};export var MidyGM1=function(){"use strict";var t;function c(e){a(this,c),i(this,"ticksPerBeat",120),i(this,"totalTime",0),i(this,"noteCheckInterval",.1),i(this,"lookAhead",1),i(this,"startDelay",.1),i(this,"startTime",0),i(this,"resumeTime",0),i(this,"soundFonts",[]),i(this,"soundFontTable",this.initSoundFontTable()),i(this,"isPlaying",!1),i(this,"isPausing",!1),i(this,"isPaused",!1),i(this,"isStopping",!1),i(this,"isSeeking",!1),i(this,"timeline",[]),i(this,"instruments",[]),i(this,"notePromises",[]),i(this,"exclusiveClassMap",new Map),this.audioContext=e,this.masterGain=new GainNode(e),this.controlChangeHandlers=this.createControlChangeHandlers(),this.channels=this.createChannels(e),this.masterGain.connect(e.destination),this.GM1SystemOn()}return t=[{key:"initSoundFontTable",value:function(){for(var e=Array(128),t=0;t<128;t++)e[t]=new Map;return e}},{key:"addSoundFont",value:function(e){var t=this.soundFonts.length;this.soundFonts.push(e);for(var n=e.parsed.presetHeaders,a=0;a<n.length;a++){var i=n[a];i.presetName.startsWith("\0")||this.soundFontTable[i.preset].set(i.bank,t)}}},{key:"loadSoundFont",value:function(e){return n(function(){var t;return s(this,function(n){switch(n.label){case 0:return[4,fetch(e)];case 1:return[4,n.sent().arrayBuffer()];case 2:return t=new u(o(new Uint8Array(n.sent()))),this.addSoundFont(t),[2]}})}).call(this)}},{key:"loadMIDI",value:function(e){return n(function(){var t,n;return s(this,function(a){switch(a.label){case 0:return[4,fetch(e)];case 1:return[4,a.sent().arrayBuffer()];case 2:return t=r(new Uint8Array(a.sent())),this.ticksPerBeat=t.header.ticksPerBeat,n=this.extractMidiData(t),this.instruments=n.instruments,this.timeline=n.timeline,this.totalTime=this.calcTotalTime(),[2]}})}).call(this)}},{key:"setChannelAudioNodes",value:function(e){var t=this.panToGain(this.constructor.channelSettings.pan),n=t.gainLeft,a=t.gainRight,i=new GainNode(e,{gain:n}),s=new GainNode(e,{gain:a}),r=new ChannelMergerNode(e,{numberOfInputs:2});return i.connect(r,0,0),s.connect(r,0,1),r.connect(this.masterGain),{gainL:i,gainR:s,merger:r}}},{key:"createChannels",value:function(e){var t=this;return Array.from({length:16},function(){var n,a;return n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),a.forEach(function(t){i(e,t,n[t])})}return e}({},t.constructor.channelSettings,t.constructor.effectSettings,t.setChannelAudioNodes(e)),a=a={scheduledNotes:new Map},Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n.push.apply(n,a)}return n})(Object(a)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(a,e))}),n})}},{key:"createNoteBuffer",value:function(e,t){return n(function(){var n,a,i,r,o,u,l,c,h,d,f,m,v,p;return s(this,function(s){switch(s.label){case 0:if(n=e.start,a=e.sample.length+e.end,!t)return[3,2];return r=(i=e.sample).byteOffset+n,o=i.byteOffset+a,u=i.buffer.slice(r,o),[4,this.audioContext.decodeAudioData(u)];case 1:return[2,s.sent()];case 2:for(p=0,c=(l=e.sample).byteOffset+n,h=l.byteOffset+a,d=l.buffer.slice(c,h),m=(f=new AudioBuffer({numberOfChannels:1,length:l.length,sampleRate:e.sampleRate})).getChannelData(0),v=new Int16Array(d);p<v.length;p++)m[p]=v[p]/32768;return[2,f];case 3:return[2]}})}).call(this)}},{key:"createNoteBufferNode",value:function(e,t){return n(function(){var n,a;return s(this,function(i){switch(i.label){case 0:return n=new AudioBufferSourceNode(this.audioContext),[4,this.createNoteBuffer(e,t)];case 1:return a=i.sent(),n.buffer=a,n.loop=e.sampleModes%2!=0,n.loop&&(n.loopStart=e.loopStart/e.sampleRate,n.loopEnd=e.loopEnd/e.sampleRate),[2,n]}})}).call(this)}},{key:"scheduleTimelineEvents",value:function(e,t,a){return n(function(){var n,i;return s(this,function(s){switch(s.label){case 0:if(!(a<this.timeline.length)||(n=this.timeline[a]).startTime>e+this.lookAhead)return[3,9];switch(n.type){case"noteOn":return[3,1];case"noteOff":return[3,3];case"controller":return[3,4];case"programChange":return[3,5];case"pitchBend":return[3,6];case"sysEx":return[3,7]}return[3,8];case 1:if(0===n.velocity)return[3,3];return[4,this.scheduleNoteOn(n.channel,n.noteNumber,n.velocity,n.startTime+this.startDelay-t)];case 2:return s.sent(),[3,8];case 3:return(i=this.scheduleNoteRelease(n.channel,n.noteNumber,n.velocity,n.startTime+this.startDelay-t))&&this.notePromises.push(i),[3,8];case 4:return this.handleControlChange(n.channel,n.controllerType,n.value),[3,8];case 5:return this.handleProgramChange(n.channel,n.programNumber),[3,8];case 6:return this.setPitchBend(n.channel,n.value),[3,8];case 7:this.handleSysEx(n.data),s.label=8;case 8:return a++,[3,0];case 9:return[2,a]}})}).call(this)}},{key:"getQueueIndex",value:function(e){for(var t=0;t<this.timeline.length;t++)if(e<=this.timeline[t].startTime)return t;return 0}},{key:"playNotes",value:function(){var e=this;return new Promise(function(t){e.isPlaying=!0,e.isPaused=!1,e.startTime=e.audioContext.currentTime;var a=e.getQueueIndex(e.resumeTime),i=e.resumeTime-e.startTime;e.notePromises=[];var r=function(){return n(function(){var e,n;return s(this,function(s){switch(s.label){case 0:if(!(a>=this.timeline.length))return[3,2];return[4,Promise.all(this.notePromises)];case 1:return s.sent(),this.notePromises=[],this.exclusiveClassMap.clear(),t(),[2];case 2:return e=this.audioContext.currentTime+i,[4,this.scheduleTimelineEvents(e,i,a)];case 3:if(a=s.sent(),!this.isPausing)return[3,5];return[4,this.stopNotes(0,!0)];case 4:return s.sent(),this.notePromises=[],t(),this.isPausing=!1,this.isPaused=!0,[2];case 5:if(!this.isStopping)return[3,7];return[4,this.stopNotes(0,!0)];case 6:return s.sent(),this.exclusiveClassMap.clear(),this.notePromises=[],t(),this.isStopping=!1,this.isPaused=!1,[2];case 7:if(!this.isSeeking)return[3,9];return this.stopNotes(0,!0),this.exclusiveClassMap.clear(),this.startTime=this.audioContext.currentTime,a=this.getQueueIndex(this.resumeTime),i=this.resumeTime-this.startTime,this.isSeeking=!1,[4,r()];case 8:return s.sent(),[3,12];case 9:return n=this.audioContext.currentTime+this.noteCheckInterval,[4,this.scheduleTask(function(){},n)];case 10:return s.sent(),[4,r()];case 11:s.sent(),s.label=12;case 12:return[2]}})}).call(e)};r()})}},{key:"ticksToSecond",value:function(e,t){return e*t/this.ticksPerBeat}},{key:"secondToTicks",value:function(e,t){return e*this.ticksPerBeat/t}},{key:"extractMidiData",value:function(e){for(var t=new Set,n=[],a=Array(16),i=0;i<a.length;i++)a[i]={programNumber:-1,bank:this.channels[i].bank};for(var s=0;s<e.tracks.length;s++)for(var r=e.tracks[s],o=0,u=0;u<r.length;u++){var l=r[u];switch(o+=l.deltaTime,l.ticks=o,l.type){case"noteOn":var c=a[l.channel];c.programNumber<0&&(t.add("".concat(c.bank,":0")),c.programNumber=0);break;case"programChange":var h=a[l.channel];h.programNumber=l.programNumber,t.add("".concat(h.bankNumber,":").concat(h.programNumber))}delete l.deltaTime,n.push(l)}var d={controller:0,sysEx:1};n.sort(function(e,t){return e.ticks!==t.ticks?e.ticks-t.ticks:(d[e.type]||2)-(d[t.type]||2)});for(var f=0,m=0,v=.5,p=0;p<n.length;p++){var y=n[p],g=this.ticksToSecond(y.ticks-m,v);y.startTime=f+g,"setTempo"===y.type&&(f+=this.ticksToSecond(y.ticks-m,v),v=y.microsecondsPerBeat/1e6,m=y.ticks)}return{instruments:t,timeline:n}}},{key:"stopChannelNotes",value:function(e,t,a){return n(function(){var n,i,r;return s(this,function(s){switch(s.label){case 0:return n=this,i=this.audioContext.currentTime,(r=this.channels[e]).scheduledNotes.forEach(function(s){for(var r=0;r<s.length;r++){var o=s[r];if(o){var u=n.scheduleNoteRelease(e,o.noteNumber,t,i,a);n.notePromises.push(u)}}}),r.scheduledNotes.clear(),[4,Promise.all(this.notePromises)];case 1:return s.sent(),[2]}})}).call(this)}},{key:"stopNotes",value:function(e,t){for(var n=0;n<this.channels.length;n++)this.stopChannelNotes(n,e,t);return Promise.all(this.notePromises)}},{key:"start",value:function(){return n(function(){return s(this,function(e){switch(e.label){case 0:if(this.isPlaying||this.isPaused)return[2];return this.resumeTime=0,[4,this.playNotes()];case 1:return e.sent(),this.isPlaying=!1,[2]}})}).call(this)}},{key:"stop",value:function(){this.isPlaying&&(this.isStopping=!0)}},{key:"pause",value:function(){if(this.isPlaying&&!this.isPaused){var e=this.audioContext.currentTime;this.resumeTime+=e-this.startTime-this.startDelay,this.isPausing=!0}}},{key:"resume",value:function(){return n(function(){return s(this,function(e){switch(e.label){case 0:if(!this.isPaused)return[2];return[4,this.playNotes()];case 1:return e.sent(),this.isPlaying=!1,[2]}})}).call(this)}},{key:"seekTo",value:function(e){this.resumeTime=e,this.isPlaying&&(this.isSeeking=!0)}},{key:"calcTotalTime",value:function(){for(var e=0,t=0;t<this.timeline.length;t++){var n=this.timeline[t];e<n.startTime&&(e=n.startTime)}return e}},{key:"currentTime",value:function(){var e=this.audioContext.currentTime;return this.resumeTime+e-this.startTime-this.startDelay}},{key:"getActiveNotes",value:function(e,t){var n=this,a=new Map;return e.scheduledNotes.forEach(function(e){var i=n.getActiveNote(e,t);i&&a.set(i.noteNumber,i)}),a}},{key:"getActiveNote",value:function(e,t){for(var n=e.length-1;n>=0;n--){var a=e[n];if(!a)return;if(!(t<a.startTime))return a.ending?null:a}return e[0]}},{key:"cbToRatio",value:function(e){return Math.pow(10,e/200)}},{key:"centToHz",value:function(e){return 8.176*Math.pow(2,e/1200)}},{key:"calcSemitoneOffset",value:function(e){var t=e.coarseTuning+e.fineTuning;return e.pitchBend*e.pitchBendRange+t}},{key:"calcPlaybackRate",value:function(e,t,n){return e.playbackRate(t)*Math.pow(2,n/12)}},{key:"setVolumeEnvelope",value:function(e){var t=e.instrumentKey,n=e.startTime,a=this.cbToRatio(-t.initialAttenuation),i=a*(1-t.volSustain),s=n+t.volDelay,r=s+t.volAttack,o=r+t.volHold,u=o+t.volDecay;e.volumeNode.gain.cancelScheduledValues(n).setValueAtTime(0,n).setValueAtTime(1e-6,s).exponentialRampToValueAtTime(a,r).setValueAtTime(a,o).linearRampToValueAtTime(i,u)}},{key:"setPitch",value:function(e,t){var n=e.instrumentKey,a=e.noteNumber,i=e.startTime,s=n.modEnvToPitch/100;if(e.bufferSource.playbackRate.value=this.calcPlaybackRate(n,a,t),0!==s){var r=e.bufferSource.playbackRate.value,o=this.calcPlaybackRate(n,a,t+s),u=i+n.modDelay,l=u+n.modAttack,c=l+n.modHold,h=c+n.modDecay;e.bufferSource.playbackRate.value.setValueAtTime(r,u).exponentialRampToValueAtTime(o,l).setValueAtTime(o,c).linearRampToValueAtTime(r,h)}}},{key:"clampCutoffFrequency",value:function(e){return Math.max(20,Math.min(e,2e4))}},{key:"setFilterEnvelope",value:function(e){var t=e.instrumentKey,n=e.startTime,a=this.centToHz(t.initialFilterFc),i=this.centToHz(t.initialFilterFc+t.modEnvToFilterFc),s=a+(i-a)*(1-t.modSustain),r=this.clampCutoffFrequency(a),o=this.clampCutoffFrequency(i),u=this.clampCutoffFrequency(s),l=n+t.modDelay,c=l+t.modAttack,h=c+t.modHold,d=h+t.modDecay;e.filterNode.frequency.cancelScheduledValues(n).setValueAtTime(r,n).setValueAtTime(r,l).exponentialRampToValueAtTime(o,c).setValueAtTime(o,h).linearRampToValueAtTime(u,d)}},{key:"startModulation",value:function(e,t,n){var a=t.instrumentKey,i=a.modLfoToPitch,s=a.modLfoToVolume;t.modulationLFO=new OscillatorNode(this.audioContext,{frequency:this.centToHz(a.freqModLFO)}),t.filterDepth=new GainNode(this.audioContext,{gain:a.modLfoToFilterFc});var r=Math.abs(i)+e.modulationDepth;t.modulationDepth=new GainNode(this.audioContext,{gain:r*(0<i?1:-1)});var o=this.cbToRatio(Math.abs(s))-1;t.volumeDepth=new GainNode(this.audioContext,{gain:o*(0<s?1:-1)}),t.modulationLFO.start(n+a.delayModLFO),t.modulationLFO.connect(t.filterDepth),t.filterDepth.connect(t.filterNode.frequency),t.modulationLFO.connect(t.modulationDepth),t.modulationDepth.connect(t.bufferSource.detune),t.modulationLFO.connect(t.volumeDepth),t.volumeDepth.connect(t.volumeNode.gain)}},{key:"createNote",value:function(e,t,a,i,r,o){return n(function(){var n,u;return s(this,function(s){switch(s.label){case 0:return n=this.calcSemitoneOffset(e),u=new l(a,i,r,t),[4,this.createNoteBufferNode(t,o)];case 1:return u.bufferSource=s.sent(),u.volumeNode=new GainNode(this.audioContext),u.filterNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:t.initialFilterQ/10}),this.setVolumeEnvelope(u),this.setFilterEnvelope(u),0<e.modulationDepth?(this.setPitch(u,n),this.startModulation(e,u,r)):u.bufferSource.playbackRate.value=this.calcPlaybackRate(t,a,n),u.bufferSource.connect(u.filterNode),u.filterNode.connect(u.volumeNode),u.bufferSource.start(r),[2,u]}})}).call(this)}},{key:"scheduleNoteOn",value:function(t,a,i,r){return n(function(){var n,o,u,l,c,h,d,f,m,v,p;return s(this,function(s){switch(s.label){case 0:if(n=this.channels[t],void 0===(o=this.soundFontTable[n.program].get(0))||(l=3===(u=this.soundFonts[o]).parsed.info.version.major,!(c=u.getInstrumentKey(0,n.program,a,i))))return[2];return[4,this.createNote(n,c,a,i,r,l)];case 1:if((h=s.sent()).volumeNode.connect(n.gainL),h.volumeNode.connect(n.gainR),0!==(d=c.exclusiveClass)){if(this.exclusiveClassMap.has(d)){var y;m=(f=function(e){if(Array.isArray(e))return e}(y=this.exclusiveClassMap.get(d))||function(e,t){var n,a,i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var s=[],r=!0,o=!1;try{for(i=i.call(e);!(r=(n=i.next()).done)&&(s.push(n.value),s.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(o)throw a}}return s}}(y,2)||function(t,n){if(t){if("string"==typeof t)return e(t,2);var a=Object.prototype.toString.call(t).slice(8,-1);if("Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return e(t,n)}}(y,2)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())[0],v=f[1],m.ending||this.scheduleNoteRelease(v,m.noteNumber,0,r,void 0,!0)}this.exclusiveClassMap.set(d,[h,t])}return(p=n.scheduledNotes).has(a)?p.get(a).push(h):p.set(a,[h]),[2]}})}).call(this)}},{key:"noteOn",value:function(e,t,n){var a=this.audioContext.currentTime;return this.scheduleNoteOn(e,t,n,a)}},{key:"stopNote",value:function(e,t,n,a){var i=n[a];return i.volumeNode.gain.cancelScheduledValues(e).linearRampToValueAtTime(0,t),i.ending=!0,this.scheduleTask(function(){i.bufferSource.loop=!1},t),new Promise(function(e){i.bufferSource.onended=function(){n[a]=null,i.bufferSource.disconnect(),i.volumeNode.disconnect(),i.filterNode.disconnect(),i.modulationDepth&&(i.volumeDepth.disconnect(),i.modulationDepth.disconnect(),i.modulationLFO.stop()),i.vibratoDepth&&(i.vibratoDepth.disconnect(),i.vibratoLFO.stop()),e()},i.bufferSource.stop(t)})}},{key:"scheduleNoteRelease",value:function(e,t,n,a,i){var s=this.channels[e];if((i||!s.sustainPedal)&&s.scheduledNotes.has(t))for(var r=s.scheduledNotes.get(t),o=0;o<r.length;o++){var u=r[o];if(u&&!u.ending){var l=a+u.instrumentKey.volRelease,c=a+u.instrumentKey.modRelease;u.filterNode.frequency.cancelScheduledValues(a).linearRampToValueAtTime(0,c);var h=Math.min(l,c);return this.stopNote(a,h,r,o)}}}},{key:"releaseNote",value:function(e,t,n){var a=this.audioContext.currentTime;return this.scheduleNoteRelease(e,t,n,a)}},{key:"releaseSustainPedal",value:function(e,t){var n=this,a=2*t,i=this.channels[e],s=[];return i.sustainPedal=!1,i.scheduledNotes.forEach(function(t){for(var i=0;i<t.length;i++){var r=t[i];if(r){var o=r.noteNumber,u=n.releaseNote(e,o,a);s.push(u)}}}),s}},{key:"handleMIDIMessage",value:function(e,t,n){var a=15&e,i=240&e;switch(i){case 128:return this.releaseNote(a,t,n);case 144:return this.noteOn(a,t,n);case 176:return this.handleControlChange(a,t,n);case 192:return this.handleProgramChange(a,t);case 224:return this.handlePitchBendMessage(a,t,n);default:console.warn("Unsupported MIDI message: ".concat(i.toString(16)))}}},{key:"handleProgramChange",value:function(e,t){this.channels[e].program=t}},{key:"handlePitchBendMessage",value:function(e,t,n){this.setPitchBend(e,128*n+t-8192)}},{key:"setPitchBend",value:function(e,t){var n=this.channels[e],a=n.pitchBend;n.pitchBend=t/8192;var i=(n.pitchBend-a)*n.pitchBendRange*100;this.updateDetune(n,i)}},{key:"createControlChangeHandlers",value:function(){return{1:this.setModulationDepth,6:this.dataEntryMSB,7:this.setVolume,10:this.setPan,11:this.setExpression,38:this.dataEntryLSB,64:this.setSustainPedal,100:this.setRPNLSB,101:this.setRPNMSB,120:this.allSoundOff,121:this.resetAllControllers,123:this.allNotesOff}}},{key:"handleControlChange",value:function(e,t,n){var a=this.controlChangeHandlers[t];a?a.call(this,e,n):console.warn("Unsupported Control change: controller=".concat(t," value=").concat(n))}},{key:"updateModulation",value:function(e){var t=this,n=this.audioContext.currentTime;e.scheduledNotes.forEach(function(a){for(var i=0;i<a.length;i++){var s=a[i];if(s)if(s.modulationDepth)s.modulationDepth.gain.setValueAtTime(e.modulationDepth,n);else{var r=t.calcSemitoneOffset(e);t.setPitch(s,r),t.startModulation(e,s,n)}}})}},{key:"setModulationDepth",value:function(e,t){var n=this.channels[e];n.modulationDepth=t/127*n.modulationDepthRange,this.updateModulation(n)}},{key:"setVolume",value:function(e,t){var n=this.channels[e];n.volume=t/127,this.updateChannelVolume(n)}},{key:"panToGain",value:function(e){var t=Math.PI/2*Math.max(0,e-1)/126;return{gainLeft:Math.cos(t),gainRight:Math.sin(t)}}},{key:"setPan",value:function(e,t){var n=this.channels[e];n.pan=t,this.updateChannelVolume(n)}},{key:"setExpression",value:function(e,t){var n=this.channels[e];n.expression=t/127,this.updateChannelVolume(n)}},{key:"dataEntryLSB",value:function(e,t){this.channels[e].dataLSB=t,this.handleRPN(e,0)}},{key:"updateChannelVolume",value:function(e){var t=this.audioContext.currentTime,n=e.volume*e.expression,a=this.panToGain(e.pan),i=a.gainLeft,s=a.gainRight;e.gainL.gain.cancelScheduledValues(t).setValueAtTime(n*i,t),e.gainR.gain.cancelScheduledValues(t).setValueAtTime(n*s,t)}},{key:"setSustainPedal",value:function(e,t){var n=t>=64;this.channels[e].sustainPedal=n,n||this.releaseSustainPedal(e,t)}},{key:"limitData",value:function(e,t,n,a,i){i<e.dataLSB?(e.dataMSB++,e.dataLSB=a):e.dataLSB<0&&(e.dataMSB--,e.dataLSB=i),n<e.dataMSB?(e.dataMSB=n,e.dataLSB=i):e.dataMSB<0&&(e.dataMSB=t,e.dataLSB=a)}},{key:"limitDataMSB",value:function(e,t,n){n<e.dataMSB?e.dataMSB=n:e.dataMSB<0&&(e.dataMSB=t)}},{key:"handleRPN",value:function(e){var t=this.channels[e];switch(128*t.rpnMSB+t.rpnLSB){case 0:this.handlePitchBendRangeRPN(e);break;case 1:this.handleFineTuningRPN(e);break;case 2:this.handleCoarseTuningRPN(e);break;default:console.warn("Channel ".concat(e,": Unsupported RPN MSB=").concat(t.rpnMSB," LSB=").concat(t.rpnLSB))}}},{key:"setRPNMSB",value:function(e,t){this.channels[e].rpnMSB=t}},{key:"setRPNLSB",value:function(e,t){this.channels[e].rpnLSB=t}},{key:"dataEntryMSB",value:function(e,t){this.channels[e].dataMSB=t,this.handleRPN(e)}},{key:"updateDetune",value:function(e,t){var n=this.audioContext.currentTime;e.scheduledNotes.forEach(function(e){for(var a=0;a<e.length;a++){var i=e[a];if(i){var s=i.bufferSource,r=s.detune.value+t;s.detune.cancelScheduledValues(n).setValueAtTime(r,n)}}})}},{key:"handlePitchBendRangeRPN",value:function(e){var t=this.channels[e];this.limitData(t,0,127,0,99);var n=t.dataMSB+t.dataLSB/100;this.setPitchBendRange(e,n)}},{key:"setPitchBendRange",value:function(e,t){var n=this.channels[e],a=n.pitchBendRange;n.pitchBendRange=t;var i=(n.pitchBendRange-a)*n.pitchBend*100;this.updateDetune(n,i)}},{key:"handleFineTuningRPN",value:function(e){var t=this.channels[e];this.limitData(t,0,127,0,127);var n=(128*t.dataMSB+t.dataLSB-8192)/8192;this.setFineTuning(e,n)}},{key:"setFineTuning",value:function(e,t){var n=this.channels[e],a=n.fineTuning;n.fineTuning=t;var i=n.fineTuning-a;this.updateDetune(n,i)}},{key:"handleCoarseTuningRPN",value:function(e){var t=this.channels[e];this.limitDataMSB(t,0,127);var n=t.dataMSB-64;this.setFineTuning(e,n)}},{key:"setCoarseTuning",value:function(e,t){var n=this.channels[e],a=n.coarseTuning;n.coarseTuning=t;var i=n.coarseTuning-a;this.updateDetune(n,i)}},{key:"allSoundOff",value:function(e){return this.stopChannelNotes(e,0,!0)}},{key:"resetAllControllers",value:function(e){Object.assign(this.channels[e],this.effectSettings)}},{key:"allNotesOff",value:function(e){return this.stopChannelNotes(e,0,!1)}},{key:"handleUniversalNonRealTimeExclusiveMessage",value:function(e){if(9===e[2])switch(e[3]){case 1:this.GM1SystemOn();break;case 2:break;default:console.warn("Unsupported Exclusive Message: ".concat(e))}else console.warn("Unsupported Exclusive Message: ".concat(e))}},{key:"GM1SystemOn",value:function(){for(var e=0;e<this.channels.length;e++){var t=this.channels[e];t.bankMSB=0,t.bankLSB=0,t.bank=0}this.channels[9].bankMSB=1,this.channels[9].bank=128}},{key:"handleUniversalRealTimeExclusiveMessage",value:function(e){if(4===e[2]){if(1===e[3])return this.handleMasterVolumeSysEx(e);console.warn("Unsupported Exclusive Message: ".concat(e))}else console.warn("Unsupported Exclusive Message: ".concat(e))}},{key:"handleMasterVolumeSysEx",value:function(e){var t=(128*e[5]+e[4])/16383;this.setMasterVolume(t)}},{key:"setMasterVolume",value:function(e){if(e<0&&1<e)console.error("Master Volume is out of range");else{var t=this.audioContext.currentTime;this.masterGain.gain.cancelScheduledValues(t),this.masterGain.gain.setValueAtTime(e*e,t)}}},{key:"handleExclusiveMessage",value:function(e){console.warn("Unsupported Exclusive Message: ".concat(e))}},{key:"handleSysEx",value:function(e){switch(e[0]){case 126:return this.handleUniversalNonRealTimeExclusiveMessage(e);case 127:return this.handleUniversalRealTimeExclusiveMessage(e);default:return this.handleExclusiveMessage(e)}}},{key:"scheduleTask",value:function(e,t){var n=this;return new Promise(function(a){var i=new AudioBufferSourceNode(n.audioContext);i.onended=function(){e(),a()},i.start(t),i.stop(t)})}}],function(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}(c.prototype,t),c}();i(MidyGM1,"channelSettings",{volume:100/127,pan:64,bank:0,dataMSB:0,dataLSB:0,program:0,pitchBend:0,fineTuning:0,coarseTuning:0,modulationDepthRange:50}),i(MidyGM1,"effectSettings",{expression:1,modulationDepth:0,sustainPedal:!1,rpnMSB:127,rpnLSB:127,pitchBendRange:2});